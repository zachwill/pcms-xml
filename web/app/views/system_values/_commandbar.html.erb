<% overlay_query_expr ||= "''" %>
<%
  section_rows = Array(@section_wayfinding_rows)
  section_rows = [
    { key: "system", label: "System", signal: "showsystemvalues", target_id: "section-system", metric_label: "", delta_label: "", delta_variant: "muted" },
    { key: "tax", label: "Tax Rates", signal: "showtaxrates", target_id: "section-tax", metric_label: "", delta_label: "", delta_variant: "muted" },
    { key: "minimum", label: "Minimum", signal: "showsalaryscales", target_id: "section-minimum", metric_label: "", delta_label: "", delta_variant: "muted" },
    { key: "rookie", label: "Rookie", signal: "showrookiescales", target_id: "section-rookie", metric_label: "", delta_label: "", delta_variant: "muted" }
  ] if section_rows.empty?

  section_state_expr = "[#{section_rows.map { |row| "{ key: '#{row[:key]}', label: '#{row[:label]}', visible: $#{row[:signal]}, target: '#{row[:target_id]}' }" }.join(', ')}]"
  section_summary_expr = "(() => { const sections = #{section_state_expr}; const visible = sections.filter((section) => section.visible); const active = visible.find((section) => section.key === $activesection) || visible[0]; return 'On ' + visible.length + '/#{section_rows.length} · Active ' + (active ? active.label : 'None'); })()"
%>

<div class="flex-1 min-w-0">
  <form
    method="get"
    action="<%= system_values_path %>"
    class="flex items-start gap-4 min-w-0 overflow-x-auto pb-1"
    role="group"
    aria-label="System Values controls"
    data-on:submit="evt.preventDefault(); @get('<%= system_values_sse_refresh_path %>?' + (<%= overlay_query_expr %>));"
  >
    <input type="hidden" name="metric_finder_query" value="<%= @metric_finder_query %>" data-bind="svmetricfinderquery" />
    <input type="hidden" name="metric_finder_cursor" value="<%= @metric_finder_cursor_value %>" data-bind="svmetricfindercursor" />

    <div class="min-w-[24rem] space-y-1">
      <div class="text-[10px] font-semibold uppercase tracking-wider text-muted-foreground/70">Season Lens</div>
      <div class="flex items-center gap-1.5">
        <select
          id="system-values-year-select"
          name="year"
          class="h-7 w-[6.5rem] rounded border border-border bg-muted/50 px-2 text-xs font-mono tabular-nums"
          data-bind="svyear"
        >
          <% @available_years.each do |candidate_year| %>
            <option value="<%= candidate_year %>" <%= "selected" if candidate_year == @selected_year %>><%= format_year_label(candidate_year) %></option>
          <% end %>
        </select>

        <span class="text-[10px] uppercase tracking-wide text-muted-foreground/70">vs</span>

        <select
          id="system-values-baseline-year-select"
          name="baseline_year"
          class="h-7 w-[6.5rem] rounded border border-border bg-muted/50 px-2 text-xs font-mono tabular-nums"
          data-bind="svbaseline"
        >
          <% @available_years.each do |candidate_year| %>
            <option value="<%= candidate_year %>" <%= "selected" if candidate_year == @baseline_year %>><%= format_year_label(candidate_year) %></option>
          <% end %>
        </select>

        <span class="text-[10px] uppercase tracking-wide text-muted-foreground/70">range</span>

        <select
          id="system-values-from-year-select"
          name="from_year"
          class="h-7 w-[5.25rem] rounded border border-border bg-muted/50 px-2 text-xs font-mono tabular-nums"
          data-bind="svfrom"
        >
          <% @available_years.each do |candidate_year| %>
            <option value="<%= candidate_year %>" <%= "selected" if candidate_year == @from_year %>><%= candidate_year %></option>
          <% end %>
        </select>

        <span class="text-[10px] uppercase tracking-wide text-muted-foreground/70">→</span>

        <select
          id="system-values-to-year-select"
          name="to_year"
          class="h-7 w-[5.25rem] rounded border border-border bg-muted/50 px-2 text-xs font-mono tabular-nums"
          data-bind="svto"
        >
          <% @available_years.each do |candidate_year| %>
            <option value="<%= candidate_year %>" <%= "selected" if candidate_year == @to_year %>><%= candidate_year %></option>
          <% end %>
        </select>

        <button type="submit" class="h-7 px-2 rounded border border-border bg-muted/50 text-xs font-medium hover:bg-muted">Apply</button>
      </div>
    </div>

    <div class="h-20 w-px bg-border self-center shrink-0"></div>

    <div class="min-w-[22rem] space-y-1">
      <div class="flex items-center justify-between gap-2">
        <div class="text-[10px] font-semibold uppercase tracking-wider text-muted-foreground/70">Section wayfinding</div>
        <div class="text-[10px] font-mono tabular-nums text-muted-foreground/80" data-text="<%= section_summary_expr %>"></div>
      </div>

      <div class="grid grid-cols-2 gap-1.5">
        <% section_rows.each do |row| %>
          <% delta_class = case row[:delta_variant]
          when "positive"
            "text-emerald-700 dark:text-emerald-300 border-emerald-300/70 dark:border-emerald-500/40 bg-emerald-50/60 dark:bg-emerald-900/20"
          when "negative"
            "text-red-700 dark:text-red-300 border-red-300/70 dark:border-red-500/40 bg-red-50/60 dark:bg-red-900/20"
          when "neutral"
            "text-foreground border-border/80 bg-background"
          else
            "text-muted-foreground border-border/70 bg-background"
          end %>

          <div
            class="rounded border px-2 py-1 space-y-1"
            data-class="{
              'border-primary/60 bg-primary/10': $<%= row[:signal] %>,
              'border-border/70 bg-background': !$<%= row[:signal] %>,
              'ring-1 ring-amber-500/60': $<%= row[:signal] %> && $activesection === '<%= row[:key] %>'
            }"
          >
            <div class="flex items-center gap-1.5">
              <label class="flex min-w-0 flex-1 items-center gap-1.5 cursor-pointer select-none">
                <input type="checkbox" class="size-3.5 accent-primary" data-bind="<%= row[:signal] %>" />
                <span class="text-[11px] text-foreground/90 truncate"><%= row[:label] %></span>
              </label>

              <button
                type="button"
                class="h-5 px-1.5 rounded border border-border/70 bg-background text-[10px] font-medium text-muted-foreground hover:text-foreground hover:bg-muted"
                data-on:click="if (!$<%= row[:signal] %>) { return; } const target = document.getElementById('<%= row[:target_id] %>'); const scroller = document.getElementById('maincanvas'); if (target && scroller) { scroller.scrollTo({ top: Math.max(target.offsetTop - 8, 0), behavior: 'smooth' }); } $activesection = '<%= row[:key] %>';"
              >Go</button>
            </div>

            <div class="pl-5">
              <span class="h-4 px-1 rounded border text-[9px] font-mono tabular-nums inline-flex items-center gap-1 <%= delta_class %>">
                <span><%= row[:metric_label].presence || row[:label] %></span>
                <span><%= row[:delta_label] %></span>
              </span>
            </div>
          </div>
        <% end %>
      </div>
    </div>

    <div class="h-20 w-px bg-border self-center shrink-0"></div>

    <div class="min-w-[17rem] space-y-1">
      <div class="text-[10px] font-semibold uppercase tracking-wider text-muted-foreground/70">Drill-in</div>
      <div class="flex items-center gap-1.5 h-7">
        <span
          class="inline-flex items-center rounded border border-border/70 bg-background px-2 h-7 text-[11px] text-muted-foreground"
          data-show="$svoverlaysection === ''"
        >No active selection</span>

        <span
          class="inline-flex items-center rounded border border-amber-500/50 bg-amber-100/60 dark:bg-amber-900/20 px-2 h-7 text-[11px] font-mono tabular-nums text-foreground"
          data-show="$svoverlaysection !== ''"
          style="display: none;"
          data-text="($svoverlaysection || '').toUpperCase() + ' · ' + ($svoverlaymetric || '') + ' · ' + ($svoverlayyear || '')"
        ></span>

        <button
          type="button"
          class="h-7 px-2 rounded border border-border bg-background text-xs font-medium text-muted-foreground hover:text-foreground hover:bg-muted"
          data-show="$svoverlaysection !== ''"
          style="display: none;"
          data-on:click="$svmetricfinder=''; $svoverlaysection=''; $svoverlaymetric=''; $svoverlayyear=''; $svoverlaylower=''; $svoverlayupper=''; @get('<%= system_values_sidebar_clear_path %>')"
        >Clear</button>
      </div>

      <div class="flex flex-wrap items-center gap-1.5">
        <span
          class="h-5 px-1.5 rounded border border-border/70 bg-background text-[10px] font-mono tabular-nums inline-flex items-center text-muted-foreground"
          data-show="$svmetricfinderquery === ''"
        >Finder idle</span>

        <span
          class="h-5 px-1.5 rounded border border-border/70 bg-background text-[10px] font-mono tabular-nums inline-flex items-center text-foreground"
          data-show="$svmetricfinderquery !== ''"
          style="display: none;"
          data-text="'Finder · ' + ($svmetricfinderquery || '')"
        ></span>

        <span
          class="h-5 px-1.5 rounded border border-border/70 bg-background text-[10px] font-mono tabular-nums inline-flex items-center text-muted-foreground"
          data-show="$svmetricfinderquery !== ''"
          style="display: none;"
          data-text="'Hits ' + ($svmetricfindercount || 0)"
        ></span>

        <span
          class="h-5 px-1.5 rounded border border-border/70 bg-background text-[10px] font-mono tabular-nums inline-flex items-center text-muted-foreground"
          data-show="$svmetricfindercursor !== ''"
          style="display: none;"
          data-text="'Cursor #' + (($svmetricfindercursorindex || 0) + 1)"
        ></span>
      </div>
    </div>
  </form>
</div>

<div class="h-20 w-px bg-border self-center ml-auto shrink-0"></div>
<%= render partial: "shared/commandbar_navigation", locals: { active_destination: "system_values" } %>
