<% content_for :title, "Two-Way Utility" %>

<%
  pane_query_expr = "'conference=' + encodeURIComponent($twconference) +
    '&team=' + encodeURIComponent($twteam) +
    '&risk=' + encodeURIComponent($twrisk) +
    '&intent=' + encodeURIComponent($twintent || '')"

  compare_query_expr = "'compare_a=' + encodeURIComponent($comparea || '') +
    '&compare_b=' + encodeURIComponent($compareb || '')"

  sync_url_expr = "const nextUrl = '/tools/two-way-utility?' + (#{pane_query_expr}) + '&' + (#{compare_query_expr}); if ((window.location.pathname + window.location.search) !== nextUrl) { window.history.replaceState({}, '', nextUrl); }"

  keyboard_handler_expr = <<~JS.squish
    const key = String(evt.key || '');
    const target = evt.target;
    const isEditable = !!(target && (['INPUT', 'TEXTAREA', 'SELECT'].includes(target.tagName) || target.isContentEditable));

    const isFinderShortcut = (evt.metaKey || evt.ctrlKey) && !evt.shiftKey && !evt.altKey && key.toLowerCase() === 'k';
    if (isFinderShortcut) {
      const finder = document.getElementById('two-way-intent-input');
      if (!finder) { return; }
      evt.preventDefault();
      finder.focus();
      finder.select();
      return;
    }

    if (key !== 'Escape' || isEditable) { return; }

    const clearButton = el.querySelector('[data-two-way-overlay-clear]');
    if (!clearButton) { return; }

    evt.preventDefault();
    clearButton.click();
  JS

  signals_literal = {
    twconference: @conference.to_s,
    twteam: @team.to_s,
    twrisk: @risk.to_s,
    twintent: @intent.to_s,
    twintentcursor: @intent_shortlist_cursor_id.to_s,
    twintentcursorindex: @intent_shortlist_cursor_index.to_i,
    comparea: @compare_a_id.to_s,
    compareb: @compare_b_id.to_s,
    overlaytype: "none",
    overlayid: ""
  }.to_json
%>

<div
  id="two-way-utility-workspace"
  class="h-screen w-full flex flex-col overflow-hidden bg-background"
  style="height: 100dvh;"
  data-signals='<%= signals_literal %>'
  data-effect="<%= sync_url_expr %>"
  data-on:keydown="<%= keyboard_handler_expr %>"
>
  <div id="flash"></div>

  <%= render partial: "tools/two_way_utility/commandbar" %>

  <div id="viewport" class="flex flex-1 overflow-hidden relative">
    <%= render partial: "tools/two_way_utility/workspace_main" %>

    <aside
      id="rightpanel"
      class="w-[30%] min-w-[320px] max-w-[480px] border-l border-border bg-background overflow-hidden relative"
    >
      <div
        id="rightpanel-base-layer"
        class="absolute inset-0 overflow-y-auto overflow-x-hidden overscroll-y-contain scroll-touch pt-2 px-4 pb-4"
      >
        <%= render partial: "tools/two_way_utility/rightpanel_base" %>
      </div>

      <%= render partial: "tools/two_way_utility/rightpanel_clear" %>
    </aside>
  </div>
</div>
