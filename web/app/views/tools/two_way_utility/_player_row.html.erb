<% player_id = player["player_id"] %>
<% player_name = player["player_name"] %>
<% state_query ||= "" %>
<% intent_query = local_assigns[:intent_query].to_s.strip %>
<% intent_active = intent_query.present? %>
<% highlighted_player_name = if intent_active
  highlight(player_name.to_s, intent_query, highlighter: '<mark class="rounded bg-amber-200/80 dark:bg-amber-700/60 px-0.5">\\1</mark>', sanitize: true)
else
  ERB::Util.h(player_name.to_s)
end %>

<% games_used = player["games_on_active_list"] %>
<% games_limit = player["active_list_games_limit"] %>
<% games_remaining = player["remaining_active_list_games"] %>
<% games_used_pct = player["games_used_pct"] %>
<% status_chip = player["limit_status_chip"] %>

<% current_year = SalaryBookHelper::SALARY_YEARS.first %>
<% next_year = SalaryBookHelper::SALARY_YEARS[1] %>
<% age_yos = player_age_yos_display(player) %>
<% cap_2025 = player["cap_2025"] %>
<% cap_2026 = player["cap_2026"] %>

<% poison_pill_now = poison_pill_now?(player, current_year) %>
<% trade_restricted_now = player["is_trade_consent_required_now"] || player["is_trade_restricted_now"] || poison_pill_now %>

<% status_tokens = [] %>
<% status_tokens << { label: "2W", classes: "text-foreground" } if player["is_two_way"] %>
<% status_tokens << { label: "NTC", classes: "text-red-600 dark:text-red-400" } if player["is_no_trade"] %>
<% status_tokens << { label: "PP", classes: "text-red-600 dark:text-red-400" } if poison_pill_now %>
<% if player["is_trade_restricted_now"] || player["is_trade_consent_required_now"] %>
  <% status_tokens << { label: "TR", classes: "text-red-600 dark:text-red-400" } %>
<% end %>

<% risk_token = case player["risk_tier"].to_s
when "critical"
  { label: "Risk:≤10", classes: "text-red-600 dark:text-red-400" }
when "warning"
  { label: "Risk:≤20", classes: "text-orange-600 dark:text-orange-400" }
when "estimate"
  { label: "Risk:EST", classes: "text-muted-foreground" }
end %>
<% status_tokens << risk_token if risk_token.present? %>
<% status_tokens << { label: "INTENT", classes: "text-amber-700 dark:text-amber-300" } if intent_active %>

<% if next_year.present? %>
  <% next_option = player_option(player, next_year) %>
  <% option_classes = case next_option
    when "PO", "ETO"
      "text-blue-600 dark:text-blue-400"
    when "TO"
      "text-purple-600 dark:text-purple-400"
  end %>
  <% status_tokens << { label: next_option, classes: option_classes } if next_option.present? && option_classes.present? %>

  <% next_year_salary = player_salary(player, next_year) %>
  <% if player["is_non_guaranteed_#{next_year}"] && next_year_salary.present? && next_year_salary.to_f > 0 %>
    <% status_tokens << { label: "NG", classes: "text-amber-600 dark:text-amber-400" } %>
  <% end %>
<% end %>

<% show_trade_kicker = player["is_trade_bonus"] && trade_bonus_has_room?(player, current_year) != false %>
<% status_tokens << { label: "TK", classes: "text-orange-600 dark:text-orange-400" } if show_trade_kicker %>

<% restricted_2025_cell_class = trade_restricted_now ? "bg-red-100/60 dark:bg-red-900/30" : "" %>
<% restricted_2025_text_class = trade_restricted_now ? "text-red-700 dark:text-red-300" : "text-foreground" %>
<% two_way_badge_2025_class = trade_restricted_now ? "bg-red-200 dark:bg-red-900/50 text-red-700 dark:text-red-300" : neutral_badge_classes %>
<% two_way_badge_2026_class = neutral_badge_classes %>

<% used_ratio = games_used_pct&.to_f %>
<% used_pct_label = used_ratio ? "#{(used_ratio * 100).round}%" : nil %>
<% used_blocks = used_ratio ? pct_cap_blocks(used_ratio) : nil %>

<% limit_ratio = if games_limit.present? && games_limit.to_f.positive?
  [games_limit.to_f / 50.0, 1.0].min
end %>
<% limit_pct_label = limit_ratio ? "#{(limit_ratio * 100).round}%" : nil %>
<% limit_blocks = limit_ratio ? pct_cap_blocks(limit_ratio) : nil %>

<% remain_ratio = if games_remaining.present? && games_limit.present? && games_limit.to_f.positive?
  games_remaining.to_f / games_limit.to_f
end %>
<% remain_pct_label = remain_ratio ? "#{(remain_ratio * 100).round}%" : nil %>
<% remain_blocks = remain_ratio ? pct_cap_blocks(remain_ratio) : nil %>

<% remaining_games_value = games_remaining&.to_f %>
<% usage_warning_tier = if remaining_games_value.present? && remaining_games_value <= 10
  :critical
elsif remaining_games_value.present? && remaining_games_value <= 20
  :warning
end %>

<% usage_warning_cell_class = case usage_warning_tier
when :critical then "bg-red-100/60 dark:bg-red-900/30"
when :warning then "bg-orange-100/60 dark:bg-orange-900/30"
else ""
end %>

<% usage_warning_top_text_class = case usage_warning_tier
when :critical then "text-red-700 dark:text-red-300"
when :warning then "text-orange-700 dark:text-orange-300"
else "text-foreground"
end %>

<% usage_warning_sub_text_class = case usage_warning_tier
when :critical then "text-red-700/90 dark:text-red-300/90"
when :warning then "text-orange-700/90 dark:text-orange-300/90"
else "text-muted-foreground/80"
end %>

<% last_game_top = "—" %>
<% last_game_bottom = "" %>
<% if player["last_game_date_est"].present? %>
  <% begin %>
    <% last_game_date = Date.parse(player["last_game_date_est"].to_s) %>
    <% last_game_top = last_game_date.strftime("%b %d") %>
    <% last_game_bottom = last_game_date.strftime("%Y") %>
  <% rescue ArgumentError %>
    <% last_game_top = format_date_short(player["last_game_date_est"]) || "—" %>
  <% end %>
<% end %>

<% signing_top = "—" %>
<% signing_bottom = "" %>
<% if player["signing_date"].present? %>
  <% begin %>
    <% signing_date = Date.parse(player["signing_date"].to_s) %>
    <% signing_top = signing_date.strftime("%b %d") %>
    <% signing_bottom = signing_date.strftime("%Y") %>
  <% rescue ArgumentError %>
    <% signing_top = format_date_short(player["signing_date"]) || "—" %>
  <% end %>
<% end %>

<% open_expr = "$overlaytype = 'player'; $overlayid = '#{player_id}'; @get('/tools/two-way-utility/sidebar/#{player_id}?#{state_query}')" %>
<% compare_refresh_base = "/tools/two-way-utility/sse/refresh?#{state_query}" %>
<% compare_state_suffix_expr = "'&selected_id=' + encodeURIComponent($overlaytype === 'player' ? $overlayid : '') + '&compare_a=' + encodeURIComponent($comparea || '') + '&compare_b=' + encodeURIComponent($compareb || '')" %>
<% pin_a_expr = "@get('#{compare_refresh_base}' + (#{compare_state_suffix_expr}) + '&compare_action=pin&compare_slot=a&player_id=#{player_id}')" %>
<% pin_b_expr = "@get('#{compare_refresh_base}' + (#{compare_state_suffix_expr}) + '&compare_action=pin&compare_slot=b&player_id=#{player_id}')" %>

<div
  class="group h-10 border-b border-border/50 flex items-center text-xs transition-colors duration-75 hover:bg-yellow-50/70 dark:hover:bg-yellow-900/25 cursor-pointer <%= intent_active ? 'bg-amber-50/40 dark:bg-amber-900/10 ring-1 ring-inset ring-amber-400/35 dark:ring-amber-500/30' : '' %>"
  role="button"
  tabindex="0"
  data-class="{ 'bg-yellow-100/80 dark:bg-yellow-900/20': $overlaytype === 'player' && $overlayid === '<%= player_id %>', 'ring-1 ring-inset ring-indigo-500/50': $comparea === '<%= player_id %>' || $compareb === '<%= player_id %>' }"
  data-on:click="<%= open_expr %>"
  data-on:keydown="if (evt.key === 'Enter' || evt.key === ' ') { evt.preventDefault(); <%= open_expr %>; }"
>
  <div
    class="w-52 shrink-0 pl-4 sticky left-0 z-20 relative bg-background transition-colors duration-75
           group-hover:bg-yellow-50 dark:group-hover:bg-yellow-900/25
           <%= intent_active ? 'bg-amber-50/40 dark:bg-amber-900/10' : '' %>
           after:absolute after:right-0 after:top-0 after:bottom-0 after:w-px after:bg-border/30"
    data-class="{ 'bg-yellow-100/80 dark:bg-yellow-900/20': $overlaytype === 'player' && $overlayid === '<%= player_id %>' }"
  >
    <div class="grid grid-cols-[40px_1fr] grid-rows-[24px_16px]" aria-label="<%= player_name %> player info">
      <div class="row-span-2 flex items-center justify-start">
        <div class="w-7 h-7 rounded border border-border bg-background overflow-hidden">
          <img
            src="<%= player_headshot_url(player_id) %>"
            alt="<%= player_name %>"
            class="w-full h-full object-cover object-top bg-muted"
            loading="lazy"
            decoding="async"
            onerror="if (this.src !== '<%= fallback_headshot_data_uri %>') { this.src = '<%= fallback_headshot_data_uri %>'; }"
          />
        </div>
      </div>

      <div class="h-[24px] flex items-end min-w-0 pl-1 pr-2">
        <a href="<%= player_href(player_id) %>" class="block truncate font-medium text-[14px] text-foreground transition-colors group-hover:text-primary hover:underline" title="<%= player_name %>" data-on:click="evt.stopPropagation()">
          <%= raw(highlighted_player_name) %>
        </a>
      </div>

      <div class="h-[16px] -mt-px flex items-start min-w-0 pl-1 pr-2 leading-none text-[10px] text-muted-foreground/80 tabular-nums overflow-hidden">
        <div class="flex items-start justify-between gap-1 w-full min-w-0">
          <div class="flex items-start min-w-0 overflow-hidden whitespace-nowrap">
            <% if age_yos.present? || status_tokens.any? %>
              <% if age_yos.present? %>
                <span class="truncate"><%= age_yos %></span>
              <% end %>

              <% status_tokens.each_with_index do |token, idx| %>
                <% if age_yos.present? || idx.positive? %>
                  <span class="px-1 text-muted-foreground/50">·</span>
                <% end %>
                <span class="<%= token[:classes] %>"><%= token[:label] %></span>
              <% end %>
            <% else %>
              <span class="text-muted-foreground/50">—</span>
            <% end %>

            <span class="ml-1 inline-flex items-center rounded border border-indigo-500/40 bg-indigo-500/10 px-1 text-[9px] font-semibold text-indigo-700 dark:text-indigo-300" data-show="$comparea === '<%= player_id %>'" style="display: none;">A</span>
            <span class="ml-1 inline-flex items-center rounded border border-emerald-500/40 bg-emerald-500/10 px-1 text-[9px] font-semibold text-emerald-700 dark:text-emerald-300" data-show="$compareb === '<%= player_id %>'" style="display: none;">B</span>
          </div>

          <div class="flex items-center gap-1 shrink-0" data-on:click="evt.stopPropagation()" data-on:keydown="evt.stopPropagation()">
            <button
              type="button"
              class="cursor-pointer h-4 px-1 rounded border border-border/70 text-[9px] font-semibold uppercase tracking-wide text-muted-foreground hover:text-foreground hover:border-foreground/30 transition-colors"
              aria-label="Pin <%= player_name %> to compare slot A"
              title="Pin to compare slot A"
              data-class="{ 'border-indigo-500/60 bg-indigo-500/10 text-indigo-700 dark:text-indigo-300': $comparea === '<%= player_id %>' }"
              data-on:click="evt.stopPropagation(); <%= pin_a_expr %>"
            >Pin A</button>

            <button
              type="button"
              class="cursor-pointer h-4 px-1 rounded border border-border/70 text-[9px] font-semibold uppercase tracking-wide text-muted-foreground hover:text-foreground hover:border-foreground/30 transition-colors"
              aria-label="Pin <%= player_name %> to compare slot B"
              title="Pin to compare slot B"
              data-class="{ 'border-emerald-500/60 bg-emerald-500/10 text-emerald-700 dark:text-emerald-300': $compareb === '<%= player_id %>' }"
              data-on:click="evt.stopPropagation(); <%= pin_b_expr %>"
            >Pin B</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="w-24 shrink-0 h-10 grid place-items-center <%= restricted_2025_cell_class %>">
    <% if cap_2025.nil? %>
      <span class="grid place-items-center w-full">
        <span class="inline-block font-mono tabular-nums text-center text-muted-foreground/50" style="width: 6ch">—</span>
      </span>
    <% elsif cap_2025.to_f == 0 %>
      <span class="inline-flex items-center justify-center text-[10px] px-1.5 py-0.5 rounded font-medium <%= two_way_badge_2025_class %>">
        Two-Way
      </span>
    <% else %>
      <span class="grid place-items-center w-full">
        <span class="inline-block font-mono tabular-nums text-right <%= restricted_2025_text_class %>" style="width: 6ch"><%= format_salary(cap_2025) %></span>
      </span>
    <% end %>
  </div>

  <div class="w-24 shrink-0 h-10 grid place-items-center">
    <% if cap_2026.nil? %>
      <span class="grid place-items-center w-full">
        <span class="inline-block font-mono tabular-nums text-center text-muted-foreground/50" style="width: 6ch">—</span>
      </span>
    <% elsif cap_2026.to_f == 0 %>
      <span class="inline-flex items-center justify-center text-[10px] px-1.5 py-0.5 rounded font-medium <%= two_way_badge_2026_class %>">
        Two-Way
      </span>
    <% else %>
      <span class="grid place-items-center w-full">
        <span class="inline-block font-mono tabular-nums text-right text-foreground" style="width: 6ch"><%= format_salary(cap_2026) %></span>
      </span>
    <% end %>
  </div>

  <div class="w-24 shrink-0 flex flex-col <%= usage_warning_cell_class %>">
    <div class="h-[24px] flex items-end justify-center text-sm">
      <span class="inline-block font-mono tabular-nums text-right <%= games_used.present? ? usage_warning_top_text_class : 'text-muted-foreground/50' %>" style="width: 4ch"><%= games_used || "—" %></span>
    </div>
    <div class="h-[16px] -mt-px flex items-start justify-center">
      <% if used_pct_label.present? %>
        <span class="text-[10px] leading-none tabular-nums whitespace-nowrap <%= usage_warning_sub_text_class %>">
          <%= used_pct_label %>
          <% if used_blocks.present? %>
            <span class="ml-0.5 opacity-70 font-mono"><%= used_blocks %></span>
          <% end %>
        </span>
      <% else %>
        <span class="text-[10px] leading-none tabular-nums whitespace-nowrap font-mono opacity-0">00% ▰▰▱▱</span>
      <% end %>
    </div>
  </div>

  <div class="w-24 shrink-0 flex flex-col <%= usage_warning_cell_class %>">
    <div class="h-[24px] flex items-end justify-center text-sm">
      <span class="inline-block font-mono tabular-nums text-right <%= games_limit.present? ? usage_warning_top_text_class : 'text-muted-foreground/50' %>" style="width: 4ch"><%= games_limit || "—" %></span>
    </div>
    <div class="h-[16px] -mt-px flex items-start justify-center">
      <% if limit_pct_label.present? || status_chip.present? %>
        <span class="text-[10px] leading-none tabular-nums whitespace-nowrap <%= usage_warning_sub_text_class %>" title="<%= status_chip.present? ? 'Game limit is estimated' : nil %>">
          <% if status_chip.present? %>
            <% if usage_warning_tier.present? %>
              <%= status_chip %>
            <% else %>
              <span class="text-amber-600 dark:text-amber-400"><%= status_chip %></span>
            <% end %>
          <% elsif limit_pct_label.present? %>
            <%= limit_pct_label %>
          <% end %>
          <% if limit_blocks.present? %>
            <span class="ml-0.5 opacity-70 font-mono"><%= limit_blocks %></span>
          <% end %>
        </span>
      <% else %>
        <span class="text-[10px] leading-none tabular-nums whitespace-nowrap font-mono opacity-0">00% ▰▰▱▱</span>
      <% end %>
    </div>
  </div>

  <div class="w-24 shrink-0 flex flex-col <%= usage_warning_cell_class %>">
    <div class="h-[24px] flex items-end justify-center text-sm">
      <span class="inline-block font-mono tabular-nums text-right <%= games_remaining.present? ? usage_warning_top_text_class : 'text-muted-foreground/50' %>" style="width: 4ch"><%= games_remaining || "—" %></span>
    </div>
    <div class="h-[16px] -mt-px flex items-start justify-center">
      <% if remain_pct_label.present? %>
        <span class="text-[10px] leading-none tabular-nums whitespace-nowrap <%= usage_warning_sub_text_class %>">
          <%= remain_pct_label %>
          <% if remain_blocks.present? %>
            <span class="ml-0.5 opacity-70 font-mono"><%= remain_blocks %></span>
          <% end %>
        </span>
      <% else %>
        <span class="text-[10px] leading-none tabular-nums whitespace-nowrap font-mono opacity-0">00% ▰▰▱▱</span>
      <% end %>
    </div>
  </div>

  <div class="w-28 shrink-0 flex flex-col">
    <div class="h-[24px] flex items-end justify-center">
      <span class="inline-block font-mono tabular-nums text-right <%= last_game_top == '—' ? 'text-muted-foreground/50' : 'text-foreground' %>" style="width: 8ch"><%= last_game_top %></span>
    </div>
    <div class="h-[16px] -mt-px flex items-start justify-center">
      <% if last_game_bottom.present? %>
        <span class="text-[10px] leading-none tabular-nums whitespace-nowrap text-muted-foreground/80"><%= last_game_bottom %></span>
      <% else %>
        <span class="text-[10px] leading-none tabular-nums whitespace-nowrap opacity-0">0000</span>
      <% end %>
    </div>
  </div>

  <div class="w-28 shrink-0 flex flex-col">
    <div class="h-[24px] flex items-end justify-center">
      <span class="inline-block font-mono tabular-nums text-right <%= signing_top == '—' ? 'text-muted-foreground/50' : 'text-foreground' %>" style="width: 8ch"><%= signing_top %></span>
    </div>
    <div class="h-[16px] -mt-px flex items-start justify-center">
      <% if signing_bottom.present? %>
        <span class="text-[10px] leading-none tabular-nums whitespace-nowrap text-muted-foreground/80"><%= signing_bottom %></span>
      <% else %>
        <span class="text-[10px] leading-none tabular-nums whitespace-nowrap opacity-0">0000</span>
      <% end %>
    </div>
  </div>

  <div class="w-40 shrink-0 flex flex-col pr-4">
    <%#
      Pixel-tuned alignment (do not casually tweak):
      - Agent text uses `-translate-y-[3px]`
      - Agency text uses `-translate-y-px`
      This preserves baseline alignment with Salary/% rows while avoiding descender clipping
      (e.g. g/p/q/y) in truncated names.
    %>
    <div class="h-[24px] flex items-end justify-start min-w-0">
      <% if player['agent_name'].present? && player['agent_id'].present? %>
        <a
          href="<%= agent_href(player['agent_id']) %>"
          class="block text-xs leading-tight truncate -translate-y-[3px] text-muted-foreground hover:text-foreground hover:underline focus:outline-none focus-visible:underline focus-visible:text-foreground transition-colors"
          data-on:click="evt.stopPropagation()"
        ><%= player['agent_name'] %></a>
      <% elsif player['agent_name'].present? %>
        <span class="text-xs leading-tight truncate -translate-y-[3px] text-muted-foreground"><%= player['agent_name'] %></span>
      <% else %>
        <span class="text-xs -translate-y-[3px] text-muted-foreground/50">—</span>
      <% end %>
    </div>

    <div class="h-[16px] -mt-px flex items-start justify-start gap-1.5 leading-none text-[10px] tabular-nums min-w-0">
      <% if player['agency_name'].present? %>
        <span class="text-muted-foreground leading-tight truncate -translate-y-px"><%= player['agency_name'] %></span>
      <% else %>
        <span class="text-muted-foreground/50 -translate-y-px">—</span>
      <% end %>
    </div>
  </div>
</div>
