<% overlay_query_expr ||= "''" %>
<% metric_shortlist = Array(@metric_finder_shortlist) %>
<% metric_shortlist_values_json = metric_shortlist.map { |option| option[:value].to_s }.to_json %>

<%
  shortlist_refresh_expr = "@get('#{tools_system_values_sse_refresh_path}?' + (#{overlay_query_expr}))"

  metric_query_input_expr = "clearTimeout(window.__systemValuesFinderDebounce); window.__systemValuesFinderDebounce = setTimeout(() => { #{shortlist_refresh_expr}; }, 140);"

  metric_shortlist_keyboard_expr = <<~JS.squish
    const shortlistValues = #{metric_shortlist_values_json};

    if ((evt.key === 'ArrowDown' || evt.key === 'ArrowUp') && shortlistValues.length) {
      evt.preventDefault();

      let cursorIndex = Number($svmetricfindercursorindex || 0);
      if (!Number.isFinite(cursorIndex) || cursorIndex < 0 || cursorIndex >= shortlistValues.length) {
        cursorIndex = 0;
      }

      const step = evt.key === 'ArrowDown' ? 1 : -1;
      cursorIndex = (cursorIndex + step + shortlistValues.length) % shortlistValues.length;
      $svmetricfindercursorindex = cursorIndex;
      $svmetricfindercursor = shortlistValues[cursorIndex];
      return;
    }

    if (evt.key === 'Enter') {
      evt.preventDefault();
      const targetValue = ($svmetricfindercursor && String($svmetricfindercursor)) || shortlistValues[0] || '';
      if (!targetValue) {
        #{shortlist_refresh_expr};
        return;
      }

      let cursorIndex = shortlistValues.indexOf(targetValue);
      if (cursorIndex < 0) { cursorIndex = 0; }
      $svmetricfindercursorindex = cursorIndex;
      $svmetricfindercursor = targetValue;
      el.dispatchEvent(new CustomEvent('system-values-jump', { bubbles: true, detail: { value: targetValue, cursorIndex: cursorIndex } }));
    }
  JS
%>

<div class="flex-1 min-w-0 space-y-3">
  <div>
    <h1 class="text-sm font-semibold tracking-wide uppercase">System Values</h1>
    <p class="text-[11px] text-muted-foreground">League constants, tax brackets, salary scales, rookie scale grid</p>
  </div>

  <form
    method="get"
    action="<%= tools_system_values_path %>"
    class="flex flex-wrap items-end gap-3"
    role="group"
    aria-label="System Values controls"
    data-on:submit="evt.preventDefault(); @get('<%= tools_system_values_sse_refresh_path %>?' + (<%= overlay_query_expr %>));"
  >
    <div class="space-y-1">
      <label class="block text-[10px] font-semibold uppercase tracking-wider text-muted-foreground/70" for="system-values-year-select">Season</label>
      <select
        id="system-values-year-select"
        name="year"
        class="h-7 rounded border border-border bg-muted/50 px-2 text-xs"
        data-bind="svyear"
      >
        <% @available_years.each do |candidate_year| %>
          <option value="<%= candidate_year %>" <%= "selected" if candidate_year == @selected_year %>><%= format_year_label(candidate_year) %></option>
        <% end %>
      </select>
    </div>

    <div class="space-y-1">
      <label class="block text-[10px] font-semibold uppercase tracking-wider text-muted-foreground/70" for="system-values-baseline-year-select">Baseline</label>
      <select
        id="system-values-baseline-year-select"
        name="baseline_year"
        class="h-7 rounded border border-border bg-muted/50 px-2 text-xs"
        data-bind="svbaseline"
      >
        <% @available_years.each do |candidate_year| %>
          <option value="<%= candidate_year %>" <%= "selected" if candidate_year == @baseline_year %>><%= format_year_label(candidate_year) %></option>
        <% end %>
      </select>
    </div>

    <div class="space-y-1">
      <label class="block text-[10px] font-semibold uppercase tracking-wider text-muted-foreground/70" for="system-values-from-year-select">From</label>
      <select
        id="system-values-from-year-select"
        name="from_year"
        class="h-7 rounded border border-border bg-muted/50 px-2 text-xs font-mono tabular-nums"
        data-bind="svfrom"
      >
        <% @available_years.each do |candidate_year| %>
          <option value="<%= candidate_year %>" <%= "selected" if candidate_year == @from_year %>><%= candidate_year %></option>
        <% end %>
      </select>
    </div>

    <div class="space-y-1">
      <label class="block text-[10px] font-semibold uppercase tracking-wider text-muted-foreground/70" for="system-values-to-year-select">To</label>
      <select
        id="system-values-to-year-select"
        name="to_year"
        class="h-7 rounded border border-border bg-muted/50 px-2 text-xs font-mono tabular-nums"
        data-bind="svto"
      >
        <% @available_years.each do |candidate_year| %>
          <option value="<%= candidate_year %>" <%= "selected" if candidate_year == @to_year %>><%= candidate_year %></option>
        <% end %>
      </select>
    </div>

    <button type="submit" class="h-7 px-2 rounded border border-border bg-muted/50 text-xs font-medium hover:bg-muted">Apply</button>

    <button
      type="button"
      class="h-7 px-2 rounded border border-border bg-background text-xs font-medium text-muted-foreground hover:text-foreground hover:bg-muted"
      data-show="$svoverlaysection !== ''"
      style="display: none;"
      data-on:click="$svmetricfinder=''; $svoverlaysection=''; $svoverlaymetric=''; $svoverlayyear=''; $svoverlaylower=''; $svoverlayupper=''; @get('<%= tools_system_values_sidebar_clear_path %>')"
    >Clear drill-in</button>

    <div class="h-7 w-px bg-border self-end mx-1"></div>

    <div
      class="space-y-1 min-w-[24rem]"
      data-on:system-values-jump="
        const raw = (evt.detail && evt.detail.value) ? String(evt.detail.value) : '';
        if (!raw) { return; }

        const parts = raw.split('|');
        if (parts.length < 6) { return; }

        const section = parts[0];
        const metric = parts[1];
        const year = parts[2];
        const lower = parts[3] || '';
        const upper = parts[4] || '';
        const anchorId = parts[5] || '';

        if (section === 'system') { $showsystemvalues = true; }
        if (section === 'tax') { $showtaxrates = true; }
        if (section === 'minimum') { $showsalaryscales = true; }
        if (section === 'rookie') { $showrookiescales = true; }

        if (evt.detail && Number.isFinite(Number(evt.detail.cursorIndex))) {
          $svmetricfindercursorindex = Number(evt.detail.cursorIndex);
        }

        $svmetricfinder = raw;
        $svmetricfindercursor = raw;
        $svoverlaysection = section;
        $svoverlaymetric = metric;
        $svoverlayyear = year;
        $svoverlaylower = lower;
        $svoverlayupper = upper;
        $activesection = section;

        const scroller = document.getElementById('maincanvas');
        const target = anchorId ? document.getElementById(anchorId) : null;
        if (scroller && target) {
          scroller.scrollTo({ top: Math.max(target.offsetTop - 52, 0), behavior: 'smooth' });
        }

        @get('<%= tools_system_values_sidebar_metric_path %>?' + (<%= overlay_query_expr %>));
      "
    >
      <label class="block text-[10px] font-semibold uppercase tracking-wider text-muted-foreground/70" for="system-values-metric-finder-query">Metric finder</label>
      <div class="flex items-center gap-1.5">
        <input
          id="system-values-metric-finder-query"
          type="search"
          placeholder="Type metric intent (cap, apron, YOS, pick...)"
          class="h-7 min-w-[21rem] rounded border border-border bg-muted/50 px-2 text-xs"
          value="<%= @metric_finder_query %>"
          data-bind="svmetricfinderquery"
          data-on:input="$svmetricfindercursor=''; $svmetricfindercursorindex=0; <%= metric_query_input_expr %>"
          data-on:keydown="<%= metric_shortlist_keyboard_expr %>"
        />

        <button
          type="button"
          class="h-7 px-2 rounded border border-border bg-background text-xs font-medium text-muted-foreground hover:text-foreground hover:bg-muted"
          data-on:click="const targetValue = $svmetricfindercursor || ''; if (!targetValue) { return; } el.dispatchEvent(new CustomEvent('system-values-jump', { bubbles: true, detail: { value: targetValue, cursorIndex: Number($svmetricfindercursorindex || 0) } }));"
        >Open</button>

        <button
          type="button"
          class="h-7 px-2 rounded border border-border bg-background text-xs font-medium text-muted-foreground hover:text-foreground hover:bg-muted"
          data-on:click="$svmetricfinderquery=''; $svmetricfindercursor=''; $svmetricfindercursorindex=0; @get('<%= tools_system_values_sse_refresh_path %>?' + (<%= overlay_query_expr %>));"
        >Clear</button>
      </div>

      <div class="flex items-center gap-1.5 min-h-[18px]">
        <% if metric_shortlist.any? %>
          <div id="system-values-metric-shortlist" class="flex items-center gap-1.5 overflow-x-auto pr-1">
            <% metric_shortlist.each_with_index do |option, idx| %>
              <% cursor_value = option[:value].to_s %>
              <button
                type="button"
                class="cursor-pointer h-4 px-1.5 rounded border border-border/70 bg-background text-[10px] text-muted-foreground hover:text-foreground hover:border-foreground/30 transition-colors whitespace-nowrap"
                data-class="{ 'border-foreground/40 bg-yellow-50/70 dark:bg-yellow-900/20 text-foreground': $svmetricfindercursor === '<%= cursor_value %>' }"
                data-on:mouseenter="$svmetricfindercursorindex=<%= idx %>; $svmetricfindercursor='<%= cursor_value %>'"
                data-on:focus="$svmetricfindercursorindex=<%= idx %>; $svmetricfindercursor='<%= cursor_value %>'"
                data-on:click="$svmetricfindercursorindex=<%= idx %>; $svmetricfindercursor='<%= cursor_value %>'; el.dispatchEvent(new CustomEvent('system-values-jump', { bubbles: true, detail: { value: '<%= cursor_value %>', cursorIndex: <%= idx %> } }));"
              >
                <span class="font-mono tabular-nums">#<%= idx + 1 %></span>
                <span class="mx-1">·</span>
                <span class="font-medium text-foreground"><%= option[:metric_label] %></span>
                <span class="mx-1">·</span>
                <span><%= option[:context_label] %></span>
              </button>
            <% end %>
          </div>
        <% elsif @metric_finder_query.present? %>
          <span class="text-[10px] text-muted-foreground/70">No shortlist matches in current year/lens.</span>
        <% end %>
      </div>

      <div class="text-[10px] text-muted-foreground/70 tabular-nums">
        <% if @metric_finder_query.present? %>
          <span><%= metric_shortlist.size %> shortlist rows · ↑/↓ pick · Enter opens overlay</span>
        <% else %>
          <span>Type intent to get ranked shortlist and open with Enter.</span>
        <% end %>
      </div>
    </div>

    <div class="h-7 w-px bg-border self-end mx-1"></div>

    <div class="space-y-1">
      <div class="text-[10px] font-semibold uppercase tracking-wider text-muted-foreground/70">Visible sections</div>
      <div class="flex flex-wrap items-center gap-3">
        <label class="flex items-center gap-1.5 text-[11px] text-foreground/80">
          <input type="checkbox" class="size-3.5 accent-primary" data-bind="showsystemvalues" />
          System
        </label>
        <label class="flex items-center gap-1.5 text-[11px] text-foreground/80">
          <input type="checkbox" class="size-3.5 accent-primary" data-bind="showtaxrates" />
          Tax Rates
        </label>
        <label class="flex items-center gap-1.5 text-[11px] text-foreground/80">
          <input type="checkbox" class="size-3.5 accent-primary" data-bind="showsalaryscales" />
          Minimum Salary
        </label>
        <label class="flex items-center gap-1.5 text-[11px] text-foreground/80">
          <input type="checkbox" class="size-3.5 accent-primary" data-bind="showrookiescales" />
          Rookie Scale
        </label>
      </div>
    </div>

    <div class="text-[10px] font-medium text-muted-foreground/80 self-end pb-1"><%= @comparison_label %></div>
  </form>
</div>

<div class="h-20 w-px bg-border self-center ml-auto shrink-0"></div>
<%= render partial: "shared/commandbar_navigation", locals: { active_destination: "system_values" } %>
