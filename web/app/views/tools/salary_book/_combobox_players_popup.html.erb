<% players = Array(local_assigns[:players]) %>
<% query = local_assigns[:query].to_s %>
<% seq = local_assigns.fetch(:seq, 0).to_i %>
<% error_message = local_assigns[:error_message].to_s.strip.presence %>
<%
  empty_message = if error_message.present?
    "Search unavailable"
  elsif query.present?
    "No players found"
  else
    "Type to search players"
  end
%>

<div
  id="sbplayercb-popup"
  class="w-full overflow-hidden rounded-md border border-border bg-background shadow-sm"
  data-show="$_sbplayercbopen"
  style="display: none;"
  data-seq="<%= seq %>"
  data-effect="
    $_sbplayercbloading = false;
    $_sbplayercbechoseq = <%= seq %>;
    $_sbplayercbresultscount = <%= players.length %>;
    if ($_sbplayercbresultscount <= 0) {
      $_sbplayercbactiveindex = -1;
    } else if ($_sbplayercbactiveindex < 0 || $_sbplayercbactiveindex >= $_sbplayercbresultscount) {
      $_sbplayercbactiveindex = 0;
    }
  "
>
  <div
    id="sbplayercb-status"
    class="h-7 px-2 border-b border-border/60 bg-muted/20 flex items-center justify-between text-[10px] uppercase tracking-wide text-muted-foreground/90"
    role="status"
    aria-live="polite"
  >
    <span data-show="$_sbplayercbloading" style="display: none;">Searchingâ€¦</span>

    <% if error_message.present? %>
      <span data-show="!$_sbplayercbloading" style="display: none;">Search unavailable</span>
    <% elsif players.any? %>
      <span data-show="!$_sbplayercbloading" style="display: none;"><%= pluralize(players.length, "result") %></span>
    <% else %>
      <span data-show="!$_sbplayercbloading" style="display: none;"><%= empty_message %></span>
    <% end %>

    <span class="font-mono tabular-nums text-[10px] text-muted-foreground/70" data-show="!$_sbplayercbloading && <%= players.any? %>" style="display: none;">
      <%= query.present? ? "query: #{query.first(24)}" : "all players" %>
    </span>
  </div>

  <div id="sbplayercb-list" role="listbox" class="max-h-72 overflow-y-auto overscroll-contain py-1">
    <% if players.any? %>
      <% players.each_with_index do |player, index| %>
        <%= render partial: "tools/salary_book/combobox_players_option", locals: { player:, index: } %>
      <% end %>
    <% else %>
      <div class="px-3 py-2 text-xs text-muted-foreground"><%= empty_message %></div>
    <% end %>
  </div>
</div>
