<% initial_team = @initial_team.to_s %>

<%# Build team_id lookup for back button logos %>
<% team_id_map = @team_meta_by_code.transform_values { |meta| meta["team_id"] }.to_json %>
<% salary_book_base_path = root_path %>

<%# Season column state machine:
    - Hover/focus year header => preview (selectedseason)
    - Click year header => lock/unlock preview (seasonlocked)
%>
<div
  id="salarybook"
  class="h-screen w-screen flex flex-col overflow-hidden bg-background"
  data-signals="{
    activeteam: '<%= initial_team %>',
    selectedseason: '',
    seasonlocked: false,
    sidebarview: 'teamview',
    overlaytype: 'none',
    overlayid: '',
    sidebarteamloaded: '<%= initial_team %>',
    sidebarcapyearloaded: '<%= @salary_year %>',
    sidebardraftloaded: false,
    sidebardraftyearloaded: '',
    sidebarrightsloaded: false,
    displaycapholds: false,
    displaydeadmoney: false,
    displayepm: false,
    displayctg: false,
    displayplayercapholds: false,
    displaycashvscap: false,
    displayluxurytax: false
  }"
>
  <div id="flash"></div>

  <%# Sidebar loader: hover/locked year updates for the currently loaded team. %>
  <div
    id="salarybook-sidebar-loader"
    class="hidden"
    aria-hidden="true"
    data-effect="
      const effectiveyear = ($selectedseason !== '' ? $selectedseason : '<%= @salary_year %>');
      if ($activeteam && $sidebarteamloaded === $activeteam && String($sidebarcapyearloaded) !== String(effectiveyear)) {
        $sidebarcapyearloaded = effectiveyear;
        @get('/tools/salary-book/sidebar/team/cap?team=' + $activeteam + '&year=' + effectiveyear);
      }
    "
  ></div>

  <%# Command bar (prototype height: 130px) %>
  <header
    id="commandbar"
    class="shrink-0 h-[130px] border-b border-border bg-background flex items-start px-4 pt-3 gap-4"
  >
    <% if @teams_by_conference["Eastern"].any? || @teams_by_conference["Western"].any? %>
      <%# Team Selector Grid %>
      <div class="flex gap-4" role="navigation" aria-label="Teams">
        <% %w[Eastern Western].each do |conf| %>
          <div class="space-y-1">
            <div class="text-[10px] font-semibold uppercase tracking-wider text-muted-foreground/70"><%= conf %></div>
            <div class="grid grid-cols-5 gap-1">
              <% @teams_by_conference[conf].each do |team| %>
                <button
                  type="button"
                  class="cursor-pointer relative h-7 px-2 rounded text-xs font-medium transition-all duration-150 border outline-none inline-flex items-center justify-center"
                  data-on:click="
                    const teamcode = '<%= team[:code] %>';
                    if ($activeteam !== teamcode) {
                      $activeteam = teamcode;
                      $seasonlocked = false;
                      $selectedseason = '';
                      $sidebarteamloaded = teamcode;
                      $sidebarcapyearloaded = '<%= @salary_year %>';
                      $sidebardraftloaded = false;
                      $sidebardraftyearloaded = '';
                      $sidebarrightsloaded = false;

                      @get('/tools/salary-book/sse/switch-team?team=' + teamcode + '&year=<%= @salary_year %>');
                      window.history.replaceState({}, '', '<%= salary_book_base_path %>?team=' + teamcode + '&year=<%= @salary_year %>');
                    }
                  "
                  data-class="{
                    'bg-primary text-primary-foreground border-primary shadow-sm': $activeteam === '<%= team[:code] %>',
                    'bg-muted/50 hover:bg-muted': $activeteam !== '<%= team[:code] %>',
                    'text-red-600 dark:text-red-400 border-red-500/70 hover:border-red-500/80': '<%= team[:code] %>' === 'POR' && $activeteam !== 'POR',
                    'text-foreground border-border hover:border-foreground/20': $activeteam !== '<%= team[:code] %>' && '<%= team[:code] %>' !== 'POR'
                  }"
                  title="<%= team[:name] %>"
                ><%= team[:code] %></button>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>

      <%# Divider %>
      <div class="h-20 w-px bg-border self-center"></div>

      <%# Apps (placeholder radios; Salaries is the only active app today) %>
      <div class="min-w-[5.5rem] space-y-1" role="radiogroup" aria-label="Apps">
        <div class="text-[10px] font-semibold uppercase tracking-wider text-muted-foreground/70">Apps</div>
        <div class="space-y-1">
          <label class="flex items-center gap-1.5 cursor-not-allowed opacity-60">
            <input
              type="radio"
              id="app-injuries"
              name="salarybook-app"
              value="injuries"
              class="size-3.5 accent-primary"
              disabled
            />
            <span class="text-[11px] leading-none select-none text-muted-foreground">Injuries</span>
          </label>

          <label class="flex items-center gap-1.5 cursor-pointer">
            <input
              type="radio"
              id="app-salaries"
              name="salarybook-app"
              value="salaries"
              class="size-3.5 accent-primary"
              checked
            />
            <span class="text-[11px] leading-none select-none text-foreground font-semibold">Salaries</span>
          </label>

          <label class="flex items-center gap-1.5 cursor-not-allowed opacity-60">
            <input
              type="radio"
              id="app-tankathon"
              name="salarybook-app"
              value="tankathon"
              class="size-3.5 accent-primary"
              disabled
            />
            <span class="text-[11px] leading-none select-none text-muted-foreground">Tankathon</span>
          </label>
        </div>
      </div>

      <%# Divider %>
      <div class="h-20 w-px bg-border self-center"></div>

      <%# Filter Toggles (client-only lenses) %>
      <div class="flex items-start gap-4" role="group" aria-label="Filters">
        <div class="min-w-[5.5rem] space-y-1">
          <div class="text-[10px] font-semibold uppercase tracking-wider text-muted-foreground/70">Display</div>
          <div class="space-y-1">
            <div class="flex items-center gap-1.5">
              <input
                type="checkbox"
                id="filter-column-capholds"
                class="size-3.5 accent-primary"
                data-bind="displayplayercapholds"
                data-on:change="window.__salaryBookPreserveContext?.()"
              />
              <label for="filter-column-capholds" class="text-[11px] leading-none cursor-pointer select-none text-foreground/80 hover:text-foreground transition-colors">Cap Holds</label>
            </div>
            <div class="flex items-center gap-1.5">
              <input
                type="checkbox"
                id="filter-column-ctg"
                class="size-3.5 accent-primary"
                data-bind="displayctg"
                data-on:change="window.__salaryBookPreserveContext?.()"
              />
              <label for="filter-column-ctg" class="text-[11px] leading-none cursor-pointer select-none text-foreground/80 hover:text-foreground transition-colors">CTG</label>
            </div>
            <div class="flex items-center gap-1.5">
              <input
                type="checkbox"
                id="filter-column-epm"
                class="size-3.5 accent-primary"
                data-bind="displayepm"
                data-on:change="window.__salaryBookPreserveContext?.()"
              />
              <label for="filter-column-epm" class="text-[11px] leading-none cursor-pointer select-none text-foreground/80 hover:text-foreground transition-colors">EPM</label>
            </div>
          </div>
        </div>

        <div class="min-w-[7.5rem] space-y-1">
          <div class="text-[10px] font-semibold uppercase tracking-wider text-muted-foreground/70">Financials</div>
          <div class="space-y-1">
            <div class="flex items-center gap-1.5">
              <input
                type="checkbox"
                id="filter-cashvscap"
                class="size-3.5 accent-primary"
                data-bind="displaycashvscap"
                data-on:change="window.__salaryBookPreserveContext?.()"
              />
              <label for="filter-cashvscap" class="text-[11px] leading-none cursor-pointer select-none text-foreground/80 hover:text-foreground transition-colors">Cash vs Cap</label>
            </div>
            <div class="flex items-center gap-1.5">
              <input
                type="checkbox"
                id="filter-deadmoney"
                class="size-3.5 accent-primary"
                data-bind="displaydeadmoney"
                data-on:change="window.__salaryBookPreserveContext?.()"
              />
              <label for="filter-deadmoney" class="text-[11px] leading-none cursor-pointer select-none text-foreground/80 hover:text-foreground transition-colors">Dead Money</label>
            </div>
            <div class="flex items-center gap-1.5">
              <input
                type="checkbox"
                id="filter-capholds"
                class="size-3.5 accent-primary"
                data-bind="displaycapholds"
                data-on:change="window.__salaryBookPreserveContext?.()"
              />
              <label for="filter-capholds" class="text-[11px] leading-none cursor-pointer select-none text-foreground/80 hover:text-foreground transition-colors">FA Cap Holds</label>
            </div>
            <div class="flex items-center gap-1.5">
              <input
                type="checkbox"
                id="filter-luxurytax"
                class="size-3.5 accent-primary"
                data-bind="displayluxurytax"
                data-on:change="window.__salaryBookPreserveContext?.()"
              />
              <label for="filter-luxurytax" class="text-[11px] leading-none cursor-pointer select-none text-foreground/80 hover:text-foreground transition-colors">Tax Payment</label>
            </div>
          </div>
        </div>

      </div>

      <%# Divider %>
      <div class="h-20 w-px bg-border self-center"></div>

      <%# Player command combobox (team-scoped in v1) %>
      <div
        id="sbplayercb-root"
        class="relative min-w-[19rem] max-w-[21rem] space-y-1"
        data-combobox-root
        data-combobox-cmdk
        data-signals="{
          _sbplayercbopen: false,
          _sbplayercbquery: '',
          _sbplayercbactiveindex: -1,
          _sbplayercbloading: false,
          _sbplayercbcomposing: false,
          _sbplayercbrequestseq: 0,
          _sbplayercblastdispatchedseq: 0,
          _sbplayercbechoseq: 0,
          _sbplayercbresultscount: 0
        }"
        data-on:focusout="if (!el.contains(evt.relatedTarget)) { $_sbplayercbopen = false; $_sbplayercbactiveindex = -1; }"
      >
        <div class="text-[10px] font-semibold uppercase tracking-wider text-muted-foreground/70">Player</div>

        <div class="relative">
          <input
            id="sbplayercb-input"
            type="text"
            class="h-8 w-full rounded border border-border bg-muted/40 px-2.5 text-xs text-foreground outline-none transition-colors focus:border-foreground/25 focus:bg-background"
            placeholder="Search active team playersâ€¦"
            role="combobox"
            aria-controls="sbplayercb-list"
            aria-autocomplete="list"
            data-bind="_sbplayercbquery"
            data-attr:aria-expanded="$_sbplayercbopen ? 'true' : 'false'"
            data-attr:aria-activedescendant="$_sbplayercbactiveindex >= 0 ? ('sbplayercb-option-' + $_sbplayercbactiveindex) : ''"
            data-on:focus="$_sbplayercbopen = true; $_sbplayercbrequestseq = $_sbplayercbrequestseq + 1"
            data-on:compositionstart="$_sbplayercbcomposing = true"
            data-on:compositionend="$_sbplayercbcomposing = false; $_sbplayercbrequestseq = $_sbplayercbrequestseq + 1"
            data-on:input__debounce.120ms="if (!$_sbplayercbcomposing) { $_sbplayercbopen = true; $_sbplayercbrequestseq = $_sbplayercbrequestseq + 1; }"
            data-on:keydown="
              const root = el.closest('#sbplayercb-root');
              const options = root ? Array.from(root.querySelectorAll('[data-combobox-option]')) : [];

              if (evt.key === 'ArrowDown') {
                evt.preventDefault();
                $_sbplayercbopen = true;
                if (options.length > 0) {
                  const base = $_sbplayercbactiveindex < 0 ? -1 : $_sbplayercbactiveindex;
                  const next = Math.min(base + 1, options.length - 1);
                  $_sbplayercbactiveindex = next;
                  options[next].scrollIntoView({ block: 'nearest' });
                }
              } else if (evt.key === 'ArrowUp') {
                evt.preventDefault();
                if (options.length > 0) {
                  const base = $_sbplayercbactiveindex < 0 ? options.length : $_sbplayercbactiveindex;
                  const next = Math.max(base - 1, 0);
                  $_sbplayercbactiveindex = next;
                  options[next].scrollIntoView({ block: 'nearest' });
                }
              } else if (evt.key === 'Enter') {
                if ($_sbplayercbopen && $_sbplayercbactiveindex >= 0) {
                  const activeOption = options[$_sbplayercbactiveindex];
                  if (activeOption) {
                    evt.preventDefault();
                    activeOption.click();
                  }
                }
              } else if (evt.key === 'Escape') {
                if ($_sbplayercbopen) {
                  evt.preventDefault();
                  $_sbplayercbopen = false;
                  $_sbplayercbactiveindex = -1;
                } else if ($_sbplayercbquery !== '') {
                  $_sbplayercbquery = '';
                  $_sbplayercbrequestseq = $_sbplayercbrequestseq + 1;
                  $_sbplayercbopen = true;
                }
              } else if (evt.key === 'Tab') {
                $_sbplayercbopen = false;
                $_sbplayercbactiveindex = -1;
              }
            "
          />

          <button
            type="button"
            class="absolute right-1 top-1/2 -translate-y-1/2 h-6 px-1.5 rounded text-[10px] uppercase tracking-wide text-muted-foreground/80 hover:text-foreground hover:bg-muted/60 transition-colors"
            data-show="$_sbplayercbquery !== ''"
            style="display: none;"
            data-on:mousedown="evt.preventDefault()"
            data-on:click="$_sbplayercbquery = ''; $_sbplayercbrequestseq = $_sbplayercbrequestseq + 1; $_sbplayercbopen = true"
          >
            Clear
          </button>
        </div>

        <div
          id="sbplayercb-loader"
          class="hidden"
          aria-hidden="true"
          data-effect="
            if ($_sbplayercbopen && $_sbplayercbrequestseq > 0 && $_sbplayercbrequestseq !== $_sbplayercblastdispatchedseq) {
              $_sbplayercblastdispatchedseq = $_sbplayercbrequestseq;
              $_sbplayercbloading = true;
              @get('<%= tools_salary_book_combobox_players_search_path %>?team=' + encodeURIComponent($activeteam || '') + '&q=' + encodeURIComponent($_sbplayercbquery) + '&limit=12&seq=' + $_sbplayercbrequestseq);
            }
          "
        ></div>

        <%= render partial: "tools/salary_book/combobox_players_popup", locals: {
          players: [],
          query: "",
          seq: 0,
          error_message: nil
        } %>
      </div>
    <% else %>
      <div class="text-sm text-muted-foreground">No teams.</div>
    <% end %>

    <%# Global navigation + theme controls %>
    <div class="h-20 w-px bg-border self-center ml-auto shrink-0"></div>
    <%= render partial: "shared/commandbar_navigation", locals: { active_destination: "salary_book" } %>
  </header>

  <div id="viewport" class="flex flex-1 overflow-hidden relative">
    <%# Main canvas %>
    <%= render partial: "tools/salary_book/maincanvas", locals: {
      boot_error: @boot_error,
      salary_year: @salary_year,
      salary_years: @salary_years,
      initial_team: @initial_team,
      initial_players: @initial_players,
      initial_cap_holds: @initial_cap_holds,
      initial_exceptions: @initial_exceptions,
      initial_dead_money: @initial_dead_money,
      initial_picks: @initial_picks,
      initial_team_summaries: @initial_team_summaries_by_year,
      initial_team_meta: @initial_team_meta
    } %>

    <%# Right panel %>
    <aside
      id="rightpanel"
      class="w-[30%] min-w-[320px] max-w-[480px] border-l border-border bg-background overflow-hidden relative"
    >
      <div
        id="rightpanel-base-layer"
        class="absolute inset-0 overflow-y-auto overflow-x-hidden overscroll-y-contain scroll-touch pt-2 px-4 pb-4 transition-opacity duration-300"
      >
        <% if @initial_team.present? %>
          <%= render partial: "tools/salary_book/sidebar_team", locals: {
            team_code: @initial_team,
            summary: @initial_team_summary,
            team_meta: @initial_team_meta,
            summaries_by_year: @initial_team_summaries_by_year,
            year: @salary_year
          } %>
        <% else %>
          <div id="rightpanel-base" class="space-y-4">
            <div class="p-4 rounded-lg border border-border bg-muted/20 text-sm text-muted-foreground">
              Select a team to load context.
            </div>
          </div>
        <% end %>
      </div>

      <%# Overlay container (patched by Datastar) %>
      <div id="rightpanel-overlay"></div>
    </aside>
  </div>
</div>

<% content_for :head_scripts do %>
  <script type="module">
    import "tools/salary_book";
  </script>
  <script>
    // Team ID map for back button logos
    window.__salaryBookTeamIds = <%= raw team_id_map %>;
  </script>
<% end %>
