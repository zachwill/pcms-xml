<%
  # Batch-load canonical slugs for all player previews to avoid N+1 queries.
  prefetch_canonical_slugs(
    entity_type: "player",
    entity_ids: Array(@trades).flat_map { |t| Array(t["player_previews"]).map { |p| p["player_id"] } }
  )
%>

<div id="trades-results" class="py-3">
  <% if @trades.empty? %>
    <div class="px-4 py-8 text-sm text-muted-foreground italic text-center border-b border-border">
      No trades found for this time period and filters.
    </div>
  <% else %>
    <%
      summary = @sidebar_summary || {}

      daterange_label = case @daterange.to_s
      when "today" then "Today"
      when "week" then "This week"
      when "month" then "This month"
      when "season" then "This season"
      else "All dates"
      end
    %>

    <section class="px-4 pb-3 border-b border-border">
      <div class="flex flex-wrap items-start justify-between gap-4">
        <div class="min-w-0 space-y-2">
          <h2 class="text-sm font-semibold text-foreground">
            Trades
            <span class="text-muted-foreground font-medium">· <%= pluralize(summary[:row_count].to_i, "deal") %></span>
          </h2>

          <div class="flex flex-wrap gap-1.5 text-[10px]">
            <span class="entity-chip entity-chip--muted"><%= daterange_label %></span>
            <span class="entity-chip entity-chip--muted">Sort: <%= @sort_label %></span>
            <% if @team.present? %>
              <span class="entity-chip entity-chip--accent">Team: <%= @team %></span>
            <% end %>
            <% unless @lens == "all" %>
              <span class="entity-chip entity-chip--warning"><%= @lens_label %></span>
            <% end %>
            <% unless @composition == "all" %>
              <span class="entity-chip entity-chip--success"><%= @composition_label %></span>
            <% end %>
          </div>
        </div>

        <div class="ml-auto shrink-0 grid grid-cols-4 gap-1.5">
          <%= render partial: "salary_book/kpi_cell", locals: { label: "Assets", value: summary[:complexity_asset_total].to_i.to_s, class_name: "w-full" } %>
          <%= render partial: "salary_book/kpi_cell", locals: { label: "Complex", value: summary[:complex_deal_count].to_i.to_s, class_name: "w-full" } %>
          <%= render partial: "salary_book/kpi_cell", locals: { label: "Player", value: summary[:player_heavy_deal_count].to_i.to_s, class_name: "w-full" } %>
          <%= render partial: "salary_book/kpi_cell", locals: { label: "Pick", value: summary[:pick_heavy_deal_count].to_i.to_s, class_name: "w-full" } %>
        </div>
      </div>
    </section>

    <div id="trades-scan-rail" class="border-b border-border bg-muted/20">
      <div class="overflow-x-auto">
        <div class="flex h-8 min-w-max items-center gap-1.5 px-4 text-[10px] leading-none text-muted-foreground">
          <span class="uppercase tracking-wide text-muted-foreground/80">Deal scan rail</span>
          <span class="entity-chip entity-chip--muted"><%= @team.present? ? "#{@team} scope" : "League-wide" %></span>
          <span class="entity-chip entity-chip--muted">Rows <span class="font-mono tabular-nums"><%= summary[:row_count].to_i %></span></span>
          <span class="entity-chip entity-chip--warning">Assets <span class="font-mono tabular-nums"><%= summary[:complexity_asset_total].to_i %></span></span>
          <span class="entity-chip entity-chip--success">Player-heavy <span class="font-mono tabular-nums"><%= summary[:player_heavy_deal_count].to_i %></span></span>
          <span class="entity-chip entity-chip--accent">Pick-heavy <span class="font-mono tabular-nums"><%= summary[:pick_heavy_deal_count].to_i %></span></span>
          <span class="entity-chip entity-chip--muted">Cash/TPE <span class="font-mono tabular-nums"><%= summary[:cash_tpe_deal_count].to_i %></span></span>
        </div>
      </div>
    </div>

    <section class="overflow-x-auto border-b border-border">
      <div id="trades-board" class="min-w-[88rem] bg-background">
        <div id="trades-flex-header" class="sticky top-0 z-30 border-b border-border bg-muted">
          <div class="flex items-center h-9 px-4 text-[10px] uppercase tracking-wide text-muted-foreground/90 font-medium">
            <div class="w-36 shrink-0">Deal</div>
            <div class="w-40 shrink-0">Route</div>
            <div class="w-[26rem] shrink-0">Team impact (OUT / IN)</div>
            <div class="w-52 shrink-0">Assets</div>
            <div class="w-44 shrink-0">Composition</div>
            <div class="w-72 shrink-0">Notes</div>
          </div>
        </div>

        <div class="divide-y divide-border/60">
          <% @trades.each do |trade| %>
            <% row_id = trade["trade_id"].to_s %>
            <% open_expr = "$overlaytype = 'trade'; $overlayid = '#{row_id}'; @get('/trades/sidebar/#{row_id}')" %>
            <% teams = trade["teams_involved"].to_s.split(", ").reject(&:blank?) %>
            <% composition_labels = Array(trade["composition_labels"]) %>
            <% focus_team_code = @team.to_s.upcase.presence %>
            <% team_impacts = Array(trade["scan_team_impacts"]) %>
            <% additional_team_impact_count = trade["scan_additional_team_impact_count"].to_i %>
            <% hidden_team_codes = Array(trade["scan_hidden_team_codes"]).map { |code| code.to_s.upcase }.reject(&:blank?) %>
            <% if team_impacts.empty? %>
              <% team_impacts = Array(trade["team_impacts"]) %>
              <% additional_team_impact_count = 0 %>
              <% hidden_team_codes = [] %>
            <% end %>
            <% player_previews = Array(trade["player_previews"]) %>
            <% additional_player_preview_count = trade["additional_player_preview_count"].to_i %>

            <div
              class="group cursor-pointer hover:bg-yellow-50/70 dark:hover:bg-yellow-900/10 transition-colors duration-75"
              role="button"
              tabindex="0"
              data-class="{ 'bg-yellow-100/80 dark:bg-yellow-900/20': $overlaytype === 'trade' && $overlayid === '<%= row_id %>' }"
              data-on:click="<%= open_expr %>"
              data-on:keydown="if (evt.key === 'Enter' || evt.key === ' ') { evt.preventDefault(); <%= open_expr %>; }"
            >
              <div class="flex items-center min-h-[56px] px-4 text-xs">
                <div class="w-36 shrink-0 pr-2">
                  <div class="entity-cell-two-line">
                    <div class="entity-cell-primary justify-start gap-1.5 min-w-0">
                      <a href="<%= trade_path(trade['trade_id']) %>" class="font-medium font-mono tabular-nums hover:underline" onclick="event.stopPropagation()">#<%= trade["trade_id"] %></a>
                      <% if trade["trade_finalized_date"].present? %>
                        <span class="entity-chip entity-chip--accent">finalized</span>
                      <% end %>
                    </div>
                    <div class="entity-cell-secondary justify-start font-mono tabular-nums"><%= format_plain_date(trade["trade_date"]) %></div>
                  </div>
                </div>

                <div class="w-40 shrink-0 pr-2">
                  <div class="entity-cell-two-line">
                    <div class="entity-cell-primary justify-start gap-1.5">
                      <span class="entity-chip entity-chip--muted"><%= trade["team_count"].to_i %>T</span>
                      <span class="entity-chip entity-chip--warning"><%= trade["complexity_asset_count"].to_i %> assets</span>
                    </div>
                    <div class="entity-cell-secondary justify-start truncate"><%= teams.any? ? teams.join(" · ") : "No team map" %></div>
                  </div>
                </div>

                <div class="w-[26rem] shrink-0 pr-2">
                  <% if team_impacts.any? %>
                    <div class="space-y-0.5">
                      <% team_impacts.each_with_index do |impact, impact_index| %>
                        <% net_variant = trade_impact_net_variant(impact) %>
                        <% net_chip_class = case net_variant
                           when :net_in then "entity-chip entity-chip--success"
                           when :net_out then "entity-chip entity-chip--danger"
                           else "entity-chip entity-chip--muted"
                           end %>
                        <% team_code = impact["team_code"].presence || "—" %>
                        <% normalized_team_code = impact["team_code"].to_s.upcase %>
                        <% is_focus_team = focus_team_code.present? && normalized_team_code == focus_team_code %>
                        <% is_last_visible_impact = impact_index == team_impacts.size - 1 %>

                        <div class="flex items-center gap-1 min-w-0 overflow-hidden text-[10px] leading-none tabular-nums">
                          <a href="<%= team_href(team_code: impact['team_code'], team_id: impact['team_id']) %>" class="font-semibold shrink-0 hover:underline" onclick="event.stopPropagation()"><%= team_code %></a>

                          <% if is_focus_team %>
                            <span class="entity-chip entity-chip--accent shrink-0">scope</span>
                          <% end %>

                          <span class="<%= net_chip_class %> shrink-0"><%= trade_impact_net_label(impact) %></span>
                          <span class="text-red-600 dark:text-red-400 shrink-0">OUT <%= trade_impact_flow_label(impact, direction: :out, compact: true) %></span>
                          <span class="text-muted-foreground/50 shrink-0">·</span>
                          <span class="text-emerald-600 dark:text-emerald-400 flex-1 min-w-0 truncate">IN <%= trade_impact_flow_label(impact, direction: :in, compact: true) %></span>

                          <% if is_last_visible_impact && additional_team_impact_count.positive? %>
                            <% hidden_summary = hidden_team_codes.any? ? " (#{hidden_team_codes.join(', ')})" : "" %>
                            <span class="text-muted-foreground/40 shrink-0">·</span>
                            <span class="inline-flex items-center rounded bg-muted px-1 py-0.5 text-[9px] leading-none font-medium text-muted-foreground shrink-0" title="+<%= additional_team_impact_count %> additional team impacts<%= hidden_summary %>">+<%= additional_team_impact_count %>T</span>
                          <% end %>
                        </div>
                      <% end %>
                    </div>
                  <% else %>
                    <span class="text-[11px] text-muted-foreground">No team impact map</span>
                  <% end %>
                </div>

                <div class="w-52 shrink-0 pr-2">
                  <div class="entity-cell-two-line">
                    <div class="entity-cell-primary justify-start gap-1.5 min-w-0">
                      <% if player_previews.any? %>
                        <div class="min-w-0 flex items-center gap-1 truncate">
                          <% player_previews.first(2).each_with_index do |preview, index| %>
                            <% player_id = preview["player_id"].to_i %>
                            <% player_name = preview["player_name"].presence || (player_id.positive? ? "Player ##{player_id}" : "Player") %>
                            <% if index.positive? %>
                              <span class="text-muted-foreground/40">·</span>
                            <% end %>
                            <% if player_id.positive? %>
                              <a href="<%= player_href(player_id) %>" class="font-medium truncate hover:underline" onclick="event.stopPropagation()"><%= player_name %></a>
                            <% else %>
                              <span class="font-medium truncate"><%= player_name %></span>
                            <% end %>
                          <% end %>
                        </div>

                        <% if additional_player_preview_count.positive? %>
                          <span class="entity-chip entity-chip--muted">+<%= additional_player_preview_count %></span>
                        <% end %>
                      <% else %>
                        <span class="entity-chip entity-chip--muted">No player preview</span>
                      <% end %>
                    </div>

                    <div class="entity-cell-secondary justify-start tabular-nums gap-1.5">
                      <span class="entity-chip entity-chip--success"><%= trade["player_count"].to_i %>P</span>
                      <span class="entity-chip entity-chip--accent"><%= trade["pick_count"].to_i %>K</span>
                      <span><%= trade["cash_line_count"].to_i %> cash</span>
                      <span class="text-muted-foreground/50">·</span>
                      <span><%= trade["tpe_line_count"].to_i %> TPE</span>
                    </div>
                  </div>
                </div>

                <div class="w-44 shrink-0 pr-2">
                  <div class="entity-cell-two-line">
                    <div class="entity-cell-primary justify-start gap-1 flex-wrap">
                      <% composition_labels.each do |label| %>
                        <% chip_class = case label
                           when "Player-heavy" then "entity-chip entity-chip--success"
                           when "Pick-heavy" then "entity-chip entity-chip--accent"
                           when "Cash/TPE" then "entity-chip entity-chip--warning"
                           else "entity-chip entity-chip--muted"
                           end %>
                        <span class="<%= chip_class %>"><%= label %></span>
                      <% end %>
                    </div>
                    <div class="entity-cell-secondary justify-start"><%= trade["trade_finalized_date"].present? ? "Finalized" : "Pending finalization" %></div>
                  </div>
                </div>

                <div class="w-72 shrink-0 pr-1">
                  <div class="entity-cell-two-line">
                    <div class="entity-cell-primary justify-start text-[11px] truncate"><%= trade["trade_comments"].presence || "—" %></div>
                    <div class="entity-cell-secondary justify-start truncate"><%= teams.any? ? teams.join(" · ") : "No team map" %></div>
                  </div>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </section>
  <% end %>
</div>
