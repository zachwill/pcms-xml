<%
  pane_query_expr = "'q=' + encodeURIComponent($teamsquery || '') +
    '&conference=' + encodeURIComponent($teamsconference || 'ALL') +
    '&pressure=' + encodeURIComponent($teamspressure || 'all') +
    '&sort=' + encodeURIComponent($teamssort || 'pressure_desc')"

  selected_overlay_query_expr = "'selected_id=' + encodeURIComponent($overlaytype === 'team' ? $selectedteamid : '')"
  refresh_query_expr = "(#{pane_query_expr}) + '&' + (#{selected_overlay_query_expr})"

  refresh_expr = "@get('/teams/sse/refresh?' + (#{refresh_query_expr})); const nextUrl = '/teams?' + (#{pane_query_expr}); if ((window.location.pathname + window.location.search) !== nextUrl) { window.history.replaceState({}, '', nextUrl); }"
  apply_search_expr = "if ((evt.key || '') === 'Enter') { evt.preventDefault(); #{refresh_expr}; }"
  clear_search_expr = "$teamsquery = ''; #{refresh_expr}"

  conference_options = [
    ['ALL', 'All'],
    ['Eastern', 'East'],
    ['Western', 'West']
  ]

  pressure_options = [
    ['all', 'All teams'],
    ['over_cap', 'Over Cap'],
    ['over_tax', 'Over Tax'],
    ['over_apron1', 'Over Apron 1'],
    ['over_apron2', 'Over Apron 2']
  ]

  sort_options = [
    ['pressure_desc', 'Pressure first'],
    ['cap_space_asc', 'Cap tightest'],
    ['tax_room_asc', 'Tax tightest'],
    ['team_asc', 'Team Aâ†’Z']
  ]

  pressure_counts = @commandbar_lane_counts || @pressure_counts || {}
  active_count = @commandbar_active_count || Array(@teams).size
%>

<header
  id="commandbar"
  class="shrink-0 h-[130px] border-b border-border bg-background px-4 pt-3 flex items-start gap-4 select-none"
>
  <div class="flex items-start min-w-0 overflow-x-auto pb-1">
    <div class="min-w-[14rem] w-[14rem] space-y-1.5">
      <div class="text-[10px] font-semibold uppercase tracking-wider text-muted-foreground/70">Search Teams</div>

      <input
        type="text"
        value="<%= @query %>"
        placeholder="Team, city, conference"
        class="h-7 w-full rounded border border-border bg-background px-2 text-xs text-foreground outline-none focus-visible:border-foreground"
        data-bind="teamsquery"
        data-on:keydown="<%= apply_search_expr %>"
      />

      <div class="flex items-center gap-1.5">
        <button
          type="button"
          class="cursor-pointer h-7 px-2 rounded border border-border bg-muted/40 text-[11px] font-medium text-foreground hover:bg-muted transition-colors"
          data-on:click="<%= refresh_expr %>"
        >Search</button>

        <button
          type="button"
          class="cursor-pointer h-7 px-2 rounded border border-border bg-background text-[11px] text-muted-foreground hover:text-foreground hover:bg-muted/40 transition-colors"
          data-on:click="<%= clear_search_expr %>"
        >Clear</button>

        <span class="text-[10px] text-muted-foreground/80 font-mono tabular-nums"><%= active_count %> rows</span>
      </div>
    </div>

    <div class="h-20 w-px bg-border self-center shrink-0 mx-3"></div>

    <div class="min-w-[8rem] w-[8rem] space-y-1">
      <div class="text-[10px] font-semibold uppercase tracking-wider text-muted-foreground/70">Conference</div>

      <div class="space-y-1">
        <% conference_options.each do |value, label| %>
          <label class="flex items-center gap-1.5 cursor-pointer select-none">
            <input
              type="radio"
              name="teams-conference"
              value="<%= value %>"
              class="size-3.5 accent-primary"
              <%= 'checked' if @conference_lens == value %>
              data-bind="teamsconference"
              data-on:change="if (el.checked) { <%= refresh_expr %>; }"
            />
            <span
              class="text-[11px] leading-none"
              data-class="{ 'text-foreground font-semibold': $teamsconference === '<%= value %>', 'text-muted-foreground': $teamsconference !== '<%= value %>' }"
            ><%= label %></span>
          </label>
        <% end %>
      </div>
    </div>

    <div class="h-20 w-px bg-border self-center shrink-0 mx-3"></div>

    <div class="min-w-[10.5rem] w-[10.5rem] space-y-1">
      <div class="text-[10px] font-semibold uppercase tracking-wider text-muted-foreground/70">Pressure Lens</div>

      <div class="space-y-1">
        <% pressure_options.each do |value, label| %>
          <label class="flex items-center justify-between gap-2 cursor-pointer select-none">
            <span class="flex items-center gap-1.5">
              <input
                type="radio"
                name="teams-pressure"
                value="<%= value %>"
                class="size-3.5 accent-primary"
                <%= 'checked' if @pressure_lens == value %>
                data-bind="teamspressure"
                data-on:change="if (el.checked) { <%= refresh_expr %>; }"
              />
              <span
                class="text-[11px] leading-none"
                data-class="{ 'text-foreground font-semibold': $teamspressure === '<%= value %>', 'text-muted-foreground': $teamspressure !== '<%= value %>' }"
              ><%= label %></span>
            </span>
            <span class="font-mono tabular-nums text-[10px] text-muted-foreground"><%= pressure_counts[value].to_i %></span>
          </label>
        <% end %>
      </div>
    </div>

    <div class="h-20 w-px bg-border self-center shrink-0 mx-3"></div>

    <div class="min-w-[11rem] w-[11rem] space-y-1">
      <div class="text-[10px] font-semibold uppercase tracking-wider text-muted-foreground/70">Sort</div>

      <div class="space-y-1">
        <% sort_options.each do |value, label| %>
          <label class="flex items-center gap-1.5 cursor-pointer select-none">
            <input
              type="radio"
              name="teams-sort"
              value="<%= value %>"
              class="size-3.5 accent-primary"
              <%= 'checked' if @sort_lens == value %>
              data-bind="teamssort"
              data-on:change="if (el.checked) { <%= refresh_expr %>; }"
            />
            <span
              class="text-[11px] leading-none"
              data-class="{ 'text-foreground font-semibold': $teamssort === '<%= value %>', 'text-muted-foreground': $teamssort !== '<%= value %>' }"
            ><%= label %></span>
          </label>
        <% end %>
      </div>
    </div>
  </div>

  <div class="h-20 w-px bg-border self-center ml-auto shrink-0"></div>
  <%= render partial: 'shared/commandbar_navigation', locals: { active_destination: 'teams' } %>
</header>
