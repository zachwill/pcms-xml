<%
  pane_query_expr = "'q=' + encodeURIComponent($teamsquery || '') +
    '&conference=' + encodeURIComponent($teamsconference || 'ALL') +
    '&pressure=' + encodeURIComponent($teamspressure || 'all') +
    '&sort=' + encodeURIComponent($teamssort || 'pressure_desc')"

  selected_overlay_query_expr = "'selected_id=' + encodeURIComponent($overlaytype === 'team' ? $selectedteamid : '')"
  refresh_query_expr = "(#{pane_query_expr}) + '&' + (#{selected_overlay_query_expr})"

  refresh_expr = "@get('/teams/sse/refresh?' + (#{refresh_query_expr})); const nextUrl = '/teams?' + (#{pane_query_expr}); if ((window.location.pathname + window.location.search) !== nextUrl) { window.history.replaceState({}, '', nextUrl); }"
  apply_search_expr = "if ((evt.key || '') === 'Enter') { evt.preventDefault(); #{refresh_expr}; }"
  clear_search_expr = "$teamsquery = ''; #{refresh_expr}"
  reset_filters_expr = "$teamsquery = ''; $teamsconference = 'ALL'; $teamspressure = 'all'; $teamssort = 'pressure_desc'; #{refresh_expr}"

  pressure_options = [
    ["all", "All teams"],
    ["over_cap", "Over Cap"],
    ["over_tax", "Over Tax"],
    ["over_apron1", "Over Apron 1"],
    ["over_apron2", "Over Apron 2"]
  ]

  sort_options = [
    ["pressure_desc", "Pressure first"],
    ["cap_space_asc", "Cap tightest"],
    ["tax_room_asc", "Tax tightest"],
    ["team_asc", "Team Aâ†’Z"]
  ]

  conference_options = [
    ["ALL", "All"],
    ["Eastern", "East"],
    ["Western", "West"]
  ]

  pressure_counts = @commandbar_lane_counts || @pressure_counts || {}
  active_count = @commandbar_active_count || Array(@teams).size
%>

<header
  id="commandbar"
  class="shrink-0 h-[130px] border-b border-border bg-background px-4 pt-3 flex items-start gap-4 select-none"
>
  <div class="flex items-start min-w-0 overflow-x-auto pb-1">
    <div class="min-w-[15rem] w-[15rem] space-y-1.5">
      <div class="text-[10px] font-semibold uppercase tracking-wider text-muted-foreground/70">Search Teams</div>

      <input
        type="text"
        value="<%= @query %>"
        placeholder="Team, city, conference"
        class="h-7 w-full rounded border border-border bg-background px-2 text-xs text-foreground outline-none focus-visible:border-foreground"
        data-bind="teamsquery"
        data-on:keydown="<%= apply_search_expr %>"
      />

      <div class="flex items-center gap-1.5">
        <button
          type="button"
          class="cursor-pointer h-7 px-2 rounded border border-border bg-muted/40 text-[11px] font-medium text-foreground hover:bg-muted transition-colors"
          data-on:click="<%= refresh_expr %>"
        >Apply</button>

        <button
          type="button"
          class="cursor-pointer h-7 px-2 rounded border border-border bg-background text-[11px] text-muted-foreground hover:text-foreground hover:bg-muted/40 transition-colors"
          data-on:click="<%= clear_search_expr %>"
        >Clear</button>

        <button
          type="button"
          class="cursor-pointer h-7 px-2 rounded border border-border bg-background text-[11px] text-muted-foreground hover:text-foreground hover:bg-muted/40 transition-colors"
          data-on:click="<%= reset_filters_expr %>"
        >Reset</button>
      </div>
    </div>

    <div class="h-20 w-px bg-border self-center shrink-0 mx-3"></div>

    <div class="min-w-[8.5rem] w-[8.5rem] space-y-1.5">
      <div class="text-[10px] font-semibold uppercase tracking-wider text-muted-foreground/70">Conference</div>
      <select
        class="h-7 w-full rounded border border-border bg-background px-2 text-xs text-foreground outline-none focus-visible:border-foreground"
        data-bind="teamsconference"
        data-on:change="<%= refresh_expr %>"
      >
        <% conference_options.each do |value, label| %>
          <option value="<%= value %>" <%= "selected" if @conference_lens == value %>><%= label %></option>
        <% end %>
      </select>

      <div class="text-[10px] text-muted-foreground/80 tabular-nums"><%= active_count %> rows</div>
    </div>

    <div class="h-20 w-px bg-border self-center shrink-0 mx-3"></div>

    <div class="min-w-[10rem] w-[10rem] space-y-1.5">
      <div class="text-[10px] font-semibold uppercase tracking-wider text-muted-foreground/70">Pressure</div>
      <select
        class="h-7 w-full rounded border border-border bg-background px-2 text-xs text-foreground outline-none focus-visible:border-foreground"
        data-bind="teamspressure"
        data-on:change="<%= refresh_expr %>"
      >
        <% pressure_options.each do |value, label| %>
          <option value="<%= value %>" <%= "selected" if @pressure_lens == value %>><%= label %></option>
        <% end %>
      </select>

      <div class="text-[10px] text-muted-foreground/80 tabular-nums">
        <span class="font-medium text-foreground"><%= pressure_counts[@pressure_lens].to_i %></span>
        in lens
      </div>
    </div>

    <div class="h-20 w-px bg-border self-center shrink-0 mx-3"></div>

    <div class="min-w-[10rem] w-[10rem] space-y-1.5">
      <div class="text-[10px] font-semibold uppercase tracking-wider text-muted-foreground/70">Sort</div>
      <select
        class="h-7 w-full rounded border border-border bg-background px-2 text-xs text-foreground outline-none focus-visible:border-foreground"
        data-bind="teamssort"
        data-on:change="<%= refresh_expr %>"
      >
        <% sort_options.each do |value, label| %>
          <option value="<%= value %>" <%= "selected" if @sort_lens == value %>><%= label %></option>
        <% end %>
      </select>

      <div class="text-[10px] text-muted-foreground/80">Cap/tax pressure board</div>
    </div>

    <div class="h-20 w-px bg-border self-center shrink-0 mx-3"></div>

    <div class="min-w-[15rem] w-[15rem] space-y-1.5">
      <div class="text-[10px] font-semibold uppercase tracking-wider text-muted-foreground/70">Pressure snapshot</div>

      <div class="grid grid-cols-2 gap-1 text-[10px] tabular-nums">
        <span class="inline-flex items-center justify-between rounded border border-border/70 bg-muted/20 px-1.5 py-0.5 text-muted-foreground">
          All
          <span class="text-foreground"><%= pressure_counts["all"].to_i %></span>
        </span>
        <span class="inline-flex items-center justify-between rounded border border-border/70 bg-muted/20 px-1.5 py-0.5 text-muted-foreground">
          Over Cap
          <span class="text-foreground"><%= pressure_counts["over_cap"].to_i %></span>
        </span>
        <span class="inline-flex items-center justify-between rounded border border-border/70 bg-muted/20 px-1.5 py-0.5 text-muted-foreground">
          Over Tax
          <span class="text-foreground"><%= pressure_counts["over_tax"].to_i %></span>
        </span>
        <span class="inline-flex items-center justify-between rounded border border-border/70 bg-muted/20 px-1.5 py-0.5 text-muted-foreground">
          Over A2
          <span class="text-red-600 dark:text-red-400"><%= pressure_counts["over_apron2"].to_i %></span>
        </span>
      </div>
    </div>
  </div>

  <div class="h-20 w-px bg-border self-center ml-auto shrink-0"></div>
  <%= render partial: "shared/commandbar_navigation", locals: { active_destination: "teams" } %>
</header>
