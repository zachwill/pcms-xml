<%
  team = team_row || {}

  team_id = team["team_id"]
  team_code = team["team_code"].to_s
  team_name = team["team_name"].to_s
  conference_name = team["conference_name"].presence || "—"
  city_name = team["city"].presence

  pressure_bucket = team["pressure_bucket"].to_s
  pressure_label, pressure_chip_classes = case pressure_bucket
    when "over_apron2"
      ["Over Apron 2", "entity-chip entity-chip--danger"]
    when "over_apron1"
      ["Over Apron 1", "entity-chip entity-chip--warning"]
    when "over_tax"
      ["Over Tax", "entity-chip entity-chip--warning"]
    when "over_cap"
      ["Over Cap", "entity-chip entity-chip--muted"]
    else
      ["Under Cap", "entity-chip entity-chip--success"]
    end

  team_page_href = team_href(team_code: team_code, team_id: team_id)

  team_summary_pressure = case pressure_bucket
    when "over_apron2", "over_apron1", "over_tax"
      pressure_bucket
    else
      "all"
    end
  team_summary_conference = %w[Eastern Western].include?(conference_name) ? conference_name : "all"
  team_summary_href = team_summary_path(
    year: 2025,
    conference: team_summary_conference,
    pressure: team_summary_pressure,
    sort: "team_asc"
  ) + "#team-summary-row-#{team_code.downcase}"

  salary_book_href = "/?team=#{team_code}##{team_code}"
%>

<div id="rightpanel-overlay" class="absolute inset-0 z-30 h-full bg-background">
  <div class="sticky top-0 z-20 h-10 px-4 flex items-center justify-between border-b border-border bg-background">
    <%= render partial: "shared/rightpanel_back_button", locals: {
      click_expr: "$overlaytype = ''; $selectedteamid = ''; @get('/teams/sidebar/clear')"
    } %>

    <a href="<%= team_page_href %>" class="text-xs text-muted-foreground hover:text-foreground hover:underline">Open team page</a>
  </div>

  <div class="px-4 py-4 overflow-y-auto h-[calc(100%-40px)]">
    <section>
      <div class="flex items-center gap-3">
        <div class="w-11 h-11 rounded border border-border bg-background overflow-hidden flex items-center justify-center shrink-0">
          <img
            src="<%= team_logo_url(team_id) %>"
            alt="<%= team_code %>"
            class="w-full h-full object-contain"
            loading="lazy"
            decoding="async"
            onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
          />
          <span class="hidden text-[10px] font-semibold text-muted-foreground"><%= team_code %></span>
        </div>

        <div class="min-w-0">
          <h2 class="text-base font-semibold truncate"><%= team_name %></h2>
          <div class="text-[11px] text-muted-foreground/80"><%= team_code %> · <%= conference_name %><% if city_name.present? %> · <%= city_name %><% end %></div>
        </div>
      </div>

      <div class="mt-2 flex flex-wrap items-center gap-1.5 text-[10px]">
        <span class="<%= pressure_chip_classes %>"><%= pressure_label %></span>
        <% if team["is_repeater_taxpayer"] %>
          <span class="entity-chip entity-chip--danger">Repeater</span>
        <% elsif team["is_taxpayer"] %>
          <span class="entity-chip entity-chip--warning">Taxpayer</span>
        <% else %>
          <span class="entity-chip entity-chip--muted">No tax</span>
        <% end %>
        <% if team["is_subject_to_apron"] %>
          <span class="entity-chip entity-chip--accent"><%= team["apron_level_lk"].presence || "Apron" %></span>
        <% end %>
      </div>
    </section>

    <section class="mt-4 border-t border-border pt-4">
      <div class="grid grid-cols-2 gap-1.5">
        <%= render partial: "salary_book/kpi_cell", locals: {
          label: "Cap space",
          value: team["cap_space"].nil? ? "—" : format_room_amount(team["cap_space"]),
          class_name: "w-full",
          variant: (team["cap_space"].to_f < 0 ? "negative" : "positive")
        } %>

        <%= render partial: "salary_book/kpi_cell", locals: {
          label: "Room tax",
          value: team["room_under_tax"].nil? ? "—" : format_room_amount(team["room_under_tax"]),
          class_name: "w-full",
          variant: (team["room_under_tax"].to_f < 0 ? "negative" : "default")
        } %>

        <%= render partial: "salary_book/kpi_cell", locals: {
          label: "Room A1",
          value: team["room_under_apron1"].nil? ? "—" : format_room_amount(team["room_under_apron1"]),
          class_name: "w-full",
          variant: (team["room_under_apron1"].to_f < 0 ? "negative" : "default")
        } %>

        <%= render partial: "salary_book/kpi_cell", locals: {
          label: "Room A2",
          value: team["room_under_apron2"].nil? ? "—" : format_room_amount(team["room_under_apron2"]),
          class_name: "w-full",
          variant: (team["room_under_apron2"].to_f < 0 ? "negative" : "default")
        } %>
      </div>
    </section>

    <section class="mt-4 border-t border-border pt-4 space-y-2">
      <div class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Pressure signals</div>

      <div class="space-y-0.5">
        <div class="flex items-center justify-between py-1.5 gap-2">
          <span class="text-sm text-muted-foreground">Current bucket</span>
          <span class="<%= pressure_chip_classes %>"><%= pressure_label %></span>
        </div>

        <div class="flex items-center justify-between py-1.5 gap-2">
          <span class="text-sm text-muted-foreground">Luxury tax owed</span>
          <span class="text-sm font-medium font-mono tabular-nums <%= team['luxury_tax_owed'].to_f > 0 ? 'text-red-600 dark:text-red-400' : 'text-muted-foreground' %>"><%= team["luxury_tax_owed"].to_f > 0 ? format_compact_currency(team["luxury_tax_owed"]) : "—" %></span>
        </div>

        <div class="flex items-center justify-between py-1.5 gap-2">
          <span class="text-sm text-muted-foreground">Roster / Two-way</span>
          <span class="text-sm font-medium font-mono tabular-nums"><%= team["roster_row_count"].to_i %> / <%= team["two_way_row_count"].to_i %></span>
        </div>
      </div>
    </section>

    <section class="mt-4 border-t border-border pt-3 space-y-1.5 text-[11px]">
      <div class="text-[10px] uppercase tracking-wide font-semibold text-muted-foreground/80">Pivots</div>
      <a href="<%= team_page_href %>" class="block text-muted-foreground hover:text-foreground hover:underline">Open canonical team page</a>
      <a href="<%= team_summary_href %>" class="block text-muted-foreground hover:text-foreground hover:underline">Open Team Summary at this team</a>
      <a href="<%= salary_book_href %>" class="block text-muted-foreground hover:text-foreground hover:underline">Open Salary Book for <%= team_code %></a>
    </section>
  </div>
</div>
