<%
  pane_query_expr = "'q=' + encodeURIComponent($agentquery) +
    '&kind=' + $entitykind +
    '&active_only=' + ($activeonly ? '1' : '0') +
    '&certified_only=' + ($certifiedonly ? '1' : '0') +
    '&with_clients=' + ($withclients ? '1' : '0') +
    '&with_book=' + ($withbook ? '1' : '0') +
    '&with_restrictions=' + ($withrestrictions ? '1' : '0') +
    '&with_expiring=' + ($withexpiring ? '1' : '0') +
    '&agency_id=' + encodeURIComponent($agencyfilterid) +
    '&year=' + $bookyear +
    '&sort=' + $sortkey +
    '&dir=' + $sortdir +
    '&agency_scope=' + ($agencyscopeactive ? '1' : '0') +
    '&agency_scope_id=' + encodeURIComponent($agencyscopeid)"

  selected_overlay_query_expr = "'selected_type=' + encodeURIComponent($overlaytype) +
    '&selected_id=' + encodeURIComponent($overlayid) +
    '&selected_return_type=' + encodeURIComponent($overlayreturntype || '') +
    '&selected_return_id=' + encodeURIComponent($overlayreturnid || '')"

  sse_get_expr = "@get('/agents/sse/refresh?' + (#{pane_query_expr}) + '&' + (#{selected_overlay_query_expr}))"
  update_url_expr = "window.history.replaceState({}, '', '/agents?' + (#{pane_query_expr}))"
  refresh_expr = "#{sse_get_expr}; #{update_url_expr}"

  sort_options = if @directory_kind.to_s == "agencies"
    [
      ["book", "Book"],
      ["clients", "Clients"],
      ["agents", "Agents"],
      ["teams", "Teams"],
      ["max", "Max"],
      ["expirings", "Exp"],
      ["options", "Opts"],
      ["name", "Name"]
    ]
  else
    [
      ["book", "Book"],
      ["clients", "Clients"],
      ["teams", "Teams"],
      ["max", "Max"],
      ["expirings", "Exp"],
      ["options", "Opts"],
      ["name", "Name"]
    ]
  end

  agency_filter_choices = [["", "All agencies"]] + Array(@agency_filter_options).map do |row|
    next if row["agency_id"].blank? || row["agency_name"].blank?

    [
      row["agency_id"].to_s,
      "#{row['agency_name']} · #{row['client_count'].to_i} clients"
    ]
  end.compact

  agency_scope_choices = [["", "No scope (all agents)"]] + agency_filter_choices.drop(1)
  scope_name = @sidebar_summary&.dig(:agency_scope_name).presence || Array(@agency_filter_options).find { |row| row["agency_id"].to_i == @agency_scope_id.to_i }&.dig("agency_name")
  scope_label = scope_name.presence || (@agency_scope_id.present? ? "Agency ##{@agency_scope_id}" : nil)
  scope_checkbox_label = scope_label.present? ? "Scoped: #{scope_label}" : "Agency scope"

  scope_toggle_expr = "if ($agencyscopeactive && !$agencyscopeid) { $agencyscopeid = $overlaytype === 'agency' ? $overlayid : $agencyfilterid; }; if (!$agencyscopeid) { $agencyscopeactive = false; }; #{refresh_expr}"
  scope_select_expr = "$agencyscopeactive = $agencyscopeid !== ''; #{refresh_expr}"
  clear_search_expr = "$agentquery = ''; #{refresh_expr}"
%>

<header id="commandbar" class="shrink-0 h-[130px] border-b border-border bg-background px-4 pt-3 flex items-start gap-4 select-none">
  <div class="flex items-start min-w-0 overflow-x-auto pb-1">
    <div class="min-w-[12rem] w-[12rem] space-y-2">
      <div class="space-y-1">
        <div class="text-[10px] font-semibold uppercase tracking-wider text-muted-foreground/70">Directory</div>
        <div class="space-y-1">
          <label class="flex items-center gap-1.5 cursor-pointer select-none">
            <input
              type="radio"
              id="agents-directory-agents"
              name="agents-directory-kind"
              value="agents"
              class="size-3.5 accent-primary"
              <%= "checked" if @directory_kind == "agents" %>
              data-bind="entitykind"
              data-on:change="<%= refresh_expr %>"
            />
            <span class="text-[11px] leading-none text-foreground/90">Agents</span>
          </label>

          <label class="flex items-center gap-1.5 cursor-pointer select-none">
            <input
              type="radio"
              id="agents-directory-agencies"
              name="agents-directory-kind"
              value="agencies"
              class="size-3.5 accent-primary"
              <%= "checked" if @directory_kind == "agencies" %>
              data-bind="entitykind"
              data-on:change="<%= refresh_expr %>"
            />
            <span class="text-[11px] leading-none text-foreground/90">Agencies</span>
          </label>
        </div>
      </div>

      <div class="space-y-1">
        <div class="text-[10px] font-semibold uppercase tracking-wider text-muted-foreground/70">Year</div>
        <div class="flex items-center gap-2">
          <% [2025, 2026, 2027].each do |year| %>
            <label class="flex items-center gap-1 cursor-pointer select-none">
              <input
                type="radio"
                id="agents-book-year-<%= year %>"
                name="agents-book-year"
                value="<%= year %>"
                class="size-3.5 accent-primary"
                <%= "checked" if @book_year == year %>
                data-bind="bookyear"
                data-on:change="<%= refresh_expr %>"
              />
              <span class="text-[11px] leading-none tabular-nums text-foreground/90"><%= year %></span>
            </label>
          <% end %>
        </div>
      </div>
    </div>

    <div class="h-20 w-px bg-border self-center shrink-0 mx-3"></div>

    <div class="min-w-[27rem] w-[27rem] space-y-2">
      <div class="space-y-1">
        <div class="text-[10px] font-semibold uppercase tracking-wider text-muted-foreground/70">Search</div>
        <div class="flex items-center gap-1.5">
          <input
            id="agents-search"
            type="text"
            placeholder="Agent or agency"
            class="h-7 w-full rounded border border-border bg-background px-2 text-xs text-foreground"
            data-bind="agentquery"
            data-on:keydown="if (evt.key === 'Enter') { evt.preventDefault(); <%= refresh_expr %>; }"
          />
          <button
            type="button"
            class="cursor-pointer h-7 px-2 rounded border border-border text-[10px] font-semibold uppercase tracking-wide text-foreground/80 hover:text-foreground hover:border-foreground/20"
            data-on:click="<%= refresh_expr %>"
          >Apply</button>
          <button
            type="button"
            class="cursor-pointer h-7 px-2 rounded border border-border text-[10px] font-semibold uppercase tracking-wide text-muted-foreground hover:text-foreground hover:border-foreground/20"
            data-show="$agentquery !== ''"
            style="display: none;"
            data-on:click="<%= clear_search_expr %>"
          >Clear</button>
        </div>
      </div>

      <div class="grid grid-cols-[1fr_auto] gap-2">
        <div class="space-y-1">
          <div class="text-[10px] font-semibold uppercase tracking-wider text-muted-foreground/70">Agency</div>
          <select
            id="agents-filter-agency"
            class="h-7 w-full rounded border border-border bg-background px-2 text-xs text-foreground"
            data-bind="agencyfilterid"
            data-on:change="<%= refresh_expr %>"
          >
            <% agency_filter_choices.each do |(value, label)| %>
              <option value="<%= value %>" <%= "selected" if @agency_filter_id.to_s == value.to_s %>><%= label %></option>
            <% end %>
          </select>
        </div>

        <div class="space-y-1 min-w-[9.75rem]">
          <div class="text-[10px] font-semibold uppercase tracking-wider text-muted-foreground/70">Sort</div>
          <div class="flex items-center gap-1.5">
            <select
              id="agents-sort-key"
              class="h-7 w-24 rounded border border-border bg-background px-2 text-xs text-foreground"
              data-bind="sortkey"
              data-on:change="<%= refresh_expr %>"
            >
              <% sort_options.each do |(value, label)| %>
                <option value="<%= value %>" <%= "selected" if @sort_key == value %>><%= label %></option>
              <% end %>
            </select>

            <label class="flex items-center gap-1 cursor-pointer select-none">
              <input
                type="radio"
                id="agents-sort-desc"
                name="agents-sort-direction"
                value="desc"
                class="size-3.5 accent-primary"
                <%= "checked" if @sort_dir == "desc" %>
                data-bind="sortdir"
                data-on:change="<%= refresh_expr %>"
              />
              <span class="text-[11px] leading-none text-foreground/90">↓</span>
            </label>

            <label class="flex items-center gap-1 cursor-pointer select-none">
              <input
                type="radio"
                id="agents-sort-asc"
                name="agents-sort-direction"
                value="asc"
                class="size-3.5 accent-primary"
                <%= "checked" if @sort_dir == "asc" %>
                data-bind="sortdir"
                data-on:change="<%= refresh_expr %>"
              />
              <span class="text-[11px] leading-none text-foreground/90">↑</span>
            </label>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-[auto_1fr] items-center gap-2">
        <label class="flex items-center gap-1.5 cursor-pointer select-none">
          <input
            type="checkbox"
            id="agents-scope-active"
            class="size-3.5 accent-primary"
            <%= "checked" if @agency_scope_active && @agency_scope_id.present? %>
            data-bind="agencyscopeactive"
            data-on:change="<%= scope_toggle_expr %>"
          />
          <span class="text-[11px] leading-none text-foreground/90"><%= scope_checkbox_label %></span>
        </label>

        <select
          id="agents-scope-select"
          class="h-7 w-full rounded border border-border bg-background px-2 text-xs text-foreground"
          data-bind="agencyscopeid"
          data-on:change="<%= scope_select_expr %>"
        >
          <% agency_scope_choices.each do |(value, label)| %>
            <option value="<%= value %>" <%= "selected" if @agency_scope_id.to_s == value.to_s %>><%= label %></option>
          <% end %>
        </select>
      </div>
    </div>

    <div class="h-20 w-px bg-border self-center shrink-0 mx-3"></div>

    <div class="min-w-[16rem] w-[16rem] space-y-1">
      <div class="text-[10px] font-semibold uppercase tracking-wider text-muted-foreground/70">Filters</div>
      <div class="grid grid-cols-2 gap-y-1 gap-x-3">
        <label class="flex items-center gap-1.5 cursor-pointer select-none">
          <input type="checkbox" id="agents-filter-active" class="size-3.5 accent-primary" <%= "checked" if @active_only %> data-bind="activeonly" data-on:change="<%= refresh_expr %>" />
          <span class="text-[11px] leading-none text-foreground/90">Active</span>
        </label>

        <label class="flex items-center gap-1.5 cursor-pointer select-none">
          <input type="checkbox" id="agents-filter-certified" class="size-3.5 accent-primary" <%= "checked" if @certified_only %> data-bind="certifiedonly" data-on:change="<%= refresh_expr %>" />
          <span class="text-[11px] leading-none text-foreground/90">Certified</span>
        </label>

        <label class="flex items-center gap-1.5 cursor-pointer select-none">
          <input type="checkbox" id="agents-filter-clients" class="size-3.5 accent-primary" <%= "checked" if @with_clients %> data-bind="withclients" data-on:change="<%= refresh_expr %>" />
          <span class="text-[11px] leading-none text-foreground/90">Clients &gt; 0</span>
        </label>

        <label class="flex items-center gap-1.5 cursor-pointer select-none">
          <input type="checkbox" id="agents-filter-book" class="size-3.5 accent-primary" <%= "checked" if @with_book %> data-bind="withbook" data-on:change="<%= refresh_expr %>" />
          <span class="text-[11px] leading-none text-foreground/90">Book &gt; 0</span>
        </label>

        <label class="flex items-center gap-1.5 cursor-pointer select-none">
          <input type="checkbox" id="agents-filter-expiring" class="size-3.5 accent-primary" <%= "checked" if @with_expiring %> data-bind="withexpiring" data-on:change="<%= refresh_expr %>" />
          <span class="text-[11px] leading-none text-foreground/90">Expiring</span>
        </label>

        <label class="flex items-center gap-1.5 cursor-pointer select-none">
          <input type="checkbox" id="agents-filter-restricted" class="size-3.5 accent-primary" <%= "checked" if @with_restrictions %> data-bind="withrestrictions" data-on:change="<%= refresh_expr %>" />
          <span class="text-[11px] leading-none text-foreground/90">Restricted</span>
        </label>
      </div>
    </div>
  </div>

  <div class="h-20 w-px bg-border self-center ml-auto shrink-0"></div>
  <%= render partial: "shared/commandbar_navigation", locals: { active_destination: "agents" } %>
</header>
