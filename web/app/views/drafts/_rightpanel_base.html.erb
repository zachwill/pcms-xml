<% summary = @sidebar_summary.is_a?(Hash) ? @sidebar_summary : {} %>
<% view = summary[:view].to_s.presence || @view.to_s %>
<% severity_counts = summary[:severity_counts].is_a?(Hash) ? summary[:severity_counts] : {} %>
<% ownership_risk_legend = @ownership_risk_legend.is_a?(Hash) ? @ownership_risk_legend : {} %>
<% normal_count = ownership_risk_legend.fetch(:normal_count, severity_counts.fetch("normal", summary[:normal_count].to_i)).to_i %>
<% at_risk_count = ownership_risk_legend.fetch(:at_risk_count, severity_counts.fetch("at_risk", summary[:at_risk_count].to_i)).to_i %>
<% critical_count = ownership_risk_legend.fetch(:critical_count, severity_counts.fetch("critical", summary[:critical_count].to_i)).to_i %>
<%
  scope_total_label = if summary[:row_count].present?
    "#{summary[:row_count].to_i} rows"
  elsif summary[:cell_count].present?
    "#{summary[:cell_count].to_i} cells"
  else
    "—"
  end
%>

<div id="rightpanel-base" class="space-y-3">
  <section class="rounded border border-border overflow-hidden">
    <div class="px-3 py-2 border-b border-border bg-muted/40">
      <div class="flex items-start justify-between gap-2">
        <div>
          <div class="text-[10px] uppercase tracking-wide text-muted-foreground/80">Workspace</div>
          <div class="text-sm font-semibold text-foreground">Drafts</div>
        </div>

        <div class="text-right text-[11px] tabular-nums text-muted-foreground">
          <div class="text-foreground font-medium"><%= scope_total_label %></div>
          <div><%= summary[:sort_label].presence || @sort_label %></div>
        </div>
      </div>
    </div>

    <div class="px-3 py-2.5 space-y-2.5">
      <% if view == "picks" %>
        <div class="grid grid-cols-3 gap-1.5">
          <%= render partial: "salary_book/kpi_cell", locals: { label: "Rows", value: summary[:row_count].to_i.to_s, class_name: "w-full" } %>
          <%= render partial: "salary_book/kpi_cell", locals: { label: "At risk", value: summary[:at_risk_count].to_i.to_s, class_name: "w-full" } %>
          <%= render partial: "salary_book/kpi_cell", locals: { label: "Critical", value: summary[:critical_count].to_i.to_s, class_name: "w-full", variant: (summary[:critical_count].to_i.positive? ? "negative" : "muted") } %>
          <%= render partial: "salary_book/kpi_cell", locals: { label: "Traded", value: summary[:traded_count].to_i.to_s, class_name: "w-full" } %>
          <%= render partial: "salary_book/kpi_cell", locals: { label: "Conditional", value: summary[:conditional_count].to_i.to_s, class_name: "w-full" } %>
          <%= render partial: "salary_book/kpi_cell", locals: { label: "Prov.", value: summary[:provenance_trade_total].to_i.to_s, class_name: "w-full" } %>
        </div>
      <% elsif view == "selections" %>
        <div class="grid grid-cols-3 gap-1.5">
          <%= render partial: "salary_book/kpi_cell", locals: { label: "Rows", value: summary[:row_count].to_i.to_s, class_name: "w-full" } %>
          <%= render partial: "salary_book/kpi_cell", locals: { label: "At risk", value: summary[:at_risk_count].to_i.to_s, class_name: "w-full" } %>
          <%= render partial: "salary_book/kpi_cell", locals: { label: "Critical", value: summary[:critical_count].to_i.to_s, class_name: "w-full", variant: (summary[:critical_count].to_i.positive? ? "negative" : "muted") } %>
          <%= render partial: "salary_book/kpi_cell", locals: { label: "R1", value: summary[:first_round_count].to_i.to_s, class_name: "w-full" } %>
          <%= render partial: "salary_book/kpi_cell", locals: { label: "With trade", value: summary[:with_trade_count].to_i.to_s, class_name: "w-full" } %>
          <%= render partial: "salary_book/kpi_cell", locals: { label: "Prov.", value: summary[:provenance_trade_total].to_i.to_s, class_name: "w-full" } %>
        </div>
      <% else %>
        <div class="grid grid-cols-3 gap-1.5">
          <%= render partial: "salary_book/kpi_cell", locals: { label: "Teams", value: summary[:team_count].to_i.to_s, class_name: "w-full" } %>
          <%= render partial: "salary_book/kpi_cell", locals: { label: "Years", value: summary[:year_count].to_i.to_s, class_name: "w-full" } %>
          <%= render partial: "salary_book/kpi_cell", locals: { label: "Cells", value: summary[:cell_count].to_i.to_s, class_name: "w-full" } %>
          <%= render partial: "salary_book/kpi_cell", locals: { label: "At risk", value: summary[:at_risk_count].to_i.to_s, class_name: "w-full" } %>
          <%= render partial: "salary_book/kpi_cell", locals: { label: "Critical", value: summary[:critical_count].to_i.to_s, class_name: "w-full", variant: (summary[:critical_count].to_i.positive? ? "negative" : "muted") } %>
          <%= render partial: "salary_book/kpi_cell", locals: { label: "Prov.", value: summary[:provenance_trade_total].to_i.to_s, class_name: "w-full" } %>
        </div>
      <% end %>

      <div class="flex flex-wrap items-center gap-1 text-[10px]">
        <span class="entity-chip entity-chip--muted">Normal <span class="ml-0.5 font-mono tabular-nums"><%= normal_count %></span></span>
        <span class="entity-chip entity-chip--warning">At risk <span class="ml-0.5 font-mono tabular-nums"><%= at_risk_count %></span></span>
        <span class="entity-chip entity-chip--danger">Critical <span class="ml-0.5 font-mono tabular-nums"><%= critical_count %></span></span>
        <% if summary[:lens_label].present? && summary[:lens_label] != "All rows" %>
          <span class="entity-chip entity-chip--accent"><%= summary[:lens_label] %></span>
        <% end %>
      </div>

      <% if Array(summary[:filters]).any? %>
        <div class="flex flex-wrap gap-1">
          <% Array(summary[:filters]).each do |label| %>
            <span class="entity-chip entity-chip--muted"><%= label %></span>
          <% end %>
        </div>
      <% end %>
    </div>
  </section>

  <% if view == "picks" && Array(summary[:top_rows]).any? %>
    <section class="rounded border border-border overflow-hidden">
      <div class="px-3 py-2 border-b border-border bg-muted/40 text-[10px] uppercase tracking-wide text-muted-foreground/80">Quick picks</div>
      <div class="divide-y divide-border">
        <% Array(summary[:top_rows]).first(10).each do |row| %>
          <% key = "pick-#{row['original_team_code']}-#{row['draft_year']}-#{row['draft_round']}" %>
          <% open_expr = "$overlaytype = 'pick'; $overlaykey = '#{key}'; @get('/drafts/sidebar/pick?team=#{row['original_team_code']}&year=#{row['draft_year']}&round=#{row['draft_round']}&overlay_key=#{key}')" %>
          <button
            type="button"
            class="cursor-pointer w-full px-3 py-2 text-left hover:bg-yellow-50/70 dark:hover:bg-yellow-900/10 transition-colors duration-75"
            data-class="{ 'bg-yellow-100/80 dark:bg-yellow-900/20': $overlaytype === 'pick' && $overlaykey === '<%= key %>' }"
            data-on:click="<%= open_expr %>"
          >
            <div class="entity-cell-two-line">
              <div class="entity-cell-primary justify-between gap-2">
                <span class="font-medium"><%= row["draft_year"] %> R<%= row["draft_round"] %> · <%= row["original_team_code"] %></span>
                <span class="font-mono tabular-nums text-[11px]"><%= row["current_team_code"] %></span>
              </div>
              <div class="entity-cell-secondary truncate">
                <span><%= row["protections_summary"].presence || row["pick_status"].presence || "Own" %></span>
                <span class="px-1 text-muted-foreground/50">·</span>
                <span>risk <%= row["ownership_risk_score"].to_i %> · P<%= row["provenance_trade_count"].to_i %></span>
              </div>
            </div>
          </button>
        <% end %>
      </div>
    </section>
  <% elsif view == "selections" && Array(summary[:top_rows]).any? %>
    <section class="rounded border border-border overflow-hidden">
      <div class="px-3 py-2 border-b border-border bg-muted/40 text-[10px] uppercase tracking-wide text-muted-foreground/80">Quick selections</div>
      <div class="divide-y divide-border">
        <% Array(summary[:top_rows]).first(10).each do |row| %>
          <% key = "selection-#{row['transaction_id']}" %>
          <% open_expr = "$overlaytype = 'selection'; $overlaykey = '#{key}'; @get('/drafts/sidebar/selection/#{row['transaction_id']}?overlay_key=#{key}')" %>
          <button
            type="button"
            class="cursor-pointer w-full px-3 py-2 text-left hover:bg-yellow-50/70 dark:hover:bg-yellow-900/10 transition-colors duration-75"
            data-class="{ 'bg-yellow-100/80 dark:bg-yellow-900/20': $overlaytype === 'selection' && $overlaykey === '<%= key %>' }"
            data-on:click="<%= open_expr %>"
          >
            <div class="entity-cell-two-line">
              <div class="entity-cell-primary justify-between gap-2">
                <span class="font-medium"><%= row["draft_year"] %> R<%= row["draft_round"] %> P<%= row["pick_number"] %></span>
                <span class="font-mono tabular-nums text-[11px]">#<%= row["transaction_id"] %></span>
              </div>
              <div class="entity-cell-secondary truncate">
                <span><%= row["player_name"].presence || "Unknown player" %> · <%= row["drafting_team_code"] %></span>
                <span class="px-1 text-muted-foreground/50">·</span>
                <span>P<%= row["provenance_trade_count"].to_i %></span>
              </div>
            </div>
          </button>
        <% end %>
      </div>
    </section>
  <% else %>
    <section class="rounded border border-border bg-muted/20 p-3 text-[11px] text-muted-foreground">
      Select a row from the main table to inspect protections and provenance details.
    </section>
  <% end %>
</div>
