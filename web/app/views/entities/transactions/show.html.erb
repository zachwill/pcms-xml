<% tx = @transaction %>
<% content_for :title, "Transaction ##{tx['transaction_id']}" %>

<% prefetch_canonical_slugs(entity_type: "player", entity_ids: [tx["player_id"]] + @trade_transactions.map { |r| r["player_id"] } + @cap_exception_usage_rows.map { |r| r["player_id"] } + @cap_dead_money_rows.map { |r| r["player_id"] } + @cap_budget_snapshot_rows.map { |r| r["player_id"] }) %>
<% prefetch_canonical_slugs(entity_type: "team", entity_ids: [tx["from_team_id"], tx["to_team_id"], tx["rights_team_id"], tx["sign_and_trade_team_id"]] + @ledger_entries.map { |r| r["team_id"] } + @cap_exception_usage_rows.map { |r| r["team_id"] } + @cap_dead_money_rows.map { |r| r["team_id"] } + @cap_budget_snapshot_rows.map { |r| r["team_id"] }) %>

<%
  party_rows = []
  {
    "From" => [tx["from_team_code"], tx["from_team_id"], tx["from_team_name"]],
    "To" => [tx["to_team_code"], tx["to_team_id"], tx["to_team_name"]],
    "Rights" => [tx["rights_team_code"], tx["rights_team_id"], tx["rights_team_name"]],
    "S&T" => [tx["sign_and_trade_team_code"], tx["sign_and_trade_team_id"], tx["sign_and_trade_team_name"]]
  }.each do |role, tuple|
    code, id, name = tuple
    next if code.blank? && id.blank?

    party_rows << { role: role, team_code: code, team_id: id, team_name: name }
  end

  delta_by_team = @ledger_entries.group_by { |r| [r["team_id"], r["team_code"]] }.transform_values do |rows|
    {
      cap_change: rows.sum { |v| v["cap_change"].to_f },
      tax_change: rows.sum { |v| v["tax_change"].to_f },
      apron_change: rows.sum { |v| v["apron_change"].to_f },
      mts_change: rows.sum { |v| v["mts_change"].to_f }
    }
  end

  timeline_ledger_rows = @ledger_entries.sort_by do |row|
    parsed_date = begin
      Date.parse(row["ledger_date"].to_s)
    rescue ArgumentError, TypeError
      nil
    end

    [parsed_date || Date.new(1900, 1, 1), row["transaction_ledger_entry_id"].to_i]
  end

  net_cap_change = @ledger_entries.sum { |row| row["cap_change"].to_f }
  net_tax_change = @ledger_entries.sum { |row| row["tax_change"].to_f }
  net_apron_change = @ledger_entries.sum { |row| row["apron_change"].to_f }

  route_label = [tx["from_team_code"], tx["to_team_code"]].compact.reject(&:blank?).join(" → ").presence || "—"

  artifact_row_count = @cap_exception_usage_rows.size + @cap_dead_money_rows.size + @cap_budget_snapshot_rows.size

  constraint_chips = []
  constraint_chips << ["Touches trade ##{tx['trade_id']}", "entity-chip--accent"] if tx["trade_id"].present?
  constraint_chips << ["Exception rows #{@cap_exception_usage_rows.size}", "entity-chip--warning"] if @cap_exception_usage_rows.any?
  constraint_chips << ["Dead money rows #{@cap_dead_money_rows.size}", "entity-chip--danger"] if @cap_dead_money_rows.any?
  constraint_chips << ["Budget snapshot rows #{@cap_budget_snapshot_rows.size}", "entity-chip--muted"] if @cap_budget_snapshot_rows.any?

  numeric_delta_class = lambda do |value|
    amount = value.to_f
    if amount.positive?
      "text-emerald-600 dark:text-emerald-400"
    elsif amount.negative?
      "text-red-500"
    else
      "text-muted-foreground"
    end
  end
%>

<div id="entity-directory" class="min-h-screen w-full bg-background">
  <%= render partial: "entities/shared/commandbar", locals: {
    active_entity_scope: "transactions"
  } %>

  <main class="px-4 pb-8 space-y-6" data-entity-workspace>
    <%= render partial: "entities/shared/workspace_header", locals: {
      breadcrumbs: [["Transactions", "/transactions"], ["##{tx['transaction_id']}", nil]],
      title: "Transaction ##{tx['transaction_id']}",
      subtitle: [format_plain_date(tx['transaction_date']), tx['transaction_type_lk'], tx['transaction_description_lk']].compact.join(' · '),
      right_links: [["Open Salary Book", "/tools/salary-book"], ["Open related trade", (tx['trade_id'].present? ? trade_href(tx['trade_id']) : nil)]].compact
    } %>

    <div class="lg:flex lg:gap-8">
      <%= render partial: "entities/shared/local_nav", locals: {
        sections: [
          ["timeline", "Causal timeline"],
          ["trade-context", "Trade context"],
          ["endnotes", "Endnotes"]
        ]
      } %>

      <div class="min-w-0 flex-1 space-y-6">
        <section id="timeline" class="scroll-mt-24 space-y-3">
          <div class="flex flex-wrap items-center justify-between gap-2">
            <h2 class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Causal timeline</h2>
            <div class="flex flex-wrap gap-1.5 text-[10px]">
              <span class="entity-chip entity-chip--muted"><%= party_rows.size %> parties</span>
              <span class="entity-chip entity-chip--accent"><%= timeline_ledger_rows.size %> ledger rows</span>
              <span class="entity-chip entity-chip--warning"><%= artifact_row_count %> artifact rows</span>
            </div>
          </div>

          <div class="rounded-lg border border-border overflow-hidden">
            <div class="divide-y divide-border/60">
              <article class="group px-3 py-2 transition-colors duration-75 hover:bg-yellow-50/70 dark:hover:bg-yellow-900/10">
                <div class="flex flex-wrap items-start gap-3">
                  <div class="w-32 shrink-0 entity-cell-two-line">
                    <div class="entity-cell-primary font-semibold uppercase tracking-wide text-[10px]">1 · Transaction facts</div>
                    <div class="entity-cell-secondary font-mono tabular-nums">Txn #<%= tx["transaction_id"] %></div>
                  </div>

                  <div class="min-w-0 flex-1 space-y-1">
                    <div class="text-sm font-medium"><%= tx["transaction_description_lk"].presence || tx["transaction_type_lk"].presence || "Transaction record" %></div>
                    <div class="text-[11px] text-muted-foreground">
                      <span class="font-mono tabular-nums"><%= format_plain_date(tx["transaction_date"]) %></span>
                      · <span><%= tx["transaction_type_lk"].presence || "type unavailable" %></span>
                      · <span>Route <%= route_label %></span>
                    </div>

                    <div class="flex flex-wrap items-center gap-2 text-[11px]">
                      <% if tx["player_id"].present? %>
                        <a href="<%= player_href(tx['player_id']) %>" class="hover:underline">Player <span class="font-medium"><%= tx["player_name"] %></span></a>
                      <% end %>
                      <% if tx["trade_id"].present? %>
                        <a href="<%= trade_href(tx['trade_id']) %>" class="hover:underline">Trade #<%= tx["trade_id"] %></a>
                      <% end %>
                      <a href="<%= transaction_href(tx['transaction_id']) %>" class="hover:underline">Direct link</a>
                      <% if @draft_selection.present? %>
                        <span class="entity-chip entity-chip--muted">Draft R<%= @draft_selection["draft_round"] %> #<%= @draft_selection["pick_number"] %></span>
                      <% end %>
                    </div>
                  </div>

                  <div class="flex items-start gap-1">
                    <div class="w-24 entity-cell-two-line">
                      <div class="entity-cell-primary justify-end font-mono tabular-nums <%= numeric_delta_class.call(net_cap_change) %>"><%= format_salary(net_cap_change) %></div>
                      <div class="entity-cell-secondary justify-end">Cap Δ</div>
                    </div>
                    <div class="w-24 entity-cell-two-line">
                      <div class="entity-cell-primary justify-end font-mono tabular-nums <%= numeric_delta_class.call(net_tax_change) %>"><%= format_salary(net_tax_change) %></div>
                      <div class="entity-cell-secondary justify-end">Tax Δ</div>
                    </div>
                    <div class="w-24 entity-cell-two-line">
                      <div class="entity-cell-primary justify-end font-mono tabular-nums <%= numeric_delta_class.call(net_apron_change) %>"><%= format_salary(net_apron_change) %></div>
                      <div class="entity-cell-secondary justify-end">Apron Δ</div>
                    </div>
                  </div>
                </div>

                <% if constraint_chips.any? %>
                  <div class="mt-2 flex flex-wrap gap-1.5">
                    <% constraint_chips.each do |label, klass| %>
                      <span class="entity-chip <%= klass %>"><%= label %></span>
                    <% end %>
                  </div>
                <% end %>
              </article>

              <article class="px-3 py-2 bg-muted/20">
                <div class="text-[10px] font-semibold uppercase tracking-wide text-muted-foreground">2 · Parties + routing</div>
              </article>

              <% if party_rows.empty? %>
                <div class="px-3 py-3 text-sm text-muted-foreground italic">No team party rows for this transaction.</div>
              <% else %>
                <% party_rows.each do |row| %>
                  <% deltas = delta_by_team[[row[:team_id], row[:team_code]]] || {} %>
                  <article class="group px-3 py-2 transition-colors duration-75 hover:bg-yellow-50/70 dark:hover:bg-yellow-900/10">
                    <div class="flex flex-wrap items-start gap-3">
                      <div class="w-28 shrink-0 entity-cell-two-line">
                        <div class="entity-cell-primary text-xs uppercase tracking-wide text-muted-foreground"><%= row[:role] %></div>
                        <div class="entity-cell-secondary"><%= route_label %></div>
                      </div>

                      <div class="min-w-0 flex-1 space-y-1">
                        <div class="text-sm font-medium">
                          <a href="<%= safe_team_href(team_code: row[:team_code], team_id: row[:team_id]) %>" class="hover:underline"><%= row[:team_code].presence || row[:team_id] %></a>
                          <span class="text-muted-foreground"> · <%= row[:team_name].presence || "team" %></span>
                        </div>

                        <div class="flex flex-wrap items-center gap-2 text-[11px] text-muted-foreground">
                          <% if tx["player_id"].present? %>
                            <a href="<%= player_href(tx['player_id']) %>" class="hover:underline">Player <%= tx["player_name"] %></a>
                          <% end %>
                          <% if tx["trade_id"].present? %>
                            <a href="<%= trade_href(tx['trade_id']) %>" class="hover:underline">Trade #<%= tx["trade_id"] %></a>
                          <% end %>
                          <a href="<%= transaction_href(tx['transaction_id']) %>" class="hover:underline">Txn #<%= tx["transaction_id"] %></a>
                        </div>
                      </div>

                      <div class="flex items-start gap-1">
                        <div class="w-20 entity-cell-two-line">
                          <div class="entity-cell-primary justify-end font-mono tabular-nums <%= numeric_delta_class.call(deltas[:cap_change]) %>"><%= format_salary(deltas[:cap_change]) %></div>
                          <div class="entity-cell-secondary justify-end">Cap Δ</div>
                        </div>
                        <div class="w-20 entity-cell-two-line">
                          <div class="entity-cell-primary justify-end font-mono tabular-nums <%= numeric_delta_class.call(deltas[:tax_change]) %>"><%= format_salary(deltas[:tax_change]) %></div>
                          <div class="entity-cell-secondary justify-end">Tax Δ</div>
                        </div>
                        <div class="w-20 entity-cell-two-line">
                          <div class="entity-cell-primary justify-end font-mono tabular-nums <%= numeric_delta_class.call(deltas[:apron_change]) %>"><%= format_salary(deltas[:apron_change]) %></div>
                          <div class="entity-cell-secondary justify-end">Apron Δ</div>
                        </div>
                      </div>
                    </div>
                  </article>
                <% end %>
              <% end %>

              <article class="px-3 py-2 bg-muted/20">
                <div class="text-[10px] font-semibold uppercase tracking-wide text-muted-foreground">3 · Ledger deltas</div>
              </article>

              <% if timeline_ledger_rows.empty? %>
                <div class="px-3 py-3 text-sm text-muted-foreground italic">No ledger rows for this transaction.</div>
              <% else %>
                <% timeline_ledger_rows.each do |row| %>
                  <article class="group px-3 py-2 transition-colors duration-75 hover:bg-yellow-50/70 dark:hover:bg-yellow-900/10">
                    <div class="flex flex-wrap items-start gap-3">
                      <div class="w-32 shrink-0 entity-cell-two-line">
                        <div class="entity-cell-primary text-xs font-mono tabular-nums"><%= format_plain_date(row["ledger_date"]) %></div>
                        <div class="entity-cell-secondary"><%= [row["transaction_type_lk"], row["transaction_description_lk"]].compact.reject(&:blank?).join(" · ").presence || "Ledger event" %></div>
                      </div>

                      <div class="min-w-0 flex-1 space-y-1">
                        <div class="text-sm font-medium">
                          <% if row["team_id"].present? || row["team_code"].present? %>
                            <a href="<%= safe_team_href(team_code: row['team_code'], team_id: row['team_id']) %>" class="hover:underline"><%= row["team_code"].presence || row["team_id"] %></a>
                            <% if row["team_name"].present? %>
                              <span class="text-muted-foreground"> · <%= row["team_name"] %></span>
                            <% end %>
                          <% else %>
                            <span class="text-muted-foreground">Team unavailable</span>
                          <% end %>
                        </div>

                        <div class="flex flex-wrap items-center gap-2 text-[11px] text-muted-foreground">
                          <% if tx["player_id"].present? %>
                            <a href="<%= player_href(tx['player_id']) %>" class="hover:underline">Player <%= tx["player_name"] %></a>
                          <% end %>
                          <% if tx["trade_id"].present? %>
                            <a href="<%= trade_href(tx['trade_id']) %>" class="hover:underline">Trade #<%= tx["trade_id"] %></a>
                          <% end %>
                          <a href="<%= transaction_href(tx['transaction_id']) %>" class="hover:underline">Txn #<%= tx["transaction_id"] %></a>
                        </div>
                      </div>

                      <div class="flex items-start gap-1">
                        <div class="w-20 entity-cell-two-line">
                          <div class="entity-cell-primary justify-end font-mono tabular-nums <%= numeric_delta_class.call(row['cap_change']) %>"><%= format_salary(row["cap_change"]) %></div>
                          <div class="entity-cell-secondary justify-end">Cap Δ</div>
                        </div>
                        <div class="w-20 entity-cell-two-line">
                          <div class="entity-cell-primary justify-end font-mono tabular-nums <%= numeric_delta_class.call(row['tax_change']) %>"><%= format_salary(row["tax_change"]) %></div>
                          <div class="entity-cell-secondary justify-end">Tax Δ</div>
                        </div>
                        <div class="w-20 entity-cell-two-line">
                          <div class="entity-cell-primary justify-end font-mono tabular-nums <%= numeric_delta_class.call(row['apron_change']) %>"><%= format_salary(row["apron_change"]) %></div>
                          <div class="entity-cell-secondary justify-end">Apron Δ</div>
                        </div>
                        <div class="w-20 entity-cell-two-line">
                          <div class="entity-cell-primary justify-end font-mono tabular-nums <%= numeric_delta_class.call(row['mts_change']) %>"><%= format_salary(row["mts_change"]) %></div>
                          <div class="entity-cell-secondary justify-end">MTS Δ</div>
                        </div>
                      </div>
                    </div>
                  </article>
                <% end %>
              <% end %>

              <article class="px-3 py-2 bg-muted/20">
                <div class="text-[10px] font-semibold uppercase tracking-wide text-muted-foreground">4 · Cap artifacts</div>
              </article>

              <% if artifact_row_count.zero? %>
                <div class="px-3 py-3 text-sm text-muted-foreground italic">No cap artifact rows tied to this transaction.</div>
              <% else %>
                <% @cap_exception_usage_rows.each do |row| %>
                  <article class="group px-3 py-2 transition-colors duration-75 hover:bg-yellow-50/70 dark:hover:bg-yellow-900/10">
                    <div class="flex flex-wrap items-start gap-3">
                      <div class="w-32 shrink-0 entity-cell-two-line">
                        <div class="entity-cell-primary text-xs uppercase tracking-wide">Exception usage</div>
                        <div class="entity-cell-secondary font-mono tabular-nums"><%= format_plain_date(row["effective_date"]) %></div>
                      </div>

                      <div class="min-w-0 flex-1 space-y-1">
                        <div class="text-sm font-medium"><%= row["exception_type_label"].presence || row["exception_type_lk"].presence || "Exception" %></div>
                        <div class="flex flex-wrap items-center gap-2 text-[11px] text-muted-foreground">
                          <% if row["team_id"].present? || row["team_code"].present? %>
                            <a href="<%= safe_team_href(team_code: row['team_code'], team_id: row['team_id']) %>" class="hover:underline">Team <%= row["team_code"].presence || row["team_id"] %></a>
                          <% end %>
                          <% if row["player_id"].present? %>
                            <a href="<%= player_href(row['player_id']) %>" class="hover:underline">Player <%= row["player_name"] %></a>
                          <% end %>
                          <% if tx["trade_id"].present? %>
                            <a href="<%= trade_href(tx['trade_id']) %>" class="hover:underline">Trade #<%= tx["trade_id"] %></a>
                          <% end %>
                          <a href="<%= transaction_href(tx['transaction_id']) %>" class="hover:underline">Txn #<%= tx["transaction_id"] %></a>
                        </div>
                      </div>

                      <div class="flex items-start gap-1">
                        <div class="w-24 entity-cell-two-line">
                          <div class="entity-cell-primary justify-end font-mono tabular-nums <%= numeric_delta_class.call(row['change_amount']) %>"><%= format_salary(row["change_amount"]) %></div>
                          <div class="entity-cell-secondary justify-end">Change</div>
                        </div>
                        <div class="w-24 entity-cell-two-line">
                          <div class="entity-cell-primary justify-end font-mono tabular-nums"><%= format_salary(row["remaining_exception_amount"]) %></div>
                          <div class="entity-cell-secondary justify-end">Remaining</div>
                        </div>
                      </div>
                    </div>
                  </article>
                <% end %>

                <% @cap_dead_money_rows.each do |row| %>
                  <article class="group px-3 py-2 transition-colors duration-75 hover:bg-yellow-50/70 dark:hover:bg-yellow-900/10">
                    <div class="flex flex-wrap items-start gap-3">
                      <div class="w-32 shrink-0 entity-cell-two-line">
                        <div class="entity-cell-primary text-xs uppercase tracking-wide">Dead money</div>
                        <div class="entity-cell-secondary font-mono tabular-nums"><%= format_year_label(row["salary_year"]) %></div>
                      </div>

                      <div class="min-w-0 flex-1 space-y-1">
                        <div class="text-sm font-medium"><%= row["player_name"].presence || "Player unavailable" %></div>
                        <div class="flex flex-wrap items-center gap-2 text-[11px] text-muted-foreground">
                          <% if row["team_id"].present? || row["team_code"].present? %>
                            <a href="<%= safe_team_href(team_code: row['team_code'], team_id: row['team_id']) %>" class="hover:underline">Team <%= row["team_code"].presence || row["team_id"] %></a>
                          <% end %>
                          <% if row["player_id"].present? %>
                            <a href="<%= player_href(row['player_id']) %>" class="hover:underline">Player profile</a>
                          <% end %>
                          <% if tx["trade_id"].present? %>
                            <a href="<%= trade_href(tx['trade_id']) %>" class="hover:underline">Trade #<%= tx["trade_id"] %></a>
                          <% end %>
                          <a href="<%= transaction_href(tx['transaction_id']) %>" class="hover:underline">Txn #<%= tx["transaction_id"] %></a>
                        </div>
                      </div>

                      <div class="flex items-start gap-1">
                        <div class="w-20 entity-cell-two-line">
                          <div class="entity-cell-primary justify-end font-mono tabular-nums"><%= format_salary(row["cap_value"]) %></div>
                          <div class="entity-cell-secondary justify-end">Cap</div>
                        </div>
                        <div class="w-20 entity-cell-two-line">
                          <div class="entity-cell-primary justify-end font-mono tabular-nums"><%= format_salary(row["tax_value"]) %></div>
                          <div class="entity-cell-secondary justify-end">Tax</div>
                        </div>
                        <div class="w-20 entity-cell-two-line">
                          <div class="entity-cell-primary justify-end font-mono tabular-nums"><%= format_salary(row["apron_value"]) %></div>
                          <div class="entity-cell-secondary justify-end">Apron</div>
                        </div>
                      </div>
                    </div>
                  </article>
                <% end %>

                <% @cap_budget_snapshot_rows.each do |row| %>
                  <article class="group px-3 py-2 transition-colors duration-75 hover:bg-yellow-50/70 dark:hover:bg-yellow-900/10">
                    <div class="flex flex-wrap items-start gap-3">
                      <div class="w-32 shrink-0 entity-cell-two-line">
                        <div class="entity-cell-primary text-xs uppercase tracking-wide">Budget snapshot</div>
                        <div class="entity-cell-secondary font-mono tabular-nums"><%= format_year_label(row["salary_year"]) %></div>
                      </div>

                      <div class="min-w-0 flex-1 space-y-1">
                        <div class="text-sm font-medium"><%= row["budget_group_label"].presence || row["budget_group_lk"].presence || "Budget posture" %></div>
                        <div class="flex flex-wrap items-center gap-2 text-[11px] text-muted-foreground">
                          <% if row["team_id"].present? || row["team_code"].present? %>
                            <a href="<%= safe_team_href(team_code: row['team_code'], team_id: row['team_id']) %>" class="hover:underline">Team <%= row["team_code"].presence || row["team_id"] %></a>
                          <% end %>
                          <% if row["player_id"].present? %>
                            <a href="<%= player_href(row['player_id']) %>" class="hover:underline">Player <%= row["player_name"] %></a>
                          <% end %>
                          <% if tx["trade_id"].present? %>
                            <a href="<%= trade_href(tx['trade_id']) %>" class="hover:underline">Trade #<%= tx["trade_id"] %></a>
                          <% end %>
                          <a href="<%= transaction_href(tx['transaction_id']) %>" class="hover:underline">Txn #<%= tx["transaction_id"] %></a>
                        </div>
                      </div>

                      <div class="flex items-start gap-1">
                        <div class="w-20 entity-cell-two-line">
                          <div class="entity-cell-primary justify-end font-mono tabular-nums"><%= format_salary(row["cap_amount"]) %></div>
                          <div class="entity-cell-secondary justify-end">Cap</div>
                        </div>
                        <div class="w-20 entity-cell-two-line">
                          <div class="entity-cell-primary justify-end font-mono tabular-nums"><%= format_salary(row["tax_amount"]) %></div>
                          <div class="entity-cell-secondary justify-end">Tax</div>
                        </div>
                        <div class="w-20 entity-cell-two-line">
                          <div class="entity-cell-primary justify-end font-mono tabular-nums"><%= format_salary(row["apron_amount"]) %></div>
                          <div class="entity-cell-secondary justify-end">Apron</div>
                        </div>
                      </div>
                    </div>
                  </article>
                <% end %>
              <% end %>
            </div>
          </div>
        </section>

        <section id="trade-context" class="scroll-mt-24 space-y-3">
          <h2 class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Trade context</h2>

          <% if tx["trade_id"].present? %>
            <div class="rounded-lg border border-border overflow-hidden">
              <div class="divide-y divide-border/60">
                <article class="group px-3 py-2 transition-colors duration-75 hover:bg-yellow-50/70 dark:hover:bg-yellow-900/10">
                  <div class="flex flex-wrap items-start gap-3">
                    <div class="w-32 shrink-0 entity-cell-two-line">
                      <div class="entity-cell-primary text-xs uppercase tracking-wide">Linked trade</div>
                      <div class="entity-cell-secondary font-mono tabular-nums">#<%= tx["trade_id"] %></div>
                    </div>

                    <div class="min-w-0 flex-1 space-y-1">
                      <div class="text-sm font-medium"><a href="<%= trade_href(tx['trade_id']) %>" class="hover:underline">Open trade #<%= tx["trade_id"] %></a></div>
                      <% if @trade.present? %>
                        <div class="text-[11px] text-muted-foreground">
                          <span class="font-mono tabular-nums"><%= @trade["team_count"] || 0 %> teams</span>
                          · <span class="font-mono tabular-nums"><%= @trade["player_line_item_count"] || 0 %> players</span>
                          · <span class="font-mono tabular-nums"><%= @trade["pick_line_item_count"] || 0 %> picks</span>
                        </div>
                      <% end %>
                    </div>
                  </div>
                </article>

                <% if @trade_transactions.any? %>
                  <article class="px-3 py-2 bg-muted/20">
                    <div class="text-[10px] font-semibold uppercase tracking-wide text-muted-foreground">Other transactions in this trade</div>
                  </article>

                  <% @trade_transactions.each do |row| %>
                    <article class="group px-3 py-2 transition-colors duration-75 hover:bg-yellow-50/70 dark:hover:bg-yellow-900/10">
                      <div class="flex flex-wrap items-start gap-3">
                        <div class="w-28 shrink-0 entity-cell-two-line">
                          <div class="entity-cell-primary font-mono tabular-nums"><a href="<%= transaction_href(row['transaction_id']) %>" class="hover:underline">Txn #<%= row["transaction_id"] %></a></div>
                          <div class="entity-cell-secondary"><%= format_plain_date(row["transaction_date"]) %></div>
                        </div>

                        <div class="min-w-0 flex-1 space-y-1">
                          <div class="text-sm font-medium"><%= [row["transaction_type_lk"], row["transaction_description_lk"]].compact.reject(&:blank?).join(" · ").presence || "Trade transaction" %></div>
                          <div class="flex flex-wrap items-center gap-2 text-[11px] text-muted-foreground">
                            <% if row["player_id"].present? %>
                              <a href="<%= player_href(row['player_id']) %>" class="hover:underline">Player <%= row["player_name"] %></a>
                            <% end %>
                            <span>Route <%= [row["from_team_code"], row["to_team_code"]].compact.reject(&:blank?).join(" → ").presence || "—" %></span>
                            <a href="<%= trade_href(tx['trade_id']) %>" class="hover:underline">Trade #<%= tx["trade_id"] %></a>
                          </div>
                        </div>
                      </div>
                    </article>
                  <% end %>
                <% end %>
              </div>
            </div>
          <% else %>
            <div class="p-4 rounded-lg bg-muted/30 border border-border/50 text-sm text-muted-foreground italic">Standalone transaction (no trade_id).</div>
          <% end %>
        </section>

        <section id="endnotes" class="scroll-mt-24 space-y-3">
          <h2 class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Related endnotes</h2>

          <% if @endnotes.empty? %>
            <div class="p-4 rounded-lg bg-muted/30 border border-border/50 text-sm text-muted-foreground italic">No endnotes linked to this transaction's trade context.</div>
          <% else %>
            <div class="rounded-lg border border-border overflow-hidden divide-y divide-border/60">
              <% @endnotes.each do |note| %>
                <article class="group px-3 py-2 transition-colors duration-75 hover:bg-yellow-50/70 dark:hover:bg-yellow-900/10">
                  <div class="flex flex-wrap items-start gap-3">
                    <div class="w-24 shrink-0 entity-cell-two-line">
                      <div class="entity-cell-primary font-mono tabular-nums">#<%= note["endnote_id"] %></div>
                      <div class="entity-cell-secondary"><%= note["status_lk"].presence || "status" %></div>
                    </div>

                    <div class="min-w-0 flex-1 space-y-1">
                      <div class="text-sm whitespace-pre-line"><%= note["explanation"].presence || note["conveyance_text"].presence || note["protections_text"].presence || "—" %></div>
                      <div class="flex flex-wrap items-center gap-1.5 text-[10px]">
                        <% if note["is_swap"] %>
                          <span class="entity-chip entity-chip--accent">Swap</span>
                        <% end %>
                        <% if note["is_conditional"] %>
                          <span class="entity-chip entity-chip--warning">Conditional</span>
                        <% end %>
                        <% if tx["trade_id"].present? %>
                          <a href="<%= trade_href(tx['trade_id']) %>" class="hover:underline text-muted-foreground">Trade #<%= tx["trade_id"] %></a>
                        <% end %>
                      </div>
                    </div>
                  </div>
                </article>
              <% end %>
            </div>
          <% end %>
        </section>
      </div>
    </div>
  </main>
</div>
