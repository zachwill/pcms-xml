<% date_groups = Array(@transaction_date_groups) %>
<% if date_groups.empty? && @transactions.any? %>
  <% date_groups = [{ key: "all", headline: "All dates", subline: nil, relative_label: nil, row_count: @transactions.size, rows: @transactions }] %>
<% end %>

<div id="transactions-results" class="space-y-3">
  <div class="flex items-end justify-between gap-4">
    <div>
      <h2 class="text-xs font-medium uppercase tracking-wide text-muted-foreground">
        Transactions feed ·
        <% case @daterange
           when "today" then %>Today<%
           when "week" then %>This week<%
           when "month" then %>This month<%
           when "season" then %>This season<%
           else %>All dates<%
           end %>
      </h2>
      <p class="text-[11px] text-muted-foreground mt-1">
        Scan by day lane first, then open rows in the sidebar for details.
      </p>
    </div>

    <div class="text-right space-y-1">
      <div class="text-[11px] text-muted-foreground tabular-nums"><span><%= @transactions.size %> rows · <%= date_groups.size %> day lanes</span></div>
      <% if @query.present? %>
        <div class="text-[10px] text-muted-foreground">Intent: <span class="font-medium text-foreground"><%= @query %></span></div>
      <% end %>
    </div>
  </div>

  <% if @transactions.empty? %>
    <div class="p-4 rounded-lg bg-muted/30 border border-border/50 text-sm text-muted-foreground italic">
      No transactions found for this time period and filters.
    </div>
  <% else %>
    <div class="rounded-lg border border-border overflow-x-auto">
      <div class="min-w-[76rem]">
        <div id="transactions-flex-header" class="sticky top-0 z-10 bg-muted/70 backdrop-blur-sm border-b border-border">
          <div class="flex items-center h-8 px-3 text-[10px] uppercase tracking-wide text-muted-foreground/90 font-medium">
            <div class="w-32 shrink-0">When</div>
            <div class="w-24 shrink-0">Type</div>
            <div class="w-56 shrink-0">Player</div>
            <div class="w-48 shrink-0">Route</div>
            <div class="w-40 shrink-0">Method</div>
            <div class="w-[26rem] shrink-0">Description / match cue</div>
          </div>
        </div>

        <div id="transactions-date-lanes" class="divide-y divide-border/70">
          <% date_groups.each do |group| %>
            <% lane_key = group[:key].to_s.parameterize.presence || "undated" %>
            <section id="transactions-date-group-<%= lane_key %>" class="border-b border-border/70 last:border-b-0">
              <div class="sticky top-8 z-[6] border-b border-border/70 bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/85">
                <div class="flex items-center px-3 h-8 text-[10px] uppercase tracking-wide text-muted-foreground/90">
                  <div class="w-32 shrink-0 font-semibold text-foreground/90"><%= group[:headline] %></div>
                  <div class="w-24 shrink-0 text-muted-foreground/80"><%= group[:subline] %></div>
                  <div class="w-56 shrink-0 text-muted-foreground/80"><%= group[:relative_label] %></div>
                  <div class="w-48 shrink-0 text-muted-foreground/70">Day bucket</div>
                  <div class="w-40 shrink-0 text-muted-foreground/70">Rows</div>
                  <div class="w-[26rem] shrink-0 text-right font-mono tabular-nums text-foreground/85"><%= group[:row_count] %></div>
                </div>
              </div>

              <div class="divide-y divide-border/50">
                <% Array(group[:rows]).each do |txn| %>
                  <% row_id = txn["transaction_id"].to_s %>
                  <% open_expr = "$overlaytype = 'transaction'; $overlayid = '#{row_id}'; @get('/transactions/sidebar/#{row_id}')" %>
                  <% type_code = txn["transaction_type_lk"].to_s %>
                  <% type_variant = case type_code
                     when "SIGN", "RSIGN" then "entity-chip--success"
                     when "WAIVE", "WAIVR" then "entity-chip--danger"
                     when "EXTSN" then "entity-chip--accent"
                     else "entity-chip--muted"
                     end %>
                  <% row_date = format_plain_date(txn["transaction_date"]) %>

                  <div
                    class="group cursor-pointer hover:bg-yellow-50/70 dark:hover:bg-yellow-900/10 transition-colors duration-75"
                    role="button"
                    tabindex="0"
                    data-class="{ 'bg-yellow-100/80 dark:bg-yellow-900/20': $overlaytype === 'transaction' && $overlayid === '<%= row_id %>' }"
                    data-on:click="<%= open_expr %>"
                    data-on:keydown="if (evt.key === 'Enter' || evt.key === ' ') { evt.preventDefault(); <%= open_expr %>; }"
                  >
                    <div class="flex items-center min-h-[56px] px-3 text-xs">
                      <div class="w-32 shrink-0 pr-2">
                        <div class="entity-cell-two-line">
                          <div class="entity-cell-primary justify-start">
                            <a href="<%= transaction_path(txn['transaction_id']) %>" class="font-medium font-mono tabular-nums hover:underline" onclick="event.stopPropagation()">#<%= txn["transaction_id"] %></a>
                          </div>
                          <div class="entity-cell-secondary justify-start font-mono tabular-nums"><%= row_date %></div>
                        </div>
                      </div>

                      <div class="w-24 shrink-0 pr-2">
                        <div class="entity-cell-two-line">
                          <div class="entity-cell-primary justify-start"><span class="entity-chip <%= type_variant %>"><%= type_code.presence || "—" %></span></div>
                          <div class="entity-cell-secondary justify-start"><%= txn["trade_id"].present? ? "trade-linked" : "standalone" %></div>
                        </div>
                      </div>

                      <div class="w-56 shrink-0 pr-2">
                        <div class="entity-cell-two-line">
                          <div class="entity-cell-primary justify-start">
                            <% if txn["player_id"].present? %>
                              <a href="<%= player_href(txn['player_id']) %>" class="font-medium truncate hover:underline" onclick="event.stopPropagation()"><%= txn["player_name"] %></a>
                            <% else %>
                              <span class="text-muted-foreground">—</span>
                            <% end %>
                          </div>
                          <div class="entity-cell-secondary justify-start">id: <code class="font-mono tabular-nums"><%= txn["player_id"].presence || "—" %></code></div>
                        </div>
                      </div>

                      <div class="w-48 shrink-0 pr-2">
                        <div class="entity-cell-two-line">
                          <div class="entity-cell-primary justify-start gap-1">
                            <% if txn["from_team_code"].present? %>
                              <a href="<%= team_href(team_code: txn['from_team_code']) %>" class="font-medium hover:underline" onclick="event.stopPropagation()"><%= txn["from_team_code"] %></a>
                            <% else %>
                              <span class="text-muted-foreground">—</span>
                            <% end %>
                            <span class="text-muted-foreground/60">→</span>
                            <% if txn["to_team_code"].present? %>
                              <a href="<%= team_href(team_code: txn['to_team_code']) %>" class="font-medium hover:underline" onclick="event.stopPropagation()"><%= txn["to_team_code"] %></a>
                            <% else %>
                              <span class="text-muted-foreground">—</span>
                            <% end %>
                          </div>
                          <div class="entity-cell-secondary justify-start truncate"><%= [txn["from_team_name"], txn["to_team_name"]].compact.reject(&:blank?).join(" → ").presence || "No team route" %></div>
                        </div>
                      </div>

                      <div class="w-40 shrink-0 pr-2">
                        <div class="entity-cell-two-line">
                          <div class="entity-cell-primary justify-start"><span class="font-mono tabular-nums"><%= txn["signed_method_lk"].presence || "—" %></span></div>
                          <div class="entity-cell-secondary justify-start truncate"><%= txn["contract_type_lk"].presence || "—" %></div>
                        </div>
                      </div>

                      <div class="w-[26rem] shrink-0 pr-1">
                        <div class="entity-cell-two-line">
                          <div class="entity-cell-primary justify-start text-[11px] truncate"><%= txn["transaction_description_lk"].presence || "—" %></div>
                          <div class="entity-cell-secondary justify-start gap-1 truncate">
                            <% if @query.present? && txn["intent_match_cue"].present? %>
                              <span class="uppercase tracking-wide text-[9px] text-muted-foreground/70">match</span>
                              <span class="font-medium text-foreground/90 truncate" title="<%= txn['intent_match_title'] %>"><%= txn["intent_match_cue"] %></span>
                            <% else %>
                              <span class="text-muted-foreground/60">No intent cue</span>
                            <% end %>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                <% end %>
              </div>
            </section>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>
</div>
