<% summary = @sidebar_summary || {} %>
<% view = summary[:view].to_s %>

<div id="rightpanel-base" class="space-y-4">
  <div class="rounded-lg border border-border bg-background p-3 space-y-3">
    <div>
      <div class="text-[10px] uppercase tracking-wide text-muted-foreground/80">Workspace snapshot</div>
      <div class="text-sm font-semibold text-foreground">
        Drafts
        <% if summary[:row_count].present? %>
          <span class="text-muted-foreground font-medium">路 <%= summary[:row_count].to_i %> rows</span>
        <% elsif summary[:cell_count].present? %>
          <span class="text-muted-foreground font-medium">路 <%= summary[:cell_count].to_i %> cells</span>
        <% end %>
      </div>
    </div>

    <% if view == "picks" %>
      <div class="grid grid-cols-2 gap-1.5">
        <%= render partial: "tools/salary_book/kpi_cell", locals: { label: "Rows", value: summary[:row_count].to_i.to_s, class_name: "w-full" } %>
        <%= render partial: "tools/salary_book/kpi_cell", locals: { label: "Traded", value: summary[:traded_count].to_i.to_s, class_name: "w-full" } %>
        <%= render partial: "tools/salary_book/kpi_cell", locals: { label: "Conditional", value: summary[:conditional_count].to_i.to_s, class_name: "w-full" } %>
        <%= render partial: "tools/salary_book/kpi_cell", locals: { label: "Swaps", value: summary[:swap_count].to_i.to_s, class_name: "w-full" } %>
      </div>
    <% elsif view == "selections" %>
      <div class="grid grid-cols-2 gap-1.5">
        <%= render partial: "tools/salary_book/kpi_cell", locals: { label: "Rows", value: summary[:row_count].to_i.to_s, class_name: "w-full" } %>
        <%= render partial: "tools/salary_book/kpi_cell", locals: { label: "R1", value: summary[:first_round_count].to_i.to_s, class_name: "w-full" } %>
        <%= render partial: "tools/salary_book/kpi_cell", locals: { label: "With trade", value: summary[:with_trade_count].to_i.to_s, class_name: "w-full" } %>
        <%= render partial: "tools/salary_book/kpi_cell", locals: { label: "Known player", value: summary[:with_player_count].to_i.to_s, class_name: "w-full" } %>
      </div>
    <% else %>
      <div class="grid grid-cols-2 gap-1.5">
        <%= render partial: "tools/salary_book/kpi_cell", locals: { label: "Teams", value: summary[:team_count].to_i.to_s, class_name: "w-full" } %>
        <%= render partial: "tools/salary_book/kpi_cell", locals: { label: "Years", value: summary[:year_count].to_i.to_s, class_name: "w-full" } %>
        <%= render partial: "tools/salary_book/kpi_cell", locals: { label: "Outgoing", value: summary[:outgoing_count].to_i.to_s, class_name: "w-full" } %>
        <%= render partial: "tools/salary_book/kpi_cell", locals: { label: "Conditional", value: summary[:conditional_count].to_i.to_s, class_name: "w-full" } %>
      </div>
    <% end %>

    <% if Array(summary[:filters]).any? %>
      <div class="pt-1 flex flex-wrap gap-1">
        <% Array(summary[:filters]).each do |label| %>
          <span class="entity-chip entity-chip--muted"><%= label %></span>
        <% end %>
      </div>
    <% end %>
  </div>

  <% if view == "picks" && Array(summary[:top_rows]).any? %>
    <div class="rounded-lg border border-border bg-background">
      <div class="px-3 py-2 border-b border-border text-[10px] uppercase tracking-wide text-muted-foreground/80">Quick picks</div>
      <div class="divide-y divide-border">
        <% Array(summary[:top_rows]).each do |row| %>
          <% key = "pick-#{row['original_team_code']}-#{row['draft_year']}-#{row['draft_round']}" %>
          <% open_expr = "$overlaytype = 'pick'; $overlaykey = '#{key}'; @get('/drafts/sidebar/pick?team=#{row['original_team_code']}&year=#{row['draft_year']}&round=#{row['draft_round']}')" %>
          <button
            type="button"
            class="cursor-pointer w-full px-3 py-2 text-left hover:bg-yellow-50/70 dark:hover:bg-yellow-900/10 transition-colors duration-75"
            data-on:click="<%= open_expr %>"
          >
            <div class="entity-cell-two-line">
              <div class="entity-cell-primary justify-between gap-2">
                <span class="font-medium"><%= row["draft_year"] %> R<%= row["draft_round"] %> 路 <%= row["original_team_code"] %></span>
                <span class="font-mono tabular-nums text-[11px]"><%= row["current_team_code"] %></span>
              </div>
              <div class="entity-cell-secondary truncate"><%= row["protections_summary"].presence || row["pick_status"].presence || "Own" %></div>
            </div>
          </button>
        <% end %>
      </div>
    </div>
  <% elsif view == "selections" && Array(summary[:top_rows]).any? %>
    <div class="rounded-lg border border-border bg-background">
      <div class="px-3 py-2 border-b border-border text-[10px] uppercase tracking-wide text-muted-foreground/80">Quick selections</div>
      <div class="divide-y divide-border">
        <% Array(summary[:top_rows]).each do |row| %>
          <% key = "selection-#{row['transaction_id']}" %>
          <% open_expr = "$overlaytype = 'selection'; $overlaykey = '#{key}'; @get('/drafts/sidebar/selection/#{row['transaction_id']}')" %>
          <button
            type="button"
            class="cursor-pointer w-full px-3 py-2 text-left hover:bg-yellow-50/70 dark:hover:bg-yellow-900/10 transition-colors duration-75"
            data-on:click="<%= open_expr %>"
          >
            <div class="entity-cell-two-line">
              <div class="entity-cell-primary justify-between gap-2">
                <span class="font-medium"><%= row["draft_year"] %> R<%= row["draft_round"] %> P<%= row["pick_number"] %></span>
                <span class="font-mono tabular-nums text-[11px]">#<%= row["transaction_id"] %></span>
              </div>
              <div class="entity-cell-secondary truncate"><%= row["player_name"].presence || "Unknown player" %> 路 <%= row["drafting_team_code"] %></div>
            </div>
          </button>
        <% end %>
      </div>
    </div>
  <% else %>
    <div class="p-4 rounded-lg border border-border bg-muted/20 text-sm text-muted-foreground">
      Use the table or grid to open pick/selection provenance in this panel.
    </div>
  <% end %>
</div>
