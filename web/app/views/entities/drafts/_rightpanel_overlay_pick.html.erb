<%
  pick ||= {}
  assets ||= []
  provenance_rows ||= []
  related_selection ||= nil

  original_code = pick["original_team_code"].to_s
  current_code = pick["current_team_code"].to_s
  draft_year = pick["draft_year"]
  draft_round = pick["draft_round"]

  draft_pick_href = draft_pick_path(team_code: original_code, year: draft_year, round: draft_round)
  trade_ids = provenance_rows.map { |row| row["trade_id"] }.compact.uniq
%>

<div id="rightpanel-overlay" class="h-full">
  <div class="sticky top-0 z-20 h-10 px-4 flex items-center justify-between border-b border-border bg-background">
    <button
      type="button"
      class="cursor-pointer flex items-center gap-1.5 text-sm transition-colors text-muted-foreground hover:text-foreground"
      data-on:click="$overlaytype = 'none'; $overlaykey = ''; @get('/drafts/sidebar/clear')"
    >
      <%= lucide_icon("arrow-left", class: "w-4 h-4", "aria-hidden": true) %>
      <span class="font-medium">Back</span>
    </button>

    <a href="<%= draft_pick_href %>" class="text-xs text-muted-foreground hover:text-foreground hover:underline">Open draft-pick page</a>
  </div>

  <div class="px-4 pb-4 pt-4 space-y-5">
    <div class="space-y-1">
      <h2 class="text-lg font-semibold text-foreground truncate"><%= draft_year %> Round <%= draft_round %> pick</h2>
      <div class="text-xs text-muted-foreground/80 tabular-nums">
        <span>Original: <%= original_code %></span>
        <span class="text-muted-foreground/50 px-1">·</span>
        <span>Current: <%= current_code.presence || "—" %></span>
      </div>
    </div>

    <div class="grid grid-cols-2 gap-1.5 border-t border-border pt-4">
      <%= render partial: "tools/salary_book/kpi_cell", locals: { label: "Status", value: pick["pick_status"].presence || "Own", class_name: "w-full", value_class_name: "text-[11px]" } %>
      <%= render partial: "tools/salary_book/kpi_cell", locals: { label: "Trades", value: trade_ids.size.to_s, class_name: "w-full" } %>
      <%= render partial: "tools/salary_book/kpi_cell", locals: { label: "Clauses", value: assets.size.to_s, class_name: "w-full" } %>
      <%= render partial: "tools/salary_book/kpi_cell", locals: { label: "Selection", value: related_selection.present? ? "Yes" : "No", class_name: "w-full", variant: (related_selection.present? ? "default" : "muted") } %>
    </div>

    <div class="border-t border-border pt-4 space-y-2">
      <div class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Ownership + protections</div>

      <div class="space-y-0.5">
        <div class="flex items-center justify-between py-1.5 gap-2">
          <span class="text-sm text-muted-foreground">Original owner</span>
          <a href="<%= team_href(team_code: original_code) %>" class="text-sm font-medium hover:underline"><%= original_code %> · <%= pick["original_team_name"].presence || "—" %></a>
        </div>

        <div class="flex items-center justify-between py-1.5 gap-2">
          <span class="text-sm text-muted-foreground">Current owner</span>
          <% if current_code.present? %>
            <a href="<%= team_href(team_code: current_code) %>" class="text-sm font-medium hover:underline"><%= current_code %> · <%= pick["current_team_name"].presence || "—" %></a>
          <% else %>
            <span class="text-sm text-muted-foreground">—</span>
          <% end %>
        </div>
      </div>

      <% if pick["protections_summary"].present? %>
        <div class="rounded border border-border/60 p-2 text-xs text-muted-foreground whitespace-pre-line"><%= pick["protections_summary"] %></div>
      <% end %>

      <% if assets.any? %>
        <div class="divide-y divide-border/50 rounded border border-border/60">
          <% assets.first(10).each do |asset| %>
            <% flags = [] %>
            <% flags << "swap" if asset["is_swap"] %>
            <% flags << "conditional" if asset["is_conditional"] %>
            <% flags << "forfeited" if asset["is_forfeited"] %>
            <div class="px-2 py-1.5">
              <div class="text-[11px] font-medium"><%= asset["display_text"].presence || asset["raw_part"].presence || "—" %></div>
              <div class="text-[10px] text-muted-foreground/80">
                slot <%= asset["asset_slot"] %>.<%= asset["sub_asset_slot"] %>
                <% if flags.any? %>
                  <span class="px-1 text-muted-foreground/50">·</span>
                  <%= flags.join(" · ") %>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>

    <div class="border-t border-border pt-4 space-y-2">
      <div class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Provenance chain</div>
      <% if provenance_rows.empty? %>
        <div class="text-sm text-muted-foreground italic">No draft_pick_trades rows found for this pick.</div>
      <% else %>
        <div class="overflow-x-auto rounded-lg border border-border/60">
          <table class="min-w-full text-[11px]">
            <thead class="bg-muted/20 text-[10px] uppercase tracking-wide text-muted-foreground">
              <tr>
                <th class="text-left px-2 py-1.5 font-medium">Trade</th>
                <th class="text-left px-2 py-1.5 font-medium">Date</th>
                <th class="text-left px-2 py-1.5 font-medium">From</th>
                <th class="text-left px-2 py-1.5 font-medium">To</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-border/50">
              <% provenance_rows.first(12).each do |row| %>
                <tr class="hover:bg-yellow-50/70 dark:hover:bg-yellow-900/25 transition-colors duration-75">
                  <td class="px-2 py-1.5 font-mono tabular-nums">
                    <% if row["trade_id"].present? %>
                      <a href="<%= trade_href(row['trade_id']) %>" class="hover:underline">#<%= row["trade_id"] %></a>
                    <% else %>
                      —
                    <% end %>
                  </td>
                  <td class="px-2 py-1.5 text-muted-foreground font-mono tabular-nums"><%= row["trade_date"].presence || "—" %></td>
                  <td class="px-2 py-1.5 text-muted-foreground"><%= row["from_team_code"].presence || "—" %></td>
                  <td class="px-2 py-1.5 text-muted-foreground"><%= row["to_team_code"].presence || "—" %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% end %>
    </div>

    <div class="border-t border-border pt-4 space-y-2">
      <div class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Pivots</div>
      <div class="flex flex-col gap-1.5 text-sm">
        <a href="<%= draft_pick_href %>" class="text-muted-foreground hover:text-foreground hover:underline">Open canonical draft-pick page</a>
        <a href="<%= team_href(team_code: original_code) %>" class="text-muted-foreground hover:text-foreground hover:underline">Open original team page (<%= original_code %>)</a>
        <% if current_code.present? %>
          <a href="<%= team_href(team_code: current_code) %>" class="text-muted-foreground hover:text-foreground hover:underline">Open current owner page (<%= current_code %>)</a>
        <% end %>
        <% if related_selection.present? %>
          <a href="<%= draft_selection_href(related_selection['transaction_id']) %>" class="text-muted-foreground hover:text-foreground hover:underline">Open draft selection page</a>
          <a href="<%= transaction_href(related_selection['transaction_id']) %>" class="text-muted-foreground hover:text-foreground hover:underline">Open transaction #<%= related_selection["transaction_id"] %></a>
        <% end %>
        <% trade_ids.first(3).each do |trade_id| %>
          <a href="<%= trade_href(trade_id) %>" class="text-muted-foreground hover:text-foreground hover:underline">Open trade #<%= trade_id %></a>
        <% end %>
      </div>
    </div>
  </div>
</div>
