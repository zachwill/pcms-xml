<%#
  EntityHeader — shared header chrome for the entity explorer.

  locals:
  - title: (String) required
  - title_badge: (String) optional (ex: team code)
  - subtitle: (String) optional
  - breadcrumbs: (Array[[label, href]]) optional
      ex: [["Players", "/players"], ["LeBron James", nil]]
  - salary_book_href: (String) optional (default: /tools/salary-book)
  - salary_book_label: (String) optional (default: "Salary Book")
  - right_links: (Array[[label, href]]) optional
  - active_entity_scope: (String) optional (players|teams|agents|agencies|draft_selections)
  - entity_scopes: (Array[[scope, label, href]]) optional
  - header_knobs: (Array[Hash]) optional
      ex:
        [
          {
            label: "Directory",
            options: [
              { type: "radio", name: "entity-kind", id: "kind-agents", value: "agents", label: "Agents", checked: true, bind: "entitykind", on_change: "..." }
            ]
          }
        ]
  - search_scope: (String) optional
  - search_query: (String) optional
  - search_placeholder: (String) optional
  - search_enabled: (Boolean) optional (default: true)
%>

<% title = title.to_s %>
<% title_badge = local_assigns[:title_badge].to_s.strip.presence %>
<% subtitle = local_assigns[:subtitle].to_s.strip.presence %>

<% breadcrumbs = local_assigns[:breadcrumbs] %>
<% breadcrumbs = [[title, nil]] unless breadcrumbs.is_a?(Array) && breadcrumbs.any? %>

<% salary_book_href = local_assigns[:salary_book_href].to_s.strip.presence || "/tools/salary-book" %>
<% salary_book_label = local_assigns[:salary_book_label].to_s.strip.presence || "Salary Book" %>
<% right_links = Array(local_assigns[:right_links]).select { |pair| pair.is_a?(Array) && pair.size == 2 } %>

<% search_enabled = local_assigns.key?(:search_enabled) ? !!local_assigns[:search_enabled] : true %>
<% search_scope = local_assigns[:search_scope].to_s.strip.presence || "players" %>
<% search_query = local_assigns[:search_query].to_s %>
<% search_placeholder = local_assigns[:search_placeholder].to_s.strip.presence || "Search…" %>

<%
  entity_scopes = local_assigns[:entity_scopes]
  entity_scopes = [
    ["players", "Players", "/players"],
    ["teams", "Teams", "/teams"],
    ["agents", "Agents", "/agents"],
    ["agencies", "Agencies", "/agents?kind=agencies"],
    ["draft_selections", "Draft selections", "/draft-selections"]
  ] unless entity_scopes.is_a?(Array) && entity_scopes.any?

  active_entity_scope = local_assigns[:active_entity_scope].to_s.strip.presence || search_scope
  header_knobs = Array(local_assigns[:header_knobs])

  default_action = entity_scopes.find { |s| s[0] == search_scope }&.[](2) || "/players"
%>

<header class="border-b border-border pb-4 space-y-3">
  <div class="flex flex-wrap items-start gap-4">
    <div class="min-w-[14rem] space-y-1">
      <div class="text-[10px] font-semibold uppercase tracking-wider text-muted-foreground/70">Entities</div>
      <div class="flex flex-wrap gap-1" role="navigation" aria-label="Entities">
        <% entity_scopes.each do |(scope, label, href)| %>
          <% active = scope.to_s == active_entity_scope.to_s %>
          <a
            href="<%= href %>"
            class="relative h-7 px-2 rounded text-xs font-medium transition-all duration-150 border outline-none inline-flex items-center justify-center no-underline hover:no-underline <%= active ? 'bg-primary text-primary-foreground border-primary shadow-sm' : 'bg-muted/50 text-foreground border-border hover:bg-muted hover:border-foreground/20' %>"
          ><%= label %></a>
        <% end %>
      </div>
    </div>

    <% if header_knobs.any? %>
      <div class="h-20 w-px bg-border self-center"></div>

      <div class="flex flex-wrap items-start gap-4" role="group" aria-label="Entity filters">
        <% header_knobs.each_with_index do |group, group_idx| %>
          <% group_label = group[:label].to_s.strip.presence || group["label"].to_s.strip.presence || "Filters" %>
          <% options = Array(group[:options] || group["options"]) %>

          <div class="min-w-[7rem] space-y-1">
            <div class="text-[10px] font-semibold uppercase tracking-wider text-muted-foreground/70"><%= group_label %></div>
            <div class="space-y-1">
              <% options.each_with_index do |option, option_idx| %>
                <% option_type = option[:type].to_s == "radio" ? "radio" : "checkbox" %>
                <% option_name = option[:name].to_s.strip.presence || option["name"].to_s.strip.presence || "entity-knob-#{group_idx}" %>
                <% option_label = option[:label].to_s.strip.presence || option["label"].to_s.strip.presence || "Option" %>
                <% option_id = option[:id].to_s.strip.presence || option["id"].to_s.strip.presence || "entity-knob-#{group_idx}-#{option_idx}" %>
                <% option_value = option[:value].to_s %>
                <% option_checked = option.key?(:checked) ? !!option[:checked] : !!option["checked"] %>
                <% option_bind = option[:bind].to_s.strip.presence || option["bind"].to_s.strip.presence %>
                <% option_on_change = option[:on_change].to_s.strip.presence || option["on_change"].to_s.strip.presence %>

                <div class="flex items-center gap-1.5">
                  <input
                    type="<%= option_type %>"
                    id="<%= option_id %>"
                    <% if option_type == "radio" %>
                      name="<%= option_name %>"
                      value="<%= option_value %>"
                    <% end %>
                    class="size-3.5 accent-primary"
                    <% if option_checked %>checked<% end %>
                    <% if option_bind.present? %>data-bind="<%= option_bind %>"<% end %>
                    <% if option_on_change.present? %>data-on:change="<%= option_on_change %>"<% end %>
                  />
                  <label for="<%= option_id %>" class="text-[11px] leading-none cursor-pointer select-none text-foreground/80 hover:text-foreground transition-colors"><%= option_label %></label>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>

  <div class="flex items-start justify-between gap-6">
    <div class="min-w-0">
      <div class="text-xs text-muted-foreground">
        <% breadcrumbs.each_with_index do |(label, href), idx| %>
          <% is_last = idx == breadcrumbs.length - 1 %>
          <% if idx > 0 %>
            <span class="mx-1">/</span>
          <% end %>

          <% if href.present? && !is_last %>
            <a href="<%= href %>" class="hover:underline"><%= label %></a>
          <% else %>
            <span class="<%= is_last ? 'text-foreground' : '' %>"><%= label %></span>
          <% end %>
        <% end %>
      </div>

      <h1 class="mt-1 text-2xl font-semibold truncate">
        <%= title %>
        <% if title_badge.present? %>
          <span class="ml-2 text-sm font-mono text-muted-foreground"><%= title_badge %></span>
        <% end %>
      </h1>

      <% if subtitle.present? %>
        <p class="mt-1 text-sm text-muted-foreground"><%= subtitle %></p>
      <% end %>
    </div>

    <nav class="shrink-0 flex flex-col items-end gap-1">
      <a href="<%= salary_book_href %>" class="text-sm text-muted-foreground hover:text-foreground hover:underline"><%= salary_book_label %></a>
      <% right_links.each do |(label, href)| %>
        <a href="<%= href %>" class="text-sm text-muted-foreground hover:text-foreground hover:underline"><%= label %></a>
      <% end %>
    </nav>
  </div>

  <% if search_enabled %>
    <form action="<%= default_action %>" method="get" class="flex items-center gap-2">
      <input
        type="text"
        name="q"
        value="<%= search_query %>"
        placeholder="<%= search_placeholder %>"
        class="w-full px-3 py-2 rounded-md border border-border bg-background text-sm outline-none focus:ring-2 focus:ring-primary/20"
        autocomplete="off"
      />
      <button type="submit" class="cursor-pointer px-3 py-2 rounded-md bg-primary text-primary-foreground text-sm font-medium">Search</button>
    </form>
  <% end %>
</header>
