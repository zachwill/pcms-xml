================================================================
Directory Structure
================================================================
.claude/
  CLAUDE.md
.github/
  ISSUE_TEMPLATE/
    config.yml
    preapproved.md
  workflows/
    ci-checks.yml
    ci-oss.yml
    ci-saas.yml
    publish-image.yml
    test.yml
  dependabot.yml
app/
  assets/
    images/
      .keep
      37signals.svg
      activity.svg
      add.svg
      arrow-left.svg
      arrow-right.svg
      arrow-up.svg
      art.svg
      assigned.svg
      attachment.svg
      bell-alert.svg
      bell-off.svg
      bell.svg
      board-add.svg
      board.svg
      bolt.svg
      bookmark-outline.svg
      bookmark.svg
      boost-color.svg
      boost.svg
      camera.svg
      caret-down.svg
      check-circle.svg
      check.svg
      clipboard.svg
      close-circle.svg
      close.svg
      collapse.svg
      column-left.svg
      column-right.svg
      comment.svg
      copy-paste.svg
      crown.svg
      email.svg
      everyone.svg
      expand.svg
      filter.svg
      fizzy.svg
      funnel.svg
      gear.svg
      globe.svg
      golden-ticket.svg
      grid.svg
      history.svg
      home.svg
      install-edge.svg
      jf-avatar.jpg
      jf-signature.svg
      lifebuoy.svg
      lock.svg
      logo.png
      logo.webp
      logout.svg
      marker.svg
      maximize.svg
      menu-dots-horizontal.svg
      menu-dots-vertical.svg
      minus.svg
      monitor.svg
      moon.svg
      move.svg
      password.svg
      pencil.svg
      person-add.svg
      person.svg
      picture-add.svg
      picture-remove.svg
      picture-zoom.svg
      pinned.svg
      qr-code.svg
      reaction.svg
      refresh--meta.svg
      refresh.svg
      remove.svg
      rename.svg
      search.svg
      settings.svg
      share.svg
      sliders.svg
      sun.svg
      switch.svg
      system_user.png
      tag-outline.svg
      tag.svg
      thumb-up.svg
      trash.svg
      unpinned.svg
      unseen.svg
      world.svg
      youtube.svg
    stylesheets/
      _global.css
      access-tokens.css
      android.css
      animation.css
      autoresize.css
      avatars.css
      bar.css
      base.css
      blank-slates.css
      bubble.css
      buttons.css
      card-columns.css
      card-perma.css
      cards.css
      circled-text.css
      color-picker.css
      comments.css
      dialog.css
      dividers.css
      drag_and_drop.css
      events.css
      expandable.css
      filters.css
      flash.css
      font-face.css
      golden-effect.css
      header.css
      icons.css
      inputs.css
      ios.css
      knobs.css
      layout.css
      lexxy.css
      lightbox.css
      markdown.css
      native.css
      nav.css
      notifications.css
      pagination.css
      panels.css
      pins.css
      popup.css
      print.css
      pwa.css
      qr-codes.css
      reactions.css
      reset.css
      rich-text-content.css
      search.css
      separators.css
      settings.css
      spinners.css
      steps.css
      syntax.css
      theme-switcher.css
      toggles.css
      tooltips.css
      trays.css
      user.css
      utilities.css
      welcome-letter.css
  channels/
    application_cable/
      connection.rb
  controllers/
    account/
      cancellations_controller.rb
      entropies_controller.rb
      exports_controller.rb
      imports_controller.rb
      join_codes_controller.rb
      settings_controller.rb
    boards/
      columns/
        closeds_controller.rb
        not_nows_controller.rb
        streams_controller.rb
      columns_controller.rb
      entropies_controller.rb
      involvements_controller.rb
      publications_controller.rb
    cards/
      comments/
        reactions_controller.rb
      assignments_controller.rb
      boards_controller.rb
      closures_controller.rb
      columns_controller.rb
      comments_controller.rb
      drafts_controller.rb
      goldnesses_controller.rb
      images_controller.rb
      not_nows_controller.rb
      pins_controller.rb
      previews_controller.rb
      publishes_controller.rb
      reactions_controller.rb
      readings_controller.rb
      self_assignments_controller.rb
      steps_controller.rb
      taggings_controller.rb
      triages_controller.rb
      watches_controller.rb
    columns/
      cards/
        drops/
          closures_controller.rb
          columns_controller.rb
          not_nows_controller.rb
          streams_controller.rb
      left_positions_controller.rb
      right_positions_controller.rb
    concerns/
      authentication/
        via_magic_link.rb
      authentication.rb
      authorization.rb
      block_search_engine_indexing.rb
      board_scoped.rb
      card_scoped.rb
      column_scoped.rb
      current_request.rb
      current_timezone.rb
      day_timelines_scoped.rb
      filter_scoped.rb
      request_forgery_protection.rb
      routing_headers.rb
      set_platform.rb
      turbo_flash.rb
      view_transitions.rb
    events/
      day_timeline/
        columns_controller.rb
      days_controller.rb
    filters/
      settings_refreshes_controller.rb
    my/
      access_tokens_controller.rb
      identities_controller.rb
      menus_controller.rb
      pins_controller.rb
      timezones_controller.rb
    notifications/
      bulk_readings_controller.rb
      readings_controller.rb
      settings_controller.rb
      trays_controller.rb
      unsubscribes_controller.rb
    prompts/
      boards/
        users_controller.rb
      cards_controller.rb
      tags_controller.rb
      users_controller.rb
    public/
      boards/
        columns/
          closeds_controller.rb
          not_nows_controller.rb
          streams_controller.rb
        columns_controller.rb
      base_controller.rb
      boards_controller.rb
      cards_controller.rb
    searches/
      queries_controller.rb
    sessions/
      magic_links_controller.rb
      menus_controller.rb
      transfers_controller.rb
    signups/
      completions_controller.rb
    users/
      email_addresses/
        confirmations_controller.rb
      avatars_controller.rb
      data_exports_controller.rb
      email_addresses_controller.rb
      events_controller.rb
      joins_controller.rb
      push_subscriptions_controller.rb
      roles_controller.rb
      verifications_controller.rb
    webhooks/
      activations_controller.rb
    admin_controller.rb
    application_controller.rb
    boards_controller.rb
    cards_controller.rb
    events_controller.rb
    filters_controller.rb
    join_codes_controller.rb
    landings_controller.rb
    notifications_controller.rb
    pwa_controller.rb
    qr_codes_controller.rb
    searches_controller.rb
    sessions_controller.rb
    signups_controller.rb
    tags_controller.rb
    users_controller.rb
    webhooks_controller.rb
  helpers/
    my/
      menu_helper.rb
    accesses_helper.rb
    application_helper.rb
    avatars_helper.rb
    boards_helper.rb
    bridge_helper.rb
    cards_helper.rb
    clipboard_helper.rb
    columns_helper.rb
    comments_helper.rb
    emoji_helper.rb
    entropy_helper.rb
    events_helper.rb
    excerpt_helper.rb
    filters_helper.rb
    forms_helper.rb
    hotkeys_helper.rb
    html_helper.rb
    login_helper.rb
    messages_helper.rb
    notifications_helper.rb
    pagination_helper.rb
    qr_codes_helper.rb
    reactions_helper.rb
    rich_text_helper.rb
    tenanting_helper.rb
    time_helper.rb
    users_helper.rb
    webhooks_helper.rb
  javascript/
    controllers/
      bridge/
        buttons_controller.js
        form_controller.js
        insets_controller.js
        overflow_menu_controller.js
        text_size_controller.js
        title_controller.js
      application.js
      assignment_limit_controller.js
      auto_click_controller.js
      auto_save_controller.js
      auto_submit_controller.js
      autoresize_controller.js
      badge_controller.js
      bar_controller.js
      beacon_controller.js
      boards_form_controller.js
      bubble_controller.js
      card_hotkeys_controller.js
      clicker_controller.js
      collapsible_columns_controller.js
      combobox_controller.js
      copy_to_clipboard_controller.js
      css_variable_counter_controller.js
      details_controller.js
      dialog_controller.js
      dialog_manager_controller.js
      drag_and_drop_controller.js
      drag_and_strum_controller.js
      element_removal_controller.js
      expandable_on_native_controller.js
      fetch_on_visible_controller.js
      filter_controller.js
      filter_form_controller.js
      filter_settings_controller.js
      form_controller.js
      frame_controller.js
      frame_reloader_controller.js
      hotkey_controller.js
      index.js
      knob_controller.js
      lightbox_controller.js
      local_save_controller.js
      local_time_controller.js
      magic_link_controller.js
      multi_selection_combobox_controller.js
      nav_section_expander_controller.js
      navigable_list_controller.js
      notifications_controller.js
      notifications_tray_controller.js
      outlet_auto_save_controller.js
      pagination_controller.js
      reaction_delete_controller.js
      reaction_emoji_controller.js
      related_element_controller.js
      retarget_links_controller.js
      scroll_to_controller.js
      soft_keyboard_controller.js
      syntax_highlight_controller.js
      theme_controller.js
      timezone_cookie_controller.js
      toggle_class_controller.js
      toggle_enable_controller.js
      tooltip_controller.js
      touch_placeholder_controller.js
      turbo_navigation_controller.js
      upload_preview_controller.js
    helpers/
      bridge/
        viewport_helpers.js
      date_helpers.js
      form_helpers.js
      html_helpers.js
      orientation_helpers.js
      platform_helpers.js
      scroll_helpers.js
      text_helpers.js
      timing_helpers.js
    initializers/
      bridge/
        bridge_element.js
      current.js
      index.js
    application.js
  jobs/
    account/
      data_import_job.rb
      incinerate_due_job.rb
    board/
      clean_inaccessible_data_job.rb
    card/
      activity_spike/
        detection_job.rb
      clean_inaccessible_data_job.rb
      remove_inaccessible_notifications_job.rb
    concerns/
      smtp_delivery_error_handling.rb
    event/
      webhook_dispatch_job.rb
    mention/
      create_job.rb
    notification/
      bundle/
        deliver_all_job.rb
        deliver_job.rb
    storage/
      materialize_job.rb
      reconcile_job.rb
    webhook/
      delivery_job.rb
    application_job.rb
    data_export_job.rb
    delete_unused_tags_job.rb
    notify_recipients_job.rb
    push_notification_job.rb
  mailers/
    concerns/
      mailers/
        unsubscribable.rb
    notification/
      bundle_mailer.rb
    account_mailer.rb
    application_mailer.rb
    export_mailer.rb
    import_mailer.rb
    magic_link_mailer.rb
    user_mailer.rb
  models/
    account/
      data_transfer/
        account_record_set.rb
        action_text_rich_text_record_set.rb
        active_storage_blob_record_set.rb
        blob_file_record_set.rb
        entropy_record_set.rb
        manifest.rb
        record_set.rb
        user_record_set.rb
      cancellable.rb
      cancellation.rb
      entropic.rb
      export.rb
      external_id_sequence.rb
      import.rb
      incineratable.rb
      join_code.rb
      multi_tenantable.rb
      seedeable.rb
      seeder.rb
      storage.rb
    board/
      accessible.rb
      auto_postponing.rb
      broadcastable.rb
      cards.rb
      entropic.rb
      publication.rb
      publishable.rb
      storage.rb
      triageable.rb
    card/
      activity_spike/
        detector.rb
      eventable/
        system_commenter.rb
      accessible.rb
      activity_spike.rb
      assignable.rb
      broadcastable.rb
      closeable.rb
      colored.rb
      commentable.rb
      entropic.rb
      entropy.rb
      eventable.rb
      exportable.rb
      golden.rb
      goldness.rb
      mentions.rb
      multistep.rb
      not_now.rb
      pinnable.rb
      postponable.rb
      promptable.rb
      readable.rb
      searchable.rb
      stallable.rb
      statuses.rb
      taggable.rb
      triageable.rb
      watchable.rb
    column/
      colored.rb
      positioned.rb
    comment/
      eventable.rb
      mentions.rb
      promptable.rb
      searchable.rb
    concerns/
      storage/
        totaled.rb
        tracked.rb
      attachments.rb
      eventable.rb
      filterable.rb
      mentions.rb
      notifiable.rb
      push_notifiable.rb
      searchable.rb
    event/
      description.rb
      particulars.rb
      promptable.rb
    filter/
      fields.rb
      params.rb
      resources.rb
      summarized.rb
    identity/
      access_token.rb
      joinable.rb
      transferable.rb
    magic_link/
      code.rb
    notification/
      bundle.rb
    notifier/
      card_event_notifier.rb
      comment_event_notifier.rb
      mention_notifier.rb
    push/
      subscription.rb
    search/
      record/
        sqlite/
          fts.rb
        sqlite.rb
        trilogy.rb
      highlighter.rb
      query.rb
      record.rb
      result.rb
      stemmer.rb
    signup/
      account_name_generator.rb
    storage/
      attachment_tracking.rb
      entry.rb
      total.rb
    tag/
      attachable.rb
    user/
      day_timeline/
        column.rb
        serializable.rb
      accessor.rb
      assignee.rb
      attachable.rb
      avatar.rb
      configurable.rb
      data_export.rb
      day_timeline.rb
      email_address_changeable.rb
      filtering.rb
      mentionable.rb
      named.rb
      notifiable.rb
      role.rb
      searcher.rb
      settings.rb
      timelined.rb
      transferable.rb
      watcher.rb
    webhook/
      delinquency_tracker.rb
      delivery.rb
      triggerable.rb
    zip_file/
      reader/
        io.rb
      reader.rb
      remote_io.rb
      writer.rb
    access.rb
    account.rb
    admin.rb
    application_platform.rb
    application_record.rb
    assignment.rb
    board.rb
    card.rb
    closure.rb
    color.rb
    column.rb
    comment.rb
    current.rb
    entropy.rb
    event.rb
    export.rb
    filter.rb
    identity.rb
    magic_link.rb
    mention.rb
    notification_pusher.rb
    notification.rb
    notifier.rb
    pin.rb
    push.rb
    qr_code_link.rb
    reaction.rb
    search.rb
    session.rb
    signup.rb
    ssrf_protection.rb
    step.rb
    storage.rb
    tag.rb
    tagging.rb
    time_window_parser.rb
    user.rb
    watch.rb
    webhook.rb
    zip_file.rb
  views/
    account/
      exports/
        show.html.erb
      imports/
        new.html.erb
        show.html.erb
      join_codes/
        edit.html.erb
        show.html.erb
      settings/
        _cancellation.html.erb
        _entropy.html.erb
        _export.html.erb
        _name.html.erb
        _user.html.erb
        _users.html.erb
        show.html.erb
    action_text/
      attachables/
        _remote_image.html.erb
        _remote_video.html.erb
    active_storage/
      blobs/
        web/
          _representation.html.erb
        _blob.html.erb
    bar/
      _bar.html.erb
    boards/
      columns/
        closeds/
          show.html.erb
        not_nows/
          show.html.erb
        streams/
          show.html.erb
        _empty_placeholder.html.erb
        create.turbo_stream.erb
        index.json.jbuilder
        show.html.erb
        show.json.jbuilder
        update.turbo_stream.erb
      edit/
        _auto_close.html.erb
        _delete.html.erb
        _name.html.erb
        _publication.html.erb
        _users.html.erb
      entropies/
        update.turbo_stream.erb
      involvements/
        update.html.erb
      publications/
        create.turbo_stream.erb
        destroy.turbo_stream.erb
      show/
        menu/
          _column_form.html.erb
          _column.html.erb
          _columns.html.erb
          _maximize.html.erb
        _closed.html.erb
        _column.html.erb
        _columns.html.erb
        _expander.html.erb
        _filtered_cards.html.erb
        _not_now.html.erb
        _stream.html.erb
      _access_toggle.html.erb
      _board.json.jbuilder
      edit.html.erb
      index.json.jbuilder
      new.html.erb
      show.html.erb
      show.json.jbuilder
    cards/
      assignments/
        _user.html.erb
        create.turbo_stream.erb
        new.html.erb
      boards/
        edit.html.erb
      closures/
        create.turbo_stream.erb
        destroy.turbo_stream.erb
      columns/
        _column.html.erb
        edit.html.erb
      comments/
        _comment.html.erb
        _comment.json.jbuilder
        _new.html.erb
        _watchers.html.erb
        create.turbo_stream.erb
        destroy.turbo_stream.erb
        edit.html.erb
        index.json.jbuilder
        show.html.erb
        show.json.jbuilder
        update.turbo_stream.erb
      container/
        footer/
          _create.html.erb
          _published.html.erb
        _closure_buttons.html.erb
        _closure.html.erb
        _content_display.html.erb
        _content.html.erb
        _gild.html.erb
        _image.html.erb
        _save_button.html.erb
      display/
        common/
          _assignees.html.erb
          _background.html.erb
          _board.html.erb
          _meta.html.erb
          _stamp.html.erb
        mini/
          _assignees.html.erb
          _meta.html.erb
          _tags.html.erb
        perma/
          _assignees.html.erb
          _background.html.erb
          _board.html.erb
          _meta.html.erb
          _steps.html.erb
          _tags.html.erb
        preview/
          _assignees.html.erb
          _board.html.erb
          _boosts.html.erb
          _bubble.html.erb
          _columns.html.erb
          _comments.html.erb
          _meta.html.erb
          _people.html.erb
          _steps.html.erb
          _tags.html.erb
        public_preview/
          _columns.html.erb
          _meta.html.erb
        _preview.html.erb
        _previews.html.erb
        _public_preview.html.erb
        _public_previews.html.erb
      drafts/
        _container.html.erb
        show.html.erb
      not_nows/
        create.turbo_stream.erb
      pins/
        _pin_button.html.erb
        show.html.erb
      previews/
        index.turbo_stream.erb
      readings/
        create.turbo_stream.erb
      steps/
        _step.html.erb
        _step.json.jbuilder
        create.turbo_stream.erb
        destroy.turbo_stream.erb
        edit.html.erb
        show.html.erb
        show.json.jbuilder
        update.turbo_stream.erb
      taggings/
        _tag.html.erb
        create.turbo_stream.erb
        new.html.erb
      triage/
        _columns.html.erb
      watches/
        _refresh.turbo_stream.erb
        _watch_button.html.erb
        create.turbo_stream.erb
        destroy.turbo_stream.erb
        show.html.erb
      _broadcasts.html.erb
      _card.json.jbuilder
      _container.html.erb
      _delete.html.erb
      _messages.html.erb
      edit.html.erb
      index.html.erb
      index.json.jbuilder
      show.html.erb
      show.json.jbuilder
      update.turbo_stream.erb
    columns/
      cards/
        drops/
          closures/
            create.turbo_stream.erb
          columns/
            create.turbo_stream.erb
          not_nows/
            create.turbo_stream.erb
          streams/
            create.turbo_stream.erb
      left_positions/
        create.turbo_stream.erb
      right_positions/
        create.turbo_stream.erb
      show/
        _add_card_button.html.erb
      _column.json.jbuilder
      _refresh_adjacent_columns.turbo_stream.erb
    entropy/
      _auto_close.html.erb
      _knob.html.erb
    event_summaries/
      _event_summary.html.erb
    events/
      day_timeline/
        columns/
          _events.html.erb
          show.html.erb
        _column.html.erb
        _columns.html.erb
      days/
        index.html.erb
      event/
        attachments/
          _attachment.html.erb
          _remote_image.html.erb
          _remote_video.html.erb
        eventable/
          _card_published.html.erb
          _card.html.erb
          _comment.html.erb
        _attachments.html.erb
        _layout.html.erb
      index/
        filter/
          _board.html.erb
          _user.html.erb
        _add_board_button.html.erb
        _add_card_button.html.erb
        _filter.html.erb
      _day.html.erb
      _empty_days.html.erb
      _event.html.erb
      index.html.erb
    filters/
      settings/
        _assignees.html.erb
        _boards.html.erb
        _cards.html.erb
        _closers.html.erb
        _controls.html.erb
        _creators.html.erb
        _indexed_by.html.erb
        _manage.html.erb
        _sorted_by.html.erb
        _tags.html.erb
        _terms.html.erb
        _time_window.html.erb
        _toggle.html.erb
      settings_refreshes/
        create.turbo_stream.erb
      _filter_toggle.html.erb
      _settings.html.erb
      create.turbo_stream.erb
      destroy.turbo_stream.erb
    join_codes/
      inactive.html.erb
      new.html.erb
    layouts/
      action_text/
        contents/
          _content.html.erb
      shared/
        _colophon.html.erb
        _flash.html.erb
        _head.html.erb
        _time_zone.html.erb
        _user_css.html.erb
        _welcome_letter.html.erb
      _lightbox.html.erb
      _theme_preference.html.erb
      application.html.erb
      mailer.html.erb
      mailer.text.erb
      public.html.erb
    mailers/
      account_mailer/
        cancellation.html.erb
        cancellation.text.erb
      export_mailer/
        completed.html.erb
        completed.text.erb
      identity_mailer/
        email_change_confirmation.text.erb
      import_mailer/
        completed.html.erb
        completed.text.erb
        failed.html.erb
        failed.text.erb
      magic_link_mailer/
        sign_in_instructions.html.erb
        sign_in_instructions.text.erb
      notification/
        bundle_mailer/
          event/
            _body.html.erb
            _body.text.erb
          mention/
            _body.html.erb
            _body.text.erb
          _notification.html.erb
          _notification.text.erb
          notification.html.erb
          notification.text.erb
    my/
      access_tokens/
        _access_token.html.erb
        index.html.erb
        new.html.erb
        show.html.erb
      identities/
        _account.json.jbuilder
        show.json.jbuilder
      menus/
        _accounts.html.erb
        _boards.html.erb
        _custom_views.html.erb
        _jump.html.erb
        _people.html.erb
        _settings.html.erb
        _shortcuts.html.erb
        _tags.html.erb
        show.html.erb
      pins/
        _pin.html.erb
        _tray.html.erb
        index.html.erb
        index.json.jbuilder
      _menu.html.erb
    notifications/
      index/
        _notification.html.erb
        _read_notifications.html.erb
        _unread_notifications.html.erb
      notification/
        event/
          _body.html.erb
          _body.json.jbuilder
        mention/
          _body.html.erb
          _body.json.jbuilder
        _body.html.erb
        _header.html.erb
      readings/
        create.turbo_stream.erb
        destroy.turbo_stream.erb
      settings/
        _board.html.erb
        _browser.html.erb
        _email.html.erb
        _install.html.erb
        _push_notifications.html.erb
        _system.html.erb
        show.html.erb
      trays/
        show.html.erb
      unsubscribes/
        new.html.erb
        show.html.erb
      _notification.html.erb
      _notification.json.jbuilder
      _tray.html.erb
      index.html.erb
      index.json.jbuilder
      index.turbo_stream.erb
    prompts/
      boards/
        users/
          _user.html.erb
          index.html.erb
      cards/
        _card.html.erb
        index.html.erb
      commands/
        _command.html.erb
        index.html.erb
      tags/
        _tag.html.erb
        index.html.erb
      users/
        index.html.erb
    public/
      boards/
        card_previews/
          index.turbo_stream.erb
        columns/
          closeds/
            show.html.erb
          not_nows/
            show.html.erb
          streams/
            show.html.erb
          show.html.erb
        show/
          _closed.html.erb
          _column.html.erb
          _columns.html.erb
          _not_now.html.erb
          _stream.html.erb
        show.html.erb
      cards/
        show/
          _content.html.erb
          _steps.html.erb
        show.html.erb
      _footer.html.erb
    pwa/
      manifest.json.erb
      service_worker.js
    reactions/
      _menu.html.erb
      _reaction.html.erb
      _reaction.json.jbuilder
      _reactions.html.erb
      create.turbo_stream.erb
      destroy.turbo_stream.erb
      index.html.erb
      index.json.jbuilder
      new.html.erb
    searches/
      _form.html.erb
      _result.html.erb
      _results.html.erb
      show.html.erb
    sessions/
      magic_links/
        show.html.erb
      menus/
        show.html.erb
      starts/
        new.html.erb
      transfers/
        show.html.erb
      _footer.html.erb
      new.html.erb
    signups/
      completions/
        new.html.erb
      new.html.erb
    tags/
      _tag.json.jbuilder
      index.html.erb
      index.json.jbuilder
    user_mailer/
      email_change_confirmation.html.erb
    users/
      avatars/
        show.svg.erb
      data_exports/
        show.html.erb
      email_addresses/
        confirmations/
          invalid_token.html.erb
          show.html.erb
        create.html.erb
        new.html.erb
      events/
        show.html.erb
      joins/
        new.html.erb
      verifications/
        new.html.erb
      _access_tokens.html.erb
      _activity_timeline.html.erb
      _attachable.html.erb
      _data_export.html.erb
      _theme.html.erb
      _transfer.html.erb
      _user.json.jbuilder
      edit.html.erb
      index.json.jbuilder
      show.html.erb
      show.json.jbuilder
    webhooks/
      form/
        _actions.html.erb
      _delivery.html.erb
      _webhook.html.erb
      edit.html.erb
      event.html.erb
      event.json.jbuilder
      index.html.erb
      new.html.erb
      show.html.erb
bin/
  brakeman
  bundle-both
  bundle-drift
  bundler-audit
  ci
  dev
  docker-entrypoint
  gitleaks-audit
  importmap
  jobs
  kamal
  minio-setup
  notify_dash_of_deployment
  rails
  rake
  rubocop
  setup
  thrust
config/
  environments/
    beta.rb
    development.rb
    production.rb
    staging.rb
    test.rb
  initializers/
    tenanting/
      account_slug.rb
      turbo.rb
    action_text.rb
    active_job.rb
    active_storage_no_reuse.rb
    active_storage_purge_on_last_attachment.rb
    active_storage.rb
    assets.rb
    autotuner.rb
    content_security_policy.rb
    database_role_logging.rb
    error_context.rb
    extensions.rb
    filter_parameter_logging.rb
    inflections.rb
    mission_control.rb
    multi_db.rb
    multi_tenant.rb
    permissions_policy.rb
    rack_mini_profiler.rb
    sanitization.rb
    sqlite_schema_dumper.rb
    table_definition_column_limits.rb
    true_client_ip.rb
    uuid_framework_models.rb
    uuid_primary_keys.rb
    vapid.rb
    vips.rb
    web_push.rb
  locales/
    en.yml
  application.rb
  boot.rb
  brakeman.ignore
  cable.yml
  cache.yml
  ci.rb
  database.mysql.yml
  database.sqlite.yml
  database.yml
  deploy.yml
  environment.rb
  importmap.rb
  puma.rb
  queue.yml
  recurring.yml
  routes.rb
  storage.oss.yml
  storage.yml
db/
  migrate/
    20251111122540_initial_schema.rb
    20251111153019_add_number_to_cards.rb
    20251112093037_create_search_indices.rb
    20251112184932_remove_join_code_from_memberships.rb
    20251113111501_drop_memberships.rb
    20251113160907_add_missing_account_id_columns.rb
    20251113163145_ensure_account_id_index.rb
    20251113190256_create_search_record_shards.rb
    20251114084325_drop_search_results.rb
    20251114183203_ensure_an_identit_can_only_have_one_user_in_an_account.rb
    20251117190817_change_endpoint_to_text_in_push_subscriptions.rb
    20251117192434_change_external_account_id_to_bigint_in_accounts.rb
    20251117202517_change_usage_limit_to_bigint_in_account_join_codes.rb
    20251120110206_add_search_records.rb
    20251120194700_remove_all_foreign_key_constraints.rb
    20251120203100_add_unique_index_to_card_activity_spikes_on_card_id.rb
    20251121092508_add_account_key_to_search_records.rb
    20251121112416_remove_old_fulltext_indexes_from_search_records.rb
    20251125110629_increase_user_agent_length.rb
    20251125130010_add_a_staff_flag_to_identities.rb
    20251127000001_create_account_external_id_sequences.rb
    20251129110120_add_purpose_to_magic_links.rb
    20251129175717_promote_first_admin_to_owner.rb
    20251201100607_create_account_exports.rb
    20251201132341_create_identity_access_tokens.rb
    20251205010536_add_verified_at_to_users.rb
    20251205205826_create_storage_tables.rb
    20251210054934_add_blob_id_and_audit_context_to_storage_entries.rb
    20251219120755_drop_card_engagements.rb
    20251223000001_rename_account_exports_to_exports.rb
    20251223000002_create_account_imports.rb
    20251224092315_create_account_cancellations.rb
    20260121155752_make_reactions_polymorphic.rb
  seeds/
    37signals.rb
    cleanslate.rb
    honcho.rb
  cable_schema.rb
  cache_schema.rb
  queue_schema.rb
  schema_sqlite.rb
  schema.rb
  seeds.rb
docs/
  API.md
  development.md
  docker-deployment.md
  kamal-deployment.md
lib/
  assets/
    .keep
  deployment/
    database_resolver.rb
  rails_ext/
    action_mailer_mail_delivery_job.rb
    active_record_date_arithmetic.rb
    active_record_replica_support.rb
    active_record_uuid_type.rb
    active_storage_analyze_job_suppress_broadcasts.rb
    active_storage_authorization.rb
    active_storage_blob_service_url_for_direct_upload_expiry.rb
    active_support_array_conversions.rb
    prepend_order.rb
    string.rb
  tasks/
    dev.rake
    saas.rake
    search.rake
  web_push/
    notification.rb
    pool.rb
  auto_link_scrubber.rb
  deployment.rb
  fizzy.rb
log/
  .keep
public/
  audio/
    banjo/
      B3.mp3
      C3.mp3
      D4.mp3
      E3.mp3
      Fsharp4.mp3
      G3.mp3
    harpsichord/
      B3.mp3
      C3.mp3
      D4.mp3
      E3.mp3
      Fsharp4.mp3
      G3.mp3
    mandolin/
      B3.mp3
      C3.mp3
      D4.mp3
      E3.mp3
      Fsharp4.mp3
      G3.mp3
    piano/
      B3.mp3
      C3.mp3
      D4.mp3
      E3.mp3
      Fsharp4.mp3
      G3.mp3
    vibes/
      B3.mp3
      C3.mp3
      D4.mp3
      E3.mp3
      Fsharp4.mp3
      G3.mp3
  400.html
  404.html
  406-unsupported-browser.html
  422.html
  500.html
  app-icon-192-maskable.png
  app-icon-192.png
  app-icon.png
  apple-touch-icon.png
  error.css
  favicon.ico
  favicon.png
  opengraph.png
  robots.txt
saas/
  .kamal/
    hooks/
      post-deploy
      pre-connect
    secrets.beta
    secrets.beta1
    secrets.beta2
    secrets.beta3
    secrets.beta4
    secrets.production
    secrets.staging
  app/
    assets/
      images/
        fizzy/
          saas/
            .keep
      stylesheets/
        fizzy/
          saas.css
    controllers/
      account/
        subscriptions/
          downgrades_controller.rb
          update_plan_controller.rb
          upgrades_controller.rb
        billing_portals_controller.rb
        subscriptions_controller.rb
      admin/
        account_searches_controller.rb
        accounts_controller.rb
        audits_controller.rb
        billing_waivers_controller.rb
        overridden_limits_controller.rb
        stats_controller.rb
      concerns/
        admin/
          account_scoped.rb
        card/
          limited_creation.rb
          limited_publishing.rb
          limited.rb
      stripe/
        webhooks_controller.rb
    helpers/
      subscriptions_helper.rb
    jobs/
      account/
        sync_stripe_customer_email_job.rb
    models/
      account/
        billing_waiver.rb
        billing.rb
        limited.rb
        overridden_limits.rb
        subscription.rb
      user/
        notifies_account_of_email_change.rb
      plan.rb
      saas_record.rb
      subscription.rb
    views/
      account/
        settings/
          _free_plan.html.erb
          _paid_plan.html.erb
          _subscription_panel.html.erb
          _subscription.html.erb
        subscriptions/
          notices/
            _admin_exceeding_card_limit.html.erb
            _admin_exceeding_storage_limit.html.erb
            _user_exceeding_card_limit.html.erb
            _user_exceeding_storage_limit.html.erb
          _upgrade.html.erb
          show.html.erb
      admin/
        accounts/
          edit.html.erb
          index.html.erb
        stats/
          show.html.erb
      cards/
        container/
          footer/
            saas/
              notices/
                _admin_nearing_card_limit.html.erb
                _admin_nearing_storage_limit.html.erb
                _user_nearing_card_limit.html.erb
                _user_nearing_storage_limit.html.erb
              _create.html.erb
              _near_notice.html.erb
      layouts/
        fizzy/
          saas/
            application.html.erb
      signup/
        completions/
          new.html.erb
        new.html.erb
  bin/
    broadcast_to_bc
    rails
    rubocop
    setup
  config/
    environments/
      beta.rb
      development.rb
      production.rb
      staging.rb
    database.yml
    deploy.beta.yml
    deploy.beta1.yml
    deploy.beta2.yml
    deploy.beta3.yml
    deploy.beta4.yml
    deploy.production.yml
    deploy.staging.yml
    deploy.yml
    routes.rb
    storage.yml
  db/
    migrate/
      20251202200249_create_console1984_tables.console1984.rb
      20251202205753_create_auditing_tables.audits1984.rb
      20251203144630_create_account_subscriptions.rb
      20251215140000_create_account_overridden_limits.rb
      20251215160000_create_account_billing_waivers.rb
      20251215170000_add_next_amount_due_in_cents_to_account_subscriptions.rb
      20251216000000_add_bytes_used_to_account_overridden_limits.rb
      20260126230838_create_auditor_tokens.audits1984.rb
    saas_schema.rb
  exe/
    stripe-dev
  lib/
    fizzy/
      saas/
        authorization.rb
        engine.rb
        metrics.rb
        signup.rb
        testing.rb
        transaction_pinning.rb
        version.rb
      saas.rb
    rails_ext/
      active_record_tasks_database_tasks.rb
    tasks/
      fizzy/
        saas_tasks.rake
    yabeda/
      solid_queue.rb
  public/
    .well-known/
      assetlinks.json
  script/
    configure-lb-beta.sh
    configure-lb-production.sh
    configure-lb-staging.sh
  test/
    controllers/
      accounts/
        subscriptions/
          card_creation_test.rb
          downgrades_controller_test.rb
          settings_test.rb
          upgrades_controller_test.rb
        billing_portals_controller_test.rb
        subscriptions_controller_test.rb
      admin/
        accounts_controller_test.rb
        audits_controller_test.rb
        billing_waivers_controller_test.rb
        overridden_limits_controller_test.rb
        stats_controller_test.rb
      card/
        limited_creation_test.rb
        limited_publishing_test.rb
      stripe/
        webhooks_controller_test.rb
      .keep
      non_production_remote_access_test.rb
    fixtures/
      files/
        .keep
      account_subscriptions.yml
    helpers/
      .keep
    integration/
      .keep
    mailers/
      .keep
    models/
      account/
        billing_test.rb
        limited_test.rb
        subscription_test.rb
      user/
        notifies_account_of_email_change_test.rb
      identity_test.rb
      plan_test.rb
      signup_test.rb
  Dockerfile
  fizzy-saas.gemspec
  Gemfile
  LICENSE.md
  Rakefile
  README.md
script/
  maintenance/
    fix_cross_account_taggings.rb
    remove_duplicated_search_queries.rb
    remove_duplicated_tags.rb
  migrations/
    renaming/
      content.rb
      files.rb
    20250924-populate-identities.rb
    20251028-populate_membership_id_on_users.rb
    20251029-populate-column-positions.rb
    20251205-backfill-verified-at.rb
    20260123-remove-draft-cards-from-search-index.rb
    backfill-storage-ledger.rb
    convert-absolute-attachment-urls-to-relative.rb
    convert-relative-attachment-urls-to-absolute.rb
    copy-blobs-to-pure.rb
    fill_account_closure_reasons.rb
    generate_comments_from_events.rb
    migrate_to_flat_card_urls.rb
    migrate_to_new_cards_url_scheme.rb
    migrate-content-to-slugged-urls.rb
    migrate-disk-service-blobs.rb
    populate_columns_from_workflow_stages.rb
    reset_boards_ids.rb
    reset_cards_ids.rb
    split-sibling-paragraphs-with-p-br.rb
  create-identities.rb
  fetch-prod-db.rb
  fix-active-storage-links.rb
  import-sqlite-database.rb
  load-prod-db-in-dev.rb
  populate.rb
  remove-lb-admin-production.sh
storage/
  .keep
test/
  channels/
    application_cable/
      connection_test.rb
  controllers/
    account/
      cancellations_controller_test.rb
    accounts/
      entropies_controller_test.rb
      exports_controller_test.rb
      join_codes_controller_test.rb
      settings_controller_test.rb
    active_storage/
      direct_uploads_controller_test.rb
    admin/
      mission_control_test.rb
    boards/
      columns/
        closeds_controller_test.rb
        not_nows_controller_test.rb
        streams_controller_test.rb
      columns_controller_test.rb
      entropies_controller_test.rb
      involvements_controller_test.rb
      publications_controller_test.rb
    cards/
      comments/
        reactions_controller_test.rb
      assignments_controller_test.rb
      boards_controller_test.rb
      closures_controller_test.rb
      comments_controller_test.rb
      drafts_controller_test.rb
      goldnesses_controller_test.rb
      images_controller_test.rb
      not_nows_controller_test.rb
      pins_controller_test.rb
      previews_controller_test.rb
      publishes_controller_test.rb
      reactions_controller_test.rb
      readings_controller_test.rb
      self_assignments_controller_test.rb
      steps_controller_test.rb
      taggings_controller_test.rb
      triages_controller_test.rb
      watches_controller_test.rb
    columns/
      cards/
        drops/
          closures_controller_test.rb
          columns_controller_test.rb
          not_nows_controller_test.rb
          streams_controller_test.rb
      left_positions_controller_test.rb
      right_positions_controller_test.rb
    concerns/
      block_search_engine_indexing_test.rb
      current_timezone_test.rb
      request_forgery_protection_test.rb
    events/
      day_timeline/
        columns_controller_test.rb
    my/
      access_tokens_controller_test.rb
      identities_controller_test.rb
      menus_controller_test.rb
      pins_controller_test.rb
      timezones_controller_test.rb
    notifications/
      bulk_readings_controller_test.rb
      readings_controller_test.rb
      settings_controller_test.rb
      trays_controller_test.rb
      unsubscribes_controller_test.rb
    prompts/
      boards/
        users_controller_test.rb
      cards_controller_test.rb
      tags_controller_test.rb
      users_controller_test.rb
    public/
      boards/
        columns/
          closeds_controller_test.rb
          not_nows_controller_test.rb
          streams_controller_test.rb
        columns_controller_test.rb
      boards_controller_test.rb
      cards_controller_test.rb
    searches/
      queries_controller_test.rb
    sessions/
      magic_links_controller_test.rb
      menus_controller_test.rb
      transfers_controller_test.rb
    signup/
      completions_controller_test.rb
    users/
      email_addresses/
        confirmations_controller_test.rb
      avatars_controller_test.rb
      data_exports_controller_test.rb
      email_addresses_controller_test.rb
      events_controller_test.rb
      joins_controller_test.rb
      push_subscriptions_controller_test.rb
      roles_controller_test.rb
      verifications_controller_test.rb
    webhooks/
      activations_controller_test.rb
    allow_browser_test.rb
    api_test.rb
    boards_controller_test.rb
    cards_controller_test.rb
    controller_authentication_test.rb
    events_controller_test.rb
    filters_controller_test.rb
    join_codes_controller_test.rb
    landings_controller_test.rb
    notifications_controller_test.rb
    qr_codes_controller_test.rb
    searches_controller_test.rb
    sessions_controller_test.rb
    signups_controller_test.rb
    tags_controller_test.rb
    users_controller_test.rb
    webhooks_controller_test.rb
  fixtures/
    account/
      join_codes.yml
    action_text/
      rich_texts.yml
    card/
      goldnesses.yml
    files/
      avatar.png
      avatar.svg
      moon.jpg
    identity/
      access_tokens.yml
    user/
      settings.yml
    webhook/
      delinquency_trackers.yml
      deliveries.yml
    accesses.yml
    accounts.yml
    assignees_filters.yml
    assignments.yml
    boards.yml
    cards.yml
    closures.yml
    columns.yml
    comments.yml
    entropies.yml
    events.yml
    exports.yml
    filters_tags.yml
    filters.yml
    identities.yml
    mentions.yml
    notifications.yml
    pins.yml
    reactions.yml
    sessions.yml
    taggings.yml
    tags.yml
    users.yml
    watches.yml
    webhooks.yml
  helpers/
    .keep
    action_text_rendering_test.rb
    application_helper_test.rb
    entropy_helper_test.rb
    excerpt_helper_test.rb
    hotkeys_helper_test.rb
    html_helper_test.rb
  integration/
    active_storage_authorization_test.rb
    card_preview_boost_count_test.rb
  jobs/
    account/
      data_import_job_test.rb
      incinerate_due_job_test.rb
    storage/
      materialize_job_test.rb
      reconcile_job_test.rb
    delete_unused_tags_job_test.rb
  lib/
    rails_ext/
      active_record_uuid_type_test.rb
      active_storage_blob_service_url_for_direct_upload_expiry_test.rb
      string_test.rb
    web_push/
      persistent_request_test.rb
    true_client_ip_test.rb
  mailers/
    notification/
      bundle_mailer_test.rb
    previews/
      notification/
        bundle_mailer_preview.rb
      export_mailer_preview.rb
      magic_link_mailer_preview.rb
      user_mailer_preview.rb
    .keep
    account_mailer_test.rb
    export_mailer_test.rb
    import_mailer_test.rb
    magic_link_mailer_test.rb
    smtp_delivery_error_test.rb
  middleware/
    account_slug_extractor_test.rb
  models/
    account/
      data_transfer/
        action_text_rich_text_record_set_test.rb
      cancellable_test.rb
      cancellation_test.rb
      export_test.rb
      external_id_sequence_test.rb
      import_test.rb
      incineratable_test.rb
      join_code_test.rb
      multi_tenantable_test.rb
      seedeable_test.rb
    board/
      accessible_test.rb
      cards_test.rb
      publishable_test.rb
    card/
      activity_spike/
        detector_test.rb
      eventable/
        system_commenter_test.rb
      assignable_test.rb
      closeable_test.rb
      colored_test.rb
      commentable_test.rb
      entropic_test.rb
      eventable_test.rb
      exportable_test.rb
      golden_test.rb
      messages_test.rb
      pinnable_test.rb
      postponable_test.rb
      readable_test.rb
      searchable_test.rb
      stallable_test.rb
      statuses_test.rb
      taggable_test.rb
      triageable_test.rb
      watchable_test.rb
    column/
      colored_test.rb
      positioned_test.rb
    comment/
      searchable_test.rb
    concerns/
      mentions_test.rb
    event/
      description_test.rb
    filter/
      search_test.rb
    identity/
      access_token_test.rb
      joinable_test.rb
      transferable_test.rb
    magic_link/
      code_test.rb
    notification/
      bundle_test.rb
    notifier/
      event_notifier_test.rb
      mention_notifier_test.rb
    push/
      subscription_test.rb
    search/
      highlighter_test.rb
      stemmer_test.rb
    signup/
      account_name_generator_test.rb
    storage/
      attachment_tracking_test.rb
      entry_test.rb
      no_reuse_test.rb
      total_test.rb
      totaled_test.rb
      tracked_test.rb
    user/
      accessor_test.rb
      avatar_test.rb
      configurable_test.rb
      data_export_test.rb
      email_address_changeable_test.rb
      mentionable_test.rb
      named_test.rb
      notifiable_test.rb
      role_test.rb
      searcher_test.rb
      settings_test.rb
    webhook/
      delinquency_tracker_test.rb
      delivery_test.rb
      triggerable_test.rb
    access_test.rb
    account_test.rb
    assignment_test.rb
    card_test.rb
    column_limits_test.rb
    column_test.rb
    comment_test.rb
    entropy_test.rb
    filter_test.rb
    identity_test.rb
    magic_link_test.rb
    notification_pusher_test.rb
    notification_test.rb
    qr_code_link_test.rb
    reaction_test.rb
    search_test.rb
    signup_test.rb
    ssrf_protection_test.rb
    tag_test.rb
    time_window_parser_test.rb
    user_test.rb
    webhook_test.rb
    zip_file_test.rb
  system/
    .keep
    smoke_test.rb
  test_helpers/
    action_text_test_helper.rb
    caching_test_helper.rb
    card_activity_test_helper.rb
    card_test_helper.rb
    change_test_helper.rb
    command_test_helper.rb
    search_test_helper.rb
    session_test_helper.rb
    vcr_test_helper.rb
  application_system_test_case.rb
  routes_test.rb
  test_helper.rb
  webmock_ipaddr_extension.rb
.dockerignore
.gitattributes
.gitignore
.gitleaks.toml
.gitleaksignore
.mise.toml
.rubocop.yml
.ruby-version
AGENTS.md
config.ru
CONTRIBUTING.md
Dockerfile
Gemfile
Gemfile.saas
Gemfile.saas.lock
LICENSE.md
Rakefile
README.md
STYLE.md

================================================================
Files
================================================================

================
File: .claude/CLAUDE.md
================
@../AGENTS.md

================
File: .github/ISSUE_TEMPLATE/config.yml
================
blank_issues_enabled: false
contact_links:
  - name: Features, Bug Reports, Questions
    url: https://github.com/basecamp/fizzy/discussions/new/choose
    about: Please use the discussions area to report issues or ask quest

================
File: .github/ISSUE_TEMPLATE/preapproved.md
================
---
name: Pre-Discussed and Approved Topics
about: |-
  For topics already discussed and approved in the GitHub Discussions section.
---

** PLEASE START A DISCUSSION INSTEAD OF OPENING AN ISSUE **
** For more details see CONTRIBUTING.md **

================
File: .github/workflows/ci-checks.yml
================
name: Checks
on:
  pull_request:
permissions:
  contents: read
jobs:
  gemfile-drift:
    name: Gemfile drift
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: .ruby-version
          bundler-cache: true
      - name: Check for lockfile drift
        run: bin/bundle-drift check
  security:
    name: Security
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: .ruby-version
          bundler-cache: true
      - name: Gem audit
        run: bin/bundler-audit check --update
      - name: Importmap audit
        run: bin/importmap audit
      - name: Brakeman audit
        run: bin/brakeman --quiet --no-pager --exit-on-warn --exit-on-error
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: .ruby-version
          bundler-cache: true
      - name: Lint code for consistent style
        run: bin/rubocop

================
File: .github/workflows/ci-oss.yml
================
name: CI (OSS)
on:
  pull_request:
    types: [opened, synchronize]
permissions:
  contents: read
jobs:
  test:
    if: github.event.pull_request.head.repo.full_name != github.repository
    uses: ./.github/workflows/test.yml
    with:
      saas: false

================
File: .github/workflows/ci-saas.yml
================
name: CI (SaaS)
on:
  push:
permissions:
  contents: read
jobs:
  test_oss:
    name: Test (OSS)
    uses: ./.github/workflows/test.yml
    with:
      saas: false
  test_saas:
    name: Test (SaaS)
    uses: ./.github/workflows/test.yml
    with:
      saas: true
    secrets:
      FIZZY_GH_TOKEN: ${{ secrets.FIZZY_GH_TOKEN }}

================
File: .github/workflows/publish-image.yml
================
name: Build and publish container image to GHCR
on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:
concurrency:
  group: publish-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
permissions:
  contents: read
  packages: write
  id-token: write
  attestations: write
env:
  IMAGE_DESCRIPTION: Fizzy is Kanban as it should be. Not as it has been.
  SOURCE_URL: https://github.com/${{ github.repository }}
jobs:
  build:
    name: Build and push image (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: ubuntu-latest
            platform: linux/amd64
            arch: amd64
          - runner: ubuntu-24.04-arm
            platform: linux/arm64
            arch: arm64
    env:
      REGISTRY: ghcr.io
      IMAGE_NAME: ${{ github.repository }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3.12.0
      - name: Log in to GHCR
        uses: docker/login-action@v3.6.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Compute canonical image name (lowercase)
        id: vars
        shell: bash
        run: |
          set -eu
          IMAGE_REF="${IMAGE_NAME:-$GITHUB_REPOSITORY}"
          CANONICAL_IMAGE="${REGISTRY}/${IMAGE_REF,,}"
          echo "canonical=${CANONICAL_IMAGE}" >> "$GITHUB_OUTPUT"
      - name: Extract Docker metadata (tags, labels) with arch suffix
        id: meta
        uses: docker/metadata-action@v5.10.0
        with:
          images: ${{ steps.vars.outputs.canonical }}
          tags: |
            type=ref,event=branch
            type=ref,event=tag
            type=sha,format=short,prefix=sha-
            type=semver,pattern={{version}},enable=${{ startsWith(github.ref, 'refs/tags/v') }}
            type=semver,pattern={{major}}.{{minor}},enable=${{ startsWith(github.ref, 'refs/tags/v') }}
            type=semver,pattern={{major}},enable=${{ startsWith(github.ref, 'refs/tags/v') }}
          flavor: |
            latest=false
            suffix=-${{ matrix.arch }}
          labels: |
            org.opencontainers.image.source=${{ env.SOURCE_URL }}
      - name: Build and push (${{ matrix.platform }})
        id: build
        uses: docker/build-push-action@v6.18.0
        with:
          context: .
          file: Dockerfile
          build-args: |
            OCI_SOURCE=${{ env.SOURCE_URL }}
            OCI_DESCRIPTION=${{ env.IMAGE_DESCRIPTION }}
          platforms: ${{ matrix.platform }}
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=${{ matrix.platform }}
          cache-to: type=gha,scope=${{ matrix.platform }},mode=max
          sbom: false
          provenance: false
      - name: Attest image provenance (per-arch)
        if: github.event_name != 'pull_request'
        uses: actions/attest-build-provenance@v3.1.0
        with:
          subject-name: ${{ steps.vars.outputs.canonical }}
          subject-digest: ${{ steps.build.outputs.digest }}
          push-to-registry: false
  manifest:
    name: Create multi-arch manifest and sign
    needs: build
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      REGISTRY: ghcr.io
      IMAGE_NAME: ${{ github.repository }}
    steps:
      - name: Set up Docker Buildx (for imagetools)
        uses: docker/setup-buildx-action@v3.12.0
      - name: Log in to GHCR
        uses: docker/login-action@v3.6.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Compute canonical image name (lowercase)
        id: vars
        shell: bash
        run: |
          set -eu
          IMAGE_REF="${IMAGE_NAME:-$GITHUB_REPOSITORY}"
          CANONICAL_IMAGE="${REGISTRY}/${IMAGE_REF,,}"
          echo "canonical=${CANONICAL_IMAGE}" >> "$GITHUB_OUTPUT"
      - name: Compute base tags (no suffix)
        id: meta
        uses: docker/metadata-action@v5.10.0
        with:
          images: ${{ steps.vars.outputs.canonical }}
          tags: |
            type=ref,event=branch
            type=ref,event=tag
            type=sha,format=short,prefix=sha-
            type=semver,pattern={{version}},enable=${{ startsWith(github.ref, 'refs/tags/v') }}
            type=semver,pattern={{major}}.{{minor}},enable=${{ startsWith(github.ref, 'refs/tags/v') }}
            type=semver,pattern={{major}},enable=${{ startsWith(github.ref, 'refs/tags/v') }}
            type=raw,value=latest,enable=${{ startsWith(github.ref, 'refs/tags/v') }}
          flavor: |
            latest=false
          labels: |
            org.opencontainers.image.source=${{ env.SOURCE_URL }}
      - name: Create multi-arch manifests
        shell: bash
        run: |
          set -eu
          tags="${{ steps.meta.outputs.tags }}"
          echo "Creating manifests for tags:"
          printf '%s\n' "$tags"
          while IFS= read -r tag; do
            [ -z "$tag" ] && continue
            echo "Creating manifest for $tag"
            src_tag="$tag"
            if [[ "$tag" == *:latest && "${GITHUB_REF}" == refs/tags/* ]]; then
              ref="${GITHUB_REF#refs/tags/}"
              src_tag="${tag%:latest}:$ref"
            fi
            if [ -n "${IMAGE_DESCRIPTION:-}" ]; then
              docker buildx imagetools create \
                --tag "$tag" \
                --annotation "index:org.opencontainers.image.description=${IMAGE_DESCRIPTION}" \
                "${src_tag}-amd64" \
                "${src_tag}-arm64"
            else
              docker buildx imagetools create \
                --tag "$tag" \
                "${src_tag}-amd64" \
                "${src_tag}-arm64"
            fi
          done <<< "$tags"
      - name: Install Cosign
        uses: sigstore/cosign-installer@v4.0.0
      - name: Cosign sign all tags (keyless OIDC)
        shell: bash
        run: |
          set -eu
          tags="${{ steps.meta.outputs.tags }}"
          printf '%s\n' "$tags"
          while IFS= read -r tag; do
            [ -z "$tag" ] && continue
            echo "Signing $tag"
            cosign sign --yes "$tag"
          done <<< "$tags"

================
File: .github/workflows/test.yml
================
name: Test
on:
  workflow_call:
    inputs:
      saas:
        type: boolean
        required: true
    secrets:
      FIZZY_GH_TOKEN:
        required: false
permissions:
  contents: read
jobs:
  test:
    name: Tests (${{ matrix.mode }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - mode: SQLite
            db_adapter: sqlite
          - mode: MySQL
            db_adapter: mysql
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ALLOW_EMPTY_PASSWORD: yes
          MYSQL_DATABASE: fizzy_test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
    env:
      RAILS_ENV: test
      DATABASE_ADAPTER: ${{ matrix.db_adapter }}
      ${{ inputs.saas && 'SAAS' || 'SAAS_DISABLED' }}: ${{ inputs.saas && '1' || '' }}
      BUNDLE_GEMFILE: ${{ inputs.saas && 'Gemfile.saas' || 'Gemfile' }}
      MYSQL_HOST: 127.0.0.1
      MYSQL_PORT: 3306
      MYSQL_USER: root
      FIZZY_DB_HOST: 127.0.0.1
      FIZZY_DB_PORT: 3306
      BUNDLE_GITHUB__COM: ${{ inputs.saas && format('x-access-token:{0}', secrets.FIZZY_GH_TOKEN) || '' }}
    steps:
      - name: Install system packages
        run: sudo apt-get update && sudo apt-get install --no-install-recommends -y libsqlite3-0 libvips curl ffmpeg
      - uses: actions/checkout@v6
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: .ruby-version
          bundler-cache: true
      - name: Run tests
        run: bin/rails db:setup test
      - name: Run system tests
        run: bin/rails test:system

================
File: .github/dependabot.yml
================
version: 2
registries:
  github-basecamp:
    type: git
    url: https://github.com
    username: x-access-token
    password: ${{secrets.FIZZY_GH_TOKEN}}
updates:
  - package-ecosystem: bundler
    registries:
      - github-basecamp
    directory: "/"
    insecure-external-code-execution: allow
    open-pull-requests-limit: 10
    vendor: false
    groups:
      development-dependencies:
        dependency-type: "development"
    schedule:
      interval: weekly
    cooldown:
      default-days: 7
      semver-major-days: 14
  - package-ecosystem: github-actions
    directory: "/"
    schedule:
      interval: weekly
    open-pull-requests-limit: 10
    cooldown:
      default-days: 7

================
File: app/assets/images/.keep
================


================
File: app/assets/images/37signals.svg
================
<svg height="37" viewBox="0 0 37 37" width="37" xmlns="http://www.w3.org/2000/svg"><g fill="currentColor"><path d="m35.4812 22.164c2.0248-2.0239 2.0248-5.3007-.0003-7.3248-2.0198-2.0258-5.301-2.0258-7.319.0007-2.0281 2.0232-2.0292 5.3012 0 7.3241 2.017 2.0215 5.2989 2.0221 7.3193 0z"></path><path d="m22.1611 8.84334c2.0249-2.02387 2.0249-5.30008-.0002-7.32415-2.0198-2.02571-5.301-2.025711-7.319.00075-2.0281 2.02309-2.0292 5.30112 0 7.32404 2.017 2.02152 5.2989 2.02152 7.3192-.00064z"></path><path d="m14.8417 35.4878c-2.0004-1.9957-1.9608-5.2847 0-7.3054 1.6632-1.6643 1.6633-4.3568 0-6.0182-1.6514-1.6494-4.3462-1.6166-6.01902 0-2.01326 2.0137-5.29117 2.0138-7.30726 0-2.000628-1.9982-1.960613-5.3031.00011-7.3247 1.64664-1.6469 1.614-4.3531 0-6.02035-2.020627-2.01857-2.020787-5.2857 0-7.30443 2.01572-2.019741 5.29428-2.019741 7.30798.00069 2.00119 1.99779 1.96109 5.28187-.0009 7.30374-1.6608 1.66305-1.6608 4.35645.00061 6.02035 1.65198 1.6478 4.34698 1.6154 6.01848 0 2.0158-2.0162 5.3064-2.0167 7.3201 0 2.004 1.9963 1.9646 5.3019 0 7.3247-1.6606 1.661-1.6615 4.354 0 6.0188 2.0241 2.0154 2.0252 5.2892 0 7.3055-2.0128 2.0155-5.3039 2.0155-7.3201-.0007z"></path></g></svg>

================
File: app/assets/images/activity.svg
================
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m3 22v-14h4v14zm7 0v-20h4v20zm7 0v-8h4v8z"/></svg>

================
File: app/assets/images/add.svg
================
<svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><path d="m4 16c0 .8.7 1.5 1.5 1.5h8.8c.1 0 .2.1.2.2v8.8c0 .8.7 1.5 1.5 1.5s1.5-.7 1.5-1.5v-8.8c0-.1.1-.2.2-.2h8.8c.8 0 1.5-.7 1.5-1.5s-.7-1.5-1.5-1.5h-8.8c-.1 0-.2-.1-.2-.2v-8.8c0-.8-.7-1.5-1.5-1.5s-1.5.7-1.5 1.5v8.8c0 .1-.1.2-.2.2h-8.8c-.8 0-1.5.7-1.5 1.5z"/></svg>

================
File: app/assets/images/arrow-left.svg
================
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m21.864 9.5h-11.607a.25.25 0 0 1 -.174-.43l3.864-3.721a2.609 2.609 0 0 0 -.075-3.682 2.612 2.612 0 0 0 -3.68-.077l-9.792 9.699a1 1 0 0 0 -.008 1.411l9.625 9.724a2.66 2.66 0 0 0 3.755-3.757l-3.729-3.733a.25.25 0 0 1 .177-.427h11.673c1.556 0 2-1.675 2-2.51a2.28 2.28 0 0 0 -2.029-2.497z"/></svg>

================
File: app/assets/images/arrow-right.svg
================
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m23.6 11.289-9.793-9.7a2.607 2.607 0 0 0-3.679.075 2.64 2.64 0 0 0-.068 3.689l3.871 3.714a.25.25 0 0 1-.173.43H2.135A2.28 2.28 0 0 0 .1 12c0 .815.448 2.51 2 2.51h11.679a.25.25 0 0 1 .177.427l-3.731 3.733a2.66 2.66 0 0 0 3.758 3.754l9.625-9.72a1 1 0 0 0-.008-1.415"/></svg>

================
File: app/assets/images/arrow-up.svg
================
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m22.41 10.2-9.704-9.8a.99.99 0 0 0 -.706-.3.992.992 0 0 0 -.7.289l-9.727 9.631a2.6 2.6 0 0 0 .1 3.657 2.59 2.59 0 0 0 3.657.1l3.743-3.732a.25.25 0 0 1 .426.178v11.666c-.016 1.559 1.665 2.011 2.501 2.011a2.276 2.276 0 0 0 2.5-2.034v-11.625a.25.25 0 0 1 .431-.173l3.722 3.881a2.658 2.658 0 0 0 3.757-3.749z"/></svg>

================
File: app/assets/images/art.svg
================
<svg enable-background="new 0 0 24 24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m14.2 15.2c.1-.7-.4-1.4-1.1-1.5-1.8-.2-3.5.8-4.2 2.5-.5 1.2-1 1.1-1.5.9-2.7-.7-4.6-3.1-4.8-5.8.1-3.5 3.6-6.3 7.9-6.3 1.7 0 3.3.4 4.7 1.3.6.4 1.5.2 1.9-.4s.2-1.5-.4-1.9c-1.9-1.1-4-1.7-6.1-1.7-6-.1-10.6 4-10.6 9 .2 3.9 2.8 7.3 6.6 8.4 1.9.7 4-.2 4.7-2.1 0-.1.1-.2.1-.3.2-.6.8-.9 1.4-.9s1.3-.5 1.4-1.2z"/><circle cx="6.1" cy="12.8" r="1.3"/><circle cx="7.4" cy="8.4" r="1.3"/><circle cx="11.8" cy="7.5" r="1.3"/><path d="m21.8 4.4c-.3-.2-.6-.2-.9-.1s-.5.4-.5.7c0 1.1-.6 2.1-1.5 2.6-1.3 1-2.2 2-1.8 3.7.1.4.3.8.5 1.1s.2.6.1.9l-4.5 8.9c-.3.7-.1 1.5.6 1.8s1.5.1 1.8-.6l4.7-9.3c.1-.2.3-.4.6-.5.9-.2 1.6-.8 2.2-1.5.8-1.1 1.1-2.5.8-3.8-.2-1.6-1-2.9-2.1-3.9z"/></svg>

================
File: app/assets/images/assigned.svg
================
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m20.3 11.5-7-6.9c-.7-.7-1.9-.7-2.6 0s-.8 1.9 0 2.6l2.8 2.7v.3s0 0-.1 0h-8.5c-.9 0-1.5.9-1.5 1.8 0 .6.3 1.8 1.4 1.8h8.4s.2 0 .2.2v.1l-2.7 2.7c-.7.8-.6 2 .2 2.7.7.6 1.8.6 2.5 0l6.9-7c.3-.3.3-.7 0-1z"/></svg>

================
File: app/assets/images/attachment.svg
================
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m21.843 3.455.00000011.00000011c-2.71798-2.7189-7.12544-2.71964-9.84434-.00165975-.00055327.00055308-.00110645.00110626-.00165953.00165953l-10.378 10.377-.0000006.00000061c-1.99277 2.0124-1.97685 5.25923.035554 7.252 1.99848 1.97898 5.21803 1.97896 7.21649-.0000451l8.42896-8.43096.00000006-.00000006c1.33478-1.23529 1.41544-3.31874.180153-4.65352-1.23529-1.33478-3.31874-1.41544-4.65352-.180153-.0625256.0578649-.122782.118134-.180634.180672l-5.189 5.184-.00000003.00000003c-.391018.390465-.391465 1.02398-.00099993 1.415.390465.391018 1.02398.391465 1.415.00099993l5.189-5.191c.517058-.493341 1.33615-.474114 1.82949.0429441.477234.500177.477019 1.28714-.00048841 1.78706l-8.432 8.431.00000024-.00000024c-1.22165 1.22165-3.20235 1.22165-4.424.00000043-1.22165-1.22165-1.22165-3.20235-.00000043-4.424l10.378-10.377.00000003-.00000003c1.93797-1.93797 5.08003-1.93797 7.018-.00000004 1.93797 1.93797 1.93797 5.08003.00000004 7.018l-7.783 7.783.00000001-.00000001c-.397252.383679-.408255 1.01675-.0245764 1.414.383679.397252 1.01675.408255 1.414.0245764.00833389-.00804914.0165273-.0162425.0245764-.0245764l7.783-7.784.00000012-.00000012c2.7189-2.7172 2.72027-7.12403.00307385-9.84293-.00102438-.00102502-.00204907-.00204971-.00307409-.00307409z"/></svg>

================
File: app/assets/images/bell-alert.svg
================
<svg enable-background="new 0 0 24 24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m17 20.5c0 .2 0 .3-.1.5.1-.1.1-.3.1-.5z"/><path d="m14.1 9.1c.1-.2.2-.3.3-.4-.1.1-.2.2-.3.4l-2.2 4.2z"/><path d="m14 6.6c.6-.3 1.2-.4 1.8-.4h.2c-1.2-1.6-3-2.7-5-3.1v-2.1c0-.6-.4-1-1-1s-1 .4-1 1v2.1c-3.9.7-6.6 4.1-6.5 8.1v4.8c0 .8-.7 1.5-1.5 1.5-.6 0-1 .4-1 1s.4 1 1 1h5.4l5.9-11.3c.4-.7 1-1.3 1.7-1.6z"/><path d="m23.8 21.3-6.4-12.2c0-.1-.1-.1-.1-.2s-.1-.1-.2-.2c0 0-.1-.1-.1-.1s-.1-.1-.1-.1c-.1 0-.1-.1-.2-.1 0 0-.1 0-.1-.1-.1-.1-.3-.1-.4-.2h-.1-.1c-.1 0-.2 0-.3 0s0 0-.1 0c0 0 0 0-.1 0h-.1c-.1 0-.1 0-.2 0h-.1c-.1 0-.3.1-.4.1-.3.2-.6.4-.8.8l-5.2 10.5-.8 1.5-.2.3c-.1.2-.1.4-.2.5-.1.4 0 .9.2 1.3.4.6 1 .9 1.6.9h.7 12.2c.6 0 1.2-.3 1.6-.9.3-.5.3-1.2 0-1.8zm-8.7-3.6c-.1-.1-.2-.2-.2-.3v-.1c0-.1-.1-.2-.1-.3v-3.2c0-.1 0-.2.1-.3v-.1c0-.1.1-.1.1-.2 0 0 0 0 .1-.1.2-.2.4-.3.6-.3.5 0 1 .4 1 1v3.2c0 .5-.4 1-1 1-.2 0-.4-.1-.6-.3zm.7 4.1c.4 0 .7-.1.9-.4-.3.2-.6.4-.9.4-.7 0-1.3-.6-1.3-1.3 0-.1 0-.3.1-.4 0-.1 0-.1.1-.1 0-.1.1-.1.1-.1.1-.1.2-.2.3-.3s.2-.1.3-.2c.1 0 .3-.1.4-.1.3 0 .5.1.7.3.3.2.5.6.5 1 0 .6-.5 1.2-1.2 1.2z"/></svg>

================
File: app/assets/images/bell-off.svg
================
<svg enable-background="new 0 0 24 24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m15.9 19.5-11-11c-.3.8-.4 1.7-.4 2.6v4.9c0 .8-.7 1.5-1.5 1.5-.6 0-1 .4-1 1s.4 1 1 1z"/><path d="m9.5 21.2v.3c0 1.4 1.1 2.5 2.5 2.5s2.5-1.1 2.5-2.5c0-.1 0-.2 0-.3s-.1-.2-.2-.2h-4.5c-.2 0-.3.1-.3.2z"/><path d="m23.7 23.7c.4-.4.4-1 0-1.4l-2.8-2.8h.1c.6 0 1-.4 1-1s-.4-1-1-1c-.8 0-1.5-.7-1.5-1.5v-4.9c.1-3.9-2.6-7.4-6.5-8.1v-2c0-.6-.4-1-1-1s-1 .4-1 1v2.1c-1.6.3-3.1 1-4.3 2.3l-5-5c-.4-.4-1-.4-1.4 0-.4.4-.4 1 0 1.4l22 22c.2.2.4.3.7.3.3-.1.5-.2.7-.4z"/></svg>

================
File: app/assets/images/bell.svg
================
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m21 17.5a1.5 1.5 0 0 1 -1.5-1.5v-4.862a7.957 7.957 0 0 0 -6.5-8.065v-2.073a1 1 0 0 0 -2 0v2.073a7.957 7.957 0 0 0 -6.5 8.065v4.862a1.5 1.5 0 0 1 -1.5 1.5 1 1 0 0 0 0 2h18a1 1 0 0 0 0-2z"/><path d="m14.236 21h-4.472a.25.25 0 0 0 -.248.222 2.319 2.319 0 0 0 -.016.278 2.5 2.5 0 1 0 5 0 2.319 2.319 0 0 0 -.016-.278.248.248 0 0 0 -.248-.222z"/></svg>

================
File: app/assets/images/board-add.svg
================
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m3 5h8v2h-8zm10 0h8v2h-8zm-10 4h8v2h-8zm10 0h8v2h-8zm-10 4h8v2h-8zm0 4h8v2h-8zm17.9.9h-3v3c0 .5-.4.9-.9.9s-.9-.4-.9-.9v-3h-3c-.5 0-.9-.4-.9-.9s.4-.9.9-.9h3v-3c0-.5.4-.9.9-.9s.9.4.9.9v3h3c.5 0 .9.4.9.9s-.4.9-.9.9z"/></svg>

================
File: app/assets/images/board.svg
================
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m21.8 0h-19.6c-1.2 0-2.2 1-2.2 2.2v19.5c0 1.2 1 2.2 2.2 2.2h19.5c1.2 0 2.2-1 2.2-2.2v-19.5c0-1.2-1-2.2-2.2-2.2zm-10.8 19h-8v-2h8zm0-4h-8v-2h8zm0-4h-8v-2h8zm0-4h-8v-2h8zm10 8h-8v-2h8zm0-4h-8v-2h8zm0-4h-8v-2h8z"/></svg>

================
File: app/assets/images/bolt.svg
================
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m10.9 15.3h-5.5l7.7-15.3v8.7h5.5l-7.6 15.3v-8.7z"/></svg>

================
File: app/assets/images/bookmark-outline.svg
================
<svg viewBox="0 0 52 52" xmlns="http://www.w3.org/2000/svg"><path d="m14.5 49.6c-1.4.8-3.3.3-4.1-1.1-.3-.5-.4-1-.4-1.5v-41c0-2.2 1.8-4 4-4h24c2.2 0 4 1.8 4 4v41c0 1.7-1.3 3-3 3s-1 0-1.5-.4l-11.5-6.6zm23.5-4.3v-39.3h-24v39.3l10.8-6.1c.8-.4 1.7-.4 2.5 0l10.8 6.1z" fill-rule="evenodd"/></svg>

================
File: app/assets/images/bookmark.svg
================
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m18.7 0h-13.4c-1.5 0-2.7 1.2-2.7 2.7v21.3l9.3-4 9.3 4v-21.3c0-1.5-1.2-2.7-2.7-2.7z"/></svg>

================
File: app/assets/images/boost-color.svg
================
<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<g clip-path="url(#clip0_603_25)">
<g opacity="0.9">
<path d="M9.32669 17.2826L7.29395 15.0448L7.2427 15.0875L5.60284 13.4092L6.49964 19.1402L10.0612 22.706L10.2576 18.064L9.39074 17.2228L9.32669 17.2826Z" fill="#AEAEAE" style="fill:#AEAEAE;fill:color(display-p3 0.6824 0.6824 0.6824);fill-opacity:1;"/>
<path d="M17.8164 7.82349L12.0854 6.9267L14.5196 9.39502L14.4683 9.43346L15.3651 10.4199L15.4847 10.326L16.7402 11.5815L21.3822 11.3851L17.8164 7.82349Z" fill="#AEAEAE" style="fill:#AEAEAE;fill:color(display-p3 0.6824 0.6824 0.6824);fill-opacity:1;"/>
</g>
<path opacity="0.9" d="M17.9018 14.4897L19.3751 16.7488L15.4249 20.6989L13.2427 19.2769L17.9018 14.4897Z" fill="#E6E2E0" style="fill:#E6E2E0;fill:color(display-p3 0.9020 0.8863 0.8784);fill-opacity:1;"/>
<path opacity="0.9" d="M1.35374 2.67757C5.18434 1.61422 8.75445 3.59572 10.4327 5.26974C10.9324 5.76938 18.4185 13.2555 18.4185 13.2555L11.9359 19.7381C11.9359 19.7381 5.15872 12.9608 3.95018 11.7523C2.27616 10.0825 0.290391 6.51244 1.35374 2.67757Z" fill="#ECE5E3" style="fill:#ECE5E3;fill:color(display-p3 0.9255 0.8980 0.8902);fill-opacity:1;"/>
<path d="M7.60142 10.8427C6.59198 10.8427 5.77366 10.0244 5.77366 9.01495C5.77366 8.00551 6.59198 7.18719 7.60142 7.18719C8.61087 7.18719 9.42918 8.00551 9.42918 9.01495C9.42918 10.0244 8.61087 10.8427 7.60142 10.8427Z" fill="white" style="fill:white;fill-opacity:1;"/>
<path d="M7.60142 11.3765C6.29716 11.3765 5.23986 10.3192 5.23986 9.01495C5.23986 7.71069 6.29716 6.65338 7.60142 6.65338C8.90568 6.65338 9.96299 7.71069 9.96299 9.01495C9.96299 10.3192 8.90568 11.3765 7.60142 11.3765Z" stroke="#70708D" style="stroke:#70708D;stroke:color(display-p3 0.4392 0.4392 0.5529);stroke-opacity:1;" stroke-width="1.06762"/>
<path d="M1.12739 2.79289C1.17437 2.62634 1.30248 2.49396 1.4733 2.44698C3.27544 1.94734 5.23131 2.04556 7.12312 2.72883C8.58789 3.25837 10.0142 4.14663 11.0349 5.16727L12.5722 6.70464L18.1409 7.58008C18.2434 7.59716 18.3416 7.64414 18.4142 7.72101L21.9801 11.2826C22.121 11.4235 22.1637 11.6285 22.0911 11.8121C22.0185 11.9957 21.8477 12.1196 21.6512 12.1281L18.1366 12.2776L19.0164 13.1573C19.2085 13.3495 19.2085 13.6655 19.0164 13.8577L18.5039 14.3701L20.0413 16.7231C20.1694 16.9196 20.1438 17.1758 19.9772 17.3424L16.027 21.2925C15.8605 21.4591 15.6043 21.4847 15.4078 21.3566L13.0548 19.8192L12.5423 20.3317C12.3502 20.5239 12.0342 20.5239 11.842 20.3317L10.9623 19.452L10.8043 22.9751C10.7957 23.1715 10.6719 23.3424 10.4882 23.415C10.4285 23.4363 10.3687 23.4491 10.3089 23.4491C10.1808 23.4491 10.0527 23.3979 9.95871 23.3039L6.39287 19.7381C6.32028 19.6655 6.26903 19.5673 6.25195 19.4648L5.38077 13.8918L3.84341 12.3545C2.82277 11.3338 1.93451 9.90748 1.40497 8.44271C0.721699 6.5509 0.627749 4.5993 1.12739 2.79289ZM15.6085 20.3146L18.9907 16.9324L17.7865 15.0876L16.1253 16.7488L15.4249 17.4491L13.7637 19.1103L15.6085 20.3146ZM4.54803 11.6541L6.2007 13.3068C6.2007 13.3068 6.77295 13.879 7.9217 15.0278L7.22134 15.7281L6.57223 15.079L7.20853 19.153L9.86476 21.8093L10.0014 18.5082L6.9096 15.4164L7.60996 14.716L10.8512 17.9573C10.8512 17.9573 11.2954 18.4014 12.1794 19.2854L12.6192 18.8456C12.6235 18.8413 13.3238 18.1409 14.7203 16.7445L15.4206 16.0441L17.5089 13.9644C17.5132 13.9602 17.6626 13.8107 17.9658 13.5075L16.6377 12.1794C16.6377 12.1794 16.1381 11.6669 15.1431 10.642L15.8434 9.94165L17.1843 11.3253L20.4854 11.1886L17.8334 8.53666L13.7594 7.90037L15.8605 9.95873L15.1601 10.6591L11.9957 7.53738L10.3388 5.88044C8.96369 4.50535 5.69252 2.46407 2.01565 3.34378C1.13166 7.00784 3.16867 10.279 4.54803 11.6541Z" fill="#70708D" style="fill:#70708D;fill:color(display-p3 0.4392 0.4392 0.5529);fill-opacity:1;"/>
<path d="M18.3843 19.6356C18.5765 19.4434 18.8925 19.4434 19.0847 19.6356L21.7324 22.2833C21.9246 22.4754 21.9246 22.7915 21.7324 22.9836C21.6342 23.0818 21.5103 23.1288 21.3822 23.1288C21.2541 23.1288 21.1302 23.0818 21.032 22.9836L18.3843 20.3359C18.1879 20.1438 18.1879 19.8278 18.3843 19.6356Z" fill="#FFA235" style="fill:#FFA235;fill:color(display-p3 1.0000 0.6353 0.2078);fill-opacity:1;"/>
<path d="M19.9431 18.7772C19.7509 18.5851 19.7509 18.269 19.9431 18.0769C20.1353 17.8847 20.4513 17.8847 20.6434 18.0769L22.531 19.9644C22.7232 20.1566 22.7232 20.4726 22.531 20.6648C22.4328 20.763 22.3089 20.81 22.1808 20.81C22.0527 20.81 21.9288 20.763 21.8306 20.6648L19.9431 18.7772Z" fill="#FFA235" style="fill:#FFA235;fill:color(display-p3 1.0000 0.6353 0.2078);fill-opacity:1;"/>
<path d="M17.4534 21.2669L19.3409 23.1545C19.5331 23.3466 19.5331 23.6627 19.3409 23.8548C19.2427 23.9531 19.1189 24 18.9907 24C18.8626 24 18.7388 23.9531 18.6406 23.8548L16.753 21.9673C16.5609 21.7751 16.5609 21.4591 16.753 21.2669C16.9452 21.0748 17.2569 21.0748 17.4534 21.2669Z" fill="#FFA235" style="fill:#FFA235;fill:color(display-p3 1.0000 0.6353 0.2078);fill-opacity:1;"/>
</g>
<defs>
<clipPath id="clip0_603_25">
<rect width="24" height="24" fill="white" style="fill:white;fill-opacity:1;"/>
</clipPath>
</defs>
</svg>

================
File: app/assets/images/boost.svg
================
<svg fill="none" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><g fill="#000"><path d="m8.81809 9.31801c.78104-.78104.78104-2.04737 0-2.82842-.78105-.78105-2.04738-.78105-2.82843 0s-.78105 2.04738 0 2.82842c.78105.78109 2.04738.78109 2.82843 0z"/><g clip-rule="evenodd" fill-rule="evenodd"><path d="m2.45414 2.95391-.26309-.96467c-.34161.09317-.60848.36004-.70165.70165l.96474.26302c-.96476-.26311-.96501-.26204-.96528-.26102l-.00059.00219-.00132.00493-.00313.01207c-.00231.00902-.00503.01998-.00809.03285-.00613.02575-.01364.05917-.0219.1-.01652.08166-.0361.19306-.05381.33223-.03543.27837-.06342.66796-.04453 1.15265.03787.97202.26394 2.31564.98381 3.89935.8229 1.81034 2.27431 3.89984 4.77227 6.09594l.00009.0073c.00061.0373.00179.0899.00408.1563.00458.1327.01359.3209.03136.5519.03542.4605.1062 1.0984.24849 1.8098.2769 1.3845.85643 3.2153 2.12963 4.4885.21774.2177.52368.323.82928.2854.3056-.0377.5769-.214.7353-.478l1.6909-2.8182c.6131.3562 1.2584.7124 1.9374 1.0681.3874.2029.8618.1305 1.1711-.1787l2.8284-2.8285c.3093-.3092.3817-.7836.1787-1.1711-.3556-.679-.7119-1.3243-1.0681-1.9374l2.818-1.6908c.2641-.1584.4404-.4297.478-.7353.0376-.3057-.0676-.6116-.2854-.8293-1.2732-1.27322-3.1039-1.85274-4.4884-2.12965-.7115-.14228-1.3493-.21306-1.8099-.24849-.231-.01777-.4191-.02678-.5518-.03135-.0664-.00229-.1191-.00348-.1564-.00409l-.007-.00009c-2.1961-2.49798-4.28557-3.9494-6.09597-4.77231-1.58371-.71987-2.92733-.94593-3.89936-.9838-.48468-.01888-.87428.00911-1.15265.04454-.13917.01771-.25057.03729-.33223.05381-.04083.00826-.07425.01576-.1.02189-.01287.00307-.02383.00579-.03285.0081l-.01207.00313-.00493.00131-.00219.00059c-.00102.00028-.002.00055.26109.96522zm15.86966 7.69679-1.5386.9232c-.4098-.6365-.8186-1.2324-1.2253-1.79023.1291.02154.2622.04575.3982.07295.8048.16098 1.6435.41378 2.3657.79408zm-7.2497 6.6344c-.6365-.4098-1.2325-.8187-1.79034-1.2255.02156.1293.04577.2625.07299.3986.16096.8048.41377 1.6435.79415 2.3657zm-7.32199-13.4313c-.14793-.00576-.28161-.00564-.40011-.00197-.00368.1185-.00379.25218.00197.40011.02842.72945.20011 1.81651.80606 3.14961 1.17236 2.57918 4.01908 6.18035 10.83867 9.87795l1.781-1.781c-3.6976-6.81957-7.29878-9.66629-9.87797-10.83864-1.3331-.60596-2.42016-.77764-3.14962-.80606zm-.33077-.64563c.00038-.00148.00049-.00208 0 0z"/><path d="m21.4037 23.0358 1.3207.1887-.1885-1.32-.99.1415c.99-.1415.9898-.1427.9897-.1431l-.0002-.0019-.0007-.0045-.0018-.0118-.0056-.0341c-.0046-.0274-.0112-.0639-.0201-.1085-.0178-.089-.0451-.2109-.0849-.357-.0791-.2902-.2109-.6863-.4239-1.1122-.4225-.845-1.2101-1.8906-2.6111-2.3576l-.5863-.1955-1.5812 1.5812.1955.5863c.467 1.401 1.5126 2.1886 2.3576 2.6111.4259.213.8219.3448 1.1121.4239.1461.0399.2681.0671.3571.0849.0445.0089.081.0155.1084.0202l.0342.0055.0117.0018.0045.0007zm.1422-.9898-.1422.9898c.0004.0001.0008.0001.1422-.9898z"/></g></g></svg>

================
File: app/assets/images/camera.svg
================
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><circle cx="14.75" cy="13.125" r="3.75"/><path d="m21.444 6.125h-1.316a.534.534 0 0 1 -.481-.346c-.618-1.304-1.257-2.654-2.647-2.654h-5c-1.071 0-1.636.778-2.659 2.191-.384.527-.51.809-.844.809h-6c-2.063 0-2.497 1.209-2.497 2.223v10.388a2.254 2.254 0 0 0 2.556 2.389h18.888a2.254 2.254 0 0 0 2.556-2.389v-10.388c0-1.014-.443-2.223-2.556-2.223zm-.944 7a5.75 5.75 0 1 1 -5.75-5.75 5.756 5.756 0 0 1 5.75 5.75zm-15.5-3.25a1.25 1.25 0 1 1 -1.25-1.25 1.25 1.25 0 0 1 1.25 1.25z"/><path d="m2.5 5.109 3 .016a.5.5 0 0 0 .5-.5v-.25a1.5 1.5 0 0 0 -1.5-1.5h-1a1.5 1.5 0 0 0 -1.5 1.5v.234a.5.5 0 0 0 .5.5z"/></svg>

================
File: app/assets/images/caret-down.svg
================
<svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 8l8 8 8-8" stroke="#000" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/></svg>

================
File: app/assets/images/check-circle.svg
================
<svg fill="none" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><g fill="#000"><path d="m15.166 7.44824c.3049-.46037.9253-.58686 1.3858-.28222.4603.30484.5868.92529.2822 1.38574l-5.2979 8.00004c-.1657.2502-.4347.4133-.7334.4433-.2986.03-.5954-.0758-.80758-.2881l-2.70215-2.7041c-.39038-.3906-.39057-1.0236 0-1.414.39049-.3903 1.02361-.3903 1.41406 0l1.83787 1.8379z"/><path clip-rule="evenodd" d="m12 1c6.0751 0 11 4.92487 11 11 0 6.0751-4.9249 11-11 11-6.07513 0-11-4.9249-11-11 0-6.07513 4.92487-11 11-11zm0 2c-4.97056 0-9 4.02944-9 9 0 4.9706 4.02944 9 9 9 4.9706 0 9-4.0294 9-9 0-4.97056-4.0294-9-9-9z" fill-rule="evenodd"/></g></svg>

================
File: app/assets/images/check.svg
================
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m23.146 5.4-2.792-2.8a.5.5 0 0 0-.708 0L7.854 14.4a.5.5 0 0 1-.708 0l-2.792-2.8a.5.5 0 0 0-.708 0L.854 14.4a.5.5 0 0 0 0 .707L7.146 21.4a.5.5 0 0 0 .708 0L23.146 6.1a.5.5 0 0 0 0-.7"/></svg>

================
File: app/assets/images/clipboard.svg
================
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m19 3h-4.18c-.42-1.16-1.52-2-2.82-2s-2.4.84-2.82 2h-4.18a2 2 0 0 0 -2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-14a2 2 0 0 0 -2-2m-7 0a1 1 0 0 1 1 1 1 1 0 0 1 -1 1 1 1 0 0 1 -1-1 1 1 0 0 1 1-1m-5 4h10v-2h2v14h-14v-14h2z"/></svg>

================
File: app/assets/images/close-circle.svg
================
<svg fill="none" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><g fill="#000"><path d="m15.293 7.29297c.3905-.39052 1.0235-.39052 1.414 0 .3906.39052.3905 1.02354 0 1.41406l-3.2929 3.29297 3.2929 3.293c.3905.3905.3906 1.0235 0 1.414-.3905.3905-1.0235.3905-1.414 0l-3.293-3.2929-3.29297 3.2929c-.39052.3906-1.02354.3906-1.41406 0-.39052-.3905-.39052-1.0235 0-1.414l3.29293-3.293-3.29293-3.29297c-.39052-.39052-.39052-1.02354 0-1.41406.39052-.39053 1.02354-.39053 1.41406 0l3.29297 3.29293z"/><path clip-rule="evenodd" d="m12 1c6.0751 0 11 4.92487 11 11 0 6.0751-4.9249 11-11 11-6.07513 0-11-4.9249-11-11 0-6.07513 4.92487-11 11-11zm0 2c-4.97056 0-9 4.02944-9 9 0 4.9706 4.02944 9 9 9 4.9706 0 9-4.0294 9-9 0-4.97056-4.0294-9-9-9z" fill-rule="evenodd"/></g></svg>

================
File: app/assets/images/close.svg
================
<svg fill="none" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="m18.9396 2.93934c.5858-.58572 1.5353-.58576 2.1211 0 .5857.58577.5857 1.53532 0 2.12109l-6.9395 6.93947 6.9395 6.9394c.5856.5858.5857 1.5354 0 2.1211-.5858.5857-1.5353.5856-2.1211 0l-6.9395-6.9394-6.93942 6.9394c-.58577.5858-1.5353.5858-2.1211 0-.58578-.5858-.58578-1.5353 0-2.1211l6.93946-6.9394-6.93946-6.93947c-.58577-.58577-.58574-1.5353 0-2.12109.58579-.58579 1.53531-.58579 2.1211 0l6.93942 6.93945z" fill="#000"/></svg>

================
File: app/assets/images/collapse.svg
================
<svg fill="none" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><g fill="#000"><path d="m10.0001 13.0002c.5523 0 1 .4477 1 1v6c0 .5522-.4478.9999-1 1-.55224 0-.99994-.4478-.99999-1v-3.586l-5.29297 5.293c-.3905.3905-1.02353.3904-1.41406 0-.39053-.3905-.39053-1.0236 0-1.4141l5.29297-5.2929h-3.58594c-.55225 0-.99995-.4478-1-1 0-.5523.44771-1 1-1z"/><path d="m20.2931 2.29313c.3905-.39051 1.0235-.39052 1.414 0s.3905 1.02356 0 1.41406l-5.2929 5.29297h3.5859c.5523.00004 1 .44774 1 1.00004 0 .5522-.4478.9999-1 1h-6c-.5522 0-.9999-.4478-1-1v-6.00004c0-.55229.4477-1 1-1 .5523.00004 1 .44774 1 1v3.58593z"/></g></svg>

================
File: app/assets/images/column-left.svg
================
<svg width="21" height="21" viewBox="0 0 21 21" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M4 9V12L0 8L4 4V7H8V9" fill="black"/>
<g filter="url(#filter0_dd_6_4)">
<path d="M6 5L6 2C6 1.44772 6.44772 1 7 1C7.55228 1 8 1.44772 8 2L8 5" fill="black"/>
</g>
<path d="M8 11V16C8 16.5523 7.55228 17 7 17C6.44772 17 6 16.5523 6 16V11" fill="black"/>
<path d="M12 1C12.5523 1 13 1.44772 13 2V20C13 20.5523 12.5523 21 12 21C11.4477 21 11 20.5523 11 20V2C11 1.44772 11.4477 1 12 1Z" fill="black"/>
<path d="M17 1C17.5523 1 18 1.44772 18 2V13C18 13.5523 17.5523 14 17 14C16.4477 14 16 13.5523 16 13V2C16 1.44772 16.4477 1 17 1Z" fill="black"/>
<rect x="7" y="7" width="2" height="2" rx="1" fill="black"/>
<path d="M4 9V12L0 8L4 4V7H8V9" fill="black"/>
<g filter="url(#filter1_dd_6_4)">
<path d="M6 5L6 2C6 1.44772 6.44772 1 7 1C7.55228 1 8 1.44772 8 2L8 5" fill="black"/>
</g>
<path d="M8 11V16C8 16.5523 7.55228 17 7 17C6.44772 17 6 16.5523 6 16V11" fill="black"/>
<path d="M12 1C12.5523 1 13 1.44772 13 2V20C13 20.5523 12.5523 21 12 21C11.4477 21 11 20.5523 11 20V2C11 1.44772 11.4477 1 12 1Z" fill="black"/>
<path d="M17 1C17.5523 1 18 1.44772 18 2V13C18 13.5523 17.5523 14 17 14C16.4477 14 16 13.5523 16 13V2C16 1.44772 16.4477 1 17 1Z" fill="black"/>
<rect x="7" y="7" width="2" height="2" rx="1" fill="black"/>
<defs>
<filter id="filter0_dd_6_4" x="2" y="1" width="10" height="12" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
<feFlood flood-opacity="0" result="BackgroundImageFix"/>
<feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha"/>
<feOffset dy="4"/>
<feGaussianBlur stdDeviation="2"/>
<feComposite in2="hardAlpha" operator="out"/>
<feColorMatrix type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.25 0"/>
<feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow_6_4"/>
<feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha"/>
<feOffset dy="4"/>
<feGaussianBlur stdDeviation="2"/>
<feComposite in2="hardAlpha" operator="out"/>
<feColorMatrix type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.25 0"/>
<feBlend mode="normal" in2="effect1_dropShadow_6_4" result="effect2_dropShadow_6_4"/>
<feBlend mode="normal" in="SourceGraphic" in2="effect2_dropShadow_6_4" result="shape"/>
</filter>
<filter id="filter1_dd_6_4" x="2" y="1" width="10" height="12" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
<feFlood flood-opacity="0" result="BackgroundImageFix"/>
<feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha"/>
<feOffset dy="4"/>
<feGaussianBlur stdDeviation="2"/>
<feComposite in2="hardAlpha" operator="out"/>
<feColorMatrix type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.25 0"/>
<feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow_6_4"/>
<feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha"/>
<feOffset dy="4"/>
<feGaussianBlur stdDeviation="2"/>
<feComposite in2="hardAlpha" operator="out"/>
<feColorMatrix type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.25 0"/>
<feBlend mode="normal" in2="effect1_dropShadow_6_4" result="effect2_dropShadow_6_4"/>
<feBlend mode="normal" in="SourceGraphic" in2="effect2_dropShadow_6_4" result="shape"/>
</filter>
</defs>
</svg>

================
File: app/assets/images/column-right.svg
================
<svg width="21" height="21" viewBox="0 0 21 21" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M17 9V12L21 8L17 4V7H13V9" fill="black"/>
<g filter="url(#filter0_dd_7_17)">
<path d="M15 5L15 2C15 1.44772 14.5523 1 14 1C13.4477 1 13 1.44772 13 2L13 5" fill="black"/>
</g>
<path d="M13 11V16C13 16.5523 13.4477 17 14 17C14.5523 17 15 16.5523 15 16V11" fill="black"/>
<path d="M9 1C8.44772 1 8 1.44772 8 2V20C8 20.5523 8.44772 21 9 21C9.55228 21 10 20.5523 10 20V2C10 1.44772 9.55228 1 9 1Z" fill="black"/>
<path d="M4 1C3.44772 1 3 1.44772 3 2V13C3 13.5523 3.44772 14 4 14C4.55228 14 5 13.5523 5 13V2C5 1.44772 4.55228 1 4 1Z" fill="black"/>
<rect width="2" height="2" rx="1" transform="matrix(-1 0 0 1 14 7)" fill="black"/>
<defs>
<filter id="filter0_dd_7_17" x="9" y="1" width="10" height="12" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
<feFlood flood-opacity="0" result="BackgroundImageFix"/>
<feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha"/>
<feOffset dy="4"/>
<feGaussianBlur stdDeviation="2"/>
<feComposite in2="hardAlpha" operator="out"/>
<feColorMatrix type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.25 0"/>
<feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow_7_17"/>
<feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha"/>
<feOffset dy="4"/>
<feGaussianBlur stdDeviation="2"/>
<feComposite in2="hardAlpha" operator="out"/>
<feColorMatrix type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.25 0"/>
<feBlend mode="normal" in2="effect1_dropShadow_7_17" result="effect2_dropShadow_7_17"/>
<feBlend mode="normal" in="SourceGraphic" in2="effect2_dropShadow_7_17" result="shape"/>
</filter>
</defs>
</svg>

================
File: app/assets/images/comment.svg
================
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><clipPath id="a"><path d="m.2.5h24v24h-24z"/></clipPath><g clip-path="url(#a)"><path d="m1.2 7c0-2.8 2.3-5 5-5h12c2.8 0 5 2.2 5 5v6c0 2.8-2.2 5-5 5h-5.6l-4.7 4.7c-.4.4-1 .4-1.4 0-.2-.2-.3-.4-.3-.7v-4c-2.8 0-5-2.2-5-5zm5-.8c-.4 0-.8.3-.8.8s.3.8.8.8h12c.4 0 .8-.3.8-.8s-.3-.8-.8-.8zm0 3c-.4 0-.8.3-.8.8s.3.8.8.8h12c.4 0 .8-.3.8-.8s-.3-.8-.8-.8zm-.7 3.8c0-.4.3-.8.8-.8h8c.4 0 .8.3.8.8s-.3.8-.8.8h-8.1c-.4 0-.8-.3-.8-.8z" fill-rule="evenodd"/></g></svg>

================
File: app/assets/images/copy-paste.svg
================
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m13.4 4.727a.251.251 0 0 0 .2.265 1.089 1.089 0 0 1 .824 1.108v1.4a1.244 1.244 0 0 0 1.244 1.244 1.244 1.244 0 0 0 1.245-1.244v-3.525a1.494 1.494 0 0 0 -1.5-1.494h-1.724a.246.246 0 0 0 -.177.074.249.249 0 0 0 -.073.177c.002.473.001 1.492-.039 1.995z"/><path d="m8.954 21.262a1.244 1.244 0 0 0 -1.244-1.244h-4.226a1.073 1.073 0 0 1 -1-1.136v-12.782a1.086 1.086 0 0 1 .842-1.115.25.25 0 0 0 .2-.258c-.039-.766-.051-1.6-.055-2a.25.25 0 0 0 -.25-.247h-1.721a1.494 1.494 0 0 0 -1.5 1.495v17.037a1.493 1.493 0 0 0 1.494 1.493h6.216a1.244 1.244 0 0 0 1.244-1.243z"/><path d="m11.937 4.472v-1.988a.5.5 0 0 0 -.5-.5h-.758a.251.251 0 0 1 -.249-.222 1.989 1.989 0 0 0 -3.953 0 .249.249 0 0 1 -.249.222h-.755a.5.5 0 0 0 -.5.5v1.988a.5.5 0 0 0 .5.5h5.967a.5.5 0 0 0 .497-.5z"/><path d="m19.02 17.269h-3.979a.75.75 0 1 0 0 1.5h3.979a.75.75 0 1 0 0-1.5z"/><path d="m14.291 14.54a.75.75 0 0 0 .75.749h2.486a.75.75 0 1 0 0-1.5h-2.486a.75.75 0 0 0 -.75.751z"/><path d="m23.5 13.46a1.991 1.991 0 0 0 -.584-1.409l-1.406-1.4a1.994 1.994 0 0 0 -1.41-.584h-7.606a1.993 1.993 0 0 0 -1.994 1.988v9.945a2 2 0 0 0 2 2h9a2 2 0 0 0 2-2zm-11-.4a1 1 0 0 1 1-1h6.187a1 1 0 0 1 .707.292l.818.816a1 1 0 0 1 .293.708v7.124a1 1 0 0 1 -1 1h-7a1 1 0 0 1 -1-1z"/></svg>

================
File: app/assets/images/crown.svg
================
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m24 6.25a3 3 0 1 0 -4.258 2.714c-.47 1.376-1.536 3.786-3.242 3.786-2.3 0-2.967-3.142-3.53-6.175a3 3 0 1 0 -1.94 0c-.56 3.1-1.239 6.175-3.53 6.175-1.706 0-2.772-2.41-3.242-3.786a3.008 3.008 0 1 0 -2.129.141l1.635 9.809a1 1 0 0 0 .986.836h14.5a1 1 0 0 0 .986-.836l1.635-9.809a2.992 2.992 0 0 0 2.129-2.855z"/><path d="m19.25 21.25h-14.5a1 1 0 0 0 0 2h14.5a1 1 0 0 0 0-2z"/></svg>

================
File: app/assets/images/email.svg
================
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m23.888 5.832a.182.182 0 0 0 -.2.039l-9.747 9.745a2.75 2.75 0 0 1 -3.888 0l-9.743-9.745a.18.18 0 0 0 -.2-.039.182.182 0 0 0 -.11.168v12a2 2 0 0 0 2 2h20a2 2 0 0 0 2-2v-12a.181.181 0 0 0 -.112-.168z"/><path d="m11.115 14.556a1.252 1.252 0 0 0 1.768 0l9.686-9.686a.5.5 0 0 0 .121-.511c-.11-.329-.416-.359-.69-.359h-20c-.275 0-.583.03-.691.359a.5.5 0 0 0 .121.511z"/></svg>

================
File: app/assets/images/everyone.svg
================
<svg enable-background="new 0 0 24 24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m5.1.6c1.4 0 2.6 1.2 2.6 2.6s-1.1 2.5-2.6 2.5-2.5-1.1-2.5-2.5 1.1-2.6 2.5-2.6m0 6c2.8 0 5.1 1.2 5.1 2.6v1.1h-10.2v-1.1c0-1.5 2.3-2.6 5.1-2.6z"/><path d="m18.9.6c1.4 0 2.6 1.2 2.6 2.6s-1.2 2.6-2.6 2.6-2.6-1.2-2.6-2.6 1.1-2.6 2.6-2.6m0 6c2.8 0 5.1 1.2 5.1 2.6v1.1h-10.3v-1.1c0-1.5 2.3-2.6 5.2-2.6z"/><path d="m5.1 14.3c1.4 0 2.6 1.2 2.6 2.6s-1.2 2.6-2.6 2.6-2.6-1.2-2.6-2.6 1.2-2.6 2.6-2.6m0 6c2.8 0 5.1 1.2 5.1 2.6v1.1h-10.2v-1.1c0-1.5 2.3-2.6 5.1-2.6z"/><path d="m18.9 14.3c1.4 0 2.6 1.2 2.6 2.6s-1.2 2.6-2.6 2.6-2.6-1.2-2.6-2.6 1.1-2.6 2.6-2.6m0 6c2.8 0 5.1 1.2 5.1 2.6v1.1h-10.3v-1.1c0-1.5 2.3-2.6 5.2-2.6z"/></svg>

================
File: app/assets/images/expand.svg
================
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10,21V19H6.41L10.91,14.5L9.5,13.09L5,17.59V14H3V21H10M14.5,10.91L19,6.41V10H21V3H14V5H17.59L13.09,9.5L14.5,10.91Z" /></svg>

================
File: app/assets/images/filter.svg
================
<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><path d="m16 10h-.00000009c1.10457-.00000005 2 .89543 2 2v24.3674l.00000002.00000001c3.11083 1.08563 4.75257 4.48754 3.66694 7.59836-.599357 1.71743-1.94951 3.06758-3.66694 3.66694v4.3673c0 1.10457-.895431 2-2 2-1.10457 0-2-.895431-2-2v-4.3673l.00000016.00000005c-3.11083-1.08563-4.75257-4.48754-3.66694-7.59836.599357-1.71743 1.94951-3.06758 3.66694-3.66694v-24.3674.0000003c-.00000017-1.10457.89543-2 2-2h.00000018zm16 0h-.00000009c1.10457-.00000005 2 .89543 2 2v4.3673l.00000002.00000001c3.11083 1.08563 4.75257 4.48754 3.66694 7.59836-.599357 1.71743-1.94951 3.06758-3.66694 3.66694v24.3674c0 1.10457-.895431 2-2 2-1.10457 0-2-.895431-2-2v-24.3673l.00000016.00000005c-3.11083-1.08563-4.75257-4.48754-3.66694-7.59836.599357-1.71743 1.94951-3.06758 3.66694-3.66694v-4.3674.0000003c-.00000017-1.10457.89543-2 2-2h.00000018zm16 0h-.00000009c1.10457-.00000005 2 .89543 2 2v14.3674l.00000002.00000001c3.11083 1.08563 4.75257 4.48754 3.66694 7.59836-.599357 1.71743-1.94951 3.06758-3.66694 3.66694v14.3673c0 1.10457-.895431 2-2 2-1.10457 0-2-.895431-2-2v-14.3673l.00000016.00000005c-3.11083-1.08563-4.75257-4.48754-3.66694-7.59836.599357-1.71743 1.94951-3.06758 3.66694-3.66694v-14.3674.0000003c-.00000017-1.10457.89543-2 2-2h.00000018z" fill-rule="evenodd"/></svg>

================
File: app/assets/images/fizzy.svg
================
<svg height="30" viewBox="0 0 30 30" width="30" xmlns="http://www.w3.org/2000/svg"><path d="m3 1c1.10457 0 2 .89543 2 2v17c0 .9763-.69986 1.7872-1.625 1.9629v6.6621c0 .2071-.16789.375-.375.375s-.375-.1679-.375-.375v-6.6621c-.92514-.1757-1.625-.9866-1.625-1.9629v-17c0-1.10457.89543-2 2-2zm6 0c1.1046 0 2 .89543 2 2v24c0 1.1046-.8954 2-2 2-1.10457 0-2-.8954-2-2v-24c0-1.10457.89543-2 2-2zm6 0c1.1046 0 2 .89543 2 2v20.5c0 .9763-.6999 1.7872-1.625 1.9629v3.1621c0 .2071-.1679.375-.375.375s-.375-.1679-.375-.375v-3.1621c-.9251-.1757-1.625-.9866-1.625-1.9629v-20.5c0-1.10457.8954-2 2-2zm6 0c1.1046 0 2 .89543 2 2v13.5c0 .9763-.6999 1.7872-1.625 1.9629v10.1621c0 .2071-.1679.375-.375.375s-.375-.1679-.375-.375v-10.1621c-.9251-.1757-1.625-.9866-1.625-1.9629v-13.5c0-1.10457.8954-2 2-2zm6 0c1.1046 0 2 .89543 2 2v17c0 .9763-.6999 1.7872-1.625 1.9629v6.6621c0 .2071-.1679.375-.375.375s-.375-.1679-.375-.375v-6.6621c-.9251-.1757-1.625-.9866-1.625-1.9629v-17c0-1.10457.8954-2 2-2z" fill="currentColor"/></svg>

================
File: app/assets/images/funnel.svg
================
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M23 0L1.00002 0C0.194222 0 -0.283458 0.955359 0.200023 1.6L9.00002 13.423V22C9.01178 23.585 10.9006 24.5769 12.2 23.6L14.2 22.1C14.696 21.7267 14.9989 21.1208 15 20.5V13.423L23.8 1.6C24.2835 0.955343 23.8058 2.70383e-05 23 0Z" fill="black"/></svg>

================
File: app/assets/images/gear.svg
================
<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><path d="m57.2844 34.2283-3.9883 1.1395.00000003-.00000001c-.360653.105603-.63181.404255-.7022.7734l.00000025-.00000123c-.177144.880411-.411338 1.74838-.7011 2.5984l-.00000004.00000011c-.124404.355235-.0388029.750235.2215 1.0221l2.8877 2.9844-.00000002-.00000002c.310719.321195.370947.809422.1476 1.1965l-1.245 2.1564.00000001-.00000003c-.223405.387125-.676446.579157-1.11.4705l-4.05-1.014.00000009.00000002c-.364739-.0892593-.74875.0331841-.9945.3171l.00000011-.00000013c-.588383.669581-1.2184 1.3014-1.88629 1.89169l-.00000005.00000005c-.283821.245602-.406362.629363-.3174.994l1.01259 4.04671.00000003.00000014c.108676.433433-.0831197.886398-.47 1.11l-2.1569 1.245.00000006-.00000003c-.387013.223582-.875373.163379-1.1965-.1475l-2.9992-2.9018c-.271609-.260598-.666603-.346484-1.0219-.2222l-.00000086.00000029c-.844355.28927-1.70648.523822-2.581.7022h-.00000002c-.368526.0708855-.666568.341721-.7723.7018l-1.1433 4.0023c-.122881.42971-.515666.725951-.9626.726h-2.49c-.446946-.00001568-.839748-.29627-.9626-.726l-1.1427-4.0013.00000003.0000001c-.105597-.360733-.404287-.631968-.7735-.7024l-.00000204-.00000041c-.876453-.176166-1.74062-.408749-2.58709-.696297l-.00000006-.00000002c-.355023-.124054-.749632-.0382612-1.0211.222l-2.9929 2.8957.00000003-.00000003c-.321159.310895-.809556.371098-1.1966.1475l-2.1564-1.2449.00000002.00000001c-.386827-.223649-.578606-.676573-.47-1.11l1.0147-4.0524.00000001-.00000005c.089308-.365259-.033593-.749759-.3182-.9955l.00000044.00000038c-.670548-.587369-1.30328-1.21656-1.8944-1.8838l.00000001.00000001c-.245655-.283127-.628953-.405207-.9931-.3163l-4.0444 1.0125.00000009-.00000002c-.433546.10855-.886524-.083455-1.11-.4705l-1.24581-2.1565-.00000001-.00000002c-.223442-.387042-.16325-.875311.1475-1.1965l2.8936-2.99.00000004-.00000004c.260682-.271984.346382-.667393.2217-1.0229l-.00000039-.00000114c-.291297-.847972-.52739-1.71391-.706798-2.59239v.00000001c-.0706561-.368607-.341534-.666738-.7017-.7723l-3.9891-1.14h-.00000001c-.429791-.122743-.726066-.515626-.7259-.9626v-2.49l-.00000001-.00002494c-.00015438-.446974.29613-.83985.725924-.962582l3.9883-1.14-.00000002.00000001c.360615-.105663.6317-.404358.702-.7735l-.00000006.0000003c.177365-.880379.411623-1.74833.7013-2.5984l.00000001-.00000002c.124479-.355233.0387827-.750276-.2217-1.022l-2.88763-2.9838.00000004.00000004c-.31075-.321188-.370942-.809458-.1475-1.1965l1.2449-2.1565-.00000002.00000004c.223626-.386854.67657-.578641 1.11-.47l4.0507 1.0141h.00000002c.364775.0891641.748769-.033351.9945-.3173l.00000111-.00000126c.58829-.669605 1.21824-1.30143 1.8861-1.8917l.00000002-.00000002c.283906-.245501.406435-.629306.3173-.9939l-1.0132-4.0467v.00000001c-.108712-.433435.0830929-.886421.47-1.11l2.1564-1.245-.00000017.0000001c.387051-.223485.875355-.163334 1.1966.1474l2.9993 2.902-.00000009-.00000008c.27176.260478.666772.346275 1.0221.222l.00000163-.00000056c.844263-.289127 1.70624-.523677 2.5806-.7022l.00000011-.00000002c.368622-.0706944.666749-.341608.7723-.7018l1.1435-4.0023.00000002-.00000006c.122881-.42971.515666-.725951.9626-.726h2.49-.00000002c.446923.00008299.839689.29631.9626.726l1.1432 4.0014v.00000001c.105576.360746.404276.631989.7735.7024l.00000093.00000019c.876467.176152 1.74063.408769 2.58709.696397l.00000009.00000003c.355053.123837.749563.0380269 1.0211-.2221l2.9928-2.8956-.00000006.00000006c.321119-.310879.809458-.371121 1.1965-.1476l2.1564 1.245.00000006.00000004c.386934.223555.578747.676562.47 1.11l-1.0145 4.0524.00000003-.00000012c-.0893391.36523.03357.749717.3182.9954l-.00000044-.00000039c.670492.587396 1.30319 1.21658 1.8943 1.8838l.00000005.00000006c.245558.283209.628879.405308.993.3163l4.0446-1.0124h.00000002c.433438-.108747.886445.0830663 1.11.47l1.2448 2.1565.00000002.00000003c.223538.387006.163382.875318-.1474 1.1965l-2.8935 2.9905.00000001-.00000001c-.260643.271964-.346341.667323-.2217 1.0228l.0000004.00000116c.291265.848011.527325 1.71399.7067 2.5925l-.00000004-.00000023c.0706729.368543.3415.666623.7016.7722l3.9893 1.14h.00000001c.42979.122764.726085.515621.726.9626v2.49-.00004575c0 .446542-.295802.839069-.72505.962137zm-34.642-14.4332.00000001.00000002c-.139243-.242359-.448593-.325951-.690952-.186708-.0217675.0125061-.0425744.0266145-.0622482.0422084l-.00000071.00000058c-6.83176 5.56387-7.8596 15.6125-2.29573 22.4443.685183.841323 1.45441 1.61055 2.29573 2.29573l-.00000003-.00000003c.219114.173628.537494.136754.711121-.0823603.0155403-.0196115.029605-.0403482.0420786-.0620397l5.76-9.9758-.00000003.00000006c.803848-1.3923.803848-3.1077.00000007-4.5zm9.3676-3.7751h-.00000004c-1.93584-.00208884-3.8559.348046-5.6664 1.0333l.00000002-.00000001c-.258314.102358-.384741.39474-.282384.653053.00930422.0234805.0203634.046227.0330837.0680467l5.7712 9.9961.0000001.00000018c.803845 1.3923 2.28941 2.24999 3.8971 2.25h11.5258.00000002c.279566.00017045.506338-.226325.506509-.505891.00001512-.0248021-.0017926-.0495717-.00540855-.0741087l.00000006.00000035c-1.26087-7.73562-7.94179-13.4178-15.7795-13.4205zm15.2779 18h-11.5248.00000017c-1.60769.00000505-3.09326.857699-3.8971 2.25l-5.7712 9.996-.00000002.00000004c-.139939.240042-.0587888.548078.181253.688016.0218196.0127203.0445662.0237795.0680467.0330837l.0000009.00000034c8.2646 3.12404 17.4969-1.04322 20.621-9.30782.376648-.996419.652834-2.02797.824446-3.07928v-.00000002c.040261-.276708-.151417-.533662-.428125-.573923-.0241659-.00351614-.0485545-.00527928-.0729748-.00527562z" fill-rule="evenodd"/></svg>

================
File: app/assets/images/globe.svg
================
<svg enable-background="new 0 0 24 24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><circle cx="12.2" cy="12.1" fill="#4183bf" r="9.3"/><path d="m17.9 17.4c-.3-.8-1-1.4-1.9-1.4h-1v-3c0-.6-.4-1-1-1h-6v-2h2c.6 0 1-.4 1-1v-2h2c1.1 0 2-.9 2-2v-.4c2.9 1.2 5 4.1 5 7.4 0 2.1-.8 4-2.1 5.4m-6.9 2.5c-3.9-.5-7-3.9-7-7.9 0-.6.1-1.2.2-1.8l4.8 4.8v1c0 1.1.9 2 2 2m1-16c-5.5 0-10 4.5-10 10s4.5 10 10 10 10-4.5 10-10-4.5-10-10-10z" fill="#40c149"/></svg>

================
File: app/assets/images/golden-ticket.svg
================
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m15.58 16.8-3.58-2.3-3.58 2.3 1.08-4.12-3.29-2.68 4.25-.26 1.54-3.94 1.54 3.94 4.25.26-3.29 2.68m5.5-.68c0-1.11.9-2 2-2v-4c0-1.11-.9-2-2-2h-16a2 2 0 0 0 -2 2v4c1.11 0 2 .9 2 2a2 2 0 0 1 -2 2v4a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-4a2 2 0 0 1 -2-2z"/></svg>

================
File: app/assets/images/grid.svg
================
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><g clip-rule="evenodd" fill-rule="evenodd"><path d="m8 13c1.65685 0 3 1.3431 3 3v3c0 1.6569-1.34315 3-3 3h-4c-1.60511 0-2.91579-1.2606-2.99609-2.8457l-.00391-.1543v-3c0-1.6569 1.34315-3 3-3zm-4 2c-.55228 0-1 .4477-1 1v3l.00488.1025c.05133.5042.47744.8975.99512.8975h4c.55228 0 1-.4477 1-1v-3c0-.5523-.44772-1-1-1z"/><path d="m20 13c1.6569 0 3 1.3431 3 3v3c0 1.6569-1.3431 3-3 3h-4c-1.6051 0-2.9158-1.2606-2.9961-2.8457l-.0039-.1543v-3c0-1.6569 1.3431-3 3-3zm-4 2c-.5523 0-1 .4477-1 1v3l.0049.1025c.0513.5042.4774.8975.9951.8975h4c.5523 0 1-.4477 1-1v-3c0-.5523-.4477-1-1-1z"/><path d="m8 2c1.65685 0 3 1.34315 3 3v3c0 1.65685-1.34315 3-3 3h-4c-1.60511 0-2.91579-1.26055-2.99609-2.8457l-.00391-.1543v-3c0-1.65685 1.34315-3 3-3zm-4 2c-.55228 0-1 .44772-1 1v3l.00488.10254c.05133.50413.47744.89746.99512.89746h4c.55228 0 1-.44772 1-1v-3c0-.55228-.44772-1-1-1z"/><path d="m20 2c1.6569 0 3 1.34315 3 3v3c0 1.65685-1.3431 3-3 3h-4c-1.6051 0-2.9158-1.26055-2.9961-2.8457l-.0039-.1543v-3c0-1.65685 1.3431-3 3-3zm-4 2c-.5523 0-1 .44772-1 1v3l.0049.10254c.0513.50413.4774.89746.9951.89746h4c.5523 0 1-.44772 1-1v-3c0-.55228-.4477-1-1-1z"/></g></svg>

================
File: app/assets/images/history.svg
================
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13.5,8H12V13L16.28,15.54L17,14.33L13.5,12.25V8M13,3A9,9 0 0,0 4,12H1L4.96,16.03L9,12H6A7,7 0 0,1 13,5A7,7 0 0,1 20,12A7,7 0 0,1 13,19C11.07,19 9.32,18.21 8.06,16.94L6.64,18.36C8.27,20 10.5,21 13,21A9,9 0 0,0 22,12A9,9 0 0,0 13,3" /></svg>

================
File: app/assets/images/home.svg
================
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m12 3 8 6v12h-5v-7h-6v7h-5v-12z"/></svg>

================
File: app/assets/images/install-edge.svg
================
<svg enable-background="new 0 0 22 22" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg"><path d="m20.3 4.7h-2.8c-.1 0-.3-.1-.3-.3v-2.7c0-.4-.4-.8-.8-.8s-.8.4-.8.8v2.8c0 .1-.1.3-.3.3h-2.8c-.4 0-.8.4-.8.8s.4.8.8.8h2.8c.1 0 .3.1.3.3v2.8c0 .4.4.8.8.8s.8-.4.8-.8v-3c0-.1.1-.3.3-.3h2.8c.4 0 .8-.4.8-.8 0-.3-.3-.7-.8-.7z"/><path d="m8.2 1.6c.4 0 .8.3.8.8v5.8c0 .4-.3.8-.8.8h-5.9c-.4 0-.8-.3-.8-.8v-5.9c0-.4.3-.8.8-.8h5.9m0-1.5h-5.9c-1.2 0-2.3 1.1-2.3 2.3v5.8c0 1.3 1.1 2.3 2.3 2.3h5.8c1.3 0 2.3-1.1 2.3-2.3v-5.8c.1-1.2-1-2.3-2.2-2.3z"/><path d="m8.2 13.1c.4 0 .8.3.8.8v5.8c0 .4-.3.8-.8.8h-5.9c-.4 0-.8-.3-.8-.8v-5.8c0-.4.3-.8.8-.8zm0-1.6h-5.9c-1.3 0-2.3 1.1-2.3 2.3v5.8c0 1.3 1.1 2.4 2.3 2.4h5.8c1.3 0 2.3-1.1 2.3-2.3v-5.8c.1-1.3-1-2.4-2.2-2.4z"/><path d="m19.7 13.1c.4 0 .8.3.8.8v5.8c0 .4-.3.8-.8.8h-5.8c-.4 0-.8-.3-.8-.8v-5.8c0-.4.3-.8.8-.8zm0-1.6h-5.8c-1.3 0-2.3 1.1-2.3 2.3v5.8c0 1.3 1.1 2.3 2.3 2.3h5.8c1.3 0 2.3-1.1 2.3-2.3v-5.8c0-1.2-1.1-2.3-2.3-2.3z"/></svg>

================
File: app/assets/images/jf-signature.svg
================
<svg xmlns="http://www.w3.org/2000/svg" width="240" height="87" fill="none" viewBox="0 0 240 87"><path fill="#17233C" fill-rule="evenodd" d="m6.02597 85.9725c.33135-.026.66239-.052.96868-.0067.27989-.0195.58491-.009.89411.0017.53861.0187 1.08995.0377 1.54339-.1009.43166-.4994.98485-.4968 1.53835-.4942.0991.0005.1983.0009.2967-.0015.7705.0324 1.4991-.1814 2.2297-.3959.7456-.2188 1.4931-.4383 2.2894-.3972 9.2331-2.3576 18.1222-6.0001 26.882-9.8925 14.2453-6.5295 27.9537-14.2051 40.1511-24.0956 12.8098-9.6426 24.1426-21.2205 33.1526-34.4521.193-.263.39-.5264.588-.7912l.001-.0008c.999-1.3378 2.024-2.7093 2.713-4.2286.282-.2664.409-.6203.537-.9743.14-.38643.279-.773.619-1.04619.115-.50354.373-.9587.631-1.41366.223-.39424.447-.78833.577-1.21362.288-.20227.332-.51548.376-.82709.035-.25043.07-.49983.231-.68979.421-.39567.502-.91604.584-1.4438l.012-.07507c.007-.04163.011-.08686.016-.13294.016-.14707.032-.30267.115-.37665.445-.39475.55-.91607.653-1.4349v-.00006l.001-.00006c.043-.21866.087-.43688.156-.644991.499-1.037032-1.372-1.12626-1.43-.198285.013.456616-.218.781366-.451 1.108706v.00008c-.118.16589-.237.33244-.324.51715-.025.60018-.354 1.04926-.682 1.49751v.00006c-.171.23295-.341.46567-.469.71926-1.634 3.34593-3.802 6.32124-5.98 9.30964v.0002c-.478.6562-.956 1.3131-1.43 1.9746-18.2636 22.4003-43.068 38.7727-69.4589 50.0571-1.6999.7101-3.3829 1.4309-5.0627 2.1505l-.0015.0006-.0025.0011-.0008.0003c-1.912.819-3.8199 1.6362-5.7442 2.4338-.6432.1763-1.2642.4396-1.8874.7038h-.0001v.0001c-.6943.2943-1.3912.5898-2.1246.7674-.2796.1126-.5551.2424-.8317.3727l-.0001.0001h-.0002c-.693.3266-1.3929.6563-2.1801.7257-.1458.0444-.2807.1366-.4177.2302-.1994.1362-.4033.2755-.6519.2755-.7708.1368-1.4919.4613-2.2089.7839l-.0001.0001c-.7791.3506-1.5534.699-2.3817.8022-3.022 1.0906-6.1355 2.4132-9.1595 3.7318-.554.3786-1.222.5721-1.88517.7641-.44112.1278-.88011.2549-1.28198.4355-.34282.3085-.76505.3958-1.19022.4837-.35648.0737-.71502.1478-1.03056.3531-.66038.3513-1.4257.3725-2.18694.3935-.992.0275-1.97706.0547-2.713895.812-1.4116 1.3464-.113326 2.2962 1.173015 2.8236.37683.4302.88292.4469 1.3786.4633.39089.0129.77531.0255 1.08474.2406.46839.4961 1.12328.4447 1.77698.3934zm233.64403-39.9001c.098-.0513.206-.079.316-.0809l.014-3.1131c-.1.0146-.202-.0017-.292-.0467-.091-.045-.165-.1166-.213-.2051-1.529-2.2248-4.666-2.6868-7.221-2.776-1.752.0457-3.506-.0037-5.262-.0531-1.9-.0535-3.802-.1071-5.701-.0401-5.938.0688-11.874.069-17.809.0691-6.373.0002-12.746.0004-19.121.0855-.461.0138-.923.0239-1.384.0341-1.874.0412-3.753.0825-5.614.3625-.203.0297-.428.0615-.495-.1983.019-.4278.467-.6415.893-.8453.216-.1032.427-.2039.574-.3285 10.78-6.1092 21.81-11.911 33.226-16.7551 4.984-2.0434 10.075-3.6986 15.179-5.358v-.0001c2.29-.7446 4.583-1.4901 6.87-2.272 1.964-.8175 4.019-1.5176 6.031-2.203l.331-.1129v-2.7522c-.425-.04292-.826-.17381-1.226-.30427-.562-.18292-1.12-.36499-1.736-.30248-7.953.22406-15.707 2.51225-23.063 5.21685-15.19 6.0993-29.467 14.3479-42.861 23.6594-.427.3304-.873.6403-1.319.9506-.681.4737-1.364.9483-1.985 1.4982-.114.1209-.251.2181-.403.2861-.152.0681-.316.1056-.482.1105-6.018.0278-12.032.2736-18.043.5651-5.107.2772-10.22.2775-15.334.2778-3.85.0002-7.701.0005-11.55.1188-1.034.0178-2.248.3232-2.733 1.3642-.539 1.4058.783 2.6947 1.898 2.6947 4.832-.0592 9.653.176 14.474.4112 4.862.2372 9.725.4745 14.601.4097.997.0288 1.995.0332 2.992.0376 2.022.0088 4.044.0177 6.06.2301.052.0056.106.0082.16.0108.236.0112.482.0229.57.2787.071.2035-.089.3374-.24.4643-.043.0364-.086.0721-.122.1087-.319.3215-.643.6396-.967.9578v.0003.0002c-.601.5903-1.202 1.1808-1.776 1.7939-6.704 6.9519-11.924 15.1883-15.343 24.2107-.075.2108-.118.4325-.161.655-.085.4411-.171.8854-.513 1.2544-.126.3621-.161.7561-.197 1.1534-.055.6168-.111 1.2416-.509 1.7674-.261.736-.26 1.5133-.259 2.2933.001.9349.002 1.8735-.449 2.7491-.523 1.3404 1.815 1.1639 1.702-.0258.053-.2874.048-.5937.043-.9006-.008-.5295-.016-1.0605.269-1.4986.418-.4918.465-1.0688.487-1.6815.057-.6188.303-1.1988.549-1.7776.222-.5228.444-1.0446.525-1.5933.295-.4675.505-.9902.713-1.5073v-.0001-.0002c.15-.3754.3-.7478.48-1.0939.118-.5857.445-1.1023.772-1.62.282-.4461.565-.8931.715-1.386 3.726-7.854 9.627-14.3975 16.076-20.1477.537-.4782 1.006-.917 1.431-1.3155 2.416-2.2651 3.44-3.2252 7.836-2.684 13.768.357 27.536.7694 41.296 1.3206 6.738.2439 13.482.2994 20.226.2439l.154-.0168c2.319-.2538 5.12-.5603 6.675-2.434.064-.0897.148-.1631.245-.2145zm-138.871 14.3205c-.018-.1645-.026-.4504-.035-.8049-.046-1.717-.135-5.0441-1.6296-3.9956-.2812.2168-.5661.4296-.8512.6424-.6562.4899-1.3124.9799-1.9223 1.519-1.3725 1.0673-2.7989 2.0304-4.234 2.9994h-.0001c-.6977.4712-1.3976.9437-2.0942 1.4302-.1054.0643-.2147.1334-.3269.2044-1.0349.6548-2.3238 1.4703-3.226.0911-.0924-.1688-.2014-.3312-.3106-.4938-.3115-.4636-.6244-.9296-.5582-1.5565.0018-.0356-.0034-.0712-.0154-.1047-.012-.0336-.0305-.0644-.0546-.0908-.024-.0264-.053-.0477-.0854-.0628s-.0674-.0237-.1031-.0252c-.1006-.0107-.2022.0084-.292.0549-.0899.0466-.1639.1185-.213.2068-.3505.5037-.7933.9198-1.2359 1.3358-.4287.4029-.8572.8056-1.2016 1.2875-.6346.8883-1.5095 1.4602-2.3846 2.0322-.0369.0241-.0737.0482-.1105.0723-.0531.0347-.1061.0695-.1591.1044-1.2984 1.2254-2.8986 2.0866-4.6384 2.4964-1.3917.2816-2.7834-1.1996-2.5846-2.6034.7881-1.4187 2.0395-2.5552 3.2831-3.6847.6388-.5802 1.2756-1.1585 1.8464-1.7722.4628-.4737 1.0141-.8212 1.5633-1.1673.699-.4405 1.3946-.879 1.9001-1.573.5617-.2222 1.0953-.5003 1.6222-.775 1.4762-.7695 2.8997-1.5116 4.7399-.9183.1427.0207.2721.0951.3616.2079.0894.1129.1322.2555.1195.3988-.0731.5539-.7622.5451-1.3804.5373-.4574-.0058-.876-.0111-.9775.2123.0084.1687.1465.1565.272.1455.022-.002.0436-.0039.064-.0048.2812-.017.563.0236.8279.1194.265.0957.5074.2447.7123.4375.205.1929.3681.4257.4793.6839.1113.2582.1682.5364.1675.8174.0296.1616.0148.3494-.0002.5397-.0284.3585-.0574.7259.2089.9435.9452-.3501 1.7651-1.0433 2.5866-1.7378.6161-.5209 1.2332-1.0427 1.9047-1.4209.5343-.3121.9775-.7249 1.4177-1.1349.5524-.5145 1.1001-1.0245 1.817-1.3258.5686-.2529 1.0351-.6382 1.4986-1.0211.5431-.4486 1.0819-.8937 1.7759-1.1184 4.0039-.7362 4.0799 4.8786 4.1279 8.4169v.0002c.009.6453.016 1.2216.047 1.6776v.0937.0004c-.003.4145-.006.8547.454 1.05 1.229.1676 2.032-1.0177 2.777-2.1162.339-.5008.666-.9836 1.016-1.3121.489-.5907.967-1.1945 1.446-1.7994v-.0002c1.72-2.1704 3.449-4.354 5.712-5.993 1.463-.936 2.857.688 3.286 2.0304.571 2.5499 2.831 4.1838 5.332 4.5923.813.5422 1.721.5884 2.629.6345.403.0206.807.0411 1.202.1051.202.045.403.0918.603.1385.985.2292 1.961.4563 2.992.4563 2.974.0883 5.948.0939 8.921.0994.767.0015 1.535.0029 2.302.0057 1.165 0 1.953.5513 2.203 1.4753.32 2.4019-2.472 2.2236-4.531 2.0921-.502-.0321-.961-.0614-1.32-.0498-.972-.0449-1.946-.0617-2.919-.0784-1.645-.0283-3.29-.0566-4.928-.221-.64-.0503-1.269-.1885-1.871-.4105-.519-.1733-1.064-.1806-1.607-.1879-.797-.0107-1.588-.0214-2.274-.5596-.318-.1711-.691-.1993-1.066-.2278-.494-.0374-.992-.0751-1.372-.4404-.081-.0891-.189-.149-.308-.1705-.616-.0173-1.137-.2891-1.656-.5603-.255-.1336-.511-.2669-.777-.3697-1.146-.7535-2.13-1.7276-2.893-2.8652-.202-.1671-.346-.5467-.491-.927-.273-.7162-.547-1.4348-1.203-.7406-1.35 1.3533-2.577 2.8118-3.804 4.2699-1.485 1.7638-2.969 3.527-4.668 5.1031-1.538 1.5129-4.646 1.0866-5.553-.9102-.393-.9593-.371-2.0621-.351-3.1407v-.0004c.009-.4373.017-.8705-.002-1.2886zm95.9-.0728c.922.015 1.805.0294 2.408.1819 3.525-.0397 16.438-1.739 14.85-6.9222-.414-1.8916-3.537-2.2882-3.181.1527.101.8586-.143 1.1759-.968 1.4535-.522.1731-1.035.3845-1.55.5963-1.013.4165-2.03.8347-3.115.9661-3.642 1.0609-8.529 1.5784-12.165.0694-.285-.0999-.586-.1296-.884-.1591-.548-.0542-1.086-.1075-1.502-.5943-.923-.2043-1.748-.7079-2.513-1.2373-.383-.3293-.705-.6274-.983-.8858-1.54-1.4287-1.775-1.6473-3.954.7589-.138.0818-.369.34-.629.6298-.522.5814-1.158 1.2899-1.375.9564-.357-.5254-.628-1.1499-.902-1.7789-.586-1.3507-1.182-2.7223-2.653-3.1782-2.356-1.2849-4.777.8288-6.493 2.3418-1.01.5971-1.878 1.3811-2.743 2.1629-.652.5889-1.303 1.1766-2.011 1.6818-.554.2202-.987.59-1.421.9608-.09.0767-.18.1534-.271.2289-1.355 1.34-2.8 2.578-4.244 3.8161-1.502 1.2865-3.003 2.5731-4.404 3.9746-.426.3959-.829.8142-1.231 1.2326-.452.4701-.904.9402-1.39 1.3788-.097.0876-.201.1719-.307.2572-.385.3125-.785.637-.913 1.1744-.358.9656.859.9736 1.318.4283 1-.8738 2.042-1.6875 3.085-2.5012 1.117-.8721 2.234-1.7441 3.299-2.6899.776-.3364 1.365-.8895 1.957-1.4444.541-.508 1.084-1.0174 1.773-1.3633 1.167-.7232 2.291-1.6879 3.414-2.652 1.001-.8598 2.002-1.7192 3.033-2.4063.642-.3533 1.368-.9474 2.122-1.5643 2.332-1.9072 4.929-4.0323 6.131.0653.203 1.0667.865 1.8956 1.678 2.5559.597.7624 1.235.3658 1.86-.0234.147-.0915.294-.1827.439-.2582.446-.1082.852-.3398 1.173-.6682.066-.0626.133-.1249.2-.1871.528-.4933 1.052-.9825 1.438-1.6094.593-.6761 1.318.0036 2.07.7078.528.4956 1.07 1.0032 1.588 1.0589.231.079.446.2115.665.3461.329.2032.667.4113 1.081.4471.036.0283.072.0568.108.0852.393.3119.773.6134 1.319.5334.382-.0139.783-.0277 1.072.2756.675.5955 2.247.621 3.721.645z" clip-rule="evenodd"/></svg>

================
File: app/assets/images/lifebuoy.svg
================
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m19.79 15.41c.95-2.17.95-4.66 0-6.82l-2.74 1.24c.6 1.38.6 2.95.01 4.34zm-4.37-11.2c-2.17-.95-4.66-.95-6.83 0l1.24 2.73c1.39-.59 2.96-.59 4.35.01zm-11.21 4.37c-.95 2.18-.95 4.66 0 6.84l2.74-1.25c-.6-1.38-.6-2.96 0-4.35zm4.38 11.21c2.17.95 4.66.95 6.83-.01l-1.24-2.73c-1.38.6-2.96.6-4.34.01zm3.41-17.79a10 10 0 0 1 10 10 10 10 0 0 1 -10 10 10 10 0 0 1 -10-10 10 10 0 0 1 10-10m0 6a4 4 0 0 0 -4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0 -4-4z"/></svg>

================
File: app/assets/images/lock.svg
================
<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><path d="m49.5 26.2h1.5c3.3.1 6 3 5.8 6.3v25.2c.1 3.3-2.5 6.2-5.8 6.3h-37.9c-3.3-.1-6-3-5.8-6.3v-25.2c-.1-3.3 2.5-6.2 5.8-6.3h1.5v-10.2c0-5.9 1.2-9.3 4-12s6.1-4 11.9-4h2.9c5.9 0 9.3 1.2 12 4s4 6.2 4 12v10.2zm-5.8-10.2c0-3.7-.8-5.9-2.5-7.7s-3.9-2.5-7.6-2.5h-2.9c-3.7 0-5.9.8-7.6 2.5s-2.5 3.9-2.5 7.7v10.2h23.3v-10.2z" fill-rule="evenodd"/></svg>

================
File: app/assets/images/logout.svg
================
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m17.508 18.5a1 1 0 0 0 -1 1v.5a.5.5 0 0 1 -.5.5h-5.5a.5.5 0 0 1 -.5-.5v-16a.5.5 0 0 1 .5-.5h5.5a.5.5 0 0 1 .5.5v1a1 1 0 0 0 2 0v-2.5a1 1 0 0 0 -1-1h-7.5v-1a.5.5 0 0 0 -.608-.488l-9 2a.5.5 0 0 0 -.392.488v19a.5.5 0 0 0 .392.489l9 2a.506.506 0 0 0 .421-.1.5.5 0 0 0 .187-.39v-1h7.5a1 1 0 0 0 1-1v-2a1 1 0 0 0 -1-.999zm-10-6a1.5 1.5 0 1 1 -1.5-1.5 1.5 1.5 0 0 1 1.5 1.5z"/><path d="m23.546 11.668-4.875-3.25a1 1 0 0 0 -1.554.832v1.75h-4.125a1.5 1.5 0 0 0 0 3h4.125v1.75a1 1 0 0 0 1.554.832l4.875-3.25a1 1 0 0 0 0-1.664z"/></svg>

================
File: app/assets/images/marker.svg
================
<svg width="19" height="20" viewBox="0 0 19 20" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M10 9.55C9.43168 9.55 8.88663 9.31295 8.48477 8.89099C8.08291 8.46903 7.85714 7.89674 7.85714 7.3C7.85714 6.70326 8.08291 6.13097 8.48477 5.70901C8.88663 5.28705 9.43168 5.05 10 5.05C10.5683 5.05 11.1134 5.28705 11.5152 5.70901C11.9171 6.13097 12.1429 6.70326 12.1429 7.3C12.1429 7.59547 12.0874 7.88806 11.9797 8.16104C11.8721 8.43402 11.7142 8.68206 11.5152 8.89099C11.3162 9.09992 11.08 9.26566 10.82 9.37873C10.5601 9.4918 10.2814 9.55 10 9.55ZM10 1C8.4087 1 6.88258 1.66375 5.75736 2.84523C4.63214 4.02671 4 5.62914 4 7.3C4 12.025 10 19 10 19C10 19 16 12.025 16 7.3C16 5.62914 15.3679 4.02671 14.2426 2.84523C13.1174 1.66375 11.5913 1 10 1Z" fill="black"/>
</svg>

================
File: app/assets/images/maximize.svg
================
<svg fill="none" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><g fill="#000"><path d="m3 15c.55228 0 1 .4477 1 1v3c0 .5523.44772 1 1 1h3c.55228 0 1 .4477 1 1s-.44772 1-1 1h-3c-1.65685 0-3-1.3431-3-3v-3c0-.5523.44772-1 1-1z"/><path d="m21 15c.5523 0 1 .4477 1 1v3c0 1.6569-1.3431 3-3 3h-3c-.5523 0-1-.4477-1-1s.4477-1 1-1h3c.5523 0 1-.4477 1-1v-3c0-.5523.4477-1 1-1z"/><path d="m8 2c.55228 0 1 .44772 1 1s-.44772 1-1 1h-3c-.55228 0-1 .44772-1 1v3c0 .55228-.44772 1-1 1s-1-.44772-1-1v-3c0-1.65685 1.34315-3 3-3z"/><path d="m19 2c1.6569 0 3 1.34315 3 3v3c0 .55228-.4477 1-1 1s-1-.44772-1-1v-3c0-.55228-.4477-1-1-1h-3c-.5523 0-1-.44772-1-1s.4477-1 1-1z"/></g></svg>

================
File: app/assets/images/menu-dots-horizontal.svg
================
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><circle cx="3.25" cy="12" r="3.25"/><circle cx="12" cy="12" r="3.25"/><circle cx="20.75" cy="12" r="3.25"/></svg>

================
File: app/assets/images/menu-dots-vertical.svg
================
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="3.25" r="3.25"/><circle cx="12" cy="12" r="3.25"/><circle cx="12" cy="20.75" r="3.25"/></svg>

================
File: app/assets/images/minus.svg
================
<svg enable-background="new 0 0 24 24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m14.5 14.3h6.7c.6 0 1.1-.5 1.1-1.1v-2.3c0-.6-.5-1.1-1.1-1.1h-6.7-5-6.7c-.6 0-1.1.5-1.1 1.1v2.3c0 .6.5 1.1 1.1 1.1h6.7z"/></svg>

================
File: app/assets/images/monitor.svg
================
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 3H4c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h5v2H7v2h10v-2h-2v-2h5c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 12H4V5h16v10z"/></svg>

================
File: app/assets/images/moon.svg
================
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M21.64 13.24A9 9 0 1 1 10.76 2.36a9.07 9.07 0 0 0 10.88 10.88z"/></svg>

================
File: app/assets/images/move.svg
================
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m13.3 18.4c-.3.3-.9.2-1.2-.1-.1-.1-.2-.3-.2-.5v-3.3c-4.2 0-6.7 1.4-7.7 4.4 0 .3-.4.5-.7.5s-.7-.3-.7-.7c.2-6.1 3.2-9.6 9-9.9v-3.4c0-.5.4-.8.8-.8s.4 0 .5.2l7.4 6.1c.3.3.4.8.1 1.2h-.1c0 .1-7.2 6.3-7.2 6.3z"/></svg>

================
File: app/assets/images/password.svg
================
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m21.5 2.5h-19-.00000011c-1.38071.00000006-2.5 1.11929-2.5 2.5v14 .00000038c.00000021 1.38071 1.11929 2.5 2.5 2.5h19 .00000011c1.38071-.00000027 2.5-1.11929 2.5-2.5v-14c0-1.38071-1.11929-2.5-2.5-2.5zm-.5 12.25h-4-.00000003c-.414214-.00000002-.75-.335786-.75-.75.00000002-.414214.335786-.75.75-.75h4-.00000003c.414214-.00000002.75.335786.75.75.00000002.414214-.335786.75-.75.75zm-6.469-1.28c.292711.292294.293049.766535.00075431 1.05925-.00025126.00025162-.0005027.00050305-.00075431.00075431l-.00000003.00000002c-.29683.283557-.76417.283557-1.061-.00000005l-1.293-1.293-.00000001-.00000001c-.0975674-.0972627-.255433-.0972627-.353.00000002l-1.293 1.293.00000001-.00000001c-.294501.28931-.766499.28931-1.061.00000002l.00000002.00000002c-.292711-.292294-.293049-.766535-.00075434-1.05925.00025126-.00025162.0005027-.00050305.00075431-.00075431l1.293-1.293.00000001-.00000001c.0977544-.0975076.0979545-.255799.00044687-.353553-.00014878-.00014915-.00029774-.00029812-.00044689-.00044689l-1.293-1.293-.00000005-.00000006c-.28762-.298073-.279147-.772871.0189256-1.06049.290776-.280579.751564-.280362 1.04207.00049142l1.293 1.293c.0975674.0972627.255433.0972627.353-.00000001l1.293-1.293.00000005-.00000005c.297801-.287901.772607-.279876 1.06051.0179256.280853.290511.28107.751299.00049121 1.04207l-1.293 1.293-.00000003.00000003c-.0977544.0975076-.0979544.255799-.00044684.353553.00014878.00014915.00029774.00029812.00044689.00044689zm-7 0c.292711.292294.293049.766535.00075431 1.05925-.00025126.00025162-.0005027.00050305-.00075431.00075431l.00000003-.00000003c-.294812.287593-.765187.287593-1.06.00000005l-1.294-1.293c-.0981335-.0968348-.255866-.0968348-.354 0l-1.293 1.293.00000001-.00000001c-.296698.282921-.763302.282921-1.06.00000002l.00000002.00000002c-.292711-.292294-.293049-.766535-.00075434-1.05925.00025126-.00025162.0005027-.00050305.00075431-.00075431l1.293-1.293c.0968348-.0981335.0968348-.255866-.00000001-.354l-1.293-1.293-.00000002-.00000002c-.282379-.303043-.265627-.777621.0374166-1.06.28803-.268389.734554-.268389 1.02258.00000004l1.293 1.293c.0981335.0968348.255866.0968348.354.00000001l1.293-1.293.00000002-.00000002c.303043-.282379.777621-.265627 1.06.0374166.268389.28803.268389.734554-.00000003 1.02258l-1.293 1.293c-.0968348.0981335-.0968348.255866 0 .354z"/></svg>

================
File: app/assets/images/pencil.svg
================
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M2.649 16.4a.5.5 0 0 0-.841.245L.394 23.01a.5.5 0 0 0 .134.462.51.51 0 0 0 .462.135l6.364-1.414a.5.5 0 0 0 .245-.842zM17.852 7.208l-10.96 10.96a.25.25 0 0 0 0 .354L8.66 20.29a.507.507 0 0 0 .707 0L19.974 9.683a.5.5 0 0 0 0-.707l-1.768-1.768a.25.25 0 0 0-.354 0M16.792 5.794l-1.768-1.767a.5.5 0 0 0-.707 0L3.71 14.633a.5.5 0 0 0 0 .707l1.768 1.768a.25.25 0 0 0 .354 0l10.96-10.96a.25.25 0 0 0 0-.354M22.449 1.552a4.005 4.005 0 0 0-5.658 0l-.707.707a.5.5 0 0 0 0 .707l4.95 4.949a.513.513 0 0 0 .707 0l.708-.707a4 4 0 0 0 0-5.656"/></svg>

================
File: app/assets/images/person-add.svg
================
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m23.1 12.9h-3v3c0 .5-.4.9-.9.9s-.9-.4-.9-.9v-3h-3c-.5 0-.9-.4-.9-.9s.4-.9.9-.9h3v-3c0-.5.4-.9.9-.9s.9.4.9.9v3s3 0 3 0c.5 0 .9.4.9.9s-.4.9-.9.9zm-7.6 8.2h-15c-.3 0-.5-.2-.5-.5.1-2.1 1.1-2.6 3.2-3.4 2-.7 2.6-1.5 2.8-3.3-.3-.2-.6-.5-.9-.8-.5-.6-.8-1.4-.9-2.1-.5 0-.9-1.1-.9-1.8s.3-1 .5-1 0 0 .1 0c-.1-.5-.2-1-.2-1.4 0-2.6 1.1-4.1 4.3-4.1s1.7.4 2 .9c.2-.1.4-.2.6-.2.8 0 1.8 1 1.8 3.3 0 .5 0 1-.2 1.4h.1c.2 0 .5.2.5 1s-.4 1.8-.9 1.8c0 .8-.4 1.5-.9 2.1-.3.3-.6.5-.9.8.1 1.8.8 2.5 2.8 3.3 2.1.8 3 1.3 3.2 3.4 0 .3-.2.5-.5.5z" fill-rule="evenodd"/></svg>

================
File: app/assets/images/person.svg
================
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m15.5294 14.1176-.7059-.2352c-.2353-.5883-.3529-1.2942-.1176-1.8824 1.2941-1.4118 1.8823-3.17647 1.7647-5.05882 0-2.82353-1.8824-4.94118-4.4706-4.94118-2.58824 0-4.47059 2.11765-4.47059 4.94118-.11765 1.7647.47059 3.64702 1.76471 5.05882.23529.5882.23529 1.2941-.11765 1.8824l-.70588.2352c-2.82353 1.0589-4.94118 1.7648-5.64706 3.0589-.47059 1.4117-.82353 2.8235-.82353 4.2353 0 .3529.23529.5882.58824.5882h18.82356c.3529 0 .5882-.2353.5882-.5882 0-1.4118-.3529-2.8236-.8235-4.1177-.7059-1.2941-2.8236-2.1176-5.6471-3.1765z" fill="#000"/></svg>

================
File: app/assets/images/picture-add.svg
================
<svg fill="none" height="24" width="24" xmlns="http://www.w3.org/2000/svg"><g fill="#000"><path d="m19 2c-2.8 0-5 2.2-5 5s2.2 5 5 5 5-2.2 5-5-2.2-5-5-5zm-.1 2.5c.3 0 .6.3.6.6v1.2c0 .2 0 .2.2.2h1.2c.3 0 .6.3.6.6s-.3.6-.6.6h-1.2c-.2 0-.2 0-.2.2v1.2c0 .3-.3.6-.6.6s-.6-.3-.6-.6v-1.2c0-.2 0-.2-.2-.2h-1.2c-.3 0-.6-.3-.6-.6s.3-.6.6-.6h1.2c.2 0 .2 0 .2-.2v-1.2c0-.3.3-.6.6-.6zm-9.2 14.4h.1l-.1-.1z"/><path d="m19.2 13.6v6.3c0 .2 0 .4-.4.4h-16.8v-13.7c0-.2 0-.4.4-.4h10.1c0-.7.3-1.3.5-1.8h-11.6c-.9.2-1.4.9-1.4 1.8v14c0 1 .8 1.8 1.8 1.8h17.5c1 0 1.8-.8 1.8-1.8v-6.9c-.6.2-1.2.3-1.8.3z"/><path d="m4.8 7.5c-.7 0-1.3.6-1.3 1.3v8.9c0 .4.2.7.5 1l2.6-3.5c.2-.3.6-.5.9-.5.4 0 .7.2.9.5l.9 1.3 2.3-3.5c.3-.4.8-.7 1.3-.7s1 .3 1.3.7l3.1 5v-4.5c-2.8-.6-4.9-3-5.1-6h-7.6zm1.9 5c-.9 0-1.6-.7-1.6-1.6s.7-1.6 1.6-1.6 1.6.7 1.6 1.6-.7 1.6-1.6 1.6z"/><path d="m5.2 18.9h2.6l1-1.5-1.2-1.7zm5.2-1.1-.7 1 .1.1h6.4l-3.1-5.1z"/></g></svg>

================
File: app/assets/images/picture-remove.svg
================
<svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M19 2c-2.8 0-5 2.2-5 5s2.2 5 5 5 5-2.2 5-5-2.2-5-5-5zm-.8 5.7H17c-.3 0-.6-.3-.6-.6s.3-.6.6-.6h4c.3 0 .6.3.6.6s-.3.6-.6.6h-2.8zM9.7 18.9h.1l-.1-.1v.1z" fill="#000"/><path d="M19.2 13.6v6.3c0 .2 0 .4-.4.4H2V6.6c0-.2 0-.4.4-.4h10.1c0-.7.3-1.3.5-1.8H1.4C.5 4.6 0 5.3 0 6.2v14c0 1 .8 1.8 1.8 1.8h17.5c1 0 1.8-.8 1.8-1.8v-6.9c-.6.2-1.2.3-1.8.3h-.1z" fill="#000"/><path d="M4.8 7.5c-.7 0-1.3.6-1.3 1.3v8.9c0 .4.2.7.5 1l2.6-3.5c.2-.3.6-.5.9-.5.4 0 .7.2.9.5l.9 1.3 2.3-3.5c.3-.4.8-.7 1.3-.7s1 .3 1.3.7l3.1 5v-4.5c-2.8-.6-4.9-3-5.1-6H4.6h.2zm1.9 5c-.9 0-1.6-.7-1.6-1.6 0-.9.7-1.6 1.6-1.6.9 0 1.6.7 1.6 1.6 0 .9-.7 1.6-1.6 1.6z" fill="#000"/><path d="M5.2 18.9h2.6l1-1.5-1.2-1.7-2.4 3.2zM10.4 17.8l-.7 1 .1.1H16.2l-3.1-5.1-2.7 4z" fill="#000"/></svg>

================
File: app/assets/images/picture-zoom.svg
================
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m6.7 11.3c-.9 0-1.6.7-1.6 1.6s.7 1.6 1.6 1.6 1.6-.7 1.6-1.6-.7-1.6-1.6-1.6z" fill="none"/><path d="m10.4 19.8 2.7-4 3.1 5.1h-6.5c0-.1.7-1.1.7-1.1zm-2.8-2.1 1.2 1.7-1 1.5h-2.6z" fill="none"/><path d="m19.2 12.1v9.9s0 .2-.1.2c0 0-.1 0-.3 0h-16.8v-13.7c0-.2 0-.4.4-.4h7.2c-.2-.6-.4-1.2-.4-1.8h-7.8c-.7.2-1.2.7-1.3 1.3v.5 14c0 1 .8 1.8 1.8 1.8h17.9c.7-.2 1.2-.7 1.3-1.3 0-.1 0-.3 0-.5v-8.2l-1.9-1.9s0 0 0 0z"/><path d="m10.2 9.5h-5.4c-.7 0-1.3.6-1.3 1.3v8.9c0 .4.2.7.5 1l2.6-3.5c.2-.3.6-.5.9-.5s.7.2.9.5l.9 1.3 2.3-3.5c.3-.4.8-.7 1.3-.7s1 .3 1.3.7l3.1 5v-7.3c-.4 0-.8.1-1.2.1-2.5 0-4.7-1.3-5.9-3.3zm-3.5 5c-.9 0-1.6-.7-1.6-1.6s.7-1.6 1.6-1.6 1.6.7 1.6 1.6-.7 1.6-1.6 1.6z"/><path d="m8.8 19.4-1.2-1.7-2.4 3.2h2.6z"/><path d="m16.2 20.9-3.1-5.1-2.7 4-.7 1 .1.1z"/><path d="m23.7 12.2-3-3c1.9-2.5 1.3-6.1-1.2-8s-6.1-1.3-8 1.2-1.3 6.1 1.2 8c2 1.5 4.7 1.5 6.7 0l3 3c.3.3.9.3 1.2 0s.3-.9 0-1.2zm-7.6-2.5c-2.2 0-3.9-1.8-3.9-3.9 0-2.2 1.8-3.9 3.9-3.9 2.2 0 3.9 1.8 3.9 3.9s-1.8 3.9-3.9 3.9z"/><path d="m17.9 5.1h-1.1v-1.1c0-.4-.3-.7-.7-.7s-.7.3-.7.7v1.1h-1.1c-.4 0-.7.3-.7.7s.3.7.7.7 1.1 0 1.1 0v1.1c0 .4.3.7.7.7s.7-.3.7-.7v-1.1h1.1c.4 0 .7-.3.7-.7s-.3-.7-.7-.7z"/></svg>

================
File: app/assets/images/pinned.svg
================
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m22.5 7.3s.1.2.2.3c.4.7.2 1.6-.5 2l-6.4 4.1c.4 1.9.2 3.8-.8 5.5-.2.4-.6.7-1.1.7s-.9-.1-1.2-.4l-8.1-8.2s-.2-.2-.2-.3c-.4-.7-.2-1.6.5-2 1.7-1 3.6-1.2 5.5-.8l4-6.4s.1-.2.2-.3c.6-.6 1.5-.6 2.1 0z"/><path d="m9.5 14.4c.6.6.6 1.5 0 2.1l-5.9 5.9c-.6.6-1.5.6-2.1 0s-.6-1.5 0-2.1l5.9-5.9c.6-.6 1.5-.6 2.1 0z"/></svg>

================
File: app/assets/images/qr-code.svg
================
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m4 4h6v6h-6zm16 0v6h-6v-6zm-6 11h2v-2h-2v-2h2v2h2v-2h2v2h-2v2h2v3h-2v2h-2v-2h-3v2h-2v-4h3zm2 0v3h2v-3zm-12 5v-6h6v6zm2-14v2h2v-2zm10 0v2h2v-2zm-10 10v2h2v-2zm-2-5h2v2h-2zm5 0h4v4h-2v-2h-2zm2-5h2v4h-2zm-9-4v4h-2v-4a2 2 0 0 1 2-2h4v2zm20-2a2 2 0 0 1 2 2v4h-2v-4h-4v-2zm-20 18v4h4v2h-4a2 2 0 0 1 -2-2v-4zm20 4v-4h2v4a2 2 0 0 1 -2 2h-4v-2z"/></svg>

================
File: app/assets/images/reaction.svg
================
<svg fill="none" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><g fill="#000"><path d="m12 1c6.0751 0 11 4.92487 11 11 0 .7521-.0753 1.4879-.2197 2.1992-.11.5411-.6385.8911-1.1797.7813-.5411-.1101-.8901-.6386-.7803-1.1797.1179-.581.1797-1.1832.1797-1.8008 0-4.97056-4.0294-9-9-9-4.97056 0-9 4.02944-9 9 0 4.9706 4.02944 9 9 9 .6176 0 1.2198-.0618 1.8008-.1797.5411-.1098 1.0696.2392 1.1797.7803.1098.5412-.2402 1.0697-.7813 1.1797-.7113.1444-1.4471.2197-2.1992.2197-6.07513 0-11-4.9249-11-11 0-6.07513 4.92487-11 11-11z"/><path d="m19 15c.5523 0 1 .4477 1 1v2h2c.5523 0 1 .4477 1 1s-.4477 1-1 1h-2v2c0 .5523-.4477 1-1 1s-1-.4477-1-1v-2h-2c-.5523 0-1-.4477-1-1s.4477-1 1-1h2v-2c0-.5523.4477-1 1-1z"/><path d="m15.0342 13.7412c.1428-.5329.6904-.8492 1.2236-.707.5335.1424.8503.6901.708 1.2236l-.9658-.2578c.9662.2577.9658.2578.9658.2578v.002l-.001.0019s-.0004.0039-.0009.0059c-.0011.0039-.0025.0084-.0039.0136-.0031.011-.0077.0255-.0127.042-.01.033-.0238.0768-.042.1299-.0365.1064-.0903.2514-.166.4219-.1506.3387-.3928.7925-.7588 1.25-.7476.9342-2.0152 1.875-3.9805 1.875s-3.23294-.9408-3.98047-1.875c-.36603-.4575-.60824-.9113-.75879-1.25-.07576-.1705-.12956-.3155-.16601-.4219-.0182-.053-.03202-.0969-.042-.1299-.00499-.0165-.00958-.031-.01269-.042-.00149-.0052-.00284-.0097-.00391-.0136-.00055-.002-.00097-.0059-.00097-.0059l-.00098-.0019c-.0069-.035 0-.002 0-.002-.14228-.5335.17452-1.0812.70801-1.2236.53325-.1422 1.08085.1741 1.22363.707l.00098.0029c.0033.011.00967.0318.01953.0606.01978.0577.05335.1471.10254.2578.09944.2238.25827.5201.49218.8125.45255.5656 1.18455 1.125 2.41895 1.125s1.9664-.5594 2.4189-1.125c.234-.2924.3928-.5887.4922-.8125.0492-.1107.0828-.2001.1026-.2578.0098-.0288.0162-.0496.0195-.0606z"/><path d="m8.5 8c.82843 0 1.5.67157 1.5 1.5 0 .8284-.67157 1.5-1.5 1.5s-1.5-.6716-1.5-1.5c0-.82843.67157-1.5 1.5-1.5z"/><path d="m15.5 8c.8284 0 1.5.67157 1.5 1.5 0 .8284-.6716 1.5-1.5 1.5s-1.5-.6716-1.5-1.5c0-.82843.6716-1.5 1.5-1.5z"/></g></svg>

================
File: app/assets/images/refresh--meta.svg
================
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m-44.4 1.7c2.2-2.2 5.4-3 8.4-2 .7.2 1.4-.2 1.6-.8.2-.7-.2-1.4-.8-1.6-5.7-1.8-11.7 1.3-13.5 7-.8 2.4-.7 5 .3 7.3v.3l-1.4.9c-.5.3-.6.9-.3 1.4.1.2.4.4.6.4l4.4.9h.2c.5 0 .9-.3 1-.8l.9-4.4c.1-.5-.2-1.1-.8-1.2-.3 0-.5 0-.8.1l-1.3.9c-.1 0-.3 0-.3 0-.9-2.9-.2-6.2 2-8.3z"/><path d="m-26.7 1.3c0-.4-.4-.7-.8-.8l-4.4-1c-.5-.1-1.1.2-1.2.7l-1 4.4c-.1.5.2 1.1.8 1.2.3 0 .5 0 .8-.1l1.4-.9h.2s.1 0 .2.2c1.4 4.3-1 9-5.3 10.4-1.6.5-3.4.5-5 0-.7-.2-1.4.1-1.6.8s.1 1.4.8 1.6c5.7 1.8 11.7-1.4 13.4-7.1.7-2.4.6-4.9-.3-7.2 0-.1 0-.2.1-.3l1.3-.8c.3-.2.5-.6.5-1z"/><rect height="5" rx="2.5" transform="matrix(0 -1 1 0 30.8 65.4)" width="32" x="32.1" y="14.8"/><path d="m24 6.4c0-.1 0-.2-.2-.2l-6.4-1.9c-.1 0-.3 0-.3.2l-1.9 6.4v.3h.2s0 0 .1 0l2.5-1.4c.3.7.4 1.5.4 2.3 0 3.6-2.9 6.5-6.5 6.5s-1.2 0-1.7-.2c-1.1-.3-2.2.3-2.5 1.4s.3 2.2 1.4 2.5c.9.3 1.9.4 2.8.4 5.8 0 10.5-4.7 10.5-10.5s-.3-2.9-.9-4.2l2.2-1.2s.1-.1.1-.2z"/><path d="m8.6 12.9s-.2 0-.3 0l-2.5 1.4c-.3-.7-.4-1.5-.4-2.2 0-3.6 2.9-6.5 6.5-6.5s1.2 0 1.7.2c1.1.3 2.2-.3 2.5-1.4s-.3-2.2-1.4-2.5c-.9-.2-1.8-.4-2.8-.4-5.7-0-10.4 4.7-10.4 10.5s.3 2.8.9 4.2l-2.2 1.2s-.1.1-.1.2 0 .2.2.2l6.4 1.9s0 0 0 0c.1 0 .2 0 .2-.2l1.9-6.4s0-.2 0-.3z"/><circle cx="40" cy="-9" fill="none" r="8.5" stroke="#000" stroke-miterlimit="10" stroke-width="4"/><path d="m51.2-14.7-5-1.5c-.3 0-.5 0-.8 0-.2.1-.4.3-.5.6l-1.5 5c-.1.4 0 .8.3 1 .2.1.4.2.6.2s.3 0 .5-.1l6.5-3.6c.3-.2.5-.6.5-1s-.3-.7-.7-.8z"/><path d="m28.7-3.7 5 1.5h.8c.2-.1.4-.3.5-.6l1.5-5c.1-.4 0-.8-.3-1-.2-.1-.4-.2-.6-.2s-.3 0-.5.1l-6.5 3.6c-.3.2-.5.6-.5 1s.3.7.7.8z"/></svg>

================
File: app/assets/images/refresh.svg
================
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m6.177 6.167a8.233 8.233 0 0 1 8.351-2.027 1.249 1.249 0 1 0 .76-2.38 10.751 10.751 0 0 0 -13.242 14.273.248.248 0 0 1 -.094.3l-1.4.922a1 1 0 0 0 .348 1.816l4.407.908a.99.99 0 0 0 .2.021 1 1 0 0 0 .979-.8l.914-4.406a1 1 0 0 0 -1.529-1.037l-1.339.881a.25.25 0 0 1 -.376-.133 8.269 8.269 0 0 1 2.021-8.338z"/><path d="m23.883 5.832a1 1 0 0 0 -.763-.807l-4.388-1a1 1 0 0 0 -1.2.752l-1 4.387a1 1 0 0 0 1.507 1.069l1.443-.906a.247.247 0 0 1 .218-.027.252.252 0 0 1 .153.159 8.249 8.249 0 0 1 -10.285 10.424 1.25 1.25 0 1 0 -.737 2.388 10.75 10.75 0 0 0 13.154-14.271.248.248 0 0 1 .1-.3l1.346-.846a1 1 0 0 0 .452-1.022z"/></svg>

================
File: app/assets/images/remove.svg
================
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M22.664 5.578a1.5 1.5 0 0 0 0-2.121l-2.121-2.121a1.5 1.5 0 0 0-2.122 0l-6.244 6.245a.25.25 0 0 1-.354 0L5.579 1.336a1.5 1.5 0 0 0-2.122 0L1.336 3.457a1.5 1.5 0 0 0 0 2.121l6.245 6.245a.25.25 0 0 1 0 .354l-6.245 6.245a1.5 1.5 0 0 0 0 2.121l2.121 2.121a1.5 1.5 0 0 0 2.122 0l6.244-6.245a.25.25 0 0 1 .354 0l6.244 6.245a1.5 1.5 0 0 0 2.122 0l2.121-2.121a1.5 1.5 0 0 0 0-2.121l-6.245-6.245a.25.25 0 0 1 0-.354z"/></svg>

================
File: app/assets/images/rename.svg
================
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m3 7a2 2 0 0 0 -2 2v8h2v-4h2v4h2v-8a2 2 0 0 0 -2-2zm0 2h2v2h-2m12-.5v-1.5a2 2 0 0 0 -2-2h-4v10h4a2 2 0 0 0 2-2v-1.5a1.54 1.54 0 0 0 -1.5-1.5 1.54 1.54 0 0 0 1.5-1.5m-2 4.5h-2v-2h2zm0-4h-2v-2h2m6-2a2 2 0 0 0 -2 2v6a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2v-1h-2v1h-2v-6h2v1h2v-1a2 2 0 0 0 -2-2z"/></svg>

================
File: app/assets/images/search.svg
================
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m23.414 20.591-4.645-4.645a10.256 10.256 0 1 0 -2.828 2.829l4.645 4.644a2.025 2.025 0 0 0 2.828 0 2 2 0 0 0 0-2.828zm-13.164-17.586a7.25 7.25 0 1 1 -7.25 7.25 7.258 7.258 0 0 1 7.25-7.25z"/></svg>

================
File: app/assets/images/settings.svg
================
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m22.421 9.763-1.266-.449.00000012.00000004c-.715005-.254175-1.08858-1.03985-.834406-1.75486.015863-.0446231.0340224-.0883962.0544056-.131144l.576-1.213.00000009-.0000002c.562362-1.18562.0571125-2.60264-1.12851-3.165-.644423-.305662-1.39207-.305662-2.03649.0000002l-1.213.577.00000003-.00000002c-.686103.325481-1.50615.0331379-1.83163-.652965-.0199623-.0420799-.0377737-.0851469-.0533652-.129034l-.45-1.265.00000005.00000014c-.440698-1.23601-1.79994-1.88074-3.03595-1.44005-.671828.239539-1.20051.768217-1.44005 1.44005l-.45 1.266v-.00000001c-.254689.715408-1.04111 1.08889-1.75652.834205-.0436977-.0155566-.0865803-.0333144-.128483-.0532053l-1.213-.577-.00000004-.00000002c-1.18562-.562362-2.60264-.0571125-3.165 1.12851-.305662.644423-.305662 1.39207.00000004 2.03649l.576 1.213.00000005.0000001c.326289.685719.0349133 1.50611-.650806 1.8324-.0421276.0200458-.0852481.0379345-.129194.0535967l-1.266.45-.00000004.00000001c-1.23574.439828-1.88095 1.79814-1.44112 3.03388.239375.672547.768575 1.20175 1.44112 1.44112l1.266.45-.00000004-.00000002c.714925.2544 1.08825 1.04019.833853 1.75512-.0157227.0441846-.0336974.0875352-.0538533.129882l-.576 1.213.00000006-.00000012c-.562362 1.18562-.0571127 2.60264 1.12851 3.165.644423.305662 1.39207.305662 2.03649.00000011l1.213-.576-.00000004.00000002c.6845-.32628 1.5039-.0358847 1.83018.648616.0205653.0431439.0388639.0873322.0548208.132384l.45 1.265-.00000012-.00000034c.440698 1.23601 1.79994 1.88074 3.03595 1.44005.671828-.239539 1.20051-.768217 1.44005-1.44004l.45-1.266.00000007-.00000021c.2544-.714925 1.04019-1.08825 1.75512-.833853.0441846.0157227.0875352.0336974.129882.0538534l1.213.576-.00000014-.00000007c1.18562.562362 2.60264.0571127 3.165-1.12851.305662-.644423.305662-1.39207.00000014-2.03649l-.576-1.213-.00000001-.00000001c-.326132-.685182-.035064-1.50501.650118-1.83115.0423464-.020156.085697-.0381306.129882-.0538533l1.266-.451-.00000016.00000006c1.23574-.439828 1.88095-1.79814 1.44112-3.03388-.239375-.672547-.768575-1.20175-1.44112-1.44112zm-10.421 7.022h-.00000027c-1.92881-.0279814-3.66412-1.17834-4.441-2.944l-.00000007-.00000017c-1.01279-2.45242.150189-5.26191 2.6-6.281l-.00000002.00000001c2.45232-.980726 5.23932.172946 6.281 2.6l.00000007.00000018c1.01279 2.45242-.150189 5.26191-2.6 6.281l-.00000033.00000014c-.583184.239869-1.20955.356971-1.84.344z"/></svg>

================
File: app/assets/images/share.svg
================
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.5 9a2 2 0 0 0-2-2h-3.25a.25.25 0 0 0-.25.25v1.5a.25.25 0 0 0 .25.25H18a.5.5 0 0 1 .5.5v12a.5.5 0 0 1-.5.5H6a.5.5 0 0 1-.5-.5v-12A.5.5 0 0 1 6 9h2.75A.25.25 0 0 0 9 8.749v-1.5A.25.25 0 0 0 8.748 7H5.5a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2h13a2 2 0 0 0 2-2z"/><path d="M10.5 11a1.5 1.5 0 0 0 3 0V5.749a.25.25 0 0 1 .25-.25h1.75a1 1 0 0 0 .7-1.707l-3.5-3.5a1 1 0 0 0-1.414 0l-3.5 3.5A1 1 0 0 0 8.5 5.5h1.75a.25.25 0 0 1 .25.25z"/></svg>

================
File: app/assets/images/sliders.svg
================
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m8 13c-1.86 0-3.41 1.28-3.86 3h-2.14v2h2.14c.45 1.72 2 3 3.86 3s3.41-1.28 3.86-3h10.14v-2h-10.14c-.45-1.72-2-3-3.86-3m0 6c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2m11.86-13c-.45-1.72-2-3-3.86-3s-3.41 1.28-3.86 3h-10.14v2h10.14c.45 1.72 2 3 3.86 3s3.41-1.28 3.86-3h2.14v-2zm-3.86 3c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/></svg>

================
File: app/assets/images/sun.svg
================
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>

================
File: app/assets/images/switch.svg
================
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z" /></svg>

================
File: app/assets/images/tag-outline.svg
================
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m2 13c0 .55.21985 1.0502.58984 1.4102l7 7 .14161.1289c.34435.2851.78735.4609 1.26855.4609s.9243-.1758 1.2754-.4609l.1445-.1289 8.9903-9c.37-.36.5898-.8602.5898-1.4102v-7c0-1.11-.89-2-2-2h-7c-.55 0-1.0502.22008-1.4102.58008l-8.99996 9.00002c-.35993.36-.58984.86-.58984 1.4199zm18-2.0088-8.9775 8.9873-.0205.0147-6.99809-6.9971v-.002l8.99409-8.9941h7.002z"/><circle cx="17.5" cy="6.5" r="1.5"/></svg>

================
File: app/assets/images/tag.svg
================
<svg fill="none" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="m18.5 7c.3978 0 .7794-.15804 1.0607-.43934s.4393-.66284.4393-1.06066-.158-.77936-.4393-1.06066-.6629-.43934-1.0607-.43934-.7794.15804-1.0607.43934-.4393.66284-.4393 1.06066.158.77936.4393 1.06066.6629.43934 1.0607.43934zm-15.91 4.58 9-9c.36-.36.86-.58 1.41-.58h7c1.11 0 2 .89 2 2v7c0 .55-.22 1.05-.59 1.41l-8.99 9c-.37.36-.87.59-1.42.59s-1.05-.23-1.41-.59l-7-7c-.37-.36-.59-.86-.59-1.41 0-.56.23-1.06.59-1.42z" fill="#000"/></svg>

================
File: app/assets/images/thumb-up.svg
================
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m10.2 11.2h-2.1c-.2 0-.4-.2-.4-.4v-2.1c0-.6-.5-1.1-1.1-1.1s-1.1.5-1.1 1.1v2.1c0 .2-.2.4-.4.4h-2.1c-.6 0-1.1.5-1.1 1.1s.5 1.1 1.1 1.1h2.1c.2 0 .4.2.4.4v2.1c0 .6.5 1.1 1.1 1.1s1.1-.5 1.1-1.1v-2.1c0-.2.2-.4.4-.4h2.1c.6 0 1.1-.5 1.1-1.1s-.5-1.1-1.1-1.1z"/><rect height="16.6" rx="1.4" width="2.7" x="16.2" y="3.4"/><rect height="8.3" rx="1.4" transform="matrix(0 1 -1 0 36.3 .9)" width="2.7" x="16.3" y="14.4"/><rect height="6.6" rx="1.4" transform="matrix(.70710678 .70710678 -.70710678 .70710678 9 -9.5)" width="2.7" x="14.6" y="2.8"/></svg>

================
File: app/assets/images/trash.svg
================
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><g fill="none" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path d="m1.5 4.5h21"/><path d="m14.25 1.5h-4.5-.00000007c-.828427.00000004-1.5.671573-1.5 1.5v1.5h7.5v-1.5c0-.828427-.671573-1.5-1.5-1.5z"/><path d="m9.75 17.25v-7.5"/><path d="m14.25 17.25v-7.5"/><path d="m18.865 21.124.00000001-.00000017c-.0645133.777732-.714596 1.37607-1.495 1.376h-10.739-.00000007c-.780403.00006974-1.43049-.598268-1.495-1.376l-1.386-16.624h16.5z"/></g></svg>

================
File: app/assets/images/unpinned.svg
================
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m23.5 19.5-6.2-6.2 4.8-3.1c.7-.4.9-1.3.5-2 0 0-.2-.3-.2-.3l-5.8-5.8c-.6-.6-1.5-.6-2.1 0s-.2.3-.2.3l-3.1 4.9-6.8-7c-.4-.3-1-.3-1.4 0-.4.4-.4 1 0 1.4l7 7s0 0 0 0l5.8 5.8s0 0 0 0l6.4 6.4c.4.4 1 .4 1.4 0s.4-1 0-1.4z"/><path d="m4.8 9.6c-.7.4-.9 1.3-.5 2 0 0 .2.3.2.3l3 3s-.1 0-.2.1l-5.9 5.9c-.6.6-.6 1.5 0 2.1s1.5.6 2.1 0l5.9-5.9s0 0 0-.1l3.1 3.1c.3.3.7.4 1.2.4s.9-.3 1.1-.7c.6-1 .9-2 1-3.1l-7.9-8.1c-1 0-2.1.4-3 1z"/></svg>

================
File: app/assets/images/unseen.svg
================
<svg enable-background="new 0 0 362 362" viewBox="0 0 362 362" xmlns="http://www.w3.org/2000/svg"><g><path d="m346.7 158.6c-18.8-20.6-40.3-38.6-64-53.6l59.5-59.4c5.9-5.7 6.1-15.1.4-21s-15.1-6.1-21-.4c-.1.1-.2.2-.4.4l-.3.3c-.5 1.6-1.4 3.1-2.6 4.3l-290.1 290c-.1.1-.3.1-.4.3-3.1 7.6.5 16.3 8.1 19.4 5.5 2.3 11.9 1 16.1-3.2l61.7-61.7c20.2 8.8 42 13.6 64.1 14h4.5c63.3 0 126.3-44.4 164.4-86.3 11-12.3 11-30.9 0-43.1zm-102.5 40.4c-6.6 21.4-23.2 38.3-44.6 45-15.2 4.8-31.6 3.8-46.1-2.8-1.9-.9-2.7-3.2-1.7-5 .2-.4.4-.7.7-1l82.7-82.7c1.4-1.5 3.8-1.5 5.3-.1.3.3.6.7.8 1.1 6.5 14.3 7.5 30.5 2.9 45.5z"/><path d="m114.8 201c.9-.9 1.3-2.3.9-3.6-1.7-5.6-2.5-11.4-2.6-17.3 0-37 30-66.9 66.9-66.9 5.8.1 11.6.9 17.3 2.6 1.3.4 2.6 0 3.6-.9l28.8-28.9c1.5-1.5 1.5-3.9 0-5.3-.4-.4-.9-.7-1.5-.9-15.6-5-31.9-7.5-48.2-7.4-64-.9-127.9 43.9-166.4 86.3-11.2 12.2-11.2 30.9-.1 43.1 15.4 16.8 32.5 31.9 51.1 45.1 1.5 1 3.5.9 4.8-.4z"/></g></svg>

================
File: app/assets/images/world.svg
================
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17.2 14.4c.1-.8.2-1.6.2-2.4s-.1-1.6-.2-2.4h4.1q.3 1.2.3 2.4c0 1.2-.1 1.6-.3 2.4m-6.2 6.7c.7-1.3 1.3-2.8 1.7-4.3h3.5c-1.1 2-3 3.5-5.2 4.3m-.3-6.7H9.2c-.1-.8-.2-1.6-.2-2.4s.1-1.6.2-2.4h5.6c.1.8.2 1.6.2 2.4s-.1 1.6-.2 2.4M12 21.6c-1-1.4-1.8-3-2.3-4.8h4.6c-.5 1.7-1.3 3.3-2.3 4.8M7.2 7.2H3.7c1.1-2 3-3.5 5.2-4.3-.7 1.4-1.3 2.8-1.7 4.3m-3.5 9.6h3.5c.4 1.5 1 2.9 1.7 4.3-2.2-.8-4.1-2.3-5.2-4.3m-1-2.4q-.3-1.2-.3-2.4c0-1.2.1-1.6.3-2.4h4.1c-.1.8-.2 1.6-.2 2.4s.1 1.6.2 2.4m5.2-12c1 1.4 1.8 3 2.3 4.8H9.7c.5-1.7 1.3-3.3 2.3-4.8m8.3 4.8h-3.5c-.4-1.5-.9-2.9-1.7-4.3 2.2.8 4.1 2.3 5.2 4.3M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.6 0 12 0"/></svg>

================
File: app/assets/images/youtube.svg
================
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10,15L15.19,12L10,9V15M21.56,7.17C21.69,7.64 21.78,8.27 21.84,9.07C21.91,9.87 21.94,10.56 21.94,11.16L22,12C22,14.19 21.84,15.8 21.56,16.83C21.31,17.73 20.73,18.31 19.83,18.56C19.36,18.69 18.5,18.78 17.18,18.84C15.88,18.91 14.69,18.94 13.59,18.94L12,19C7.81,19 5.2,18.84 4.17,18.56C3.27,18.31 2.69,17.73 2.44,16.83C2.31,16.36 2.22,15.73 2.16,14.93C2.09,14.13 2.06,13.44 2.06,12.84L2,12C2,9.81 2.16,8.2 2.44,7.17C2.69,6.27 3.27,5.69 4.17,5.44C4.64,5.31 5.5,5.22 6.82,5.16C8.12,5.09 9.31,5.06 10.41,5.06L12,5C16.19,5 18.8,5.16 19.83,5.44C20.73,5.69 21.31,6.27 21.56,7.17Z" /></svg>

================
File: app/assets/stylesheets/_global.css
================
@layer reset, base, components, modules, utilities, native, platform;
:root {
  /* Insets - The mobile apps may inject their own custom insets based on native elements on screen, like a floating navigation */
  --custom-safe-inset-top: var(--injected-safe-inset-top, env(safe-area-inset-top, 0px));
  --custom-safe-inset-right: var(--injected-safe-inset-right, env(safe-area-inset-right, 0px));
  --custom-safe-inset-bottom: var(--injected-safe-inset-bottom, env(safe-area-inset-bottom, 0px));
  --custom-safe-inset-left: var(--injected-safe-inset-left, env(safe-area-inset-left, 0px));
  /* Spacing */
  --inline-space: 1ch;
  --inline-space-half: calc(var(--inline-space) / 2);
  --inline-space-double: calc(var(--inline-space) * 2);
  --block-space: 1rem;
  --block-space-half: calc(var(--block-space) / 2);
  --block-space-double: calc(var(--block-space) * 2);
  /* Text */
  --font-sans: "Adwaita Sans", -apple-system, BlinkMacSystemFont, "Segoe UI Variable Fizzy", "Segoe UI", "Noto Sans", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
  --font-serif: ui-serif, serif;
  --font-mono: ui-monospace, monospace;
  --text-xx-small: 0.55rem;
  --text-x-small: 0.75rem;
  --text-small: 0.85rem;
  --text-normal: 1rem;
  --text-medium: 1.1rem;
  --text-large: 1.5rem;
  --text-x-large: 1.8rem;
  --text-xx-large: 2.5rem;
  @media (max-width: 639px) {
    --text-xx-small: 0.65rem;
    --text-x-small: 0.85rem;
    --text-small: 0.95rem;
    --text-normal: 1.1rem;
    --text-medium: 1.2rem;
    --text-large: 1.5rem;
    --text-x-large: 1.8rem;
    --text-xx-large: 2.5rem;
  }
  /* Borders */
  --border: 1px solid var(--color-ink-lighter);
  /* Shadows */
  --shadow: 0 0 0 1px oklch(var(--lch-black) / 5%),
            0 0.2em 0.2em oklch(var(--lch-black) / 5%),
            0 0.4em 0.4em oklch(var(--lch-black) / 5%),
            0 0.8em 0.8em oklch(var(--lch-black) / 5%);
  /* Components */
  --btn-size: 2.65em;
  --footer-height: 2.65rem;
  --tray-size: clamp(12rem, 25dvw, 24rem);
  /* Focus rings for keyboard navigation */
  --focus-ring-color: var(--color-link);
  --focus-ring-offset: 1px;
  --focus-ring-size: 2px;
  --focus-ring: var(--focus-ring-size) solid var(--focus-ring-color);
  /* Dialogs */
  --dialog-duration: 150ms;
  /* Easing functions from https://easingwizard.com/ */
  --ease-out-expo: cubic-bezier(0.16, 1, 0.3, 1);
  --ease-out-overshoot: cubic-bezier(0.25, 1.75, 0.5, 1);
  --ease-out-overshoot-subtle: cubic-bezier(0.25, 1.25, 0.5, 1);
  @media (max-width: 799px) {
    --tray-size: var(--footer-height);
  }
  /* Layout */
  --main-padding: clamp(var(--inline-space), 3vw, calc(var(--inline-space) * 3));
  --main-width: 1400px;
  /* Z-index */
  --z-events-column-header: 1;
  --z-events-day-header: 3;
  --z-popup: 10;
  --z-nav: 20;
  --z-flash: 30;
  --z-tooltip: 40;
  --z-bar: 50;
  --z-tray: 51;
  --z-welcome: 52;
  --z-nav-open: 100;
  /* OKLCH colors: Fixed */
  --lch-black: 0% 0 0;
  --lch-white: 100% 0 0;
  /* OKLCH colors: Light mode */
  --lch-canvas: var(--lch-white);
  --lch-ink-inverted: var(--lch-white);
  --lch-ink-darkest: 26% 0.05 264;
  --lch-ink-darker: 40% 0.026 262;
  --lch-ink-dark: 56% 0.014 260;
  --lch-ink-medium: 66% 0.008 258;
  --lch-ink-light: 84% 0.005 256;
  --lch-ink-lighter: 92% 0.003 254;
  --lch-ink-lightest: 96% 0.002 252;
  --lch-uncolor-darkest: 26% 0.018 40;
  --lch-uncolor-darker: 40.04% 0.0376 50.06;
  --lch-uncolor-dark: 57.09% 0.0676 60.5;
  --lch-uncolor-medium: 66% 0.0944 71.46;
  --lch-uncolor-light: 83.97% 0.0457 80.84;
  --lch-uncolor-lighter: 92% 0.014 90;
  --lch-uncolor-lightest: 96% 0.012 100;
  --lch-red-darkest: 26% 0.105 34;
  --lch-red-darker: 40% 0.154 36;
  --lch-red-dark: 59% 0.19 38;
  --lch-red-medium: 66% 0.204 40;
  --lch-red-light: 84.08% 0.0837 41.96;
  --lch-red-lighter: 92% 0.03 44;
  --lch-red-lightest: 96% 0.013 46;
  --lch-yellow-darkest: 26% 0.0729 40;
  --lch-yellow-darker: 40% 0.12 50;
  --lch-yellow-dark: 58% 0.156 60;
  --lch-yellow-medium: 74% 0.184 70;
  --lch-yellow-light: 84% 0.12 80;
  --lch-yellow-lighter: 92% 0.076 90;
  --lch-yellow-lightest: 96% 0.034 100;
  --lch-lime-darkest: 26% 0.064 109;
  --lch-lime-darker: 40% 0.101 110;
  --lch-lime-dark: 56.5% 0.142 111;
  --lch-lime-medium: 68% 0.176 113.11;
  --lch-lime-light: 83.92% 0.0927 113.6;
  --lch-lime-lighter: 92% 0.046 114;
  --lch-lime-lightest: 96% 0.034 115;
  --lch-green-darkest: 26% 0.071 149;
  --lch-green-darker: 40% 0.12 148;
  --lch-green-dark: 55% 0.162 147;
  --lch-green-medium: 66% 0.208 146;
  --lch-green-light: 83.92% 0.0772 145.06;
  --lch-green-lighter: 92% 0.044 144;
  --lch-green-lightest: 96% 0.022 143;
  --lch-aqua-darkest: 26% 0.059 214;
  --lch-aqua-darker: 40% 0.093 212;
  --lch-aqua-dark: 55.5% 0.122 210;
  --lch-aqua-medium: 66% 0.152 208;
  --lch-aqua-light: 83.88% 0.0555 206.02;
  --lch-aqua-lighter: 92% 0.02 204;
  --lch-aqua-lightest: 96% 0.012 202;
  --lch-blue-darkest: 26% 0.126 264;
  --lch-blue-darker: 40% 0.166 262;
  --lch-blue-dark: 57.02% 0.1895 260.46;
  --lch-blue-medium: 66% 0.196 257.82;
  --lch-blue-light: 84.04% 0.0719 255.29;
  --lch-blue-lighter: 92% 0.026 254;
  --lch-blue-lightest: 96% 0.016 252;
  --lch-violet-darkest: 26% 0.148 292;
  --lch-violet-darker: 40% 0.2 290;
  --lch-violet-dark: 58% 0.216 287.6;
  --lch-violet-medium: 66% 0.206 285.52;
  --lch-violet-light: 84.08% 0.0791 283.47;
  --lch-violet-lighter: 92% 0.03 282;
  --lch-violet-lightest: 96% 0.015 280;
  --lch-purple-darkest: 26% 0.131 314;
  --lch-purple-darker: 40% 0.178 312;
  --lch-purple-dark: 58% 0.21 310;
  --lch-purple-medium: 66% 0.258 308;
  --lch-purple-light: 84.09% 0.0778 305.77;
  --lch-purple-lighter: 92% 0.03 304;
  --lch-purple-lightest: 96% 0.019 302;
  --lch-pink-darkest: 26% 0.12 348;
  --lch-pink-darker: 40% 0.16 346;
  --lch-pink-dark: 59% 0.188 344;
  --lch-pink-medium: 71.8% 0.2008 342;
  --lch-pink-light: 84.04% 0.0737 340;
  --lch-pink-lighter: 92% 0.03 338;
  --lch-pink-lightest: 96% 0.02 336;
  /* Colors: Named */
  --color-black: oklch(var(--lch-black));
  --color-white: oklch(var(--lch-white));
  --color-ink: oklch(var(--lch-ink-darkest));
  --color-ink-darkest: oklch(var(--lch-ink-darkest));
  --color-ink-darker: oklch(var(--lch-ink-darker));
  --color-ink-dark: oklch(var(--lch-ink-dark));
  --color-ink-medium: oklch(var(--lch-ink-medium));
  --color-ink-light: oklch(var(--lch-ink-light));
  --color-ink-lighter: oklch(var(--lch-ink-lighter));
  --color-ink-lightest: oklch(var(--lch-ink-lightest));
  --color-ink-inverted: oklch(var(--lch-ink-inverted));
  /* Colors: Abstractions */
  --color-canvas: oklch(var(--lch-canvas));
  --color-negative: oklch(var(--lch-red-dark));
  --color-positive: oklch(var(--lch-green-dark));
  --color-link: oklch(var(--lch-blue-dark));
  --color-selected-light: oklch(var(--lch-blue-lightest));
  --color-selected: oklch(var(--lch-blue-lighter));
  --color-selected-dark: oklch(var(--lch-blue-light));
  --color-highlight: oklch(var(--lch-yellow-lighter));
  --color-marker: oklch(var(--lch-red-medium));
  --color-terminal-bg: oklch(98% 0.002 252);
  --color-terminal-text: var(--color-ink);
  --color-terminal-text-light: var(--color-ink-lighter);
  --color-golden: oklch(89.1% 0.178 95.7);
  --color-maybe: oklch(var(--lch-blue-medium));
  /* Colors: Cards */
  --color-card-default: oklch(var(--lch-blue-dark));
  --color-card-complete: var(--color-ink-darker);
  --color-card-1: oklch(var(--lch-ink-medium));
  --color-card-2: oklch(var(--lch-uncolor-medium));
  --color-card-3: oklch(var(--lch-yellow-medium));
  --color-card-4: oklch(var(--lch-lime-medium));
  --color-card-5: oklch(var(--lch-aqua-medium));
  --color-card-6: oklch(var(--lch-violet-medium));
  --color-card-7: oklch(var(--lch-purple-medium));
  --color-card-8: oklch(var(--lch-pink-medium));
  /* Colors: Highlighter */
  --highlight-1: rgb(136, 118, 38);
  --highlight-2: rgb(185, 94, 6);
  --highlight-3: rgb(207, 0, 0);
  --highlight-4: rgb(216, 28, 170);
  --highlight-5: rgb(144, 19, 254);
  --highlight-6: rgb(5, 98, 185);
  --highlight-7: rgb(17, 138, 15);
  --highlight-8: rgb(148, 82, 22);
  --highlight-9: rgb(102, 102, 102);
  --highlight-bg-1: rgba(229, 223, 6, 0.3);
  --highlight-bg-2: rgba(255, 185, 87, 0.3);
  --highlight-bg-3: rgba(255, 118, 118, 0.3);
  --highlight-bg-4: rgba(248, 137, 216, 0.3);
  --highlight-bg-5: rgba(190, 165, 255, 0.3);
  --highlight-bg-6: rgba(124, 192, 252, 0.3);
  --highlight-bg-7: rgba(140, 255, 129, 0.3);
  --highlight-bg-8: rgba(221, 170, 123, 0.3);
  --highlight-bg-9: rgba(200, 200, 200, 0.3);
  /* Colors: Syntax highlighting */
  --color-code-token__att: oklch(var(--lch-blue-dark));
  --color-code-token__comment: oklch(var(--lch-ink-medium));
  --color-code-token__function: oklch(var(--lch-purple-dark));
  --color-code-token__operator: oklch(var(--lch-red-dark));
  --color-code-token__property: oklch(var(--lch-purple-dark));
  --color-code-token__punctuation: oklch(var(--lch-ink-dark));
  --color-code-token__selector: oklch(var(--lch-green-dark));
  --color-code-token__variable: oklch(var(--lch-red-dark));
  /* Colors: Generating gradient */
  --color-gradient-1: oklch(var(--lch-violet-lighter));
  --color-gradient-2: oklch(var(--lch-pink-lighter));
  --color-gradient-3: oklch(var(--lch-purple-lighter));
  --color-gradient-4: var(--color-canvas);
}
/* Dark mode - explicit theme choice overrides system preference */
html[data-theme="dark"] {
  --lch-canvas: 20% 0.0195 232.58;
  --lch-ink-inverted: var(--lch-black);
  --lch-ink-darkest: 96.02% 0.0034 260;
  --lch-ink-darker: 86% 0.0061 260;
  --lch-ink-dark: 73.97% 0.009 260;
  --lch-ink-medium: 62% 0.0122 260;
  --lch-ink-light: 40% 0.0148 260;
  --lch-ink-lighter: 30% 0.0178 260;
  --lch-ink-lightest: 25% 0.0204 260;
  --lch-uncolor-darkest: 96.09% 0.0076 100;
  --lch-uncolor-darker: 86% 0.021 90;
  --lch-uncolor-dark: 73.93% 0.041 80;
  --lch-uncolor-medium: 62% 0.0552 70;
  --lch-uncolor-light: 40% 0.0387 60;
  --lch-uncolor-lighter: 30% 0.012 50;
  --lch-uncolor-lightest: 25% 0.0017 40;
  --lch-red-darkest: 95.85% 0.0218 46;
  --lch-red-darker: 86% 0.086 44;
  --lch-red-dark: 73.95% 0.139 42;
  --lch-red-medium: 62% 0.154 40;
  --lch-red-light: 40% 0.088 38;
  --lch-red-lighter: 30% 0.032 36;
  --lch-red-lightest: 25% 0.011 34;
  --lch-yellow-darkest: 96% 0.056 100;
  --lch-yellow-darker: 86% 0.103 90;
  --lch-yellow-dark: 74.06% 0.136 80;
  --lch-yellow-medium: 62.1% 0.146 70;
  --lch-yellow-light: 40% 0.0736 60;
  --lch-yellow-lighter: 30% 0.026 50;
  --lch-yellow-lightest: 25% 0.01 40;
  --lch-lime-darkest: 96.04% 0.066 115;
  --lch-lime-darker: 86% 0.098 114;
  --lch-lime-dark: 73.97% 0.121 113;
  --lch-lime-medium: 62% 0.128 112;
  --lch-lime-light: 40% 0.0637 111;
  --lch-lime-lighter: 30% 0.024 110;
  --lch-lime-lightest: 25% 0.012 109;
  --lch-green-darkest: 96.12% 0.035 143;
  --lch-green-darker: 86% 0.082 144;
  --lch-green-dark: 73.99% 0.117 145;
  --lch-green-medium: 62% 0.1261 146;
  --lch-green-light: 40% 0.065 147;
  --lch-green-lighter: 30% 0.03 148;
  --lch-green-lightest: 25% 0.018 149;
  --lch-aqua-darkest: 96.15% 0.0244 202;
  --lch-aqua-darker: 86% 0.06 204;
  --lch-aqua-dark: 73.92% 0.095 206;
  --lch-aqua-medium: 62% 0.106 208;
  --lch-aqua-light: 40% 0.0594 210;
  --lch-aqua-lighter: 30% 0.028 212;
  --lch-aqua-lightest: 25% 0.017 214;
  --lch-blue-darkest: 95.93% 0.0217 252;
  --lch-blue-darker: 86% 0.068 254;
  --lch-blue-dark: 74% 0.1293 256;
  --lch-blue-medium: 62% 0.159 258;
  --lch-blue-light: 40% 0.094 260;
  --lch-blue-lighter: 30% 0.0452 262;
  --lch-blue-lightest: 25% 0.0318 264;
  --lch-violet-darkest: 95.97% 0.019 280;
  --lch-violet-darker: 86% 0.068 282;
  --lch-violet-dark: 74.08% 0.142 284;
  --lch-violet-medium: 62% 0.184 286;
  --lch-violet-light: 40% 0.108 288;
  --lch-violet-lighter: 30% 0.048 290;
  --lch-violet-lightest: 25% 0.025 292;
  --lch-purple-darkest: 95.99% 0.0217 302;
  --lch-purple-darker: 86% 0.068 304;
  --lch-purple-dark: 73.98% 0.141 306;
  --lch-purple-medium: 62% 0.177 308;
  --lch-purple-light: 40% 0.099 310;
  --lch-purple-lighter: 30% 0.04 312;
  --lch-purple-lightest: 25% 0.017 314;
  --lch-pink-darkest: 95.84% 0.0308 336;
  --lch-pink-darker: 86% 0.074 338;
  --lch-pink-dark: 74.04% 0.1294 340;
  --lch-pink-medium: 62% 0.166 342;
  --lch-pink-light: 40% 0.085 344;
  --lch-pink-lighter: 30% 0.03 346;
  --lch-pink-lightest: 25% 0.011 348;
  --color-terminal-bg: var(--color-canvas);
  --color-terminal-text-light: oklch(var(--lch-green-dark));
  --color-golden: oklch(var(--lch-blue-medium));
  --color-highlight: oklch(var(--lch-blue-lighter));
  --shadow: 0 0 0 1px oklch(var(--lch-black) / 0.42),
    0 0.2em 1.6em -0.8em oklch(var(--lch-black) / 0.6),
    0 0.4em 2.4em -1em oklch(var(--lch-black) / 0.7),
    0 0.4em 0.8em -1.2em oklch(var(--lch-black) / 0.8),
    0 0.8em 1.2em -1.6em oklch(var(--lch-black) / 0.9),
    0 1.2em 1.6em -2em oklch(var(--lch-black) / 1);
}
/* Fallback to system preference when no explicit theme is set */
@media (prefers-color-scheme: dark) {
  html:not([data-theme]) {
    --lch-canvas: 20% 0.0195 232.58;
    --lch-ink-inverted: var(--lch-black);
    --lch-ink-darkest: 96.02% 0.0034 260;
    --lch-ink-darker: 86% 0.0061 260;
    --lch-ink-dark: 73.97% 0.009 260;
    --lch-ink-medium: 62% 0.0122 260;
    --lch-ink-light: 40% 0.0148 260;
    --lch-ink-lighter: 30% 0.0178 260;
    --lch-ink-lightest: 25% 0.0204 260;
    --lch-uncolor-darkest: 96.09% 0.0076 100;
    --lch-uncolor-darker: 86% 0.021 90;
    --lch-uncolor-dark: 73.93% 0.041 80;
    --lch-uncolor-medium: 62% 0.0552 70;
    --lch-uncolor-light: 40% 0.0387 60;
    --lch-uncolor-lighter: 30% 0.012 50;
    --lch-uncolor-lightest: 25% 0.0017 40;
    --lch-red-darkest: 95.85% 0.0218 46;
    --lch-red-darker: 86% 0.086 44;
    --lch-red-dark: 73.95% 0.139 42;
    --lch-red-medium: 62% 0.154 40;
    --lch-red-light: 40% 0.088 38;
    --lch-red-lighter: 30% 0.032 36;
    --lch-red-lightest: 25% 0.011 34;
    --lch-yellow-darkest: 96% 0.056 100;
    --lch-yellow-darker: 86% 0.103 90;
    --lch-yellow-dark: 74.06% 0.136 80;
    --lch-yellow-medium: 62.1% 0.146 70;
    --lch-yellow-light: 40% 0.0736 60;
    --lch-yellow-lighter: 30% 0.026 50;
    --lch-yellow-lightest: 25% 0.01 40;
    --lch-lime-darkest: 96.04% 0.066 115;
    --lch-lime-darker: 86% 0.098 114;
    --lch-lime-dark: 73.97% 0.121 113;
    --lch-lime-medium: 62% 0.128 112;
    --lch-lime-light: 40% 0.0637 111;
    --lch-lime-lighter: 30% 0.024 110;
    --lch-lime-lightest: 25% 0.012 109;
    --lch-green-darkest: 96.12% 0.035 143;
    --lch-green-darker: 86% 0.082 144;
    --lch-green-dark: 73.99% 0.117 145;
    --lch-green-medium: 62% 0.1261 146;
    --lch-green-light: 40% 0.065 147;
    --lch-green-lighter: 30% 0.03 148;
    --lch-green-lightest: 25% 0.018 149;
    --lch-aqua-darkest: 96.15% 0.0244 202;
    --lch-aqua-darker: 86% 0.06 204;
    --lch-aqua-dark: 73.92% 0.095 206;
    --lch-aqua-medium: 62% 0.106 208;
    --lch-aqua-light: 40% 0.0594 210;
    --lch-aqua-lighter: 30% 0.028 212;
    --lch-aqua-lightest: 25% 0.017 214;
    --lch-blue-darkest: 95.93% 0.0217 252;
    --lch-blue-darker: 86% 0.068 254;
    --lch-blue-dark: 74% 0.1293 256;
    --lch-blue-medium: 62% 0.159 258;
    --lch-blue-light: 40% 0.094 260;
    --lch-blue-lighter: 30% 0.0452 262;
    --lch-blue-lightest: 25% 0.0318 264;
    --lch-violet-darkest: 95.97% 0.019 280;
    --lch-violet-darker: 86% 0.068 282;
    --lch-violet-dark: 74.08% 0.142 284;
    --lch-violet-medium: 62% 0.184 286;
    --lch-violet-light: 40% 0.108 288;
    --lch-violet-lighter: 30% 0.048 290;
    --lch-violet-lightest: 25% 0.025 292;
    --lch-purple-darkest: 95.99% 0.0217 302;
    --lch-purple-darker: 86% 0.068 304;
    --lch-purple-dark: 73.98% 0.141 306;
    --lch-purple-medium: 62% 0.177 308;
    --lch-purple-light: 40% 0.099 310;
    --lch-purple-lighter: 30% 0.04 312;
    --lch-purple-lightest: 25% 0.017 314;
    --lch-pink-darkest: 95.84% 0.0308 336;
    --lch-pink-darker: 86% 0.074 338;
    --lch-pink-dark: 74.04% 0.1294 340;
    --lch-pink-medium: 62% 0.166 342;
    --lch-pink-light: 40% 0.085 344;
    --lch-pink-lighter: 30% 0.03 346;
    --lch-pink-lightest: 25% 0.011 348;
    --color-terminal-bg: var(--color-canvas);
    --color-terminal-text-light: oklch(var(--lch-green-dark));
    --color-golden: oklch(var(--lch-blue-medium));
    --color-highlight: oklch(var(--lch-blue-lighter));
    --shadow: 0 0 0 1px oklch(var(--lch-black) / 0.42),
              0 .2em 1.6em -0.8em oklch(var(--lch-black) / 0.6),
              0 .4em 2.4em -1em oklch(var(--lch-black) / 0.7),
              0 .4em .8em -1.2em oklch(var(--lch-black) / 0.8),
              0 .8em 1.2em -1.6em oklch(var(--lch-black) / 0.9),
              0 1.2em 1.6em -2em oklch(var(--lch-black) / 1);
  }
}

================
File: app/assets/stylesheets/access-tokens.css
================
.access_tokens_table {
  border-collapse: collapse;
  inline-size: 100%;
  td, th {
    border-block-end: 1px solid var(--color-ink-light);
    padding-inline: var(--inline-space);
    text-align: start;
  }
  th {
    font-size: var(--text-x-small);
    text-transform: uppercase;
  }
  tr:nth-of-type(even) {
    background-color: var(--color-ink-lightest);
  }
}

================
File: app/assets/stylesheets/android.css
================
@layer platform {
  [data-platform~=android] {
    .hide-on-android {
      display: none;
    }
    /* Filters
    /* ------------------------------------------------------------------------ */
    .filters {
      --text-x-small: 1rem;
    }
  }
}

================
File: app/assets/stylesheets/animation.css
================
@layer utilities {
  .shake {
    animation: shake 400ms both;
  }
  @keyframes appear-then-fade {
    0%,100% { opacity: 0; }
    5%,60%  { opacity: 1; }
  }
  @keyframes gradient {
    0%   { background-position: 0% 50%; }
    50%  { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }
  @keyframes pulse {
    0%   { opacity: 1; }
    50%  { opacity: 0.4; }
    100% { opacity: 1; }
  }
  /* Keyframes */
  @keyframes react {
    0%   { transform: scale(0.85);  opacity: 0; }
    50%  { transform: scale(1.15); opacity: 1; }
    100% { transform: scale(1); }
  }
  @keyframes scale-fade-out {
    0%   { transform: scale(1); opacity: 1; }
    100% { transform: scale(0); opacity: 0; }
  }
  @keyframes shake {
    0%  { transform: translateX(-2rem); }
    25% { transform: translateX(2rem); }
    50% { transform: translateX(-1rem); }
    75% { transform: translateX(1rem); }
  }
  @keyframes slide-up {
    from { transform: translateY(2rem); }
    to   { transform: translateY(0); }
  }
  @keyframes slide-up-fade-in {
    from { transform: translateY(2rem); opacity: 0; }
    to   { transform: translateY(0); opacity: 1; }
  }
  @keyframes slide-down {
    from { transform: translateY(0); }
    to   { transform: translateY(2rem); }
  }
  @keyframes submitting {
    0%    { -webkit-mask-position: 0% 0%,   50% 0%,   100% 0% }
    12.5% { -webkit-mask-position: 0% 50%,  50% 0%,   100% 0% }
    25%   { -webkit-mask-position: 0% 100%, 50% 50%,  100% 0% }
    37.5% { -webkit-mask-position: 0% 100%, 50% 100%, 100% 50% }
    50%   { -webkit-mask-position: 0% 100%, 50% 100%, 100% 100% }
    62.5% { -webkit-mask-position: 0% 50%,  50% 100%, 100% 100% }
    75%   { -webkit-mask-position: 0% 0%,   50% 50%,  100% 100% }
    87.5% { -webkit-mask-position: 0% 0%,   50% 0%,   100% 50% }
    100%  { -webkit-mask-position: 0% 0%,   50% 0%,   100% 0% }
  }
  @keyframes success {
    0%  { background-color: var(--color-border-darker); scale: 0.8; }
    33% { background-color: var(--color-border-darker); scale: 1; }
  }
  @keyframes wiggle {
    0% { transform: rotate(0deg); }
    20% { transform: rotate(3deg); }
    40% { transform: rotate(-3deg); }
    60% { transform: rotate(3deg); }
    80% { transform: rotate(-3deg); }
    100% { transform: rotate(0deg); }
  }
  @keyframes wobble {
    0%  { transform: rotate(calc(var(--bubble-rotate) + 30deg)); }
    15% { border-radius: 66% 34% 72% 28% / 39% 63% 37% 61%; }
    25% { border-radius: 55% 47% 62% 40% / 58% 50% 52% 44%; }
    33% { border-radius: 46% 54% 61% 39% / 50% 51% 49% 50%; }
    50% { border-radius: 54% 46% 61% 39% / 57% 49% 51% 43%; }
    75% { border-radius: 53% 45% 60% 38% / 56% 48% 50% 42%; }
  }
  @keyframes zoom-fade {
    100% { transform: translateY(-1.5em); scale: 2; opacity: 0; }
  }
  @keyframes blink {
    50% {
      border-color: transparent;
    }
  }
}

================
File: app/assets/stylesheets/autoresize.css
================
@layer components {
  @supports not (field-sizing: content) {
    .autoresize__wrapper {
      display: grid !important;
      position: relative;
      > *, &::after {
        grid-area: 1 / 1 / 2 / 2;
      }
      &::after {
        content: attr(data-autoresize-clone-value) " ";
        font: inherit;
        line-height: inherit;
        padding-block: var(--autosize-block-padding, 0);
        visibility: hidden;
        white-space: pre-wrap;
      }
    }
    .autoresize__textarea {
      inset: 0;
      overflow: hidden;
      position: absolute;
      resize: none;
    }
  }
}

================
File: app/assets/stylesheets/avatars.css
================
@layer components {
  .avatar {
    --avatar-border-radius: 50%;
    --avatar-size-default: 5ch;
    --btn-border-size: 0;
    aspect-ratio: 1;
    block-size: var(--avatar-size, var(--avatar-size-default));
    border-radius: var(--avatar-border-radius);
    display: grid;
    flex-shrink: 0;
    inline-size: var(--avatar-size, var(--avatar-size-default));
    margin: 0;
    place-items: center;
    :is(img, .icon) {
      aspect-ratio: 1;
      block-size: 100%;
      border-radius: var(--avatar-border-radius);
      grid-area: 1/1;
      inline-size: 100%;
      max-inline-size: 100%;
      object-fit: cover;
    }
  }
  .avatar__form {
    display: grid;
    grid-template-columns: 1fr auto 1fr;
  }
}

================
File: app/assets/stylesheets/bar.css
================
@layer components {
  .bar {
    --row-gap: 0.2lh;
    background-color: var(--color-terminal-bg);
    block-size: calc(var(--footer-height) + env(safe-area-inset-bottom));
    color: var(--color-terminal-text);
    display: flex;
    flex-direction: column;
    font-size: 0.9em;
    inset: auto 0 0 0;
    max-block-size: 100%;
    padding-block: var(--block-space) calc(var(--block-space) + env(safe-area-inset-bottom));
    padding-inline:
      calc(var(--tray-size) + calc(var(--inline-space) * 3) + env(safe-area-inset-left))
      calc(var(--tray-size) + calc(var(--inline-space) * 3) + env(safe-area-inset-right));
    place-content: center;
    position: fixed;
    view-transition-name: bar;
    z-index: var(--z-bar);
    html[data-theme="dark"] & {
      border-block: 1px solid var(--color-ink-lighter);
    }
    @media (prefers-color-scheme: dark) {
      html:not([data-theme]) & {
        border-block: 1px solid var(--color-ink-lighter);
      }
    }
    &:has(.bar__placeholder[hidden]) {
      padding-inline: 1ch;
    }
  }
  ::view-transition-group(bar) {
    z-index: 99;
  }
  .bar__input {
    transform: translateY(50%);
    transition: transform 350ms cubic-bezier(0.25, 1.25, 0.5, 1);
    .bar:has(.bar__placeholder[hidden]) & {
      transform: translateY(0);
    }
  }
  .bar__modal {
    background-color: var(--color-terminal-bg);
    block-size: 75dvh;
    border-block: 1px solid var(--color-ink-lighter);
    inline-size: 100vw;
    inset: auto 0 0 0;
    max-inline-size: 100vw;
    margin-block-end: calc(var(--footer-height) - 0.3rem + env(safe-area-inset-bottom));
    position: fixed;
    z-index: -1;
    &:has(#bar-content[busy]), &:has(#bar-content:not([complete])), &:has([data-search-redirect]) {
      display: none;
    }
  }
  .bar__placeholder {
    .btn--plain {
      color: inherit;
      font-size: var(--text-x-small);
      font-weight: 600;
      opacity: 0.66;
      padding-inline: 1ch;
      text-transform: uppercase;
      white-space: nowrap;
      &:hover {
        color: oklch(var(--lch-blue-dark));
        opacity: 1;
      }
    }
  }
}

================
File: app/assets/stylesheets/base.css
================
@layer base {
  html {
    font-size: 100%;
    @media (min-width: 100ch) {
      font-size: 1.1875rem;
    }
  }
  body {
    -moz-osx-font-smoothing: grayscale;
    -webkit-font-smoothing: antialiased;
    -webkit-text-size-adjust: none;
    background: var(--color-canvas);
    color: var(--color-ink);
    font-family: var(--font-sans);
    interpolate-size: allow-keywords;
    line-height: 1.375;
    max-inline-size: 100vw;
    scroll-behavior: auto;
    text-rendering: optimizeLegibility;
    text-size-adjust: none;
  }
  a {
    text-decoration: none;
    &:not([class]) {
      color: var(--color-link);
      text-decoration: underline;
      text-decoration-skip-ink: auto;
    }
  }
  :is(a, button, input, textarea, .switch, .btn) {
    transition: 100ms ease-out;
    transition-property: background-color, border-color, box-shadow, filter, outline;
    touch-action: manipulation;
    /* Keyboard navigation */
    &:where(:focus-visible) {
      border-radius: 0.25ch;
      outline: var(--focus-ring-size) solid var(--focus-ring-color);
      outline-offset: var(--focus-ring-offset);
    }
    /* Default disabled styles */
    &:where([disabled]) {
      cursor: not-allowed;
      opacity: 0.5;
      pointer-events: none;
    }
  }
  ::selection {
    background: var(--color-selected);
    html[data-theme="dark"] & {
      background-color: var(--color-selected-dark);
    }
    @media (prefers-color-scheme: dark) {
      html:not([data-theme]) & {
        background-color: var(--color-selected-dark);
      }
    }
  }
  :where(ul, ol):where([role="list"]) {
    margin: 0;
    padding: 0;
    list-style: none;
  }
  kbd {
    border: 1px solid;
    border-radius: 0.3em;
    box-shadow: 0 0.1em 0 currentColor;
    font-family: var(--font-mono);
    font-size: 0.8em;
    font-weight: 600;
    opacity: 0.7;
    padding: 0 0.4em;
    text-transform: uppercase;
    vertical-align: middle;
    white-space: nowrap;
  }
  video {
    max-inline-size: 100%;
  }
  /* Printing */
  @page {
    margin: 1in;
  }
  @media print {
    .no-print {
      display: none;
    }
  }
  /* Turbo */
  turbo-frame,
  turbo-cable-stream-source {
    display: contents;
  }
  .turbo-progress-bar {
    visibility: hidden;
  }
  /* Nicer scrollbars on Chrome 29+. This is intended for Windows machines, but */
  /* there's not a way to target Windows using CSS, so Chrome on Mac will have */
  /* slightly thinner scrollbars than normal. #C1C1C1 is the default color on Macs. */
  @media screen and (-webkit-min-device-pixel-ratio:0) and (min-resolution:.001dpcm) {
    * {
      scrollbar-color: #C1C1C1 transparent;
      scrollbar-width: thin;
    }
  }
}

================
File: app/assets/stylesheets/blank-slates.css
================
/* Styles for the blank slate. To manage when they are shown/hidden, do so in context */
@layer components {
  .blank-slate {
    border-radius: 0.5ch;
    border: 2px dashed var(--color-ink-lighter);
    color: var(--color-ink-dark);
    font-weight: 500;
    margin-block-start: 2dvh;
    padding: 1.5ch 2ch;
    rotate: -3deg;
  }
  .blank-slate--drag {
    background-color: color-mix(in srgb, transparent, var(--card-color) 5%);
    border-color: color-mix(in srgb, transparent, var(--card-color) 10%);
    color: color-mix(in srgb, transparent, var(--card-color) 75%);
    margin-block-start: 0;
    rotate: 0deg;
  }
}

================
File: app/assets/stylesheets/bubble.css
================
@layer components {
  .bubble {
    --bubble-color: var(--card-color, oklch(var(--lch-blue-medium)));
    --bubble-number-max: 26px;
    --bubble-shape: 54% 46% 61% 39% / 57% 49% 51% 43%;
    --bubble-rotate: 0deg;
    --bubble-size-default: 4rem;
    block-size: var(--bubble-size, var(--bubble-size-default));
    color: var(--card-content-color);
    container-type: inline-size;
    font-size: 1.4rem;
    font-weight: bold;
    inline-size: var(--bubble-size, var(--bubble-size-default));
    inset-block-start: 20%;
    padding: 0.5cqi;
    position: absolute;
    z-index: 1;
    &:before {
      background: radial-gradient(
        color-mix(in srgb, var(--bubble-color) 8%, var(--color-canvas)) 50%,
        color-mix(in srgb, var(--bubble-color) 48%, var(--color-canvas)) 100%
      );
      border-radius: var(--bubble-shape);
      content: "";
      inset: 0;
      position: absolute;
      transform: rotate(var(--bubble-rotate));
      z-index: -1;
    }
    @media (any-hover: hover) {
      &:hover:before {
        animation: wobble 1200ms;
      }
    }
    svg {
      display: block;
      letter-spacing: 0.2ch;
      text-transform: uppercase;
    }
  }
  .bubble__number {
    display: grid;
    font-size: clamp(10px, 50cqi, var(--bubble-number-max)); /* FF bug: https://app.fizzy.do/5986089/boards/2/cards/1373 */
    font-weight: 900;
    inset: 0;
    place-content: center;
    position: absolute;
    text-align: center;
  }
}

================
File: app/assets/stylesheets/buttons.css
================
@layer components {
  .btn {
    --icon-size: var(--btn-icon-size, 1.3em);
    --btn-border-radius: 99rem;
    --btn-hover-brightness: 0.9;
    align-items: center;
    background-color: var(--btn-background, var(--color-canvas));
    border-radius: var(--btn-border-radius);
    border: var(--btn-border-size, 1px) solid var(--btn-border-color, var(--color-ink-light));
    color: var(--btn-color, var(--color-ink));
    cursor: pointer;
    display: inline-flex;
    font-size: 1em;
    font-weight: var(--btn-font-weight, 600);
    gap: var(--btn-gap, 0.5em);
    justify-content: center;
    padding: var(--btn-padding, 0.5em 1.1em);
    pointer-events: auto;
    position: relative;
    transition: 100ms ease-out;
    transition-property: background-color, border, box-shadow, color, filter, opacity, scale;
    @media (any-hover: hover) {
      &:hover {
        filter: brightness(var(--btn-hover-brightness));
      }
    }
    html[data-theme="dark"] & {
      --btn-hover-brightness: 1.25;
    }
    @media (prefers-color-scheme: dark) {
      html:not([data-theme]) & {
        --btn-hover-brightness: 1.25;
      }
    }
    &[disabled],
    &:has([disabled]),
    [disabled] &[type=submit],
    &[type=submit]:disabled {
      cursor: not-allowed;
      opacity: 0.3;
      pointer-events: none;
    }
    form[aria-busy] &:disabled {
      position: relative;
      > * {
        visibility: hidden;
      }
      &::after {
        --mask: no-repeat radial-gradient(#000 68%,#0000 71%);
        --size: 1.25em;
        -webkit-mask: var(--mask), var(--mask), var(--mask);
        -webkit-mask-size: 28% 45%;
        animation: submitting 1s infinite linear;
        aspect-ratio: 8/5;
        background: currentColor;
        content: "";
        inline-size: var(--size);
        inset: 50%;
        margin-block: calc((var(--size) / 3) * -1);
        margin-inline: calc((var(--size) / 2) * -1);
        position: absolute;
      }
    }
  }
  /* Variants
  /* ------------------------------------------------------------------------ */
  .btn--plain {
    --btn-background: transparent;
    --btn-border-radius: 0;
    --btn-border-size: 0;
    --btn-color: inherit;
    --btn-icon-size: 100%;
    --btn-padding: 0;
  }
  .btn--link {
    --btn-background: var(--color-link);
    --btn-border-color: var(--color-canvas);
    --btn-color: var(--color-ink-inverted);
    --focus-ring-color: var(--color-link);
  }
  .btn--circle,
  .btn[aria-label]:where(:has(.icon)),
  .btn:where(:has(.for-screen-reader):has(.icon)) {
    --btn-padding: 0;
    --icon-size: 75%;
    aspect-ratio: 1;
    block-size: var(--btn-size);
    display: grid;
    inline-size: var(--btn-size);
    justify-content: normal; /* FF fix */
    place-items: center;
    > * {
      grid-area: 1/1;
    }
  }
  /* Make a normal button circular on mobile */
  @media (max-width: 639px) {
    .btn--circle-mobile {
      --btn-size: 3em;
      --btn-padding: 0;
      --icon-size: 75%;
      aspect-ratio: 1;
      inline-size: var(--btn-size);
      kbd,
      span:last-of-type:not(.icon) {
        display: none;
      }
    }
  }
  @media (min-width: 640px) {
    .btn--circle-mobile .icon--mobile-only {
      display: none !important;
    }
  }
  .btn--negative {
    --btn-background: var(--color-negative);
    --btn-border-color: var(--color-negative);
    --btn-color: var(--color-ink-inverted);
    --focus-ring-color: var(--color-negative);
  }
  .btn--positive {
    --btn-background: var(--color-positive);
    --btn-border-color: var(--color-canvas);
    --btn-color: var(--color-ink-inverted);
    --focus-ring-color: var(--color-positive);
  }
  .btn--success {
    --success-timing-function: cubic-bezier(0.25, 1.25, 0.5, 1);
    animation: success 1s var(--success-timing-function);
    .icon {
      animation: zoom-fade 500ms var(--success-timing-function);
    }
  }
  /* Fake button used to help space things out */
  .btn--placeholder {
    pointer-events: none;
    visibility: hidden;
  }
  .btn--remove {
    --btn-icon-size: 0.7em;
  }
  .btn--reversed {
    --btn-background: var(--color-ink);
    --btn-border-color: var(--color-canvas);
    --btn-color: var(--color-canvas);
    --focus-ring-color: var(--color-ink);
  }
  /* Toggleable buttons
  /* ------------------------------------------------------------------------ */
  .btn {
    &:has(input[type=radio], input[type=checkbox]) {
      position: relative;
      :is(input[type=radio], input[type=checkbox]) {
        appearance: none;
        border-radius: var(--btn-border-radius);
        cursor: pointer;
        display: flex;
        inset: 0;
        margin: 0;
        padding: 0;
        position: absolute;
        &:focus-visible {
          outline: none;
        }
      }
      .checked {
        display: none;
      }
    }
    &:has(input:checked)  {
      --btn-background: var(--color-ink);
      --btn-border-color: var(--color-ink);
      --btn-color: var(--color-ink-inverted);
      --focus-ring-color: var(--color-ink);
      .checked {
        display: block;
      }
    }
    &:has(input:focus-visible)  {
      outline: var(--focus-ring-size) solid var(--focus-ring-color);
      outline-offset: var(--focus-ring-offset);
    }
  }
  .btn--back {
    --btn-border-size: 0;
    @media (max-width: 639px) {
      strong, kbd {
        display: none;
      }
    }
    @media (min-width: 640px) {
      font-size: var(--text-medium);
      .icon--arrow-left {
        display: none;
      }
    }
  }
  /* Button groups
  /* ------------------------------------------------------------------------ */
  .btn__group {
    .btn {
      --btn-border-radius: 0;
      --radius: 0.3em;
      flex: 1 0 33%;
      inline-size: 100%;
      justify-content: center;
      white-space: nowrap;
    }
    form {
      flex: 1 1 0%;
    }
    :first-of-type .btn {
      border-end-start-radius: var(--radius);
      border-inline-end: 0;
      border-start-start-radius: var(--radius);
      padding-inline-end: 0.8em;
    }
    :last-of-type .btn {
      border-end-end-radius: var(--radius);
      border-inline-start: 0;
      border-start-end-radius: var(--radius);
      padding-inline-start: 0.8em;
    }
    span {
      inline-size: 100%;
    }
  }
}

================
File: app/assets/stylesheets/card-columns.css
================
@layer components {
  /* Layout adjustments for contained scrolling
  /* ------------------------------------------------------------------------ */
  /* Scroll columns individually on mobile */
  @media (max-width: 639px) {
    body.contained-scrolling {
      block-size: 100dvh;
      grid-template-rows: 1fr var(--footer-height);
      #global-container {
        display: grid;
        grid-template-rows: auto 1fr;
        overflow: hidden;
      }
      #main {
        display: grid;
        grid-template-rows: auto auto 1fr;
        overflow: auto;
        padding: 0;
      }
      /* Adapt the grid to public views (no filters or watchers sections) */
      &.public #main {
        grid-template-rows: 1fr;
      }
    }
  }
  /* Column container
  /* ------------------------------------------------------------------------ */
  #main:has(.card-columns) {
    --main-padding: 0;
  }
  .card-columns {
    --bubble-size: 3.5rem;
    --cards-gap: min(1.2cqi, 1.7rem);
    --column-gap: 8px;
    --column-padding: calc(var(--column-gap) * 2);
    --column-transition-duration: 300ms;
    --column-width-collapsed: 40px;
    --column-width-expanded: 450px;
    --progress-increment: var(--progress-max-height) / var(--progress-max-cards);
    --progress-max-cards: 15; /* should match first geared pagination page size */
    --progress-max-height: 50dvh;
    container-type: inline-size;
    display: grid;
    gap: var(--column-gap);
    grid-template-columns: 1fr auto 1fr;
    inline-size: 100%;
    margin-inline: auto;
    max-inline-size: var(--main-width);
    outline: none;
    overflow-x: auto;
    overflow-y: hidden;
    position: relative;
    /* When it has something expanded */
    &:has(.card-columns__left .is-expanded, .card-columns__right .is-expanded) {
      grid-template-columns: auto auto auto;
      @media (min-width: 640px) {
        grid-template-columns: auto var(--column-width-expanded) auto;
      }
    }
    &:has(.cards) {
      block-size: 100%;
      min-block-size: 20lh;
    }
    @media (max-width: 639px) {
      --column-width-expanded: calc(100vw - var(--column-gap) * 4);
      scroll-snap-type: inline mandatory;
      &:not(:has(.is-expanded)) {
        grid-template-columns: auto var(--column-width-collapsed) auto;
      }
    }
    @media (min-width: 640px) {
      padding-block-end: var(--column-width-collapsed);
    }
  }
  .card-columns__left,
  .card-columns__right {
    align-items: stretch;
    display: flex;
    gap: var(--column-gap);
    position: relative;
    @media (max-width: 639px) {
      min-block-size: 0;
    }
  }
  .card-columns__left {
    justify-content: end;
    margin-inline-start: auto;
    padding-inline-start: var(--column-gap);
    @media (max-width: 639px) {
      padding-inline-start: calc(var(--column-gap) * 2);
    }
  }
  .card-columns__right {
    justify-content: start;
    padding-inline-end: var(--column-gap);
    margin-inline-end: auto;
  }
  /* Column
  /* ------------------------------------------------------------------------ */
  .cards {
    --column-color: color-mix(in srgb, var(--card-color) 15%, var(--color-canvas));
    inline-size: var(--column-width-expanded);
    outline: none;
    position: relative;
    scroll-snap-align: center;
    &.is-expanded {
      @media (max-width: 639px) {
        overflow: hidden;
      }
    }
    &.is-collapsed {
      inline-size: var(--column-width-collapsed);
      .pagination-link.pagination-link--active-when-observed,
      .card {
        display: none;
      }
    }
    &.drag-and-drop__hover-container {
      --dnd-bg-color: transparent;
      --dnd-border-color: transparent;
      &.is-off-screen {
        &:after {
          content: attr(data-column-name);
          font-size: var(--text-x-small);
          font-weight: 500;
          line-height: var(--column-width-collapsed);
          padding-inline: 1ch;
          position: fixed;
          text-transform: uppercase;
          top: 0;
          translate: -50%;
        }
        &.is-collapsed {
          &:after {
            writing-mode: vertical-rl;
          }
        }
        &:not(.is-collapsed) {
          &:after {
            background-color: var(--column-color);
            inline-size: calc(var(--column-width-expanded) - 4px); /* make room for the dnd border */
          }
        }
      }
    }
    @media (any-hover: hover) {
      .card:has(.card__background img:not([src=""])):hover .card__background img:not([src=""]) {
        filter: blur(3px) brightness(1.2);
        opacity: 0.2;
      }
    }
  }
  .cards__transition-container {
    block-size: 100%;
    border-radius: calc(var(--column-width-collapsed) / 2);
    translate: 0 0.5ch; /* Allow a little room for the mini bubble */
    transition: translate var(--column-transition-duration) var(--ease-out-overshoot-subtle);
    @media (min-width: 640px) {
      .is-expanded & {
        translate: 0 0.5ch; /* Allow a little room for the mini bubble */
      }
      .is-collapsed & {
        translate: 0 var(--column-width-collapsed);
      }
    }
    .drag-and-drop__hover-container & {
      --dnd-bg-color: var(--column-color);
      --dnd-border-color: var(--card-color);
      background-color: var(--dnd-bg-color);
      outline: 2px dashed var(--dnd-border-color);
      outline-offset: -2px;
      transition: background-color 200ms;
      z-index: 1;
    }
    .no-transitions & {
      transition: none;
    }
    /* Use flex so the __list container can take up the remaining space for scrolling */
    @media (max-width: 639px) {
      .is-expanded & {
        display: flex;
        flex-direction: column;
      }
    }
  }
  /* The wrapper around the cards used to clip overflow while transitioning.
   * Also, don't resize cards while transitioning to avoid reflow. */
  .cards__list {
    display: flex;
    flex-direction: column;
    gap: var(--cards-gap);
    overflow-x: hidden;
    overflow-y: auto;
    .is-expanded & {
      padding: var(--column-padding) var(--column-padding) calc(var(--column-padding) + var(--custom-safe-inset-bottom));
      /* Use the rest of the column height for scrolling */
      @media (max-width: 639px) {
        flex: 1;
        padding-inline: calc(var(--column-padding) / 4);
      }
    }
    [aria-selected] & .card[aria-selected] {
      outline: var(--focus-ring-size) solid var(--color-selected-dark);
      outline-offset: var(--focus-ring-offset);
      html[data-theme="dark"] & {
        outline-color: oklch(var(--lch-blue-medium));
      }
      @media (prefers-color-scheme: dark) {
        html:not([data-theme]) & {
          outline-color: oklch(var(--lch-blue-medium));
        }
      }
    }
    &:has(.card) {
      .blank-slate {
        display: none;
      }
    }
    /* Use the default blank-slate on small viewports since drag-and-drop isn't available */
    [data-controller~="drag-and-drop"] & {
      @media (max-width: 639px) {
        .blank-slate--drag {
          display: none;
        }
      }
      @media (min-width: 640px) {
        .blank-slate--default {
          display: none;
        }
      }
    }
  }
  .cards__new-column {
    position: relative;
    @media (max-width: 639px) {
      inset-inline-end: 0;
      position: absolute;
      translate: 100%;
    }
    @media (min-width: 640px) {
      margin-block-start: var(--column-width-collapsed);
    }
  }
  /* Cards grid; used when filtering
  /* -------------------------------------------------------------------------- */
  .cards--grid {
    --cards-gap: 1rem;
    --card-grid-columns: 1;
    container-type: inline-size;
    inline-size: 100%;
    margin-inline: auto;
    max-inline-size: var(--main-width);
    @media (min-width: 640px) {
      --card-grid-columns: 2;
    }
    @media (min-width: 960px) {
      --card-grid-columns: 3;
    }
    .cards__list {
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      gap: var(--cards-gap);
      justify-content: center;
      padding: 1ch;
    }
    .card {
      inline-size: calc((100% - var(--cards-gap) * (var(--card-grid-columns) - 1) ) / var(--card-grid-columns));
    }
    .card__header .card__column-name--current {
      --btn-padding: 0.1em 0.5em;
      background: none;
      border: 1px solid currentColor;
      color: var(--card-color);
      display: inline-flex;
      flex: 0 1 auto;
      inline-size: fit-content;
      margin: 0 0 0 auto;
    }
    .blank-slate--drag {
      display: none;
    }
  }
  /* Column Elements
  /* ------------------------------------------------------------------------ */
  .cards__header {
    .cards.is-collapsed & {
      block-size: 100%;
    }
    .cards.is-expanded & {
      display: grid;
      grid-template-areas: "menu expander maximize";
      grid-template-columns: var(--column-width-collapsed) 1fr var(--column-width-collapsed);
      padding-inline: var(--column-padding);
    }
  }
  .cards__menu .btn--circle,
  .cards__maximize-button {
    --btn-background: transparent;
    block-size: var(--column-width-collapsed);
    inline-size: var(--column-width-collapsed);
    opacity: 0;
    outline-offset: -2px;
    .cards:hover &,
    &:focus-visible {
      opacity: 1;
    }
    .cards.is-collapsed & {
      display: none;
    }
  }
  .cards__menu {
    position: relative;
    z-index: var(--z-popup);
  }
  .cards__maximize-button {
    grid-area: maximize;
  }
  .cards__expander {
    --gradient-direction: to bottom;
    align-items: center;
    border-radius: 99rem;
    cursor: pointer;
    display: flex;
    flex-direction: row-reverse;
    font-size: var(--text-x-small);
    font-weight: 600;
    gap: 0.5ch;
    grid-area: expander;
    justify-content: center;
    outline: none;
    outline-offset: -2px;
    position: relative;
    text-transform: uppercase;
    &[disabled] {
      opacity: 1;
    }
    @media (any-hover: hover) {
      .is-collapsed:hover {
        filter: brightness(0.9);
      }
    }
    /* Progress */
    &:after {
      background: linear-gradient(var(--gradient-direction), var(--card-color), var(--column-color) 80%);
      block-size: var(--column-width-collapsed);
      border-radius: 99rem;
      content: "";
      inset: 0 0 auto;
      margin-inline: auto;
      max-block-size: var(--progress-max-height);
      min-block-size: var(--column-width-collapsed);
      opacity: 0;
      position: absolute;
      transition:
        block-size 500ms var(--ease-out-overshoot),
        inline-size var(--column-transition-duration) ease-out,
        opacity var(--column-transition-duration) ease-out;
      z-index: -1;
    }
    .no-transitions &:after {
      transition: none;
    }
    .cards.is-collapsed & {
      block-size: 100%;
      flex-direction: column;
      inline-size: var(--column-width-collapsed);
      justify-content: start;
      letter-spacing: 0.05em;
      /* Guitar string */
      &:before {
        background-color: var(--column-color);
        block-size: 100%;
        content: "";
        inline-size: 1px;
        inset-block: calc(var(--column-width-collapsed) + var(--card-count) * var(--progress-increment)) 0;
        position: absolute;
        z-index: -2;
      }
      &:after {
        block-size: calc(var(--column-width-collapsed) + var(--card-count) * var(--progress-increment));
        max-block-size: none;
        opacity: 1;
        inline-size: var(--column-width-collapsed);
      }
    }
    .cards.is-expanded & {
      inline-size: 100%;
      justify-content: center;
    }
  }
  .cards__expander-count {
    line-height: var(--column-width-collapsed);
    inline-size: var(--column-width-collapsed);
    .cards.is-expanded & {
      display: none;
    }
  }
  .cards__expander-title {
    font-weight: inherit;
    font-size: inherit;
    line-height: var(--column-width-collapsed);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    .cards.is-collapsed & {
      max-inline-size: 50vh;
      writing-mode: vertical-rl;
    }
    .cards.is-expanded & {
      align-items: center;
      display: flex;
      gap: 0.25ch;
      max-inline-size: calc(100% - var(--column-width-collapsed) * 2);
    }
    .icon--collapse {
    --icon-size: 1.15em;
      opacity: 0.66;
      transition: 150ms ease-out;
      transition-property: opacity, scale;
      @media (min-width: 640px) {
        opacity: 0;
        scale: 1.5;
      }
      .cards.is-collapsed & {
        display: none;
      }
      .cards.is-expanded .cards__expander:hover & {
        opacity: 0.66;
        scale: 1;
      }
    }
  }
  /* Override card styles within columns
  /* Adding .board-tools here since it sits outside the cards container on mobile */
  /* ------------------------------------------------------------------------ */
  .cards .card,
  .board-tools {
    --block-space: 1em;
    --block-space-half: 0.5em;
    --card-padding-inline: 1em;
    --text-xx-large: 1.6em;
    --text-x-small: 1em;
    /* Set lower limit for font size */
    font-size: clamp(0.6rem, 0.85cqi, 100px);
    .card__counts {
      --gap: 0.5ch;
      align-items: flex-end;
      display: flex;
      flex-shrink: 0;
      gap: calc(2 * var(--gap));
      margin-inline: auto calc(var(--card-padding-inline) * -0.5);
      padding-inline-start: var(--gap);
    }
    .card__boosts,
    .card__comments {
      --icon-size: 1.6em;
      align-items: center;
      display: flex;
      flex-shrink: 0;
      font-weight: 600;
      gap: var(--gap);
      img {
        block-size: var(--icon-size);
        inline-size: var(--icon-size);
      }
      .icon--comment {
        color: var(--card-color);
      }
    }
    .card__steps {
      --column-gap: 0.8ch;
      display: flex;
    }
    .card__tags {
      gap: calc(var(--card-header-space) / 2);
    }
    .card__title {
      pointer-events: none;
    }
    .card__link {
      z-index: 1;
    }
    .card__stages,
    .card__hide-on-index {
      display: none;
    }
    .card__body {
      padding-block: calc(var(--card-padding-block) * 0.75) var(--card-padding-block);
    }
    .card__meta {
      font-weight: 600;
      strong,
      .local-time-value {
        font-weight: inherit;
      }
      @media (max-width: 639px) {
        inline-size: auto;
      }
    }
    &:has(.card__background img:not([src=""])) {
      .card__content,
      .card__meta,
      .card__boosts,
      .card__comments,
      .card__column-name:not(.card__column-name--current) {
        opacity: 0;
        transition: opacity 0.2s ease-in-out;
      }
      @media (any-hover: hover) {
        &:hover {
          .card__content,
          .card__footer,
          .card__boosts,
          .card__comments,
          .card__column-name:not(.card__column-name--current) {
            opacity: 1;
          }
          .card__background img {
            filter: blur(3px) brightness(1.2);
            opacity: 0.2;
          }
        }
      }
    }
    .bubble {
      inset-inline-start: 100%;
      translate: -90% -40%;
    }
  }
  /* Considering
  /* ------------------------------------------------------------------------ */
  .cards--maybe {
    --card-color: oklch(var(--lch-blue-medium));
    position: relative;
    .card {
      --avatar-size: 2.75em;
      --text-small: 1.1em;
      background-color: var(--color-canvas);
      line-height: 1.2;
      z-index: 2;
      @media (min-width: 640px) {
        --text-xx-large: 1.6em;
      }
    }
    .card__board {
      background-color: transparent;
      color: var(--card-content-color);
    }
    .card__header {
      color: var(--color-ink);
      padding-block-start: calc(var(--card-padding-block) / 2);
    }
    .card__tags {
      color: inherit;
    }
    .card__body {
      padding-block: 0 var(--card-padding-block);
    }
    .card__people-label {
      display: none;
    }
    .card__title {
      min-block-size: 0;
    }
  }
  /* Board tools
  /* -------------------------------------------------------------------------- */
  .board-tools.card {
    --border-color: var(--color-selected-dark);
    --border-size: 1px;
    --card-padding-block: var(--block-space);
    border: 1px solid var(--border-color);
    inline-size: auto;
    text-align: center;
    @media (max-width: 639px) {
      /* On mobile, hide the tool card inside the Maybe column */
      .cards & {
        display: none;
      }
      #cards_container > & {
        margin: 0 3ch 1ch;
      }
    }
    @media (min-width: 640px) {
      /* On desktop, hide the tool card above the columns */
      #cards_container > & {
        display: none;
      }
    }
    @media (min-width: 800px) {
      margin: var(--column-padding) var(--column-padding) 0;
    }
    &:has(dialog[open]) {
      z-index: 5;
    }
    .divider {
      --divider-color: oklch(var(--lch-blue-light));
    }
    .btn--link {
      font-size: 1.2em;
    }
    .btn:not(.btn--link, .btn--circle) {
      border: 0;
      color: var(--color-link);
    }
    footer {
      font-size: var(--text-x-small);
      margin-block: 1ch calc(var(--block-space-half) * -1);
    }
    .overflow-count {
      font-size: 1.2em;
      font-weight: 500;
      padding: 0.5em 0.3em;
    }
  }
  .board-tools__watching {
    --btn-size: 32px;
    --gap: 0.5ch;
    display: flex;
    gap: var(--gap);
    inline-size: 100%;
    margin-block: var(--block-space-half);
    place-content: center;
    position: relative;
  }
  .board-tools__watching-dialog {
    --panel-padding: 2ch;
    --panel-size: 100%;
    display: flex;
    flex-wrap: wrap;
    gap: var(--gap);
    inset-block-start: 0;
    justify-content: center;
    position: absolute;
    z-index: 1;
  }
  /* On Deck (Not Now)
  /* ------------------------------------------------------------------------ */
  .cards--closed,
  .cards--on-deck {
    --card-color: var(--color-ink-light) !important;
    .card,
    .blank-slate {
      --card-color: var(--color-card-complete) !important;
    }
    .bubble {
      display: none !important;
    }
  }
  /* Doing
  /* -------------------------------------------------------------------------- */
  /* Surface a mini bubble if there are cards with bubbles inside */
  .cards--maybe:has(.bubble:not([hidden])) .cards__expander-title,
  .cards--maybe.is-collapsed:has(.bubble:not([hidden])) .cards__transition-container,
  .cards--doing.is-collapsed:has(.bubble:not([hidden])) .cards__transition-container {
    --bubble-color: var(--card-color, oklch(var(--lch-blue-medium)));
    --bubble-opacity: 75%;
    --bubble-shape: 54% 46% 61% 39% / 57% 49% 51% 43%;
    &:before {
      background: radial-gradient(
        color-mix(in srgb, var(--bubble-color) calc(var(--bubble-opacity) / 5), var(--color-canvas)) 50%,
        color-mix(in srgb, var(--bubble-color) var(--bubble-opacity), var(--color-canvas)) 100%
      );
      block-size: 1em;
      border-radius: var(--bubble-shape);
      content: "";
      inline-size: 1em;
      inset: 0 0 auto auto;
      position: absolute;
      translate: 20% -20%;
      z-index: 1;
    }
    /* Maybe column: position bubble relative to the title, not the container */
    .cards--maybe.is-expanded & {
      overflow: visible;
      position: relative;
      &:before {
        inset-block-start: 50%;
        inset-inline-start: 0;
        translate: -125% -75%;
        z-index: -1;
      }
    }
    @media (max-width: 639px) {
      &.cards__expander-title:before {
        display: none;
      }
    }
    html[data-theme="dark"] & {
      --bubble-opacity: 100%;
    }
    @media (prefers-color-scheme: dark) {
      html:not([data-theme]) & {
        --bubble-opacity: 100%;
      }
    }
  }
  /* Card column indicators
  /* -------------------------------------------------------------------------- */
  .card__column-name {
    --btn-background: transparent;
    --btn-padding: 0.2em 0.5em;
    --btn-border-size: 0;
    --btn-border-radius: 0.2em;
    color: inherit;
    inline-size: 100%;
    justify-content: flex-start;
    text-transform: uppercase;
    @media (hover: hover) {
      &:not(.card__column-name--current):hover {
        --btn-background: color(from var(--column-color) srgb r g b / 0.15);
        color: var(--column-color);
      }
    }
  }
  .card__column-name--current {
    --btn-background: var(--card-color);
    color: var(--color-ink-inverted);
    opacity: 1 !important;
    @media (hover: hover) {
      &:hover {
        --btn-background: var(--card-color);
      }
    }
  }
}

================
File: app/assets/stylesheets/card-perma.css
================
/* Card container for the perma. Tools and actions and whatnot */
@layer components {
  .card-perma {
    --actions-block-inset: 1.5rem;
    --actions-inline-inset: 4rem;
    --color-container: color-mix(in srgb, var(--card-color) 33%, var(--color-canvas));
    --half-btn-height: 1.25rem;
    --padding-inline: calc(var(--block-space-double) + var(--block-space));
    --padding-block: calc(var(--block-space-double) + var(--block-space-half));
    align-items: start;
    column-gap: var(--inline-space);
    display: grid;
    grid-template-areas:
      "notch-top notch-top notch-top"
      "actions-left card actions-right"
      "notch-bottom notch-bottom notch-bottom"
      "closure-message closure-message closure-message";
    grid-template-columns: 48px minmax(0, 1120px) 48px;
    inline-size: fit-content;
    margin-block-start: var(--block-space);
    max-inline-size: 100%;
    margin-inline: auto;
    position: relative;
    &:has(dialog[open]) {
      z-index: 3;
    }
    &:has(.card-perma__star-input:checked) {
      .card {
        outline: 4px solid var(--color-negative);
      }
    }
    @media (max-width: 799px) {
      --half-btn-height: 1.25rem;
      --padding-inline: 1.5ch;
      column-gap: 0;
      grid-template-areas:
        "notch-top notch-top notch-top"
        "card card card"
        "actions-left notch-bottom actions-right"
        "closure-message closure-message closure-message";
      grid-template-columns: 1fr auto 1fr;
      inline-size: calc(100% + 2 * var(--padding-inline));
      margin-inline: calc(-1 * var(--padding-inline));
      max-inline-size: none;
      position: relative;
    }
    .card {
      --card-aspect-ratio: 2 / 0.95;
      --lexxy-bg-color: var(--card-bg-color);
      border: none;
    }
    .card__background {
      filter: brightness(1.2) contrast(0.8);
      opacity: 0.2;
    }
    .card__body {
      position: relative;
      @media (max-width: 639px) {
        flex-direction: column;
        padding-block-end: calc(var(--card-padding-block) * 1.5);
      }
    }
    .card__content {
      display: flex;
      flex-direction: column;
      gap: 1ch;
    }
    .card__title {
      font-size: clamp(var(--text-medium), 6vw, var(--text-x-large));
      margin-block-end: 0.5ch;
      /* With tight line spacing, Windows will cover over adjacent lines of text
      * when input text is selected. Here, we're setting the selection color to a
      * transparent value so the overlapping text lines are at least visible. */
      ::selection {
        background: oklch(var(--lch-blue-light) / 0.5);
      }
      &:has(textarea) {
        margin-block-end: 0;
        @supports not (field-sizing: content) {
          text-wrap: unset; /* Safari is annoying if you have text-wrap: balance in textareas */
        }
      }
    }
    .card__meta,
    .card__stages {
      @media (min-width: 640px) {
        font-size: var(--text-small);
      }
    }
    .card__meta {
      grid-area: meta;
      margin-inline-end: auto;
    }
    .card__stages {
      max-inline-size: 32ch;
      @media (max-width: 639px) {
        border: 1px solid var(--card-color);
        border-radius: 0.25em;
        flex-direction: row;
        gap: 0;
        overflow: auto;
        max-inline-size: 100%;
        padding: 0;
        position: relative;
        white-space: nowrap;
        & > form {
          flex-grow: 1;
          max-inline-size: 25ch;
          min-block-size: 2.5em;
        }
        & > form + form:not(:has(.card__column-name--current)) {
          box-shadow: -1px 0 0 0 var(--color-container);
        }
      }
    }
    .card__column-name {
      @media (max-width: 639px) {
        --btn-border-radius: 0;
        justify-content: center;
      }
    }
    .card__footer {
      --btn-size: 2.5rem;
      display: flex;
      gap: 0.5ch;
      inline-size: 100%;
      text-align: start;
      /* Switch to grid layout so that the bg zoom button can stay next to the
       * meta element, and the reactions can sit below */
      &:has(.reaction) {
        display: grid;
        grid-template-columns: 1fr auto;
        grid-template-areas:
          "meta bg-zoom"
          "reactions reactions";
      }
      @media (max-width: 639px) {
        font-size: var(--text-x-small);
      }
    }
    .reactions {
      --reaction-size: var(--btn-size);
      align-self: flex-end;
      display: flex;
      gap: 0.5ch;
      grid-area: reactions;
      margin-inline-start: auto;
      &:has(.reaction) {
        --padding: calc(var(--card-padding-block) / 2);
        --reaction-size: 1.6875rem;
        margin-block: var(--padding) calc(-1 * var(--padding));
        padding-block-start: var(--padding);
        position: relative;
        &:before {
          border-block-start: 1px dashed color-mix(in srgb, transparent, var(--card-color) 33%);
          content: "";
          inset: 0 calc(-1 * var(--card-padding-inline)) auto;
          position: absolute;
        }
      }
      &:not(:has(.reaction)) {
        position: static;
        .reactions__trigger {
          --btn-border-color: var(--color-ink-light);
        }
      }
    }
    .reaction__popup.popup {
      inline-size: max-content;
    }
    .card__zoom-bg-btn {
      grid-area: bg-zoom;
    }
    .bubble {
      --bubble-number-max: 42px;
      --bubble-size: 6rem;
      inset: calc(var(--bubble-size) / -4) calc(var(--bubble-size) / 1.5) auto auto;
      translate: 0 0;
      @media (max-width: 799px) {
        --bubble-size: 4.5rem;
        inset: calc(var(--bubble-size) / 1.5) 0 auto auto;
      }
    }
  }
  /* Child items
  /* ------------------------------------------------------------------------ */
  .card-perma__bg {
    background-color: var(--color-container);
    border-radius: 0.2em;
    grid-area: card;
    padding: clamp(2rem, 4vw, var(--padding-block));
    @media (max-width: 639px) {
      padding: clamp(0.25rem, 2vw, var(--padding-block));
      padding-block-end: clamp(2.5rem, 4vw, var(--padding-block));
    }
    @media (min-width: 640px) and (max-width: 799px) {
      padding-inline: var(--padding-inline);
    }
  }
  .card-perma__actions {
    display: grid;
    gap: var(--block-space-half);
    &:has([open]) {
      position: relative;
      z-index: 1;
    }
    &:has([data-controller~="tooltip"]:hover) {
      z-index: var(--z-tooltip);
    }
  }
  .card-perma__actions--left { grid-area: actions-left; }
  .card-perma__actions--right { grid-area: actions-right; }
  @media (max-width: 799px) {
    .card-perma__actions {
      display: flex;
      padding-inline: var(--padding-inline);
      translate: 0 -50%;
    }
    .card-perma__actions--right {
      inset-inline-end: 0;
      justify-content: flex-end;
    }
  }
  .card-perma__image-btn {
    &:has(input[type="file"]:focus),
    &:has(input[type="file"]:focus-visible) {
      outline: var(--focus-ring) !important;
      outline-offset: var(--focus-ring-offset);
    }
    input[type="file"] {
      outline: none;
    }
  }
  .card__banner {
    align-items: center;
    background-color: var(--color-highlight);
    border-radius: 2em;
    color: color-mix(in srgb, var(--card-color) 40%, var(--color-ink));
    display: inline-flex;
    inline-size: auto;
    gap: var(--inline-space-half);
    grid-area: notch-top;
    justify-content: center;
    margin-block-start: -4ch;
    margin-inline: auto;
    max-inline-size: 36ch;
    padding: var(--block-space-half) var(--block-space);
    position: relative;
    text-align: center;
    translate: 0 50%;
    z-index: 0;
    .btn {
      --btn-background: var(--card-color);
      --btn-border-color: var(--card-color);
      --btn-color: var(--color-ink-inverted);
    }
  }
  /* Notches
  /* -------------------------------------------------------------------------- */
  .card-perma__notch {
    align-items: center;
    color: color-mix(in srgb, var(--card-color) 40%, var(--color-ink));
    display: inline-flex;
    inline-size: auto;
    gap: var(--inline-space);
    justify-content: center;
    margin-inline: auto;
    position: relative;
    text-align: center;
    z-index: 0;
  }
  .card-perma__notch--top {
    grid-area: notch-top;
    inline-size: 100%;
    margin-block-start: -4ch;
    max-inline-size: 36ch;
    padding-inline: 1ch;
    translate: 0 50%;
    .btn {
      --btn-border-color: var(--card-color);
      --btn-color: var(--card-color);
      text-align: center;
      &:has(input:checked)  {
        --btn-background: var(--card-color);
        --btn-border-color: var(--card-color);
        --btn-color: var(--color-ink-inverted);
      }
    }
  }
  .card-perma__notch--bottom {
    grid-area: notch-bottom;
    /* Overlap the card BG by half the button height */
    &:has(.btn) {
      translate: 0 calc(-1 * var(--half-btn-height));
    }
    form {
      background-color: var(--color-canvas);
      border-radius: 99rem;
    }
    .btn:not(.popup__btn, .btn--plain, .btn--reversed, .settings-subscription__button) {
      --btn-background: var(--card-color);
      --btn-color: var(--color-ink-inverted);
    }
    .btn--reversed {
      --btn-background: var(--color-canvas);
      --btn-color: var(--card-color);
      --btn-border-color: var(--color-container);
    }
    @media (max-width: 639px) {
      flex-direction: column;
    }
  }
  .card-perma__notch-new-card-buttons {
    display: flex;
    gap: var(--inline-space-half);
    @media (max-width: 479px) {
      flex-direction: column;
      .btn {
        inline-size: 100%;
      }
    }
  }
  .card-perma__closure-message {
    color: var(--card-color);
    grid-area: closure-message;
    margin-block: var(--block-space) var(--block-space-double);
    padding-inline: 1ch;
    .btn--plain {
      --btn-color: var(--card-color);
      text-decoration: underline;
    }
    @media (max-width: 799px) {
      margin-block: var(--block-space-half);
      translate: 0 calc(-0.5 * var(--half-btn-height));
    }
    @media (min-width: 800px) {
      .card-perma__notch--bottom:has(.btn) ~ & {
        margin-block: var(--block-space-half) var(--block-space);
        translate: 0 calc(-0.5 * var(--half-btn-height));
      }
    }
  }
}

================
File: app/assets/stylesheets/cards.css
================
@layer components {
  /* Base
  /* ------------------------------------------------------------------------ */
  .card {
    --avatar-size: 2.75em;
    --card-bg-color: color-mix(in srgb, var(--card-color) 4%, var(--color-canvas));
    --card-content-color: color-mix(in srgb, var(--card-color) 30%, var(--color-ink));
    --card-text-color: color-mix(in srgb, var(--card-color) 75%, var(--color-ink));
    --card-border: 1px solid color-mix(in srgb, var(--card-color) 33%, var(--color-ink-inverted));
    --card-header-space: 1ch;
    --card-padding-inline: var(--inline-space-double);
    --card-padding-block: var(--block-space);
    --border-color: transparent;
    --border-radius: 0.2em;
    --border-size: 0;
    aspect-ratio: var(--card-aspect-ratio, auto);
    background-color: var(--card-bg-color);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    display: flex;
    flex-direction: column;
    inline-size: 100%;
    padding: var(--card-padding-block) var(--card-padding-inline);
    position: relative;
    text-align: start;
    z-index: 1;
    html[data-theme="dark"] & {
      box-shadow: 0 0 0 1px var(--color-ink-lighter);
    }
    @media (prefers-color-scheme: dark) {
      html:not([data-theme]) & {
        box-shadow: 0 0 0 1px var(--color-ink-lighter);
      }
    }
    .popup {
      inline-size: 260px;
    }
  }
  /* Header
  /* ------------------------------------------------------------------------ */
  .card__header {
    align-items: center;
    border-radius: var(--border-radius) 0 0 0;
    display: flex;
    flex-wrap: nowrap;
    gap: var(--card-header-space);
    margin-block-start: calc(-1 * var(--card-padding-block));
    margin-inline: calc(-1 * var(--card-padding-inline)) calc(-0.5 * var(--card-padding-inline));
    max-inline-size: unset;
    min-inline-size: 0;
    .card__column-name {
      display: none;
    }
  }
  .card__board {
    align-items: center;
    align-self: start;
    background-color: var(--card-color);
    border-radius: var(--border-radius) 0 var(--border-radius) 0;
    color: var(--color-ink-inverted);
    display: inline-flex;
    font-weight: 600;
    max-inline-size: 100%;
    min-inline-size: 0;
    padding-block: 0.25lh;
    padding-inline: var(--card-padding-inline) 1ch;
    position: relative;
    transition: background-color 100ms ease-out;
    &:has(.btn) {
      @media (any-hover: hover) {
        &:hover {
          background-color: color-mix(in srgb, var(--card-color) 90%, var(--color-ink));
        }
      }
    }
    dialog {
      inset-block-start: 100%;
    }
  }
  .card__id {
    flex-shrink: 0;
    .card-perma &:before {
      content: "No.";
      opacity: 0.5;
    }
  }
  .card__board-name {
    align-items: center;
    border-inline-start: 1px solid color-mix(in hsl, transparent 75%, currentColor);
    color: currentColor;
    display: flex;
    gap: 0.25ch;
    margin-inline-start: var(--card-header-space);
    max-inline-size: 100%;
    min-inline-size: 0;
    padding-inline-start: var(--card-header-space);
    text-transform: uppercase;
  }
  .card__board-picker-button {
    inset: 0;
    position: absolute;
  }
  .card__tags {
    --btn-color: var(--card-color);
    align-items: center;
    align-self: stretch;
    color: var(--card-text-color);
    display: flex;
    gap: 0.5ch;
    min-inline-size: 0;
    [data-controller="dialog"] {
      align-items: center;
      align-self: stretch;
      display: flex;
      position: relative;
    }
    .popup {
      --panel-size: 18ch;
      inset-block-start: 100%;
    }
  }
  .card__tag-picker {
    --panel-border-radius: 2em;
    --panel-padding: 0.5em 0.7em;
    --panel-size: max-content;
    inline-size: auto !important;
    inset: 0 auto auto 0;
    max-inline-size: var(--panel-size) !important;
    position: absolute;
    z-index: 2;
    &[open] {
      display: flex;
    }
    .input {
      --input-padding: 0.2em 0.5em;
      inline-size: 18ch;
    }
  }
  .card__tag-picker-button {
    font-size: 0.6em;
  }
  .card__tag {
    color: inherit;
    font-weight: 600;
    min-width: 0;
    text-transform: uppercase;
  }
  /* Body
  /* ------------------------------------------------------------------------ */
  .card__body {
    display: flex;
    flex-grow: 1;
    gap: 1ch;
    inline-size: 100%;
    padding-block: calc(var(--card-padding-block) / 2);
    @media (min-width: 640px) {
      gap: var(--card-padding-inline);
    }
  }
  .card__content {
    color: var(--card-content-color);
    contain: inline-size;
    flex: 2 1 auto;
    max-inline-size: 100%;
  }
  .card__title {
    --autosize-block-padding: 0 0.5ch;
    --input-border-radius: 0;
    --input-color: var(--card-content-color);
    --lines: 3;
    color: var(--card-content-color);
    font-size: var(--text-xx-large);
    font-weight: 900;
    line-height: 1.15;
    text-wrap: balance;
    .card-field__title {
      overflow: hidden; /* prevent scrolling on windows */
      padding-block: var(--autosize-block-padding);
      &:is(textarea)::placeholder {
        color: inherit;
        opacity: 0.66;
      }
    }
    .card__title-link {
      color: inherit;
    }
  }
  .card__description {
    /* Hide the empty element that Lexical saves when nothing is added to the description <p><br /></p> */
    action-text-content p:only-child:has(br:only-child) {
      display: none;
    }
    lexxy-toolbar {
      border-block-start: 1px solid var(--color-ink-light);
    }
    & ~ .btn.btn--reversed {
      --btn-background: var(--card-color);
      --btn-color: var(--color-ink-inverted);
    }
    & ~ .btn {
      --btn-border-color: var(--card-color);
      --btn-color: var(--card-color);
    }
  }
  .card__stages {
    color: var(--card-text-color);
    display: flex;
    flex: 0 1 auto;
    flex-direction: column;
    gap: 2px;
    justify-self: end;
    max-inline-size: 20ch;
    padding-block: var(--block-space-half);
  }
  /* Footer
  /* ------------------------------------------------------------------------ */
  /* Card metadata */
  .card__meta {
     --meta-spacer-block: 0.5ch;
     --meta-spacer-inline: 0.75ch;
    align-items: center;
    color: var(--card-text-color);
    display: grid;
    font-size: var(--text-x-small);
    font-weight: 500;
    grid-template-areas:
      "avatars-author text-added text-updated avatars-assignees"
      "avatars-author text-author text-assignees avatars-assignees";
    grid-template-columns: auto auto 1fr auto;
    inline-size: fit-content;
    text-transform: uppercase;
    strong,
    .local-time-value {
      font-weight: 900;
    }
  }
  /* Assign grid areas */
  .card__meta-avatars--author { grid-area: avatars-author; }
  .card__meta-avatars--assignees { grid-area: avatars-assignees; }
  .card__meta-text--added { grid-area: text-added; }
  .card__meta-text--author { grid-area: text-author; }
  .card__meta-text--updated { grid-area: text-updated; }
  .card__meta-text--assignees { grid-area: text-assignees; }
  .card__meta-avatars {
    align-self: center;
  }
  .card__meta-avatars--author {
    margin-inline-end: var(--meta-spacer-inline);
  }
  .card__meta-avatars--assignees {
    display: flex;
    margin-inline-start: var(--meta-spacer-inline);
    .avatar {
      margin-inline-end: calc(-1 * var(--meta-spacer-inline));
    }
  }
  .card__assignees-trigger {
    background: transparent;
    border: none;
    padding: 0;
    display: flex;
    &:focus-visible {
      outline: none;
      .btn {
        box-shadow: 0 0 0 var(--focus-ring-size) var(--focus-ring-color);
      }
    }
  }
  .card__meta-text {
    line-height: 1;
    white-space: nowrap;
    .icon {
      --icon-size: 0.9em;
      margin-inline-end: 0.5ch;
      vertical-align: top;
    }
  }
  /* Top */
  .card__meta-text:nth-of-type(odd) {
    border-block-end: var(--card-border);
    padding-block-end: var(--meta-spacer-block);
  }
  /* Bottom */
  .card__meta-text:nth-of-type(even) {
    padding-block-start: var(--meta-spacer-block);
  }
  /* Left */
  .card__meta-text:nth-of-type(-n+2) {
    border-inline-end: var(--card-border);
    padding-inline-end: var(--meta-spacer-inline);
  }
  /* Right */
  .card__meta-text:nth-of-type(n+3) {
    padding-inline-start: var(--meta-spacer-inline);
  }
  @media (max-width: 639px) {
    .card__meta {
      inline-size: 100%;
    }
    .card__meta-avatars--author,
    .card__meta-avatars--assignees .avatar {
      display: none;
    }
  }
  /* Closed stamp
  /* ------------------------------------------------------------------------ */
  .card__closed {
    --stamp-color: oklch(var(--lch-green-medium) / 0.65);
    align-items: center;
    background-color: color-mix(in srgb, var(--card-bg-color) 90%, transparent);
    border-radius: 0.2em;
    border: 0.5ch solid var(--stamp-color);
    color: var(--color-ink-dark);
    display: flex;
    flex-direction: column;
    font-weight: bold;
    inset: auto 0 -1lh auto;
    justify-content: center;
    max-inline-size: 25ch;
    min-inline-size: 16ch;
    padding: 1ch;
    pointer-events: none;
    position: absolute;
    rotate: 5deg;
    transform-origin: top right;
    .cards & {
      display: none;
      .cards--grid &,
      .cards--on-deck & {
        &.card__closed--system {
          display: flex;
        }
      }
    }
  }
  .card:has(.card__closed),
  .card:is(.card--postponed),
  .card-perma:has(.card__closed),
  .card-perma:has(.card--postponed) {
    --card-color: var(--color-card-complete) !important;
    .bubble {
      display: none;
    }
  }
  .card__closed-title {
    color: var(--stamp-color);
    font-size: 1.3em;
    font-weight: 900;
    position: relative;
    text-align: center;
    text-transform: uppercase;
  }
  .card__closed-date {
    font-family: var(--font-mono);
    text-transform: uppercase;
  }
  .card__closed-by {
    border-block-end: 1px dashed currentcolor;
  }
  /* Misc bits
  /* ------------------------------------------------------------------------ */
  .card__background {
    inset: 0;
    position: absolute;
    z-index: -1;
    img {
      block-size: 100%;
      border-radius: var(--border-radius);
      inline-size: 100%;
      object-fit: cover;
      object-position: center;
      opacity: 1;
      transition: filter 0.2s ease-in-out, opacity 0.2s ease-in-out;
    }
  }
  .card__link {
    content: "";
    inset: 0;
    position: absolute;
    z-index: -1;
  }
  .card:nth-child(2n+1) .bubble { --bubble-rotate: -90deg; }
  .card:nth-child(3n+1) .bubble { --bubble-rotate: 45deg; }
  /* Variants
  /* ------------------------------------------------------------------------ */
  .card--notification {
    --card-color: var(--color-card-default);
    --card-padding-inline: 1ch;
    --card-padding-block: 1ch;
    background-color: var(--color-canvas);
    color: var(--color-ink);
    &.card--closed {
      --card-color: var(--color-card-complete) !important;
    }
    .card__body {
      padding-block-end: 0;
    }
    .card__board {
      font-size: var(--text-xx-small);
      padding-block: 0.5ch;
      padding-inline-start: var(--inline-space-double);
    }
    .card__header {
      margin-block-start: calc(-1.1 * var(--card-padding-block));
      margin-inline: calc(-1 * var(--card-padding-inline));
      max-inline-size: unset;
    }
    .card__timestamp {
      opacity: 0.66;
    }
    .card__notification-body {
      font-size: var(--text-x-small);
    }
    .card__notification-meta {
      font-size: var(--text-xx-small);
      font-weight: 600;
      text-transform: uppercase;
    }
    .card__notification-mentioner {
      background-color: var(--color-highlight);
      border-radius: 0.7em 0.2em 0.7em 0.2em;
      color: inherit;
      display: inline-flex;
      padding: 0.1em 0.3em;
    }
    .card__title {
      font-size: var(--text-small);
      font-weight: bold;
      min-block-size: 0;
    }
  }
  .card__notification-unread-indicator {
    --btn-background: var(--color-marker);
    --btn-border-color: var(--color-canvas);
    --btn-color: var(--color-ink-inverted);
    --btn-icon-size: 0.5em;
    --btn-padding: 0;
    --btn-size: 1.6em;
    font-size: var(--text-xx-small);
    font-weight: 600;
    margin: 2px;
    position: relative;
    z-index: 1;
    .icon {
      opacity: 0;
      transition: opacity 150ms ease;
    }
    @media (hover: hover) {
      .card:hover & {
        --btn-background: var(--color-ink-lightest);
        --btn-color: var(--color-ink);
        .badge-count { opacity: 0; }
               .icon { opacity: 1; }
      }
    }
  }
  .card__board-public-description {
    max-inline-size: 66ch;
    > *:first-child { margin-block-start: 0; }
    > *:last-child { margin-block-end: 0; }
    ul, ol {
      inline-size: fit-content;
      margin-inline: auto;
      text-align: start;
    }
    code {
      text-align: left;
    }
  }
}

================
File: app/assets/stylesheets/circled-text.css
================
@layer components {
  .circled-text {
    --circled-color: oklch(var(--lch-blue-dark));
    --circled-padding: -0.5ch;
    background: none;
    color: var(--circled-color);
    position: relative;
    white-space: nowrap;
    span {
      opacity: 0.5;
      mix-blend-mode: multiply;
      html[data-theme="dark"] & {
        mix-blend-mode: screen;
      }
      @media (prefers-color-scheme: dark) {
        html:not([data-theme]) & {
          mix-blend-mode: screen;
        }
      }
    }
    span::before,
    span::after {
      border: 2px solid var(--circled-color);
      content: "";
      inset: var(--circled-padding);
      position: absolute;
    }
    span::before {
      border-inline-end: none;
      border-radius: 100% 0 0 75% / 50% 0 0 50%;
      inset-block-start: calc(var(--circled-padding) / 2);
      inset-inline-end: 50%;
    }
    span::after {
      border-inline-start: none;
      border-radius: 0 100% 75% 0 / 0 50% 50% 0;
      inset-inline-start: 30%;
    }
  }
}

================
File: app/assets/stylesheets/color-picker.css
================
@layer components {
  .color-picker__colors {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--inline-space-half);
    .btn {
      --btn-border-radius: 0.1em;
      --btn-size: 2em;
      --icon-size: 1.3em;
      inline-size: 100%;
    }
  }
}

================
File: app/assets/stylesheets/comments.css
================
@layer components {
  .comments {
    --avatar-size: 2.33em;
    --comment-padding-block: var(--block-space-half);
    --comment-padding-inline: var(--inline-space-double);
    --comment-max: 70ch;
    --reaction-size: 2.25rem;
    display: flex;
    flex-direction: column;
    padding-inline: var(--inline-space);
    place-items: center;
    text-align: center;
    @media (min-width: 160ch) {
      padding-inline: var(--tray-size);
    }
    @media (min-width: 640px) {
      --reaction-size: 1.6875rem;
    }
  }
  .comments__subscribers {
    max-inline-size: var(--comment-max);
    padding-inline: calc(var(--comment-padding-block) + var(--inline-space-double));
  }
  .comment {
    /* Distinguish from the .comment class used for code formatting without extra specificity */
    &:where(.comments &) {
      display: flex;
      margin-inline: auto;
      max-inline-size: var(--comment-max);
      position: relative;
    }
    .comment-by-system & {
      --comment-padding-block: var(--block-space-half);
      text-align: center;
      &::before {
        /* Make up space for lack of avatar */
        content: "";
        display: flex;
        inline-size: calc(var(--comment-padding-inline) * 0.9);
      }
      .comment__avatar {
        display: none;
      }
      .comment__author {
        a { margin: 0 auto; }
        h3 { margin-inline: auto; }
        strong { display: none; }
      }
      .comment__body {
        padding: 0;
        text-align: center;
      }
      .comment__content {
        --stripe-color: var(--color-ink-lightest);
        background-image: repeating-linear-gradient(
          45deg in srgb,
          var(--color-canvas) 0 1px,
          var(--stripe-color) 1px 10px);
        padding-inline: var(--comment-padding-inline);
        .comments--system-expanded .comment-by-system & {
          --stripe-color: color-mix(in srgb, var(--card-color) 10%, var(--color-canvas));
        }
      }
      .reactions {
        display: none !important;
      }
    }
    .reactions {
      margin-block-start: var(--block-space-half);
      margin-inline: calc(var(--column-gap) / -1);
    }
  }
  .comment__author {
    .btn {
      font-weight: inherit;
    }
  }
  .comment__avatar {
    margin: calc(var(--comment-padding-block) * 0.75) calc(var(--comment-padding-inline) * -0.75);
    z-index: 0;
  }
  .comment__body {
    text-align: start;
    .action-text-content {
      > action-text-attachment:first-child figure {
        margin-block-start: 0.5ch;
      }
      > :last-child {
        margin-block-end: 0;
      }
    }
    &:not:has(lexxy-editor) {
      padding-inline-end: var(--reaction-size);
    }
    /* Add an empty space so the last line of text doesn't overlap with the reaction button */
    .action-text-content > p:last-child::after {
      content: "";
      display: inline-block;
      inline-size: var(--reaction-size);
    }
  }
  .comment__content {
    --btn-icon-size: 1.2rem;
    --btn-size: var(--reaction-size);
    --comment-bg-color: var(--color-ink-lightest);
    --lexxy-bg-color: var(--comment-bg-color);
    background-color: var(--comment-bg-color);
    border-radius: 0.2em;
    max-inline-size: calc(100% - calc(var(--comment-padding-inline) * 0.75));
    padding:
      var(--comment-padding-block)
      calc(var(--comment-padding-inline) / 2)
      calc(var(--comment-padding-block) * 1.5)
      var(--comment-padding-inline);
    word-wrap: break-word;
  }
  .comment__edit {
    background-color: var(--color-ink-lightest);
    &:hover {
      z-index: 1;
    }
  }
  .comment__permalink-title {
    color: currentColor;
    opacity: 0.66;
    text-decoration: none;
    text-transform: capitalize;
    @media (max-width: 639px) {
      line-height: 1.5lh;
    }
  }
  .comment__history {
    background-color: transparent;
    display: none;
    inset: var(--comment-padding-block) var(--comment-padding-block) auto auto;
    translate: 2px -2px; /* Align baseline with time stamp */
    position: absolute;
    @media (any-hover: hover) {
      &:hover {
        background-color: var(--stripe-color);
      }
    }
  }
  .comment-by-system {
    display: none;
    transition: var(--dialog-duration) allow-discrete;
    transition-property: display;
    .comments--system-expanded & {
      display: contents;
    }
  }
  /* Show the last system comment */
  :nth-last-child(1 of .comment-by-system) {
    display: contents;
    .comment__history {
      display: inline-flex;
    }
  }
  /* Hide the "Show history" button if there's only one system comment */
  :nth-child(1 of .comment-by-system) {
    .comment__history {
      display: none;
    }
  }
}

================
File: app/assets/stylesheets/dialog.css
================
@layer components {
  /* Prevent page scrolling when modal dialog is open */
  html:has(dialog:modal) {
    overflow: hidden;
  }
  :is(.dialog) {
    border: 0;
    opacity: 0;
    transform: scale(0.2);
    transform-origin: top center;
    transition: var(--dialog-duration) allow-discrete;
    transition-property: display, opacity, overlay, transform;
    &::backdrop {
      background-color: var(--color-black);
      opacity: 0;
      transform: scale(1);
      transition: var(--dialog-duration) allow-discrete;
      transition-property: display, opacity, overlay;
    }
    &[open] {
      opacity: 1;
      transform: scale(1);
      &::backdrop {
        opacity: 0.5;
      }
    }
    @starting-style {
      &[open] {
        opacity: 0;
        transform: scale(0.2);
      }
      &[open]::backdrop {
        opacity: 0;
      }
    }
  }
  /* Ensure padding from viewport edges */
  .dialog.panel {
    max-inline-size: calc(100vw - var(--inline-space-double) * 2);
  }
}

================
File: app/assets/stylesheets/dividers.css
================
@layer components {
  .divider {
    --divider-color: var(--color-ink-light);
    align-items: center;
    display: flex;
    gap: var(--inline-space);
    &:before,
    &:after {
      background: var(--divider-color);
      block-size: var(--divider-size, 1px);
      content: "";
      flex: 1;
    }
  }
  .divider--fade {
    &:before { background: linear-gradient(to right, transparent, var(--divider-color) 50%); }
    &:after  { background: linear-gradient(to left, transparent, var(--divider-color) 50%); }
  }
}

================
File: app/assets/stylesheets/drag_and_drop.css
================
@layer components {
  .drag-and-drop__dragged-item {
    box-shadow: none;
    filter: grayscale(1) brightness(0.97);
    opacity: 0.6;
    outline: 2px dashed var(--color-selected-dark);
  }
  .drag-and-drop__hover-container {
    --dnd-bg-color: var(--color-selected-light);
    --dnd-border-color: var(--color-selected-dark);
    background-color: var(--dnd-bg-color);
    outline: 2px dashed var(--dnd-border-color);
    outline-offset: -2px;
    transition: background-color 200ms;
    z-index: 1;
  }
}

================
File: app/assets/stylesheets/events.css
================
@layer components {
  /* Events header
  /* ------------------------------------------------------------------------ */
  .header--events {
    --header-button-count: 1;
    @media (min-width: 640px) {
      --header-actions-width: 7.25rem !important;
    }
  }
  /* Event column layout
  /* ------------------------------------------------------------------------ */
  .events {
    --events-gap: 1ch;
    --events-border: 1px solid var(--color-ink-lighter);
    --events-day-header-height: 1.75rem;
  }
  .events--grid {
    --events-grid-gap: 1rem;
    --events-grid-columns: 1;
    container-type: inline-size;
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
    gap: var(--events-grid-gap);
    justify-content: center;
    margin: var(--block-space) auto;
    max-inline-size: var(--main-width);
    @media (min-width: 640px) {
      --events-grid-columns: 2;
    }
    @media (min-width: 960px) {
      --events-grid-columns: 3;
    }
    .event {
      inline-size: calc((100% - var(--events-grid-gap) * (var(--events-grid-columns) - 1) ) / var(--events-grid-columns)) !important;
      margin: 0 !important;
    }
  }
  .events__activity-summary {
    border: solid var(--color-ink-lighter);
    border-width: 1px 1px 0 1px;
    color: var(--color-ink-darker);
    inline-size: auto;
    margin-inline: auto;
    padding: 1.1lh 1lh 1lh;
    position: relative;
    text-align: start;
    z-index: 2;
    .events section:first-of-type & {
      border-radius: 0.5em 0.5em 0 0;
    }
    &:has(.events__activity--generating) {
      --border-color: var(--color-selected-dark);
      animation: gradient 4s ease infinite;
      background: linear-gradient(-45deg, var(--color-gradient-1), var(--color-gradient-2), var(--color-gradient-3), var(--color-gradient-4));
      background-size: 300%;
      text-align: center;
    }
    > * {
      column-count: 2;
      column-gap: var(--inline-space-double);
      margin-inline: auto;
      max-inline-size: 80ch;
    }
    a {
      color: inherit;
    }
    h3 {
      column-span: all;
      font-size: var(--text-large);
      line-height: 1.3;
      margin-block: 0.5em 0.25em;
      text-align: center;
      text-wrap: balance;
      + p {
        column-span: all;
        font-size: var(--text-medium);
        margin-block: 0 1.5em;
        text-align: center;
        text-wrap: balance;
      }
    }
    h4 {
      break-after: avoid-column;
      font-size: var(--text-medium);
      line-height: 1.3;
      margin-block: 0.5em 0.25em;
      text-wrap: balance;
      + p {
        break-inside: avoid-column;
        margin-block: 0 1.5em;
      }
    }
    hr { display: none; }
  }
  .events__activity-generating-msg {
    display: block;
    font-weight: 500;
    margin-block: 2lh;
    opacity: 0.5;
  }
  .events__activity-prompt-edit {
    inset: auto 1em 1em auto;
    position: absolute;
  }
  .events__filter-select {
    font-weight: inherit;
    text-decoration: underline;
    @media (any-hover: hover) {
      &:hover {
        --btn-color: var(--color-link);
      }
    }
  }
  .events__day {
    position: relative;
    @media (max-width: 639px) {
      margin-block-end: calc(var(--events-gap) * 2);
    }
  }
  .events__day-header,
  .events__column-header {
    font-size: var(--text-small);
    text-align: center;
    text-transform: uppercase;
  }
  .events__day-header {
    block-size: 0;
    margin-block-start: calc(var(--events-day-header-height) / 2);
    position: relative;
    z-index: var(--z-events-day-header);
  }
  .events__day-time {
    align-items: center;
    background-color: var(--color-ink);
    block-size: var(--events-day-header-height);
    border-radius: 0.2em;
    color: var(--color-ink-inverted);
    display: flex;
    gap: 0.4ch;
    inline-size: fit-content;
    inset: 0 auto auto 50%;
    margin-inline: auto;
    padding-inline: 1.5ch;
    position: absolute;
    translate: -50% -50%;
  }
  .events__columns {
    border-block-start: var(--events-border);
    position: relative;
    z-index: 1;
    @media (min-width: 640px) {
      align-items: end;
      border-inline: var(--events-border);
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      /* Pseudo column borders since .events__column is display: contents */
      &:before,
      &:after {
        border-inline-start: var(--events-border);
        content: "";
        inset-block: 0;
        position: absolute;
        z-index: var(--z-events-day-header);
      }
      &:before { inset-inline-start: calc(100% / 3); }
      &:after { inset-inline-end: calc(100% / 3); }
    }
  }
  .events__column {
    @media (max-width: 639px) {
      &:not(:has(.event)) {
        display: none;
      }
    }
    @media (min-width: 640px) {
      display: contents;
    }
    &:nth-of-type(1) > * { grid-column-start: 1; }
    &:nth-of-type(2) > * { grid-column-start: 2; }
    &:nth-of-type(3) > * { grid-column-start: 3; }
  }
  .events__column-header {
    background-color: var(--color-canvas);
    grid-row-start: 1;
    inset-block-start: var(--custom-safe-inset-top);
    margin-block: calc(var(--events-gap) * 2) var(--events-gap);
    padding-block: var(--events-gap);
    position: sticky;
    z-index: var(--z-events-column-header);
    @media (max-width: 639px) {
      margin-inline: calc(var(--main-padding) * -0.5);
      padding-inline: var(--main-padding);
    }
  }
  .events__column-footer {
    grid-row-start: 26;
    margin: var(--events-gap);
    padding: var(--block-space-half) var(--inline-space);
  }
  .events__maximize-button {
    inset: 50% var(--events-gap) auto auto;
    outline-offset: -2px;
    position: absolute;
    transform: translateY(-50%);
    z-index: 1;
    @media (max-width: 639px) {
      inset-inline-end: 0;
    }
    @media (any-hover: hover ) {
      opacity: 0;
      .events__column-header:hover &,
      &:focus-visible {
        opacity: 1;
      }
    }
  }
  .events__time-block {
    align-content: end;
    display: grid;
    gap: var(--events-gap);
    justify-items: center;
    margin: 0;
    padding: 0;
    @media (min-width: 640px) {
      padding-block-end: calc(var(--events-gap) * 3);
      padding-inline: calc(var(--events-gap) * 2);
    }
    .event {
      grid-column-start: unset !important;
      grid-row-start: unset !important;
    }
  }
  .events__none {
    background-color: var(--color-canvas);
    border-block-start: var(--events-border);
    grid-column: 1 / -1;
    padding-block: 3em;
    text-align: center;
  }
  /* Event
  /* ------------------------------------------------------------------------ */
  .event {
    --column-gap: 0.7ch;
    --event-padding: 0.6em;
    background-color: color-mix(in srgb, var(--card-color) 10%, var(--color-canvas));
    border-radius: 0.2em;
    box-shadow: 0 0 0 1px color-mix(in srgb, var(--card-color) 20%, var(--color-canvas));
    color: color-mix(in srgb, var(--card-color) 40%, var(--color-ink));
    margin: var(--inline-space);
    max-inline-size: 100%;
    min-inline-size: 0;
    overflow: clip;
    padding: var(--event-padding);
    position: relative;
    z-index: 0;
    @media (max-width: 639px) {
      inline-size: 100%;
    }
    &:has(.card__background img:not([src=""])) {
      background-color: var(--color-canvas) !important;
    }
    .event_attachments {
      .attachment--image {
        block-size: auto;
        max-inline-size: 30%;
      }
    }
    .card__background {
      filter: brightness(1.2) contrast(0.8);
      opacity: 0.2;
      z-index: 0;
    }
    .card__header {
      inline-size: 100%;
      margin-block-start: calc(-1 * var(--event-padding));
    }
    .card__board {
      background-color: transparent;
      color: color-mix(in srgb, var(--card-color) 40%, var(--color-ink));
      font-size: 0.7em;
    }
    .card__board-name {
      border-inline-start: 1px solid color-mix(in srgb, var(--color-ink) 33%, var(--color-canvas));
      color: color-mix(in srgb, var(--card-color) 40%, var(--color-ink));
      margin: 0 0 0 calc(var(--inline-space) * 0.75);
      padding-inline-start: calc(var(--inline-space) * 0.75);
    }
    .card__header {
      overflow: visible;
    }
    .card__id {
      margin: 0;
    }
  }
  .event--related {
    outline: 0.15rem solid var(--card-color);
  }
  .event__content {
    max-inline-size: 100%;
    position: relative;
    z-index: 1;
  }
  .event__grid-item {
    background-color: var(--color-canvas);
    block-size: 100%;
    border-radius: 0;
    display: flex;
    inline-size: 100%;
  }
  .event__grid-column-title {
    --z: 3;
    background-color: var(--color-canvas);
    font-size: 0.9em;
    padding: 1.5em 0 1em;
    text-transform: uppercase;
  }
  .event__icon {
    color: var(--card-color);
    display: grid;
    margin-inline-start: auto;
    place-content: center;
    translate: calc(var(--event-padding) / 2);
  }
  .event__timestamp {
    align-self: start;
    display: grid;
    font-weight: 600;
    margin-block-end: var(--block-space-half);
  }
  .event__title {
    --lines: 4;
    font-size: 1.1em;
    line-height: 1.2;
  }
}

================
File: app/assets/stylesheets/expandable.css
================
@layer components {
  .expandable-on-native {
    body:not([data-platform~=native]) & {
      &::details-content {
        display: contents;
      }
      summary {
        display: none;
      }
    }
  }
}

================
File: app/assets/stylesheets/filters.css
================
@layer components {
  #header:has(.filters) {
    position: relative;
  }
  .filters {
    align-items: center;
    display: flex;
    flex-wrap: wrap;
    gap: var(--inline-space-half);
    justify-content: center;
    padding-block-start: 2px; /* prevents input focus-ring clipping on mobile */
    position: relative;
    view-transition-name: filters;
    z-index: 1;
    .btn {
      --btn-border-color: var(--color-ink-medium);
      --input-background: var(--color-canvas);
    }
    &:has(dialog[open]),
    &:has([data-controller~="tooltip"]:hover) {
      z-index: calc(var(--z-nav) + 1);
    }
  }
  .filter {
    &[aria-selected] {
      display: flex;
    }
  }
  .filter__button {
    --btn-border-size: 0;
    --btn-font-weight: 400;
    --btn-icon-size: 0.7em;
    --btn-padding: 0.3em 0.7em;
    inline-size: 100%;
    justify-content: space-between;
    text-align: start;
    span {
      overflow: hidden;
      text-decoration: none;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    img {
      display: none;
    }
    &:has(input[type=checkbox]:checked) img {
      display: block;
    }
  }
  .filter__columns {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    max-block-size: 50dvh;
  }
  .filter__label {
    display: flex;
    inline-size: 100%;
    padding: 0.3em 0.7em;
    strong {
      overflow: hidden;
      text-decoration: none;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
  }
  .filter__menu {
    display: flex;
    flex-direction: column;
    inline-size: 100%;
    list-style: none;
    margin: 0;
    min-inline-size: 0;
    overflow-x: auto;
    padding: 0 var(--inline-space);
    position: relative;
    row-gap: 0.2em;
    &::before {
      block-size: 100%;
      border-block: 0;
      border-inline-end: 0;
      border-inline-start: 1px solid var(--color-ink-lighter);
      content: "";
      display: inline-flex;
      inline-size: 0;
      position: absolute;
      inset: 0 auto 0 0;
    }
    &:first-child::before {
      display: none;
    }
    li {
      text-align: start;
    }
  }
  .filter__terms:is(.input) {
    --input-background: var(--color-canvas);
    --input-border-radius: 5em;
    --input-padding: 0.5em 1.3em;
    --input-width: 16em;
    --collapsed-filter-space: calc(var(--btn-size) + var(--inline-space-half) + 0.25em);
    inline-size: var(--input-width);
    min-inline-size: var(--input-width);
    .filters:not(.filters--expanded, .filters--has-filters-set) & {
      --input-padding: 0.5em 2.7em 0.5em 1.3em;
      inline-size: calc(var(--input-width) + (0.25 * var(--collapsed-filter-space)));
      margin-inline-end: calc((var(--btn-size) + var(--inline-space-half) + 0.25em) * -1);
      min-inline-size: calc(var(--input-width) + (0.25 * var(--collapsed-filter-space)));
    }
  }
  .filter-toggle {
    .filters:not(.filters--expanded, .filters--has-filters-set) & {
      --btn-background: transparent;
      --btn-border-size: 0;
      transform: translateX(calc(var(--inline-space-half) * -1));
      position: relative;
    }
  }
  .quick-filter {
    position: relative;
    &:has([aria-checked="true"]):not(.quick-filter--with-default) {
      .input--select {
        --input-background: var(--color-selected);
      }
    }
    /* Hide a quick filter if there's nothing in it to filter by */
    &:not(:has(.popup__item)) {
      display: none !important;
    }
  }
  .filters:not(.filters--expanded) {
    .quick-filter:not([data-filter-show=true]) {
      display: none;
    }
  }
  .filters.filters--expanded {
    .quick-filter {
      display: block;
    }
  }
  .filters__manage {
    display: none;
  }
  .filters--has-filters-set .filters__manage {
    display: flex;
  }
  .filters__show-when-expanded {
    .filters:not(.filters--expanded) & {
      display: none;
    }
  }
  .filters__show-when-collapsed {
    .filters--expanded & {
      display: none;
    }
  }
}

================
File: app/assets/stylesheets/flash.css
================
@layer components {
  .flash {
    display: flex;
    inset-block-start: var(--block-space);
    inset-inline-start: 50%;
    justify-content: center;
    position: fixed;
    transform: translate(-50%);
    z-index: var(--z-flash);
  }
  .flash__inner {
    animation: appear-then-fade 3s 300ms both;
    background-color: var(--flash-background, var(--color-ink));
    border-radius: 4em;
    color: var(--flash-color, var(--color-ink-inverted));
    display: inline-flex;
    font-size: var(--font-size-medium);
    margin: 0 auto;
    padding: 0.7em 1.4em;
  }
}

================
File: app/assets/stylesheets/font-face.css
================
@layer base {
  /*
    Segoe UI Variable Fizzy font face configuration.
    1. Segoe UI Variable (Weights 100-700):
       Leverages variable font features to:
       - Automatically adjust Weight (wght) dynamically within the 100-700 range.
       - Automatically manage Optical Size (opsz) based on font-size.
    2. Segoe UI Black (Weights 800-900):
       Used as a fallback because Segoe UI Variable does not natively support 900 weight.
       This ensures a consistent bold experience across all weights.
  */
  @font-face {
    font-family: "Segoe UI Variable Fizzy";
    src: local("Segoe UI Variable");
    font-weight: 100 700;
    font-style: normal;
  }
  @font-face {
    font-family: "Segoe UI Variable Fizzy";
    src: local("Segoe UI Variable");
    font-weight: 100 700;
    font-style: italic;
  }
  @font-face {
    font-family: "Segoe UI Variable Fizzy";
    src: local("Segoe UI Black");
    font-weight: 800 900;
    font-style: normal;
  }
  @font-face {
    font-family: "Segoe UI Variable Fizzy";
    src: local("Segoe UI Black Italic");
    font-weight: 800 900;
    font-style: italic;
  }
}

================
File: app/assets/stylesheets/golden-effect.css
================
@layer components {
  .golden-effect {
    /* Uncomment below to use the card color for golden effect */
    /* --color-golden: color-mix(in srgb, var(--card-color) 35%, transparent); */
    background-color: color-mix(in srgb, var(--color-golden) 4%, var(--color-canvas));
    background-image: linear-gradient(60deg,
      color-mix(in srgb, var(--color-golden) 45%, transparent) 0%,
      color-mix(in srgb, var(--color-golden) 10%, transparent) 33%,
      color-mix(in srgb, var(--color-golden) 5%, transparent) 66%,
      color-mix(in srgb, var(--color-golden) 45%, transparent) 100%
    );
    box-shadow:
      0 0 0 1px color-mix(in oklch, var(--color-golden) 100%, transparent),
      0 0 0.2em 0.2em color-mix(in oklch, var(--color-golden) 25%, transparent),
      0 0 1em 0.5em color-mix(in oklch, var(--color-golden) 25%, transparent);
    lexxy-toolbar {
      --lexxy-bg-color: transparent;
    }
  }
}

================
File: app/assets/stylesheets/header.css
================
@layer components {
  /* Centered title with space for two buttons on either side */
  .header {
    --header-gap: 0.5ch;
    --btn-icon-size: 1rem;
    --header-btn-size: 2rem;
    --header-button-count: 0;
    --header-actions-width: calc((var(--header-btn-size) + var(--header-gap)) * var(--header-button-count));
    display: grid;
    grid-template-columns: var(--header-actions-width) 1fr var(--header-actions-width);
    grid-template-areas:
      "menu menu menu"
      "actions-start title actions-end";
    max-inline-size: 100dvw;
    padding-block: calc(var(--block-space-half) + var(--custom-safe-inset-top)) var(--block-space-half);
    padding-inline: var(--main-padding);
    position: relative;
    z-index: var(--z-nav);
    /* Change the grid size depending on how many buttons are present */
    &:has(.header__actions > *:nth-child(1)) { --header-button-count: 1; }
    &:has(.header__actions > *:nth-child(2)) { --header-button-count: 2; }
    &:has(.header__actions > *:nth-child(3)) { --header-button-count: 3; }
    &:has(nav) {
      row-gap: 0;
    }
    &:has(dialog[open]) {
      z-index: var(--z-nav-open);
    }
    &:has(~ #main .card-columns) {
      inline-size: 100dvw;
      margin-inline: auto;
      max-inline-size: var(--main-width);
    }
    nav {
      grid-area: menu;
      margin-inline: auto;
    }
  }
  .header__actions {
    display: flex;
    font-size: var(--text-x-small);
    gap: var(--header-gap);
    inline-size: var(--header-actions-width);
  }
  .header__actions--start {
    grid-area: actions-start;
    margin-inline-end: auto;
  }
  .header__actions--end {
    grid-area: actions-end;
    justify-content: flex-end;
    margin-inline-start: auto;
  }
  .header__title {
    color: inherit;
    font-size: var(--text-large);
    font-weight: 900;
    grid-area: title;
    margin: 0 auto;
    min-inline-size: 0;
    text-align: center;
  }
  .header__skip-navigation {
    --left-offset: -999em;
    inset-block-start: 4rem;
    inset-inline-start: var(--left-offset);
    position: absolute;
    white-space: nowrap;
    z-index: 11;
    &:focus {
      --left-offset: var(--inline-space);
    }
  }
  .header__logo {
    color: var(--color-ink);
    font-size: 1.2rem;
    inline-size: auto;
    margin-block-start: 0.1em;
    span {
      background: var(--color-ink-lightest);
      block-size: auto;
      border-radius: 0.3125em;
      box-shadow:
        0 0 0 1px oklch(var(--lch-ink-darkest) / 0.1),
        0 0.1em 0.2em -0.1em oklch(var(--lch-ink-darkest) / 0.05),
        0 0.2em 0.4em -0.2em oklch(var(--lch-ink-darkest) / 0.05),
        0 0.3em 0.6em -0.3em oklch(var(--lch-ink-darkest) / 0.05)
      ;
      display: grid;
      height: 1.5em;
      inline-size: 1.5em;
      padding: 0.325em 0.275em 0.225em 0.275em;
      place-content: center;
      width: 1.5em;
    }
    svg {
      height: 100%;
      margin-inline-start: 0.4125em;
      margin-inline-end: 0.5375em;
      max-height: 0.8625em;
      overflow: visible;
      width: auto;
    }
  }
  /* Optional class to stack header actions on small screens
  /* ------------------------------------------------------------------------ */
  .header--mobile-actions-stack {
    @media (max-width: 639px) {
      grid-template-areas:
        "actions-start menu actions-end"
        "title title title";
      .header__title {
        margin-block-start: 0.25rem;
      }
    }
  }
}

================
File: app/assets/stylesheets/icons.css
================
@layer components {
  .icon {
    -webkit-touch-callout: none;
    background-color: currentColor;
    block-size: var(--icon-size, 1em);
    display: inline-block;
    flex-shrink: 0;
    inline-size: var(--icon-size, 1em);
    mask-image: var(--svg);
    mask-position: center;
    mask-repeat: no-repeat;
    mask-size: var(--icon-size, 1em);
    pointer-events: none;
    user-select: none;
  }
  img.icon {
    background: none;
  }
  .icon--37signals { --svg: url("37signals.svg"); }
  .icon--add { --svg: url("add.svg "); }
  .icon--add--meta { --svg: url("add--meta.svg "); }
  .icon--arrow-left { --svg: url("arrow-left.svg "); }
  .icon--arrow-right { --svg: url("arrow-right.svg "); }
  .icon--arrow-up { --svg: url("arrow-up.svg "); }
  .icon--art { --svg: url("art.svg "); }
  .icon--assigned { --svg: url("assigned.svg "); }
  .icon--attachment { --svg: url("attachment.svg "); }
  .icon--bell-alert { --svg: url("bell-alert.svg "); }
  .icon--bell-off { --svg: url("bell-off.svg "); }
  .icon--bell { --svg: url("bell.svg "); }
  .icon--bolt { --svg: url("bolt.svg "); }
  .icon--bookmark-outline { --svg: url("bookmark-outline.svg "); }
  .icon--bookmark { --svg: url("bookmark.svg "); }
  .icon--boost { --svg: url("boost.svg "); }
  .icon--camera { --svg: url("camera.svg "); }
  .icon--caret-down { --svg: url("caret-down.svg "); }
  .icon--check { --svg: url("check.svg "); }
  .icon--check-circle { --svg: url("check-circle.svg "); }
  .icon--check-all { --svg: url("check-all.svg "); }
  .icon--clipboard { --svg: url("clipboard.svg "); }
  .icon--close { --svg: url("close.svg "); }
  .icon--close-circle { --svg: url("close-circle.svg "); }
  .icon--collapse { --svg: url("collapse.svg "); }
  .icon--board { --svg: url("board.svg "); }
  .icon--board-add { --svg: url("board-add.svg "); }
  .icon--column-left { --svg: url("column-left.svg "); }
  .icon--column-right { --svg: url("column-right.svg "); }
  .icon--comment { --svg: url("comment.svg "); }
  .icon--copy-paste { --svg: url("copy-paste.svg "); }
  .icon--crown { --svg: url("crown.svg "); }
  .icon--email { --svg: url("email.svg "); }
  .icon--everyone { --svg: url("everyone.svg "); }
  .icon--expand { --svg: url("expand.svg "); }
  .icon--gear { --svg: url("gear.svg "); }
  .icon--grid { --svg: url("grid.svg "); }
  .icon--filter { --svg: url("filter.svg "); }
  .icon--fizzy { --svg: url("fizzy.svg"); }
  .icon--globe { --svg: url("globe.svg "); }
  .icon--golden-ticket { --svg: url("golden-ticket.svg "); }
  .icon--history { --svg: url("history.svg "); }
  .icon--home { --svg: url("home.svg "); }
  .icon--install-edge { --svg: url("install-edge.svg "); }
  .icon--lifebuoy { --svg: url("lifebuoy.svg "); }
  .icon--lock { --svg: url("lock.svg "); }
  .icon--logout { --svg: url("logout.svg "); }
  .icon--marker { --svg: url("marker.svg "); }
  .icon--maximize { --svg: url("maximize.svg "); }
  .icon--menu { --svg: url("menu.svg "); }
  .icon--menu-dots-horizontal { --svg: url("menu-dots-horizontal.svg "); }
  .icon--menu-dots-vertical { --svg: url("menu-dots-vertical.svg "); }
  .icon--minus { --svg: url("minus.svg "); }
  .icon--monitor { --svg: url("monitor.svg "); }
  .icon--moon { --svg: url("moon.svg "); }
  .icon--move { --svg: url("move.svg "); }
  .icon--notification-bell-access-only { --svg: url("bell.svg "); }
  .icon--notification-bell-watching { --svg: url("bell-off.svg "); }
  .icon--notification-bell-reverse-access-only { --svg: url("bell-off.svg "); }
  .icon--notification-bell-reverse-watching { --svg: url("bell.svg "); }
  .icon--password { --svg: url("password.svg "); }
  .icon--pencil { --svg: url("pencil.svg "); }
  .icon--person { --svg: url("person.svg "); }
  .icon--person-add { --svg: url("person-add.svg "); }
  .icon--picture-add { --svg: url("picture-add.svg "); }
  .icon--picture-double { --svg: url("picture-double.svg "); }
  .icon--picture-remove { --svg: url("picture-remove.svg "); }
  .icon--picture-zoom { --svg: url("picture-zoom.svg "); }
  .icon--pinned { --svg: url("pinned.svg "); }
  .icon--qr-code { --svg: url("qr-code.svg "); }
  .icon--reaction { --svg: url("reaction.svg "); }
  .icon--refresh { --svg: url("refresh.svg "); }
  .icon--refresh--meta { --svg: url("refresh--meta.svg "); }
  .icon--remove { --svg: url("remove.svg "); }
  .icon--rename { --svg: url("rename.svg "); }
  .icon--search { --svg: url("search.svg "); }
  .icon--settings { --svg: url("settings.svg "); }
  .icon--share { --svg: url("share.svg "); }
  .icon--sliders { --svg: url("sliders.svg "); }
  .icon--sun { --svg: url("sun.svg "); }
  .icon--switch { --svg: url("switch.svg "); }
  .icon--tag { --svg: url("tag.svg "); }
  .icon--tag-outline { --svg: url("tag-outline.svg "); }
  .icon--thumb-up { --svg: url("thumb-up.svg "); }
  .icon--trash { --svg: url("trash.svg "); }
  .icon--unpinned { --svg: url("unpinned.svg"); }
  .icon--unseen { --svg: url("unseen.svg"); }
  .icon--world { --svg: url("world.svg"); }
  .icon--youtube { --svg: url("youtube.svg"); }
}

================
File: app/assets/stylesheets/inputs.css
================
@layer components {
  /* Text inputs */
  .input {
    accent-color: var(--input-accent-color, var(--color-ink));
    background-color: var(--input-background, transparent);
    border-radius: var(--input-border-radius, 0.5em);
    border: var(--input-border-size, 1px) solid var(--input-border-color, var(--color-ink-medium));
    color: var(--input-color, var(--color-ink));
    font-size: max(16px, 1em);
    inline-size: 100%;
    line-height: inherit;
    max-inline-size: 100%;
    padding: var(--input-padding, 0.5em 0.8em);
    resize: none;
    &:autofill,
    &:-webkit-autofill,
    &:-webkit-autofill:hover,
    &:-webkit-autofill:focus {
      -webkit-text-fill-color: var(--color-ink);
      -webkit-box-shadow: 0 0 0px 1000px var(--color-selected) inset;
    }
    &:where(:focus) {
      --focus-ring-offset: -1px;
    }
    &[readonly] {
      --focus-ring-size: 0;
    }
    &[autocomplete='one-time-code'] {
      --input-spacing: 0.5em;
      font-family: var(--font-mono);
      font-size: var(--text-large);
      font-weight: 900;
      inline-size: 18ch;
      letter-spacing: 1ch;
      min-inline-size: 18ch;
      text-align: center;
    }
    &[type='number'] {
      &::-webkit-outer-spin-button,
      &::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
    }
    /* Target mobile Safari only */
    @supports (hanging-punctuation: first) and (font: -apple-system-body) and (-webkit-appearance: none) {
      @media (hover: none) {
        font-size: max(16px, 1em) !important;
      }
    }
  }
  .input--file,
  .input--upload {
    cursor: pointer;
    &:has(input[type="file"]:focus-visible) {
      outline: 0.15rem solid var(--color-selected-dark);
    }
    input[type="file"] {
      --hover-size: 0;
      --input-border-color: transparent;
      --input-border-radius: 8px;
      block-size: 100%;
      cursor: pointer;
      font-size: 0;
      inline-size: 100%;
      overflow: clip;
      &::file-selector-button {
        appearance: none;
        cursor: pointer;
        opacity: 0;
      }
    }
  }
  .input--file {
    display: grid;
    inline-size: auto;
    place-items: center;
    > * {
      grid-area: 1 / 1;
    }
    img {
      border-radius: 0.4em;
    }
    &:is(.avatar) {
      input[type="file"] {
        border-radius: 50%;
      }
    }
  }
  .input--upload {
    --btn-border-color: var(--color-ink);
    --btn-border-radius: 1ch;
    border-style: dashed;
    position: relative;
    input[type="file"] {
      inset: 0;
      outline: none;
      position: absolute;
    }
    &:has([data-upload-preview-target="fileName"]:not([hidden])) {
      --btn-border-color: var(--color-positive);
      --btn-color: var(--color-positive);
    }
  }
  .input--select {
    --input-border-radius: 2em;
    --input-padding: 0.5em 1.8em 0.5em 1.2em;
    --caret-icon: url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='m12 19.5c-.7 0-1.3-.3-1.7-.8l-9.8-11.1c-.7-.8-.6-1.9.2-2.6.8-.6 1.9-.6 2.5.2l8.6 9.8c0 .1.2.1.4 0l8.6-9.8c.7-.8 1.8-.9 2.6-.2s.9 1.8.2 2.6l-9.8 11.1c-.4.5-1.1.8-1.7.8z' fill='%23000'/%3E%3C/svg%3E");
    --caret-icon-dark: url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='m12 19.5c-.7 0-1.3-.3-1.7-.8l-9.8-11.1c-.7-.8-.6-1.9.2-2.6.8-.6 1.9-.6 2.5.2l8.6 9.8c0 .1.2.1.4 0l8.6-9.8c.7-.8 1.8-.9 2.6-.2s.9 1.8.2 2.6l-9.8 11.1c-.4.5-1.1.8-1.7.8z' fill='%23fff'/%3E%3C/svg%3E");
    -webkit-appearance: none;
    appearance: none;
    background-image: var(--caret-icon);
    background-size: 0.5em;
    background-position: center right 0.9em;
    background-repeat: no-repeat;
    text-align: start;
    html[data-theme="dark"] & {
      --caret-icon: var(--caret-icon-dark);
    }
    @media (prefers-color-scheme: dark) {
      html:not([data-theme]) & {
        --caret-icon: var(--caret-icon-dark);
      }
    }
    option {
      background-color: var(--color-canvas);
      color: var(--color-ink);
    }
  }
  .input--textarea {
    --input-padding: 0;
    line-height: inherit;
    min-block-size: calc(3lh + (2 * var(--input-padding)));
    min-inline-size: 100%;
    padding-block: var(--input-padding);
    padding-inline: calc(var(--input-padding) + calc((1lh - 1ex) / 2));
    @supports (field-sizing: content) {
      field-sizing: content;
      max-block-size: calc(3lh + (2 * var(--input-padding)));
      min-block-size: calc(1lh + (2 * var(--input-padding)));
    }
  }
  .input--invisible {
    background-color: transparent;
    block-size: 5px;
    border: none;
    inline-size: 5px;
    opacity: 0.1;
    &:focus {
      outline: none;
    }
  }
  /* Switches */
  .switch {
    --switch-color: var(--color-ink-medium);
    --switch-hover-brightness: 0.9;
    block-size: 1.75em;
    border-radius: 2em;
    display: inline-flex;
    inline-size: 3em;
    position: relative;
    &:has(:focus-visible) {
      .switch__btn {
        outline: var(--focus-ring-size) solid var(--focus-ring-color);
      }
    }
  }
  .switch__input {
    block-size: 0;
    inline-size: 0;
    opacity: 0.1;
  }
  .switch__btn {
    background-color: var(--switch-color);
    border-radius: 2em;
    cursor: pointer;
    inset: 0;
    outline-offset: var(--focus-ring-offset);
    position: absolute;
    transition: 150ms ease;
    &::before {
      background-color: var(--color-ink-inverted);
      block-size: 1.35em;
      border-radius: 50%;
      content: "";
      inline-size: 1.35em;
      inset-block-end: 0.2em;
      inset-inline-start: 0.2em;
      position: absolute;
      transition: 150ms ease;
    }
    @media (any-hover: hover) {
      &:hover {
        background-color: color-mix(in srgb, var(--switch-color) 80%, var(--color-ink));
      }
    }
    .switch__input:checked + & {
      --switch-color: var(--color-link);
      &::before {
        transform: translateX(1.2em);
      }
    }
    .switch__input:disabled + & {
      --switch-color: var(--color-ink-medium);
      cursor: not-allowed;
      opacity: 0.5;
    }
  }
  /* Containers that act like (and contain) inputs */
  .input--actor {
    outline-offset: -1px;
    transition: box-shadow 150ms ease, outline-offset 150ms ease;
    &:focus-within {
      --input-border-color: var(--color-selected-dark);
      outline: var(--focus-ring-size) solid var(--focus-ring-color);
    }
    .input {
      --input-padding: 0;
      --input-border-radius: 0;
      --input-background: transparent;
      --input-border-size: 0;
      inline-size: 100%;
      outline: 0;
    }
    &:has(.input:is(
      :autofill,
      :-webkit-autofill,
      :-webkit-autofill:hover,
      :-webkit-autofill:focus)) {
        -webkit-text-fill-color: var(--color-text);
        -webkit-box-shadow: 0 0 0px 1000px var(--color-selected) inset;
    }
  }
  .input--hidden {
    block-size: 0;
    inline-size: 0;
    opacity: 0;
    padding: 0;
  }
  .input.boost__input {
    --input-border-radius: 0;
    --input-border-size: 0;
    --input-padding: 0;
    color: inherit;
    font-size: inherit;
    font-weight: inherit;
    inline-size: min-content;
    max-inline-size: 3ch;
    min-inline-size: 1ch;
    outline: none;
    @supports (field-sizing: content) {
      field-sizing: content;
      max-inline-size: unset;
    }
    &:focus {
      background-color: var(--color-highlight);
    }
    &::-webkit-outer-spin-button,
    &::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
  }
}

================
File: app/assets/stylesheets/ios.css
================
@layer platform {
  :root:has([data-platform~=ios]) {
    &[data-text-size=xsmall] { font-size: 14px; }
    &[data-text-size=small] { font-size: 15px; }
    &[data-text-size=medium] { font-size: 16px; }
    &[data-text-size=large] { font-size: 17px; }
    &[data-text-size=xlarge] { font-size: 19px; }
    &[data-text-size=xxlarge] { font-size: 21px; }
    &[data-text-size=xxxlarge] { font-size: 23px; }
  }
  [data-platform~=ios] {
    .hide-on-ios {
      display: none;
    }
    /* Events
    /* ------------------------------------------------------------------------ */
    .events__column-header {
      -webkit-backdrop-filter: blur(16px);
      backdrop-filter: blur(16px);
      background-color: oklch(from var(--color-canvas) l c h / 0.5);
      border-radius: 10em;
    }
  }
}

================
File: app/assets/stylesheets/knobs.css
================
@layer components {
  .knob {
    --knob-angle-reserve: 120deg;
    --knob-option-angle: calc((360deg - var(--knob-angle-reserve)) / (var(--knob-options) - 1));
    --knob-option-size: 3ch;
    --knob-chamfer-size: 1ch;
    --knob-color: oklch(var(--lch-ink-light));
    --knob-color-accent: oklch(var(--lch-blue-medium));
    --knob-tick-size: 1ch;
    --knob-radius: calc(var(--knob-size) / 2);
    --knob-size: 96px;
    border: none;
    display: block;
    font-weight: 500;
    padding: var(--knob-option-size) 0 0;
    position: relative;
    text-align: center;
  }
  .knob__slider {
    appearance: none;
    background-color: transparent;
    block-size: var(--knob-size);
    inline-size: var(--knob-size);
    inset: 50% auto auto 50%;
    opacity: 0;
    position: absolute;
    translate: -50% -50%;
    z-index: 1;
    &::-moz-range-track {
      block-size: var(--knob-size);
      cursor: grab;
    }
    &::-webkit-slider-runnable-track {
      block-size: var(--knob-size);
      cursor: grab;
    }
    &::-moz-range-thumb {
      background-color: transparent;
      border: none;
      border-radius: 0;
    }
    &::-webkit-slider-thumb {
      appearance: none;
      background-color: transparent;
      height: 1px;
      width: 1px;
    }
  }
  .knob__option {
    block-size: var(--knob-option-size);
    border-radius: 50%;
    cursor: pointer;
    display: grid;
    inline-size: var(--knob-option-size);
    inset: 50% auto auto 50%;
    place-content: center;
    position: absolute;
    transform:
      translate(-50%, -50%)
      rotate(calc(-1 * ((360deg - var(--knob-angle-reserve)) / 2) + (var(--knob-option-angle) * var(--i))))
      translateY(calc(-1 * var(--knob-radius) - 50% - var(--knob-tick-size)));
    z-index: 1;
    &:hover,
    &:has(input:checked) {
      color: var(--knob-color-accent);
    }
    &:has(:focus-visible) {
      outline: var(--focus-ring-size) solid var(--focus-ring-color);
      outline-offset: 0;
    }
    /* Tick marks */
    &:before {
      background-color: var(--knob-color);
      block-size: var(--knob-tick-size);
      content: "";
      inline-size: 2px;
      inset: 100% auto auto 50%;
      position: absolute;
      translate: -50% 0;
    }
    /* The value text */
    span {
      rotate: calc(((360deg - var(--knob-angle-reserve)) / 2) - (var(--knob-option-angle) * var(--i)));
    }
    input {
      opacity: 0;
      position: absolute;
    }
  }
  .knob__knob {
    background: linear-gradient(to top, var(--knob-color), color-mix(in oklch, var(--knob-color) 50%, var(--color-canvas) 50%));
    block-size: var(--knob-size);
    border-radius: 50%;
    box-shadow:
      0 0 2px 1px rgba(0,0,0,0.10),
      0 2px 4px rgba(0,0,0,0.15),
      0 2px 8px rgba(0,0,0,0.20);
    inline-size: var(--knob-size);
    margin-inline: auto;
    position: relative;
    &:before,
    &:after {
      content: "";
      position: absolute;
    }
    /* Indent */
    &:before {
      background: linear-gradient(to bottom, var(--knob-color), color-mix(in oklch, var(--knob-color) 50%, var(--color-canvas) 50%));
      block-size: calc(var(--knob-size) - var(--knob-chamfer-size));
      border-radius: 50%;
      box-shadow:
        0 -1px 0 rgba(255, 255, 255, 0.25),
        inset 0 -1px 0 rgba(255, 255, 255, 0.25);
      inline-size: calc(var(--knob-size) - var(--knob-chamfer-size));
      inset: 50% auto auto 50%;
      translate: -50% -50%;
    }
    /* Indicator */
    &:after {
      background-color: var(--color-ink);
      block-size: calc(var(--knob-radius) - var(--knob-chamfer-size) / 2);
      border-radius: 50% 50% 2px 2px;
      inline-size: 4px;
      inset: auto auto 50% 50%;
      rotate: calc(-1 * ((360deg - var(--knob-angle-reserve)) / 2) + (var(--knob-option-angle) * var(--knob-index)));
      transform-origin: center bottom;
      transition: rotate 100ms;
      translate: -50% 0;
    }
  }
  .knob__label {
    font-weight: bold;
    margin-block-start: 1ch;
    text-transform: uppercase;
  }
}

================
File: app/assets/stylesheets/layout.css
================
@layer base {
  body {
    display: grid;
    grid-template-rows: auto 1fr auto 9em;
    &.public {
      grid-template-rows: auto 1fr auto;
    }
    &.compact-on-touch {
      @media (any-hover: none) {
        grid-template-rows: auto 1fr auto;
        min-height: unset;
      }
    }
  }
  /* Required for the card column page on mobile, but not needed otherwise */
  :where(#global-container) {
    display: contents;
  }
  :where(#header) {
    position: relative;
    z-index: var(--z-nav);
  }
  :where(#main) {
    inline-size: 100dvw;
    margin-inline: auto;
    max-inline-size: 100dvw;
    padding-inline:
      calc(var(--main-padding) + var(--custom-safe-inset-left))
      calc(var(--main-padding) + var(--custom-safe-inset-right));
    text-align: center;
  }
  :where(#footer) {
    max-inline-size: 100dvw;
  }
  :is(#header, #footer) {
    @media print {
      display: none;
    }
  }
}

================
File: app/assets/stylesheets/lexxy.css
================
@layer components {
  /* Editor
  /* ------------------------------------------------------------------------ */
  lexxy-editor {
    display: block;
    position: relative;
    overflow: visible;
    figure.node--selected,
    div.node--selected {
      &:has(img) {
        img {
          outline: var(--focus-ring-size) solid var(--focus-ring-color);
          outline-offset: var(--focus-ring-offset);
        }
      }
      &:not(:has(img)) {
        outline: var(--focus-ring-size) solid var(--focus-ring-color);
        outline-offset: var(--focus-ring-offset);
      }
    }
  }
  .lexxy-content__table-wrapper {
    margin: 0;
    margin-block: 1ch;
    overflow-x: auto;
  }
  table {
    th, td {
      &.table-cell--selected {
        background-color: var(--color-selected-light);
      }
      &.lexxy-content__table-cell--selected {
        background-color: var(--color-selected);
        border-color: var(--color-selected-dark);
      }
    }
    &.lexxy-content__table--selection {
      ::selection {
        background: transparent;
      }
    }
  }
  /* Lexical uses the `lexxy-editor--empty` class even if you have a list
   * started but haven't added other characters. Here, we hide the placeholder
   * when you click the List button in the toolbar. */
  .lexxy-editor--empty {
    .lexxy-editor__content:not(:has(ul, ol))::before {
      content: attr(placeholder);
      color: currentColor;
      cursor: text;
      opacity: 0.66;
      pointer-events: none;
      position: absolute;
      white-space: pre-line;
    }
  }
  .lexxy-editor__content {
    margin-block-start: var(--block-space-half);
    min-block-size: calc(7lh + var(--block-space));
    outline: 0;
    /* Allow color highlights to show through a bit */
    ::selection {
      background: oklch(var(--lch-blue-light) / 0.5);
    }
    > :last-child {
      margin-block-end: 0;
    }
  }
  .lexxy-editor--drag-over {
    background-color: var(--color-selected);
    border-radius: 4px;
    outline: 2px dashed var(--color-selected-dark);
  }
  .lexxy-code-language-picker {
    --caret-icon: url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='m12 19.5c-.7 0-1.3-.3-1.7-.8l-9.8-11.1c-.7-.8-.6-1.9.2-2.6.8-.6 1.9-.6 2.5.2l8.6 9.8c0 .1.2.1.4 0l8.6-9.8c.7-.8 1.8-.9 2.6-.2s.9 1.8.2 2.6l-9.8 11.1c-.4.5-1.1.8-1.7.8z' fill='%23000'/%3E%3C/svg%3E");
    --caret-icon-dark: url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='m12 19.5c-.7 0-1.3-.3-1.7-.8l-9.8-11.1c-.7-.8-.6-1.9.2-2.6.8-.6 1.9-.6 2.5.2l8.6 9.8c0 .1.2.1.4 0l8.6-9.8c.7-.8 1.8-.9 2.6-.2s.9 1.8.2 2.6l-9.8 11.1c-.4.5-1.1.8-1.7.8z' fill='%23fff'/%3E%3C/svg%3E");
    -webkit-appearance: none;
    appearance: none;
    background-color: var(--color-canvas);
    background-image: var(--caret-icon);
    background-position: center right 0.9em;
    background-repeat: no-repeat;
    background-size: 0.5em;
    border: 1px solid var(--color-ink-light);
    border-radius: 99rem;
    color: var(--color-ink);
    cursor: pointer;
    font-family: var(--font-base);
    font-size: var(--text-x-small);
    font-weight: 500;
    inset-inline-end: 0;
    line-height: 1.15lh;
    margin: 0.75ch 0.75ch 0 0;
    padding-inline: 1.5ch 1.8em;
    text-align: start;
    html[data-theme="dark"] & {
      --caret-icon: var(--caret-icon-dark);
    }
    @media (prefers-color-scheme: dark) {
      html:not([data-theme]) & {
        --caret-icon: var(--caret-icon-dark);
      }
    }
    option {
      background-color: var(--color-canvas);
      color: var(--color-ink);
    }
  }
  /* Toolbar
  /* ------------------------------------------------------------------------ */
  /* TODO: Temporary - hide table button while we work on the styles */
  button[name="table"] {
    display: none;
  }
  lexxy-toolbar {
    --lexxy-toolbar-icon-size: 1em;
    background-color: var(--lexxy-bg-color, var(--color-canvas));
    border-block-end: 1px solid var(--color-ink-light);
    color: currentColor;
    display: flex;
    font-size: inherit;
    margin: 0;
    max-inline-size: 100%;
    padding: 0.2em 0;
    position: relative;
    position: sticky;
    inset-block-start: 0;
    z-index: 2;
  }
  .lexxy-editor__toolbar-button {
    --toolbar-button-size: 44px;
    appearance: none;
    aspect-ratio: 1;
    background-color: transparent;
    block-size: var(--toolbar-button-size);
    border: none;
    border-radius: 0.2em;
    color: currentColor;
    cursor: pointer;
    display: grid;
    font-size: inherit;
    place-items: center;
    &:is(:focus, :hover) {
      background-color: var(--color-ink-lighter);
      box-shadow: none;
    }
    &:is(:active),
    &[aria-pressed="true"] {
      background-color: var(--color-selected);
    }
    svg {
      -webkit-touch-callout: none;
      block-size: var(--lexxy-toolbar-icon-size);
      fill: currentColor;
      grid-area: 1/1;
      inline-size: var(--lexxy-toolbar-icon-size);
      user-select: none;
    }
    @media (min-width: 640px) {
      --toolbar-button-size: 2em;
    }
  }
  .lexxy-editor__toolbar-overflow-menu {
    background-color: var(--color-canvas);
    border-radius: 0.5ch;
    box-shadow: var(--shadow);
    display: flex;
    flex-wrap: wrap;
    inset-inline-end: 0;
    padding: 4px;
    position: absolute;
    z-index: 2;
  }
  .lexxy-editor__toolbar-spacer {
    flex: 1;
  }
  /* Dropdowns
  /* ------------------------------------------------------------------------ */
  .lexxy-editor__toolbar-dropdown-content {
    --lexxy-dropdown-padding: 0.75rem;
    --lexxy-dropdown-btn-size: 2rem;
    background-color: var(--color-canvas);
    border: 1px solid var(--color-ink-lighter);
    border-radius: 0.5em;
    box-shadow: var(--shadow);
    color: var(--color-ink);
    font-size: var(--text-small);
    padding: var(--lexxy-dropdown-padding);
    position: absolute;
    z-index: 2;
    button {
      block-size: var(--lexxy-dropdown-btn-size);
    }
  }
  .lexxy-editor__toolbar-dropdown-actions {
    display: flex;
    font-size: var(--text-x-small);
    flex: 1 1 0%;
    gap: var(--lexxy-dropdown-padding);
    margin-block-start: var(--lexxy-dropdown-padding);
    .btn {
      --radius: 99rem;
      inline-size: 100%;
    }
    .btn[type="submit"] {
      --btn-background: var(--card-color, var(--color-link));
      --btn-color: var(--color-ink-inverted);
      --focus-ring-color: var(--card-color, var(--color-link));
    }
    span {
      inline-size: 100%;
    }
  }
  lexxy-link-dropdown {
    .input {
      min-inline-size: 30ch;
    }
  }
  lexxy-highlight-dropdown {
    --gap: 0.5ch;
    [data-button-group] {
      display: flex;
      flex-direction: row;
      gap: var(--gap);
      + & {
        margin-block-start: var(--gap);
      }
      @media (max-width: 639px) {
        flex-wrap: wrap;
      }
    }
  }
  .lexxy-highlight-button {
    --outline-color: oklch(var(--lch-ink-darkest) / 0.2);
    appearance: none;
    background: var(--color-canvas);
    border: none;
    border-radius: 0.5ch;
    color: inherit;
    display: grid;
    font-weight: 500;
    inline-size: var(--lexxy-dropdown-btn-size);
    place-content: center;
    position: relative;
    outline: none;
    &:after {
      content: "Aa";
    }
    &:hover,
    &[aria-pressed="true"] {
      box-shadow: 0 0 0 1px var(--color-canvas), 0 0 0 3px var(--outline-color);
    }
    &[aria-pressed="true"] {
      --outline-color: var(--color-link);
      &:after {
        content: "";
      }
    }
  }
  .lexxy-editor__toolbar-dropdown-reset {
    background: var(--color-canvas);
    border: 1px solid var(--color-ink-light);
    border-radius: 99rem;
    inline-size: 100%;
    margin-block-start: var(--lexxy-dropdown-padding);
    &[disabled] {
      display: none;
    }
  }
  .lexxy-table-handle-buttons {
    --button-size: 2.5em;
    color: var(--color-ink-inverted);
    display: none;
    flex-direction: row;
    font-size: var(--text-x-small);
    gap: 0.25ch;
    line-height: 1;
    position: absolute;
    transform: translate(-50%, -120%);
    z-index: 1;
    &:has([open]) {
      z-index: 4;
    }
    .lexxy-table-control {
      align-items: center;
      background-color: var(--color-ink);
      border-radius: 0.75ch;
      display: flex;
      flex-direction: row;
      gap: 1ch;
      padding: 2px;
      white-space: nowrap;
      button,
      summary {
        aspect-ratio: 1 / 1;
        align-items: center;
        background-color: transparent;
        border-radius: 0.5ch;
        border: 0;
        color: var(--color-ink-inverted);
        cursor: pointer;
        display: flex;
        font-size: inherit;
        font-weight: 700;
        justify-content: center;
        line-height: 1;
        list-style: none;
        min-block-size: var(--button-size);
        min-inline-size: var(--button-size);
        padding: 0;
        user-select: none;
        -webkit-user-select: none;
        &:hover {
          background-color: var(--color-ink-darker);
        }
        &:focus,
        &:focus-visible {
          background-color: var(--color-ink-darker);
          outline: var(--focus-ring-size) solid var(--focus-ring-color);
          outline-offset: var(--focus-ring-offset);
        }
        svg {
          block-size: 1em;
          inline-size: 1em;
          fill: currentColor;
        }
        span {
          display: none;
        }
      }
    }
    .lexxy-table-control__more-menu {
      gap: 0;
      padding: 2px;
      position: relative;
      summary {
        &::-webkit-details-marker {
          display: none;
        }
      }
      .lexxy-table-control__more-menu-details {
        display: flex;
        flex-direction: column;
        gap: 0.25ch;
        inset-block-start: 105%;
        inset-inline-end: 0;
        padding: 0;
        position: absolute;
        .lexxy-table-control__more-menu-section {
          background: var(--color-ink);
          border-radius: 0.75ch;
          display: flex;
          flex-direction: column;
          padding: 2px;
        }
        button {
          aspect-ratio: unset;
          align-items: center;
          flex-direction: row;
          font-weight: normal;
          gap: 1ch;
          justify-content: flex-start;
          padding: 0.5ch 2ch;
          padding-inline-start: 1ch;
          white-space: nowrap;
          svg {
            block-size: 1.3em;
            inline-size: 1.3em;
          }
          span {
            display: inline-block;
          }
        }
      }
    }
  }
  /* Prompt menu (@mentions, etc.)
  /* ------------------------------------------------------------------------ */
  .lexxy-prompt-menu {
    --lexxy-prompt-avatar-size: 24px;
    --lexxy-prompt-min-width: 20ch;
    --lexxy-prompt-padding: 0.5ch;
    background-color: var(--color-canvas);
    border-radius: calc(var(--lexxy-prompt-padding) * 2);
    box-shadow: var(--shadow);
    color: var(--color-ink);
    font-family: var(--font-sans);
    font-size: var(--text-small);
    list-style: none;
    margin: 0;
    max-height: 200px;
    min-inline-size: var(--lexxy-prompt-min-width);
    overflow: auto;
    padding: var(--lexxy-prompt-padding);
    visibility: hidden;
    z-index: var(--z-popup);
  }
  .lexxy-prompt-menu--visible {
    visibility: initial;
  }
  .lexxy-prompt-menu__item {
    align-items: center;
    border-radius: 0.5ch;
    cursor: pointer;
    display: flex;
    gap: var(--lexxy-prompt-padding);
    padding: var(--lexxy-prompt-padding);
    white-space: nowrap;
    &:hover {
      background-color: var(--color-ink-lightest);
    }
    &[aria-selected] {
      background-color: var(--color-selected);
    }
    img {
      block-size: var(--lexxy-prompt-avatar-size);
      border-radius: 50%;
      flex-shrink: 0;
      inline-size: var(--lexxy-prompt-avatar-size);
      margin: 0;
    }
    + & {
      margin-top: 2px;
    }
    code {
      background-color: var(--color-terminal-text-light);
      border-radius: 0.25ch;
      font-size: 0.95em;
      padding-inline: 0.5ch;
    }
  }
  /* Empty state */
  .lexxy-prompt-menu__item--empty {
    color: var(--color-ink-medium);
    padding: var(--lexxy-prompt-padding);
  }
}

================
File: app/assets/stylesheets/lightbox.css
================
@layer components {
  .lightbox {
    --dialog-duration: 350ms;
    --lightbox-padding: 3vmin;
    background-color: transparent;
    block-size: 100dvh;
    border: 0;
    inline-size: 100dvw;
    inset: 0;
    margin: auto;
    max-height: unset;
    max-width: unset;
    overflow: hidden;
    padding:
      calc(var(--lightbox-padding) + var(--custom-safe-inset-top))
      calc(var(--lightbox-padding) + var(--custom-safe-inset-right))
      calc(var(--lightbox-padding) + var(--custom-safe-inset-bottom))
      calc(var(--lightbox-padding) + var(--custom-safe-inset-left));
    text-align: center;
    &::backdrop {
      -webkit-backdrop-filter: blur(16px);
      backdrop-filter: blur(16px);
      background-color: oklch(var(--lch-black) / 50%);
    }
    /* Closed state */
    &,
    &::backdrop {
      opacity: 0;
      transition: var(--dialog-duration) allow-discrete;
      transition-property: display, opacity, overlay;
    }
    /* Open state */
    &[open],
    &[open]::backdrop {
      align-items: center;
      display: flex;
      justify-content: center;
      opacity: 1;
      @starting-style {
        opacity: 0;
      }
      .lightbox__figure {
        animation: slide-up var(--dialog-duration);
      }
    }
  }
  .lightbox__actions {
    display: flex;
    gap: 1ch;
    inset:
      calc(var(--lightbox-padding) + var(--custom-safe-inset-top))
      calc(var(--lightbox-padding) + var(--custom-safe-inset-right))
      auto
      auto;
    position: absolute;
  }
  .lightbox__figure {
    animation-fill-mode: forwards;
    animation: slide-down var(--dialog-duration);
    display: flex;
    flex-direction: column;
    gap: var(--lightbox-padding);
    margin: 0 auto;
    max-block-size: 100%;
    img {
      object-fit: contain;
    }
  }
  .lightbox__caption {
    color: var(--color-white);
    &:empty {
      display: none;
    }
    &[tabindex="-1"]:focus-visible {
      outline: unset;
    }
  }
  .lightbox__image {
    flex: 1;
    min-block-size: 0;
  }
  /* Prevent body from scrolling when lightbox is open */
  html:has(.lightbox[open]) {
    overflow: clip;
  }
}

================
File: app/assets/stylesheets/markdown.css
================
@layer components {
  .heading__link {
    --opacity: 0.5;
    --size: 0.8em;
    background: url(link.svg) no-repeat center bottom 0.2em;
    background-size: var(--size);
    block-size: 1em;
    color: var(--color-link);
    display: inline-flex;
    font-size: var(--size);
    inline-size: var(--size);
    padding: 1em 0 0;
    opacity: var(--opacity);
    overflow: hidden;
    transition: opacity 300ms ease;
    vertical-align: middle;
    @media (hover: hover) {
      --opacity: 0;
      :is(h1, h2, h3, h4, h5, h6):hover & {
        --opacity: 0.5;
      }
    }
    html[data-theme="dark"] & {
      filter: invert(1);
    }
    @media (prefers-color-scheme: dark) {
      html:not([data-theme]) & {
        filter: invert(1);
      }
    }
  }
}

================
File: app/assets/stylesheets/native.css
================
@layer native {
  [data-platform~=native] {
    --footer-height: 0;
    -webkit-tap-highlight-color: transparent;
    .hide-on-native {
      display: none;
    }
    /* Layout
    /* ------------------------------------------------------------------------ */
    &:not(.contained-scrolling) {
      #main {
        padding-block-end: var(--custom-safe-inset-bottom);
      }
    }
    /* Header
    /* ------------------------------------------------------------------------ */
    .header:is(
      :not(:has(.header__title, .header__actions)),
      :not(:has(.header__title, .header__actions--end)):has(.header__actions--start .btn--back:only-child)
    ) {
      block-size: var(--custom-safe-inset-top);
      padding: unset;
      * {
        display: none;
      }
    }
    .header__actions {
      .btn--back {
        display: none;
      }
    }
    /* Card columns
    /* ------------------------------------------------------------------------ */
    .board-tools.card {
      padding-block-start: 0;
    }
    /* Card perma
    /* ------------------------------------------------------------------------ */
    .card-perma {
      margin-block-start: 0;
      &:not(:has(.card-perma__notch-new-card-buttons)) .card-perma__bg {
        padding-block: clamp(0.25rem, 2vw, var(--padding-block));
      }
    }
    .card-perma__bg {
      border-start-start-radius: calc(0.2em + clamp(0.25rem, 2vw, var(--padding-block)));
      border-start-end-radius: calc(0.2em + clamp(0.25rem, 2vw, var(--padding-block)));
    }
    .card-perma__closure-message {
      margin-block: var(--block-space);
      translate: unset;
    }
    /* Search
    /* ------------------------------------------------------------------------ */
    .search__title {
      text-decoration: none;
    }
  }
}
[data-bridge-components~=form] {
  [data-controller~=bridge--form] {
    [data-bridge--form-target~=submit] {
      display: none;
    }
  }
}
[data-bridge-components~=overflow-menu] {
  [data-controller~=bridge--overflow-menu] {
    [data-bridge--overflow-menu-target~=item] {
      display: none;
    }
  }
}
[data-bridge-components~=buttons] {
  [data-bridge--buttons-target~=button] {
    display: none;
  }
}

================
File: app/assets/stylesheets/nav.css
================
@layer components {
  /* Trigger
  /* ------------------------------------------------------------------------ */
  .nav__trigger {
    --input-background: transparent;
    --input-border-color: transparent;
    --input-padding: 0.3em 2em 0.3em 0.75em;
    font-weight: 600;
    inline-size: auto;
    margin-block-start: 0.1em;
    ::-webkit-search-cancel-button {
      -webkit-appearance: none;
    }
    @media (any-hover: hover) {
      &:hover {
        --input-background: var(--color-ink-lighter);
        span {
          background: var(--color-ink-lighter);
        }
      }
    }
    span {
      background: var(--color-ink-lightest);
      block-size: auto;
      border-radius: 0.3125em;
      box-shadow:
        0 0 0 1px oklch(var(--lch-ink-darkest) / 0.1),
        0 0.1em 0.2em -0.1em oklch(var(--lch-ink-darkest) / 0.05),
        0 0.2em 0.4em -0.2em oklch(var(--lch-ink-darkest) / 0.05),
        0 0.3em 0.6em -0.3em oklch(var(--lch-ink-darkest) / 0.05)
      ;
      display: grid;
      height: 1.5em;
      inline-size: 1.5em;
      padding: 0.325em 0.275em 0.225em 0.275em;
      place-content: center;
      width: 1.5em;
    }
    svg {
      height: 100%;
      margin-inline-start: 0.4125em;
      margin-inline-end: 0.5375em;
      max-height: 0.8625em;
      overflow: visible;
      width: auto;
    }
  }
  /* Dialog
  /* ------------------------------------------------------------------------ */
  .nav__menu.popup {
    --panel-border-color: var(--color-selected-dark);
    --panel-border-radius: 1.4em;
    --panel-padding: var(--block-space);
    --panel-size: 45ch;
    --popup-display: grid;
    --nav-section-gap: 2px;
    block-size: auto;
    box-shadow: 0 0 0 1px oklch(var(--lch-blue-medium) / 5%),
                0 0.2em 0.2em oklch(var(--lch-blue-medium) / 5%),
                0 0.4em 0.4em oklch(var(--lch-blue-medium) / 5%),
                0 0.8em 0.8em oklch(var(--lch-blue-medium) / 5%);
    grid-template-rows: auto 1fr auto;
    gap: var(--nav-section-gap);
    max-block-size: calc(100vh - var(--block-space) - var(--footer-height));
    overflow: hidden;
    padding-block-end: 0;
    scrollbar-gutter: stable both-edges;
    z-index: var(--z-nav);
    @media (max-height: 668px) {
      max-block-size: calc(100vh - var(--block-space));
    }
  }
  .nav__scroll-container {
    display: flex;
    flex-direction: column;
    gap: var(--nav-section-gap);
    margin-inline: calc(-1 * var(--block-space)); /* space for scrollbar */
    overflow: auto;
    padding-block-end: var(--nav-section-gap);
    padding-inline: var(--block-space);
  }
  .nav__close {
    @media (any-hover: hover) {
      display: none !important;
    }
  }
  .nav__section {
    border-block-start: 1px solid var(--color-ink-lighter);
    font-size: var(--text-small);
    &[open] {
      padding-block-end: 0.4rem;
    }
  }
  .nav__section--secret:not([data-is-filtering]) {
    display: none;
  }
  .nav__header {
    --actions-width: 2rem;
    display: grid;
    grid-template-columns: var(--actions-width) 1fr var(--actions-width);
    grid-template-areas:
      "actions-start title actions-end";
    justify-items: center;
  }
  .nav__header-actions {
    display: flex;
    font-size: var(--text-x-small);
    gap: var(--inline-space);
    inline-size: var(--actions-width);
    min-inline-size: fit-content;
  }
  .nav__header-actions--end {
    grid-area: actions-end;
    justify-content: flex-end;
    margin-inline-start: auto;
  }
  .nav__header-actions--start {
    grid-area: actions-start;
    margin-inline-end: auto;
  }
  .nav__header-title {
    color: inherit;
    grid-area: title;
    justify-content: center;
    margin: auto;
    min-inline-size: 0;
    text-align: center;
  }
  .nav__hotkeys {
    --gap: 8px;
    align-items: center;
    display: flex;
    flex-wrap: wrap;
    gap: var(--gap);
    inline-size: 100%;
    list-style: none;
    justify-content: center;
    margin: var(--block-space) auto calc(var(--block-space-half) / 2);
    max-inline-size: 100%;
    /* When all its children are hidden, hide this as well so it doesn't take up space */
    &:has(.popup__item[hidden]):not(:has(.popup__item:not([hidden]))) {
      display: none;
    }
    .btn {
      --btn-border-radius: 0.4em;
      align-content: end;
      aspect-ratio: 5/3;
      background-color: var(--color-ink-lightest);
      border-radius: 0.5em;
      container-type: inline-size;
      flex-basis: calc((100% - var(--gap) * 2) / 3);
      flex-direction: column;
      font-size: var(--text-small);
      line-height: 1;
      justify-content: center;
      overflow: hidden;
      position: relative;
      row-gap: 0.3lh;
      text-align: center;
      kbd {
        inset: 0.66em 0.33em auto auto;
        line-height: 1.4;
        opacity: 0.5;
        position: absolute;
        @media (any-hover: none) {
          /* This is a reasonable way to assert touch devices. any-pointer would seem */
          /* to be a better fit but it is incorrectly reported on many devices */
          display: none;
        }
      }
      .icon {
        --icon-size: 2em !important;
      }
      span {
        display: flex;
        text-wrap: nowrap;
      }
      @media (max-width: 639px) {
        font-size: var(--text-x-small);
        font-size: clamp(var(--text-xx-small), 3.15cqi, var(--text-small));
        font-weight: 500;
      }
    }
  }
  .nav__blank-slate {
    font-size: var(--text-small);
    margin: 2rem auto;
    .nav:has(.popup__item:not([hidden])) & {
      display: none;
    }
  }
  .nav__footer {
    background-color: var(--color-canvas);
    border-block-start: 1px solid var(--color-ink-lighter);
    font-size: var(--text-small);
    line-height: 1.6;
    margin-block-start: calc(-1 * var(--nav-section-gap));
    padding: 1.5ch;
    text-align: center;
    z-index: 1;
    @media (max-height: 668px) {
      font-size: var(--text-x-small);
    }
  }
}

================
File: app/assets/stylesheets/notifications.css
================
@layer components {
  /* Notifications list
  /* ------------------------------------------------------------------------ */
  .notifications-list {
    --panel-size: 45ch;
    .tray__item {
      position: relative;
      &[aria-selected] {
        outline: 0;
        .card {
          border-radius: 0.25ch;
          outline: var(--focus-ring-size) solid var(--focus-ring-color);
          outline-offset: var(--focus-ring-offset);
        }
      }
    }
    .card {
      @media (prefers-color-scheme: dark) {
        box-shadow: 0 0 0 1px var(--color-ink-lighter);
      }
    }
    .card__header {
      column-gap: var(--inline-space-half);
    }
    &:has(.card--notification) {
      .notifications-list__blank-slate {
        display: none;
      }
    }
  }
  /* Read items
  /* ------------------------------------------------------------------------ */
  .notifications-list--read {
    &:not(:has(.card--notification)) {
      display: none;
    }
    .card {
      box-shadow: 0 0 0 1px var(--color-ink-lighter);
    }
    .card__notification-unread-indicator {
      --btn-background: transparent;
      --btn-size: 1.8em;
      margin: 2px;
      .icon {
        block-size: 1.7em;
        color: var(--color-ink);
        inline-size: 1.7em;
        opacity: 1;
      }
    }
  }
 /* Help
 /* ------------------------------------------------------------------------ */
  .notifications-help {
    h2 {
      font-size: var(--text-medium);
      margin: 0;
    }
    .icon {
      --icon-size: 1.2em;
      vertical-align: text-top;
    }
    ol {
      margin-block: var(--block-space-half) var(--block-space);
      &:last-of-type {
        margin-block-end: var(--block-space-half);
      }
    }
  }
  .notifications-help__explainer {
    padding: var(--block-space);
  }
  .notifications__on-message {
    display: none;
    .notifications--on & {
      display: inline;
    }
  }
  .notifications__off-message {
    display: inline;
    .notifications--on & {
      display: none;
    }
  }
  .notifications__status {
    --panel-border-radius: 0.5em;
    --panel-padding: var(--block-space);
  }
}

================
File: app/assets/stylesheets/pagination.css
================
@layer components {
  .pagination-link {
    display: block;
    flex: 1;
    min-block-size: 1.5rem;
    pointer-events: none;
    text-decoration: none;
    &.pagination-link--active-when-observed {
      block-size: 0;
      inline-size: 0;
      overflow: hidden;
      visibility: hidden;
      turbo-frame:has(&):has(~ turbo-frame) & {
        display: none;
      }
    }
    &[aria-busy="true"] {
      .spinner {
        display: block;
      }
    }
  }
  .day-timeline-pagination-link {
    block-size: 1px;
    display: block;
    inline-size: 1px;
    overflow: clip;
  }
}

================
File: app/assets/stylesheets/panels.css
================
@layer components {
  .panel {
    background-color: var(--panel-bg, var(--color-canvas));
    border: var(--panel-border-size, 1px) solid var(--panel-border-color, var(--color-ink-lighter));
    border-radius: var(--panel-border-radius, 1em);
    color: var(--color-ink);
    inline-size: var(--panel-size, 60ch);
    max-inline-size: 100%;
    padding: var(--panel-padding, var(--block-space));
    @media (min-width: 640px) {
      --panel-size: 100%;
      padding: var(--panel-padding, var(--block-space-double));
    }
  }
  .panel--wide {
    --panel-size: 60ch;
  }
  .panel--centered {
    --panel-border-size: 0;
    --panel-size: 100%;
    @media (min-width: 640px) {
      --panel-size: 42ch;
    }
    #main:has(&) {
      display: grid;
      justify-content: center;
      margin: auto;
    }
  }
}

================
File: app/assets/stylesheets/pins.css
================
@layer components {
  .pins-list {
    --panel-size: 45ch;
  }
}

================
File: app/assets/stylesheets/popup.css
================
@layer components {
  .popup {
    --btn-background: transparent;
    --panel-border-radius: 0.5em;
    --panel-padding: var(--block-space);
    --panel-size: auto;
    --popup-icon-size: 24px;
    --popup-item-padding-inline: 0.4rem;
    --popup-display: flex;
    inset: 0 auto auto 50%;
    max-block-size: 70dvh;
    max-inline-size: min(55ch, calc(100vw - (var(--panel-padding))));
    min-inline-size: min(25ch, calc(100vw - (var(--panel-padding))));
    overflow: auto;
    position: absolute;
    transform: translateX(-50%);
    z-index: var(--z-popup);
    &[open] {
      display: var(--popup-display);
    }
    /* The .pop-up--align-<drection> classes are used for initial alignment.
     * The orient JS helper layers on the .orient-<direction> to avoid running
     * off the edge of the screen and will override .popup--align */
    &:where(.popup--align-left),
    &.orient-left {
      inset-inline: auto 0;
      transform: translateX(var(--orient-offset, 0px));
    }
    &:where(.popup--align-right),
    &.orient-right {
      inset-inline: 0 auto;
      transform: translateX(var(--orient-offset, 0px));
    }
    form {
      display: contents;
    }
  }
  .popup__footer {
    border-block-start: 1px solid var(--color-ink-lightest);
    color: var(--card-color);
    margin-block-start: var(--popup-item-padding-inline);
    padding: var(--popup-item-padding-inline) var(--popup-item-padding-inline) 0;
    text-align: center;
    text-transform: initial;
  }
  .popup__title {
    font-weight: 800;
    white-space: nowrap;
    &[tabindex="-1"]:focus-visible {
      outline: unset;
    }
  }
  /* Hide lists when all the items within are hidden */
  .popup__section {
    &:not(:has(.popup__list)),
    &:not(:has(.popup__list > *)),
    &:has(.popup__item[hidden]):not(:has(.popup__item:not([hidden]))) {
      display: none;
    }
  }
  .popup__section-title {
    background: var(--color-canvas);
    font-size: var(--text-small);
    font-weight: 600;
    inset-block-start: 0;
    list-style: none;
    padding: 0.75ch var(--inline-space-half);
    position: sticky;
    text-transform: uppercase;
    z-index: 1;
    &:is(summary) {
      align-items: center;
      cursor: pointer;
      display: flex;
      gap: 0.5ch;
    }
    &::-webkit-details-marker {
      display: none;
    }
    .icon--caret-down {
      font-size: 1ch;
      margin-inline-start: -0.5ch;
      transition: rotate 150ms ease-out;
    }
    .popup__section:not([open]) & {
      .icon--caret-down {
        rotate: -90deg;
      }
    }
  }
  .popup__list {
    display: flex;
    flex-direction: column;
    inline-size: 100%;
    list-style: none;
    margin: 0;
    max-inline-size: 100%;
    padding: 0;
    row-gap: 1px;
    details & {
      margin-inline-start: 0.75ch;
    }
  }
  .popup__item {
    align-items: center;
    background: transparent;
    border-radius: 0.3em;
    display: flex;
    inline-size: 100%;
    max-inline-size: 100%;
    @media (any-hover: hover) {
      &:hover {
        background: var(--color-ink-lightest);
      }
    }
    &:has(.popup__btn[disabled]) {
      pointer-events: none;
    }
    .checked {
      display: none;
    }
    &[aria-checked="true"] .checked {
      display: block;
    }
    &[aria-selected] {
      background-color: var(--color-selected);
      @media (any-hover: hover) {
        &:hover {
          background-color: var(--color-selected);
        }
      }
    }
  }
  /* The actionable thing with padding within popup__item */
  .popup__btn {
    --btn-border-radius: 0.3em;
    --btn-border-size: 0;
    flex: 1 1 auto;
    font-weight: 500;
    justify-content: start;
    inline-size: 100%;
    min-inline-size: 0;
    max-inline-size: 100%;
    padding: var(--inline-space-half) var(--popup-item-padding-inline);
    text-align: start;
    &:focus-visible {
      z-index: 1;
    }
  }
  .popup__icon {
    --icon-size: 1em;
    inline-size: var(--popup-icon-size);
    margin-inline-start: var(--popup-item-padding-inline);
  }
  .popup__radio {
    --icon-size: var(--text-x-small);
    block-size: var(--popup-icon-size);
    inline-size: var(--popup-icon-size);
    margin-inline-start: var(--popup-item-padding-inline);
    flex-shrink: 0;
    &:hover {
      --btn-border-color: var(--color-ink);
    }
  }
  /* Animated
  /* -------------------------------------------------------------------------- */
  .popup--animated {
    opacity: 0;
    transform: scale(0.2) translateX(-50%);
    transform-origin: top left;
    transition: var(--dialog-duration) allow-discrete;
    transition-property: display, opacity, overlay, transform;
    &::backdrop {
      background-color: var(--color-always-black);
      opacity: 0;
      transform: scale(1);
      transition: var(--dialog-duration) allow-discrete;
      transition-property: display, opacity, overlay;
    }
    &[open] {
      opacity: 1;
      transform: scale(1) translateX(-50%);
      &::backdrop {
        opacity: 0.5;
      }
    }
    @starting-style {
      &[open] {
        opacity: 0;
        transform: scale(0.2) translateX(-50%);
      }
      &[open]::backdrop {
        opacity: 0;
      }
    }
  }
}

================
File: app/assets/stylesheets/print.css
================
@media print {
  /* Global
  /* ------------------------------------------------------------------------ */
  :root {
    --color-ink: black;
    --color-canvas: white;
    --border-dark: 1px solid var(--color-ink);
    --border-light: 1px solid color-mix(in oklch, var(--color-ink), transparent 75%);
    --font-sans: "Adwaita Sans", -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Hiragino Sans GB", "Hiragino Sans", "Apple SD Gothic Neo", "Microsoft YaHei", "Meiryo", "Malgun Gothic";
  }
  @page {
    margin: 0.5in;
  }
  html {
    font-size: 10pt;
  }
  main {
    inline-size: unset;
    margin: 0;
    orphans: 3;
    padding: 0;
    widows: 2;
  }
  /* Browsers usually disable backgrounds on print, so this ensures icons
    (which use BG masks) will show up. */
  .icon,
  .knob,
  .switch {
    -webkit-print-color-adjust: exact;
    color-adjust: exact;
    print-color-adjust: exact;
  }
  .nav__menu,
  .nav__trigger,
  .header__actions {
    display: none;
  }
  .header {
    padding: 0;
  }
  .header__title {
    margin-block-end: 1ch;
  }
  /* Cards
  /* -------------------------------------------------------------------------- */
  .card {
    --card-color: var(--color-ink) !important;
    background: var(--color-canvas);
    border: var(--border-light);
    box-shadow: none;
    break-inside: avoid;
    color: var(--color-ink);
  }
  .card {
    .card__board {
      background: var(--color-canvas);
      border-block-end: var(--border-light);
      border-inline-end: var(--border-light);
      color: var(--color-ink);
    }
  }
  .card__title {
    font-weight: bold;
  }
  /* Events
  /* ------------------------------------------------------------------------ */
  .events__columns {
    border-inline: none;
  }
  .events__column-header {
    background: none;
    margin: 0;
    padding-block: 1ch;
  }
  .events__time-block {
    padding: 0 1ch;
    .events__column:first-child & {
      padding-inline-start: 0;
    }
    .events__column:last-child & {
      padding-inline-end: 0;
    }
  }
  .events__none {
    padding-block: 2ch;
  }
  .event {
    --card-color: var(--color-ink) !important;
    background: var(--color-canvas);
    border: var(--border-light);
    box-shadow: none;
    break-inside: avoid;
    color: var(--color-ink);
    .avatar {
      --avatar-size: 2lh;
    }
  }
  /* Boards
  /* ------------------------------------------------------------------------ */
  .filters,
  .card--new,
  .cards__decoration,
  .card-columns:before,
  .cards--maybe:before {
    display: none;
  }
  .card-columns {
    border-block-start: var(--border-light);
    margin-block-end: 1ch;
    min-block-size: unset;
  }
  .cards--on-deck,
  .cards--doing {
    padding-inline: 0;
  }
  .cards--maybe {
    background: none;
    margin: 0;
    padding-inline: 1ch;
    .card__header {
      margin-inline: calc(-1 * var(--card-padding-inline));
    }
    .card__body {
      padding-block-start: calc(var(--card-padding-block) / 2);
    }
  }
  /* Card perma
  /* ------------------------------------------------------------------------ */
  .card-perma__notch,
  .card-perma__actions,
  .comment--new,
  .comments__subscribers,
  .card__meta-avatars--assignees > div > div:last-child,
  .steps > .step:last-child,
  .card__board-name .icon,
  div:has(> .card__tag-picker-button),
  .delete-card,
  .header--card .header__title {
    display: none;
  }
  .card-perma {
    display: block;
    inline-size: 100%;
    margin: 0 0 1lh;
    .card {
      aspect-ratio: unset;
    }
    .card__title {
      font-size: var(--text-x-large);
    }
  }
  .card-perma__bg {
    background: transparent;
    padding: 0;
  }
  .comments {
    --row-gap: 0;
    --comment-padding-inline: 1.4lh;
    padding-inline: 0;
  }
  .comment {
    --comment-max: none;
    border-block-end: var(--border-light);
  }
  .comment__content {
    background: none;
  }
  .comment__avatar {
    --btn-size: 2lh;
    margin-inline-start: 0;
  }
  .comment__author h3 {
    margin-inline: 0;
  }
  .comment__edit {
    display: none;
  }
  .comment__body {
    text-align: start;
  }
  .reactions {
    margin-block-start: 0;
  }
  /* Settings
  /* ------------------------------------------------------------------------ */
  .settings__user-filter .input,
  .settings__user-list-tips {
    display: none;
  }
  .settings__panel {
    border: none;
    border-radius: 0;
    box-shadow: none;
    padding: 0;
    text-align: left;
    h2 {
      &:before,
      &:after {
        display: none;
      }
    }
  }
  .settings__panel--users {
    form:has(.btn--negative) {
      display: none;
    }
    .btn {
      background-color: transparent;
      border: none;
      color: var(--color-ink);
      opacity: 1;
    }
    .btn:not(:has(input:checked)) {
      opacity: 0;
    }
  }
  .settings__panel--entropy {
    display: none;
  }
  .settings__user-filter {
    background: none;
    margin: 0;
    padding: 0;
    /* Hide the "Everyone" switch */
    > li:first-child {
      display: none;
    }
  }
}

================
File: app/assets/stylesheets/pwa.css
================
/* PWA install */
.pwa__instructions {
  @media (display-mode: standalone) {
    display: none;
  }
}
.pwa__installer {
  display: none;
  .pwa--can-install & {
    display: block;
  }
}

================
File: app/assets/stylesheets/qr-codes.css
================
@layer components {
  .qr-code {
    aspect-ratio: 1;
    block-size: 50dvh;
  }
}

================
File: app/assets/stylesheets/reactions.css
================
@layer components {
  .reactions {
    --btn-icon-size: 1.3em;
    --column-gap: 0.4ch;
    --reaction-border-color: var(--color-ink-lighter);
    --row-gap: 0;
    align-items: center;
    display: flex;
    flex-wrap: wrap;
    gap: var(--inline-space-half);
    inline-size: 100%;
    &:has([open]) {
      z-index: var(--z-popup);
    }
    &:not(:has(.reaction)) {
      inline-size: auto;
      inset-block-end: var(--comment-padding-block);
      inset-inline-end: calc(var(--comment-padding-inline) / 2);
      margin: 0;
      position: absolute;
      @media (max-width: 640px) {
        inset-inline-end: calc(var(--comment-padding-inline) / 3);
      }
      .reactions__list {
        display: none;
      }
      .reactions__trigger {
        --btn-border-color: var(--color-ink-lightest);
        background-color: var(--color-ink-lightest);
      }
    }
  }
  .reactions__trigger {
    --btn-size: var(--reaction-size);
    --btn-border-color: var(--reaction-border-color);
    img {
      block-size: 65%;
      inline-size: 65%;
    }
  }
  .reactions__list {
    display: inline-flex;
    flex-wrap: wrap;
    gap: var(--inline-space-half);
    &:not(:has(.reaction)) {
      display: none;
    }
  }
  /* Single reaction
  /* -------------------------------------------------------------------------- */
  .reaction {
    --btn-size: 100%;
    --reaction-hover-brightness: 0.9;
    align-items: center;
    background-color: var(--color-canvas);
    block-size: var(--reaction-size);
    border: 1px solid var(--reaction-border-color);
    border-radius: 4rem;
    display: inline-flex;
    gap: 0.25ch;
    max-inline-size: 100%;
    opacity: 1;
    padding: 0.1em 0.36em 0.1em 0.12em;
    position: relative;
    transition: opacity 100ms ease-in-out, transform 150ms ease-in-out;
    &:has(span.txt-small.txt-medium) { /* emoji only reactions */
      padding: 0.1em 0.12em;
    }
    .btn {
      font-size: 0.6em;
      inline-size: auto;
    }
  }
  .reaction--deleteable {
    cursor: pointer;
    @media (any-hover: hover) {
      &:not(.expanded):hover {
        filter: brightness(var(--reaction-hover-brightness));
        html[data-theme="dark"] & {
          --reaction-hover-brightness: 1.25;
        }
        @media (prefers-color-scheme: dark) {
          html:not([data-theme]) & {
            --reaction-hover-brightness: 1.25;
          }
        }
      }
    }
  }
  /* Make the avatar and delete buttons fit nicely within the reaction */
  .reaction__avatar,
  .reaction__avatar .avatar,
  .reaction__form-label,
  .reaction form {
    block-size: 100%;
  }
  .reaction__delete {
    display: none;
    .expanded & {
      display: grid;
    }
  }
  .reaction__form {
    transition: none;
    &.expanded {
      animation: react 300ms both;
      transform: translate3d(0, 0, 0);
      transform-origin: left center;
    }
    &:has(.input:focus) {
      outline: var(--focus-ring-size) solid var(--focus-ring-color);
      outline-offset: -1px;
    }
    .reaction__form-label:focus {
      outline: none;
    }
  }
  .reaction__input {
    --input-background: transparent;
    --input-border-size: 0;
    --input-padding: 0;
    box-shadow: none;
    display: inherit;
    max-inline-size: 16ch;
    min-inline-size: 2em;
    outline: 0;
  }
  .reaction--deleting {
    animation: scale-fade-out 0.2s both;
  }
  .reaction__menu-btn,
  .reaction__submit-btn,
  .reaction__cancel-btn {
    --btn-size: 1.25rem;
    --icon-size: var(--btn-size);
  }
  .reaction__submit-btn {
    color: oklch(var(--lch-green-dark));
  }
  .reaction__cancel-btn {
    color: oklch(var(--lch-red-dark));
  }
  /* Menu
  /* ------------------------------------------------------------------------ */
  .reaction__menu {
    position: relative;
  }
  .reaction__popup {
    --panel-border-radius: 1em;
    --panel-padding: var(--block-space-half) var(--inline-space);
    --offset: calc(-1 * var(--panel-padding));
    inset: var(--offset) auto auto var(--offset);
    min-inline-size: auto;
    transform: none;
  }
  .reaction__emoji-list {
    display: grid;
    gap: var(--inline-space-half);
    grid-template-columns: repeat(10, 1fr);
    @media (max-width: 639px) {
      grid-template-columns: repeat(6, 1fr);
    }
    .btn {
      --btn-size: calc(1.3rem * 1.3);
      font-size: 1.3rem;
      position: relative;
      /* Make sure the focus ring sits on top of adjacent buttons */
      &:hover,
      &:focus-visible {
        filter: none;
        z-index: 1;
      }
      &:hover {
        scale: 1.3;
      }
    }
  }
}

================
File: app/assets/stylesheets/reset.css
================
@layer reset {
  /*
  * Modern CSS Reset
  * @link https://github.com/hankchizljaw/modern-css-reset
  */
  /* Box sizing rules */
  *,
  *::before,
  *::after {
    box-sizing: border-box;
  }
  /* Remove default margin */
  body,
  h1,
  h2,
  h3,
  h4,
  h5,
  h6 {
    margin: 0;
  }
  p,
  li,
  h1,
  h2,
  h3,
  h4 {
    /* Help prevent overflow of long words/names/URLs */
    word-break: break-word;
    /* Optional, not supported for all languages */
    /* hyphens: auto; */
  }
  html,
  body {
    overflow-x: clip;
  }
  html {
    /* scroll-behavior: smooth; */
  }
  /* Set core body defaults */
  body {
    min-height: 100dvh;
    font-family: sans-serif;
    font-size: 100%;
    line-height: 1.5;
    text-rendering: optimizeSpeed;
  }
  /* Make images easier to work with */
  img {
    display: block;
    max-inline-size: 100%;
  }
  /* Inherit fonts for inputs and buttons */
  input,
  button,
  textarea,
  select {
    font: inherit;
  }
  button {
    cursor: pointer;
  }
  summary {
    &::-webkit-details-marker {
      display: none;
    }
    &::marker {
      content: "";
    }
  }
  /* Remove all animations and transitions for people that prefer not to see them */
  @media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
      scroll-behavior: auto !important;
    }
    html {
      scroll-behavior: initial;
    }
  }
  dialog {
    border: 0;
    padding: 0;
    &:where(:focus-visible):focus,
    &:where(:focus-visible):active {
      outline: 0;
    }
  }
}

================
File: app/assets/stylesheets/rich-text-content.css
================
@layer components {
  :where(.rich-text-content) {
    --block-margin: 0.5lh;
    h1, h2, h3, h4, h5, h6 {
      display: block;
      font-weight: 800;
      letter-spacing: -0.02ch;
      line-height: 1.1;
      margin-block: 0 var(--block-margin);
      overflow-wrap: break-word;
      text-wrap: balance;
    }
    h1 { font-size: 2em; }
    h2 { font-size: 1.5em; }
    h3 { font-size: 1.17em; }
    h4 { font-size: 1em; }
    h5 { font-size: 0.83em; }
    h6 { font-size: 0.67em; }
    p, ul, ol, dl, blockquote, figure, .attachment {
      margin-block: 0 var(--block-margin);
      &:not(lexxy-editor &) {
        overflow-wrap: break-word;
        text-wrap: pretty;
      }
    }
    p:has(+ p) {
      margin: 0;
    }
    ol, ul {
      padding-inline-start: 3ch;
    }
    ol {
      list-style: decimal;
    }
    ul {
      list-style: disc;
    }
    li:has(li) {
      list-style: none;
      ol, ul {
        margin: 0;
        padding-inline-start: 2ch;
      }
    }
    b, strong, .lexxy-content__bold {
      font-weight: 700;
    }
    i, em, .lexxy-content__italic {
      font-style: italic;
    }
    s, .lexxy-content__strikethrough {
      text-decoration: line-through;
    }
    mark, .lexxy-content__highlight {
      background-color: transparent;
      color: inherit;
    }
    p, blockquote {
      letter-spacing: -0.005ch;
    }
    /* Avoid extra space due to empty paragraphs */
    p:empty {
      display: none;
    }
    blockquote {
      border-inline-start: 0.25em solid var(--color-ink-lighter);
      font-style: italic;
      margin: var(--block-margin) 0;
      padding-inline-start: 2ch;
    }
    img, video, embed, object {
      inline-size: auto;
      margin-inline: auto;
      max-block-size: 32rem;
      object-fit: contain;
    }
    /* Links should hug media contained within */
    a:has(img),
    a:has(video) {
      inline-size: fit-content;
      margin-inline: auto;
    }
    hr {
      color: currentColor;
      block-size: 0;
      border: none;
      border-block-end: 2px solid currentColor;
      inline-size: 20%;
      margin: calc(var(--block-margin) * 2) 0;
    }
    .horizontal-divider  {
      margin: var(--block-margin) 0;
      padding-block: var(--block-margin);
    }
    /* Code */
    code, pre {
      background-color: var(--color-canvas);
      border: 1px solid var(--color-ink-lighter);
      border-radius: 0.3em;
      color: var(--color-ink);
      font-family: var(--font-mono);
      font-size: 0.85em;
      font-weight: 500;
      margin-block: var(--block-margin);
      padding: 0.1em 0.3em;
      &:is(pre),
      &[data-language] {
        border-radius: 0.5em;
        display: block;
        overflow-x: auto;
        padding: 0.5lh 2ch;
        tab-size: 2;
        text-wrap: nowrap;
        white-space: pre;
        word-break: break-word;
        /* Keywords and attributes */
        .code-token__attr,
        .token.atrule,
        .token.attr,
        .token.keyword {
          color: var(--color-code-token__att);
        }
        /* Constants, booleans, numbers, properties, tags */
        .code-token__property,
        .token.boolean,
        .token.constant,
        .token.deleted,
        .token.number,
        .token.property,
        .token.symbol,
        .token.tag {
          color: var(--color-code-token__property);
        }
        /* Strings, selectors, and built-in constructs */
        .code-token__selector,
        .token.builtin,
        .token.char,
        .token.inserted,
        .token.selector,
        .token.string {
          color: var(--color-code-token__selector);
        }
        /* Comments and meta information */
        .code-token__comment,
        .token.cdata,
        .token.comment,
        .token.doctype,
        .token.prolog {
          color: var(--color-code-token__comment);
          font-style: italic;
        }
        /* Operators and symbolic entities */
        .code-token__operator,
        .token.entity,
        .token.operator,
        .token.url {
          color: var(--color-code-token__operator);
        }
        /* Functions and class names */
        .code-token__function,
        .token.class,
        .token.class-name,
        .token.function {
          color: var(--color-code-token__function);
        }
        /* Variables, regex, namespaces, important */
        .code-token__variable,
        .token.important,
        .token.namespace,
        .token.regex,
        .token.variable {
          color: var(--color-code-token__variable);
        }
        /* Punctuation */
        .code-token__punctuation,
        .token.punctuation {
          color: var(--color-code-token__punctuation);
        }
      }
    }
    /* Tables */
    .lexxy-content__table-wrapper {
      margin: 0;
      margin-block: 1ch;
      overflow-x: auto;
    }
    table {
      border-collapse: collapse;
      border-spacing: 0;
      inline-size: calc(100% - 0.5ch);
      margin: 0.25ch;
      th,
      td {
        border: 1px solid var(--color-ink-light);
        padding: 0.5ch 1ch;
        text-align: start;
        word-break: normal;
        *:last-child {
          margin-block-end: 0;
        }
        *:not(pre, code) {
          word-break: normal;
        }
      }
      th,
      .lexxy-content__table-cell--header {
        background: var(--color-ink-lightest);
      }
      td {
        background: var(--color-canvas);
      }
    }
  }
  /* Attachments
  /* ------------------------------------------------------------------------ */
  .attachment {
    block-size: auto;
    display: block;
    inline-size: fit-content;
    position: relative;
    max-inline-size: 100%;
    progress {
      inline-size: 100%;
      margin: auto;
    }
  }
  .attachment__caption {
    color: color-mix(in oklch, var(--color-ink) 66%, transparent);
    font-size: var(--text-small);
    textarea {
      --input-border-radius: 0.3em;
      --input-border-size: 0;
      --input-padding: 0;
      background-color: var(--input-background, transparent);
      border: none;
      color: inherit;
      inline-size: 100%;
      max-inline-size: 100%;
      resize: none;
      text-align: center;
      &:focus {
        --focus-ring-size: 0;
      }
      @supports (field-sizing: content) {
        field-sizing: content;
        inline-size: auto;
        min-inline-size: 20ch;
      }
    }
  }
  .attachment__icon {
    aspect-ratio: 4/5;
    background-color: color-mix(var(--attachment-icon-color), transparent 90%);
    block-size: 2.5lh;
    border: 2px solid var(--attachment-icon-color);
    border-block-start-width: 1ch;
    border-radius: 0.5ch;
    box-sizing: border-box;
    color: var(--attachment-icon-color);
    display: grid;
    font-size: var(--text-small);
    font-weight: bold;
    inline-size: auto;
    padding-inline: 0.5ch;
    place-content: center;
    text-transform: uppercase;
    white-space: nowrap;
  }
  .attachment--preview {
    margin-inline: auto;
    text-align: center;
    img, video {
      block-size: auto;
      display: block;
      margin-inline: auto;
      max-inline-size: 100%;
      user-select: none;
    }
    > a {
      display: block;
    }
    .attachment__caption {
      column-gap: 0.5ch;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      margin-block-start: 0.5ch;
    }
  }
  .attachment--file {
    --attachment-icon-color: var(--color-ink-medium);
    align-items: center;
    display: flex;
    flex-wrap: wrap;
    gap: 1ch;
    inline-size: 100%;
    margin-inline: 0;
    .attachment__caption {
      display: grid;
      flex: 1;
      text-align: start;
    }
    .attachment__name {
      color: var(--color-ink);
      font-weight: bold;
    }
    /* Video attachments don't have an identifiable class, but we need to
     * make sure the caption is always below the video */
    &:has(video) {
      .attachment__caption {
        flex: none;
        inline-size: 100%;
      }
    }
  }
  .attachment--psd,
  .attachment--key,
  .attachment--sketch,
  .attachment--ai,
  .attachment--eps,
  .attachment--indd,
  .attachment--svg,
  .attachment--ppt,
  .attachment--pptx {
    --attachment-icon-color: oklch(var(--lch-red-medium));
  }
  .attachment--css,
  .attachment--crash,
  .attachment--php,
  .attachment--json,
  .attachment--htm,
  .attachment--html,
  .attachment--rb,
  .attachment--erb,
  .attachment--ts,
  .attachment--js {
    --attachment-icon-color: oklch(var(--lch-purple-medium));
  }
  .attachment--txt,
  .attachment--pages,
  .attachment--rtf,
  .attachment--md,
  .attachment--doc,
  .attachment--docx {
    --attachment-icon-color: oklch(var(--lch-blue-medium));
  }
  .attachment--csv &,
  .attachment--numbers &,
  .attachment--xls &,
  .attachment--xlsx & {
    --attachment-icon-color: oklch(var(--lch-green-medium));
  }
  .attachment__link {
    color: var(--color-link);
    text-decoration: underline;
  }
  /* Custom attachments such as mentions, etc. */
  action-text-attachment[content-type^='application/vnd.actiontext'] {
    --attachment-bg-color: transparent;
    --attachment-image-size: 1em;
    --attachment-text-color: currentColor;
    align-items: center;
    background: var(--attachment-bg-color);
    border-radius: 99rem;
    box-shadow:
      -0.25ch 0 0 var(--attachment-bg-color),
       0.5ch 0 0 var(--attachment-bg-color);
    color: var(--attachment-text-color);
    display: inline-flex;
    gap: 0.25ch;
    margin: 0;
    padding: 0;
    position: relative;
    vertical-align: bottom;
    white-space: normal;
    lexxy-editor & {
      cursor: pointer;
    }
    img {
      block-size: var(--attachment-image-size);
      border-radius: 50%;
      inline-size: var(--attachment-image-size);
    }
    &.node--selected {
      --attachment-bg-color: oklch(var(--lch-blue-dark));
      --attachment-text-color: var(--color-ink-inverted);
    }
  }
  action-text-attachment[content-type^='application/vnd.actiontext.mention'] {
    img {
      object-fit: cover;
    }
  }
  [data-lexical-cursor] {
    animation: blink 1s step-end infinite;
    block-size: 1lh;
    border-inline-start: 1px solid currentColor;
    line-height: inherit;
    margin-block: 1em;
  }
}

================
File: app/assets/stylesheets/search.css
================
summary {
  &::-webkit-details-marker {
    display: none !important;
  }
  &::marker {
    display: none !important;
  }
  &::marker {
    content: "";
  }
}
@layer components {
  .search {
    --gap: 4vmin;
    --width: 80ch;
    display: flex;
    flex-direction: column;
    gap: var(--gap);
    margin-inline: auto;
    max-block-size: 100%;
    overflow-y: auto;
    overscroll-behavior: contain;
    padding: var(--block-space);
  }
  /* Form
  /* ------------------------------------------------------------------------ */
  .search__input {
    --clear-icon-size: 1em;
    max-inline-size: 50ch;
    position: relative;
    &::-webkit-search-cancel-button {
      display: none;
    }
    .bar__input & {
      --focus-ring-size: 0;
      --input-border-color: var(--color-ink-light);
      --input-border-radius: 0;
      --input-padding: 0.1em;
      border-width: 0 0 1px;
    }
  }
  .search__reset {
    --btn-background: var(--color-terminal-bg);
    --btn-size: 1.5lh;
  }
  /* Content
  /* ------------------------------------------------------------------------ */
  .search__list {
    display: grid;
    gap: var(--block-space);
    list-style: none;
    margin: 0 auto;
    max-inline-size: min(80ch, 100%);
    padding: 0;
    text-align: start;
  }
  .search__blank-slate {
    margin-block: 3em;
    margin-inline: auto;
    inline-size: fit-content;
  }
  .search__excerpt {
    color: var(--color-ink);
    font-size: var(--text-small);
  }
  .search__excerpt--comment {
    --avatar-size: var(--comment-avatar-size);
    --comment-avatar-size: 32px;
    --padding: 1ch;
    align-items: center;
    background-color: var(--color-ink-lightest);
    border-radius: 1ch;
    display: flex;
    gap: 1ch;
    margin-inline-start: calc(var(--comment-avatar-size) / 2);
    padding-block: 0.5ch;
    .avatar {
      margin-inline-start: calc(-0.5 * var(--comment-avatar-size));
    }
  }
  .search__result {
    color: var(--color-link);
    &:not(&:hover) {
      box-shadow: 0 0 0 1px var(--color-ink-lighter);
    }
  }
  .search__title {
    text-decoration: underline;
  }
  /* Perma
  /* ------------------------------------------------------------------------ */
  .search-perma {
    .search__form > label,
    .search__reset {
      display: none;
    }
    .search__input {
      max-inline-size: min(80ch, 100%);
    }
    .search {
      padding-inline: 0;
    }
  }
}

================
File: app/assets/stylesheets/separators.css
================
@layer components {
  .separator {
    block-size: 100%;
    border-block: 0;
    border-inline-end: 0;
    border-inline-start: var(--border-size, 1px) var(--border-style, solid) var(--border-color, currentColor);
    display: inline-flex;
    inline-size: 0;
  }
  .separator--horizontal {
    block-size: 0;
    border-block-end: 0;
    border-block-start: var(--border-size, 1px) var(--border-style, solid) var(--border-color, currentColor);
    border-inline: 0;
    display: flex;
  }
}

================
File: app/assets/stylesheets/settings.css
================
@layer components {
  .settings {
    --settings-spacer: var(--block-space);
    --settings-item-padding-inline: 0.5ch;
    display: grid;
    gap: calc(var(--settings-spacer) * 2);
    margin: 0 auto;
    max-inline-size: min(100ch, 100%);
    @media (min-width: 960px) {
      grid-template-columns: repeat(2, 1fr);
    }
  }
  /* Sections & Panels
  /* -------------------------------------------------------------------------- */
  .settings__panel {
    --panel-size: 100%;
    --panel-padding: calc(var(--settings-spacer) / 1);
    display: flex;
    flex-direction: column;
    gap: var(--panel-padding);
    min-block-size: 100%;
    min-inline-size: 0;
    @media (min-width: 640px) {
      --panel-padding: calc(var(--settings-spacer) * 2);
    }
  }
  .settings__panel--users {
    @media (min-width: 640px) {
      max-height: 80dvh;
    }
    @media (min-width: 960px) {
      max-height: calc(100dvh - 12rem);
    }
  }
  .settings__section {
    h2 {
      font-size: var(--text-large);
    }
    > * + * {
      margin-block-start: calc(var(--panel-padding) / 2);
    }
    &:is(:first-child):has(h2) {
      margin-top: -0.33lh; /* Align h2 letters caps with panel padding */
    }
  }
  /* Users
  /* ------------------------------------------------------------------------ */
  .settings__user-filter {
    --btn-size: 3.5ch;
    --avatar-size: var(--btn-size);
    display: flex;
    flex-direction: column;
    gap: calc(var(--settings-spacer) / 2);
    min-height: 0;
  }
  .settings__user-filter--bg {
    background-color: var(--color-ink-lightest);
    border-radius: 0.5em;
    margin-block: 0;
    padding: var(--settings-spacer);
  }
  .settings__user-list {
    flex: 1 1 auto;
    list-style: none;
    margin: calc(var(--settings-spacer) / -4) calc(-1 * var(--settings-item-padding-inline));
    padding: 0;
    overflow: auto;
    li {
      border-radius: 0.5em;
      /* Add padding if it's not already on a link within */
      &:not(:has(a:first-child)) { padding-inline-end: var(--settings-item-padding-inline); }
      &:not(:has(a:last-child)) { padding-inline-end: var(--settings-item-padding-inline); }
    }
    a {
      padding: calc(var(--settings-spacer) / 4) var(--settings-item-padding-inline);
      @media(any-hover: hover) {
        &:hover {
          text-decoration: underline;
        }
      }
    }
    /* Only add a BG color when you can actually navigate */
    .settings__user-filter:focus-within & {
      [aria-selected] {
        background: var(--color-selected);
      }
    }
  }
  .settings__user-list-tips {
    border-top: 1px solid var(--color-ink-light);
    color: var(--color-ink-dark);
    font-size: var(--text-small);
    padding-block-start: var(--settings-spacer);
    .settings__user-filter--bg & {
      margin-inline: calc(-1 * var(--settings-spacer));
      padding-inline: var(--settings-spacer);
    }
  }
}

================
File: app/assets/stylesheets/spinners.css
================
@layer components {
  .spinner {
    position: relative;
    &::before {
      --mask: no-repeat radial-gradient(#000 68%, #0000 71%);
      --dot-size: 1.25em;
      -webkit-mask: var(--mask), var(--mask), var(--mask);
      -webkit-mask-size: 28% 45%;
      animation: submitting 1.3s infinite linear;
      aspect-ratio: 8/5;
      background: currentColor;
      content: "";
      inline-size: var(--dot-size);
      inset: 50% 0.25em;
      margin-block: calc((var(--dot-size) / 3) * -1);
      margin-inline: calc((var(--dot-size) / 2) * -1);
      position: absolute;
    }
  }
}

================
File: app/assets/stylesheets/steps.css
================
@layer components {
  .step {
    display: grid;
    grid-template-columns: 1em auto auto;
    gap: calc(var(--inline-space) * 2/3);
    inline-size: auto;
  }
  .step__checkbox {
    --hover-color: var(--card-color);
    appearance: none;
    background-color: var(--color-canvas);
    block-size: 1.1em;
    border: 1px solid currentColor;
    border-radius: 0.15em;
    color: currentColor;
    display: grid;
    font: inherit;
    inline-size: 1.1em;
    margin: 0;
    place-content: center;
    transform: translateY(0.1em);
    &::before {
      background-color: CanvasText;
      block-size: 0.65em;
      box-shadow: inset 1em 1em currentColor;
      clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
      content: "";
      inline-size: 0.65em;
      transform: scale(0);
      transform-origin: center;
      transition: 150ms transform ease-in-out;
    }
    &:checked::before {
      transform: scale(1) rotate(10deg);
    }
    &:where([disabled]):not(:hover):not(:active) {
      filter: none;
      opacity: 0.5;
    }
  }
  .step__content {
    --input-border-radius: 0;
    --input-border-size: 0;
    --input-padding: 0;
    border-bottom: 1px solid transparent;
    color: currentColor;
    font-weight: 500;
    margin-block-end: calc(var(--block-space) * 1/3);
    &:is(a, input[type=text]) {
      --hover-size: 0;
    }
    .step:has(:checked) & {
      opacity: 0.7;
      text-decoration: line-through;
    }
    &::placeholder {
      color: var(--card-color);
    }
    &:is(input) {
      max-inline-size: 70ch;
      min-inline-size: 30ch;
      @supports (field-sizing: content) {
        field-sizing: content;
        max-inline-size: 100%;
        min-inline-size: 15ch;
      }
    }
  }
  .step__content--edit {
    border-bottom-color: currentColor;
  }
  .steps {
    contain: inline-size;
    display: grid;
    list-style: none;
    margin: 0;
    max-inline-size: 100%;
    padding: 0;
  }
  .steps__icon {
    --icon-size: 0.875em;
    background-color: var(--card-color);
    block-size: 1.3em;
    border-radius: 50%;
    color: var(--color-ink-inverted);
    display: grid;
    inline-size: 1.3em;
    place-content: center;
  }
}

================
File: app/assets/stylesheets/syntax.css
================
@layer components {
  .highlight {
    /* Named color values */
    --keyword: lch(50.16 68.78 25.97);
    --entity: lch(39.03 73.26 304.21);
    --constant: lch(39.68 63.13 279.47);
    --string: lch(19.22 34.92 275.47);
    --variable: lch(57.9 81.69 53.33);
    --comment: lch(47.93 7 254.8);
    --entity-tag: lch(39.64 68.17 142.85);
    --markup-heading: lch(39.68 63.13 279.47);
    --markup-list: lch(40.44 43.36 84.69);
    --markup-inserted: lch(39.64 68.17 142.85);
    --markup-deleted: lch(39.64 68.17 31.45);
    /* Redefine named color values for dark mode */
    html[data-theme="dark"] {
      --keyword: lch(67.63 58.99 30.64);
      --entity: lch(75.13 46.73 306.74);
      --constant: lch(74.9 39.71 255.53);
      --string: lch(74.9 39.71 255.53);
      --variable: lch(76.17 61.1 61.97);
      --comment: lch(60.83 6.66 254.46);
      --entity-tag: lch(83.65 59.31 141.61);
      --markup-heading: lch(47.93 71.67 280.72);
      --markup-list: lch(83.84 57.9 85.03);
      --markup-inserted: lch(83.65 59.31 141.61);
      --markup-deleted: lch(73.8% 65 29.18);
    }
    @media (prefers-color-scheme: dark) {
      html:not([data-theme]) {
        --keyword: lch(67.63 58.99 30.64);
        --entity: lch(75.13 46.73 306.74);
        --constant: lch(74.9 39.71 255.53);
        --string: lch(74.9 39.71 255.53);
        --variable: lch(76.17 61.1 61.97);
        --comment: lch(60.83 6.66 254.46);
        --entity-tag: lch(83.65 59.31 141.61);
        --markup-heading: lch(47.93 71.67 280.72);
        --markup-list: lch(83.84 57.9 85.03);
        --markup-inserted: lch(83.65 59.31 141.61);
        --markup-deleted: lch(73.8% 65 29.18);
      }
    }
    color: var(--color-ink);
    .w {
      color: var(--color-ink);
    }
    .k, .kd, .kn, .kp, .kr, .kt, .kv {
      color: var(--keyword);
    }
    .gr {
      color: var(--color-ink-lightest);
    }
    .gd {
      color: var(--markup-deleted);
      background-color: light-dark(lch(39.64 68.17 31.45 / 0.15), lch(39.64 68.17 31.45 / 0.2));
    }
    .nb, .nc, .no, .nn {
      color: var(--variable);
    }
    .sr, .na, .nt {
      color: var(--entity-tag);
    }
    .gi {
      color: var(--markup-inserted);
      background-color: light-dark(lch(49.14 52.75 142.85 / 0.15), lch(83.65 59.31 141.61 / 0.15));
    }
    .kc, .l, .ld, .m, .mb, .mf, .mh, .mi, .il, .mo, .mx, .sb, .bp, .ne, .nl, .py, .nv, .vc, .vg, .vi, .vm, .o, .ow {
      color: var(--constant);
    }
    .gh {
      color: var(--constant);
      font-weight: bold;
    }
    .gu {
      color: var(--constant);
      font-weight: bold;
    }
    .s, .sa, .sc, .dl, .sd, .s2, .se, .sh, .sx, .s1, .ss {
      color: var(--string);
    }
    .nd, .nf, .fm {
      color: var(--entity);
    }
    .err {
      color: var(--color-ink-inverted);
      background-color: var(--markup-deleted);
    }
    .c, .ch, .cd, .cm, .cp, .cpf, .c1, .cs, .gl, .gt {
      color: var(--comment);
    }
    .ni, .si {
      color: var(--storage-modifier-import);
    }
    .ge {
      color: var(--storage-modifier-import);
      font-style: italic;
    }
    .gs {
      color: var(--storage-modifier-import);
      font-weight: bold;
    }
  }
}

================
File: app/assets/stylesheets/theme-switcher.css
================
@layer components {
  .theme-switcher {
    @media (max-width: 479px) {
      --row-gap: 1ch;
      flex-direction: column;
    }
  }
  .theme-switcher__btn {
    --btn-background: var(--color-ink-lightest);
    --btn-border-radius: 0.4em;
    --btn-border-size: 0;
    --btn-gap: 0.1lh;
    --btn-padding: 1em;
    --icon-size: 2em;
    column-gap: var(--inline-space);
    flex: 1;
    flex-direction: column;
    position: relative;
    white-space: nowrap;
    &:has(input:checked) {
      --btn-background: var(--color-selected);
      --btn-color: var(--color-ink);
    }
    @media (max-width: 479px) {
      flex-direction: row;
    }
  }
}

================
File: app/assets/stylesheets/toggles.css
================
@layer components {
  .toggler--toggled {
    .toggler__visible-when-off {
      display: none;
    }
    .toggler__visible-when-on {
      display: unset;
    }
  }
  .toggler__visible-when-on {
    display: none;
  }
}

================
File: app/assets/stylesheets/tooltips.css
================
@layer components {
  [data-controller~="tooltip"] {
    --tooltip-delay: 750ms;
    --tooltip-duration: 150ms;
    .for-screen-reader {
      background: var(--color-ink);
      border-radius: 0.5ch;
      color: var(--color-canvas);
      font-size: var(--text-x-small);
      font-weight: normal;
      inset: -1ch auto auto 50%;
      max-inline-size: min(50ch, calc(100vw - (var(--inline-space) * 2)));
      opacity: 0;
      padding: 0.25ch 1ch;
      transition: var(--tooltip-duration) ease-out allow-discrete;
      transition-property: opacity;
      translate: -50% -100%;
      text-overflow: ellipsis;
      &.orient-right {
        inset-inline: 0 auto;
        translate: var(--orient-offset, 0px) -100%;
      }
      &.orient-left {
        inset-inline: auto 0;
        translate: var(--orient-offset, 0px) -100%;
      }
    }
    @media(any-hover: hover) {
      &:hover .for-screen-reader {
        block-size: auto !important;
        clip-path: none !important;
        inline-size: auto !important;
        opacity: 1;
        transform: translate3d(0, 0, 0); /* Fixes Safari overflow rendering bug */
        transition-delay: var(--tooltip-delay);
        translate: -50% -100%;
        z-index: var(--z-tooltip);
        &.orient-left,
        &.orient-right {
          translate: 0 -100%;
        }
      }
    }
  }
}

================
File: app/assets/stylesheets/trays.css
================
@layer components {
  /* Container
  /* ------------------------------------------------------------------------ */
  .tray {
    --tray-duration: 350ms;
    --tray-margin: 0.5rem;
    --tray-radius: 0.25rem;
    --tray-item-height: 76px; /* FIXME: Magic number */
    align-items: end;
    block-size: var(--footer-height);
    display: grid;
    inset-block: auto env(safe-area-inset-bottom);
    inline-size: var(--tray-size);
    position: fixed;
    transition: inset var(--tray-duration) var(--ease-out-overshoot-subtle);
    z-index: var(--z-tray);
    /* Make the dialog, expander, and actions inhabit the same space */
    > * {
      grid-column-start: 1;
      grid-row-start: 1;
    }
    @media (max-width: 799px) {
      &:has(.tray__dialog[open]) {
        background-color: var(--color-terminal-bg);
        inline-size: calc(100% - var(--tray-margin) * 2);
        inset-inline-start: var(--tray-margin);
        z-index: calc(var(--z-tray) + 2);
      }
    }
  }
  /* Dialog
  /* ------------------------------------------------------------------------ */
  .tray__dialog {
    background-color: transparent;
    display: flex;
    flex-direction: column-reverse;
    inline-size: auto;
    inset: auto 0 0 0;
    position: absolute;
    transition: var(--tray-duration) var(--ease-out-overshoot-subtle);
    transition-property: background-color, box-shadow, inset-block-end;
    &[open] {
      border-radius: var(--tray-radius);
      box-shadow:
        0 0 0 1px var(--color-ink-lighter),
        0 0 16px oklch(var(--lch-black) / 33%);
      inset-block-end: calc(var(--footer-height) - 0.75ch);
    }
    &:not([open]) {
      block-size: var(--footer-height);
      pointer-events: none;
      /* On desktop, when there aren't items, tweak the hat so it doesn't look
         like it's coming from the bottom of the viewport */
      @media (min-width: 800px) {
        &:not(:has(.tray__item--notification)) {
          .tray__item--hat {
            margin-block-end: 0;
            opacity: 0;
          }
        }
      }
    }
  }
  /* Expander
  /* ------------------------------------------------------------------------ */
  .tray__toggle {
    align-self: stretch;
    background: none;
    border: 0;
    display: block;
    padding: 0;
    transition: opacity 100ms ease-out;
    .icon {
      color: var(--color-ink);
      display: none;
    }
    .tray__toggle-text {
      display: contents;
    }
    @media (max-width: 799px) {
      /* When collapsed on mobile, make it small */
      .tray__dialog:not([open]) ~ & {
        inline-size: var(--footer-height);
        .tray__toggle-btn {
          border: 0;
        }
        .icon {
          display: block;
        }
        .tray__toggle-text {
          display: none;
        }
      }
      /* Show a red dot if there are items to show */
      .tray__dialog:not([open]):has(.tray__item--notification) ~ &:after {
        background: oklch(var(--lch-red-medium));
        block-size: 1ch;
        border-radius: 50%;
        content: "";
        inline-size: 1ch;
        inset: 25% 25% auto auto;
        position: absolute;
      }
    }
    /* On desktop */
    @media (min-width: 800px) {
      .tray__dialog:not([open]):has(.tray__item:not(.tray__item--hat)) ~ & {
        block-size: var(--tray-item-height);
        translate: 0 -1.85rem;
      }
      /* Hide the UI when collapsed, but only if there are items */
      .tray__dialog:not([open]):has(.tray__item--notification) ~ & {
        opacity: 0;
      }
    }
  }
  .tray__toggle-btn {
    --btn-background: transparent;
    --btn-border-size: 0;
    --btn-color: var(--color-ink);
    inline-size: 100%;
    opacity: 0.66;
  }
  /* Item
  /* ------------------------------------------------------------------------ */
  .tray__item {
    --tray-item-delay: calc((var(--tray-item-index) - 1) * 20ms);
    --tray-item-index: 1;
    --tray-item-margin: calc(-1 * var(--tray-item-height) + var(--tray-item-offset));
    --tray-item-offset: var(--block-space-half); /* The amount they overlap */
    --tray-item-scale: calc(1 - (var(--tray-item-index) - 1) / 30);
    --tray-item-z: calc(6 - var(--tray-item-index));
    font-size: 10px;
    margin-block-end: var(--tray-item-margin);
    position: relative;
    .tray__dialog & {
      transition: var(--tray-duration) var(--ease-out-overshoot-subtle);
      transition-delay: var(--tray-item-delay);
      transition-property: margin, opacity, scale;
      &:not(.tray__item--hat) {
        z-index: var(--tray-item-z);
      }
      &:has(*:focus-visible) {
        z-index: calc(var(--tray-item-z) + 1);
      }
      &:first-child {
        --tray-item-margin: var(--tray-margin);
      }
      &:not(:first-child) {
        scale: var(--tray-item-scale);
      }
      &:nth-child(1) { --tray-item-index: 1; }
      &:nth-child(2) { --tray-item-index: 2; }
      &:nth-child(3) { --tray-item-index: 3; }
      &:nth-child(4) { --tray-item-index: 4; }
      &:nth-child(5) { --tray-item-index: 5; }
      &:nth-child(6) { --tray-item-index: 6; }
      &:nth-child(7) { --tray-item-index: 7; }
      &:nth-child(8) { --tray-item-index: 8; }
      &:nth-child(9) { --tray-item-index: 9; }
      &:nth-child(10) { --tray-item-index: 10; }
    }
    .tray__dialog[open] & {
      --tray-item-margin: 0;
      --tray-item-scale: 1;
    }
    .tray__dialog:not([open]) & {
      @media (max-width: 799px) {
        opacity: 0;
      }
    }
    .bubble {
      display: none;
    }
  }
  .tray__item--hat {
    --tray-hat-bg: var(--color-canvas);
    --tray-item-scale: 1;
    background-color: var(--tray-hat-bg);
    border-block-end: 1px solid var(--color-ink-lighter);
    border-radius: var(--tray-radius) var(--tray-radius) 0 0;
    block-size: var(--tray-item-height);
    display: flex;
    opacity: 0;
    padding: 0.5ch;
    .btn {
      --btn-background: var(--tray-hat-bg);
      --btn-border-radius: 0.5ch;
      --btn-padding: 1.25ch 0.5ch 1ch;
      block-size: 100%;
      display: flex;
      flex-direction: column;
      font-weight: normal;
      gap: 0.25ch;
      inline-size: 100%;
      &:focus-visible {
        z-index: 1;
      }
      @media (max-width: 1060px) {
        > span:not(.icon) {
          font-size: 12px;
        }
      }
      .tray__dialog:not([open]) & {
        pointer-events: none;
      }
    }
    > *:is(:first-child, :last-child) {
      inline-size: 128px;
    }
    .tray__dialog[open] & {
      opacity: 1;
    }
    .tray__new-notifications {
      display: none;
      position: relative;
    }
    .tray__dialog:has(.tray__item:nth-child(1n + 7)) & {
      .tray__old-notifications { display: none; }
      .tray__new-notifications { display: flex; }
      .btn:has(.tray__new-notifications) { /* Red dot */
        &:after {
          background-color: oklch(var(--lch-red-medium));
          block-size: 1ch;
          border-radius: 50%;
          box-shadow: 0 0 0 1px var(--tray-hat-bg);
          content: "";
          inline-size: 1ch;
          inset: 25% auto auto 50%;
          position: absolute;
          translate: 25% -75%;
        }
      }
    }
  }
  /* Tray cards
  /* ------------------------------------------------------------------------ */
  .tray__item {
    .card {
      --card-padding-block: 1.5ch;
      --card-padding-inline: 1.5ch;
      --text-xx-large: 2em;
      block-size: var(--tray-item-height);
      view-transition-name: unset !important;
      [open] & {
        box-shadow: 0 0 0 1px var(--color-ink-lighter);
        border: 0;
        border-radius: 0;
      }
      html[data-theme="dark"] & {
        box-shadow: 0 0 0 1px var(--color-ink-lighter);
      }
      @media (prefers-color-scheme: dark) {
        html:not([data-theme]) & {
          box-shadow: 0 0 0 1px var(--color-ink-lighter);
        }
      }
    }
    .card__background {
      display: none;
    }
    .card__body {
      margin-block-start: 0.2em;
      padding-block-end: 0;
    }
    .card__board {
      padding-block: 0.25ch;
    }
    .card__title {
      --lines: 1;
      font-size: var(--text-small);
      font-weight: bold;
      min-block-size: 0;
    }
  }
  /* Pin-specific styles
  /* ------------------------------------------------------------------------ */
  .tray--pins {
    inset-inline: var(--tray-margin) auto;
    view-transition-name: tray-pins;
    #footer:has(.bar__placeholder[hidden]) & {
      inset-inline-start: -100%;
    }
    /* Disable the expander if there aren't items to show */
    .tray__dialog:not(:has(.tray__item)) ~ .tray__toggle {
      opacity: 0.5;
      &, .tray__toggle-btn {
        pointer-events: none;
      }
    }
    /* Add a border on mobile */
    @media (max-width: 799px) {
      .tray__dialog:not([open]) ~ .tray__toggle {
        border-inline-end: 1px dashed var(--color-ink-light);
        translate: calc(-1 * var(--tray-margin)) 0;
      }
    }
  }
  .tray__item--pin {
    --tray-item-z: calc(10 - var(--tray-item-index));
    position: relative;
    [open] &[aria-selected] {
      outline: 0;
      z-index: calc(var(--tray-item-z) + 2);
      .card__link {
        border-radius: 0.25ch;
        outline: var(--focus-ring-size) solid var(--focus-ring-color);
        outline-offset: var(--focus-ring-offset);
        z-index: 1;
      }
    }
    /* Show 6 max items on smallest devices */
    @media (max-height: 578px) {
      &:nth-child(1n + 7) { display: none; }
    }
    /* 7 max */
    @media (min-height: 578px) and (max-height: 656px) {
      &:nth-child(1n + 8) { display: none; }
    }
    /* 8 max */
    @media (min-height: 656px) and (max-height: 734px) {
      &:nth-child(1n + 9) { display: none; }
    }
    /* 9 max */
    @media (min-height: 734px) and (max-height: 812px) {
      &:nth-child(1n + 10) { display: none; }
    }
    /* 10 max on larger screens */
    @media (min-height: 812px) {
      &:nth-child(1n + 11) { display: none; }
    }
    &:not([aria-selected]) .card__link:focus-visible,
    .tray__dialog:not([open]) & .card__link:focus-visible {
      --focus-ring-size: 0;
    }
    .tray__remove-pin-btn {
      --btn-icon-size: 1.25em;
      --btn-size: 2em;
      background-color: var(--card-bg-color);
      inset: 0 0 auto auto;
      opacity: 0.66;
      position: absolute;
      z-index: 1;
      &:hover {
        opacity: 1;
      }
      .tray__dialog:not([open]) & {
        opacity: 0;
        pointer-events: none;
      }
      [aria-busy] & {
        position: absolute !important;
      }
    }
    .avatar,
    .card__tags,
    .card__meta .btn,
    .card__meta-text:not(.card__meta-text--updated),
    .card__stages,
    .card__steps,
    .card__boosts,
    .card__comments,
    .card__closed {
      display: none;
    }
    .card__header {
      margin-block-start: calc(var(--card-padding-block) * -1.1);
      margin-inline: calc(-1 * var(--card-padding-inline));
      max-inline-size: unset;
    }
    .card__body {
      display: block;
      margin-block-start: 0.3em;
    }
    .card__column-name--current {
      --btn-padding: 0.1em 0.5em;
      background: none !important;
      border: 1px solid currentColor;
      color: var(--color-ink);
      display: inline-flex;
      flex: 0 1 auto;
      inline-size: fit-content;
      margin: 0 0 0 auto;
      transition: translate 150ms ease-out;
      translate: -2em;
      .tray__dialog:not([open]) & {
        translate: 0;
      }
    }
    .card__link {
      z-index: 1;
    }
    .card__footer {
      margin-block: -0.2em 2em;
      .icon { display: none; }
    }
    .card__meta {
      grid-template-areas: "text-updated";
      grid-template-columns: 1fr;
    }
    .card__meta-text {
      line-height: 1.5;
    }
    .card__meta-text--updated {
      border: 0;
      font-size: var(--text-x-small);
      opacity: 0.66;
      padding: 0;
      text-transform: none;
      .local-time-value {
        font-weight: inherit;
      }
    }
    .card__bubble {
      display: none;
    }
  }
  ::view-transition-group(tray-pins) {
    z-index: 100;
  }
  /* Notification-specific styles
  /* ------------------------------------------------------------------------ */
  .tray--notifications {
    inset-inline: auto var(--tray-margin);
    view-transition-name: tray-notifications;
    #footer:has(.bar__placeholder[hidden]) & {
      inset-inline-end: -100%;
    }
    .tray__item,
    [data-navigable-list-target~=item] {
      [open] &[aria-selected] {
        outline: 0;
        z-index: calc(var(--tray-item-z) + 2);
        .card,
        .tray__item--hat & .btn {
          border-radius: 0.25ch;
          outline: var(--focus-ring-size) solid var(--focus-ring-color);
          outline-offset: var(--focus-ring-offset);
        }
      }
      &:nth-child(1n + 7) {
        display: none;
        pointer-events: none;
        visibility: hidden;
      }
      &:not([aria-selected]) .card:focus-visible,
      .tray__dialog:not([open]) & .card:focus-visible {
        --focus-ring-size: 0;
      }
      .btn:focus-visible {
        outline: 0;
      }
    }
    &:not(:has(.card--notification)) {
      .tray__notification-read-action {
        visibility: hidden;
      }
    }
    /* On mobile */
    @media (max-width: 799px) {
      /* add a border */
      .tray__dialog:not([open]) ~ .tray__toggle {
        border-inline-start: 1px dashed var(--color-ink-light);
        translate: var(--tray-margin) 0;
      }
    }
  }
  ::view-transition-group(tray-notifications) {
    z-index: 100;
  }
}

================
File: app/assets/stylesheets/user.css
================
@layer components {
  .user-edit-link {
    inset: 0 0 auto auto;
    position: absolute;
  }
}

================
File: app/assets/stylesheets/utilities.css
================
@layer utilities {
  /* Text */
  .txt-xx-small { font-size: var(--text-xx-small); }
  .txt-x-small { font-size: var(--text-x-small); }
  .txt-small { font-size: var(--text-small); }
  .txt-normal { font-size: var(--text-normal); }
  .txt-medium { font-size: var(--text-medium); }
  .txt-large { font-size: var(--text-large); }
  .txt-x-large { font-size: var(--text-x-large); }
  .txt-xx-large { font-size: var(--text-xx-large); }
  .txt-align-center { text-align: center; }
  .txt-align-start { text-align: start; }
  .txt-align-end { text-align: end; }
  .txt-current { color: currentColor; }
  .txt-ink { color: var(--color-ink); }
  .txt-reversed { color: var(--color-ink-inverted); }
  .txt-negative { color: var(--color-negative); }
  .txt-positive { color: var(--color-positive); }
  .txt-subtle { color: var(--color-ink-dark); }
  .txt-alert { color: var(--color-marker); }
  .txt-undecorated { text-decoration: none; }
  .txt-underline { text-decoration: underline; }
  .txt-tight-lines { line-height: 1.2; }
  .txt-nowrap { white-space: nowrap; }
  .txt-balance { text-wrap: balance; }
  .txt-break { word-break: break-word; }
  .txt-uppercase { text-transform: uppercase; }
  .txt-capitalize { text-transform: capitalize; }
  .txt-capitalize-first-letter::first-letter { text-transform: capitalize; }
  .txt-link { color: var(--color-link); text-decoration: underline; }
  .font-weight-normal { font-weight: normal; }
  .font-weight-bold { font-weight: bold; }
  .font-weight-black { font-weight: 900; }
  /* Flexbox and Grid */
  .justify-end { justify-content: end; }
  .justify-start { justify-content: start; }
  .justify-center { justify-content: center; }
  .justify-space-between { justify-content: space-between; }
  .align-center { align-items: center; }
  .align-start { align-items: start; }
  .align-end { align-items: end; }
  .align-self-center { align-self: center; }
  .align-self-end { align-self: end; }
  .align-self-start { align-self: start; }
  .v-align-middle { vertical-align: middle; }
  .contain { contain: inline-size; }
  .display-inline { display: inline; }
  .flex { display: flex; }
  .flex-inline { display: inline-flex; }
  .flex-column { flex-direction: column; }
  .flex-wrap { flex-wrap: wrap; }
  .flex-1 { flex: 1; }
  .flex-item-grow { flex-grow: 1; }
  .flex-item-shrink { flex-shrink: 1; }
  .flex-item-no-shrink { flex-shrink: 0; }
  .flex-item-justify-start { margin-inline-end: auto; }
  .flex-item-justify-end { margin-inline-start: auto; }
  .gap {
    column-gap: var(--column-gap, var(--inline-space));
    row-gap: var(--row-gap, var(--block-space));
  }
  .gap-half {
    column-gap: var(--column-gap, var(--inline-space-half));
    row-gap: var(--row-gap, var(--block-space-half));
  }
  .gap-none {
    --column-gap: 0;
    --row-gap: 0;
    gap: 0;
  }
  /* Sizing */
  .full-width { inline-size: 100%; }
  .min-width { min-inline-size: 0; }
  .half-width { inline-size: 50%; }
  .max-width { max-inline-size: 100%; }
  .min-content { inline-size: min-content; }
  .fit-content { inline-size: fit-content; }
  .max-inline-size { max-inline-size: 100%; }
  /* Overflow */
  .overflow-x { overflow-x: auto; scroll-snap-type: x mandatory; scroll-behavior: smooth; }
  .overflow-y { overflow-y: auto; scroll-snap-type: y mandatory; scroll-behavior: smooth; }
  .overflow-clip { text-overflow: clip; white-space: nowrap; overflow: hidden; }
  .overflow-ellipsis { text-overflow: ellipsis; white-space: nowrap; overflow: hidden; }
  .overflow-line-clamp {
    -webkit-line-clamp: var(--lines, 2);
    -webkit-box-orient: vertical;
    display: -webkit-box;
    overflow: hidden;
    text-overflow: clip;
    white-space: normal;
  }
  /* Mouse pointer */
  .non-clickable {
    cursor: default;
    pointer-events: none;
  }
  .cursor-pointer { cursor: pointer; }
  /* Padding */
  .pad { padding: var(--block-space) var(--inline-space); }
  .pad-double { padding: var(--block-space-double) var(--inline-space-double); }
  .pad-block { padding-block: var(--block-space); }
  .pad-block-start { padding-block-start: var(--block-space); }
  .pad-block-end { padding-block-end: var(--block-space); }
  .pad-block-half { padding-block: var(--block-space-half); }
  .pad-block-start-half { padding-block-start: var(--block-space-half); }
  .pad-inline { padding-inline: var(--inline-space); }
  .pad-inline-start { padding-inline-start: var(--inline-space); }
  .pad-inline-end { padding-inline-end: var(--inline-space); }
  .pad-inline-half { padding-inline: var(--inline-space-half); }
  .pad-inline-double { padding-inline: var(--inline-space-double); }
  .unpad { padding: 0; }
  .unpad-block-end { padding-block-end: 0; }
  .unpad-inline { padding-inline: 0; }
  /* Margins */
  .margin { margin: var(--block-space) var(--inline-space); }
  .margin-block { margin-block: var(--block-space); }
  .margin-block-half { margin-block: var(--block-space-half); }
  .margin-block-start { margin-block-start: var(--block-space); }
  .margin-block-start-half { margin-block-start: var(--block-space-half); }
  .margin-block-start-auto { margin-block-start: auto; }
  .margin-block-end { margin-block-end: var(--block-space); }
  .margin-block-end-half { margin-block-end: var(--block-space-half); }
  .margin-block-double { margin-block: var(--block-space-double); }
  .margin-block-end-double { margin-block-end: var(--block-space-double); }
  .margin-block-start-double { margin-block-start: var(--block-space-double); }
  .margin-inline { margin-inline: var(--inline-space); }
  .margin-inline-start { margin-inline-start: var(--inline-space); }
  .margin-inline-start-half { margin-inline-start: var(--inline-space-half); }
  .margin-inline-end { margin-inline-end: var(--inline-space); }
  .margin-inline-end-half { margin-inline-end: var(--inline-space-half); }
  .margin-inline-half { margin-inline: var(--inline-space-half); }
  .margin-inline-double { margin-inline: var(--inline-space-double); }
  .margin-none { margin: 0; }
  .margin-none-block { margin-block: 0; }
  .margin-none-block-start { margin-block-start: 0; }
  .margin-none-block-end { margin-block-end: 0; }
  .margin-none-inline { margin-inline: 0; }
  .margin-none-inline-start { margin-inline-start: 0; }
  .margin-none-inline-end { margin-inline-end: 0; }
  .center { margin-inline: auto; }
  .center-block { margin-block: auto; }
  /* Position */
  .position-relative { position: relative; }
  .position-sticky { position: sticky; inset: var(--inset, 0 auto auto auto); z-index: var(--z, 1); }
  /* Fills */
  .fill { background-color: var(--color-canvas); }
  .fill-black { background-color: var(--color-ink); }
  .fill-white { background-color: var(--color-ink-inverted); }
  .fill-shade { background-color: var(--color-ink-lightest); }
  .fill-selected { background-color: var(--color-selected); }
  .fill-highlight { background-color: var(--color-highlight); }
  .fill-transparent { background-color: transparent; }
  .fill-highlighter {
    display: inline-block;
    position: relative;
    z-index: 1;
    &::before {
      background-color: var(--color-highlight);
      border-radius: 0.2em;
      content: "";
      inset-block: 0;
      inset-inline: -0.1em;
      position: absolute;
      transform: skewX(-10deg) rotate(1deg);
      z-index: -1;
    }
  }
  .translucent { opacity: var(--opacity, 0.66); }
  /* Borders */
  .border { border: var(--border-size, 1px) var(--border-style, solid) var(--border-color, var(--color-ink-lighter)); }
  .border-block { border-block: var(--border-size, 1px) var(--border-style, solid) var(--border-color, var(--color-ink-lighter)); }
  .border-bottom { border-block-end: var(--border-size, 1px) var(--border-style, solid) var(--border-color, var(--color-ink-lighter)); }
  .border-top { border-block-start: var(--border-size, 1px) var(--border-style, solid) var(--border-color, var(--color-ink-lighter)); }
  .borderless { border: 0; }
  /* Border radius */
  .border-radius { border-radius: var(--border-radius, 0.5em); }
  /* Shadows */
  .shadow { box-shadow: var(--shadow); }
  /* Lists */
  :where(.list-style-none) {
    list-style: none;
    margin: 0 auto;
    padding: 0;
  }
  /* Accessibility */
  .visually-hidden,
  .for-screen-reader {
    block-size: 1px;
    clip-path: inset(50%);
    inline-size: 1px;
    overflow: hidden;
    position: absolute;
    white-space: nowrap;
  }
  /* Visibility */
  [hidden] { display: none !important; }
  .display-contents,
  [contents] { display: contents; }
  .hide-in-pwa {
    @media (display-mode: standalone) {
      display: none;
    }
  }
  .hide-in-browser {
    @media (display-mode: browser) {
      display: none;
    }
  }
  .hide-focus-ring {
    --focus-ring-size: 0;
  }
  .hide-on-touch {
    @media (any-hover: none) {
      display: none;
    }
  }
  .show-on-touch {
    display: none;
    @media (any-hover: none) {
      display: unset;
    }
  }
  .show-on-native {
    body:not([data-platform~=native]) & {
      display: none;
    }
  }
  .hide-scrollbar {
    -ms-overflow-style: none;  /* Edge */
    scrollbar-width: none; /* FF */
    /* Chrome/Safari/Opera */
    &::-webkit-scrollbar {
      display: none;
    }
  }
}

================
File: app/assets/stylesheets/welcome-letter.css
================
@layer components {
  .welcome-letter {
    position: relative;
    view-transition-name: welcome-letter;
    z-index: var(--z-welcome);
    h2, p {
      text-wrap: pretty;
    }
  }
  .welcome-letter__close {
    inset: var(--block-space) var(--block-space) auto auto;
    position: absolute;
  }
  .welcome-letter__signature {
    background-color: currentColor;
    block-size: 3em;
    display: inline-block;
    inline-size: 8em;
    mask-image: url("jf-signature.svg");
    mask-position: center;
    mask-repeat: no-repeat;
    mask-size: 8em 3em;
  }
}

================
File: app/channels/application_cable/connection.rb
================
module ApplicationCable
  class Connection < ActionCable::Connection::Base
    identified_by :current_user
    def connect
      set_current_user || reject_unauthorized_connection
    end
    private
      def set_current_user
        if session = find_session_by_cookie
          account = Account.find_by(external_account_id: request.env["fizzy.external_account_id"])
          Current.account = account
          self.current_user = session.identity.users.find_by!(account: account) if account
        end
      end
      def find_session_by_cookie
        Session.find_signed(cookies.signed[:session_token])
      end
  end
end

================
File: app/controllers/account/cancellations_controller.rb
================
class Account::CancellationsController < ApplicationController
  before_action :ensure_owner
  def create
    Current.account.cancel
    redirect_to session_menu_path(script_name: nil), notice: "Account deleted"
  end
  private
    def ensure_owner
      head :forbidden unless Current.user.owner?
    end
end

================
File: app/controllers/account/entropies_controller.rb
================
class Account::EntropiesController < ApplicationController
  before_action :ensure_admin
  def update
    Current.account.entropy.update!(entropy_params)
    redirect_to account_settings_path, notice: "Account updated"
  end
  private
    def entropy_params
      params.expect(entropy: [ :auto_postpone_period ])
    end
end

================
File: app/controllers/account/exports_controller.rb
================
class Account::ExportsController < ApplicationController
  before_action :ensure_admin_or_owner
  before_action :ensure_export_limit_not_exceeded, only: :create
  before_action :set_export, only: :show
  CURRENT_EXPORT_LIMIT = 10
  def show
  end
  def create
    Current.account.exports.create!(user: Current.user).build_later
    redirect_to account_settings_path, notice: "Export started. You'll receive an email when it's ready."
  end
  private
    def ensure_admin_or_owner
      head :forbidden unless Current.user.admin? || Current.user.owner?
    end
    def ensure_export_limit_not_exceeded
      head :too_many_requests if Current.account.exports.current.count >= CURRENT_EXPORT_LIMIT
    end
    def set_export
      @export = Current.account.exports.completed.find_by(id: params[:id], user: Current.user)
    end
end

================
File: app/controllers/account/imports_controller.rb
================
class Account::ImportsController < ApplicationController
  layout "public"
  disallow_account_scope only: %i[ new create ]
  allow_unauthorized_access only: :show
  before_action :set_import, only: %i[ show ]
  before_action :ensure_accessed_by_owner, only: %i[ show ]
  def new
  end
  def create
    signup = Signup.new(identity: Current.identity, full_name: "Import", skip_account_seeding: true)
    if signup.complete
      start_import(signup.account)
    else
      render :new, alert: "Couldn't create account."
    end
  end
  def show
  end
  private
    def set_import
      @import = Current.account.imports.find(params[:id])
    end
    def ensure_accessed_by_owner
      head :forbidden unless @import.identity == Current.identity
    end
    def start_import(account)
      import = nil
      Current.set(account: account) do
        import = account.imports.create!(identity: Current.identity, file: params[:file])
        import.process_later
      end
      redirect_to account_import_path(import, script_name: account.slug)
    end
end

================
File: app/controllers/account/join_codes_controller.rb
================
class Account::JoinCodesController < ApplicationController
  before_action :set_join_code
  before_action :ensure_admin, only: %i[ update destroy ]
  def show
  end
  def edit
  end
  def update
    if @join_code.update(join_code_params)
      redirect_to account_join_code_path
    else
      render :edit, status: :unprocessable_entity
    end
  end
  def destroy
    @join_code.reset
    redirect_to account_join_code_path
  end
  private
    def set_join_code
      @join_code = Current.account.join_code
    end
    def join_code_params
      params.expect account_join_code: [ :usage_limit ]
    end
end

================
File: app/controllers/account/settings_controller.rb
================
class Account::SettingsController < ApplicationController
  before_action :ensure_admin, only: :update
  before_action :set_account
  def show
    @users = @account.users.active.alphabetically.includes(:identity)
  end
  def update
    @account.update!(account_params)
    redirect_to account_settings_path
  end
  private
    def set_account
      @account = Current.account
    end
    def account_params
      params.expect account: %i[ name ]
    end
end

================
File: app/controllers/boards/columns/closeds_controller.rb
================
class Boards::Columns::ClosedsController < ApplicationController
  include BoardScoped
  def show
    set_page_and_extract_portion_from @board.cards.closed.recently_closed_first.preloaded
    fresh_when etag: @page.records
  end
end

================
File: app/controllers/boards/columns/not_nows_controller.rb
================
class Boards::Columns::NotNowsController < ApplicationController
  include BoardScoped
  def show
    set_page_and_extract_portion_from @board.cards.postponed.latest.preloaded
    fresh_when etag: @page.records
  end
end

================
File: app/controllers/boards/columns/streams_controller.rb
================
class Boards::Columns::StreamsController < ApplicationController
  include BoardScoped
  def show
    set_page_and_extract_portion_from @board.cards.awaiting_triage.latest.with_golden_first.preloaded
    fresh_when etag: @page.records
  end
end

================
File: app/controllers/boards/columns_controller.rb
================
class Boards::ColumnsController < ApplicationController
  include BoardScoped
  before_action :set_column, only: %i[ show update destroy ]
  def index
    @columns = @board.columns.sorted
    fresh_when etag: @columns
  end
  def show
    set_page_and_extract_portion_from @column.cards.active.latest.with_golden_first.preloaded
    fresh_when etag: @page.records
  end
  def create
    @column = @board.columns.create!(column_params)
    respond_to do |format|
      format.turbo_stream
      format.json { head :created, location: board_column_path(@board, @column, format: :json) }
    end
  end
  def update
    @column.update!(column_params)
    respond_to do |format|
      format.turbo_stream
      format.json { head :no_content }
    end
  end
  def destroy
    @column.destroy
    respond_to do |format|
      format.html { redirect_back_or_to @board }
      format.json { head :no_content }
    end
  end
  private
    def set_column
      @column = @board.columns.find(params[:id])
    end
    def column_params
      params.expect(column: [ :name, :color ])
    end
end

================
File: app/controllers/boards/entropies_controller.rb
================
class Boards::EntropiesController < ApplicationController
  include BoardScoped
  before_action :ensure_permission_to_admin_board
  def update
    @board.update!(entropy_params)
  end
  private
    def entropy_params
      params.expect(board: [ :auto_postpone_period ])
    end
end

================
File: app/controllers/boards/involvements_controller.rb
================
class Boards::InvolvementsController < ApplicationController
  include BoardScoped
  def update
    @board.access_for(Current.user).update!(involvement: params[:involvement])
  end
end

================
File: app/controllers/boards/publications_controller.rb
================
class Boards::PublicationsController < ApplicationController
  include BoardScoped
  before_action :ensure_permission_to_admin_board
  def create
    @board.publish
  end
  def destroy
    @board.unpublish
    @board.reload
  end
end

================
File: app/controllers/cards/comments/reactions_controller.rb
================
class Cards::Comments::ReactionsController < ApplicationController
  include CardScoped
  before_action :set_comment
  before_action :set_reactable
  with_options only: :destroy do
    before_action :set_reaction
    before_action :ensure_permission_to_administer_reaction
  end
  def index
    render "reactions/index"
  end
  def new
    render "reactions/new"
  end
  def create
    @reaction = @reactable.reactions.create!(params.expect(reaction: :content))
    respond_to do |format|
      format.turbo_stream { render "reactions/create" }
      format.json { head :created }
    end
  end
  def destroy
    @reaction.destroy
    respond_to do |format|
      format.turbo_stream { render "reactions/destroy" }
      format.json { head :no_content }
    end
  end
  private
    def set_comment
      @comment = @card.comments.find(params[:comment_id])
    end
    def set_reactable
      @reactable = @comment
    end
    def set_reaction
      @reaction = @reactable.reactions.find(params[:id])
    end
    def ensure_permission_to_administer_reaction
      head :forbidden if Current.user != @reaction.reacter
    end
end

================
File: app/controllers/cards/assignments_controller.rb
================
class Cards::AssignmentsController < ApplicationController
  include CardScoped
  def new
    @assigned_to = @card.assignees.active.alphabetically.where.not(id: Current.user)
    @users = @board.users.active.alphabetically.where.not(id: @card.assignees).where.not(id: Current.user)
    fresh_when etag: [ @users, @card.assignees ]
  end
  def create
    if @card.toggle_assignment @board.users.active.find(params[:assignee_id])
      respond_to do |format|
        format.turbo_stream
        format.json { head :no_content }
      end
    else
      respond_to do |format|
        format.turbo_stream
        format.json { head :unprocessable_entity }
      end
    end
  end
end

================
File: app/controllers/cards/boards_controller.rb
================
class Cards::BoardsController < ApplicationController
  include BoardScoped
  skip_before_action :set_board, only: %i[ edit ]
  before_action :set_card
  def edit
    @boards = Current.user.boards.ordered_by_recently_accessed
    fresh_when @boards
  end
  def update
    @card.move_to(@board)
    respond_to do |format|
      format.html { redirect_to @card }
      format.json { head :no_content }
    end
  end
  private
    def set_card
      @card = Current.user.accessible_cards.find_by!(number: params[:card_id])
    end
end

================
File: app/controllers/cards/closures_controller.rb
================
class Cards::ClosuresController < ApplicationController
  include CardScoped
  def create
    capture_card_location
    @card.close
    refresh_stream_if_needed
    respond_to do |format|
      format.turbo_stream
      format.json { head :no_content }
    end
  end
  def destroy
    @card.reopen
    refresh_stream_after_reopen
    respond_to do |format|
      format.turbo_stream
      format.json { head :no_content }
    end
  end
  private
    def refresh_stream_after_reopen
      if @card.awaiting_triage?
        set_page_and_extract_portion_from @board.cards.awaiting_triage.latest.with_golden_first.preloaded
      end
    end
end

================
File: app/controllers/cards/columns_controller.rb
================
class Cards::ColumnsController < ApplicationController
  def edit
    @card = Current.user.accessible_cards.find_by!(number: params[:card_id])
    @columns = @card.board.columns.sorted
    fresh_when etag: [ @card, @columns ]
  end
end

================
File: app/controllers/cards/comments_controller.rb
================
class Cards::CommentsController < ApplicationController
  include CardScoped
  before_action :set_comment, only: %i[ show edit update destroy ]
  before_action :ensure_creatorship, only: %i[ edit update destroy ]
  before_action :ensure_card_is_commentable, only: :create
  def index
    set_page_and_extract_portion_from @card.comments.chronologically
  end
  def create
    @comment = @card.comments.create!(comment_params)
    respond_to do |format|
      format.turbo_stream
      format.json { head :created, location: card_comment_path(@card, @comment, format: :json) }
    end
  end
  def show
  end
  def edit
  end
  def update
    @comment.update! comment_params
    respond_to do |format|
      format.turbo_stream
      format.json { head :no_content }
    end
  end
  def destroy
    @comment.destroy
    respond_to do |format|
      format.turbo_stream
      format.json { head :no_content }
    end
  end
  private
    def set_comment
      @comment = @card.comments.find(params[:id])
    end
    def ensure_creatorship
      head :forbidden if Current.user != @comment.creator
    end
    def ensure_card_is_commentable
      head :forbidden unless @card.commentable?
    end
    def comment_params
      params.expect(comment: [ :body, :created_at ])
    end
end

================
File: app/controllers/cards/drafts_controller.rb
================
class Cards::DraftsController < ApplicationController
  include CardScoped
  before_action :redirect_if_published
  def show
  end
  private
    def redirect_if_published
      redirect_to @card unless @card.drafted?
    end
end

================
File: app/controllers/cards/goldnesses_controller.rb
================
class Cards::GoldnessesController < ApplicationController
  include CardScoped
  def create
    @card.gild
    respond_to do |format|
      format.turbo_stream { render_card_replacement }
      format.json { head :no_content }
    end
  end
  def destroy
    @card.ungild
    respond_to do |format|
      format.turbo_stream { render_card_replacement }
      format.json { head :no_content }
    end
  end
end

================
File: app/controllers/cards/images_controller.rb
================
class Cards::ImagesController < ApplicationController
  include CardScoped
  def destroy
    @card.image.purge_later
    respond_to do |format|
      format.html { redirect_to @card }
      format.json { head :no_content }
    end
  end
end

================
File: app/controllers/cards/not_nows_controller.rb
================
class Cards::NotNowsController < ApplicationController
  include CardScoped
  def create
    capture_card_location
    @card.postpone
    refresh_stream_if_needed
    respond_to do |format|
      format.turbo_stream
      format.json { head :no_content }
    end
  end
end

================
File: app/controllers/cards/pins_controller.rb
================
class Cards::PinsController < ApplicationController
  include CardScoped
  def show
    fresh_when etag: @card.pin_for(Current.user) || "none"
  end
  def create
    @pin = @card.pin_by Current.user
    broadcast_add_pin_to_tray
    respond_to do |format|
      format.turbo_stream { render_pin_button_replacement }
      format.json { head :no_content }
    end
  end
  def destroy
    @pin = @card.unpin_by Current.user
    broadcast_remove_pin_from_tray
    respond_to do |format|
      format.turbo_stream { render_pin_button_replacement }
      format.json { head :no_content }
    end
  end
  private
    def broadcast_add_pin_to_tray
      @pin.broadcast_prepend_to [ Current.user, :pins_tray ], target: "pins", partial: "my/pins/pin"
    end
    def broadcast_remove_pin_from_tray
      @pin.broadcast_remove_to [ Current.user, :pins_tray ]
    end
    def render_pin_button_replacement
      render turbo_stream: turbo_stream.replace([ @card, :pin_button ], partial: "cards/pins/pin_button", locals: { card: @card })
    end
end

================
File: app/controllers/cards/previews_controller.rb
================
class Cards::PreviewsController < ApplicationController
  include FilterScoped
  before_action :set_filter, only: :index
  def index
    set_page_and_extract_portion_from @filter.cards
  end
end

================
File: app/controllers/cards/publishes_controller.rb
================
class Cards::PublishesController < ApplicationController
  include CardScoped
  def create
    @card.publish
    if add_another_param?
      card = @board.cards.create!(status: :drafted)
      redirect_to card_draft_path(card), notice: "Card added"
    else
      redirect_to @card.board
    end
  end
  private
    def add_another_param?
      params[:creation_type] == "add_another"
    end
end

================
File: app/controllers/cards/reactions_controller.rb
================
class Cards::ReactionsController < ApplicationController
  include CardScoped
  before_action :set_reactable
  with_options only: :destroy do
    before_action :set_reaction
    before_action :ensure_permission_to_administer_reaction
  end
  def index
    render "reactions/index"
  end
  def new
    render "reactions/new"
  end
  def create
    @reaction = @reactable.reactions.create!(params.expect(reaction: :content))
    respond_to do |format|
      format.turbo_stream { render "reactions/create" }
      format.json { head :created }
    end
  end
  def destroy
    @reaction.destroy
    respond_to do |format|
      format.turbo_stream { render "reactions/destroy" }
      format.json { head :no_content }
    end
  end
  private
    def set_reactable
      @reactable = @card
    end
    def set_reaction
      @reaction = @reactable.reactions.find(params[:id])
    end
    def ensure_permission_to_administer_reaction
      head :forbidden if Current.user != @reaction.reacter
    end
end

================
File: app/controllers/cards/readings_controller.rb
================
class Cards::ReadingsController < ApplicationController
  include CardScoped
  def create
    @notifications = @card.read_by(Current.user)
    record_board_access
  end
  def destroy
    @notifications = @card.unread_by(Current.user)
    record_board_access
  end
  private
    def record_board_access
      @card.board.accessed_by(Current.user)
    end
end

================
File: app/controllers/cards/self_assignments_controller.rb
================
class Cards::SelfAssignmentsController < ApplicationController
  include CardScoped
  def create
    if @card.toggle_assignment(Current.user)
      respond_to do |format|
        format.turbo_stream { render "cards/assignments/create" }
        format.json { head :no_content }
      end
    else
      respond_to do |format|
        format.turbo_stream { render "cards/assignments/create" }
        format.json { head :unprocessable_entity }
      end
    end
  end
end

================
File: app/controllers/cards/steps_controller.rb
================
class Cards::StepsController < ApplicationController
  include CardScoped
  before_action :set_step, only: %i[ show edit update destroy ]
  def create
    @step = @card.steps.create!(step_params)
    respond_to do |format|
      format.turbo_stream
      format.json { head :created, location: card_step_path(@card, @step, format: :json) }
    end
  end
  def show
  end
  def edit
  end
  def update
    @step.update!(step_params)
    respond_to do |format|
      format.turbo_stream
      format.json { render :show }
    end
  end
  def destroy
    @step.destroy!
    respond_to do |format|
      format.turbo_stream
      format.json { head :no_content }
    end
  end
  private
    def set_step
      @step = @card.steps.find(params[:id])
    end
    def step_params
      params.expect(step: [ :content, :completed ])
    end
end

================
File: app/controllers/cards/taggings_controller.rb
================
class Cards::TaggingsController < ApplicationController
  include CardScoped
  def new
    @tagged_with = @card.tags.alphabetically
    @tags = Current.account.tags.all.alphabetically.where.not(id: @tagged_with)
    fresh_when etag: [ @tags, @card.tags ]
  end
  def create
    @card.toggle_tag_with sanitized_tag_title_param
    respond_to do |format|
      format.turbo_stream
      format.json { head :no_content }
    end
  end
  private
    def sanitized_tag_title_param
      params.required(:tag_title).strip.gsub(/\A#/, "")
    end
end

================
File: app/controllers/cards/triages_controller.rb
================
class Cards::TriagesController < ApplicationController
  include CardScoped
  def create
    column = @card.board.columns.find(params[:column_id])
    @card.triage_into(column)
    respond_to do |format|
      format.html { redirect_to @card }
      format.json { head :no_content }
    end
  end
  def destroy
    @card.send_back_to_triage
    respond_to do |format|
      format.html { redirect_to @card }
      format.json { head :no_content }
    end
  end
end

================
File: app/controllers/cards/watches_controller.rb
================
class Cards::WatchesController < ApplicationController
  include CardScoped
  def show
    fresh_when etag: @card.watch_for(Current.user) || "none"
  end
  def create
    @card.watch_by Current.user
    respond_to do |format|
      format.turbo_stream
      format.json { head :no_content }
    end
  end
  def destroy
    @card.unwatch_by Current.user
    respond_to do |format|
      format.turbo_stream
      format.json { head :no_content }
    end
  end
end

================
File: app/controllers/columns/cards/drops/closures_controller.rb
================
class Columns::Cards::Drops::ClosuresController < ApplicationController
  include CardScoped
  def create
    @card.close
  end
end

================
File: app/controllers/columns/cards/drops/columns_controller.rb
================
class Columns::Cards::Drops::ColumnsController < ApplicationController
  include CardScoped
  def create
    @column = @card.board.columns.find(params[:column_id])
    @card.triage_into(@column)
  end
end

================
File: app/controllers/columns/cards/drops/not_nows_controller.rb
================
class Columns::Cards::Drops::NotNowsController < ApplicationController
  include CardScoped
  def create
    @card.postpone
  end
end

================
File: app/controllers/columns/cards/drops/streams_controller.rb
================
class Columns::Cards::Drops::StreamsController < ApplicationController
  include CardScoped
  def create
    @card.send_back_to_triage
    set_page_and_extract_portion_from @board.cards.awaiting_triage.latest.with_golden_first
  end
end

================
File: app/controllers/columns/left_positions_controller.rb
================
class Columns::LeftPositionsController < ApplicationController
  include ColumnScoped
  def create
    @left_column = @column.left_column
    @column.move_left
  end
end

================
File: app/controllers/columns/right_positions_controller.rb
================
class Columns::RightPositionsController < ApplicationController
  include ColumnScoped
  def create
    @right_column = @column.right_column
    @column.move_right
  end
end

================
File: app/controllers/concerns/authentication/via_magic_link.rb
================
module Authentication::ViaMagicLink
  extend ActiveSupport::Concern
  included do
    after_action :ensure_development_magic_link_not_leaked
  end
  private
    def ensure_development_magic_link_not_leaked
      unless Rails.env.development?
        raise "Leaking magic link via flash in #{Rails.env}?" if flash[:magic_link_code].present?
      end
    end
    def redirect_to_fake_session_magic_link(email_address, **options)
      fake_magic_link = MagicLink.new(
        identity: Identity.new(email_address: email_address),
        code: SecureRandom.base32(6),
        expires_at: MagicLink::EXPIRATION_TIME.from_now
      )
      redirect_to_session_magic_link fake_magic_link, **options
    end
    def redirect_to_session_magic_link(magic_link, return_to: nil)
      serve_development_magic_link(magic_link)
      set_pending_authentication_token(magic_link)
      session[:return_to_after_authenticating] = return_to if return_to
      respond_to do |format|
        format.html { redirect_to main_app.session_magic_link_url(script_name: nil) }
        format.json { render json: { pending_authentication_token: pending_authentication_token }, status: :created }
      end
    end
    def serve_development_magic_link(magic_link)
      if Rails.env.development? && magic_link.present?
        flash[:magic_link_code] = magic_link.code
        response.set_header("X-Magic-Link-Code", magic_link.code)
      end
    end
    def set_pending_authentication_token(magic_link)
      cookies[:pending_authentication_token] = {
        value: pending_authentication_token_verifier.generate(magic_link.identity.email_address, expires_at: magic_link.expires_at),
        httponly: true,
        same_site: :lax,
        expires: magic_link.expires_at
      }
    end
    def email_address_pending_authentication
      pending_authentication_token_verifier.verified(pending_authentication_token)
    end
    def pending_authentication_token_verifier
      Rails.application.message_verifier(:pending_authentication)
    end
    def pending_authentication_token
      cookies[:pending_authentication_token]
    end
    def clear_pending_authentication_token
      cookies.delete(:pending_authentication_token)
    end
end

================
File: app/controllers/concerns/authentication.rb
================
module Authentication
  extend ActiveSupport::Concern
  included do
    before_action :require_account # Checking and setting account must happen first
    before_action :require_authentication
    helper_method :authenticated?
    helper_method :email_address_pending_authentication
    etag { Current.identity.id if authenticated? }
    include Authentication::ViaMagicLink, LoginHelper
  end
  class_methods do
    def require_unauthenticated_access(**options)
      allow_unauthenticated_access **options
      before_action :redirect_authenticated_user, **options
    end
    def allow_unauthenticated_access(**options)
      skip_before_action :require_authentication, **options
      before_action :resume_session, **options
      allow_unauthorized_access **options
    end
    def disallow_account_scope(**options)
      skip_before_action :require_account, **options
      before_action :redirect_tenanted_request, **options
    end
  end
  private
    def authenticated?
      Current.identity.present?
    end
    def require_account
      unless Current.account.present?
        redirect_to main_app.session_menu_path(script_name: nil)
      end
    end
    def require_authentication
      resume_session || authenticate_by_bearer_token || request_authentication
    end
    def resume_session
      if session = find_session_by_cookie
        set_current_session session
      end
    end
    def find_session_by_cookie
      Session.find_signed(cookies.signed[:session_token])
    end
    def authenticate_by_bearer_token
      if request.authorization.to_s.include?("Bearer")
        authenticate_or_request_with_http_token do |token|
          if identity = Identity.find_by_permissable_access_token(token, method: request.method)
            Current.identity = identity
          end
        end
      end
    end
    def request_authentication
      if Current.account.present?
        session[:return_to_after_authenticating] = request.url
      end
      redirect_to_login_url
    end
    def after_authentication_url
      session.delete(:return_to_after_authenticating) || landing_url
    end
    def redirect_authenticated_user
      redirect_to main_app.root_url if authenticated?
    end
    def redirect_tenanted_request
      redirect_to main_app.root_url if Current.account.present?
    end
    def start_new_session_for(identity)
      identity.sessions.create!(user_agent: request.user_agent, ip_address: request.remote_ip).tap do |session|
        set_current_session session
      end
    end
    def set_current_session(session)
      Current.session = session
      cookies.signed.permanent[:session_token] = { value: session.signed_id, httponly: true, same_site: :lax }
    end
    def terminate_session
      Current.session.destroy
      cookies.delete(:session_token)
    end
    def session_token
      cookies[:session_token]
    end
end

================
File: app/controllers/concerns/authorization.rb
================
module Authorization
  extend ActiveSupport::Concern
  included do
    before_action :ensure_can_access_account, if: :authenticated_account_access?
  end
  class_methods do
    def allow_unauthorized_access(**options)
      skip_before_action :ensure_can_access_account, **options
    end
    def require_access_without_a_user(**options)
      skip_before_action :ensure_can_access_account, **options
      before_action :redirect_existing_user, **options
    end
  end
  private
    def ensure_admin
      head :forbidden unless Current.user.admin?
    end
    def ensure_staff
      head :forbidden unless Current.identity.staff?
    end
    def authenticated_account_access?
      Current.account.present? && authenticated?
    end
    def ensure_can_access_account
      unless Current.account.active? && Current.user&.active?
        respond_to do |format|
          format.html { redirect_to session_menu_path(script_name: nil) }
          format.json { head :forbidden }
        end
      end
    end
    def redirect_existing_user
      redirect_to root_path if Current.user
    end
end

================
File: app/controllers/concerns/block_search_engine_indexing.rb
================
# Tell crawlers like Googlebot to drop pages entirely from search results, even
# if other sites link to it
module BlockSearchEngineIndexing
  extend ActiveSupport::Concern
  included do
    after_action :block_search_engine_indexing
  end
  private
    def block_search_engine_indexing
      headers["X-Robots-Tag"] = "none"
    end
end

================
File: app/controllers/concerns/board_scoped.rb
================
module BoardScoped
  extend ActiveSupport::Concern
  included do
    before_action :set_board
  end
  private
    def set_board
      @board = Current.user.boards.find(params[:board_id])
    end
    def ensure_permission_to_admin_board
      unless Current.user.can_administer_board?(@board)
        head :forbidden
      end
    end
end

================
File: app/controllers/concerns/card_scoped.rb
================
module CardScoped
  extend ActiveSupport::Concern
  included do
    before_action :set_card, :set_board
  end
  private
    def set_card
      @card = Current.user.accessible_cards.find_by!(number: params[:card_id])
    end
    def set_board
      @board = @card.board
    end
    def render_card_replacement
      render turbo_stream: turbo_stream.replace([ @card, :card_container ], partial: "cards/container", method: :morph, locals: { card: @card.reload })
    end
    def capture_card_location
      @source_column = @card.column
      @was_in_stream = @card.awaiting_triage?
    end
    def refresh_stream_if_needed
      if @was_in_stream
        set_page_and_extract_portion_from @board.cards.awaiting_triage.latest.with_golden_first.preloaded
      end
    end
end

================
File: app/controllers/concerns/column_scoped.rb
================
module ColumnScoped
  extend ActiveSupport::Concern
  included do
    before_action :set_column
  end
  private
    def set_column
      @column = Current.user.accessible_columns.find(params[:column_id])
    end
end

================
File: app/controllers/concerns/current_request.rb
================
module CurrentRequest
  extend ActiveSupport::Concern
  included do
    before_action do
      Current.http_method = request.method
      Current.request_id  = request.uuid
      Current.user_agent  = request.user_agent
      Current.ip_address  = request.ip
      Current.referrer    = request.referrer
    end
  end
end

================
File: app/controllers/concerns/current_timezone.rb
================
# FIXME: This should move upstream to Rails. It's a good pattern.
module CurrentTimezone
  extend ActiveSupport::Concern
  included do
    around_action :set_current_timezone
    helper_method :timezone_from_cookie
    etag { timezone_from_cookie }
  end
  private
    def set_current_timezone(&)
      Time.use_zone(timezone_from_cookie, &)
    end
    def timezone_from_cookie
      @timezone_from_cookie ||= begin
        timezone = cookies[:timezone]
        ActiveSupport::TimeZone[timezone] if timezone.present?
      end
    end
end

================
File: app/controllers/concerns/day_timelines_scoped.rb
================
module DayTimelinesScoped
  extend ActiveSupport::Concern
  included do
    include FilterScoped
    before_action :set_day_timeline
  end
  private
    def set_day_timeline
      @day_timeline = Current.user.timeline_for(day, filter: @filter)
    end
    def day
      if params[:day].present?
        Time.zone.parse(params[:day])
      else
        Time.current
      end
    rescue ArgumentError
      head :not_found
    end
end

================
File: app/controllers/concerns/filter_scoped.rb
================
module FilterScoped
  extend ActiveSupport::Concern
  included do
    before_action :set_filter
    before_action :set_user_filtering
  end
  private
    def set_filter
      if params[:filter_id].present?
        @filter = Current.user.filters.find(params[:filter_id])
      else
        @filter = Current.user.filters.from_params filter_params
      end
    end
    def filter_params
      params.with_defaults(**Filter.default_values).permit(*Filter::PERMITTED_PARAMS)
    end
    def set_user_filtering
      @user_filtering = User::Filtering.new(Current.user, @filter, expanded: expanded_param)
    end
    def expanded_param
      ActiveRecord::Type::Boolean.new.cast(params[:expand_all])
    end
end

================
File: app/controllers/concerns/request_forgery_protection.rb
================
module RequestForgeryProtection
  extend ActiveSupport::Concern
  included do
    protect_from_forgery using: :header_only, with: :exception
  end
  private
    def verified_via_header_only?
      super || allowed_api_request? || allowed_insecure_context_request?
    end
    def allowed_api_request?
      sec_fetch_site_value.nil? && request.format.json?
    end
    def allowed_insecure_context_request?
      sec_fetch_site_value.nil? && !request.ssl? && !Rails.configuration.force_ssl
    end
end

================
File: app/controllers/concerns/routing_headers.rb
================
module RoutingHeaders
  extend ActiveSupport::Concern
  included do
    before_action :set_target_header
  end
  private
    def set_target_header
      response.headers["X-Kamal-Target"] = request.headers["X-Kamal-Target"]
    end
end

================
File: app/controllers/concerns/set_platform.rb
================
module SetPlatform
  extend ActiveSupport::Concern
  included do
    helper_method :platform
  end
  private
    def platform
      @platform ||= ApplicationPlatform.new(request.user_agent)
    end
end

================
File: app/controllers/concerns/turbo_flash.rb
================
module TurboFlash
  extend ActiveSupport::Concern
  included do
    helper_method :turbo_stream_flash
  end
  private
    def turbo_stream_flash(**flash_options)
      turbo_stream.replace(:flash, partial: "layouts/shared/flash", locals: { flash: flash_options })
    end
end

================
File: app/controllers/concerns/view_transitions.rb
================
# FIXME: Upstream this fix to turbo-rails
module ViewTransitions
  extend ActiveSupport::Concern
  included do
    before_action :disable_view_transitions, if: :page_refresh?
  end
  private
    def disable_view_transitions
      @disable_view_transition = true
    end
    def page_refresh?
      request.referrer.present? && request.referrer == request.url
    end
end

================
File: app/controllers/events/day_timeline/columns_controller.rb
================
class Events::DayTimeline::ColumnsController < ApplicationController
  include DayTimelinesScoped
  before_action :ensure_valid_column
  before_action :set_column
  def show
    fresh_when @day_timeline
  end
  private
    VALID_COLUMNS = %w[ added updated closed ]
    def ensure_valid_column
      head :not_found unless VALID_COLUMNS.include?(params[:id])
    end
    def set_column
      @column = @day_timeline.public_send("#{params[:id]}_column")
    end
end

================
File: app/controllers/events/days_controller.rb
================
class Events::DaysController < ApplicationController
  include DayTimelinesScoped
  def index
    fresh_when @day_timeline
  end
end

================
File: app/controllers/filters/settings_refreshes_controller.rb
================
class Filters::SettingsRefreshesController < ApplicationController
  include FilterScoped
  def create
  end
end

================
File: app/controllers/my/access_tokens_controller.rb
================
class My::AccessTokensController < ApplicationController
  def index
    @access_tokens = my_access_tokens.order(created_at: :desc)
  end
  def show
    @access_token = my_access_tokens.find(verifier.verify(params[:id]))
  rescue ActiveSupport::MessageVerifier::InvalidSignature
    redirect_to my_access_tokens_path, alert: "Token is no longer visible"
  end
  def new
    @access_token = my_access_tokens.new
  end
  def create
    access_token = my_access_tokens.create!(access_token_params)
    expiring_id = verifier.generate access_token.id, expires_in: 10.seconds
    redirect_to my_access_token_path(expiring_id)
  end
  def destroy
    my_access_tokens.find(params[:id]).destroy!
    redirect_to my_access_tokens_path
  end
  private
    def my_access_tokens
      Current.identity.access_tokens
    end
    def access_token_params
      params.expect(access_token: %i[ description permission ])
    end
    def verifier
      Rails.application.message_verifier(:access_tokens)
    end
end

================
File: app/controllers/my/identities_controller.rb
================
class My::IdentitiesController < ApplicationController
  disallow_account_scope
  def show
    @identity = Current.identity
  end
end

================
File: app/controllers/my/menus_controller.rb
================
class My::MenusController < ApplicationController
  def show
    @filters = Current.user.filters.all
    @boards = Current.user.boards.ordered_by_recently_accessed
    @tags = Current.account.tags.all.alphabetically
    @users = Current.account.users.active.alphabetically
    @accounts = Current.identity.accounts.active
    fresh_when etag: [ @filters, @boards, @tags, @users, @accounts ]
  end
end

================
File: app/controllers/my/pins_controller.rb
================
class My::PinsController < ApplicationController
  def index
    @pins = user_pins
    fresh_when etag: [ @pins, @pins.collect(&:card) ]
  end
  private
    def user_pins
      Current.user.pins.includes(:card).ordered.limit(pins_limit)
    end
    def pins_limit
      request.format.json? ? 100 : 20
    end
end

================
File: app/controllers/my/timezones_controller.rb
================
class My::TimezonesController < ApplicationController
  def update
    Current.user.settings.update!(timezone_name: timezone_param)
  end
  private
    def timezone_param
      params[:timezone_name]
    end
end

================
File: app/controllers/notifications/bulk_readings_controller.rb
================
class Notifications::BulkReadingsController < ApplicationController
  def create
    Current.user.notifications.unread.read_all
    respond_to do |format|
      format.html do
        if from_tray?
          head :ok
        else
          redirect_to notifications_path
        end
      end
      format.json { head :no_content }
    end
  end
  private
    def from_tray?
      params[:from_tray]
    end
end

================
File: app/controllers/notifications/readings_controller.rb
================
class Notifications::ReadingsController < ApplicationController
  def create
    @notification = Current.user.notifications.find(params[:notification_id])
    @notification.read
    respond_to do |format|
      format.turbo_stream
      format.json { head :no_content }
    end
  end
  def destroy
    @notification = Current.user.notifications.find(params[:notification_id])
    @notification.unread
    respond_to do |format|
      format.turbo_stream
      format.json { head :no_content }
    end
  end
end

================
File: app/controllers/notifications/settings_controller.rb
================
class Notifications::SettingsController < ApplicationController
  before_action :set_settings
  def show
    @boards = Current.user.boards.alphabetically
  end
  def update
    @settings.update!(settings_params)
    redirect_to notifications_settings_path, notice: "Settings updated"
  end
  private
    def set_settings
      @settings = Current.user.settings
    end
    def settings_params
      params.expect(user_settings: :bundle_email_frequency)
    end
end

================
File: app/controllers/notifications/trays_controller.rb
================
class Notifications::TraysController < ApplicationController
  def show
    @notifications = Current.user.notifications.preloaded.unread.ordered.limit(100)
    # Invalidate on the whole set instead of the unread set since the max updated at in the unread set
    # can stay the same when reading old notifications.
    fresh_when Current.user.notifications
  end
end

================
File: app/controllers/notifications/unsubscribes_controller.rb
================
class Notifications::UnsubscribesController < ApplicationController
  allow_unauthenticated_access
  skip_forgery_protection
  before_action :set_user
  def new
  end
  def create
    @user.settings.bundle_email_never!
    redirect_to notifications_unsubscribe_path(access_token: params[:access_token])
  end
  def show
  end
  private
    def set_user
      unless @user = User.find_by_token_for(:unsubscribe, params[:access_token])
        redirect_to root_path, alert: "Invalid unsubscribe link"
      end
    end
end

================
File: app/controllers/prompts/boards/users_controller.rb
================
class Prompts::Boards::UsersController < ApplicationController
  include BoardScoped
  def index
    @users = @board.users.active.alphabetically
    if stale? etag: @users
      render layout: false
    end
  end
end

================
File: app/controllers/prompts/cards_controller.rb
================
class Prompts::CardsController < ApplicationController
  MAX_RESULTS = 10
  def index
    @cards = if filter_param.present?
      prepending_exact_matches_by_id(search_cards)
    else
      published_cards.latest
    end
    if stale? etag: @cards
      render layout: false
    end
  end
  private
    def filter_param
      params[:filter]
    end
    def search_cards
      published_cards
        .mentioning(params[:filter], user: Current.user)
        .reverse_chronologically
        .limit(MAX_RESULTS)
    end
    def published_cards
      Current.user.accessible_cards.published
    end
    def prepending_exact_matches_by_id(cards)
      if card_by_id = Current.user.accessible_cards.find_by(number: params[:filter])
        [ card_by_id ] + cards
      else
        cards
      end
    end
end

================
File: app/controllers/prompts/tags_controller.rb
================
class Prompts::TagsController < ApplicationController
  def index
    @tags = Current.account.tags.all.alphabetically
    if stale? etag: @tags
      render layout: false
    end
  end
end

================
File: app/controllers/prompts/users_controller.rb
================
class Prompts::UsersController < ApplicationController
  def index
    @users = Current.account.users.active.alphabetically
    if stale? etag: @users
      render layout: false
    end
  end
end

================
File: app/controllers/public/boards/columns/closeds_controller.rb
================
class Public::Boards::Columns::ClosedsController < Public::BaseController
  def show
    set_page_and_extract_portion_from @board.cards.closed.recently_closed_first
  end
end

================
File: app/controllers/public/boards/columns/not_nows_controller.rb
================
class Public::Boards::Columns::NotNowsController < Public::BaseController
  def show
    set_page_and_extract_portion_from @board.cards.postponed.latest
  end
end

================
File: app/controllers/public/boards/columns/streams_controller.rb
================
class Public::Boards::Columns::StreamsController < Public::BaseController
  def show
    set_page_and_extract_portion_from @board.cards.awaiting_triage.latest.with_golden_first
  end
end

================
File: app/controllers/public/boards/columns_controller.rb
================
class Public::Boards::ColumnsController < Public::BaseController
  before_action :set_column
  def show
    set_page_and_extract_portion_from @column.cards.active.latest.with_golden_first
  end
  private
    # Unlike the other public controllers, this is using params[:id] to fetch the column instead of the card
    def set_card
    end
    def set_column
      @column = @board.columns.find(params[:id])
    end
end

================
File: app/controllers/public/base_controller.rb
================
class Public::BaseController < ApplicationController
  allow_unauthenticated_access
  before_action :set_board, :set_card, :set_public_cache_expiration
  before_action :ensure_board_accessible
  layout "public"
  private
    def set_board
      @board = Board.find_by_published_key(params[:board_id] || params[:id])
    end
    def set_card
      @card = @board.cards.published.find_by!(number: params[:id]) if params[:board_id] && params[:id]
    end
    def set_public_cache_expiration
      expires_in 30.seconds, public: true
    end
    def ensure_board_accessible
      raise ActionController::RoutingError, "Not Found" if @board&.account&.cancelled?
    end
end

================
File: app/controllers/public/boards_controller.rb
================
class Public::BoardsController < Public::BaseController
  def show
    set_page_and_extract_portion_from @board.cards.awaiting_triage.latest.with_golden_first
  end
end

================
File: app/controllers/public/cards_controller.rb
================
class Public::CardsController < Public::BaseController
  def show
  end
end

================
File: app/controllers/searches/queries_controller.rb
================
class Searches::QueriesController < ApplicationController
  def create
    Current.user.remember_search(params[:q])
    head :ok
  end
end

================
File: app/controllers/sessions/magic_links_controller.rb
================
class Sessions::MagicLinksController < ApplicationController
  disallow_account_scope
  require_unauthenticated_access
  rate_limit to: 10, within: 15.minutes, only: :create, with: :rate_limit_exceeded
  before_action :ensure_that_email_address_pending_authentication_exists
  layout "public"
  def show
  end
  def create
    if magic_link = MagicLink.consume(code)
      authenticate magic_link
    else
      invalid_code
    end
  end
  private
    def ensure_that_email_address_pending_authentication_exists
      unless email_address_pending_authentication.present?
        alert_message = "Enter your email address to sign in."
        respond_to do |format|
          format.html { redirect_to new_session_path, alert: alert_message }
          format.json { render json: { message: alert_message }, status: :unauthorized }
        end
      end
    end
    def code
      params.expect(:code)
    end
    def authenticate(magic_link)
      if ActiveSupport::SecurityUtils.secure_compare(email_address_pending_authentication || "", magic_link.identity.email_address)
        sign_in magic_link
      else
        email_address_mismatch
      end
    end
    def sign_in(magic_link)
      clear_pending_authentication_token
      start_new_session_for magic_link.identity
      respond_to do |format|
        format.html { redirect_to after_sign_in_url(magic_link) }
        format.json { render json: { session_token: session_token, requires_signup_completion: requires_signup_completion?(magic_link) } }
      end
    end
    def email_address_mismatch
      clear_pending_authentication_token
      alert_message = "Something went wrong. Please try again."
      respond_to do |format|
        format.html { redirect_to new_session_path, alert: alert_message }
        format.json { render json: { message: alert_message }, status: :unauthorized }
      end
    end
    def invalid_code
      respond_to do |format|
        format.html { redirect_to session_magic_link_path, flash: { shake: true } }
        format.json { render json: { message: "Try another code." }, status: :unauthorized }
      end
    end
    def after_sign_in_url(magic_link)
      if requires_signup_completion?(magic_link)
        new_signup_completion_path
      else
        after_authentication_url
      end
    end
    def rate_limit_exceeded
      rate_limit_exceeded_message = "Try again in 15 minutes."
      respond_to do |format|
        format.html { redirect_to session_magic_link_path, alert: rate_limit_exceeded_message }
        format.json { render json: { message: rate_limit_exceeded_message }, status: :too_many_requests }
      end
    end
    def requires_signup_completion?(magic_link)
      magic_link.for_sign_up?
    end
end

================
File: app/controllers/sessions/menus_controller.rb
================
class Sessions::MenusController < ApplicationController
  disallow_account_scope
  layout "public"
  def show
    @accounts = Current.identity.accounts.active
    if @accounts.one?
      redirect_to root_url(script_name: @accounts.first.slug)
    end
  end
end

================
File: app/controllers/sessions/transfers_controller.rb
================
class Sessions::TransfersController < ApplicationController
  disallow_account_scope
  require_unauthenticated_access
  def show
  end
  def update
    if identity = Identity.find_by_transfer_id(params[:id])
      start_new_session_for identity
      redirect_to session_menu_path(script_name: nil)
    else
      head :bad_request
    end
  end
end

================
File: app/controllers/signups/completions_controller.rb
================
class Signups::CompletionsController < ApplicationController
  layout "public"
  disallow_account_scope
  def new
    @signup = Signup.new(identity: Current.identity)
  end
  def create
    @signup = Signup.new(signup_params)
    if @signup.complete
      welcome_to_account
    else
      invalid_signup
    end
  end
  private
    def signup_params
      params.expect(signup: %i[ full_name ]).with_defaults(identity: Current.identity)
    end
    def welcome_to_account
      respond_to do |format|
        format.html do
          flash[:welcome_letter] = true
          redirect_to landing_url(script_name: @signup.account.slug)
        end
        format.json { render json: { account_id: @signup.account.id }, status: :created }
      end
    end
    def invalid_signup
      respond_to do |format|
        format.html { render :new, status: :unprocessable_entity }
        format.json { render json: { errors: @signup.errors.full_messages }, status: :unprocessable_entity }
      end
    end
end

================
File: app/controllers/users/email_addresses/confirmations_controller.rb
================
class Users::EmailAddresses::ConfirmationsController < ApplicationController
  allow_unauthenticated_access
  before_action :set_user
  rate_limit to: 5, within: 1.hour, only: :create
  def show
  end
  def create
    if @user.change_email_address_using_token(token)
      terminate_session if Current.session
      start_new_session_for @user.identity
      redirect_to edit_user_url(script_name: @user.account.slug, id: @user)
    else
      render :invalid_token, status: :unprocessable_entity
    end
  end
  private
    def set_user
      @user = Current.account.users.active.find(params[:user_id])
    end
    def token
      params.expect :email_address_token
    end
end

================
File: app/controllers/users/avatars_controller.rb
================
class Users::AvatarsController < ApplicationController
  allow_unauthenticated_access only: :show
  before_action :set_user
  before_action :ensure_permission_to_administer_user, only: :destroy
  def show
    if @user.system?
      redirect_to view_context.image_path("system_user.png")
    elsif @user.avatar.attached?
      redirect_to rails_blob_path(@user.avatar_thumbnail, disposition: "inline")
    elsif stale? @user, cache_control: cache_control
      render_initials
    end
  end
  def destroy
    @user.avatar.destroy
    redirect_to @user
  end
  private
    def set_user
      @user = Current.account.users.find(params[:user_id])
    end
    def ensure_permission_to_administer_user
      head :forbidden unless Current.user.can_change?(@user)
    end
    def cache_control
      if @user == Current.user
        {}
      else
        { max_age: 30.minutes, stale_while_revalidate: 1.week }
      end
    end
    def render_initials
      render formats: :svg
    end
end

================
File: app/controllers/users/data_exports_controller.rb
================
class Users::DataExportsController < ApplicationController
  before_action :set_user
  before_action :ensure_current_user
  before_action :ensure_export_limit_not_exceeded, only: :create
  before_action :set_export, only: :show
  CURRENT_EXPORT_LIMIT = 10
  def show
  end
  def create
    @user.data_exports.create!(account: Current.account).build_later
    redirect_to @user, notice: "Export started. You'll receive an email when it's ready."
  end
  private
    def set_user
      @user = Current.account.users.find(params[:user_id])
    end
    def ensure_current_user
      head :forbidden unless @user == Current.user
    end
    def ensure_export_limit_not_exceeded
      head :too_many_requests if @user.data_exports.current.count >= CURRENT_EXPORT_LIMIT
    end
    def set_export
      @export = @user.data_exports.completed.find_by(id: params[:id])
    end
end

================
File: app/controllers/users/email_addresses_controller.rb
================
class Users::EmailAddressesController < ApplicationController
  before_action :set_user
  rate_limit to: 5, within: 1.hour, only: :create
  def new
  end
  def create
    identity = Identity.find_by_email_address(new_email_address)
    if identity&.users&.exists?(account: @user.account)
      flash[:alert] = "You already have a user in this account with that email address"
      redirect_to new_user_email_address_path(@user)
    else
      @user.send_email_address_change_confirmation(new_email_address)
    end
  end
  private
    def set_user
      @user = Current.identity.users.find(params[:user_id])
    end
    def new_email_address
      params.expect :email_address
    end
end

================
File: app/controllers/users/events_controller.rb
================
class Users::EventsController < ApplicationController
  include FilterScoped
  before_action :set_user, :set_filter, :set_user_filtering
  def show
    @filter = Current.user.filters.new(creator_ids: [ @user.id ])
    @day_timeline = Current.user.timeline_for(day_param, filter: @filter)
    fresh_when @day_timeline
  end
  private
    def set_user
      @user = Current.account.users.active.find(params[:user_id])
    end
    def day_param
      if params[:day].present?
        Time.zone.parse(params[:day])
      else
        Time.current
      end
    end
end

================
File: app/controllers/users/joins_controller.rb
================
class Users::JoinsController < ApplicationController
  layout "public"
  def new
  end
  def create
    Current.user.update!(user_params)
    redirect_to landing_path
  end
  private
    def user_params
      params.expect(user: [ :name, :avatar ])
    end
end

================
File: app/controllers/users/push_subscriptions_controller.rb
================
class Users::PushSubscriptionsController < ApplicationController
  before_action :set_push_subscriptions
  def index
  end
  def create
    @push_subscriptions.create_with(user_agent: request.user_agent).create_or_find_by!(push_subscription_params)
  end
  def destroy
    @push_subscriptions.destroy_by(id: params[:id])
    redirect_to user_push_subscriptions_url
  end
  private
    def set_push_subscriptions
      @push_subscriptions = Current.user.push_subscriptions
    end
    def push_subscription_params
      params.require(:push_subscription).permit(:endpoint, :p256dh_key, :auth_key)
    end
end

================
File: app/controllers/users/roles_controller.rb
================
class Users::RolesController < ApplicationController
  before_action :set_user
  before_action :ensure_permission_to_administer_user
  def update
    @user.update!(role_params)
    redirect_to account_settings_path
  end
  private
    def set_user
      @user = Current.account.users.active.find(params[:user_id])
    end
    def ensure_permission_to_administer_user
      head :forbidden unless Current.user.can_administer?(@user)
    end
    def role_params
      { role: params.require(:user)[:role].presence_in(%w[ member admin ]) || "member" }
    end
end

================
File: app/controllers/users/verifications_controller.rb
================
class Users::VerificationsController < ApplicationController
  layout "public"
  def new
  end
  def create
    Current.user.verify
    redirect_to new_users_join_path
  end
end

================
File: app/controllers/webhooks/activations_controller.rb
================
class Webhooks::ActivationsController < ApplicationController
  include BoardScoped
  before_action :ensure_admin
  def create
    webhook = @board.webhooks.find(params[:webhook_id])
    webhook.activate
    redirect_to webhook
  end
end

================
File: app/controllers/admin_controller.rb
================
class AdminController < ApplicationController
  disallow_account_scope
  before_action :ensure_staff
end

================
File: app/controllers/application_controller.rb
================
class ApplicationController < ActionController::Base
  include Authentication
  include Authorization
  include BlockSearchEngineIndexing
  include CurrentRequest, CurrentTimezone, SetPlatform
  include RequestForgeryProtection
  include TurboFlash, ViewTransitions
  include RoutingHeaders
  etag { "v1" }
  stale_when_importmap_changes
  allow_browser versions: :modern
end

================
File: app/controllers/boards_controller.rb
================
class BoardsController < ApplicationController
  include FilterScoped
  before_action :set_board, except: %i[ index new create ]
  before_action :ensure_permission_to_admin_board, only: %i[ update destroy ]
  def index
    set_page_and_extract_portion_from Current.user.boards
  end
  def show
    if @filter.used?(ignore_boards: true)
      show_filtered_cards
    else
      show_columns
    end
  end
  def new
    @board = Board.new
  end
  def create
    @board = Board.create! board_params.with_defaults(all_access: true)
    respond_to do |format|
      format.html { redirect_to board_path(@board) }
      format.json { head :created, location: board_path(@board, format: :json) }
    end
  end
  def edit
    selected_user_ids = @board.users.ids
    @selected_users, @unselected_users = \
      @board.account.users.active.alphabetically.includes(:identity).partition { |user| selected_user_ids.include? user.id }
  end
  def update
    @board.update! board_params
    @board.accesses.revise granted: grantees, revoked: revokees if grantees_changed?
    respond_to do |format|
      format.html do
        if @board.accessible_to?(Current.user)
          redirect_to edit_board_path(@board), notice: "Saved"
        else
          redirect_to root_path, notice: "Saved (you were removed from the board)"
        end
      end
      format.json { head :no_content }
    end
  end
  def destroy
    @board.destroy
    respond_to do |format|
      format.html { redirect_to root_path }
      format.json { head :no_content }
    end
  end
  private
    def set_board
      @board = Current.user.boards.find params[:id]
    end
    def ensure_permission_to_admin_board
      unless Current.user.can_administer_board?(@board)
        head :forbidden
      end
    end
    def grantees_changed?
      params.key?(:user_ids)
    end
    def show_filtered_cards
      @filter.board_ids = [ @board.id ]
      set_page_and_extract_portion_from @filter.cards
    end
    def show_columns
      cards = @board.cards.awaiting_triage.latest.with_golden_first.preloaded
      set_page_and_extract_portion_from cards
      fresh_when etag: [ @board, @page.records, @user_filtering, Current.account ]
    end
    def board_params
      params.expect(board: [ :name, :all_access, :auto_postpone_period, :public_description ])
    end
    def grantees
      @board.account.users.active.where id: grantee_ids
    end
    def revokees
      @board.users.where.not id: grantee_ids
    end
    def grantee_ids
      params.fetch :user_ids, []
    end
end

================
File: app/controllers/cards_controller.rb
================
class CardsController < ApplicationController
  include FilterScoped
  before_action :set_board, only: %i[ create ]
  before_action :set_card, only: %i[ show edit update destroy ]
  before_action :redirect_if_drafted, only: :show
  before_action :ensure_permission_to_administer_card, only: %i[ destroy ]
  def index
    set_page_and_extract_portion_from @filter.cards
  end
  def create
    respond_to do |format|
      format.html do
        card = Current.user.draft_new_card_in(@board)
        redirect_to card_draft_path(card)
      end
      format.json do
        card = @board.cards.create! card_params.merge(creator: Current.user, status: "published")
        head :created, location: card_path(card, format: :json)
      end
    end
  end
  def show
  end
  def edit
  end
  def update
    @card.update! card_params
    respond_to do |format|
      format.turbo_stream
      format.json { render :show }
    end
  end
  def destroy
    @card.destroy!
    respond_to do |format|
      format.html { redirect_to @card.board, notice: "Card deleted" }
      format.json { head :no_content }
    end
  end
  private
    def set_board
      @board = Current.user.boards.find params[:board_id]
    end
    def set_card
      @card = Current.user.accessible_cards.find_by!(number: params[:id])
    end
    def redirect_if_drafted
      redirect_to card_draft_path(@card) if @card.drafted?
    end
    def ensure_permission_to_administer_card
      head :forbidden unless Current.user.can_administer_card?(@card)
    end
    def card_params
      params.expect(card: [ :title, :description, :image, :created_at, :last_active_at ])
    end
end

================
File: app/controllers/events_controller.rb
================
class EventsController < ApplicationController
  include DayTimelinesScoped
  def index
    fresh_when @day_timeline
  end
end

================
File: app/controllers/filters_controller.rb
================
class FiltersController < ApplicationController
  before_action :set_filters
  def create
    @filter = Current.user.filters.remember filter_params
  end
  def destroy
    @filter = Current.user.filters.find(params[:id])
    @filter.destroy!
  end
  private
    def set_filters
      @filters = Current.user.filters
    end
    def filter_params
      Filter.normalize_params(params.permit(*Filter::PERMITTED_PARAMS))
    end
end

================
File: app/controllers/join_codes_controller.rb
================
class JoinCodesController < ApplicationController
  allow_unauthenticated_access
  rate_limit to: 10, within: 3.minutes, only: :create, with: -> { head :too_many_requests }
  before_action :set_join_code
  before_action :ensure_join_code_is_valid
  before_action :set_identity, only: :create
  layout "public"
  def new
  end
  def create
    @join_code.redeem_if { |account| @identity.join(account) }
    user = User.active.find_by!(account: @join_code.account, identity: @identity)
    if @identity == Current.identity && user.setup?
      redirect_to landing_url(script_name: @join_code.account.slug)
    elsif @identity == Current.identity
      redirect_to new_users_verification_url(script_name: @join_code.account.slug)
    else
      terminate_session if Current.identity
      redirect_to_session_magic_link \
        @identity.send_magic_link,
        return_to: new_users_verification_url(script_name: @join_code.account.slug)
    end
  end
  private
    def set_identity
      @identity = Identity.find_or_initialize_by(email_address: params.expect(:email_address))
      if @identity.new_record?
        if @identity.invalid?
          head :unprocessable_entity
        else
          @identity.save!
        end
      end
    end
    def set_join_code
      @join_code ||= Account::JoinCode.find_by(code: params.expect(:code), account: Current.account)
    end
    def ensure_join_code_is_valid
      if @join_code.nil?
        head :not_found
      elsif !@join_code.active?
        render :inactive, status: :gone
      end
    end
end

================
File: app/controllers/landings_controller.rb
================
class LandingsController < ApplicationController
  def show
    flash.keep(:welcome_letter)
    if Current.user.boards.one?
      redirect_to board_path(Current.user.boards.first)
    else
      redirect_to root_path
    end
  end
end

================
File: app/controllers/notifications_controller.rb
================
class NotificationsController < ApplicationController
  MAX_UNREAD_NOTIFICATIONS = 500
  MAX_UNREAD_NOTIFICATIONS_VIA_API = 100
  def index
    @unread = Current.user.notifications.unread.ordered.preloaded.limit(max_unread_notifications) unless current_page_param
    set_page_and_extract_portion_from Current.user.notifications.read.ordered.preloaded
    respond_to do |format|
      format.turbo_stream if current_page_param # Allows read-all action to side step pagination
      format.html
      format.json
    end
  end
  private
    def max_unread_notifications
      request.format.json? ? MAX_UNREAD_NOTIFICATIONS_VIA_API : MAX_UNREAD_NOTIFICATIONS
    end
end

================
File: app/controllers/pwa_controller.rb
================
class PwaController < ApplicationController
  disallow_account_scope
  skip_forgery_protection
  # We need a stable URL at the root, so we can't use the regular asset path here.
  def service_worker
  end
end

================
File: app/controllers/qr_codes_controller.rb
================
class QrCodesController < ApplicationController
  allow_unauthenticated_access
  def show
    expires_in 1.year, public: true
    qr_code_svg = RQRCode::QRCode
      .new(QrCodeLink.from_signed(params[:id]).url)
      .as_svg(viewbox: true, fill: :white, color: :black)
    render svg: qr_code_svg
  end
end

================
File: app/controllers/searches_controller.rb
================
class SearchesController < ApplicationController
  include Turbo::DriveHelper
  def show
    if card = Current.user.accessible_cards.find_by_id(params[:q])
      @card = card
    else
      set_page_and_extract_portion_from Current.user.search(params[:q])
      @recent_search_queries = Current.user.search_queries.order(updated_at: :desc).limit(10)
    end
  end
end

================
File: app/controllers/sessions_controller.rb
================
class SessionsController < ApplicationController
  disallow_account_scope
  require_unauthenticated_access except: :destroy
  rate_limit to: 10, within: 3.minutes, only: :create, with: :rate_limit_exceeded
  layout "public"
  def new
  end
  def create
    if identity = Identity.find_by(email_address: email_address)
      sign_in identity
    elsif Account.accepting_signups?
      sign_up
    else
      redirect_to_fake_session_magic_link email_address
    end
  end
  def destroy
    terminate_session
    respond_to do |format|
      format.html { redirect_to_logout_url }
      format.json { head :no_content }
    end
  end
  private
    def magic_link_from_sign_in_or_sign_up
      if identity = Identity.find_by_email_address(email_address)
        identity.send_magic_link
      else
        signup = Signup.new(email_address: email_address)
        signup.create_identity if signup.valid?(:identity_creation) && Account.accepting_signups?
      end
    end
    def email_address
      params.expect(:email_address)
    end
    def rate_limit_exceeded
      rate_limit_exceeded_message = "Try again later."
      respond_to do |format|
        format.html { redirect_to new_session_path, alert: rate_limit_exceeded_message }
        format.json { render json: { message: rate_limit_exceeded_message }, status: :too_many_requests }
      end
    end
    def sign_in(identity)
      redirect_to_session_magic_link identity.send_magic_link
    end
    def sign_up
      signup = Signup.new(email_address: email_address)
      if signup.valid?(:identity_creation)
        magic_link = signup.create_identity
        redirect_to_session_magic_link magic_link
      else
        respond_to do |format|
          format.html { redirect_to new_session_path, alert: "Something went wrong" }
          format.json { render json: { message: "Something went wrong" }, status: :unprocessable_entity }
        end
      end
    end
end

================
File: app/controllers/signups_controller.rb
================
class SignupsController < ApplicationController
  disallow_account_scope
  allow_unauthenticated_access
  rate_limit to: 10, within: 3.minutes, only: :create, with: -> { redirect_to new_signup_path, alert: "Try again later." }
  before_action :redirect_authenticated_user
  before_action :enforce_tenant_limit
  layout "public"
  def new
    @signup = Signup.new
  end
  def create
    signup = Signup.new(signup_params)
    if signup.valid?(:identity_creation)
      redirect_to_session_magic_link signup.create_identity
    else
      head :unprocessable_entity
    end
  end
  private
    def redirect_authenticated_user
      redirect_to new_signup_completion_path if authenticated?
    end
    def enforce_tenant_limit
      redirect_to new_session_url unless Account.accepting_signups?
    end
    def signup_params
      params.expect signup: :email_address
    end
end

================
File: app/controllers/tags_controller.rb
================
class TagsController < ApplicationController
  def index
    set_page_and_extract_portion_from Current.account.tags.alphabetically
  end
end

================
File: app/controllers/users_controller.rb
================
class UsersController < ApplicationController
  before_action :set_user, except: %i[ index ]
  before_action :ensure_permission_to_change_user, only: %i[ update destroy ]
  def index
    set_page_and_extract_portion_from Current.account.users.active.alphabetically
  end
  def show
  end
  def edit
  end
  def update
    if @user.update(user_params)
      respond_to do |format|
        format.html { redirect_to @user }
        format.json { head :no_content }
      end
    else
      respond_to do |format|
        format.html { render :edit, status: :unprocessable_entity }
        format.json { render json: @user.errors, status: :unprocessable_entity }
      end
    end
  end
  def destroy
    @user.deactivate
    respond_to do |format|
      format.html { redirect_to account_settings_path }
      format.json { head :no_content }
    end
  end
  private
    def set_user
      @user = Current.account.users.active.find(params[:id])
    end
    def ensure_permission_to_change_user
      head :forbidden unless Current.user.can_change?(@user)
    end
    def user_params
      params.expect(user: [ :name, :avatar ])
    end
end

================
File: app/controllers/webhooks_controller.rb
================
class WebhooksController < ApplicationController
  include BoardScoped
  before_action :ensure_admin
  before_action :set_webhook, except: %i[ index new create ]
  def index
    set_page_and_extract_portion_from @board.webhooks.ordered
  end
  def show
  end
  def new
    @webhook = @board.webhooks.new
  end
  def create
    webhook = @board.webhooks.create!(webhook_params)
    redirect_to webhook
  end
  def edit
  end
  def update
    @webhook.update!(webhook_params.except(:url))
    redirect_to @webhook
  end
  def destroy
    @webhook.destroy!
    redirect_to board_webhooks_path
  end
  private
    def set_webhook
      @webhook = @board.webhooks.find(params[:id])
    end
    def webhook_params
      params
        .expect(webhook: [ :name, :url, subscribed_actions: [] ])
        .merge(board_id: @board.id)
    end
end

================
File: app/helpers/my/menu_helper.rb
================
module My::MenuHelper
  def jump_field_tag
    text_field_tag :search, nil,
      type: "search",
      role: "combobox",
      placeholder: "Type to jump to a board, person, place, or tag",
      class: "input input--transparent txt-small",
      autofocus: true,
      autocorrect: "off",
      autocomplete: "off",
      aria: { activedescendant: "" },
      data: {
        "1p-ignore": "true",
        filter_target: "input",
        nav_section_expander_target: "input",
        navigable_list_target: "input",
        action: "input->filter#filter" }
  end
  def my_menu_board_item(board)
    my_menu_item("board", board) do
      link_to(tag.span(board.name, class: "overflow-ellipsis"), board, class: "popup__btn btn")
    end
  end
  def my_menu_tag_item(the_tag)
    my_menu_item("tag", tag) do
      link_to(tag.span(class: "overflow-ellipsis") do
        tag.span("##{the_tag.title}", class: "visually-hidden") + the_tag.title
      end, cards_path(tag_ids: [ the_tag ]), class: "popup__btn btn", title: "##{the_tag.title}")
    end
  end
  def my_menu_user_item(user)
    my_menu_item("person", user) do
      link_to(tag.span(user.name, class: "overflow-ellipsis"), user, class: "popup__btn btn")
    end
  end
  def my_menu_filter_item(filter)
    my_menu_item("bookmark", filter) do
      link_to(cards_path(filter_id: filter.id), class: "popup__btn btn") do
        tag.div(class: "txt-tight-lines min-width txt-small overflow-ellipsis") do
          tag.div(tag.strong(filter.boards_label)) +
          tag.div(filter.summary, class: "txt-capitalize")
        end
      end
    end
  end
  def my_menu_item(item, record)
    tag.li(class: "popup__item", data: { filter_target: "item", navigable_list_target: "item", id: "filter-#{item}-#{record.id}" }) do
      icon_tag(item, class: "popup__icon") + yield
    end
  end
end

================
File: app/helpers/accesses_helper.rb
================
module AccessesHelper
  def access_menu_tag(board, **options, &)
    tag.menu class: [ options[:class], { "toggler--toggled": board.all_access? } ], data: {
      controller: "filter toggle-class navigable-list",
      action: "keydown->navigable-list#navigate filter:changed->navigable-list#reset",
      navigable_list_focus_on_selection_value: true,
      navigable_list_actionable_items_value: true,
      toggle_class_toggle_class: "toggler--toggled" }, &
  end
  def access_toggles_for(users, selected:, disabled: false)
    render partial: "boards/access_toggle",
      collection: users, as: :user,
      locals: { selected: selected, disabled: disabled },
      cached: ->(user) { [ user, selected, disabled ] }
  end
  def access_involvement_advance_button(board, user, show_watchers: true, icon_only: false)
    access = board.access_for(user)
    turbo_frame_tag dom_id(board, :involvement_button) do
      concat board_watchers_list(board) if show_watchers
      concat involvement_button(board, access, show_watchers, icon_only)
    end
  end
  def board_watchers_list(board)
    watchers = board.watchers.with_avatars.load
    displayed_watchers = watchers.first(8)
    overflow_count = watchers.size - 8
    tag.div(class: "divider divider--fade") do
      tag.strong(watchers.any? ? "Watching for new cards" : "No one is watching for new cards", class: "txt-uppercase")
    end +
    tag.div(avatar_tags(displayed_watchers), class: "board-tools__watching") do
      tag.div(data: { controller: "dialog", action: "keydown.esc->dialog#close click@document->dialog#closeOnClickOutside" }) do
        tag.button("+#{overflow_count}", class: "overflow-count btn btn--circle borderless", data: { action: "dialog#open" }, aria: { label: "Show #{overflow_count} more watchers" }) +
        tag.dialog(avatar_tags(watchers), class: "board-tools__watching-dialog dialog panel", data: { dialog_target: "dialog" }, aria: { hidden: "true" })
      end if overflow_count > 0
    end
  end
  def involvement_button(board, access, show_watchers, icon_only)
    label_text = access.access_only? ? "Watch this" : "Stop watching"
    button_to(
      board_involvement_path(board), method: :put,
      params: { show_watchers: show_watchers, involvement: next_involvement(access.involvement), icon_only: icon_only },
      aria: { labelledby: dom_id(board, :involvement_label) },
      title: (label_text if icon_only),
      class: class_names("btn", { "btn--reversed": access.watching? && icon_only }),
      data: !icon_only && { bridge__overflow_menu_target: "item", bridge_title: label_text }) do
        icon_tag("notification-bell-#{icon_only ? 'reverse-' : nil}#{access.involvement.dasherize}") +
        tag.span(label_text, class: class_names("txt-nowrap txt-uppercase", "for-screen-reader": icon_only), id: dom_id(board, :involvement_label))
    end
  end
  private
    def next_involvement(involvement)
      order = %w[ watching access_only ]
      order[(order.index(involvement.to_s) + 1) % order.size]
    end
end

================
File: app/helpers/application_helper.rb
================
module ApplicationHelper
  def page_title_tag
    account_name = if Current.account && Current.session&.identity&.users&.many?
      Current.account&.name
    end
    tag.title [ @page_title, account_name, "Fizzy" ].compact.join(" | ")
  end
  def icon_tag(name, **options)
    tag.span class: class_names("icon icon--#{name}", options.delete(:class)), "aria-hidden": true, **options
  end
  def back_link_to(label, url, action, **options)
    link_to url, class: "btn btn--back btn--circle-mobile", data: { controller: "hotkey", action: action }, **options do
      icon_tag("arrow-left") + tag.strong("Back to #{label}", class: "overflow-ellipsis") + tag.kbd("ESC", class: "txt-x-small hide-on-touch").html_safe
    end
  end
end

================
File: app/helpers/avatars_helper.rb
================
require "zlib"
module AvatarsHelper
  AVATAR_COLORS = %w[
    #AF2E1B #CC6324 #3B4B59 #BFA07A #ED8008 #ED3F1C #BF1B1B #736B1E #D07B53
    #736356 #AD1D1D #BF7C2A #C09C6F #698F9C #7C956B #5D618F #3B3633 #67695E
  ]
  def avatar_background_color(user)
    AVATAR_COLORS[Zlib.crc32(user.to_param) % AVATAR_COLORS.size]
  end
  def avatar_tag(user, hidden_for_screen_reader: false, **options)
    link_to user_path(user), class: class_names("avatar btn btn--circle", options.delete(:class)), data: { turbo_frame: "_top" },
      aria: { hidden: hidden_for_screen_reader, label: user.name },
      tabindex: hidden_for_screen_reader ? -1 : nil,
      **options do
      avatar_image_tag(user)
    end
  end
  def avatar_tags(users, **options)
    users.collect { avatar_tag(it, **options) }.join.html_safe
  end
  def mail_avatar_tag(user, size: 48, **options)
    if user.avatar.attached?
      image_tag user_avatar_url(user), alt: user.name, class: "avatar", size: size, **options
    else
      tag.span class: "avatar", style: "background-color: #{avatar_background_color(user)};" do
        user.initials
      end
    end
  end
  def avatar_preview_tag(user, hidden_for_screen_reader: false, **options)
    tag.span class: class_names("avatar", options.delete(:class)),
      aria: { hidden: hidden_for_screen_reader, label: user.name },
      tabindex: hidden_for_screen_reader ? -1 : nil do
      avatar_image_tag(user, **options)
    end
  end
  def avatar_image_tag(user, **options)
    image_tag user_avatar_path(user, script_name: user.account.slug), aria: { hidden: "true" }, size: 48, title: user.name, **options
  end
end

================
File: app/helpers/boards_helper.rb
================
module BoardsHelper
  def link_back_to_board(board)
    back_link_to board.name, board, "keydown.left@document->hotkey#click keydown.esc@document->hotkey#click click->turbo-navigation#backIfSamePath"
  end
  def link_to_edit_board(board)
    link_to edit_board_path(board), class: "btn btn--circle-mobile",
      data: { controller: "tooltip", bridge__overflow_menu_target: "item", bridge_title: "Board settings" } do
      icon_tag("settings") + tag.span("Settings for #{board.name}", class: "for-screen-reader")
    end
  end
end

================
File: app/helpers/bridge_helper.rb
================
module BridgeHelper
  def bridge_icon(name)
    asset_url("#{name}.svg")
  end
end

================
File: app/helpers/cards_helper.rb
================
module CardsHelper
  def card_article_tag(card, id: dom_id(card, :article), data: {}, **options, &block)
    classes = [
      options.delete(:class),
      ("golden-effect" if card.golden?),
      ("card--postponed" if card.postponed?),
      ("card--active" if card.active?)
    ].compact.join(" ")
    data[:drag_and_drop_top] = true if card.golden? && !card.closed? && !card.postponed?
    tag.article \
      id: id,
      style: "--card-color: #{card.color}; view-transition-name: #{id}",
      class: classes,
      data: data,
      **options,
      &block
  end
  def card_title_tag(card)
    title = [
      card.title,
      "added by #{card.creator.name}",
      "in #{card.board.name}"
    ]
    title << "assigned to #{card.assignees.map(&:name).to_sentence}" if card.assignees.any?
    title.join(" ")
  end
  def card_drafted_or_added(card)
    card.drafted? ? "Drafted" : "Added"
  end
  def card_social_tags(card)
    tag.meta(property: "og:title", content: "#{card.title} | #{card.board.name}") +
    tag.meta(property: "og:description", content: format_excerpt(card&.description, length: 200)) +
    tag.meta(property: "og:image", content: card.image.attached? ? "#{request.base_url}#{url_for(card.image)}" : "#{request.base_url}/opengraph.png") +
    tag.meta(property: "og:url", content: card_url(card))
  end
  def button_to_remove_card_image(card)
    button_to(card_image_path(card), method: :delete, class: "btn", data: { controller: "tooltip", action: "dialog#close" }) do
      icon_tag("trash") + tag.span("Remove background image", class: "for-screen-reader")
    end
  end
end

================
File: app/helpers/clipboard_helper.rb
================
module ClipboardHelper
  def button_to_copy_to_clipboard(url, &)
    tag.button class: "btn", data: {
      controller: "copy-to-clipboard tooltip", action: "copy-to-clipboard#copy",
      copy_to_clipboard_success_class: "btn--success", copy_to_clipboard_content_value: url
    }, &
  end
end

================
File: app/helpers/columns_helper.rb
================
module ColumnsHelper
  def button_to_set_column(card, column)
    button_to \
      tag.span(column.name, class: "overflow-ellipsis"),
      card_triage_path(card, column_id: column),
      method: :post,
      class: [ "card__column-name btn", { "card__column-name--current": column == card.column && card.open? } ],
      disabled: column == card.column,
      style: "--column-color: #{column.color}",
      form_class: "flex gap-half",
      data: { turbo_frame: "_top", scroll_to_target: column == card.column && card.open? ? "target" : nil }
  end
  def column_tag(id:, name:, drop_url:, collapsed: true, selected: nil, card_color: "var(--color-card-default)", data: {}, **properties, &block)
    classes = token_list("cards", properties.delete(:class), "is-collapsed": collapsed, "is-expanded": !collapsed)
    hotkeys_disabled = data[:card_hotkeys_disabled]
    data = {
      drag_and_drop_target: "container",
      navigable_list_target: "item",
      column_name: name,
      drag_and_drop_url: drop_url,
      drag_and_drop_css_variable_name: "--card-color",
      drag_and_drop_css_variable_value: card_color
    }.merge(data)
    data[:action] = token_list(
      "turbo:before-morph-attribute->collapsible-columns#preventToggle",
      "focus->navigable-list#select",
      data.delete(:action)
    )
    tag.section(id: id, class: classes, tabindex: "0", "aria-selected": selected, data: data, **properties) do
      tag.div(class: "cards__transition-container", data: {
        controller: "navigable-list css-variable-counter",
        css_variable_counter_property_name_value: "--card-count",
        navigable_list_supports_horizontal_navigation_value: "false",
        navigable_list_prevent_handled_keys_value: "true",
        navigable_list_auto_select_value: "false",
        navigable_list_actionable_items_value: "true",
        navigable_list_only_act_on_focused_items_value: "true",
        card_hotkeys_disabled: hotkeys_disabled,
        action: "keydown->navigable-list#navigate"
      }, &block)
    end
  end
  def column_frame_tag(id, src: nil, data: {}, **options, &block)
    data = data.with_defaults \
      drag_and_drop_refresh: true,
      controller: "frame",
      action: "turbo:before-frame-render->frame#morphRender turbo:before-morph-element->frame#morphReload"
    options[:refresh] = :morph if src.present?
    turbo_frame_tag(id, src: src, data: data, **options, &block)
  end
end

================
File: app/helpers/comments_helper.rb
================
module CommentsHelper
  def new_comment_placeholder(card)
    if card.creator == Current.user && card.comments.empty?
      "Next, add some notes, context, pictures, or video about this"
    else
      "Type your comment"
    end
  end
end

================
File: app/helpers/emoji_helper.rb
================
module EmojiHelper
  REACTIONS = {
    "" => "Clapping",
    "" => "Thumbs up",
    "" => "Hands raised in celebration",
    "" => "Flexed bicep",
    "" => "Sign of the horns",
    "" => "Raised fist",
    "" => "Sparkles",
    "" => "Red heart",
    "" => "100 points",
    "" => "Party popper",
    "" => "Face with starry eyes",
    "" => "Partying face",
    "" => "Smiling face with flush cheeks",
    "" => "Grinning face",
    "" => "Face with tears of joy",
    "" => "Grinning face with sweat drop",
    "" => "Smiling face with sunglasses",
    "" => "Winking face",
    "" => "Winking face with stuck out tongue",
    "" => "Grimacing face",
    "" => "Surprised face with open mouth",
    "" => "Flushed face",
    "" => "Thinking face",
    "" => "Unamused face",
    "" => "Crying face",
    "" => "Loudly crying face",
    "" => "Face screaming in fear",
    "" => "Eyes",
    "" => "Hands pressed together",
    "" => "Pile of poop",
    "" => "Thumbs down",
    "" => "Peace",
    "" => "Finger pointing left",
    "" => "Finger pointing Up",
    "" => "Raised hand",
    "" => "Waving hand",
    "" => "Sun",
    "" => "Moon",
    "" => "Collision",
    "" => "Fire",
    "" => "Birthday cake",
    "" => "Fork and knife",
    "" => "Money bag",
    "" => "Gold medal",
    "" => "Red flashing light",
    "" => "Light bulb",
    "" => "Hammer and wrench",
    "" => "Chart with upward trend",
    "" => "Check mark",
    "" => "Public address loudspeaker"
  }
end

================
File: app/helpers/entropy_helper.rb
================
module EntropyHelper
  def entropy_auto_close_options
    [ 3, 7, 30, 90, 365, 11 ]
  end
  def entropy_bubble_options_for(card)
    {
      daysBeforeReminder: card.entropy.days_before_reminder,
      closesAt: card.entropy.auto_clean_at.iso8601,
      action: "Closes"
    }
  end
  def stalled_bubble_options_for(card)
    if card.last_activity_spike_at
      {
        stalledAfterDays: card.entropy.days_before_reminder,
        lastActivitySpikeAt: card.last_activity_spike_at.iso8601,
        updatedAt: card.updated_at.iso8601,
        action: "Stalled"
      }
    end
  end
end

================
File: app/helpers/events_helper.rb
================
module EventsHelper
  def event_action_icon(event)
    case event.action
    when "card_assigned"
      "assigned"
    when "card_unassigned"
      "minus"
    when "comment_created"
      "comment"
    when "card_title_changed"
      "rename"
    when "card_board_changed", "card_triaged", "card_postponed", "card_auto_postponed"
      "move"
    else
      "person"
    end
  end
  def events_at_hour_container(column, hour, &block)
    tag.div class: "events__time-block", style: "grid-area: #{25 - hour}/#{column.index}", &block
  end
end

================
File: app/helpers/excerpt_helper.rb
================
module ExcerptHelper
  def format_excerpt(content, length: 200)
    return "" if content.blank?
    text = content.respond_to?(:to_plain_text) ? content.to_plain_text : content.to_s
    text = text.gsub(/^>\s*(.*)$/m, '> \1')
    text = text.gsub(/^\s*[-+]\s*(.*)$/m, ' \1')
    text = text.gsub(/^\d+\.\s*(.*)$/m) { |m| m }
    text = text.gsub(/\s+/, " ").strip
    text.truncate(length)
  end
end

================
File: app/helpers/filters_helper.rb
================
module FiltersHelper
  def filter_chip_tag(text, params)
    link_to cards_path(params), class: "btn txt-x-small btn--remove fill-selected flex-inline" do
      concat tag.span(text)
      concat icon_tag("close")
    end
  end
  def filter_hidden_field_tag(key, value)
    name = params[key].is_a?(Array) ? "#{key}[]" : key
    hidden_field_tag name, value, id: nil
  end
  def filter_selected_boards_title(user_filtering)
    user_filtering.selected_board_titles.collect { tag.strong it }.to_sentence.html_safe
  end
  def filter_place_menu_item(path, label, icon, new_window: false, current: false, turbo: true)
    link_to_params = {}
    link_to_params.merge!({ target: "_blank" }) if new_window
    link_to_params.merge!({ data: { turbo: false } }) unless turbo
    tag.li class: "popup__item", id: "filter-place-#{label.parameterize}", data: { filter_target: "item", navigable_list_target: "item" }, aria: { checked: current } do
      concat icon_tag(icon, class: "popup__icon")
      concat(link_to(path, link_to_params.merge(class: "popup__btn btn"), data: { turbo: turbo }) do
        concat tag.span(label, class: "overflow-ellipsis")
        concat icon_tag("check", class: "checked flex-item-justify-end", "aria-hidden": true)
      end)
    end
  end
  def filter_dialog(label, &block)
    tag.dialog class: "margin-block-start-half popup panel flex-column align-start gap-half fill-white shadow txt-small", data: {
      action: "turbo:before-cache@document->dialog#close keydown->navigable-list#navigate filter:changed->navigable-list#reset toggle->filter#filter",
      aria: { label: label, aria_description: label },
      controller: "navigable-list",
      dialog_target: "dialog",
      navigable_list_focus_on_selection_value: false,
      navigable_list_actionable_items_value: true
    }, &block
  end
  def filter_title(title)
    tag.strong title, class: "popup__title pad-inline-half", tabindex: "-1", data: { dialog_target: "focusTouch" }
  end
  def collapsible_nav_section(title, **properties, &block)
    tag.details class: "nav__section popup__section", data: { action: "toggle->nav-section-expander#toggle", nav_section_expander_target: "section", nav_section_expander_key_value: title.parameterize }, open: true, **properties do
      concat(tag.summary(class: "popup__section-title") do
        concat icon_tag "caret-down"
        concat title
      end)
      concat(tag.ul(class: "popup__list") do
        capture(&block)
      end)
    end
  end
  def filter_hotkey_link(title, path, key, icon)
    link_to path, class: "popup__item btn borderless", id: "filter-hotkey-#{key}", role: "listitem", data: { filter_target: "item", navigable_list_target: "item", controller: "hotkey", action: "keydown.#{key}@document->hotkey#click keydown.shift+#{key}@document->hotkey#click" } do
      concat icon_tag(icon)
      concat tag.span(title.html_safe)
      concat tag.kbd(key)
    end
  end
  def sorted_by_label(sort_value)
    case sort_value
    when "newest"
      "Newest to oldest"
    when "oldest"
      "Oldest to newest"
    when "latest"
      "Recently updated"
    else
      sort_value.humanize
    end
  end
end

================
File: app/helpers/forms_helper.rb
================
module FormsHelper
  def auto_submit_form_with(**attributes, &)
    data = attributes.delete(:data) || {}
    data[:controller] = "auto-submit #{data[:controller]}".strip
    if block_given?
      form_with **attributes, data: data, &
    else
      form_with(**attributes, data: data) { }
    end
  end
  def bridged_form_with(**attributes, &)
    data = attributes.delete(:data) || {}
    controllers = [ data[:controller], "bridge--form" ].compact.join(" ").strip
    actions = [
      data[:action],
      "turbo:submit-start->bridge--form#submitStart",
      "turbo:submit-end->bridge--form#submitEnd"
    ].compact.join(" ").strip
    data[:controller] = controllers
    data[:action] = actions
    if block_given?
      form_with **attributes, data: data, &
    else
      form_with(**attributes, data: data) { }
    end
  end
end

================
File: app/helpers/hotkeys_helper.rb
================
module HotkeysHelper
  # Pass in an array of chorded keys, e.g. ["ctrl", "shift", "J"]
  def hotkey_label(hotkey)
    hotkey.map do |key|
      if key == "ctrl" && platform.mac?
        ""
      elsif key == "enter"
        platform.mac? ? "return" : "enter"
      else
        key
      end.capitalize
    end.join("+").gsub(/\+/, "")
  end
end

================
File: app/helpers/html_helper.rb
================
module HtmlHelper
  def format_html(html)
    Loofah::HTML5::DocumentFragment.parse(html).scrub!(AutoLinkScrubber.new).to_html.html_safe
  end
end

================
File: app/helpers/login_helper.rb
================
module LoginHelper
  def login_url
    main_app.new_session_path(script_name: nil)
  end
  def logout_url
    main_app.new_session_path
  end
  def redirect_to_login_url
    redirect_to login_url, allow_other_host: true
  end
  def redirect_to_logout_url
    redirect_to logout_url, allow_other_host: true
  end
end

================
File: app/helpers/messages_helper.rb
================
module MessagesHelper
  def messages_tag(card, &)
    turbo_frame_tag dom_id(card, :messages),
      class: "comments gap center",
      style: "--card-color: #{card.color}",
      role: "group",
      aria: { label: "Messages" },
      data: { controller: "toggle-class", toggle_class_toggle_class: "comments--system-expanded" }, &
  end
end

================
File: app/helpers/notifications_helper.rb
================
module NotificationsHelper
  def event_notification_title(event)
    case event_notification_action(event)
    when "comment_created" then "RE: #{card_notification_title(event.eventable.card)}"
    else card_notification_title(event.eventable)
    end
  end
  def event_notification_body(event)
    creator = event.creator.name
    case event_notification_action(event)
    when "card_assigned" then "Assigned to #{event.assignees.none? ? "self" : event.assignees.pluck(:name).to_sentence}"
    when "card_unassigned" then "Unassigned by #{creator}"
    when "card_published" then "Added by #{creator}"
    when "card_closed" then "Moved to Done by #{creator}"
    when "card_reopened" then "Reopened by #{creator}"
    when "card_postponed" then "Moved to Not Now by #{creator}"
    when "card_auto_postponed" then "Moved to Not Now due to inactivity"
    when "card_title_changed" then "Renamed by #{creator}"
    when "card_board_changed" then "Moved by #{creator}"
    when "card_triaged" then "Moved to #{event.particulars.dig("particulars", "column")} by #{creator}"
    when "card_sent_back_to_triage" then "Moved back to Maybe? by #{creator}"
    when "comment_created" then comment_notification_body(event)
    else creator
    end
  end
  def notification_tag(notification, &)
    tag.div id: dom_id(notification), class: "tray__item tray__item--notification", data: {
      navigable_list_target: "item",
      notifications_tray_target: "notification",
      card_id: notification.card.id,
      timestamp: notification.created_at.to_i
    } do
      link_to(notification,
        class: [ "card card--notification", { "card--closed": notification.card.closed? }, { "unread": !notification.read? } ],
        data: { turbo_frame: "_top", badge_target: "unread", action: "badge#update dialog#close" },
        style: { "--card-color:": notification.card.color },
        &)
    end
  end
  def notification_toggle_read_button(notification, url:)
    if notification.read?
      button_to url,
          method: :delete,
          class: "card__notification-unread-indicator btn btn--circle borderless",
          title: "Mark as unread",
          data: { action: "form#submit:stop badge#update:stop", form_target: "submit" },
          form: { data: { controller: "form" } } do
        concat(icon_tag("unseen"))
      end
    else
      button_to url,
          class: "card__notification-unread-indicator btn btn--circle borderless",
          title: "Mark as read",
          data: { action: "form#submit:stop badge#update:stop", form_target: "submit" },
          form: { data: { controller: "form" } } do
        concat(icon_tag("remove"))
        concat(tag.span("1", class: "badge-count", data: { group_count: "" }))
      end
    end
  end
  def notifications_next_page_link(page)
    unless @page.last?
      tag.div id: "next_page", data: { controller: "fetch-on-visible", fetch_on_visible_url_value: notifications_path(page: @page.next_param) }
    end
  end
  def bundle_email_frequency_options_for(settings)
    options_for_select([
      [ "Never", "never" ],
      [ "Every few hours", "every_few_hours" ],
      [ "Every day", "daily" ],
      [ "Every week", "weekly" ]
    ], settings.bundle_email_frequency)
  end
  private
    def event_notification_action(event)
      if event.action.card_published? && event.eventable.assigned_to?(event.creator)
        "card_assigned"
      else
        event.action
      end
    end
    def comment_notification_body(event)
      comment = event.eventable
      comment.body.to_plain_text.truncate(200)
    end
    def card_notification_title(card)
      card.title.presence || "Card #{card.number}"
    end
end

================
File: app/helpers/pagination_helper.rb
================
module PaginationHelper
  def pagination_frame_tag(namespace, page, data: {}, **attributes, &)
    turbo_frame_tag pagination_frame_id_for(namespace, page.number), data: { timeline_target: "frame", **data }, role: "presentation", **attributes, &
  end
  def link_to_next_page(namespace, page, activate_when_observed: false, label: default_pagination_label(activate_when_observed), data: {}, **attributes)
    if page.before_last? && !params[:previous]
      attributes[:class] = class_names(attributes[:class], "btn txt-small center-block center": !activate_when_observed)
      pagination_link(namespace, page.number + 1, label: label, activate_when_observed: activate_when_observed, data: data, **attributes)
    end
  end
  def pagination_link(namespace, page_number, activate_when_observed: false, label: default_pagination_label(activate_when_observed), url_params: {}, data: {}, **attributes)
    link_to label, url_for(params.permit!.to_h.merge(page: page_number, **url_params)),
      "aria-label": "Load page #{page_number}",
      id: "#{namespace}-pagination-link-#{page_number}",
      class: class_names(attributes.delete(:class), "pagination-link", { "pagination-link--active-when-observed" => activate_when_observed }),
      data: {
        frame: pagination_frame_id_for(namespace, page_number),
        pagination_target: "paginationLink",
        action: ("click->pagination#loadPage:prevent" unless activate_when_observed),
        **data
      },
      **attributes
  end
  def pagination_frame_id_for(namespace, page_number)
    "#{namespace}-pagination-contents-#{page_number}"
  end
  def with_manual_pagination(name, page, **properties)
    pagination_list name, **properties do
      concat(pagination_frame_tag(name, page) do
        yield
        concat link_to_next_page(name, page)
      end)
    end
  end
  def with_automatic_pagination(name, page, **properties)
    pagination_list name, paginate_on_scroll: true, **properties do
      concat(pagination_frame_tag(name, page) do
        yield
        concat link_to_next_page(name, page, activate_when_observed: true)
      end)
    end
  end
  def day_timeline_pagination_frame_tag(day_timeline, &)
    turbo_frame_tag day_timeline_pagination_frame_id_for(day_timeline.day), data: { timeline_target: "frame" }, role: "presentation", refresh: :morph, &
  end
  def day_timeline_pagination_frame_id_for(day)
    "day-timeline-pagination-contents-#{day.strftime("%Y-%m-%d")}"
  end
  def day_timeline_pagination_link(day_timeline, filter)
    if day_timeline.next_day
      link_to "Load more", events_days_path(day: day_timeline.next_day.strftime("%Y-%m-%d"), **filter.as_params),
        class: "day-timeline-pagination-link", data: { frame: day_timeline_pagination_frame_id_for(day_timeline.next_day), pagination_target: "paginationLink" }
    end
  end
  private
    def pagination_list(name, tag_element: :div, paginate_on_scroll: false, **properties, &block)
      classes = properties.delete(:class)
      properties[:id] ||= "#{name}-pagination-list"
      tag.public_send tag_element,
        class: token_list(name, "display-contents", classes),
        data: { controller: "pagination", pagination_paginate_on_intersection_value: paginate_on_scroll },
        **properties,
        &block
    end
    def default_pagination_label(activate_when_observed)
      "Load more"
    end
end

================
File: app/helpers/qr_codes_helper.rb
================
module QrCodesHelper
  def qr_code_image(url)
    qr_code_link = QrCodeLink.new(url)
    image_tag qr_code_path(qr_code_link.signed), class: "qr-code center", alt: "QR Code"
  end
end

================
File: app/helpers/reactions_helper.rb
================
module ReactionsHelper
  def reaction_path_prefix_for(reactable)
    case reactable
    when Card then [ reactable ]
    when Comment then [ reactable.card, reactable ]
    else
      raise ArgumentError, "Unknown reactable type: #{reactable.class}"
    end
  end
end

================
File: app/helpers/rich_text_helper.rb
================
module RichTextHelper
  def mentions_prompt(board)
    content_tag "lexxy-prompt", "", trigger: "@", src: prompts_board_users_path(board), name: "mention"
  end
  def global_mentions_prompt
    content_tag "lexxy-prompt", "", trigger: "@", src: prompts_users_path, name: "mention"
  end
  def tags_prompt
    content_tag "lexxy-prompt", "", trigger: "#", src: prompts_tags_path, name: "tag"
  end
  def cards_prompt
    content_tag "lexxy-prompt", "", trigger: "#", src: prompts_cards_path, name: "card", "insert-editable-text": true, "remote-filtering": true, "supports-space-in-searches": true
  end
  def code_language_picker
    content_tag "lexxy-code-language-picker"
  end
  def general_prompts(board)
    safe_join([ mentions_prompt(board), cards_prompt, code_language_picker ])
  end
end

================
File: app/helpers/tenanting_helper.rb
================
module TenantingHelper
  def tenanted_action_cable_meta_tag
    tag "meta",
        name: "action-cable-url",
        content: "#{request.script_name}#{ActionCable.server.config.mount_path}"
  end
end

================
File: app/helpers/time_helper.rb
================
module TimeHelper
  def local_datetime_tag(datetime, style: :time, **attributes)
    # Render empty space to ensure it takes height until the local time is loaded via JS
    tag.time "&nbsp;".html_safe, **attributes, datetime: datetime.to_i, data: { local_time_target: style, action: "turbo:morph-element->local-time#refreshTarget" }
  end
end

================
File: app/helpers/users_helper.rb
================
module UsersHelper
  def role_display_name(user)
    case user.role
    when "admin" then "Administrator"
    else user.role.titleize
    end
  end
end

================
File: app/helpers/webhooks_helper.rb
================
module WebhooksHelper
  ACTION_LABELS = {
    card_published: "Card added",
    card_title_changed: "Card title changed",
    card_board_changed: "Card board changed",
    comment_created: "Comment added",
    card_assigned: "Card assigned",
    card_unassigned: "Card unassigned",
    card_triaged: "Card column changed",
    card_closed: "Card moved to Done",
    card_reopened: "Card reopened",
    card_postponed: "Card moved to Not Now",
    card_auto_postponed: "Card moved to Not Now due to inactivity",
    card_sent_back_to_triage: "Card moved back to Maybe?"
  }.with_indifferent_access.freeze
  def webhook_action_options(actions = Webhook::PERMITTED_ACTIONS)
    ACTION_LABELS.select { |key, _| actions.include?(key.to_s) }
  end
  def webhook_action_label(action)
    ACTION_LABELS[action] || action.to_s.humanize
  end
  def link_to_webhooks(board, &)
    link_to board_webhooks_path(board_id: board),
        class: [ "btn btn--circle-mobile", { "btn--reversed": board.webhooks.any? } ],
        data: { controller: "tooltip", bridge__overflow_menu_target: "item", bridge_title: "Webhooks" } do
      icon_tag("world") + tag.span("Webhooks", class: "for-screen-reader")
    end
  end
end

================
File: app/javascript/controllers/bridge/buttons_controller.js
================
import { BridgeComponent } from "@hotwired/hotwire-native-bridge"
import { BridgeElement } from "@hotwired/hotwire-native-bridge"
export default class extends BridgeComponent {
  static component = "buttons"
  static targets = [ "button" ]
  buttonTargetConnected() {
    this.notifyBridgeOfConnect()
  }
  buttonTargetDisconnected() {
    if (!this.#isControllerTearingDown()) {
      this.notifyBridgeOfConnect()
    }
  }
  notifyBridgeOfConnect() {
    const buttons = this.#enabledButtonTargets
      .map((target, index) => {
        const element = new BridgeElement(target)
        return { ...element.getButton(), index }
    })
    this.send("connect", { buttons }, message => {
      this.#clickButton(message)
    })
  }
  #clickButton(message) {
    const selectedIndex = message.data.selectedIndex
    this.#enabledButtonTargets[selectedIndex].click()
  }
  get #enabledButtonTargets() {
    return this.buttonTargets
      .filter(target => !target.closest("[data-bridge-disabled]"))
  }
  #isControllerTearingDown() {
    return !document.body.contains(this.element)
  }
}

================
File: app/javascript/controllers/bridge/form_controller.js
================
import { BridgeComponent } from "@hotwired/hotwire-native-bridge"
import { BridgeElement } from "@hotwired/hotwire-native-bridge"
export default class extends BridgeComponent {
  static component = "form"
  static targets = [ "submit", "cancel" ]
  static values = { submitTitle: String }
  submitTargetConnected() {
    this.notifyBridgeOfConnect()
    this.#observeSubmitTarget()
  }
  submitTargetDisconnected() {
    this.notifyBridgeOfDisonnect()
    this.submitObserver?.disconnect()
  }
  notifyBridgeOfConnect() {
    const submitElement = new BridgeElement(this.submitTarget)
    const cancelElement = this.hasCancelTarget ? new BridgeElement(this.cancelTarget) : null
    const submitButton = { title: submitElement.title }
    const cancelButton = cancelElement ? { title: cancelElement.title } : null
    this.send("connect", { submitButton, cancelButton }, message => this.receive(message))
  }
  receive(message) {
    switch (message.event) {
      case "submit":
        this.submitTarget.click()
        break
      case "cancel":
        this.cancelTarget.click()
        break
    }
  }
  notifyBridgeOfDisonnect() {
    this.send("disconnect")
  }
  submitStart() {
    this.send("submitStart")
  }
  submitEnd() {
    this.send("submitEnd")
  }
  #observeSubmitTarget() {
    this.submitObserver = new MutationObserver(() => {
      this.send(this.submitTarget.disabled ? "submitDisabled" : "submitEnabled")
    })
    this.submitObserver.observe(this.submitTarget, {
      attributes: true,
      attributeFilter: [ "disabled" ]
    })
  }
}

================
File: app/javascript/controllers/bridge/insets_controller.js
================
import { BridgeComponent } from "@hotwired/hotwire-native-bridge"
// Bridge component to control custom safe-area insets from native apps.
// Sets CSS variables --injected-safe-inset-(top|right|bottom|left).
export default class extends BridgeComponent {
  static component = "insets"
  connect() {
    super.connect()
    this.notifyBridgeOfConnect()
  }
  disconnect() {
    super.disconnect()
    this.send("disconnect")
  }
  notifyBridgeOfConnect() {
    this.send("connect", {}, message => {
      this.#setInsets(message.data)
    })
  }
  #setInsets({ top, right, bottom, left }) {
    const root = document.documentElement.style
    root.setProperty("--injected-safe-inset-top", `${top}px`)
    root.setProperty("--injected-safe-inset-right", `${right}px`)
    root.setProperty("--injected-safe-inset-bottom", `${bottom}px`)
    root.setProperty("--injected-safe-inset-left", `${left}px`)
  }
}

================
File: app/javascript/controllers/bridge/overflow_menu_controller.js
================
import { BridgeComponent } from "@hotwired/hotwire-native-bridge"
import { BridgeElement } from "@hotwired/hotwire-native-bridge"
export default class extends BridgeComponent {
  static component = "overflow-menu"
  static targets = [ "item" ]
  itemTargetConnected() {
    this.notifyBridgeOfConnect()
  }
  itemTargetDisconnected() {
    if (!this.#isControllerTearingDown) {
      this.notifyBridgeOfConnect()
    }
  }
  notifyBridgeOfConnect() {
    const items = this.#enabledItemTargets
      .map((target, index) => {
        const element = new BridgeElement(target)
        return { title: element.title, index }
      })
    this.send("connect", { items }, message => {
      this.#clickItem(message)
    })
  }
  #clickItem(message) {
    const selectedIndex = message.data.selectedIndex
    this.#enabledItemTargets[selectedIndex].click()
  }
  get #enabledItemTargets() {
    return this.itemTargets
      .filter(target => !target.closest("[data-bridge-disabled]"))
  }
  #isControllerTearingDown() {
    return !document.body.contains(this.element)
  }
}

================
File: app/javascript/controllers/bridge/text_size_controller.js
================
import { BridgeComponent } from "@hotwired/hotwire-native-bridge"
export default class extends BridgeComponent {
  static component = "text-size"
  connect() {
    super.connect()
    this.notifyBridgeOfConnect()
  }
  disconnect() {
    super.disconnect()
    this.send("disconnect")
  }
  notifyBridgeOfConnect() {
    this.send("connect", {}, message => {
      this.#setTextSize(message.data)
    })
  }
  #setTextSize(data) {
    document.documentElement.dataset.textSize = data.textSize
  }
}

================
File: app/javascript/controllers/bridge/title_controller.js
================
import { BridgeComponent } from "@hotwired/hotwire-native-bridge"
import { viewport } from "helpers/bridge/viewport_helpers"
import { nextFrame } from "helpers/timing_helpers"
export default class extends BridgeComponent {
  static component = "title"
  static targets = [ "header" ]
  static values = { title: String }
  async connect() {
    super.connect()
    await nextFrame()
    this.#startObserver()
    window.addEventListener("resize", this.#windowResized)
  }
  disconnect() {
    super.disconnect()
    this.#stopObserver()
    window.removeEventListener("resize", this.#windowResized)
  }
  notifyBridgeOfVisibilityChange(visible) {
    this.send("visibility", { title: this.#title, elementVisible: visible })
  }
  // Intersection Observer
  #startObserver() {
    if (!this.hasHeaderTarget) return
    this.observer = new IntersectionObserver(([ entry ]) =>
      this.notifyBridgeOfVisibilityChange(entry.isIntersecting),
      { rootMargin: `-${this.#topOffset}px 0px 0px 0px` }
    )
    this.observer.observe(this.headerTarget)
    this.previousTopOffset = this.#topOffset
  }
  #stopObserver() {
    this.observer?.disconnect()
  }
  #updateObserverIfNeeded() {
    if (this.#topOffset === this.previousTopOffset) return
    this.#stopObserver()
    this.#startObserver()
  }
  #windowResized = () => {
    this.#updateObserverIfNeeded()
  }
  get #title() {
    return this.titleValue ? this.titleValue : document.title
  }
  get #topOffset() {
    return viewport.top
  }
}

================
File: app/javascript/controllers/application.js
================
import { Application } from "@hotwired/stimulus"
const application = Application.start()
// Configure Stimulus development experience
application.debug = false
window.Stimulus   = application
export { application }

================
File: app/javascript/controllers/assignment_limit_controller.js
================
import { Controller } from "@hotwired/stimulus"
export default class extends Controller {
  static values = { limit: Number, count: Number }
  static targets = ["unassigned", "limitMessage"]
  connect() {
    this.updateState()
  }
  countValueChanged() {
    this.updateState()
  }
  updateState() {
    const atLimit = this.countValue >= this.limitValue
    this.unassignedTargets.forEach(el => {
      el.hidden = atLimit
    })
    if (this.hasLimitMessageTarget) {
      this.limitMessageTarget.hidden = !atLimit
    }
  }
}

================
File: app/javascript/controllers/auto_click_controller.js
================
import { Controller } from "@hotwired/stimulus"
export default class extends Controller {
  connect() {
    this.element.click()
  }
}

================
File: app/javascript/controllers/auto_save_controller.js
================
import { Controller } from "@hotwired/stimulus"
import { submitForm } from "helpers/form_helpers"
const AUTOSAVE_INTERVAL = 3000
export default class extends Controller {
  #timer
  // Lifecycle
  disconnect() {
    this.submit()
  }
  // Actions
  async submit() {
    if (this.#dirty) {
      await this.#save()
    }
  }
  change(event) {
    if (event.target.form === this.element && !this.#dirty) {
      this.#scheduleSave()
    }
  }
  // Private
  #scheduleSave() {
    this.#timer = setTimeout(() => this.#save(), AUTOSAVE_INTERVAL)
  }
  async #save() {
    this.#resetTimer()
    await submitForm(this.element)
  }
  #resetTimer() {
    clearTimeout(this.#timer)
    this.#timer = null
  }
  get #dirty() {
    return !!this.#timer
  }
}

================
File: app/javascript/controllers/auto_submit_controller.js
================
import { Controller } from "@hotwired/stimulus"
export default class extends Controller {
  connect() {
    this.element.addEventListener("turbo:submit-end", this.#handleSubmitEnd.bind(this), { once: true })
    this.submit()
  }
  submit() {
    this.#markAsBusy()
    this.#disableSubmit()
    this.element.requestSubmit()
  }
  #handleSubmitEnd(event) {
    if (event.detail.success) {
      this.element.remove()
    } else {
      this.#clearBusy()
      this.#enableSubmit()
    }
  }
  #markAsBusy() {
    this.element.setAttribute("aria-busy", "true")
  }
  #clearBusy() {
    this.element.setAttribute("aria-busy", "false")
  }
  #disableSubmit() {
    this.#submitElements().forEach(element => element.disabled = true)
  }
  #enableSubmit() {
    this.#submitElements().forEach(element => element.disabled = false)
  }
  #submitElements() {
    return this.element.querySelectorAll("input[type=submit],button")
  }
}

================
File: app/javascript/controllers/autoresize_controller.js
================
import { Controller } from "@hotwired/stimulus"
export default class extends Controller {
  static targets = ["textarea", "wrapper"]
  connect() {
    this.resize()
  }
  resize() {
    this.wrapperTarget.setAttribute("data-autoresize-clone-value", this.textareaTarget.value)
  }
}

================
File: app/javascript/controllers/badge_controller.js
================
import { Controller } from "@hotwired/stimulus"
import { onNextEventLoopTick } from "helpers/timing_helpers"
export default class extends Controller {
  static targets = [ "unread" ]
  static classes = [ "unread" ]
  connect() {
    onNextEventLoopTick(() => this.update())
  }
  update() {
    onNextEventLoopTick(() => {
      if (this.#available) {
        const unreadCount = this.#unreadCount
        if (unreadCount > 0) {
          navigator.setAppBadge(unreadCount)
        } else {
          navigator.clearAppBadge()
        }
      }
    })
  }
  clear() {
    onNextEventLoopTick(() => {
      if (this.#available) {
        navigator.clearAppBadge()
      }
    })
  }
  get #unreadCount() {
    return this.unreadTargets.filter(unreadTarget => unreadTarget.classList.contains(this.unreadClass)).length
  }
  get #available() {
    return "setAppBadge" in navigator
  }
}

================
File: app/javascript/controllers/bar_controller.js
================
import { Controller } from "@hotwired/stimulus"
import { post } from "@rails/request.js"
import { nextFrame } from "helpers/timing_helpers";
export default class extends Controller {
  static targets = [ "turboFrame", "search", "searchInput", "form", "buttonsContainer" ]
  static outlets = [ "dialog" ]
  static values = {
    searchUrl: String,
  }
  dialogOutletConnected(outlet, element) {
    outlet.close()
    this.#clearTurboFrame()
  }
  reset() {
    this.dialogOutlet.close()
    this.#clearTurboFrame()
    this.#showItem(this.buttonsContainerTarget)
    this.#hideItem(this.searchTarget)
  }
  clearInput() {
    if (this.searchInputTarget.value) {
      this.searchInputTarget.value = ""
      this.searchInputTarget.focus()
    } else {
      this.reset()
    }
  }
  showModalAndSubmit(event) {
    this.showModal()
    this.formTarget.requestSubmit()
    this.#restoreFocusAfterTurboFrameLoads()
  }
  showModal() {
    this.dialogOutlet.open()
  }
  search(event) {
    this.#showItem(this.searchTarget)
    this.#hideItem(this.buttonsContainerTarget)
    if (this.searchInputTarget.value.trim()) {
      this.showModalAndSubmit()
    } else {
      this.#loadTurboFrame()
    }
  }
  #restoreFocusAfterTurboFrameLoads() {
    this.turboFrameTarget.addEventListener("turbo:frame-load", () => {
      this.searchInputTarget.focus()
    }, { once: true })
  }
  #loadTurboFrame() {
    this.turboFrameTarget.src = this.searchUrlValue
  }
  #clearTurboFrame() {
    this.turboFrameTarget.removeAttribute("src")
    this.turboFrameTarget.innerHtml = ""
  }
  async #showItem(element) {
    element.removeAttribute("hidden")
    const autofocusElement = element.querySelector("[autofocus]")
    autofocusElement?.focus()
    await nextFrame()
    autofocusElement?.select()
  }
  #hideItem(element) {
    element.setAttribute("hidden", "hidden")
  }
}

================
File: app/javascript/controllers/beacon_controller.js
================
import { post } from "@rails/request.js"
import { Controller } from "@hotwired/stimulus"
export default class extends Controller {
  static values = { url: String }
  connect() {
    this.#sendBeacon()
    this.onVisibilityChange = this.#sendBeacon.bind(this);
    document.addEventListener("visibilitychange", this.onVisibilityChange)
  }
  disconnect() {
    this.#sendBeacon()
    document.removeEventListener("visibilitychange", this.onVisibilityChange)
  }
  #sendBeacon() {
    if (!document.hidden) {
      post(this.urlValue, { responseKind: "turbo-stream" })
    }
  }
}

================
File: app/javascript/controllers/boards_form_controller.js
================
import { Controller } from "@hotwired/stimulus"
import { nextEventLoopTick } from "helpers/timing_helpers";
export default class extends Controller {
  static targets = ["meCheckbox"]
  static values = { selfRemovalPromptMessage: { type: String, default: "Are you sure?" } }
  async submitWithWarning(event) {
    if (this.hasMeCheckboxTarget && !this.meCheckboxTarget.checked && !this.confirmed) {
      event.detail.formSubmission.stop()
      const message = this.selfRemovalPromptMessageValue
      if (confirm(message)) {
        await nextEventLoopTick()
        this.confirmed = true
        this.element.requestSubmit()
      }
    }
  }
}

================
File: app/javascript/controllers/bubble_controller.js
================
import { Controller } from "@hotwired/stimulus"
import { signedDifferenceInDays } from "helpers/date_helpers"
const REFRESH_INTERVAL = 3_600_000 // 1 hour (in milliseconds)
export default class extends Controller {
  static targets = [ "entropy", "stalled", "top", "center", "bottom" ]
  static values = { entropy: Object, stalled: Object }
  #timer
  connect() {
    this.#timer = setInterval(this.update.bind(this), REFRESH_INTERVAL)
    this.update()
  }
  disconnect() {
    clearInterval(this.#timer)
  }
  update() {
    if (this.#hasEntropy) {
      this.#showEntropy()
    } else if (this.#isStalled) {
      this.#showStalled()
    } else {
      this.#hide()
    }
  }
  get #hasEntropy() {
    return this.#entropyCleanupInDays < this.entropyValue.daysBeforeReminder
  }
  get #entropyCleanupInDays() {
    return signedDifferenceInDays(new Date(), new Date(this.entropyValue.closesAt))
  }
  #showEntropy() {
    this.#render({
      top: this.#entropyCleanupInDays < 1 ? this.entropyValue.action : `${this.entropyValue.action} in`,
      center: this.#entropyCleanupInDays < 1 ? "!" : this.#entropyCleanupInDays,
      bottom: this.#entropyCleanupInDays < 1 ? "Today" : (this.#entropyCleanupInDays === 1 ? "day" : "days"),
    })
  }
  #render({ top, center, bottom }) {
    this.topTarget.innerHTML = top
    this.centerTarget.innerHTML = center
    this.bottomTarget.innerHTML = bottom
    this.#show()
  }
  // Keep in sync with Card::Stallable#stalled? in app/models/card/stallable.rb
  get #isStalled() {
    return this.stalledValue.lastActivitySpikeAt &&
      signedDifferenceInDays(new Date(this.stalledValue.lastActivitySpikeAt), new Date()) > this.stalledValue.stalledAfterDays &&
      signedDifferenceInDays(new Date(this.stalledValue.updatedAt), new Date()) > this.stalledValue.stalledAfterDays
  }
  #showStalled() {
    this.#render({
      top: "Stalled for",
      center: signedDifferenceInDays(new Date(this.stalledValue.lastActivitySpikeAt), new Date()),
      bottom: "days"
    })
  }
  #hide() {
    this.element.toggleAttribute("hidden", true)
  }
  #show() {
    this.element.removeAttribute("hidden")
  }
}

================
File: app/javascript/controllers/card_hotkeys_controller.js
================
import { Controller } from "@hotwired/stimulus"
import { post } from "@rails/request.js"
export default class extends Controller {
  static outlets = [ "navigable-list" ]
  connect() {
    this.morphCompletePromise = null
    this.morphCompleteResolver = null
  }
  handleKeydown(event) {
    if (this.#shouldIgnore(event) || this.#hasModifier(event)) return
    const handler = this.#keyHandlers[event.key.toLowerCase()]
    if (handler) {
      handler.call(this, event)
    }
  }
  // Called when turbo:morph completes - resolves our waiting promise
  handleMorphComplete() {
    if (this.morphCompleteResolver) {
      this.morphCompleteResolver()
      this.morphCompleteResolver = null
      this.morphCompletePromise = null
    }
  }
  // Private
  #shouldIgnore(event) {
    const target = event.target
    return target.tagName === "INPUT" ||
           target.tagName === "TEXTAREA" ||
           target.isContentEditable ||
           target.closest("input, textarea, [contenteditable], lexxy-editor")
  }
  #hasModifier(event) {
    return event.metaKey || event.ctrlKey || event.altKey || event.shiftKey
  }
  get #selectedCard() {
    // Find the navigable-list that currently has focus
    const focusedList = this.navigableListOutlets.find(list => list.hasFocus)
    if (!focusedList) return null
    const currentItem = focusedList.currentItem
    if (currentItem?.classList.contains("card") && !this.#hotkeysDisabled(focusedList)) {
      return { card: currentItem, controller: focusedList }
    }
    return null
  }
  async #postponeCard(event) {
    const selection = this.#selectedCard
    if (!selection) return
    const url = selection.card.dataset.cardNotNowUrl
    if (url) {
      event.preventDefault()
      await this.#performCardAction(url, selection)
    }
  }
  async #closeCard(event) {
    const selection = this.#selectedCard
    if (!selection) return
    const url = selection.card.dataset.cardClosureUrl
    if (url) {
      event.preventDefault()
      await this.#performCardAction(url, selection)
    }
  }
  async #assignToMe(event) {
    const selection = this.#selectedCard
    if (!selection) return
    const url = selection.card.dataset.cardAssignToSelfUrl
    if (url) {
      event.preventDefault()
      await post(url, { responseKind: "turbo-stream" })
    }
  }
  async #performCardAction(url, selection) {
    const { controller } = selection
    const visibleItems = controller.visibleItems
    const currentIndex = visibleItems.indexOf(selection.card)
    const wasLastItem = currentIndex === visibleItems.length - 1
    // Set up promise to wait for morph completion
    this.morphCompletePromise = new Promise(resolve => {
      this.morphCompleteResolver = resolve
    })
    await post(url, { responseKind: "turbo-stream" })
    // Wait for Turbo Stream morph to complete
    await Promise.race([
      this.morphCompletePromise,
      new Promise(resolve => setTimeout(resolve, 200)) // Fallback timeout
    ])
    // Select the next card (or previous if it was the last)
    const newVisibleItems = controller.visibleItems
    if (newVisibleItems.length === 0) {
      controller.clearSelection()
      return
    }
    if (wasLastItem) {
      controller.selectLast()
    } else {
      const nextIndex = Math.min(currentIndex, newVisibleItems.length - 1)
      if (newVisibleItems[nextIndex]) {
        await controller.selectItem(newVisibleItems[nextIndex])
      }
    }
  }
  #hotkeysDisabled(navigableList) {
    return navigableList?.element.dataset.cardHotkeysDisabled === "true"
  }
  #keyHandlers = {
    "["(event) { this.#postponeCard(event) },
    "]"(event) { this.#closeCard(event) },
    m(event) { this.#assignToMe(event) }
  }
}

================
File: app/javascript/controllers/clicker_controller.js
================
import { Controller } from "@hotwired/stimulus"
import { nextFrame } from "helpers/timing_helpers";
export default class extends Controller {
  static targets = [ "clickable" ]
  async click() {
    await nextFrame()
    this.#clickable.click()
  }
  get #clickable() {
    return this.hasClickableTarget ? this.clickableTarget : this.element
  }
}

================
File: app/javascript/controllers/collapsible_columns_controller.js
================
import { Controller } from "@hotwired/stimulus"
import { nextFrame, debounce } from "helpers/timing_helpers";
export default class extends Controller {
  static classes = [ "collapsed", "expanded", "noTransitions", "titleNotVisible" ]
  static targets = [ "column", "button", "title", "maybeColumn" ]
  static values = {
    board: String,
    desktopBreakpoint: { type: String, default: "(min-width: 640px)" }
  }
  initialize() {
    this.restoreState = debounce(this.restoreState.bind(this), 10)
  }
  async connect() {
    this.mediaQuery = window.matchMedia(this.desktopBreakpointValue)
    this.handlePlatform = this.#handlePlatform.bind(this)
    this.mediaQuery.addEventListener("change", this.handlePlatform)
    await this.#restoreColumnsDisablingTransitions()
    this.#setupIntersectionObserver()
  }
  disconnect() {
    if (this._intersectionObserver) {
      this._intersectionObserver.disconnect()
      this._intersectionObserver = null
    }
    this.mediaQuery.removeEventListener("change", this.handlePlatform)
  }
  toggle({ target }) {
    const column = target.closest('[data-collapsible-columns-target~="column"]')
    this.#toggleColumn(column);
  }
  preventToggle(event) {
    if (event.target.hasAttribute("data-collapsible-columns-target") && event.detail.attributeName === "class") {
      event.preventDefault()
    }
  }
  async restoreState(event) {
    await nextFrame()
    await this.#restoreColumnsDisablingTransitions()
  }
  focusOnColumn({ target }) {
    if (this.#isDesktop && this.#isCollapsed(target)) {
      this.#collapseAllExcept(target)
      this.#expand(target)
    }
  }
  async #restoreColumnsDisablingTransitions() {
    this.#disableTransitions()
    this.#restoreColumns()
    this.#handlePlatform()
    await nextFrame()
    this.#enableTransitions()
  }
  #disableTransitions() {
    this.element.classList.add(this.noTransitionsClass)
  }
  #enableTransitions() {
    this.element.classList.remove(this.noTransitionsClass)
  }
  #toggleColumn(column) {
    this.#collapseAllExcept(column)
    if (this.#isCollapsed(column)) {
      this.#expand(column)
    } else {
      this.#collapse(column)
    }
  }
  #collapseAllExcept(clickedColumn) {
    const columns = this.#isDesktop ? this.columnTargets.filter(c => c !== this.maybeColumnTarget) : this.columnTargets
    columns.forEach(column => {
      if (column !== clickedColumn) {
        this.#collapse(column)
      }
    })
  }
  #isCollapsed(column) {
    return column.classList.contains(this.collapsedClass)
  }
  #collapse(column) {
    const key = this.#localStorageKeyFor(column)
    this.#buttonFor(column)?.setAttribute("aria-expanded", "false")
    column.classList.remove(this.expandedClass)
    column.classList.add(this.collapsedClass)
    localStorage.removeItem(key)
  }
  #expand(column, saveState = true) {
    this.#buttonFor(column)?.setAttribute("aria-expanded", "true")
    column.classList.remove(this.collapsedClass)
    column.classList.add(this.expandedClass)
    if (saveState) {
      const key = this.#localStorageKeyFor(column)
      localStorage.setItem(key, true)
    }
    if (window.matchMedia('(max-width: 639px)').matches) {
      column.scrollIntoView({ behavior: "smooth", inline: "center" })
    }
  }
  #buttonFor(column) {
    return this.buttonTargets.find(button => column.contains(button))
  }
  #restoreColumns() {
    this.columnTargets.forEach(column => {
      this.#restoreColumn(column)
    })
  }
  #restoreColumn(column) {
    const key = this.#localStorageKeyFor(column)
    if (localStorage.getItem(key)) {
      this.#collapseAllExcept(column)
      this.#expand(column)
    }
  }
  #localStorageKeyFor(column) {
    return `expand-${this.boardValue}-${column.getAttribute("id")}`
  }
  #setupIntersectionObserver() {
    if (typeof IntersectionObserver === "undefined") return
    if (this._intersectionObserver) this._intersectionObserver.disconnect()
    this._intersectionObserver = new IntersectionObserver(entries => {
      entries.forEach(entry => {
        const title = entry.target
        const column = title.closest(".cards")
        if (!column) return
        const offscreen = entry.intersectionRatio === 0
        column.classList.toggle(this.titleNotVisibleClass, offscreen)
      })
    }, { threshold: [0] })
    this.titleTargets.forEach(title => this._intersectionObserver.observe(title))
  }
  get #isDesktop() {
    return this.mediaQuery?.matches
  }
  #handlePlatform() {
    this.#isDesktop ? this.#handleDesktopMode() : this.#handleMobileMode()
  }
  async #handleDesktopMode() {
    this.#expand(this.maybeColumnTarget, false)
    this.#maybeButton.setAttribute("disabled", true)
  }
  #handleMobileMode() {
    this.#maybeButton.removeAttribute("disabled")
    const expandedColumn = this.columnTargets.find(column => column !== this.maybeColumnTarget && !this.#isCollapsed(column))
    if (expandedColumn) {
      this.#collapseAllExcept(expandedColumn)
    } else {
      this.#collapseAllExcept(this.maybeColumnTarget)
      this.#expand(this.maybeColumnTarget, false)
    }
  }
  get #maybeButton() {
    return this.maybeColumnTarget.querySelector('[data-collapsible-columns-target="button"]')
  }
}

================
File: app/javascript/controllers/combobox_controller.js
================
import { Controller } from "@hotwired/stimulus"
export default class extends Controller {
  #hiddenField
  static targets = [ "label", "item", "hiddenFieldTemplate" ]
  static values = {
    selectPropertyName: { type: String, default: "aria-checked" },
    defaultValue: String,
    defaultLabel: String
  }
  static classes = ["withDefault"]
  connect() {
    this.#selectedItem = this.#selectedItem
  }
  change(event) {
    const item = event.target.closest("[role='checkbox']")
    if (item) {
      this.#selectedItem = item
    }
  }
  get #selectedLabel() {
    const selectedValue = this.#selectedItemValue()
    if (this.hasDefaultLabelValue && (selectedValue === this.defaultValueValue || !selectedValue)) {
      return this.defaultLabelValue
    }
    return this.#selectedItem?.dataset?.comboboxLabel || ""
  }
  get #selectedItem() {
    return this.itemTargets.find(item => item.getAttribute(this.selectPropertyNameValue) === "true")
  }
  #selectedItemValue() {
    return this.#selectedItem?.dataset?.comboboxValue || ""
  }
  set #selectedItem(item) {
    if (!item) return
    this.#clearSelection()
    item.setAttribute(this.selectPropertyNameValue, "true")
    this.labelTarget.textContent = this.#selectedLabel
    this.hiddenField.value = item.dataset.comboboxValue
    this.hiddenField.disabled = !item.dataset.comboboxValue
    this.#updateWithDefaultClass()
  }
  #clearSelection() {
    this.itemTargets.forEach(target => {
      target.setAttribute(this.selectPropertyNameValue, "false")
    })
  }
  get hiddenField() {
    if (!this.#hiddenField) {
      this.#hiddenField = this.#buildHiddenField()
    }
    return this.#hiddenField
  }
  #buildHiddenField() {
    const [field] = this.hiddenFieldTemplateTarget.content.cloneNode(true).children
    this.element.appendChild(field)
    return field
  }
  #updateWithDefaultClass() {
    if (this.hasWithDefaultClass && this.hasDefaultValueValue) {
      const selectedValue = this.#selectedItemValue()
      const shouldHaveClass = selectedValue === this.defaultValueValue
      if (shouldHaveClass) {
        this.element.classList.add(this.withDefaultClass)
      } else {
        this.element.classList.remove(this.withDefaultClass)
      }
    }
  }
}

================
File: app/javascript/controllers/copy_to_clipboard_controller.js
================
import { Controller } from "@hotwired/stimulus"
export default class extends Controller {
  static values = { content: String }
  static classes = [ "success" ]
  async copy(event) {
    event.preventDefault()
    this.reset()
    try {
      await navigator.clipboard.writeText(this.contentValue)
      this.element.classList.add(this.successClass)
    } catch {}
  }
  reset() {
    this.element.classList.remove(this.successClass)
    this.#forceReflow()
  }
  #forceReflow() {
    this.element.offsetWidth
  }
}

================
File: app/javascript/controllers/css_variable_counter_controller.js
================
import { Controller } from "@hotwired/stimulus"
import { debounce } from "helpers/timing_helpers"
export default class extends Controller {
  static targets = [ "item", "counter" ]
  static values = {
    propertyName: String,
    maxValue: { type: Number, default: 15 } // should match first geared pagination page size
  }
  initialize() {
    this.#updateCounter = debounce(this.#updateCounter.bind(this), 50)
  }
  connect() {
    if (this.itemTargets.length > 0) {
      this.#updateCounter()
    }
  }
  itemTargetConnected() {
    this.#updateCounter()
  }
  itemTargetDisconnected() {
    this.#updateCounter()
  }
  #updateCounter = () => {
    if (!this.hasCounterTarget) return
    const count = Math.min(this.itemTargets.length, this.maxValueValue)
    this.counterTarget.style.setProperty(this.propertyNameValue, count)
  }
}

================
File: app/javascript/controllers/details_controller.js
================
import { Controller } from "@hotwired/stimulus"
export default class extends Controller {
  static targets = [ "details" ]
  close() {
    this.detailsTarget.removeAttribute("open")
  }
  closeOnClickOutside({ target }) {
    if (!this.element.contains(target)) this.close()
  }
}

================
File: app/javascript/controllers/dialog_controller.js
================
import { Controller } from "@hotwired/stimulus"
import { orient } from "helpers/orientation_helpers"
import { isTouchDevice } from "helpers/platform_helpers"
export default class extends Controller {
  static targets = [ "dialog", "focusMouse", "focusTouch" ]
  static values = {
    modal: { type: Boolean, default: false },
    sizing: { type: Boolean, default: true },
    autoOpen: { type: Boolean, default: false }
  }
  connect() {
    this.dialogTarget.setAttribute("aria-hidden", "true")
    if (this.autoOpenValue) this.open()
  }
  focusTouchTargetConnected() {
    this.#setupFocus()
  }
  open() {
    const modal = this.modalValue
    if (modal) {
      this.dialogTarget.showModal()
    } else {
      this.dialogTarget.show()
      orient({ target: this.dialogTarget, anchor: this.element })
    }
    this.loadLazyFrames()
    this.dialogTarget.setAttribute("aria-hidden", "false")
    this.dispatch("show")
  }
  toggle() {
    if (this.dialogTarget.open) {
      this.close()
    } else {
      this.open()
    }
  }
  close() {
    this.dialogTarget.close()
    this.dialogTarget.setAttribute("aria-hidden", "true")
    this.dialogTarget.blur()
    orient({ target: this.dialogTarget, reset: true })
    this.dispatch("close")
  }
  closeOnClickOutside({ target }) {
    if (!this.element.contains(target)) this.close()
  }
  preventCloseOnMorphing(event) {
    if (event.detail?.attributeName === "open") {
      event.preventDefault()
      event.stopPropagation()
    }
  }
  loadLazyFrames() {
    Array.from(this.dialogTarget.querySelectorAll("turbo-frame")).forEach(frame => { frame.loading = "eager" })
  }
  captureKey(event) {
    if (event.key !== "Escape") { event.stopPropagation() }
  }
  #setupFocus() {
    const touch = isTouchDevice()
    if (this.hasFocusMouseTarget) this.focusMouseTarget.autofocus = !touch
    if (this.hasFocusTouchTarget) this.focusTouchTarget.autofocus = touch
  }
}

================
File: app/javascript/controllers/dialog_manager_controller.js
================
import { Controller } from "@hotwired/stimulus"
export default class extends Controller {
  connect() {
    this.element.addEventListener("dialog:show", this.handleDialogShow.bind(this))
  }
  disconnect() {
    this.element.removeEventListener("dialog:show", this.handleDialogShow.bind(this))
  }
  handleDialogShow(event) {
    this.#dialogControllers.forEach(dialogController => {
      if (dialogController !== event.target) {
        const dialog = dialogController.querySelector("dialog")
        dialog.removeAttribute("open")
      }
    })
  }
  get #dialogControllers() {
    return this.element.querySelectorAll('[data-controller~="dialog"]')
  }
}

================
File: app/javascript/controllers/drag_and_drop_controller.js
================
import { Controller } from "@hotwired/stimulus"
import { post } from "@rails/request.js"
import { nextFrame } from "helpers/timing_helpers"
export default class extends Controller {
  static targets = [ "item", "container" ]
  static classes = [ "draggedItem", "hoverContainer" ]
  // Actions
  async dragStart(event) {
    event.dataTransfer.effectAllowed = "move"
    event.dataTransfer.dropEffect = "move"
    event.dataTransfer.setData("37ui/move", event.target)
    await nextFrame()
    this.dragItem = this.#itemContaining(event.target)
    this.sourceContainer = this.#containerContaining(this.dragItem)
    this.originalDraggedItemCssVariable = this.#containerCssVariableFor(this.sourceContainer)
    this.dragItem.classList.add(this.draggedItemClass)
  }
  dragOver(event) {
    event.preventDefault()
    if (!this.dragItem) { return }
    const container = this.#containerContaining(event.target)
    this.#clearContainerHoverClasses()
    if (!container) { return }
    if (container !== this.sourceContainer) {
      container.classList.add(this.hoverContainerClass)
      this.#applyContainerCssVariableToDraggedItem(container)
    } else {
      this.#restoreOriginalDraggedItemCssVariable()
    }
  }
  async drop(event) {
    const targetContainer = this.#containerContaining(event.target)
    if (!targetContainer || targetContainer === this.sourceContainer) { return }
    this.wasDropped = true
    this.#increaseCounter(targetContainer)
    this.#decreaseCounter(this.sourceContainer)
    const sourceContainer = this.sourceContainer
    this.#insertDraggedItem(targetContainer, this.dragItem)
    await this.#submitDropRequest(this.dragItem, targetContainer)
    this.#reloadSourceFrame(sourceContainer)
  }
  dragEnd() {
    this.dragItem.classList.remove(this.draggedItemClass)
    this.#clearContainerHoverClasses()
    if (!this.wasDropped) {
      this.#restoreOriginalDraggedItemCssVariable()
    }
    this.sourceContainer = null
    this.dragItem = null
    this.wasDropped = false
    this.originalDraggedItemCssVariable = null
  }
  #itemContaining(element) {
    return this.itemTargets.find(item => item.contains(element) || item === element)
  }
  #containerContaining(element) {
    return this.containerTargets.find(container => container.contains(element) || container === element)
  }
  #clearContainerHoverClasses() {
    this.containerTargets.forEach(container => container.classList.remove(this.hoverContainerClass))
  }
  #applyContainerCssVariableToDraggedItem(container) {
    const cssVariable = this.#containerCssVariableFor(container)
    if (cssVariable) {
      this.dragItem.style.setProperty(cssVariable.name, cssVariable.value)
    }
  }
  #restoreOriginalDraggedItemCssVariable() {
    if (this.originalDraggedItemCssVariable) {
      const { name, value } = this.originalDraggedItemCssVariable
      this.dragItem.style.setProperty(name, value)
    }
  }
  #containerCssVariableFor(container) {
    const { dragAndDropCssVariableName, dragAndDropCssVariableValue } = container.dataset
    if (dragAndDropCssVariableName && dragAndDropCssVariableValue) {
      return { name: dragAndDropCssVariableName, value: dragAndDropCssVariableValue }
    }
    return null
  }
  #increaseCounter(container) {
    this.#modifyCounter(container, count => count + 1)
  }
  #decreaseCounter(container) {
    this.#modifyCounter(container, count => Math.max(0, count - 1))
  }
  #modifyCounter(container, fn) {
    const counterElement = container.querySelector("[data-drag-and-drop-counter]")
    if (counterElement) {
      const currentValue = counterElement.textContent.trim()
      if (!/^\d+$/.test(currentValue)) return
      counterElement.textContent = fn(parseInt(currentValue))
    }
  }
  #insertDraggedItem(container, item) {
    const itemContainer = container.querySelector("[data-drag-drop-item-container]")
    const topItems = itemContainer.querySelectorAll("[data-drag-and-drop-top]")
    const firstTopItem = topItems[0]
    const lastTopItem = topItems[topItems.length - 1]
    const isTopItem = item.hasAttribute("data-drag-and-drop-top")
    const referenceItem = isTopItem ? firstTopItem : lastTopItem
    if (referenceItem) {
      referenceItem[isTopItem ? "before" : "after"](item)
    } else {
      itemContainer.prepend(item)
    }
  }
  async #submitDropRequest(item, container) {
    const body = new FormData()
    const id = item.dataset.id
    const url = container.dataset.dragAndDropUrl.replaceAll("__id__", id)
    return post(url, { body, headers: { Accept: "text/vnd.turbo-stream.html" } })
  }
  #reloadSourceFrame(sourceContainer) {
    const frame = sourceContainer.querySelector("[data-drag-and-drop-refresh]")
    if (frame) frame.reload()
  }
}

================
File: app/javascript/controllers/drag_and_strum_controller.js
================
import { Controller } from "@hotwired/stimulus"
const INSTRUMENTS = [
  [
   "/audio/vibes/B3.mp3",
   "/audio/vibes/C3.mp3",
   "/audio/vibes/D4.mp3",
   "/audio/vibes/E3.mp3",
   "/audio/vibes/Fsharp4.mp3",
   "/audio/vibes/G3.mp3"
  ],
  [
    "/audio/banjo/B3.mp3",
    "/audio/banjo/C3.mp3",
    "/audio/banjo/D4.mp3",
    "/audio/banjo/E3.mp3",
    "/audio/banjo/Fsharp4.mp3",
    "/audio/banjo/G3.mp3"
  ],
  [
    "/audio/harpsichord/B3.mp3",
    "/audio/harpsichord/C3.mp3",
    "/audio/harpsichord/D4.mp3",
    "/audio/harpsichord/E3.mp3",
    "/audio/harpsichord/Fsharp4.mp3",
    "/audio/harpsichord/G3.mp3"
  ],
  [
    "/audio/mandolin/B3.mp3",
    "/audio/mandolin/C3.mp3",
    "/audio/mandolin/D4.mp3",
    "/audio/mandolin/E3.mp3",
    "/audio/mandolin/Fsharp4.mp3",
    "/audio/mandolin/G3.mp3"
  ],
  [
   "/audio/piano/B3.mp3",
   "/audio/piano/C3.mp3",
   "/audio/piano/D4.mp3",
   "/audio/piano/E3.mp3",
   "/audio/piano/Fsharp4.mp3",
   "/audio/piano/G3.mp3"
  ],
]
export default class extends Controller {
  static targets = [ "container" ]
  connect() {
    this.instrumentIndex = 0
    this.preloadedAudioFiles = []
    document.addEventListener("keydown", this.handleKeyDown.bind(this));
  }
  disconnect() {
    document.removeEventListener("keydown", this.handleKeyDown.bind(this));
  }
  handleKeyDown(event) {
    if (event.shiftKey) {
      this.instrumentIndex = this.#getInstrumentIndex(event)
      if (this.instrumentIndex < INSTRUMENTS.length) {
        this.#preloadAudioFiles(this.instrumentIndex)
      }
    }
  }
  dragEnter(event) {
    event.preventDefault()
    const container = this.#containerContaining(event.target)
    if (!container) { return }
    if (container !== this.sourceContainer && event.shiftKey) {
      this.#playSound()
    }
  }
  #getInstrumentIndex(event) {
    const number = Number(event.code.replace("Digit", ""))
    return isNaN(number) ? 0 : number
  }
  #preloadAudioFiles(instrumentIndex) {
    this.preloadedAudioFiles = []
    const audioFiles = INSTRUMENTS[instrumentIndex];
    if (audioFiles) {
      this.preloadedAudioFiles = audioFiles.map(file => {
        const audio = new Audio(file)
        audio.load()
        return audio
      })
    }
  }
  #containerContaining(element) {
    return this.containerTargets.find(container => container.contains(element) || container === element)
  }
  #playSound() {
    const randomIndex = Math.floor(Math.random() * this.preloadedAudioFiles.length)
    const audio = this.preloadedAudioFiles[randomIndex]
    const audioInstance = new Audio(audio.src)
    audioInstance.play()
  }
}

================
File: app/javascript/controllers/element_removal_controller.js
================
import { Controller } from "@hotwired/stimulus"
export default class extends Controller {
  remove() {
    this.element.remove()
  }
}

================
File: app/javascript/controllers/expandable_on_native_controller.js
================
import { Controller } from "@hotwired/stimulus"
import { isNative } from "helpers/platform_helpers"
export default class extends Controller {
  static get shouldLoad() {
    return isNative()
  }
  static values = { autoExpandSelector: String }
  connect() {
    if (this.hasAutoExpandSelectorValue && this.element.querySelector(this.autoExpandSelectorValue)) {
      this.element.open = true
    }
  }
}

================
File: app/javascript/controllers/fetch_on_visible_controller.js
================
import { Controller } from "@hotwired/stimulus"
import { get } from "@rails/request.js"
export default class extends Controller {
  static values = { url: String }
  connect() {
    this.#observe()
  }
  #observe() {
    const observer = new IntersectionObserver((entries) => {
      const visible = !!entries.find(entry => entry.isIntersecting)
      if (visible) {
        this.#fetch()
      }
    })
    observer.observe(this.element)
  }
  #fetch() {
    get(this.urlValue, { responseKind: "turbo-stream" })
  }
}

================
File: app/javascript/controllers/filter_controller.js
================
import { Controller } from "@hotwired/stimulus"
import { debounce } from "helpers/timing_helpers"
import { filterMatches } from "helpers/text_helpers"
export default class extends Controller {
  static targets = [ "input", "item" ]
  initialize() {
    this.filter = debounce(this.filter.bind(this), 100)
  }
  filter() {
    this.itemTargets.forEach(item => {
      if (filterMatches(item.textContent, this.inputTarget.value)) {
        item.removeAttribute("hidden")
      } else {
        item.toggleAttribute("hidden", true)
      }
    })
    this.dispatch("changed")
  }
  clearInput() {
    if (!this.hasInputTarget) return
    this.inputTarget.value = ""
  }
}

================
File: app/javascript/controllers/filter_form_controller.js
================
import { Controller } from "@hotwired/stimulus"
export default class extends Controller {
  clearCategory({ params: { name } }) {
    name.split(",").forEach(name => {
      this.element.querySelectorAll(`input[name="${name}"]`).forEach(input => {
        input.checked = false
      })
    })
  }
}

================
File: app/javascript/controllers/filter_settings_controller.js
================
import { Controller } from "@hotwired/stimulus"
import { debounce } from "helpers/timing_helpers";
import { post } from "@rails/request.js"
export default class extends Controller {
  static classes = ["filtersSet"]
  static targets = ["field", "form"]
  static values = { refreshUrl: String, noFilteringUrl: String, cardsUrl: String }
  initialize() {
    this.debouncedToggle = debounce(this.#toggle.bind(this), 50)
  }
  connect() {
    this.#toggle()
  }
  change(event) {
    this.#toggle()
    this.#refreshSaveToggleButton()
  }
  resetIfNoFiltering(event) {
    if (!this.#hasFiltersSet) {
      this.#showNoFilteringUrl()
      event.stopImmediatePropagation()
    }
  }
  async fieldTargetConnected(field) {
    this.debouncedToggle()
  }
  submitToGenericCardsView() {
    this.formTarget.action = this.cardsUrlValue
    this.formTarget.dataset.turboFrame = "top"
    this.formTarget.requestSubmit()
  }
  #toggle() {
    this.element.classList.toggle(this.filtersSetClass, this.#hasFiltersSet)
  }
  get #hasFiltersSet() {
    return this.fieldTargets.some(field => this.#isFieldSet(field))
  }
  #isFieldSet(field) {
    const value = field.value?.trim()
    if (!value) return false
    const defaultValue = this.#defaultValueForField(field)
    return defaultValue ? value !== defaultValue : true
  }
  #defaultValueForField(field) {
    const comboboxContainer = field.closest("[data-combobox-default-value-value]")
    return comboboxContainer?.dataset?.comboboxDefaultValueValue
  }
  #refreshSaveToggleButton() {
    post(this.refreshUrlValue, {
      body: this.#collectFilterFormData(),
      responseKind: "turbo-stream"
    })
  }
  #collectFilterFormData() {
    const formData = new FormData()
    this.formTargets.forEach(form => {
      const hiddenFields = form.querySelectorAll('input[type="hidden"]:not([disabled])[name]')
      hiddenFields.forEach(field => {
        formData.append(field.name, field.value)
      })
    })
    return formData
  }
  #showNoFilteringUrl() {
    Turbo.visit(this.noFilteringUrlValue, { frame: "cards_container", action: "advance" })
  }
}

================
File: app/javascript/controllers/form_controller.js
================
import { Controller } from "@hotwired/stimulus"
import { debounce, nextFrame } from "helpers/timing_helpers";
export default class extends Controller {
  static targets = [ "cancel", "submit", "input" ]
  static values = {
    debounceTimeout: { type: Number, default: 300 }
  }
  #isComposing = false
  initialize() {
    this.debouncedSubmit = debounce(this.debouncedSubmit.bind(this), this.debounceTimeoutValue)
  }
  // IME Composition tracking
  compositionStart() {
    this.#isComposing = true
  }
  compositionEnd() {
    this.#isComposing = false
  }
  submit() {
    this.element.requestSubmit()
  }
  preventEmptySubmit(event) {
    const input = this.hasInputTarget ? this.inputTarget : null
    if (input) {
      const value = (input.value || "").trim()
      const isEmpty = value.length === 0
      if (isEmpty) {
        event.preventDefault()
        input.setCustomValidity(input.dataset.validationMessage || "Please fill out this field")
        input.reportValidity()
        input.addEventListener("input", () => input.setCustomValidity(""), { once: true })
      }
    }
  }
  preventComposingSubmit(event) {
    if (this.#isComposing) {
      event.preventDefault()
    }
  }
  debouncedSubmit(event) {
    this.submit(event)
  }
  submitToTopTarget(event) {
    const value = event.target.value?.trim()
    if (!value) return false
    this.element.setAttribute("data-turbo-frame", "_top")
    this.submit()
  }
  reset() {
    this.element.reset()
  }
  cancel() {
    this.cancelTarget?.click()
  }
  preventAttachment(event) {
    event.preventDefault()
  }
  async disableSubmitWhenInvalid(event) {
    await nextFrame()
    if (this.element.checkValidity()) {
      this.submitTarget.removeAttribute("disabled")
    } else {
      this.submitTarget.toggleAttribute("disabled", true)
    }
  }
  select(event) {
    event.target.select()
  }
  blurActiveInput() {
    document.activeElement?.blur()
  }
}

================
File: app/javascript/controllers/frame_controller.js
================
import { Controller } from "@hotwired/stimulus"
import { Turbo } from "@hotwired/turbo-rails"
export default class extends Controller {
  morphRender({ detail }) {
    detail.render = function (currentElement, newElement) {
      Turbo.morphChildren(currentElement, newElement)
    }
  }
  morphReload(event) {
    const newElement = event.detail.newElement
    if (newElement && newElement.tagName === "TURBO-FRAME" && newElement.matches('[data-controller~="frame"]')) {
      event.preventDefault()
      this.element.reload()
    }
  }
  reload() {
    this.element.reload()
  }
}

================
File: app/javascript/controllers/frame_reloader_controller.js
================
import { Controller } from "@hotwired/stimulus"
export default class extends Controller {
  static values = {
    reloadInterval: { type: Number, default: 10 * 60 } // 10 minutes
  }
  connect() {
    this.freshSince = Date.now()
  }
  reload() {
    const now = Date.now()
    const reloadIntervalMs = this.reloadIntervalValue * 1000
    if ((now - this.freshSince) >= reloadIntervalMs) {
      this.freshSince = now
      this.element.reload()
    }
  }
}

================
File: app/javascript/controllers/hotkey_controller.js
================
import { Controller } from "@hotwired/stimulus"
export default class extends Controller {
  click(event) {
    if (this.#isClickable && !this.#shouldIgnore(event)) {
      event.preventDefault()
      this.element.click()
    }
  }
  focus(event) {
    if (this.#isClickable && !this.#shouldIgnore(event)) {
      event.preventDefault()
      this.element.focus()
    }
  }
  #shouldIgnore(event) {
    return event.defaultPrevented || event.target.closest("input, textarea, lexxy-editor")
  }
  get #isClickable() {
    return getComputedStyle(this.element).pointerEvents !== "none"
  }
}

================
File: app/javascript/controllers/index.js
================
// Import and register all your controllers from the importmap under controllers/*
import { application } from "controllers/application"
// Eager load all controllers defined in the import map under controllers/**/*_controller
import { eagerLoadControllersFrom } from "@hotwired/stimulus-loading"
eagerLoadControllersFrom("controllers", application)
// Lazy load controllers as they appear in the DOM (remember not to preload controllers in import map!)
// import { lazyLoadControllersFrom } from "@hotwired/stimulus-loading"
// lazyLoadControllersFrom("controllers", application)

================
File: app/javascript/controllers/knob_controller.js
================
import { Controller } from "@hotwired/stimulus"
export default class extends Controller {
  static targets = [ "field", "option", "slider" ]
  connect() {
    this.#index = this.#selectedOption.dataset.index
  }
  optionChanged({ target }) {
    this.#index = target.dataset.index
  }
  sliderChanged({ target }) {
    this.#index = target.value
  }
  set #index(index) {
    this.fieldTarget.style.setProperty("--knob-index", `${index}`);
    this.sliderTarget.value = index
    this.#optionForIndex(index).checked = true
  }
  get #selectedOption() {
    return this.optionTargets.find(option => {
      return option.checked
    })
  }
  #optionForIndex(index) {
    return this.optionTargets.find(option => {
      return option.dataset.index === index;
    })
  }
}

================
File: app/javascript/controllers/lightbox_controller.js
================
import { Controller } from "@hotwired/stimulus"
export default class extends Controller {
  static targets = [ "caption", "image", "dialog", "zoomedImage" ]
  imageTargetConnected(element) {
    element.addEventListener("click", this.#handleImageClick)
  }
  imageTargetDisconnected(element) {
    element.removeEventListener("click", this.#handleImageClick)
  }
  #handleImageClick = (event) => {
    event.preventDefault()
    this.#open(event.currentTarget)
  }
  #open(link) {
    this.dialogTarget.showModal()
    this.#set(link)
  }
  // Wait for the transition to finish before resetting the image
  handleTransitionEnd(event) {
    if (event.target === this.dialogTarget && !this.dialogTarget.open) {
      this.reset()
    }
  }
  reset() {
    this.zoomedImageTarget.src = ""
    this.captionTarget.innerHTML = "&nbsp;"
    this.dispatch('closed')
  }
  #set(target) {
    const imageSrc = target.href
    const caption = target.dataset.lightboxCaptionValue
    this.zoomedImageTarget.src = imageSrc
    if (caption) {
      this.captionTarget.innerText = caption
    }
  }
}

================
File: app/javascript/controllers/local_save_controller.js
================
import { Controller } from "@hotwired/stimulus"
import { debounce, nextFrame } from "helpers/timing_helpers"
export default class extends Controller {
  static targets = ["input"]
  static values = { key: String }
  initialize() {
    this.save = debounce(this.save.bind(this), 300)
  }
  connect() {
    this.restoreContent()
  }
  submit({ detail: { success } }) {
    if (success) {
      this.#clear()
    }
  }
  save() {
    const content = this.inputTarget.value
    if (content) {
      localStorage.setItem(this.keyValue, content)
    } else {
      this.#clear()
    }
  }
  async restoreContent() {
    await nextFrame()
    let savedContent = localStorage.getItem(this.keyValue)
    if (savedContent) {
      savedContent = `<div>${savedContent}</div>` // temporary for old markdown saves
      this.inputTarget.value = savedContent
      this.#triggerChangeEvent(savedContent)
    }
  }
  // Private
  #clear() {
    localStorage.removeItem(this.keyValue)
  }
  #triggerChangeEvent(newValue) {
    if (this.inputTarget.tagName === "LEXXY-EDITOR") {
      this.inputTarget.dispatchEvent(new CustomEvent('lexxy:change', {
        bubbles: true,
        detail: {
          previousContent: '',
          newContent: newValue
        }
      }))
    }
  }
}

================
File: app/javascript/controllers/local_time_controller.js
================
import { Controller } from "@hotwired/stimulus"
import { differenceInDays, secondsToDate } from "helpers/date_helpers"
const DEFAULT_LOCALE = "en-US"
export default class extends Controller {
  static targets = [ "time", "date", "datetime", "shortdate", "ago", "indays", "daysago", "agoorweekday", "timeordate" ]
  static values = { refreshInterval: Number }
  static classes = [ "local-time-value"]
  #timer
  initialize() {
    this.timeFormatter = new Intl.DateTimeFormat(DEFAULT_LOCALE, { timeStyle: "short" })
    this.dateFormatter = new Intl.DateTimeFormat(DEFAULT_LOCALE, { dateStyle: "long" })
    this.shortdateFormatter = new Intl.DateTimeFormat(DEFAULT_LOCALE, { month: "short", day: "numeric" })
    this.datetimeFormatter = new Intl.DateTimeFormat(DEFAULT_LOCALE, { timeStyle: "short", dateStyle: "short" })
    this.agoFormatter = new AgoFormatter()
    this.daysagoFormatter = new DaysAgoFormatter()
    this.datewithweekdayFormatter = new Intl.DateTimeFormat(DEFAULT_LOCALE, { weekday: "long", month: "long", day: "numeric" })
    this.datewithweekdayFormatter = new Intl.DateTimeFormat(DEFAULT_LOCALE, { weekday: "long", month: "long", day: "numeric" })
    this.indaysFormatter = new InDaysFormatter()
    this.agoorweekdayFormatter = new DaysAgoOrWeekdayFormatter()
    this.timeordateFormatter = new TimeOrDateFormatter()
  }
  connect() {
    this.#timer = setInterval(() => this.#refreshRelativeTimes(), 30_000)
  }
  disconnect() {
    clearInterval(this.#timer)
  }
  refreshAll() {
    this.constructor.targets.forEach(targetName => {
      this.targets.findAll(targetName).forEach(target => {
        this.#formatTime(this[`${targetName}Formatter`], target)
      })
    })
  }
  refreshTarget(event) {
    const target = event.target;
    const targetName = target.dataset.localTimeTarget
    this.#formatTime(this[`${targetName}Formatter`], target)
  }
  timeTargetConnected(target) {
    this.#formatTime(this.timeFormatter, target)
  }
  dateTargetConnected(target) {
    this.#formatTime(this.dateFormatter, target)
  }
  datetimeTargetConnected(target) {
    this.#formatTime(this.datetimeFormatter, target)
  }
  shortdateTargetConnected(target) {
    this.#formatTime(this.shortdateFormatter, target)
  }
  agoTargetConnected(target) {
    this.#formatTime(this.agoFormatter, target)
  }
  indaysTargetConnected(target) {
    this.#formatTime(this.indaysFormatter, target)
  }
  daysagoTargetConnected(target) {
    this.#formatTime(this.daysagoFormatter, target)
  }
  agoorweekdayTargetConnected(target) {
    this.#formatTime(this.agoorweekdayFormatter, target)
  }
  timeordateTargetConnected(target) {
    this.#formatTime(this.timeordateFormatter, target)
  }
  #refreshRelativeTimes() {
    this.agoTargets.forEach(target => {
      this.#formatTime(this.agoFormatter, target)
    })
  }
  #formatTime(formatter, target) {
    const dt = secondsToDate(parseInt(target.getAttribute("datetime")))
    target.innerHTML = formatter.format(dt)
    target.title = this.datetimeFormatter.format(dt)
  }
}
class AgoFormatter {
  format(dt) {
    const now = new Date()
    const seconds = (now - dt) / 1000
    const minutes = seconds / 60
    const hours = minutes / 60
    const days = hours / 24
    const weeks = days / 7
    const months = days / (365 / 12)
    const years = days / 365
    if (years >= 1) return this.#pluralize("year", years)
    if (months >= 1) return this.#pluralize("month", months)
    if (weeks >= 1) return this.#pluralize("week", weeks)
    if (days >= 1) return this.#pluralize("day", days)
    if (hours >= 1) return this.#pluralize("hour", hours)
    if (minutes >= 1) return this.#pluralize("minute", minutes)
    return "Less than a minute ago"
  }
  #pluralize(word, quantity) {
    quantity = Math.floor(quantity)
    const suffix = (quantity === 1) ? "" : "s"
    return `${quantity} ${word}${suffix} ago`
  }
}
class DaysAgoFormatter {
  format(date) {
    const days = differenceInDays(date, new Date())
    if (days <= 0) return styleableValue("today")
    if (days === 1) return styleableValue("yesterday")
    return `${styleableValue(days)} days ago`
  }
}
class DaysAgoOrWeekdayFormatter {
  format(date) {
    const days = differenceInDays(date, new Date())
    if (days <= 1) {
      return new DaysAgoFormatter().format(date)
    } else {
      return new Intl.DateTimeFormat(DEFAULT_LOCALE, { weekday: "long", month: "long", day: "numeric" }).format(date)
    }
  }
}
class InDaysFormatter {
  format(date) {
    const days = differenceInDays(new Date(), date)
    if (days <= 0) return styleableValue("today")
    if (days === 1) return styleableValue("tomorrow")
    return `in ${styleableValue(days)} days`
  }
}
class TimeOrDateFormatter {
  format(date) {
    const days = differenceInDays(date, new Date())
    if (days >= 1) {
      return new Intl.DateTimeFormat(DEFAULT_LOCALE, { month: "short", day: "numeric" }).format(date)
    } else {
      return new Intl.DateTimeFormat(DEFAULT_LOCALE, { timeStyle: "short" }).format(date)
    }
  }
}
function styleableValue(value) {
  return `<span class="local-time-value">${value}</span>`
}

================
File: app/javascript/controllers/magic_link_controller.js
================
import { Controller } from "@hotwired/stimulus"
import { onNextEventLoopTick } from "helpers/timing_helpers"
export default class extends Controller {
  static targets = [ "input" ]
  submitOnEnter(event) {
    event.preventDefault()
    this.submit()
  }
  submitOnPaste() {
    onNextEventLoopTick(() => this.submit())
  }
  submit() {
    if (this.inputTarget.disabled) return
    this.element.submit()
    this.inputTarget.disabled = true
  }
}

================
File: app/javascript/controllers/multi_selection_combobox_controller.js
================
import { Controller } from "@hotwired/stimulus"
import { toSentence } from "helpers/text_helpers"
export default class extends Controller {
  #hiddenField
  static targets = [ "label", "item", "hiddenFieldTemplate" ]
  static values = {
    selectPropertyName: { type: String, default: "aria-checked" },
    defaultValue: String,
    noSelectionLabel: { type: String, default: "No selection" },
    labelPrefix: String
  }
  connect() {
    this.refresh()
  }
  change(event) {
    const item = event.target.closest("[role='checkbox']")
    if (item) {
      this.#toggleSelection(item)
    }
  }
  refresh() {
    this.labelTarget.textContent = this.#selectedLabel
    this.#updateHiddenFields()
    this.#updateFilterShow()
  }
  clear(event) {
    this.#deselectAll()
    this.#updateHiddenFields()
    this.labelTarget.textContent = this.#selectedLabel
    this.#updateFilterShow()
  }
  get #selectedLabel() {
    const selectedValues = this.#selectedValues()
    if (selectedValues.length === 0) {
      return this.noSelectionLabelValue
    }
    const labels = this.#selectedItems.map(item => item.dataset.multiSelectionComboboxLabel)
    const sentence = toSentence(labels, {
      two_words_connector: " or ",
      last_word_connector: ", or "
    })
    return this.hasLabelPrefixValue ? `${this.labelPrefixValue} ${sentence}` : sentence
  }
  #toggleSelection(item) {
    const isSelected = item.getAttribute(this.selectPropertyNameValue) === "true"
    if (isSelected) {
      item.setAttribute(this.selectPropertyNameValue, "false")
    } else {
      if (this.isAnExclusiveSelectionItemInvolved(item)) {
        this.#deselectAll()
      }
      item.setAttribute(this.selectPropertyNameValue, "true")
    }
    this.#updateHiddenFields()
    if (item.dataset.multiSelectionFieldName) {
      this.#renameHiddenFields(item.dataset.multiSelectionFieldName)
    }
    this.labelTarget.textContent = this.#selectedLabel
  }
  isAnExclusiveSelectionItemInvolved(item) {
    return this.#isExclusiveSelection(item) || Array.from(this.#selectedItems).some((item) => this.#isExclusiveSelection(item))
  }
  #isExclusiveSelection(item) {
    return item.dataset.multiSelectionExclusive === "true"
  }
  #updateHiddenFields() {
    this.#clearHiddenFields()
    this.#addHiddenFields()
    this.#updateFilterShow()
  }
  #deselectAll() {
    this.itemTargets.forEach(item => {
      item.setAttribute(this.selectPropertyNameValue, "false")
    })
  }
  get #selectedItems() {
    return this.itemTargets.filter(item =>
      item.getAttribute(this.selectPropertyNameValue) === "true"
    )
  }
  #selectedValues() {
    return this.#selectedItems.map(item => item.dataset.multiSelectionComboboxValue)
  }
  #clearHiddenFields() {
    this.#hiddenFields.forEach(field => {
      field.remove()
    })
  }
  #renameHiddenFields(fieldName) {
    this.#hiddenFields.forEach(field => {
      field.setAttribute("name", fieldName)
    })
  }
  get #hiddenFields() {
    return this.element.querySelectorAll("input[type='hidden']")
  }
  #addHiddenFields() {
    this.#selectedValues().forEach(value => {
      const [ field ] = this.hiddenFieldTemplateTarget.content.cloneNode(true).children
      field.removeAttribute("id")
      field.value = value
      this.element.appendChild(field)
    })
  }
  #updateFilterShow() {
    const hasSelection = this.#selectedValues().length > 0
    this.element.setAttribute("data-filter-show", hasSelection)
  }
}

================
File: app/javascript/controllers/nav_section_expander_controller.js
================
import { Controller } from "@hotwired/stimulus"
export default class extends Controller {
  static values = { key: String }
  static targets = [ "input", "section" ]
  sectionTargetConnected() {
    this.#restoreToggles()
  }
  toggle(event) {
    const section = event.target
    if (section.hasAttribute("data-is-filtering")) return
    const key = this.#localStorageKeyFor(section)
    if (section.open) {
      localStorage.removeItem(key)
    } else {
      localStorage.setItem(key, true)
    }
  }
  showWhileFiltering() {
    if (this.inputTarget.value) {
      this.#expandAll();
    } else {
      this.#restoreToggles()
    }
  }
  #expandAll() {
    this.sectionTargets.forEach(section => {
      section.setAttribute("data-is-filtering", true)
      section.open = true
    })
  }
  #restoreToggles() {
    this.sectionTargets.forEach(section => {
      const key = this.#localStorageKeyFor(section)
      section.open = !localStorage.getItem(key)
      section.removeAttribute("data-is-filtering")
    })
  }
  #localStorageKeyFor(section) {
    return section.getAttribute("data-nav-section-expander-key-value")
  }
}

================
File: app/javascript/controllers/navigable_list_controller.js
================
import { Controller } from "@hotwired/stimulus"
import { nextFrame } from "helpers/timing_helpers"
import { isMobile } from "helpers/platform_helpers"
export default class extends Controller {
  static targets = [ "item", "input" ]
  static values = {
    reverseOrder: { type: Boolean, default: false },
    selectionAttribute: { type: String, default: "aria-selected" },
    focusOnSelection: { type: Boolean, default: true },
    actionableItems: { type: Boolean, default: false },
    reverseNavigation: { type: Boolean, default: false },
    supportsHorizontalNavigation: { type: Boolean, default: true },
    supportsVerticalNavigation: { type: Boolean, default: true },
    hasNestedNavigation: { type: Boolean, default: false },
    preventHandledKeys: { type: Boolean, default: false },
    autoSelect: { type: Boolean, default: true },
    autoScroll: { type: Boolean, default: true },
    onlyActOnFocusedItems: { type: Boolean, default: false }
  }
  // Don't load for mobile devices
  static get shouldLoad() {
    return !isMobile()
  }
  connect() {
    if (this.autoSelectValue) {
      this.reset()
    } else {
      this.#activateManualSelection()
    }
  }
  // Actions
  reset(event) {
    if (this.reverseOrderValue) {
      this.selectLast()
    } else {
      this.selectFirst()
    }
  }
  navigate(event) {
    this.#keyHandlers[event.key]?.call(this, event)
    this.#relayNavigationToParentNavigableList(event)
  }
  select({ target }) {
    this.selectItem(target, true)
  }
  hoverSelect({ currentTarget }) {
    this.selectItem(currentTarget)
  }
  selectCurrentOrReset(event) {
    if (this.currentItem) {
      this.#setCurrentFrom(this.currentItem)
    } else {
      this.reset()
    }
  }
  selectFirst() {
    this.#setCurrentFrom(this.#visibleItems[0])
  }
  selectLast() {
    this.#setCurrentFrom(this.#visibleItems[this.#visibleItems.length - 1])
  }
  deselectWhenClickingOutside(event) {
    if (this.element.contains(event.target)) {
      return
    }
    this.#clearSelection()
  }
  // Public
  async selectItem(item, skipFocus = false) {
    await this.#selectCurrentElementInParent()
    this.#clearSelection()
    item.setAttribute(this.selectionAttributeValue, "true")
    this.currentItem = item
    this.#refreshActiveDescendant()
    await nextFrame()
    if (this.autoScrollValue) { this.currentItem.scrollIntoView({ block: "nearest", inline: "nearest" }) }
    if (this.hasNestedNavigationValue) { this.#activateNestedNavigableList() }
    if (!skipFocus && this.focusOnSelectionValue) { this.currentItem.focus({ preventScroll: !this.autoScrollValue }) }
  }
  isSelected(item) {
    return item === this.currentItem
  }
  // Private
  async #setCurrentFrom(element) {
    const selectedItem = this.#visibleItems.find(item => item.contains(element))
    if (selectedItem) {
      await this.selectItem(selectedItem)
    }
  }
  get #parentNavigableListController() {
    const parentNavigableList = this.element.parentElement?.closest("[data-controller~='navigable-list']")
    if (parentNavigableList) {
      return this.application.getControllerForElementAndIdentifier(parentNavigableList, "navigable-list")
    }
    return null
  }
  async #selectCurrentElementInParent() {
    const parentController = this.#parentNavigableListController
    if (parentController) {
      const parentItem = this.element.closest("[data-navigable-list-target~='item']")
      const isAlreadySelected = parentController.isSelected(parentItem)
      if (!isAlreadySelected) {
        await parentController.selectItem(parentItem, true)
      }
    }
  }
  #clearSelection() {
    for (const item of this.itemTargets) {
      item.removeAttribute(this.selectionAttributeValue)
    }
  }
  #refreshActiveDescendant() {
    const id = this.currentItem?.getAttribute("id")
    if (this.hasInputTarget && id) {
      this.inputTarget.setAttribute("aria-activedescendant", id)
    }
  }
  #activateNestedNavigableList() {
    const nestedController = this.#nestedNavigableListController()
    if (nestedController) {
      nestedController.selectCurrentOrReset()
      return true
    }
    return false
  }
  #nestedNavigableListController() {
    const nestedElement = this.currentItem?.querySelector('[data-controller~="navigable-list"]')
    if (nestedElement) {
      return this.application.getControllerForElementAndIdentifier(nestedElement, "navigable-list")
    }
    return null
  }
  #activateManualSelection() {
    const preselectedItem = this.itemTargets.find(item => item.hasAttribute(this.selectionAttributeValue))
    if (preselectedItem) {
      this.#setCurrentFrom(preselectedItem)
    }
  }
  // Stimulus won't let you handle keydown events with different handlers for the same (nested) stimulus controllers.
  #relayNavigationToParentNavigableList(event) {
    const parentController = this.#parentNavigableListController
    if (parentController) {
      parentController.element.focus({ preventScroll: !parentController.autoScrollValue })
      parentController.navigate(event)
    }
  }
  #selectPrevious() {
    const index = this.#visibleItems.indexOf(this.currentItem)
    if (index > 0) {
      this.#setCurrentFrom(this.#visibleItems[index - 1])
    }
  }
  #selectNext() {
    const index = this.#visibleItems.indexOf(this.currentItem)
    if (index >= 0 && index < this.#visibleItems.length - 1) {
      this.#setCurrentFrom(this.#visibleItems[index + 1])
    }
  }
  #handleArrowKey(event, fn) {
    if (event.shiftKey || event.metaKey || event.ctrlKey) { return }
    fn.call()
    if (this.preventHandledKeysValue) {
      event.preventDefault()
    }
  }
  #clickCurrentItem(event) {
    if (this.actionableItemsValue && this.currentItem && this.#visibleItems.length && this.#isFocusContainedOnNavigableItem) {
      const clickableElement = this.currentItem.querySelector("a,button") || this.currentItem
      clickableElement.click()
      event.preventDefault()
    }
  }
  get #isFocusContainedOnNavigableItem() {
    return !this.onlyActOnFocusedItemsValue || this.itemTargets.some(item => item === document.activeElement || item.contains(document.activeElement))
  }
  #toggleCurrentItem(event) {
    if (this.actionableItemsValue && this.currentItem && this.#visibleItems.length) {
      const toggleable = this.currentItem.querySelector("input[type=checkbox]")
      const isDisabled = toggleable.hasAttribute("disabled")
      if (toggleable) {
        if (!isDisabled) {
          toggleable.checked = !toggleable.checked
          toggleable.dispatchEvent(new Event('change', { bubbles: true }))
        }
        event.preventDefault()
      }
    }
  }
  get #visibleItems() {
    return this.itemTargets.filter(item => {
      return item.checkVisibility() && !item.hidden
    })
  }
  // Public accessors for card_hotkeys_controller outlet
  get visibleItems() {
    return this.#visibleItems
  }
  clearSelection() {
    this.#clearSelection()
    this.currentItem = null
  }
  get hasFocus() {
    return this.element.contains(document.activeElement)
  }
  #keyHandlers = {
    ArrowDown(event) {
      if (this.supportsVerticalNavigationValue) {
        const selectMethod = this.reverseNavigationValue ? this.#selectPrevious.bind(this) : this.#selectNext.bind(this)
        this.#handleArrowKey(event, selectMethod)
      }
    },
    ArrowUp(event) {
      if (this.supportsVerticalNavigationValue) {
        const selectMethod = this.reverseNavigationValue ? this.#selectNext.bind(this) : this.#selectPrevious.bind(this)
        this.#handleArrowKey(event, selectMethod)
      }
    },
    ArrowRight(event) {
      if (this.supportsHorizontalNavigationValue) {
        this.#handleArrowKey(event, this.#selectNext.bind(this))
      }
    },
    ArrowLeft(event) {
      if (this.supportsHorizontalNavigationValue) {
        this.#handleArrowKey(event, this.#selectPrevious.bind(this))
      }
    },
    Enter(event) {
      // Skip handling during IME composition (e.g., Japanese input)
      if (event.isComposing) { return }
      if (event.shiftKey) {
        this.#toggleCurrentItem(event)
      } else {
        this.#clickCurrentItem(event)
      }
    }
  }
}

================
File: app/javascript/controllers/notifications_controller.js
================
import { Controller } from "@hotwired/stimulus"
import { post } from "@rails/request.js"
export default class extends Controller {
  static classes = [ "enabled" ]
  static targets = [ "subscribeButton", "explainer" ]
  static values = { subscriptionsUrl: String }
  async connect() {
    if (!this.#allowed) return
    switch(Notification.permission) {
      case "default":
        this.#showButtonToSubscribe()
        break
      case "granted":
        const registration = await this.#getServiceWorkerRegistration()
        const subscription = await registration?.pushManager?.getSubscription()
        if (registration && subscription) {
          this.element.classList.add(this.enabledClass)
        } else {
          this.#showButtonToSubscribe()
        }
        break
    }
  }
  async attemptToSubscribe() {
    if (this.#allowed) {
      const registration = await this.#getServiceWorkerRegistration() || await this.#registerServiceWorker()
      switch(Notification.permission) {
        case "denied":  { break }
        case "granted": { this.#subscribe(registration); break }
        case "default": { this.#requestPermissionAndSubscribe(registration) }
      }
    }
  }
  async isEnabled() {
    if (this.#allowed) {
      const registration = await this.#getServiceWorkerRegistration()
      const existingSubscription = await registration?.pushManager?.getSubscription()
      return Notification.permission == "granted" && registration && existingSubscription
    }
  }
  get #allowed() {
    return navigator.serviceWorker && window.Notification
  }
  async #getServiceWorkerRegistration() {
    return navigator.serviceWorker.getRegistration("/service-worker.js", { scope: "/" })
  }
  async #registerServiceWorker() {
    await navigator.serviceWorker.register("/service-worker.js", { scope: "/" })
    return navigator.serviceWorker.ready
  }
  async #subscribe(registration) {
    registration.pushManager
      .subscribe({ userVisibleOnly: true, applicationServerKey: this.#vapidPublicKey })
      .then(subscription => {
        this.#syncPushSubscription(subscription)
      })
  }
  async #syncPushSubscription(subscription) {
    const response = await post(this.subscriptionsUrlValue, { body: this.#extractJsonPayloadAsString(subscription), responseKind: "turbo-stream" })
    if (response.ok) {
      this.element.classList.add(this.enabledClass)
      this.subscribeButtonTarget.hidden = true
    } else {
      subscription.unsubscribe()
    }
  }
  #showButtonToSubscribe() {
    this.subscribeButtonTarget.hidden = false
    this.explainerTarget.hidden = true
  }
  async #requestPermissionAndSubscribe(registration) {
    const permission = await Notification.requestPermission()
    if (permission === "granted") this.#subscribe(registration)
  }
  get #vapidPublicKey() {
    const encodedVapidPublicKey = document.querySelector('meta[name="vapid-public-key"]').content
    return this.#urlBase64ToUint8Array(encodedVapidPublicKey)
  }
  #extractJsonPayloadAsString(subscription) {
    const { endpoint, keys: { p256dh, auth } } = subscription.toJSON()
    return JSON.stringify({ push_subscription: { endpoint, p256dh_key: p256dh, auth_key: auth } })
  }
  // VAPID public key comes encoded as base64 but service worker registration needs it as a Uint8Array
  #urlBase64ToUint8Array(base64String) {
    const padding = "=".repeat((4 - base64String.length % 4) % 4)
    const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/")
    const rawData = window.atob(base64)
    const outputArray = new Uint8Array(rawData.length)
    for (let i = 0; i < rawData.length; ++i) {
      outputArray[i] = rawData.charCodeAt(i)
    }
    return outputArray
  }
}

================
File: app/javascript/controllers/notifications_tray_controller.js
================
import { Controller } from "@hotwired/stimulus"
export default class extends Controller {
  static targets = [ "notification", "hiddenNotifications" ]
  static classes = [ "grouped" ]
  connect() {
    this.group()
  }
  group() {
    const notificationsByCardId = this.#groupNotificationsByCardId()
    for (const cardId in notificationsByCardId) {
      const notifications = notificationsByCardId[cardId]
      if (notifications.length > 1) {
        this.#renderGroup(notifications)
      }
    }
    this.grouped = true
  }
  notificationTargetConnected(notification) {
    if (this.grouped && notification.parentElement !== this.hiddenNotificationsTarget) {
      this.#groupNotification(notification)
    }
  }
  #groupNotificationsByCardId() {
    const notificationsByCardId = {}
    this.notificationTargets.forEach(notification => {
      const cardId = notification.dataset.cardId
      notificationsByCardId[cardId] ||= []
      notificationsByCardId[cardId].push(notification)
    })
    return notificationsByCardId
  }
  #groupNotification(notification) {
    const groupedNotifications = this.#groupedNotificationsFor(notification)
    if (groupedNotifications.length > 1) {
      this.#renderGroup(groupedNotifications)
    }
  }
  #groupedNotificationsFor(notification) {
    const cardId = notification.dataset.cardId
    return this.notificationTargets
      .filter(notification => notification.dataset.cardId === cardId)
  }
  #renderGroup(groupedNotifications) {
    groupedNotifications.sort((notification_1, notification_2) => parseInt(notification_1.dataset.timestamp) - parseInt(notification_2.dataset.timestamp))
    this.#showAsGrouped(groupedNotifications[0], groupedNotifications.length)
    groupedNotifications.slice(1).forEach(notification => this.#hideInGroup(notification))
  }
  #showAsGrouped(notification, size) {
    notification.classList.add(this.groupedClass)
    this.#showGroupedNotification(notification)
    this.#setGroupCount(notification, size)
  }
  #hideInGroup(notification) {
    this.#hideGroupedNotification(notification)
    this.#setGroupCount(notification, "")
  }
  // We use a hidden container instead of hiding the notifications directly so that the CSS that sort the
  // tray element indexes doesn't get messed up with the child positions changing.
  #showGroupedNotification(notification) {
    if (notification.parentElement === this.hiddenNotificationsTarget) {
      this.hiddenNotificationsTarget.parentElement.insertBefore(notification, this.hiddenNotificationsTarget)
    }
  }
  #hideGroupedNotification(notification) {
    this.hiddenNotificationsTarget.appendChild(notification)
  }
  #setGroupCount(notification, count) {
    notification.querySelector("[data-group-count]").textContent = count
  }
}

================
File: app/javascript/controllers/outlet_auto_save_controller.js
================
import { Controller } from "@hotwired/stimulus"
export default class extends Controller {
  static outlets = [ "auto-save" ]
  change(event) {
    this.autoSaveOutlet.change(event)
  }
  submit() {
    this.autoSaveOutlet.submit()
  }
}

================
File: app/javascript/controllers/pagination_controller.js
================
import { Controller } from "@hotwired/stimulus"
import { createElement } from "helpers/html_helpers"
import { delay, nextEvent } from "helpers/timing_helpers"
import { keepingScrollPosition } from "helpers/scroll_helpers"
import { get } from "@rails/request.js"
const DELAY_BEFORE_OBSERVING = 400
export default class extends Controller {
  static targets = [ "paginationLink" ]
  static values = {
    paginateOnIntersection: { type: Boolean, default: false },
    discardFrame: Boolean,
    manualActivation: Boolean
  }
  initialize() {
    if (!this.manualActivation) {
      this.activate()
    }
  }
  disconnect() {
    this.observer?.disconnect()
  }
  async activate() {
    await delay(DELAY_BEFORE_OBSERVING)
    if (this.paginateOnIntersectionValue) {
      this.observer = new IntersectionObserver(this.#intersect, { rootMargin: "300px", threshold: 1 })
    }
  }
  async paginationLinkTargetConnected(linkElement) {
    if (this.paginateOnIntersectionValue) {
      await delay(DELAY_BEFORE_OBSERVING)
      this.observer?.observe(linkElement)
    }
  }
  // Actions
  loadPage({ target }) {
    this.#loadPaginationLink(target)
  }
  // Private
  #intersect = ([ entry ]) => {
    if (entry?.isIntersecting && entry.intersectionRatio === 1) {
      this.#loadPaginationLink(entry.target)
    }
  }
  #loadPaginationLink(linkElement) {
    this.observer?.unobserve(linkElement)
    keepingScrollPosition(this.#closestSiblingTo(linkElement) || linkElement.parentNode, this.#expandPaginationLink(linkElement))
  }
  #closestSiblingTo(element) {
    return element.nextElementSibling || element.previousElementSibling
  }
  async #expandPaginationLink(linkElement) {
    linkElement.setAttribute("aria-busy", "true")
    if (this.discardFrameValue) {
      await this.#replacePaginationLinkWithFrameContents(linkElement)
    } else {
      await this.#replacePaginationLinkWithFrame(linkElement)
    }
    linkElement.removeAttribute("aria-busy")
  }
  async #replacePaginationLinkWithFrameContents(linkElement) {
    linkElement.outerHTML = await this.#loadHtmlFrom(linkElement)
  }
  async #loadHtmlFrom(linkElement) {
    const response = await get(linkElement.href, { responseKind: "html" })
    const html = await response.text
    const doc = new DOMParser().parseFromString(html, "text/html")
    const element = doc.querySelector(`turbo-frame#${linkElement.dataset.frame}`)
    return element ? element.innerHTML.trim() : ""
  }
  #replacePaginationLinkWithFrame(linkElement) {
    const turboFrame = this.#buildTurboFrameFor(linkElement)
    this.#insertTurboFrameAtPosition(linkElement, turboFrame)
  }
  #buildTurboFrameFor(linkElement) {
    const turboFrame = createElement("turbo-frame", {
      id: linkElement.dataset.frame,
      src: linkElement.href,
      refresh: "morph",
      target: "_top"
    })
    this.#keepScrollPositionOnFrameRender(turboFrame, linkElement)
    return turboFrame
  }
  async #keepScrollPositionOnFrameRender(turboFrame, linkElement) {
    await nextEvent(turboFrame, "turbo:before-frame-render")
    keepingScrollPosition(linkElement, nextEvent(turboFrame, "turbo:frame-render"))
  }
  #insertTurboFrameAtPosition(linkElement, turboFrame) {
    const container = linkElement.parentNode.parentNode
    if (linkElement.parentNode.firstElementChild === linkElement) {
      container.prepend(turboFrame)
    } else {
      container.append(turboFrame)
    }
  }
}

================
File: app/javascript/controllers/reaction_delete_controller.js
================
import { Controller } from "@hotwired/stimulus"
export default class extends Controller {
  static classes = [ "deleteable", "reveal", "perform" ]
  static targets = [ "button", "content" ]
  static values = { reacterId: String }
  connect() {
    if (this.#currentUserIsReacter) {
      this.#setAccessibleAttributes()
    }
  }
  reveal() {
    if (this.#currentUserIsReacter) {
      this.element.classList.toggle(this.revealClass)
      this.contentTarget.ariaExpanded = this.element.classList.contains(this.revealClass)
      this.buttonTarget.focus()
    }
  }
  perform() {
    this.element.classList.add(this.performClass)
  }
  #setAccessibleAttributes() {
    this.contentTarget.role = "button"
    this.contentTarget.tabIndex = 0
    this.contentTarget.ariaExpanded = false
    this.element.classList.add(this.deleteableClass)
  }
  get #currentUserIsReacter() {
    return Current.user.id === this.reacterIdValue
  }
}

================
File: app/javascript/controllers/reaction_emoji_controller.js
================
import { Controller } from "@hotwired/stimulus"
export default class extends Controller {
  static targets = [ "input" ]
  insertEmoji(event) {
    const emojiChar = event.target.getAttribute("data-emoji")
    const value = this.inputTarget.value
    const newValue = `${value}${emojiChar}`
    if (this.inputTarget.maxLength > 0 && newValue.length <= this.inputTarget.maxLength) {
      this.inputTarget.value = newValue
    }
    this.inputTarget.focus()
  }
}

================
File: app/javascript/controllers/related_element_controller.js
================
import { Controller } from "@hotwired/stimulus"
export default class extends Controller {
  static targets = [ "related" ]
  static classes = [ "highlight" ]
  connect() {
    this.#highlight(null)
  }
  highlight(event) {
    this.#highlight(event.currentTarget.dataset.relatedElementGroupValue)
  }
  unhighlight() {
    this.#highlight(null)
  }
  #highlight(groupValue) {
    this.relatedTargets.forEach(element =>
      element.classList.toggle(this.highlightClass, element.dataset.relatedElementGroupValue === groupValue)
    )
  }
}

================
File: app/javascript/controllers/retarget_links_controller.js
================
import { Controller } from "@hotwired/stimulus"
export default class extends Controller {
  connect() {
    this.element.querySelectorAll("a").forEach(this.#retargetLink.bind(this))
  }
  #retargetLink(link) {
    link.target = this.#targetsSameDomain(link) ? "_top" : "_blank"
  }
  #targetsSameDomain(link) {
    return link.href.startsWith(window.location.origin)
  }
}

================
File: app/javascript/controllers/scroll_to_controller.js
================
import { Controller } from "@hotwired/stimulus"
export default class extends Controller {
  static targets = [ "target" ]
  connect() {
    this.#scrollTargetIntoView()
  }
  #scrollTargetIntoView() {
    if(this.hasTargetTarget) {
      this.element.scrollTo({
        top: this.targetTarget.offsetTop - this.element.offsetHeight / 2 + this.targetTarget.offsetHeight / 2,
        left: this.targetTarget.offsetLeft - this.element.offsetWidth / 2 + this.targetTarget.offsetWidth / 2,
        behavior: "instant"
      })
    }
  }
}

================
File: app/javascript/controllers/soft_keyboard_controller.js
================
import { Controller } from "@hotwired/stimulus"
import { nextEventNamed } from "helpers/timing_helpers"
import { isTouchDevice } from "helpers/platform_helpers"
export default class extends Controller {
  // Only load for touch devices
  static get shouldLoad() {
    return isTouchDevice()
  }
  // Use a fake input to trigger the soft keyboard on actions that load async content
  // See https://gist.github.com/cathyxz/73739c1bdea7d7011abb236541dc9aaa
  async open(event) {
    const fakeInput = this.#focusOnFakeInput()
    this.#removeOnFocusOut(fakeInput)
  }
  #focusOnFakeInput() {
    const fakeInput = document.createElement("input")
    fakeInput.setAttribute("type", "text")
    fakeInput.setAttribute("class", "input--invisible")
    this.element.appendChild(fakeInput)
    fakeInput.focus()
    return fakeInput
  }
  async #removeOnFocusOut(element) {
    await nextEventNamed("focusout", element)
    element.remove()
  }
}

================
File: app/javascript/controllers/syntax_highlight_controller.js
================
import { Controller } from "@hotwired/stimulus"
import { highlightAll } from "lexxy"
export default class extends Controller {
  connect() {
    highlightAll()
  }
}

================
File: app/javascript/controllers/theme_controller.js
================
import { Controller } from "@hotwired/stimulus"
export default class extends Controller {
  static targets = ["lightButton", "darkButton", "autoButton"]
  connect() {
    this.#applyStoredTheme()
  }
  setLight() {
    this.#theme = "light"
  }
  setDark() {
    this.#theme = "dark"
  }
  setAuto() {
    this.#theme = "auto"
  }
  get #storedTheme() {
    return localStorage.getItem("theme") || "auto"
  }
  set #theme(theme) {
    localStorage.setItem("theme", theme)
    const currentTheme = document.documentElement.getAttribute("data-theme") || "auto"
    const hasChanged = currentTheme !== theme
    const prefersReducedMotion = window.matchMedia?.("(prefers-reduced-motion: reduce)")?.matches
    const animate = hasChanged && !prefersReducedMotion
    const applyTheme = () => {
      if (theme === "auto") {
        document.documentElement.removeAttribute("data-theme")
      } else {
        document.documentElement.setAttribute("data-theme", theme)
      }
      this.#updateButtons()
    }
    if (animate && document.startViewTransition) {
      document.startViewTransition(applyTheme)
    } else {
      applyTheme()
    }
  }
  #applyStoredTheme() {
    this.#theme = this.#storedTheme
  }
  #updateButtons() {
    const storedTheme = this.#storedTheme
    if (this.hasLightButtonTarget) { this.lightButtonTarget.checked = (storedTheme === "light") }
    if (this.hasDarkButtonTarget)  { this.darkButtonTarget.checked  = (storedTheme === "dark") }
    if (this.hasAutoButtonTarget)  { this.autoButtonTarget.checked  = (storedTheme !== "light" && storedTheme !== "dark") }
  }
}

================
File: app/javascript/controllers/timezone_cookie_controller.js
================
import { Controller } from "@hotwired/stimulus"
export default class extends Controller {
  connect() {
    this.#setTimezoneCookie()
  }
  #setTimezoneCookie() {
    const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone
    document.cookie = `timezone=${encodeURIComponent(timezone)}; path=/`
  }
}

================
File: app/javascript/controllers/toggle_class_controller.js
================
import { Controller } from "@hotwired/stimulus"
export default class extends Controller {
  static classes = [ "toggle" ]
  static targets = [ "checkbox" ]
  toggle() {
    this.element.classList.toggle(this.toggleClass)
  }
  add() {
    this.element.classList.add(this.toggleClass)
  }
  remove() {
    this.element.classList.remove(this.toggleClass)
  }
  checkAll() {
    this.checkboxTargets.forEach(checkbox => {
      checkbox.checked = true
    })
  }
  checkNone() {
    this.checkboxTargets.forEach(checkbox => {
      if (checkbox.dataset.boardsFormTarget === "meCheckbox") return
      checkbox.checked = false
    })
  }
}

================
File: app/javascript/controllers/toggle_enable_controller.js
================
import { Controller } from "@hotwired/stimulus"
export default class extends Controller {
  static targets = [ "element" ]
  toggle() {
    this.elementTargets.forEach((element) => {
      element.toggleAttribute("disabled")
    })
  }
}

================
File: app/javascript/controllers/tooltip_controller.js
================
import { Controller } from "@hotwired/stimulus"
import { orient } from "helpers/orientation_helpers"
export default class extends Controller {
  static targets = [ "tooltip" ]
  connect() {
    this.element.addEventListener("mouseenter", this.mouseEnter.bind(this))
    this.element.addEventListener("mouseout", this.mouseOut.bind(this))
  }
  disconnect() {
    this.element.removeEventListener("mouseenter", this.mouseEnter.bind(this))
    this.element.removeEventListener("mouseout", this.mouseOut.bind(this))
  }
  mouseEnter(event) {
    orient({ target: this.#tooltipElement, anchor: this.element })
  }
  mouseOut(event) {
    orient({ target: this.#tooltipElement, reset: true })
  }
  get #tooltipElement() {
    return this.element.querySelector(".for-screen-reader")
  }
  get #tooltipText() {
    return this.#tooltipElement.innerText
  }
}

================
File: app/javascript/controllers/touch_placeholder_controller.js
================
import { Controller } from "@hotwired/stimulus"
import { isTouchDevice } from "helpers/platform_helpers"
export default class extends Controller {
  static get shouldLoad() {
    return isTouchDevice()
  }
  static values = { placeholder: String }
  connect() {
    if (this.hasPlaceholderValue) {
      this.element.placeholder = this.placeholderValue
    }
  }
}

================
File: app/javascript/controllers/turbo_navigation_controller.js
================
import { Controller } from "@hotwired/stimulus"
export default class extends Controller {
  rememberLocation() {
    sessionStorage.setItem("referrerUrl", window.location.href)
  }
  backIfSamePath(event) {
    if (event.ctrlKey || event.metaKey || event.shiftKey) { return }
    const link = event.target.closest("a")
    const targetUrl = new URL(link.href)
    if (this.#referrerPath && targetUrl.pathname === this.#referrerPath) {
      event.preventDefault()
      Turbo.visit(this.#referrerUrl)
    }
  }
  get #referrerPath() {
    if (!this.#referrerUrl) return null
    return new URL(this.#referrerUrl).pathname
  }
  get #referrerUrl() {
    return sessionStorage.getItem("referrerUrl")
  }
}

================
File: app/javascript/controllers/upload_preview_controller.js
================
import { Controller } from "@hotwired/stimulus"
export default class extends Controller {
  static targets = [ "image", "input", "fileName", "placeholder" ]
  previewImage() {
    if (this.#file) {
      this.imageTarget.src = URL.createObjectURL(this.#file)
      this.imageTarget.onload = () => URL.revokeObjectURL(this.imageTarget.src)
    }
  }
  previewFileName() {
    this.#file ? this.#showFileName() : this.#showPlaceholder()
  }
  #showFileName() {
    this.fileNameTarget.innerHTML = this.#file.name
    this.fileNameTarget.removeAttribute("hidden")
    this.placeholderTarget.setAttribute("hidden", true)
  }
  #showPlaceholder() {
    this.placeholderTarget.removeAttribute("hidden")
    this.fileNameTarget.setAttribute("hidden", true)
  }
  get #file() {
    return this.inputTarget.files[0]
  }
}

================
File: app/javascript/helpers/bridge/viewport_helpers.js
================
let top = 0
const viewportTarget = window.visualViewport || window
export const viewport = {
  get top() {
    return top
  },
  get height() {
    return viewportTarget.height || window.innerHeight
  }
}
function update() {
  requestAnimationFrame(() => {
    const styles = getComputedStyle(document.documentElement)
    const customInset = styles.getPropertyValue("--custom-safe-inset-top")
    const fallbackInset = styles.getPropertyValue("--safe-area-inset-top")
    const insetValue = (customInset || fallbackInset).trim()
    top = parseInt(insetValue || "0", 10) || 0
  })
}
viewportTarget.addEventListener("resize", update)
update()

================
File: app/javascript/helpers/date_helpers.js
================
export function differenceInDays(fromDate, toDate) {
  return Math.round(Math.abs((beginningOfDay(toDate) - beginningOfDay(fromDate)) / (1000 * 60 * 60 * 24)))
}
export function signedDifferenceInDays(fromDate, toDate) {
  return Math.round((beginningOfDay(toDate) - beginningOfDay(fromDate)) / (1000 * 60 * 60 * 24))
}
export function beginningOfDay(date) {
  return new Date(date.getFullYear(), date.getMonth(), date.getDate())
}
export function secondsToDate(seconds) {
  return new Date(seconds * 1000)
}

================
File: app/javascript/helpers/form_helpers.js
================
import { FetchRequest } from "@rails/request.js"
export async function submitForm(form) {
  const request = new FetchRequest(form.method, form.action, {
    body: new FormData(form)
  })
  return await request.perform()
}

================
File: app/javascript/helpers/html_helpers.js
================
export function createElement(name, properties) {
  const element = document.createElement(name)
  for (var key in properties) {
    element.setAttribute(key, properties[key])
  }
  return element
}

================
File: app/javascript/helpers/orientation_helpers.js
================
const EDGE_THRESHOLD = 16
export function orient({ target, anchor = null, reset = false }) {
  target.classList.remove("orient-left", "orient-right")
  target.style.removeProperty("--orient-offset")
  if (reset) return
  const targetGeometry = geometry(target)
  const anchorGeometry = geometry(anchor)
  const shouldOrientLeft = targetGeometry.spaceOnRight < EDGE_THRESHOLD && targetGeometry.spaceOnRight < targetGeometry.spaceOnLeft
  const shouldOrientRight = targetGeometry.spaceOnLeft < EDGE_THRESHOLD && targetGeometry.spaceOnLeft < targetGeometry.spaceOnRight
  if (shouldOrientLeft) {
    orientLeft({ el: target, targetGeometry, anchorGeometry })
  } else if (shouldOrientRight) {
    orientRight({ el: target, targetGeometry, anchorGeometry })
  }
}
function orientLeft({ el, targetGeometry, anchorGeometry }) {
  const offset = Math.min(0, anchorGeometry.spaceOnLeft + anchorGeometry.width - targetGeometry.width) * -1
  el.classList.add("orient-left")
  el.style.setProperty("--orient-offset", `${offset}px`)
}
function orientRight({ el, targetGeometry, anchorGeometry }) {
  const offset = Math.max(0, anchorGeometry.spaceOnLeft + targetGeometry.width - window.innerWidth) * -1
  el.classList.add("orient-right")
  el.style.setProperty("--orient-offset", `${offset}px`)
}
function geometry(el) {
  const rect = el.getBoundingClientRect()
  return {
    spaceOnLeft: rect.left,
    spaceOnRight: window.innerWidth - rect.right,
    width: rect.width
  }
}

================
File: app/javascript/helpers/platform_helpers.js
================
export function isTouchDevice() {
  return "ontouchstart" in window && navigator.maxTouchPoints > 0
}
export function isIos() {
  return /iPhone|iPad/.test(navigator.userAgent)
}
export function isAndroid() {
  return /Android/.test(navigator.userAgent)
}
export function isMobile() {
  return isIos() || isAndroid()
}
export function isNative() {
  return /Hotwire Native/.test(navigator.userAgent)
}

================
File: app/javascript/helpers/scroll_helpers.js
================
export async function keepingScrollPosition(element, promise) {
  const originalPosition = element.getBoundingClientRect()
  await promise
  const currentPosition = element.getBoundingClientRect()
  const yDiff = currentPosition.top - originalPosition.top
  const xDiff = currentPosition.left - originalPosition.left
  findNearestScrollableYAncestor(element).scrollTop += yDiff
  findNearestScrollableXAncestor(element).scrollLeft += xDiff
}
export function isFullyVisible(element, container = document.documentElement) {
  const elementRect = element.getBoundingClientRect()
  const containerRect = container.getBoundingClientRect()
  return elementRect.top >= containerRect.top &&
    elementRect.bottom <= containerRect.bottom &&
    elementRect.left >= containerRect.left &&
    elementRect.right <= containerRect.right
}
export function isScrolledToBottom(element, threshold = 100) {
  return (element.scrollHeight - element.scrollTop - element.clientHeight) < threshold
}
export function scrollToBottom(element) {
  element.scrollTop = element.scrollHeight
}
export function scrollIntoView(element, options = { inline: "center", block: "center", behavior: "instant" }) {
  element.scrollIntoView(options)
}
// Private
function findNearestScrollableYAncestor(refElement) {
  return findNearest(refElement, (element) => {
    const largerThanVisibleArea = element.scrollHeight > element.clientHeight
    const overflowY = getComputedStyle(element).overflowY
    const scrollableStyle = overflowY === "scroll" || overflowY === "auto"
    return largerThanVisibleArea && scrollableStyle
  })
}
function findNearestScrollableXAncestor(refElement) {
  return findNearest(refElement, (element) => {
    const largerThanVisibleArea = element.scrollWidth > element.clientWidth
    const overflowX = getComputedStyle(element).overflowX
    const scrollableStyle = overflowX === "scroll" || overflowX === "auto"
    return largerThanVisibleArea && scrollableStyle
  })
}
function findNearest(element, fn) {
  while (element) {
    if (fn(element)) {
      return element
    } else {
      element = element.parentElement
    }
  }
  return document.documentElement
}

================
File: app/javascript/helpers/text_helpers.js
================
export function isMultiLineString(string) {
  return /\r|\n/.test(string)
}
export function normalizeFilteredText(string) {
  return string
    .toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // Remove diacritics
}
export function filterMatches(text, potentialMatch) {
  return normalizeFilteredText(text).includes(normalizeFilteredText(potentialMatch))
}
export function toSentence(array, options = {}) {
  const defaultConnectors = {
    words_connector: ", ",
    two_words_connector: " and ",
    last_word_connector: ", and "
  }
  const connectors = { ...defaultConnectors, ...options }
  if (array.length === 0) {
    return ""
  }
  if (array.length === 1) {
    return array[0]
  }
  if (array.length === 2) {
    return array.join(connectors.two_words_connector)
  }
  return array.slice(0, -1).join(connectors.words_connector) + connectors.last_word_connector + array[array.length - 1]
}

================
File: app/javascript/helpers/timing_helpers.js
================
export function throttle(fn, delay = 1000) {
  let timeoutId = null
  return (...args) => {
    if (!timeoutId) {
      fn(...args)
      timeoutId = setTimeout(() => timeoutId = null, delay)
    }
  }
}
export function debounce(fn, delay = 1000) {
  let timeoutId = null
  return (...args) => {
    clearTimeout(timeoutId)
    timeoutId = setTimeout(() => fn.apply(this, args), delay)
  }
}
export function nextEventLoopTick() {
  return delay(0)
}
export function onNextEventLoopTick(callback) {
  setTimeout(callback, 0)
}
export function nextEvent(element, eventName) {
  return new Promise(resolve => element.addEventListener(eventName, resolve, { once: true }))
}
export function nextFrame() {
  return new Promise(requestAnimationFrame)
}
export function nextEventNamed(eventName, element = window) {
  return new Promise(resolve => element.addEventListener(eventName, resolve, { once: true }))
}
export function delay(ms) {
  return new Promise(resolve => setTimeout(resolve, ms))
}

================
File: app/javascript/initializers/bridge/bridge_element.js
================
import { BridgeElement } from "@hotwired/hotwire-native-bridge"
BridgeElement.prototype.getButton = function() {
  return {
    title: this.title,
    icon: this.getIcon()
  }
}
BridgeElement.prototype.getIcon = function() {
  const url = this.bridgeAttribute(`icon-url`)
  if (url) {
    return { url }
  }
  return null
}

================
File: app/javascript/initializers/current.js
================
class Current {
  get user() {
    const currentUserId = this.#extractContentFromMetaTag("current-user-id")
    if (currentUserId) {
      return { id: currentUserId }
    }
  }
  #extractContentFromMetaTag(name) {
    return document.head.querySelector(`meta[name="${name}"]`)?.getAttribute("content")
  }
}
window.Current = new Current()

================
File: app/javascript/initializers/index.js
================
import "initializers/current"
import "initializers/bridge/bridge_element"

================
File: app/javascript/application.js
================
// Configure your import map in config/importmap.rb. Read more: https://github.com/rails/importmap-rails
import "@hotwired/turbo-rails"
import "@hotwired/hotwire-native-bridge"
import "initializers"
import "controllers"
import "lexxy"
import "@rails/actiontext"

================
File: app/jobs/account/data_import_job.rb
================
class Account::DataImportJob < ApplicationJob
  include ActiveJob::Continuable
  queue_as :backend
  discard_on Account::DataTransfer::RecordSet::IntegrityError, ZipFile::InvalidFileError
  def perform(import)
    step :check do |step|
      import.check \
        start: step.cursor,
        callback: ->(record_set:, file:) { step.set!([ record_set.model.name, file ]) }
    end
    step :process do |step|
      import.process \
        start: step.cursor,
        callback: ->(record_set:, files:) { step.set!([ record_set.model.name, files.last ]) }
    end
  end
end

================
File: app/jobs/account/incinerate_due_job.rb
================
class Account::IncinerateDueJob < ApplicationJob
  include ActiveJob::Continuable
  queue_as :incineration
  def perform
    step :incineration do |step|
      Account.due_for_incineration.find_each do |account|
        account.incinerate
        step.checkpoint!
      end
    end
  end
end

================
File: app/jobs/board/clean_inaccessible_data_job.rb
================
class Board::CleanInaccessibleDataJob < ApplicationJob
  discard_on ActiveJob::DeserializationError
  def perform(user, board)
    board.clean_inaccessible_data_for(user)
  end
end

================
File: app/jobs/card/activity_spike/detection_job.rb
================
class Card::ActivitySpike::DetectionJob < ApplicationJob
  discard_on ActiveJob::DeserializationError
  def perform(card)
    card.detect_activity_spikes
  end
end

================
File: app/jobs/card/clean_inaccessible_data_job.rb
================
class Card::CleanInaccessibleDataJob < ApplicationJob
  discard_on ActiveJob::DeserializationError
  def perform(card)
    card.clean_inaccessible_data
  end
end

================
File: app/jobs/card/remove_inaccessible_notifications_job.rb
================
class Card::RemoveInaccessibleNotificationsJob < ApplicationJob
  discard_on ActiveJob::DeserializationError
  def perform(card)
    card.remove_inaccessible_notifications
  end
end

================
File: app/jobs/concerns/smtp_delivery_error_handling.rb
================
module SmtpDeliveryErrorHandling
  extend ActiveSupport::Concern
  included do
    # Retry delivery to possibly-unavailable remote mailservers.
    retry_on Net::OpenTimeout, Net::ReadTimeout, Socket::ResolutionError, wait: :polynomially_longer
    # Net::SMTPServerBusy is SMTP error code 4xx, a temporary error.
    # Common one we've seen is 452 4.3.1 Insufficient system storage.
    # Patiently retry.
    retry_on Net::SMTPServerBusy, wait: :polynomially_longer
    # SMTP error 50x.
    rescue_from Net::SMTPSyntaxError do |error|
      case error.message
      when /\A501 5\.1\.3/
        # Ignore undeliverable email addresses.
        Sentry.capture_exception error, level: :info if Fizzy.saas?
      else
        raise
      end
    end
    # SMTP error 5xx except 50x and 53x.
    # * 550 5.1.1: Unknown users
    # * 552 5.6.0: Message/headers too large
    rescue_from Net::SMTPFatalError do |error|
      case error.message
      when /\A550 5\.1\.1/, /\A552 5\.6\.0/, /\A555 5\.5\.4/
        Sentry.capture_exception error, level: :info if Fizzy.saas?
      else
        raise
      end
    end
  end
end

================
File: app/jobs/event/webhook_dispatch_job.rb
================
require "active_job/continuable"
class Event::WebhookDispatchJob < ApplicationJob
  include ActiveJob::Continuable
  queue_as :webhooks
  discard_on ActiveJob::DeserializationError
  def perform(event)
    step :dispatch do |step|
      Webhook.active.triggered_by(event).find_each(start: step.cursor) do |webhook|
        webhook.trigger(event)
        step.advance! from: webhook.id
      end
    end
  end
end

================
File: app/jobs/mention/create_job.rb
================
class Mention::CreateJob < ApplicationJob
  discard_on ActiveJob::DeserializationError
  def perform(record, mentioner:)
    record.create_mentions(mentioner:)
  end
end

================
File: app/jobs/notification/bundle/deliver_all_job.rb
================
class Notification::Bundle::DeliverAllJob < ApplicationJob
  queue_as :backend
  discard_on ActiveJob::DeserializationError
  def perform
    Notification::Bundle.deliver_all
  end
end

================
File: app/jobs/notification/bundle/deliver_job.rb
================
class Notification::Bundle::DeliverJob < ApplicationJob
  include SmtpDeliveryErrorHandling
  queue_as :backend
  discard_on ActiveJob::DeserializationError
  def perform(bundle)
    bundle.deliver
  end
end

================
File: app/jobs/storage/materialize_job.rb
================
class Storage::MaterializeJob < ApplicationJob
  queue_as :backend
  limits_concurrency to: 1, key: ->(owner) { owner }
  discard_on ActiveJob::DeserializationError
  def perform(owner)
    owner.materialize_storage
  end
end

================
File: app/jobs/storage/reconcile_job.rb
================
class Storage::ReconcileJob < ApplicationJob
  class ReconcileAborted < StandardError; end
  queue_as :backend
  limits_concurrency to: 1, key: ->(owner) { owner }
  discard_on ActiveJob::DeserializationError
  retry_on ReconcileAborted, wait: 1.minute, attempts: 3
  def perform(owner)
    raise ReconcileAborted, "Could not get stable snapshot for #{owner.class}##{owner.id}" unless owner.reconcile_storage
  end
end

================
File: app/jobs/webhook/delivery_job.rb
================
class Webhook::DeliveryJob < ApplicationJob
  queue_as :webhooks
  discard_on ActiveJob::DeserializationError
  def perform(delivery)
    delivery.deliver
  end
end

================
File: app/jobs/application_job.rb
================
class ApplicationJob < ActiveJob::Base
  # Automatically retry jobs that encountered a deadlock
  # retry_on ActiveRecord::Deadlocked
  # Most jobs are safe to ignore if the underlying records are no longer available
  # discard_on ActiveJob::DeserializationError
end

================
File: app/jobs/data_export_job.rb
================
class DataExportJob < ApplicationJob
  queue_as :backend
  discard_on ActiveJob::DeserializationError
  def perform(export)
    export.build
  end
end

================
File: app/jobs/delete_unused_tags_job.rb
================
class DeleteUnusedTagsJob < ApplicationJob
  def perform
    Tag.unused.find_each do |tag|
      tag.destroy!
    end
  end
end

================
File: app/jobs/notify_recipients_job.rb
================
class NotifyRecipientsJob < ApplicationJob
  discard_on ActiveJob::DeserializationError
  def perform(notifiable)
    notifiable.notify_recipients
  end
end

================
File: app/jobs/push_notification_job.rb
================
class PushNotificationJob < ApplicationJob
  discard_on ActiveJob::DeserializationError
  def perform(notification)
    NotificationPusher.new(notification).push
  end
end

================
File: app/mailers/concerns/mailers/unsubscribable.rb
================
module Mailers::Unsubscribable
  extend ActiveSupport::Concern
  included do
    after_action :set_unsubscribe_headers
  end
  def set_unsubscribe_headers
    headers["List-Unsubscribe-Post"] = "List-Unsubscribe=One-Click"
    headers["List-Unsubscribe"]      = "<#{notifications_unsubscribe_url(access_token: @unsubscribe_token)}>"
  end
end

================
File: app/mailers/notification/bundle_mailer.rb
================
class Notification::BundleMailer < ApplicationMailer
  include Mailers::Unsubscribable
  helper NotificationsHelper
  def notification(bundle)
    @user = bundle.user
    @bundle = bundle
    @notifications = bundle.notifications
    @unsubscribe_token = @user.generate_token_for(:unsubscribe)
    mail \
      to: bundle.user.identity.email_address,
      subject: "Fizzy#{ " (#{ Current.account.name })" if @user.identity.accounts.many? }: New notifications"
  end
end

================
File: app/mailers/account_mailer.rb
================
class AccountMailer < ApplicationMailer
  def cancellation(cancellation)
    @account = cancellation.account
    @user = cancellation.initiated_by
    mail(
      to: @user.identity.email_address,
      subject: "Your Fizzy account was cancelled"
    )
  end
end

================
File: app/mailers/application_mailer.rb
================
class ApplicationMailer < ActionMailer::Base
  default from: ENV.fetch("MAILER_FROM_ADDRESS", "Fizzy <support@fizzy.do>")
  layout "mailer"
  append_view_path Rails.root.join("app/views/mailers")
  helper AvatarsHelper, HtmlHelper
  private
    def default_url_options
      if Current.account
        super.merge(script_name: Current.account.slug)
      else
        super
      end
    end
end

================
File: app/mailers/export_mailer.rb
================
class ExportMailer < ApplicationMailer
  helper_method :export_download_url
  def completed(export)
    @export = export
    @user = export.user
    mail to: @user.identity.email_address, subject: "Your Fizzy data export is ready for download"
  end
  private
    def export_download_url(export)
      if export.is_a?(User::DataExport)
        user_data_export_url(export.user, export)
      else
        account_export_url(export)
      end
    end
end

================
File: app/mailers/import_mailer.rb
================
class ImportMailer < ApplicationMailer
  def completed(identity, account)
    @account = account
    mail to: identity.email_address, subject: "Your Fizzy account import is done"
  end
  def failed(identity)
    mail to: identity.email_address, subject: "Your Fizzy account import failed"
  end
end

================
File: app/mailers/magic_link_mailer.rb
================
class MagicLinkMailer < ApplicationMailer
  def sign_in_instructions(magic_link)
    @magic_link = magic_link
    @identity = @magic_link.identity
    mail to: @identity.email_address, subject: "Your Fizzy code is #{ @magic_link.code }"
  end
end

================
File: app/mailers/user_mailer.rb
================
class UserMailer < ApplicationMailer
  def email_change_confirmation(email_address:, token:, user:)
    @token = token
    @user = user
    mail to: email_address, subject: "Confirm your new email address"
  end
end

================
File: app/models/account/data_transfer/account_record_set.rb
================
class Account::DataTransfer::AccountRecordSet < Account::DataTransfer::RecordSet
  ACCOUNT_ATTRIBUTES = %w[
    join_code
    name
  ]
  JOIN_CODE_ATTRIBUTES = %w[
    code
    usage_count
    usage_limit
  ]
  def initialize(account)
    super(account: account, model: Account)
  end
  private
    def records
      [ account ]
    end
    def export_record(account)
      zip.add_file "data/account.json", account.as_json.merge(join_code: account.join_code.as_json).to_json
    end
    def files
      [ "data/account.json" ]
    end
    def import_batch(files)
      account_data = load(files.first)
      join_code_data = account_data.delete("join_code")
      account.update!(name: account_data.fetch("name"))
      account.join_code.update!(join_code_data.slice("usage_count", "usage_limit"))
      account.join_code.update(code: join_code_data.fetch("code"))
    end
    def check_record(file_path)
      data = load(file_path)
      unless (ACCOUNT_ATTRIBUTES - data.keys).empty?
        raise IntegrityError, "Account record missing required fields"
      end
      unless data.key?("join_code")
        raise IntegrityError, "Account record missing 'join_code' field"
      end
      unless data["join_code"].is_a?(Hash)
        raise IntegrityError, "'join_code' field must be a JSON object"
      end
      unless (JOIN_CODE_ATTRIBUTES - data["join_code"].keys).empty?
        raise IntegrityError, "'join_code' field missing required keys"
      end
    end
end

================
File: app/models/account/data_transfer/action_text_rich_text_record_set.rb
================
class Account::DataTransfer::ActionTextRichTextRecordSet < Account::DataTransfer::RecordSet
  ATTRIBUTES = %w[
    account_id
    body
    created_at
    id
    name
    record_id
    record_type
    updated_at
  ].freeze
  def initialize(account)
    super(account: account, model: ActionText::RichText)
  end
  private
    def records
      ActionText::RichText.where(account: account)
    end
    def export_record(rich_text)
      data = rich_text.as_json.merge("body" => convert_sgids_to_gids(rich_text.body))
      zip.add_file "data/action_text_rich_texts/#{rich_text.id}.json", data.to_json
    end
    def files
      zip.glob("data/action_text_rich_texts/*.json")
    end
    def import_batch(files)
      batch_data = files.map do |file|
        data = load(file)
        data["body"] = convert_gids_to_sgids(data["body"])
        data.slice(*ATTRIBUTES).merge("account_id" => account.id)
      end
      ActionText::RichText.insert_all!(batch_data)
    end
    def check_record(file_path)
      data = load(file_path)
      expected_id = File.basename(file_path, ".json")
      unless data["id"].to_s == expected_id
        raise IntegrityError, "ActionTextRichText record ID mismatch: expected #{expected_id}, got #{data['id']}"
      end
      missing = ATTRIBUTES - data.keys
      if missing.any?
        raise IntegrityError, "#{file_path} is missing required fields: #{missing.join(', ')}"
      end
      check_associations_dont_exist(data)
    end
    def convert_sgids_to_gids(content)
      return nil if content.blank?
      content.send(:attachment_nodes).each do |node|
        sgid = SignedGlobalID.parse(node["sgid"], for: ActionText::Attachable::LOCATOR_NAME)
        record = begin
          sgid&.find
        rescue ActiveRecord::RecordNotFound
          nil
        end
        if record&.account_id == account.id
          node["gid"] = record.to_global_id.to_s
          node.remove_attribute("sgid")
        end
      end
      content.fragment.source.to_html
    end
    def convert_gids_to_sgids(html)
      return html if html.blank?
      fragment = Nokogiri::HTML.fragment(html)
      fragment.css("action-text-attachment[gid]").each do |node|
        gid = GlobalID.parse(node["gid"])
        if gid
          record = gid.find
          node["sgid"] = record.attachable_sgid
          node.remove_attribute("gid")
        end
      end
      fragment.to_html
    end
end

================
File: app/models/account/data_transfer/active_storage_blob_record_set.rb
================
class Account::DataTransfer::ActiveStorageBlobRecordSet < Account::DataTransfer::RecordSet
  def initialize(account)
    super(
      account: account,
      model: ActiveStorage::Blob,
      attributes: ActiveStorage::Blob.column_names - %w[service_name]
    )
  end
  private
    def import_batch(files)
      batch_data = files.map do |file|
        data = load(file)
        data.slice(*attributes).merge(
          "account_id" => account.id,
          "service_name" => ActiveStorage::Blob.service.name
        )
      end
      model.insert_all!(batch_data)
    end
end

================
File: app/models/account/data_transfer/blob_file_record_set.rb
================
class Account::DataTransfer::BlobFileRecordSet < Account::DataTransfer::RecordSet
  def initialize(account)
    super(account: account, model: ActiveStorage::Blob)
  end
  private
    def records
      ActiveStorage::Blob.where(account: account)
    end
    def export_record(blob)
      if blob.service.exist?(blob.key)
        zip.add_file("storage/#{blob.key}", compress: false) do |out|
          blob.download { |chunk| out.write(chunk) }
        end
      end
    end
    def files
      zip.glob("storage/*")
    end
    def import_batch(files)
      files.each do |file|
        key = File.basename(file)
        blob = ActiveStorage::Blob.find_by(key: key, account: account)
        next unless blob
        zip.read(file) do |stream|
          blob.upload(stream)
        end
      end
    end
    def check_record(file_path)
      key = File.basename(file_path)
      unless zip.exists?("data/active_storage_blobs/#{key}.json") || ActiveStorage::Blob.exists?(key: key, account: account)
        # File exists without corresponding blob record - could be orphaned or blob not yet imported
        # We allow this since blob metadata is imported before files
      end
    end
end

================
File: app/models/account/data_transfer/entropy_record_set.rb
================
class Account::DataTransfer::EntropyRecordSet < Account::DataTransfer::RecordSet
  def initialize(account)
    super(account: account, model: Entropy)
  end
  private
    def import_batch(files)
      batch_data = files.map do |file|
        data = load(file)
        data.slice(*attributes).merge("account_id" => account.id)
      end
      container_keys = batch_data.map { |d| [ d["container_type"], d["container_id"] ] }
      existing_containers = Entropy
        .where(account_id: account.id)
        .where(container_type: container_keys.map(&:first), container_id: container_keys.map(&:last))
        .pluck(:container_type, :container_id)
        .to_set
      to_update, to_insert = batch_data.partition do |data|
        existing_containers.include?([ data["container_type"], data["container_id"] ])
      end
      to_update.each do |data|
        Entropy
          .find_by(account_id: account.id, container_type: data["container_type"], container_id: data["container_id"])
          .update!(data.slice("auto_postpone_period"))
      end
      Entropy.insert_all!(to_insert) if to_insert.any?
    end
end

================
File: app/models/account/data_transfer/manifest.rb
================
class Account::DataTransfer::Manifest
  attr_reader :account
  def initialize(account)
    @account = account
  end
  def each_record_set(start: nil)
    raise ArgumentError, "No block given" unless block_given?
    started = start.nil?
    record_class, last_id = start if start
    record_sets.each do |record_set|
      if started
        yield record_set
      elsif record_set.model.name == record_class
        started = true
        yield record_set, last_id
      end
    end
  end
  private
    def record_sets
      [
        Account::DataTransfer::AccountRecordSet.new(account),
        Account::DataTransfer::UserRecordSet.new(account),
        *build_record_sets(::User::Settings, ::Tag, ::Board, ::Column),
        Account::DataTransfer::EntropyRecordSet.new(account),
        *build_record_sets(
          ::Board::Publication, ::Webhook, ::Access, ::Card, ::Comment, ::Step,
          ::Assignment, ::Tagging, ::Closure, ::Card::Goldness, ::Card::NotNow,
          ::Card::ActivitySpike, ::Watch, ::Pin, ::Reaction, ::Mention,
          ::Filter, ::Webhook::DelinquencyTracker, ::Event,
          ::Notification, ::Notification::Bundle, ::Webhook::Delivery
        ),
        Account::DataTransfer::ActiveStorageBlobRecordSet.new(account),
        *build_record_sets(::ActiveStorage::Attachment),
        Account::DataTransfer::ActionTextRichTextRecordSet.new(account),
        Account::DataTransfer::BlobFileRecordSet.new(account)
      ]
    end
    def build_record_sets(*models)
      models.map do |model|
        Account::DataTransfer::RecordSet.new(account: account, model: model)
      end
    end
end

================
File: app/models/account/data_transfer/record_set.rb
================
class Account::DataTransfer::RecordSet
  class IntegrityError < StandardError; end
  IMPORT_BATCH_SIZE = 100
  attr_reader :account, :model, :attributes
  def initialize(account:, model:, attributes: nil)
    @account = account
    @model = model
    @attributes = (attributes || model.column_names).map(&:to_s)
  end
  def export(to:, start: nil)
    with_zip(to) do
      block = lambda do |record|
        export_record(record)
      end
      records.respond_to?(:find_each) ? records.find_each(&block) : records.each(&block)
    end
  end
  def import(from:, start: nil, callback: nil)
    with_zip(from) do
      file_list = files
      file_list = skip_to(file_list, start) if start
      file_list.each_slice(IMPORT_BATCH_SIZE) do |file_batch|
        import_batch(file_batch)
        callback&.call(record_set: self, files: file_batch)
      end
    end
  end
  def check(from:, start: nil, callback: nil)
    with_zip(from) do
      file_list = files
      file_list = skip_to(file_list, start) if start
      file_list.each do |file_path|
        check_record(file_path)
        callback&.call(record_set: self, file: file_path)
      end
    end
  end
  private
    attr_reader :zip
    def with_zip(zip)
      old_zip = @zip
      @zip = zip
      yield
    ensure
      @zip = old_zip
    end
    def records
      model.where(account_id: account.id)
    end
    def export_record(record)
      zip.add_file "data/#{model_dir}/#{record.id}.json", record.to_json
    end
    def files
      zip.glob("data/#{model_dir}/*.json")
    end
    def import_batch(files)
      batch_data = files.map do |file|
        data = load(file)
        data.slice(*attributes).merge("account_id" => account.id).tap do |record_data|
          record_data["updated_at"] = Time.current if record_data.key?("updated_at")
        end
      end
      model.insert_all!(batch_data)
    end
    def check_record(file_path)
      data = load(file_path)
      expected_id = File.basename(file_path, ".json")
      unless data["id"].to_s == expected_id
        raise IntegrityError, "#{model} record ID mismatch: expected #{expected_id}, got #{data['id']}"
      end
      missing = attributes - data.keys
      if missing.any?
        raise IntegrityError, "#{file_path} is missing required fields: #{missing.join(', ')}"
      end
      if model.exists?(id: data["id"])
        raise IntegrityError, "#{model} record with ID #{data['id']} already exists"
      end
      check_associations_dont_exist(data)
    end
    def check_associations_dont_exist(data)
      model.reflect_on_all_associations(:belongs_to).each do |association|
        foreign_key = association.foreign_key.to_s
        if associated_id = data[foreign_key]
          check_association_doesnt_exist(data, association, associated_id)
        end
      end
    end
    def check_association_doesnt_exist(data, association, associated_id)
      if association.polymorphic?
        type_column = association.foreign_type.to_s
        associated_class = data[type_column].constantize
      else
        associated_class = association.klass
      end
      if associated_class.exists?(id: associated_id)
        raise IntegrityError, "#{model} record references existing #{association.name} (#{associated_class}) with ID #{associated_id}"
      end
    end
    def skip_to(file_list, last_id)
      index = file_list.index(last_id)
      if index
        file_list[(index + 1)..]
      else
        file_list
      end
    end
    def load(file_path)
      JSON.parse(zip.read(file_path))
    rescue ArgumentError => e
      raise IntegrityError, e.message
    end
    def model_dir
      model.table_name
    end
end

================
File: app/models/account/data_transfer/user_record_set.rb
================
class Account::DataTransfer::UserRecordSet < Account::DataTransfer::RecordSet
  ATTRIBUTES = %w[
    id
    email_address
    name
    role
    active
    verified_at
    created_at
    updated_at
  ]
  def initialize(account)
    super(account: account, model: User)
  end
  private
    def records
      User.where(account: account)
    end
    def export_record(user)
      zip.add_file "data/users/#{user.id}.json", user.as_json.merge(email_address: user.identity&.email_address).to_json
    end
    def files
      zip.glob("data/users/*.json")
    end
    def import_batch(files)
      batch_data = files.map do |file|
        user_data = load(file)
        email_address = user_data.delete("email_address")
        identity = Identity.find_or_create_by!(email_address: email_address) if email_address.present?
        user_data.slice(*ATTRIBUTES).merge(
          "account_id" => account.id,
          "identity_id" => identity&.id
        )
      end
      conflicting_identity_ids = batch_data.pluck("identity_id").compact
      account.users.where(identity_id: conflicting_identity_ids).destroy_all
      User.insert_all!(batch_data)
    end
    def check_record(file_path)
      data = load(file_path)
      expected_id = File.basename(file_path, ".json")
      unless data["id"].to_s == expected_id
        raise IntegrityError, "User record ID mismatch: expected #{expected_id}, got #{data['id']}"
      end
      unless (ATTRIBUTES - data.keys).empty?
        raise IntegrityError, "#{file_path} is missing required fields"
      end
    end
end

================
File: app/models/account/cancellable.rb
================
module Account::Cancellable
  extend ActiveSupport::Concern
  included do
    has_one :cancellation, dependent: :destroy
    define_callbacks :cancel
    define_callbacks :reactivate
  end
  def cancel(initiated_by: Current.user)
    with_lock do
      if cancellable? && active?
        run_callbacks :cancel do
          create_cancellation!(initiated_by: initiated_by)
        end
        AccountMailer.cancellation(cancellation).deliver_later
      end
    end
  end
  def reactivate
    with_lock do
      if cancelled?
        run_callbacks :reactivate do
          cancellation.destroy
        end
      end
    end
  end
  def cancelled?
    cancellation.present?
  end
  def cancellable?
    Account.accepting_signups?
  end
end

================
File: app/models/account/cancellation.rb
================
class Account::Cancellation < ApplicationRecord
  belongs_to :account
  belongs_to :initiated_by, class_name: "User"
end

================
File: app/models/account/entropic.rb
================
module Account::Entropic
  extend ActiveSupport::Concern
  DEFAULT_ENTROPY_PERIOD = 30.days
  included do
    has_one :entropy, as: :container, dependent: :destroy
    after_create -> { create_entropy!(auto_postpone_period: DEFAULT_ENTROPY_PERIOD, account: self) }
  end
end

================
File: app/models/account/export.rb
================
class Account::Export < Export
  private
    def filename
      "fizzy-account-#{account_id}-export-#{id}.zip"
    end
    def populate_zip(zip)
      Account::DataTransfer::Manifest.new(account).each_record_set do |record_set|
        record_set.export(to: zip)
      end
    end
end

================
File: app/models/account/external_id_sequence.rb
================
# Provides sequential IDs for +external_account_id+ when creating accounts without one.
class Account::ExternalIdSequence < ApplicationRecord
  class << self
    def next
      with_lock do |sequence|
        sequence.increment!(:value).value
      end
    end
    def value
      first&.value || self.next
    end
    private
      def with_lock
        transaction do
          sequence = lock.first_or_create!(value: initial_value)
          yield sequence
        end
      end
      def initial_value
        Account.maximum(:external_account_id) || 0
      end
  end
end

================
File: app/models/account/import.rb
================
class Account::Import < ApplicationRecord
  broadcasts_refreshes
  belongs_to :account
  belongs_to :identity
  has_one_attached :file
  enum :status, %w[ pending processing completed failed ].index_by(&:itself), default: :pending
  scope :expired, -> { where(completed_at: ...24.hours.ago).or(where(status: :failed, created_at: ...7.days.ago)) }
  def self.cleanup
    expired.each(&:cleanup)
  end
  def process_later
    Account::DataImportJob.perform_later(self)
  end
  def check(start: nil, callback: nil)
    processing!
    ZipFile.read_from(file.blob) do |zip|
      Account::DataTransfer::Manifest.new(account).each_record_set(start: start) do |record_set, last_id|
        record_set.check(from: zip, start: last_id, callback: callback)
      end
    end
  rescue => e
    mark_as_failed
    raise e
  end
  def process(start: nil, callback: nil)
    processing!
    ZipFile.read_from(file.blob) do |zip|
      Account::DataTransfer::Manifest.new(account).each_record_set(start: start) do |record_set, last_id|
        record_set.import(from: zip, start: last_id, callback: callback)
      end
    end
    add_importer_to_all_access_boards
    reconcile_account_storage
    mark_completed
  rescue => e
    mark_as_failed
    raise e
  end
  def cleanup
    destroy
    account.destroy if failed?
  end
  private
    def mark_completed
      update!(status: :completed, completed_at: Time.current)
      ImportMailer.completed(identity, account).deliver_later
    end
    def mark_as_failed
      failed!
      ImportMailer.failed(identity).deliver_later
    end
    def add_importer_to_all_access_boards
      importer = account.users.find_by!(identity: identity)
      account.boards.all_access.find_each do |board|
        board.accesses.grant_to(importer)
      end
    end
    def reconcile_account_storage
      account.boards.each(&:reconcile_storage)
      account.reconcile_storage
      account.materialize_storage
    end
end

================
File: app/models/account/incineratable.rb
================
module Account::Incineratable
  extend ActiveSupport::Concern
  INCINERATION_GRACE_PERIOD = 30.days
  included do
    scope :due_for_incineration, -> { joins(:cancellation).where(account_cancellations: { created_at: ...INCINERATION_GRACE_PERIOD.ago }) }
    define_callbacks :incinerate
  end
  def incinerate
    run_callbacks :incinerate do
      account.destroy
    end
  end
end

================
File: app/models/account/join_code.rb
================
class Account::JoinCode < ApplicationRecord
  CODE_LENGTH = 12
  USAGE_LIMIT_MAX = 10_000_000_000
  belongs_to :account
  validates :usage_limit, numericality: { less_than_or_equal_to: USAGE_LIMIT_MAX, message: "cannot be larger than the population of the planet" }
  scope :active, -> { where("usage_count < usage_limit") }
  before_create :generate_code, if: -> { code.blank? }
  def redeem_if(&block)
    with_lock do
      increment!(:usage_count) if active? && block.call(account)
    end
  end
  def active?
    usage_count < usage_limit
  end
  def reset
    generate_code
    self.usage_count = 0
    save!
  end
  private
    def generate_code
      self.code = loop do
        candidate = SecureRandom.base58(CODE_LENGTH).scan(/.{4}/).join("-")
        break candidate unless self.class.exists?(code: candidate)
      end
    end
end

================
File: app/models/account/multi_tenantable.rb
================
module Account::MultiTenantable
  extend ActiveSupport::Concern
  included do
    cattr_accessor :multi_tenant, default: false
  end
  class_methods do
    def accepting_signups?
      multi_tenant || Account.none?
    end
  end
end

================
File: app/models/account/seedeable.rb
================
module Account::Seedeable
  extend ActiveSupport::Concern
  def setup_customer_template
    Account::Seeder.new(self, users.admin.first).seed
  end
end

================
File: app/models/account/seeder.rb
================
class Account::Seeder
  attr_reader :account, :creator
  def initialize(account, creator)
    @account = account
    @creator = creator
  end
  def seed
    Current.set(user: creator, account: account) do
      populate
    end
  end
  def seed!
    raise "You can't run in production environments" unless Rails.env.local?
    delete_everything
    seed
  end
  private
    def populate
      # ---------------
      # Playground Board
      # ---------------
      playground = account.boards.create! name: "Playground", creator: creator, all_access: true
      playground.update! auto_postpone_period: 365.days
      # Cards
      playground.cards.create! creator: creator, title: "Finally, watch this Fizzy orientation video", status: "published", description: <<~HTML
        <p>Theres a whole lot more you can do in Fizzy. In the video below, 37signals founder and CEO, Jason Fried, will walk you through the basics in just 17 minutes.</p>
        <action-text-attachment url="https://videos.37signals.com/fizzy/assets/videos/fizzyorientation-4k.mp4" caption="Fizzy orientation" content-type="video/mp4" filename="fizzyorientation-4k.mp4"></action-text-attachment>
      HTML
      playground.cards.create! creator: creator, title: "Now, grab the invite link to invite someone else", status: "published", description: <<~HTML
        <p>Open the Fizzy menu, select <b><strong>+ Add people</b></strong>, then copy the invite link. You can give this link to someone else so they can make a login for themselves in your account.</p>
        <action-text-attachment url="https://videos.37signals.com/fizzy/assets/images/invite-link.gif" alt="Demo of copying invite link" caption="Get a link to invite co-workers" content-type="image/*" filename="invite-link.gif" presentation="gallery"></action-text-attachment>
      HTML
      playground.cards.create! creator: creator, title: "Then, head back home to check out activity", status: "published", description: <<~HTML
        <p>Hit 1 or pull down the Fizzy menu and select Home.</p>
        <action-text-attachment url="https://videos.37signals.com/fizzy/assets/images/back-to-home.gif" alt="Demo of visiting Home" caption="Go back to Home for Latest Activity" content-type="image/*" filename="back-to-home.gif" presentation="gallery"></action-text-attachment>
      HTML
      playground.cards.create! creator: creator, title: "Now, check out all cards assigned to you", status: "published", description: <<~HTML
        <p>Pull down the Fizzy menu at the top of the screen, and select <b><strong>Assigned to me</b></strong> or just hit 2 on your keyboard any time.</p>
        <action-text-attachment url="https://videos.37signals.com/fizzy/assets/images/all-assigned.gif" alt="Demo of navigating to 'Assigned to Me'" caption="See all cards assigned to me" content-type="image/*" filename="all-assigned.gif" presentation="gallery"></action-text-attachment>
      HTML
      playground.cards.create! creator: creator, title: "Then, open the Fizzy menu", status: "published", description: <<~HTML
        <p>The Fizzy menu is how you get around the app. Click <b><strong>Fizzy</b></strong> at the top of the screen or hit the J key on your keyboard to pop it open.</p>
        <action-text-attachment url="https://videos.37signals.com/fizzy/assets/images/open-menu.gif" alt="Demo of opening the main menu" caption="Open the Fizzy menu" content-type="image/*" filename="open-menu.gif" presentation="gallery"></action-text-attachment>
      HTML
      playground.cards.create! creator: creator, title: "Next, assign this card to yourself", status: "published", description: <<~HTML
        <p>Click the little head with the + next to it, then pick yourself.</p>
        <action-text-attachment url="https://videos.37signals.com/fizzy/assets/images/assign-to-self.gif" alt="Demo of assigning a card" caption="Assign this to yourself" content-type="image/*" filename="assign-to-self.gif" presentation="gallery"></action-text-attachment>
      HTML
      playground.cards.create! creator: creator, title: "Now, tag this card Design then move it to YES", status: "published", description: <<~HTML
        <p>Click the little Tag icon, type design, then <b><strong>Create tag</b></strong>. Then, move the card to the new YES column you created in the previous step.</p>
        <action-text-attachment url="https://videos.37signals.com/fizzy/assets/images/tag-design.gif" alt="Demo of tagging a card" caption="Tag this #design" content-type="image/*" filename="tag-design.gif" presentation="gallery"></action-text-attachment>
      HTML
      playground.cards.create! creator: creator, title: "Next, make two more columns", status: "published", description: <<~HTML
        <ol>
          <li>Make one called "Yes"</li>
          <li>Make another called "Working on"</li>
        </ol>
        <p>Go back to the Board view, click the little + to the right of the DONE column, name the column, pick a color, then do it again.</p>
        <p><br></p>
        <p>After that, drag this card to DONE or select DONE in the sidebar.</p>
        <action-text-attachment url="https://videos.37signals.com/fizzy/assets/images/make-columns.gif" alt="Demo of adding columns" caption="Make two more columns" content-type="image/*" filename="make-columns.gif" presentation="gallery"></action-text-attachment>
      HTML
      playground.cards.create! creator: creator, title: "Second, move this card to NOT NOW", status: "published", description: <<~HTML
        <p>You can either select NOT NOW over in the sidebar, or you can go back out to the board view and drag this card into the NOT NOW column on the left side.</p>
        <p><br></p>
        <action-text-attachment url="https://videos.37signals.com/fizzy/assets/images/not-now.gif" alt="Demo of moving a card to Not Now" caption="Move to Not Now" content-type="image/*" filename="not-now.gif" presentation="gallery"></action-text-attachment>
      HTML
      playground.cards.create! creator: creator, title: "First, rename this card", status: "published", description: <<~HTML
        <ol>
          <li>Click the title and you can rename the card, change the description, or add more information to the card.</li>
          <li>Then, hit "Mark as Done" at the bottom of the card.</li>
          <li>Finally, hit <b><strong>Back to Playground</strong></b> in the top left of the screen to go back to the board.</li>
        </ol>
        <action-text-attachment url="https://videos.37signals.com/fizzy/assets/images/rename.gif" alt="Demo of renaming a card" caption="Rename this card" content-type="image/*" filename="rename.gif" presentation="gallery"></action-text-attachment>
      HTML
    end
    def delete_everything
      Current.set(user: creator, account: account) do
        account.boards.destroy_all
      end
    end
end

================
File: app/models/account/storage.rb
================
module Account::Storage
  extend ActiveSupport::Concern
  include Storage::Totaled
  private
    def calculate_real_storage_bytes
      boards.sum { |board| board.send(:calculate_real_storage_bytes) }
    end
end

================
File: app/models/board/accessible.rb
================
module Board::Accessible
  extend ActiveSupport::Concern
  included do
    has_many :accesses, dependent: :delete_all do
      def revise(granted: [], revoked: [])
        transaction do
          grant_to granted
          revoke_from revoked
        end
      end
      def grant_to(users)
        Access.insert_all Array(users).collect { |user| { id: ActiveRecord::Type::Uuid.generate, board_id: proxy_association.owner.id, user_id: user.id, account_id: proxy_association.owner.account.id } }
      end
      def revoke_from(users)
        destroy_by user: users unless proxy_association.owner.all_access?
      end
    end
    has_many :users, through: :accesses
    has_many :access_only_users, -> { merge(Access.access_only) }, through: :accesses, source: :user
    scope :all_access, -> { where(all_access: true) }
    after_create :grant_access_to_creator
    after_save_commit :grant_access_to_everyone
  end
  def accessed_by(user)
    access_for(user).accessed
  end
  def access_for(user)
    accesses.find_by(user: user)
  end
  def accessible_to?(user)
    access_for(user).present?
  end
  def clean_inaccessible_data_for(user)
    return if accessible_to?(user)
    mentions_for_user(user).destroy_all
    notifications_for_user(user).destroy_all
    watches_for(user).destroy_all
    pins_for(user).destroy_all
  end
  def watchers
    users.active.where(accesses: { involvement: :watching })
  end
  private
    def grant_access_to_creator
      accesses.create(user: creator, involvement: :watching)
    end
    def grant_access_to_everyone
      accesses.grant_to(account.users.active) if all_access_previously_changed?(to: true)
    end
    def mentions_for_user(user)
      # Query handles 2 paths:
      #
      # 1. Mention->Card
      # 2. Mention->Comment->Card
      board_id_binary = ActiveRecord::Type::Uuid.new.serialize(id)
      user.mentions
        .joins("LEFT JOIN cards ON mentions.source_id = cards.id AND mentions.source_type = 'Card'")
        .joins("LEFT JOIN comments ON mentions.source_id = comments.id AND mentions.source_type = 'Comment'")
        .joins("LEFT JOIN cards AS comment_cards ON comments.card_id = comment_cards.id")
        .where("(mentions.source_type = 'Card' AND cards.board_id = ?) OR (mentions.source_type = 'Comment' AND comment_cards.board_id = ?)", board_id_binary, board_id_binary)
    end
    def notifications_for_user(user)
      # Query handles 2 paths:
      #
      # 1. Notification->Event->Card
      # 2. Notification->Event->Comment->Card
      #
      # Notification->Event->Mention->Card and Notification->Event->Mention->Comment->Card are
      # handled by destroying mentions_for_user.
      uuid_type = ActiveRecord::Type.lookup(:uuid, adapter: :trilogy)
      board_id_binary = uuid_type.serialize(id)
      user.notifications
        .joins("LEFT JOIN events ON notifications.source_id = events.id AND notifications.source_type = 'Event'")
        .joins("LEFT JOIN cards AS event_cards ON events.eventable_id = event_cards.id AND events.eventable_type = 'Card'")
        .joins("LEFT JOIN comments AS event_comments ON events.eventable_id = event_comments.id AND events.eventable_type = 'Comment'")
        .joins("LEFT JOIN cards AS event_comment_cards ON event_comments.card_id = event_comment_cards.id")
        .where("(notifications.source_type = 'Event' AND events.eventable_type = 'Card' AND event_cards.board_id = ?) OR
              (notifications.source_type = 'Event' AND events.eventable_type = 'Comment' AND event_comment_cards.board_id = ?)",
               board_id_binary, board_id_binary)
    end
    def watches_for(user)
      Watch.where(card: cards, user: user)
    end
    def pins_for(user)
      Pin.where(card: cards, user: user)
    end
end

================
File: app/models/board/auto_postponing.rb
================
module Board::AutoPostponing
  extend ActiveSupport::Concern
  included do
    before_create :set_default_auto_postpone_period
  end
  private
    DEFAULT_AUTO_POSTPONE_PERIOD = 30.days
    def set_default_auto_postpone_period
      self.auto_postpone_period ||= DEFAULT_AUTO_POSTPONE_PERIOD unless attribute_present?(:auto_postpone_period)
    end
end

================
File: app/models/board/broadcastable.rb
================
module Board::Broadcastable
  extend ActiveSupport::Concern
  included do
    broadcasts_refreshes
    broadcasts_refreshes_to ->(board) { [ board.account, :all_boards ] }
  end
end

================
File: app/models/board/cards.rb
================
module Board::Cards
  extend ActiveSupport::Concern
  included do
    has_many :cards, dependent: :destroy
    after_update_commit -> { cards.touch_all }, if: :saved_change_to_name?
  end
end

================
File: app/models/board/entropic.rb
================
module Board::Entropic
  extend ActiveSupport::Concern
  included do
    delegate :auto_postpone_period, to: :entropy
    has_one :entropy, as: :container, dependent: :destroy
  end
  def entropy
    super || account.entropy
  end
  def auto_postpone_period=(new_value)
    entropy ||= association(:entropy).reader || self.build_entropy
    entropy.update auto_postpone_period: new_value
  end
end

================
File: app/models/board/publication.rb
================
class Board::Publication < ApplicationRecord
  belongs_to :account, default: -> { board.account }
  belongs_to :board
  has_secure_token :key
end

================
File: app/models/board/publishable.rb
================
module Board::Publishable
  extend ActiveSupport::Concern
  included do
    has_one :publication, class_name: "Board::Publication", dependent: :destroy
    scope :published, -> { joins(:publication) }
  end
  class_methods do
    def find_by_published_key(key)
      Board::Publication.find_by!(key: key).board
    end
  end
  def published?
    publication.present?
  end
  alias_method :publicly_accessible?, :published?
  def publish
    create_publication! unless published?
  end
  def unpublish
    publication&.destroy
  end
end

================
File: app/models/board/storage.rb
================
module Board::Storage
  extend ActiveSupport::Concern
  include Storage::Totaled
  # Board's own embeds (public_description) count toward itself
  def board_for_storage_tracking
    self
  end
  private
    BATCH_SIZE = 1000
    # Calculate actual storage by summing blob sizes.
    #
    # Storage tracking is a business abstraction - we count what users upload.
    # Original upload bytes only; variants/previews/derivatives excluded.
    # Physical storage optimizations (deduplication, compression) don't affect quotas.
    def calculate_real_storage_bytes
      @card_ids = nil  # Clear memoization for fresh calculation
      card_image_bytes + card_embed_bytes + comment_embed_bytes + board_embed_bytes
    end
    def card_ids
      @card_ids ||= cards.ids
    end
    def card_image_bytes
      sum_blob_bytes_in_batches \
        ActiveStorage::Attachment.where(record_type: "Card", name: "image"),
        card_ids
    end
    def card_embed_bytes
      sum_embed_bytes_for "Card", card_ids
    end
    def comment_embed_bytes
      card_ids.each_slice(BATCH_SIZE).sum do |batch|
        sum_embed_bytes_for "Comment", Comment.where(card_id: batch).ids
      end
    end
    def board_embed_bytes
      sum_embed_bytes_for "Board", [ id ]
    end
    def sum_embed_bytes_for(record_type, record_ids)
      rich_text_ids = ActionText::RichText \
        .where(record_type: record_type, record_id: record_ids).ids
      sum_blob_bytes_in_batches \
        ActiveStorage::Attachment.where(record_type: "ActionText::RichText", name: "embeds"),
        rich_text_ids
    end
    def sum_blob_bytes_in_batches(base_scope, record_ids)
      # Count per-attachment to match ledger model.
      # Same blob attached 3 times = 3x bytes (business abstraction, not physical storage).
      #
      # Do NOT remove the join thinking it's a performance optimization - it's required
      # for correct per-attachment counting. We keep ActiveStorage/ActionText in the same
      # database (realm/geo partitioning, not functionality partitioning), so cross-table
      # joins are fine.
      record_ids.each_slice(BATCH_SIZE).sum do |batch_ids|
        base_scope
          .where(record_id: batch_ids)
          .joins(:blob)
          .sum("active_storage_blobs.byte_size")
      end
    end
end

================
File: app/models/board/triageable.rb
================
module Board::Triageable
  extend ActiveSupport::Concern
  included do
    has_many :columns, dependent: :destroy
  end
end

================
File: app/models/card/activity_spike/detector.rb
================
class Card::ActivitySpike::Detector
  attr_reader :card
  def initialize(card)
    @card = card
  end
  def detect
    if has_activity_spike?
      register_activity_spike
      true
    else
      false
    end
  end
  private
    def has_activity_spike?
      card.entropic? && (multiple_people_commented? || card_was_just_assigned? || card_was_just_reopened?)
    end
    def register_activity_spike
      Card.suppressing_turbo_broadcasts do
        Card::ActivitySpike.find_or_create_by!(card: card).touch
      end
    end
    def multiple_people_commented?(minimum_comments: 3, minimum_participants: 2)
      card.comments
        .where(created_at: recent_period.seconds.ago..)
        .group(:card_id)
        .having("COUNT(*) >= ?", minimum_comments)
        .having("COUNT(DISTINCT creator_id) >= ?", minimum_participants)
        .exists?
    end
    def recent_period
      card.entropy.auto_clean_period * 0.33
    end
    def card_was_just_assigned?
      card.assigned? && card_was_just?(:assigned)
    end
    def card_was_just_reopened?
      card.open? && card_was_just?(:reopened)
    end
    def card_was_just?(action)
      last_event&.action&.to_s == "card_#{action}" && last_event.created_at > 1.minute.ago
    end
    def last_event
      card.events.order(:created_at).last
    end
end

================
File: app/models/card/eventable/system_commenter.rb
================
class Card::Eventable::SystemCommenter
  include ERB::Util
  attr_reader :card, :event
  def initialize(card, event)
    @card, @event = card, event
  end
  def comment
    return unless comment_body.present?
    card.comments.create! creator: card.account.system_user, body: comment_body, created_at: event.created_at
  end
  private
    def comment_body
      case event.action
      when "card_assigned"
        "#{creator_name} <strong>assigned</strong> this to #{assignee_names}."
      when "card_unassigned"
        "#{creator_name} <strong>unassigned</strong> from #{assignee_names}."
      when "card_closed"
        "<strong>Moved</strong> to Done by #{creator_name}"
      when "card_reopened"
        "<strong>Reopened</strong> by #{creator_name}"
      when "card_postponed"
        "#{creator_name} <strong>moved</strong> this to Not Now"
      when "card_auto_postponed"
        "<strong>Moved</strong> to Not Now due to inactivity"
      when "card_title_changed"
        "#{creator_name} <strong>changed the title</strong> from #{old_title} to #{new_title}."
      when "card_board_changed"
        "#{creator_name} <strong>moved</strong> this from #{old_board} to #{new_board}."
      when "card_triaged"
        "#{creator_name} <strong>moved</strong> this to #{column}"
      when "card_sent_back_to_triage"
        "#{creator_name} <strong>moved</strong> this back to Maybe?"
      end
    end
    def creator_name
      h event.creator.name
    end
    def assignee_names
      h event.assignees.pluck(:name).to_sentence
    end
    def old_title
      h event.particulars.dig("particulars", "old_title")
    end
    def new_title
      h event.particulars.dig("particulars", "new_title")
    end
    def old_board
      h event.particulars.dig("particulars", "old_board")
    end
    def new_board
      h event.particulars.dig("particulars", "new_board")
    end
    def column
      h event.particulars.dig("particulars", "column")
    end
end

================
File: app/models/card/accessible.rb
================
module Card::Accessible
  extend ActiveSupport::Concern
  included do
    delegate :accessible_to?, to: :board
  end
  def publicly_accessible?
    published? && board.publicly_accessible?
  end
  def clean_inaccessible_data
    accessible_user_ids = board.accesses.pluck(:user_id)
    pins.where.not(user_id: accessible_user_ids).in_batches.destroy_all
    watches.where.not(user_id: accessible_user_ids).in_batches.destroy_all
  end
  private
    def grant_access_to_assignees
      board.accesses.grant_to(assignees)
    end
    def clean_inaccessible_data_later
      Card::CleanInaccessibleDataJob.perform_later(self)
    end
end

================
File: app/models/card/activity_spike.rb
================
class Card::ActivitySpike < ApplicationRecord
  belongs_to :account, default: -> { card.account }
  belongs_to :card, touch: true
end

================
File: app/models/card/assignable.rb
================
module Card::Assignable
  extend ActiveSupport::Concern
  included do
    has_many :assignments, dependent: :delete_all
    has_many :assignees, through: :assignments
    scope :unassigned, -> { where.missing :assignments }
    scope :assigned_to, ->(users) { joins(:assignments).where(assignments: { assignee: users }).distinct }
    scope :assigned_by, ->(users) { joins(:assignments).where(assignments: { assigner: users }).distinct }
  end
  def toggle_assignment(user)
    assigned_to?(user) ? unassign(user) : assign(user)
  end
  def assigned_to?(user)
    assignments.any? { |a| a.assignee_id == user.id }
  end
  def assigned?
    assignments.any?
  end
  private
    def assign(user)
      assignment = assignments.create assignee: user, assigner: Current.user
      if assignment.persisted?
        watch_by user
        track_event :assigned, assignee_ids: [ user.id ]
      end
    rescue ActiveRecord::RecordNotUnique
      # Already assigned
    end
    def unassign(user)
      destructions = assignments.destroy_by assignee: user
      track_event :unassigned, assignee_ids: [ user.id ] if destructions.any?
    end
end

================
File: app/models/card/broadcastable.rb
================
module Card::Broadcastable
  extend ActiveSupport::Concern
  included do
    broadcasts_refreshes
    before_update :remember_if_preview_changed
  end
  private
    def remember_if_preview_changed
      @preview_changed ||= title_changed? || column_id_changed? || board_id_changed?
    end
    def preview_changed?
      @preview_changed
    end
end

================
File: app/models/card/closeable.rb
================
module Card::Closeable
  extend ActiveSupport::Concern
  included do
    has_one :closure, dependent: :destroy
    scope :closed, -> { joins(:closure) }
    scope :open, -> { where.missing(:closure) }
    scope :recently_closed_first, -> { closed.order(closures: { created_at: :desc }) }
    scope :closed_at_window, ->(window) { closed.where(closures: { created_at: window }) }
    scope :closed_by, ->(users) { closed.where(closures: { user_id: Array(users) }) }
  end
  def closed?
    closure.present?
  end
  def open?
    !closed?
  end
  def closed_by
    closure&.user
  end
  def closed_at
    closure&.created_at
  end
  def close(user: Current.user)
    unless closed?
      transaction do
        not_now&.destroy
        create_closure! user: user
        track_event :closed, creator: user
      end
    end
  end
  def reopen(user: Current.user)
    if closed?
      transaction do
        closure&.destroy
        track_event :reopened, creator: user
      end
    end
  end
end

================
File: app/models/card/colored.rb
================
module Card::Colored
  extend ActiveSupport::Concern
  def color
    column&.color || Column::Colored::DEFAULT_COLOR
  end
end

================
File: app/models/card/commentable.rb
================
module Card::Commentable
  extend ActiveSupport::Concern
  included do
    has_many :comments, dependent: :destroy
  end
  def commentable?
    published?
  end
  private
    STORAGE_BATCH_SIZE = 1000
    # Override to include comments, but only load comments that have attachments.
    # Cards can have thousands of comments; most won't have attachments.
    # Streams in batches to avoid loading all IDs into memory at once.
    def storage_transfer_records
      comment_ids_with_attachments = storage_comment_ids_with_attachments
      if comment_ids_with_attachments.any?
        [ self, *comments.where(id: comment_ids_with_attachments).to_a ]
      else
        [ self ]
      end
    end
    def storage_comment_ids_with_attachments
      direct = []
      rich_text_map = {}
      # Stream comment IDs in batches to avoid loading all into memory
      comments.in_batches(of: STORAGE_BATCH_SIZE) do |batch|
        batch_ids = batch.pluck(:id)
        direct.concat \
          ActiveStorage::Attachment
            .where(record_type: "Comment", record_id: batch_ids)
            .distinct
            .pluck(:record_id)
        ActionText::RichText
          .where(record_type: "Comment", record_id: batch_ids)
          .pluck(:id, :record_id)
          .each { |rt_id, comment_id| rich_text_map[rt_id] = comment_id }
      end
      embed_comment_ids = if rich_text_map.any?
        rich_text_map.keys.each_slice(STORAGE_BATCH_SIZE).flat_map do |batch_ids|
          ActiveStorage::Attachment
            .where(record_type: "ActionText::RichText", record_id: batch_ids)
            .distinct
            .pluck(:record_id)
        end.filter_map { |rt_id| rich_text_map[rt_id] }
      else
        []
      end
      (direct + embed_comment_ids).uniq
    end
end

================
File: app/models/card/entropic.rb
================
module Card::Entropic
  extend ActiveSupport::Concern
  included do
    scope :due_to_be_postponed, -> do
      active
        .joins(board: :account)
        .left_outer_joins(board: :entropy)
        .joins("LEFT OUTER JOIN entropies AS account_entropies ON account_entropies.account_id = accounts.id AND account_entropies.container_type = 'Account' AND account_entropies.container_id = accounts.id")
        .where("last_active_at <= #{connection.date_subtract('?', 'COALESCE(entropies.auto_postpone_period, account_entropies.auto_postpone_period)')}", Time.now)
    end
    scope :postponing_soon, -> do
      now = Time.now
      active
        .joins(board: :account)
        .left_outer_joins(board: :entropy)
        .joins("LEFT OUTER JOIN entropies AS account_entropies ON account_entropies.account_id = accounts.id AND account_entropies.container_type = 'Account' AND account_entropies.container_id = accounts.id")
        .where("last_active_at > #{connection.date_subtract('?', 'COALESCE(entropies.auto_postpone_period, account_entropies.auto_postpone_period)')}", now)
        .where("last_active_at <= #{connection.date_subtract('?', 'COALESCE(entropies.auto_postpone_period, account_entropies.auto_postpone_period) * 0.75')}", now)
    end
    delegate :auto_postpone_period, to: :board
  end
  class_methods do
    def auto_postpone_all_due
      due_to_be_postponed.find_each do |card|
        card.auto_postpone(user: card.account.system_user)
      end
    end
  end
  def entropy
    Card::Entropy.for(self)
  end
  def entropic?
    entropy.present?
  end
end

================
File: app/models/card/entropy.rb
================
class Card::Entropy
  attr_reader :card, :auto_clean_period
  class << self
    def for(card)
      return unless card.last_active_at
      new(card, card.auto_postpone_period)
    end
  end
  def initialize(card, auto_clean_period)
    @card = card
    @auto_clean_period = auto_clean_period
  end
  def auto_clean_at
    card.last_active_at + auto_clean_period
  end
  def days_before_reminder
    (auto_clean_period * 0.25).seconds.in_days.round
  end
end

================
File: app/models/card/eventable.rb
================
module Card::Eventable
  extend ActiveSupport::Concern
  include ::Eventable
  included do
    before_create { self.last_active_at ||= created_at || Time.current }
    after_save :track_title_change, if: :saved_change_to_title?
  end
  def event_was_created(event)
    transaction do
      create_system_comment_for(event)
      touch_last_active_at unless was_just_published?
    end
  end
  def touch_last_active_at
    # Not using touch so that we can detect attribute change on callbacks
    update!(last_active_at: Time.current)
  end
  private
    def should_track_event?
      published?
    end
    def track_title_change
      if title_before_last_save.present?
        track_event "title_changed", particulars: { old_title: title_before_last_save, new_title: title }
      end
    end
    def create_system_comment_for(event)
      SystemCommenter.new(self, event).comment
    end
end

================
File: app/models/card/exportable.rb
================
module Card::Exportable
  extend ActiveSupport::Concern
  include ActionView::Helpers::TagHelper
  def export_json
    JSON.pretty_generate({
      number: number,
      title: title,
      board: board.name,
      status: export_status,
      creator: export_user(creator),
      description: export_html(description),
      created_at: created_at.iso8601,
      updated_at: updated_at.iso8601,
      comments: comments.chronologically.map do |comment|
        {
          id: comment.id,
          body: export_html(comment.body),
          creator: export_user(comment.creator),
          created_at: comment.created_at.iso8601
        }
      end
    })
  end
  def export_attachments
    collect_attachments.map do |attachment|
      { path: export_attachment_path(attachment.blob), blob: attachment.blob }
    end
  end
  private
    def export_html(rich_text)
      return "" if rich_text.blank?
      rich_text.body.render_attachments do |attachment|
        attachment_representation(attachment)
      end.to_html
    end
    def attachment_representation(attachment)
      case attachable = attachment.attachable
      when ActiveStorage::Blob
        path = export_attachment_path(attachable)
        if attachable.image?
          tag.img(src: path, alt: attachable.filename)
        else
          tag.a(attachable.filename, href: path)
        end
      when ActionText::Attachables::RemoteImage
        tag.img(src: attachable.url, alt: "Remote image")
      else
        attachment.to_html
      end
    end
    def export_user(user)
      {
        id: user.id,
        name: user.name,
        email: user.identity&.email_address
      }
    end
    def export_attachment_path(blob)
      "#{number}/#{blob.key}_#{blob.filename}"
    end
    def collect_attachments
      (attachments.to_a + comments.flat_map { |c| c.attachments.to_a }).uniq(&:blob_id)
    end
    def export_status
      case
      when closed?
        "Done"
      when postponed?
        "Not now"
      when column.present?
        column.name
      else
        "Maybe?"
      end
    end
end

================
File: app/models/card/golden.rb
================
module Card::Golden
  extend ActiveSupport::Concern
  included do
    has_one :goldness, dependent: :destroy, class_name: "Card::Goldness"
    scope :golden, -> { joins(:goldness) }
    scope :with_golden_first, -> { left_outer_joins(:goldness).prepend_order("card_goldnesses.id IS NULL").preload(:goldness) }
  end
  def golden?
    goldness.present?
  end
  def gild
    create_goldness! unless golden?
  end
  def ungild
    goldness&.destroy
  end
end

================
File: app/models/card/goldness.rb
================
class Card::Goldness < ApplicationRecord
  belongs_to :account, default: -> { card.account }
  belongs_to :card, touch: true
end

================
File: app/models/card/mentions.rb
================
module Card::Mentions
  extend ActiveSupport::Concern
  included do
    include ::Mentions
    def mentionable?
      published?
    end
    def should_check_mentions?
      was_just_published?
    end
  end
end

================
File: app/models/card/multistep.rb
================
module Card::Multistep
  extend ActiveSupport::Concern
  included do
    has_many :steps, dependent: :destroy
  end
end

================
File: app/models/card/not_now.rb
================
class Card::NotNow < ApplicationRecord
  belongs_to :account, default: -> { card.account }
  belongs_to :card, class_name: "::Card", touch: true
  belongs_to :user, optional: true
end

================
File: app/models/card/pinnable.rb
================
module Card::Pinnable
  extend ActiveSupport::Concern
  included do
    has_many :pins, dependent: :destroy
    after_update_commit :broadcast_pin_updates, if: :preview_changed?
  end
  def pinned_by?(user)
    pins.exists?(user: user)
  end
  def pin_for(user)
    pins.find_by(user: user)
  end
  def pin_by(user)
    pins.find_or_create_by!(user: user)
  end
  def unpin_by(user)
    pins.find_by(user: user).tap { it.destroy }
  end
  private
    def broadcast_pin_updates
      pins.find_each do |pin|
        pin.broadcast_replace_later_to [ pin.user, :pins_tray ], partial: "my/pins/pin"
      end
    end
end

================
File: app/models/card/postponable.rb
================
module Card::Postponable
  extend ActiveSupport::Concern
  included do
    has_one :not_now, dependent: :destroy, class_name: "Card::NotNow"
    scope :postponed, -> { open.published.joins(:not_now) }
    scope :active, -> { open.published.where.missing(:not_now) }
  end
  def postponed?
    open? && published? && not_now.present?
  end
  def postponed_at
    not_now&.created_at
  end
  def postponed_by
    not_now&.user
  end
  def active?
    open? && published? && !postponed?
  end
  def auto_postpone(**args)
    postpone(**args, event_name: :auto_postponed)
  end
  def postpone(user: Current.user, event_name: :postponed)
    transaction do
      send_back_to_triage(skip_event: true)
      reopen
      activity_spike&.destroy
      create_not_now!(user: user) unless postponed?
      track_event event_name, creator: user
    end
  end
  def resume
    transaction do
      reopen
      activity_spike&.destroy
      not_now&.destroy
    end
  end
end

================
File: app/models/card/promptable.rb
================
module Card::Promptable
  extend ActiveSupport::Concern
  included do
    include Rails.application.routes.url_helpers
  end
  def to_prompt
    <<~PROMPT
      BEGIN OF CARD #{id}
      **Title:** #{title.first(1000)}
      **Description:**
      #{description.to_plain_text.first(10_000)}
      #### Metadata
      * Id: #{id}
      * Created by: #{creator.name}}
      * Assigned to: #{assignees.map(&:name).join(", ")}
      * Column: #{column_prompt_label}
      * Created at: #{created_at}}
      * Board id: #{board_id}
      * Board name: #{board.name}
      * Number of comments: #{comments.count}
      * Path: #{card_path(self, script_name: account.slug)}
      END OF CARD #{id}
    PROMPT
  end
  private
    def column_prompt_label
      if open?
        if postponed?
          "Not now"
        elsif triaged?
          "#{column&.name}"
        else
          "Maybe?"
        end
      else
        "Closed (by #{closed_by&.name} at #{closed_at})"
      end
    end
end

================
File: app/models/card/readable.rb
================
module Card::Readable
  extend ActiveSupport::Concern
  def read_by(user)
    notifications_for(user).tap do |notifications|
      notifications.each(&:read)
    end
  end
  def unread_by(user)
    all_notifications_for(user).tap do |notifications|
      notifications.each(&:unread)
    end
  end
  def remove_inaccessible_notifications
    accessible_user_ids = board.accesses.pluck(:user_id)
    notification_sources.each do |sources|
      inaccessible_notifications_from(sources, accessible_user_ids).in_batches.destroy_all
    end
  end
  private
    def remove_inaccessible_notifications_later
      Card::RemoveInaccessibleNotificationsJob.perform_later(self)
    end
    def notifications_for(user)
      scope = user.notifications.unread
      scope.where(source: event_notification_sources)
        .or(scope.where(source: mention_notification_sources))
    end
    def all_notifications_for(user)
      scope = user.notifications
      scope.where(source: event_notification_sources)
        .or(scope.where(source: mention_notification_sources))
    end
    def event_notification_sources
      events.or(comment_creation_events)
    end
    def comment_creation_events
      Event.where(eventable: comments)
    end
    def inaccessible_notifications_from(sources, accessible_user_ids)
      Notification.where(source: sources).where.not(user_id: accessible_user_ids)
    end
    def notification_sources
      [ events, comment_creation_events, mentions, comment_mentions ]
    end
    def mention_notification_sources
      mentions.or(comment_mentions)
    end
    def comment_mentions
      Mention.where(source: comments)
    end
end

================
File: app/models/card/searchable.rb
================
module Card::Searchable
  extend ActiveSupport::Concern
  included do
    include ::Searchable
    scope :mentioning, ->(query, user:) do
      search_record_class = Search::Record.for(user.account_id)
      joins(search_record_class.card_join).merge(search_record_class.for_query(query, user: user))
    end
  end
  def search_title
    title
  end
  def search_content
    description.to_plain_text
  end
  def search_card_id
    id
  end
  def search_board_id
    board_id
  end
  def searchable?
    published?
  end
end

================
File: app/models/card/stallable.rb
================
module Card::Stallable
  extend ActiveSupport::Concern
  STALLED_AFTER_LAST_SPIKE_PERIOD = 14.days
  included do
    has_one :activity_spike, class_name: "Card::ActivitySpike", dependent: :destroy
    scope :with_activity_spikes, -> { joins(:activity_spike) }
    scope :stalled, -> { open.active.with_activity_spikes.where(card_activity_spikes: { updated_at: ..STALLED_AFTER_LAST_SPIKE_PERIOD.ago }, updated_at: ..STALLED_AFTER_LAST_SPIKE_PERIOD.ago) }
    before_update :remember_to_detect_activity_spikes
    after_update_commit :detect_activity_spikes_later, if: :should_detect_activity_spikes?
  end
  # Keep in sync with #isStalled in app/javascript/controllers/bubble_controller.js
  def stalled?
    if activity_spike.present?
      open? && last_activity_spike_at < STALLED_AFTER_LAST_SPIKE_PERIOD.ago && updated_at < STALLED_AFTER_LAST_SPIKE_PERIOD.ago
    end
  end
  def last_activity_spike_at
    activity_spike&.updated_at
  end
  def detect_activity_spikes
    Card::ActivitySpike::Detector.new(self).detect
  end
  private
    def remember_to_detect_activity_spikes
      @should_detect_activity_spikes = published? && last_active_at_changed?
    end
    def should_detect_activity_spikes?
      @should_detect_activity_spikes
    end
    def detect_activity_spikes_later
      Card::ActivitySpike::DetectionJob.perform_later(self)
    end
end

================
File: app/models/card/statuses.rb
================
module Card::Statuses
  extend ActiveSupport::Concern
  included do
    enum :status, %w[ drafted published ].index_by(&:itself)
    before_save :mark_if_just_published
    after_create -> { track_event :published }, if: :published?
  end
  attr_accessor :was_just_published
  alias_method :was_just_published?, :was_just_published
  def publish
    transaction do
      self.created_at = Time.current
      published!
      track_event :published
    end
  end
  private
    def mark_if_just_published
      self.was_just_published = true if published? && status_changed?
    end
end

================
File: app/models/card/taggable.rb
================
module Card::Taggable
  extend ActiveSupport::Concern
  included do
    has_many :taggings, dependent: :destroy
    has_many :tags, through: :taggings
    scope :tagged_with, ->(tags) { joins(:taggings).where(taggings: { tag: tags }) }
  end
  def toggle_tag_with(title)
    tag = account.tags.find_or_create_by!(title: title)
    transaction do
      if tagged_with?(tag)
        taggings.destroy_by tag: tag
      else
        taggings.create tag: tag
      end
    end
  end
  def tagged_with?(tag)
    tags.include? tag
  end
end

================
File: app/models/card/triageable.rb
================
module Card::Triageable
  extend ActiveSupport::Concern
  included do
    belongs_to :column, optional: true, touch: true
    scope :awaiting_triage, -> { active.where.missing(:column) }
    scope :triaged, -> { active.joins(:column) }
  end
  def triaged?
    active? && column.present?
  end
  def awaiting_triage?
    active? && !triaged?
  end
  def triage_into(column)
    raise "The column must belong to the card board" unless board == column.board
    transaction do
      resume
      update! column: column
      track_event "triaged", particulars: { column: column.name }
    end
  end
  def send_back_to_triage(skip_event: false)
    transaction do
      resume
      update! column: nil
      track_event "sent_back_to_triage" unless skip_event
    end
  end
end

================
File: app/models/card/watchable.rb
================
module Card::Watchable
  extend ActiveSupport::Concern
  included do
    has_many :watches, dependent: :destroy
    has_many :watchers, -> { active.merge(Watch.watching) }, through: :watches, source: :user
    after_create :subscribe_creator
  end
  def watched_by?(user)
    watch_for(user)&.watching?
  end
  def watch_for(user)
    watches.find_by(user: user)
  end
  def watch_by(user)
    watches.where(user: user).first_or_create.update!(watching: true)
  end
  def unwatch_by(user)
    watches.where(user: user).first_or_create.update!(watching: false)
  end
  private
    def subscribe_creator
      # Avoid touching to not interfere with the abandon card detection system
      Card.no_touching do
        watch_by creator
      end
    end
end

================
File: app/models/column/colored.rb
================
module Column::Colored
  extend ActiveSupport::Concern
  DEFAULT_COLOR = Color::COLORS.first
  included do
    before_validation -> { self[:color] ||= DEFAULT_COLOR.value }
  end
  def color
    Color.for_value(super) || DEFAULT_COLOR
  end
end

================
File: app/models/column/positioned.rb
================
module Column::Positioned
  extend ActiveSupport::Concern
  included do
    scope :sorted, -> { order(position: :asc) }
    before_create :set_position
  end
  def move_left
    swap_position_with left_column
  end
  def move_right
    swap_position_with right_column
  end
  def left_column
    board.columns.where("position < ?", position).sorted.last
  end
  def right_column
    board.columns.where("position > ?", position).sorted.first
  end
  def leftmost?
    left_column.nil?
  end
  def rightmost?
    right_column.nil?
  end
  def adjacent_columns
    board.columns.where(id: [ left_column&.id, right_column&.id ].compact)
  end
  private
    def set_position
      max_position = board.columns.maximum(:position) || 0
      self.position = max_position + 1
    end
    def swap_position_with(other_column)
      return if other_column.nil?
      transaction do
        old_position = self.position
        self.update_column(:position, other_column.position)
        other_column.update_column(:position, old_position)
      end
    end
end

================
File: app/models/comment/eventable.rb
================
module Comment::Eventable
  extend ActiveSupport::Concern
  include ::Eventable
  included do
    after_create_commit :track_creation
  end
  def event_was_created(event)
    card.touch_last_active_at
  end
  private
    def should_track_event?
      !creator.system?
    end
    def track_creation
      track_event("created", board: card.board, creator: creator)
    end
end

================
File: app/models/comment/mentions.rb
================
module Comment::Mentions
  extend ActiveSupport::Concern
  included do
    include ::Mentions
    def mentionable?
      card.published?
    end
  end
end

================
File: app/models/comment/promptable.rb
================
module Comment::Promptable
  extend ActiveSupport::Concern
  included do
    include Rails.application.routes.url_helpers
  end
  def to_prompt
    <<~PROMPT
        BEGIN OF COMMENT #{id}
        **Content:**
        #{body.to_plain_text.first(5000)}
        #### Metadata
        * Id: #{id}
        * Card id: #{card.number}
        * Card title: #{card.title}
        * Created by: #{creator.name}}
        * Created at: #{created_at}}
        * Path: #{card_path(card, anchor: ActionView::RecordIdentifier.dom_id(self), script_name: account.slug)}
        END OF COMMENT #{id}
      PROMPT
  end
end

================
File: app/models/comment/searchable.rb
================
module Comment::Searchable
  extend ActiveSupport::Concern
  included do
    include ::Searchable
  end
  def search_title
    nil
  end
  def search_content
    body.to_plain_text
  end
  def search_card_id
    card_id
  end
  def search_board_id
    card.board_id
  end
  def searchable?
    card.published?
  end
end

================
File: app/models/concerns/storage/totaled.rb
================
module Storage::Totaled
  extend ActiveSupport::Concern
  included do
    has_one :storage_total, as: :owner, class_name: "Storage::Total", dependent: :destroy
    has_many :storage_entries, class_name: "Storage::Entry", foreign_key: foreign_key_for_storage
  end
  class_methods do
    def foreign_key_for_storage
      "#{model_name.singular}_id"
    end
  end
  # Fast: materialized snapshot (may be slightly stale)
  def bytes_used
    storage_total&.bytes_stored || 0
  end
  # Exact: snapshot + pending entries
  def bytes_used_exact
    create_or_find_storage_total.current_usage
  end
  def materialize_storage_later
    Storage::MaterializeJob.perform_later(self)
  end
  # Materialize all pending entries into snapshot
  def materialize_storage
    total = create_or_find_storage_total
    total.with_lock do
      latest_entry_id = storage_entries.maximum(:id)
      if latest_entry_id && total.last_entry_id != latest_entry_id
        scope = storage_entries.where(id: ..latest_entry_id)
        scope = scope.where.not(id: ..total.last_entry_id) if total.last_entry_id
        delta_sum = scope.sum(:delta)
        total.update! bytes_stored: total.bytes_stored + delta_sum, last_entry_id: latest_entry_id
      end
    end
  end
  # Reconcile ledger against actual attachment storage.
  #
  # Uses two-cursor approach for consistency: capture cursor before AND after the
  # scan. If they differ, entries were added during the scan and we can't get an
  # accurate diff without risking double-counting or undercounting.
  #
  # Returns true if reconciled successfully, false if aborted due to concurrent
  # writes. Caller (ReconcileJob) handles retries to avoid amplification.
  def reconcile_storage
    cursor_before = storage_entries.maximum(:id)
    real_bytes = calculate_real_storage_bytes
    cursor_after = storage_entries.maximum(:id)
    if cursor_before != cursor_after
      Rails.logger.warn "[Storage] Reconcile aborted for #{self.class}##{id}: cursor moved during scan"
      false
    else
      ledger_bytes = cursor_after ? storage_entries.where(id: ..cursor_after).sum(:delta) : 0
      diff = real_bytes - ledger_bytes
      if diff.nonzero?
        Rails.logger.info "[Storage] Reconcile #{self.class}##{id}: adjusting by #{diff} bytes"
        Storage::Entry.record \
          account: is_a?(Account) ? self : account,
          board: is_a?(Board) ? self : nil,
          recordable: nil,
          delta: diff,
          operation: "reconcile"
      end
      true
    end
  end
  private
    def create_or_find_storage_total
      self.storage_total ||= Storage::Total.create_or_find_by!(owner: self)
    end
    def calculate_real_storage_bytes
      raise NotImplementedError, "Subclass must implement calculate_real_storage_bytes"
    end
end

================
File: app/models/concerns/storage/tracked.rb
================
# Storage tracking is a business abstraction - we count what users upload.
# Original upload bytes only; variants/previews/derivatives excluded.
# Physical storage optimizations (deduplication, compression) don't affect quotas.
module Storage::Tracked
  extend ActiveSupport::Concern
  included do
    before_update :track_board_transfer, if: :board_transfer?
  end
  # Return self as the trackable record for storage entries
  def storage_tracked_record
    self
  end
  # Override in models where board is determined differently (e.g., Board itself)
  def board_for_storage_tracking
    board
  end
  # Total bytes for all attachments on this record
  def storage_bytes
    attachments_for_storage.sum { |a| a.blob.byte_size }
  end
  private
    def board_transfer?
      respond_to?(:will_save_change_to_board_id?) && will_save_change_to_board_id?
    end
    def track_board_transfer
      old_board = Board.find_by(id: attribute_in_database(:board_id))
      records = storage_transfer_records.compact
      return if records.empty?
      attachments_by_record = storage_attachments_for_records(records)
      attachments_by_record.each do |recordable, attachments|
        bytes = attachments.sum { |attachment| attachment.blob.byte_size }
        next if bytes.zero?
        # Debit old board
        if old_board
          Storage::Entry.record \
            account: account,
            board: old_board,
            recordable: recordable,
            delta: -bytes,
            operation: "transfer_out"
        end
        # Credit new board
        Storage::Entry.record \
          account: account,
          board: board,
          recordable: recordable,
          delta: bytes,
          operation: "transfer_in"
      end
    end
    def storage_transfer_records
      [ self ]
    end
    # Override if needed. Default = all direct attachments
    def attachments_for_storage(recordable = self)
      storage_attachments_for_records([ recordable ]).fetch(recordable, [])
    end
    def storage_attachments_for_records(recordables)
      records = Array(recordables).compact
      return {} if records.empty?
      # Build lookup for records by (type, id) to avoid N+1 when resolving RichText parents
      records_by_key = records.index_by { |r| [ r.class.name, r.id ] }
      rich_texts = ActionText::RichText.where(record: records)
      rich_text_to_parent = rich_texts.to_h { |rt| [ rt.id, records_by_key[[ rt.record_type, rt.record_id ]] ] }
      attachments = ActiveStorage::Attachment
        .where(record: records + rich_texts)
        .includes(:blob)
        .to_a
      attachments.each_with_object(Hash.new { |h, k| h[k] = [] }) do |attachment, grouped|
        # Resolve parent without N+1: use lookup for RichText, direct for others
        recordable = if attachment.record_type == "ActionText::RichText"
          rich_text_to_parent[attachment.record_id]
        else
          records_by_key[[ attachment.record_type, attachment.record_id ]]
        end
        grouped[recordable] << attachment if recordable
      end
    end
end

================
File: app/models/concerns/attachments.rb
================
module Attachments
  extend ActiveSupport::Concern
  # Variants used by ActionText embeds. Processed immediately on attachment to avoid
  # read replica issues (lazy variants would attempt writes on read replicas).
  #
  # Patched into ActionText::RichText in config/initializers/action_text.rb
  VARIANTS = {
    # vipsthumbnail used to create sized image variants has a intent setting to manage colors during
    # resize. By setting an invalid intent value the gif-incompatible intent filtering is skipped and
    # the gif can be rendered with all its frame intact.
    #
    # Only `n` is accepted as an override, using the full parameter name `intent` doesnt work.
    #
    # This was cargo-culted from know-it-all and I imagine it may be fixed at some point.
    small: { loader: { n: -1 }, resize_to_limit: [ 800, 600 ] },
    large: { loader: { n: -1 }, resize_to_limit: [ 1024, 768 ] }
  }
  def attachments
    rich_text_record&.embeds || []
  end
  def has_attachments?
    attachments.any?
  end
  def remote_images
    @remote_images ||= rich_text_record&.body&.attachables&.grep(ActionText::Attachables::RemoteImage) || []
  end
  def has_remote_images?
    remote_images.any?
  end
  def remote_videos
    @remote_videos ||= rich_text_record&.body&.attachables&.grep(ActionText::Attachables::RemoteVideo) || []
  end
  def has_remote_videos?
    remote_videos.any?
  end
  private
    def rich_text_record
      @rich_text_record ||= begin
        association = self.class.reflect_on_all_associations(:has_one).find { it.klass == ActionText::RichText }
        public_send(association.name)
      end
    end
end

================
File: app/models/concerns/eventable.rb
================
module Eventable
  extend ActiveSupport::Concern
  included do
    has_many :events, as: :eventable, dependent: :destroy
  end
  def track_event(action, creator: Current.user, board: self.board, **particulars)
    if should_track_event?
      board.events.create!(action: "#{eventable_prefix}_#{action}", creator:, board:, eventable: self, particulars:)
    end
  end
  def event_was_created(event)
  end
  private
    def should_track_event?
      true
    end
    def eventable_prefix
      self.class.name.demodulize.underscore
    end
end

================
File: app/models/concerns/filterable.rb
================
module Filterable
  extend ActiveSupport::Concern
  included do
    has_and_belongs_to_many :filters
    after_update { filters.touch_all }
    before_destroy :remove_from_filters
  end
  private
    # FIXME: This is too inefficient to have part of a destroy transaction.
    # Need to find a way to use a job or a single query.
    def remove_from_filters
      filters.each { it.resource_removed self }
    end
end

================
File: app/models/concerns/mentions.rb
================
module Mentions
  extend ActiveSupport::Concern
  included do
    has_many :mentions, as: :source, dependent: :destroy
    has_many :mentionees, through: :mentions
    after_save_commit :create_mentions_later, if: :should_create_mentions?
  end
  def create_mentions(mentioner: Current.user)
    scan_mentionees.each do |mentionee|
      mentionee.mentioned_by mentioner, at: self
    end
  end
  def mentionable_content
    rich_text_associations.collect { send(it.name)&.to_plain_text }.compact.join(" ")
  end
  private
    def scan_mentionees
      mentionees_from_attachments & mentionable_users
    end
    def mentionees_from_attachments
      rich_text_associations.flat_map { send(it.name)&.body&.attachments&.collect { it.attachable } }.compact
    end
    def mentionable_users
      board.users
    end
    def rich_text_associations
      self.class.reflect_on_all_associations(:has_one).filter { it.klass == ActionText::RichText }
    end
    def should_create_mentions?
      mentionable? && (mentionable_content_changed? || should_check_mentions?)
    end
    def mentionable_content_changed?
      rich_text_associations.any? { send(it.name)&.body_previously_changed? }
    end
    def create_mentions_later
      Mention::CreateJob.perform_later(self, mentioner: Current.user)
    end
    # Template method
    def mentionable?
      true
    end
    def should_check_mentions?
      false
    end
end

================
File: app/models/concerns/notifiable.rb
================
module Notifiable
  extend ActiveSupport::Concern
  included do
    has_many :notifications, as: :source, dependent: :destroy
    after_create_commit :notify_recipients_later
  end
  def notify_recipients
    Notifier.for(self)&.notify
  end
  def notifiable_target
    self
  end
  private
    def notify_recipients_later
      NotifyRecipientsJob.perform_later self
    end
end

================
File: app/models/concerns/push_notifiable.rb
================
module PushNotifiable
  extend ActiveSupport::Concern
  included do
    after_create_commit :push_notification_later
  end
  private
    def push_notification_later
      PushNotificationJob.perform_later(self)
    end
end

================
File: app/models/concerns/searchable.rb
================
module Searchable
  extend ActiveSupport::Concern
  SEARCH_CONTENT_LIMIT = 32.kilobytes
  included do
    after_create_commit :create_in_search_index
    after_update_commit :update_in_search_index
    after_destroy_commit :remove_from_search_index
  end
  def reindex
    update_in_search_index
  end
  private
    def create_in_search_index
      if searchable?
        search_record_class.create!(search_record_attributes)
      end
    end
    def update_in_search_index
      if searchable?
        search_record_class.upsert!(search_record_attributes)
      else
        remove_from_search_index
      end
    end
    def remove_from_search_index
      search_record_class.find_by(searchable_type: self.class.name, searchable_id: id)&.destroy
    end
    def search_record_attributes
      {
        account_id: account_id,
        searchable_type: self.class.name,
        searchable_id: id,
        card_id: search_card_id,
        board_id: search_board_id,
        title: search_title,
        content: search_record_content,
        created_at: created_at
      }
    end
    def search_record_content
      search_content&.truncate_bytes(SEARCH_CONTENT_LIMIT, omission: "")
    end
    def search_record_class
      Search::Record.for(account_id)
    end
  # Models must implement these methods:
  # - account_id: returns the account id
  # - search_title: returns title string or nil
  # - search_content: returns content string
  # - search_card_id: returns the card id (self.id for cards, card_id for comments)
  # - search_board_id: returns the board id
  # - searchable?: returns whether this record should be indexed
end

================
File: app/models/event/description.rb
================
class Event::Description
  include ActionView::Helpers::TagHelper
  include ERB::Util
  attr_reader :event, :user
  def initialize(event, user)
    @event = event
    @user = user
  end
  def to_html
    to_sentence(creator_tag, card_title_tag).html_safe
  end
  def to_plain_text
    to_sentence(creator_name, quoted(card.title))
  end
  private
    def to_sentence(creator, card_title)
      if event.action.comment_created?
        comment_sentence(creator, card_title)
      else
        action_sentence(creator, card_title)
      end
    end
    def creator_tag
      tag.span data: { creator_id: event.creator.id } do
        tag.span("You", data: { only_visible_to_you: true }) +
        tag.span(event.creator.name, data: { only_visible_to_others: true })
      end
    end
    def card_title_tag
      tag.span card.title, class: "txt-underline"
    end
    def creator_name
      h(event.creator.name)
    end
    def quoted(text)
      %("#{h text}")
    end
    def card
      @card ||= event.action.comment_created? ? event.eventable.card : event.eventable
    end
    def comment_sentence(creator, card_title)
      "#{creator} commented on #{card_title}"
    end
    def action_sentence(creator, card_title)
      case event.action
      when "card_assigned"
        assigned_sentence(creator, card_title)
      when "card_unassigned"
        unassigned_sentence(creator, card_title)
      when "card_published"
        "#{creator} added #{card_title}"
      when "card_closed"
        %(#{creator} moved #{card_title} to "Done")
      when "card_reopened"
        "#{creator} reopened #{card_title}"
      when "card_postponed"
        %(#{creator} moved #{card_title} to "Not Now")
      when "card_auto_postponed"
        %(#{card_title} moved to "Not Now" due to inactivity)
      when "card_resumed"
        "#{creator} resumed #{card_title}"
      when "card_title_changed"
        renamed_sentence(creator, card_title)
      when "card_board_changed", "card_collection_changed"
        moved_sentence(creator, card_title)
      when "card_triaged"
        triaged_sentence(creator, card_title)
      when "card_sent_back_to_triage"
        %(#{creator} moved #{card_title} back to "Maybe?")
      end
    end
    def assigned_sentence(creator, card_title)
      if event.assignees.include?(user)
        "#{creator} will handle #{card_title}"
      else
        "#{creator} assigned #{h event.assignees.pluck(:name).to_sentence} to #{card_title}"
      end
    end
    def unassigned_sentence(creator, card_title)
      assignees_text = event.assignees.include?(user) ? "yourself" : event.assignees.pluck(:name).to_sentence
      "#{creator} unassigned #{h(assignees_text)} from #{card_title}"
    end
    def renamed_sentence(creator, card_title)
      old_title = event.particulars.dig("particulars", "old_title")
      %(#{creator} renamed #{card_title} (was: "#{h old_title}"))
    end
    def moved_sentence(creator, card_title)
      new_location = event.particulars.dig("particulars", "new_board") || event.particulars.dig("particulars", "new_collection")
      %(#{creator} moved #{card_title} to "#{h new_location}")
    end
    def triaged_sentence(creator, card_title)
      column = event.particulars.dig("particulars", "column")
      %(#{creator} moved #{card_title} to "#{h column}")
    end
end

================
File: app/models/event/particulars.rb
================
module Event::Particulars
  extend ActiveSupport::Concern
  included do
    store_accessor :particulars, :assignee_ids
  end
  def assignees
    @assignees ||= User.where id: assignee_ids
  end
end

================
File: app/models/event/promptable.rb
================
module Event::Promptable
  extend ActiveSupport::Concern
  def to_prompt
    <<~PROMPT
        BEGIN OF EVENT #{id}
        ## Event #{action} (#{eventable_type} #{eventable_id}))
        * Created at: #{created_at}
        * Created by: #{creator.name}
        #{eventable.to_prompt}
        END OF EVENT #{id}
      PROMPT
  end
end

================
File: app/models/filter/fields.rb
================
module Filter::Fields
  extend ActiveSupport::Concern
  INDEXES = %w[ all closed not_now stalled postponing_soon golden ]
  SORTED_BY = %w[ newest oldest latest ]
  delegate :default_value?, to: :class
  class_methods do
    def default_values
      { indexed_by: "all", sorted_by: "latest" }
    end
    def default_value?(key, value)
      default_values[key.to_sym].eql?(value)
    end
    def indexed_by_human_name(index)
      case index
      when "postponing_soon"
        "Closing soon"
      when "closed"
        "Done"
      when "all"
        "Open"
      else
        index.humanize
      end
    end
  end
  included do
    store_accessor :fields, :assignment_status, :indexed_by, :sorted_by, :terms,
      :card_ids, :creation, :closure
    def assignment_status
      super.to_s.inquiry
    end
    def indexed_by
      (super || default_indexed_by).inquiry
    end
    def sorted_by
      (super || default_sorted_by).inquiry
    end
    def creation_window
      TimeWindowParser.parse(creation)
    end
    def closure_window
      TimeWindowParser.parse(closure)
    end
    def terms
      Array(super)
    end
    def terms=(value)
      super(Array(value).filter(&:present?))
    end
  end
  def with(**fields)
    creator.filters.from_params(as_params).tap do |filter|
      fields.each do |key, value|
        filter.public_send("#{key}=", value)
      end
    end
  end
  def default_indexed_by
    self.class.default_values[:indexed_by]
  end
  def default_indexed_by?
    default_value?(:indexed_by, indexed_by)
  end
  def default_sorted_by
    self.class.default_values[:sorted_by]
  end
  def default_sorted_by?
    default_value?(:sorted_by, sorted_by)
  end
end

================
File: app/models/filter/params.rb
================
module Filter::Params
  extend ActiveSupport::Concern
  PERMITTED_PARAMS = [
    :assignment_status,
    :indexed_by,
    :sorted_by,
    :creation,
    :closure,
    card_ids: [],
    assignee_ids: [],
    creator_ids: [],
    closer_ids: [],
    board_ids: [],
    tag_ids: [],
    terms: []
  ]
  class_methods do
    def find_by_params(params)
      find_by params_digest: digest_params(params)
    end
    def digest_params(params)
      Digest::MD5.hexdigest normalize_params(params).to_json
    end
    def normalize_params(params)
      params
        .to_h
        .compact_blank
        .reject(&method(:default_value?))
        .collect { |name, value| [ name, value.is_a?(Array) ? value.collect(&:to_s) : value.to_s ] }
        .sort_by { |name, _| name.to_s }
        .to_h
    end
  end
  included do
    before_save { self.params_digest = self.class.digest_params(as_params) }
  end
  def used?(ignore_boards: false)
    tags.any? || assignees.any? || creators.any? || closers.any? ||
      terms.any? || card_ids&.any? || (!ignore_boards && boards.present?) ||
      assignment_status.unassigned? || !indexed_by.all? || !sorted_by.latest?
  end
  # +as_params+ uses `resource#ids` instead of `#resource_ids`
  # because the latter won't work on unpersisted filters.
  def as_params
    @as_params ||= {}.tap do |params|
      params[:indexed_by]        = indexed_by
      params[:sorted_by]         = sorted_by
      params[:creation]          = creation
      params[:closure]           = closure
      params[:assignment_status] = assignment_status
      params[:terms]             = terms
      params[:tag_ids]           = tags.ids
      params[:board_ids]    = boards.ids
      params[:card_ids]          = card_ids
      params[:assignee_ids]      = assignees.ids
      params[:creator_ids]       = creators.ids
      params[:closer_ids]        = closers.ids
    end.compact_blank.reject(&method(:default_value?))
  end
  def as_params_without(key, value)
    as_params.dup.tap do |params|
      if params[key].is_a?(Array)
        params[key] = params[key] - [ value ]
        params.delete(key) if params[key].empty?
      elsif params[key] == value
        params.delete(key)
      end
    end
  end
  def params_digest
    super.presence || self.class.digest_params(as_params)
  end
end

================
File: app/models/filter/resources.rb
================
module Filter::Resources
  extend ActiveSupport::Concern
  included do
    has_and_belongs_to_many :tags
    has_and_belongs_to_many :boards
    has_and_belongs_to_many :assignees, class_name: "User", join_table: "assignees_filters", association_foreign_key: "assignee_id"
    has_and_belongs_to_many :creators, class_name: "User", join_table: "creators_filters", association_foreign_key: "creator_id"
    has_and_belongs_to_many :closers, class_name: "User", join_table: "closers_filters", association_foreign_key: "closer_id"
  end
  def resource_removed(resource)
    kind = resource.class.model_name.plural
    send "#{kind}=", send(kind).without(resource)
    @boards = nil
    empty? ? destroy! : save!
  rescue ActiveRecord::RecordNotUnique
    destroy!
  end
  def boards
    @boards ||= creator.boards.where id: super.ids
  end
  def board_titles
    if boards.none?
      creator.boards.one? ? [ creator.boards.first.name ] : [ "all boards" ]
    else
      boards.map(&:name)
    end
  end
  def boards_label
    board_titles.to_sentence
  end
end

================
File: app/models/filter/summarized.rb
================
module Filter::Summarized
  def summary
    [ index_summary, sort_summary, tag_summary, assignee_summary, creator_summary, terms_summary ].compact.to_sentence
  end
  private
    def index_summary
      unless indexed_by.all?
        indexed_by.humanize
      end
    end
    def sort_summary
      unless sorted_by.latest?
        sorted_by.humanize
      end
    end
    def tag_summary
      if tags.any?
        "#{tags.map(&:hashtag).to_choice_sentence}"
      end
    end
    def assignee_summary
      if assignees.any?
        "assigned to #{assignees.pluck(:name).to_choice_sentence}"
      elsif assignment_status.unassigned?
        "assigned to no one"
      end
    end
    def terms_summary
      if terms.any?
        "matching #{terms.map { |term| %Q("#{term}") }.to_sentence}"
      end
    end
    def creator_summary
      if creators.any?
        "added by #{creators.pluck(:name).to_choice_sentence}"
      end
    end
end

================
File: app/models/identity/access_token.rb
================
class Identity::AccessToken < ApplicationRecord
  belongs_to :identity
  has_secure_token
  enum :permission, %w[ read write ].index_by(&:itself), default: :read
  def allows?(method)
    method.in?(%w[ GET HEAD ]) || write?
  end
end

================
File: app/models/identity/joinable.rb
================
module Identity::Joinable
  extend ActiveSupport::Concern
  def join(account, **attributes)
    attributes[:name] ||= email_address
    transaction do
      account.users.find_or_create_by!(identity: self) do |user|
        user.assign_attributes(attributes)
      end.previously_new_record?
    end
  end
end

================
File: app/models/identity/transferable.rb
================
module Identity::Transferable
  extend ActiveSupport::Concern
  TRANSFER_LINK_EXPIRY_DURATION = 4.hours
  class_methods do
    def find_by_transfer_id(id)
      find_signed(id, purpose: :transfer)
    end
  end
  def transfer_id
    signed_id(purpose: :transfer, expires_in: TRANSFER_LINK_EXPIRY_DURATION)
  end
end

================
File: app/models/magic_link/code.rb
================
module MagicLink::Code
  CODE_SUBSTITUTIONS = { "O" => "0", "I" => "1", "L" => "1" }.freeze
  class << self
    def generate(length)
      SecureRandom.base32(length)
    end
    def sanitize(code)
      if code.present?
        normalize_code(code)
          .then { apply_substitutions(it) }
          .then { remove_invalid_characters(it) }
      end
    end
    private
      def normalize_code(code)
        code.to_s.upcase
      end
      def apply_substitutions(code)
        CODE_SUBSTITUTIONS.reduce(code) { |result, (from, to)| result.gsub(from, to) }
      end
      def remove_invalid_characters(code)
        code.gsub(/[^#{SecureRandom::BASE32_ALPHABET.join}]/, "")
      end
  end
end

================
File: app/models/notification/bundle.rb
================
class Notification::Bundle < ApplicationRecord
  belongs_to :account, default: -> { user.account }
  belongs_to :user
  enum :status, %i[ pending processing delivered ]
  scope :due, -> { pending.where("ends_at <= ?", Time.current) }
  scope :containing, ->(notification) { where("starts_at <= ? AND ends_at > ?", notification.created_at, notification.created_at) }
  scope :overlapping_with, ->(other_bundle) do
    where(
      "(starts_at <= ? AND ends_at >= ?) OR (starts_at <= ? AND ends_at >= ?) OR (starts_at >= ? AND ends_at <= ?)",
      other_bundle.starts_at, other_bundle.starts_at,
      other_bundle.ends_at, other_bundle.ends_at,
      other_bundle.starts_at, other_bundle.ends_at
    )
  end
  before_validation :set_default_window, if: :new_record?
  validate :validate_no_overlapping
  class << self
    def deliver_all
      due.in_batches do |batch|
        jobs = batch.collect { DeliverJob.new(it) }
        ActiveJob.perform_all_later jobs
      end
    end
    def deliver_all_later
      DeliverAllJob.perform_later
    end
  end
  def notifications
    user.notifications.where(created_at: window).unread
  end
  def deliver
    user.in_time_zone do
      Current.with_account(user.account) do
        processing!
        Notification::BundleMailer.notification(self).deliver if deliverable?
        delivered!
      end
    end
  end
  def deliver_later
    DeliverJob.perform_later(self)
  end
  def flush
    update!(ends_at: Time.current)
    deliver_later
  end
  def set_default_window
    self.starts_at ||= Time.current
    self.ends_at ||= self.starts_at + user.settings.bundle_aggregation_period
  end
  private
    def window
      starts_at..ends_at
    end
    def validate_no_overlapping
      if overlapping_bundles.exists?
        errors.add(:base, "Bundle window overlaps with an existing pending bundle with id #{overlapping_bundles.first.id}")
      end
    end
    def deliverable?
      user.settings.bundling_emails? && notifications.any? && account.active?
    end
    def overlapping_bundles
      user.notification_bundles.where.not(id: id).overlapping_with(self)
    end
end

================
File: app/models/notifier/card_event_notifier.rb
================
class Notifier::CardEventNotifier < Notifier
  delegate :creator, to: :source
  delegate :board, to: :card
  private
    def recipients
      case source.action
      when "card_assigned"
        source.assignees.excluding(creator)
      when "card_published"
        board.watchers.without(creator, *card.mentionees).including(*card.assignees).uniq
      when "comment_created"
        card.watchers.without(creator, *source.eventable.mentionees)
      else
        board.watchers.without(creator)
      end
    end
    def card
      source.eventable
    end
end

================
File: app/models/notifier/comment_event_notifier.rb
================
class Notifier::CommentEventNotifier < Notifier
  delegate :creator, to: :source
  private
    def recipients
      card.watchers.without(creator, *source.eventable.mentionees)
    end
    def card
      source.eventable.card
    end
end

================
File: app/models/notifier/mention_notifier.rb
================
class Notifier::MentionNotifier < Notifier
  alias mention source
  private
    def recipients
      if mention.self_mention?
        []
      else
        [ mention.mentionee ]
      end
    end
    def creator
      mention.mentioner
    end
end

================
File: app/models/push/subscription.rb
================
class Push::Subscription < ApplicationRecord
  PERMITTED_ENDPOINT_HOSTS = %w[
    jmt17.google.com
    fcm.googleapis.com
    updates.push.services.mozilla.com
    web.push.apple.com
    notify.windows.com
  ].freeze
  belongs_to :account, default: -> { user.account }
  belongs_to :user
  validates :endpoint, presence: true
  validate :validate_endpoint_url
  def notification(**params)
    WebPush::Notification.new(
      **params,
      badge: user.notifications.unread.count,
      endpoint: endpoint,
      endpoint_ip: resolved_endpoint_ip,
      p256dh_key: p256dh_key,
      auth_key: auth_key
    )
  end
  def resolved_endpoint_ip
    return @resolved_endpoint_ip if defined?(@resolved_endpoint_ip)
    @resolved_endpoint_ip = SsrfProtection.resolve_public_ip(endpoint_uri&.host)
  end
  private
    def endpoint_uri
      @endpoint_uri ||= URI.parse(endpoint) if endpoint.present?
    rescue URI::InvalidURIError
      nil
    end
    def validate_endpoint_url
      if endpoint_uri.nil?
        errors.add(:endpoint, "is not a valid URL")
      elsif endpoint_uri.scheme != "https"
        errors.add(:endpoint, "must use HTTPS")
      elsif !permitted_endpoint_host?
        errors.add(:endpoint, "is not a permitted push service")
      elsif resolved_endpoint_ip.nil?
        errors.add(:endpoint, "resolves to a private or invalid IP address")
      end
    end
    def permitted_endpoint_host?
      host = endpoint_uri&.host&.downcase
      PERMITTED_ENDPOINT_HOSTS.any? { |permitted| host&.end_with?(permitted) }
    end
end

================
File: app/models/search/record/sqlite/fts.rb
================
class Search::Record::SQLite::Fts < ApplicationRecord
  self.table_name = "search_records_fts"
  self.primary_key = "rowid"
  # FTS5 virtual table columns
  attribute :rowid, :integer
  attribute :title, :string
  attribute :content, :string
  # FTS5 virtual tables don't expose rowid in the schema by default
  # We need to explicitly select it when loading records
  scope :with_rowid, -> { select(:rowid, :title, :content) }
  def self.upsert(rowid, title, content)
    connection.exec_query(
      "INSERT OR REPLACE INTO search_records_fts(rowid, title, content) VALUES (?, ?, ?)",
      "Search::Record::SQLite::Fts Upsert",
      [ rowid, title, content ]
    )
  end
end

================
File: app/models/search/record/sqlite.rb
================
module Search::Record::SQLite
  extend ActiveSupport::Concern
  included do
    attribute :result_title, :string
    attribute :result_content, :string
    has_one :search_records_fts, -> { with_rowid },
      class_name: "Search::Record::SQLite::Fts", foreign_key: :rowid, primary_key: :id, dependent: :destroy
    after_save :upsert_to_fts5_table
    scope :matching, ->(query, account_id) { joins(:search_records_fts).where("search_records_fts MATCH ?", query) }
  end
  class_methods do
    def search_fields(query)
      opening_mark = connection.quote(Search::Highlighter::OPENING_MARK)
      closing_mark = connection.quote(Search::Highlighter::CLOSING_MARK)
      ellipsis = connection.quote(Search::Highlighter::ELIPSIS)
      [ "highlight(search_records_fts, 0, #{opening_mark}, #{closing_mark}) AS result_title",
        "snippet(search_records_fts, 1, #{opening_mark}, #{closing_mark}, #{ellipsis}, 20) AS result_content",
        "#{connection.quote(query.terms)} AS query" ]
    end
    def for(account_id)
      self
    end
  end
  def card_title
    escape_fts_highlight(result_title || card.title)
  end
  def card_description
    escape_fts_highlight(result_content) unless comment
  end
  def comment_body
    escape_fts_highlight(result_content) if comment
  end
  private
    def escape_fts_highlight(html)
      return nil unless html.present?
      CGI.escapeHTML(html)
        .gsub(CGI.escapeHTML(Search::Highlighter::OPENING_MARK), Search::Highlighter::OPENING_MARK)
        .gsub(CGI.escapeHTML(Search::Highlighter::CLOSING_MARK), Search::Highlighter::CLOSING_MARK)
        .html_safe
    end
    def upsert_to_fts5_table
      Fts.upsert(id, title, content)
    end
end

================
File: app/models/search/record/trilogy.rb
================
module Search::Record::Trilogy
  extend ActiveSupport::Concern
  SHARD_COUNT = 16
  included do
    self.abstract_class = true
    before_save :set_account_key, :stem_content
    scope :matching, ->(query, account_id) do
      full_query = "+account#{account_id} +(#{Search::Stemmer.stem(query)})"
      where("MATCH(#{table_name}.account_key, #{table_name}.content, #{table_name}.title) AGAINST(? IN BOOLEAN MODE)", full_query)
    end
    SHARD_CLASSES = SHARD_COUNT.times.map do |shard_id|
      Class.new(self) do
        self.table_name = "search_records_#{shard_id}"
        def self.name
          "Search::Record"
        end
      end
    end.freeze
  end
  class_methods do
    def shard_id_for_account(account_id)
      Zlib.crc32(account_id.to_s) % SHARD_COUNT
    end
    def search_fields(query)
      "#{connection.quote(query.terms)} AS query"
    end
    def for(account_id)
      SHARD_CLASSES[shard_id_for_account(account_id)]
    end
  end
  def card_title
    highlight(card.title, show: :full) if card_id
  end
  def card_description
    highlight(card.description.to_plain_text, show: :snippet) if card_id
  end
  def comment_body
    highlight(comment.body.to_plain_text, show: :snippet) if comment
  end
  private
    def stem_content
      self.title = Search::Stemmer.stem(title) if title_changed?
      self.content = Search::Stemmer.stem(content) if content_changed?
    end
    def set_account_key
      self.account_key = "account#{account_id}"
    end
    def highlight(text, show:)
      if text.present? && attribute?(:query)
        highlighter = Search::Highlighter.new(query)
        show == :snippet ? highlighter.snippet(text) : highlighter.highlight(text)
      else
        text
      end
    end
end

================
File: app/models/search/highlighter.rb
================
class Search::Highlighter
  OPENING_MARK = "<mark class=\"circled-text\"><span></span>"
  CLOSING_MARK = "</mark>"
  ELIPSIS = "..."
  attr_reader :query
  def initialize(query)
    @query = query
  end
  def highlight(text)
    result = text.dup
    terms.each do |term|
      result.gsub!(/\b(#{Regexp.escape(term)}\w*)\b/i) do |match|
        "#{OPENING_MARK}#{match}#{CLOSING_MARK}"
      end
    end
    escape_highlight_marks(result)
  end
  def snippet(text, max_words: 20)
    words = text.split(/\s+/)
    match_index = words.index { |word| terms.any? { |term| word.downcase.include?(term.downcase) } }
    if words.length <= max_words
      highlight(text)
    elsif match_index
      start_index = [ 0, match_index - max_words / 2 ].max
      end_index = [ words.length - 1, start_index + max_words - 1 ].min
      snippet_text = words[start_index..end_index].join(" ")
      snippet_text = "...#{snippet_text}" if start_index > 0
      snippet_text = "#{snippet_text}..." if end_index < words.length - 1
      highlight(snippet_text)
    else
      text.truncate_words(max_words, omission: "...")
    end
  end
  private
    def terms
      @terms ||= begin
        terms = []
        query.scan(/"([^"]+)"/) do |phrase|
          terms << phrase.first
        end
        unquoted = query.gsub(/"[^"]+"/, "")
        unquoted.split(/\s+/).each do |word|
          terms << word if word.present?
        end
        terms.uniq
      end
    end
    def escape_highlight_marks(html)
      CGI.escapeHTML(html)
        .gsub(CGI.escapeHTML(OPENING_MARK), OPENING_MARK.html_safe)
        .gsub(CGI.escapeHTML(CLOSING_MARK), CLOSING_MARK.html_safe)
        .html_safe
    end
end

================
File: app/models/search/query.rb
================
class Search::Query < ApplicationRecord
  belongs_to :account, default: -> { user&.account || Current.account }
  belongs_to :user, optional: true
  validates :terms, presence: true
  before_validation :sanitize_terms
  delegate :to_s, to: :terms
  class << self
    def wrap(query)
      if query.is_a?(self)
        query
      else
        self.new(terms: query)
      end
    end
  end
  private
    def sanitize_terms
      self.terms = sanitize(terms)
    end
    def sanitize(terms)
      if terms.present?
        terms = remove_invalid_search_characters(self.terms)
        terms = remove_unbalanced_quotes(terms)
        terms.presence
      else
        terms
      end
    end
    def remove_invalid_search_characters(terms)
      terms.gsub(/[^\w"]/, " ")
    end
    def remove_unbalanced_quotes(terms)
      if terms.count("\"").even?
        terms
      else
        terms.gsub("\"", " ")
      end
    end
end

================
File: app/models/search/record.rb
================
class Search::Record < ApplicationRecord
  include const_get(connection.adapter_name)
  belongs_to :searchable, polymorphic: true
  belongs_to :card
  validates :account_id, :searchable_type, :searchable_id, :card_id, :board_id, :created_at, presence: true
  class << self
    def upsert!(attributes)
      record = find_by(searchable_type: attributes[:searchable_type], searchable_id: attributes[:searchable_id])
      if record
        record.update!(attributes)
        record
      else
        create!(attributes)
      end
    end
    def card_join
      "INNER JOIN #{table_name} ON #{table_name}.card_id = cards.id"
    end
  end
  scope :for_query, ->(query, user:) do
    query = Search::Query.wrap(query)
    if query.valid? && user.board_ids.any?
      matching(query.to_s, user.account_id).where(account_id: user.account_id, board_id: user.board_ids)
    else
      none
    end
  end
  scope :search, ->(query, user:) do
    query = Search::Query.wrap(query)
    for_query(query, user: user)
      .includes(:searchable, card: [ :board, :creator ])
      .order(created_at: :desc)
      .select(:id, :account_id, :searchable_type, :searchable_id, :card_id, :board_id, :title, :content, :created_at, *search_fields(query))
  end
  def source
    searchable_type == "Comment" ? searchable : card
  end
  def comment
    searchable if searchable_type == "Comment"
  end
end

================
File: app/models/search/result.rb
================
class Search::Result < ApplicationRecord
  attribute :card_id, :uuid
  attribute :comment_id, :uuid
  attribute :creator_id, :uuid
  belongs_to :creator, class_name: "User"
  belongs_to :card, foreign_key: :card_id, optional: true
  belongs_to :comment, foreign_key: :comment_id, optional: true
  def card_title
    highlight(card.title, show: :full) if card_id
  end
  def card_description
    highlight(card.description.to_plain_text, show: :snippet) if card_id
  end
  def comment_body
    highlight(comment.body.to_plain_text, show: :snippet) if comment_id
  end
  def source
    comment_id.present? ? comment : card
  end
  def readonly?
    true
  end
  private
    def highlight(text, show:)
      if text.present? && attribute?(:query)
        highlighter = Search::Highlighter.new(query)
        show == :snippet ? highlighter.snippet(text) : highlighter.highlight(text)
      else
        text
      end
    end
end

================
File: app/models/search/stemmer.rb
================
module Search::Stemmer
  extend self
  STEMMER = Mittens::Stemmer.new
  def stem(value)
    if value.present?
      value.gsub(/[^\w\s]/, "").split(/\s+/).map { |word| STEMMER.stem(word.downcase) }.join(" ")
    else
      value
    end
  end
end

================
File: app/models/signup/account_name_generator.rb
================
class Signup::AccountNameGenerator
  SUFFIX = "Fizzy".freeze
  attr_reader :identity, :name
  def initialize(identity:, name:)
    @identity = identity
    @name = name
  end
  def generate
    next_index = current_index + 1
    if next_index == 1
      "#{prefix} #{SUFFIX}"
    else
      "#{prefix} #{next_index.ordinalize} #{SUFFIX}"
    end
  end
  private
    def current_index
      existing_indices.max || 0
    end
    def existing_indices
      Current.without_account do
        identity.accounts.filter_map do |account|
          if account.name.match?(first_account_name_regex)
            1
          elsif match = account.name.match(nth_account_name_regex)
            match[1].to_i
          end
        end
      end
    end
    def first_account_name_regex
      @first_account_name_regex ||= /\A#{prefix}\s+#{SUFFIX}\Z/i
    end
    def nth_account_name_regex
      @nth_account_name_regex ||= /\A#{prefix}\s+(1st|2nd|3rd|\d+th)\s+#{SUFFIX}/i
    end
    def prefix
      @prefix ||= "#{first_name}'s"
    end
    def first_name
      name.strip.split(" ", 2).first
    end
end

================
File: app/models/storage/attachment_tracking.rb
================
module Storage::AttachmentTracking
  extend ActiveSupport::Concern
  included do
    # Snapshot IDs in before_destroy since parent record may be deleted
    # by the time after_destroy_commit runs
    before_destroy :snapshot_storage_context
    after_create_commit :record_storage_attach
    after_destroy_commit :record_storage_detach
  end
  private
    def record_storage_attach
      return unless storage_tracked_record
      Storage::Entry.record \
        account: storage_tracked_record.account,
        board: storage_tracked_record.board_for_storage_tracking,
        recordable: storage_tracked_record,
        blob: blob,
        delta: blob.byte_size,
        operation: "attach"
    end
    def record_storage_detach
      return unless @storage_snapshot
      Storage::Entry.record \
        account: @storage_snapshot[:account],
        board: @storage_snapshot[:board],
        recordable: @storage_snapshot[:recordable],
        blob: blob,
        delta: -blob.byte_size,
        operation: "detach"
    end
    # Snapshot records in before_destroy since parent may be deleted by the time
    # after_destroy_commit runs. The records may be destroyed but .id still works.
    def snapshot_storage_context
      return unless storage_tracked_record
      @storage_snapshot = {
        account: storage_tracked_record.account,
        board: storage_tracked_record.board_for_storage_tracking,
        recordable: storage_tracked_record
      }
    end
    def storage_tracked_record
      record.try(:storage_tracked_record)
    end
end

================
File: app/models/storage/entry.rb
================
class Storage::Entry < ApplicationRecord
  belongs_to :account
  belongs_to :board, optional: true
  belongs_to :recordable, polymorphic: true, optional: true
  scope :pending, ->(last_entry_id) { where.not(id: ..last_entry_id) if last_entry_id }
  # Records may be destroyed (during cascading deletes) but .id still works.
  # Skip entirely if account is destroyed - no need to track storage for deleted accounts.
  # Skip materialize jobs for destroyed boards since there's nothing to update.
  def self.record(delta:, operation:, account:, board: nil, recordable: nil, blob: nil)
    return if delta.zero?
    return if account.destroyed?
    entry = create! \
      account_id: account.id,
      board_id: board&.id,
      recordable_type: recordable&.class&.name,
      recordable_id: recordable&.id,
      blob_id: blob&.id,
      delta: delta,
      operation: operation,
      user_id: Current.user&.id,
      request_id: Current.request_id
    account.materialize_storage_later
    board&.materialize_storage_later unless board&.destroyed?
    entry
  end
end

================
File: app/models/storage/total.rb
================
class Storage::Total < ApplicationRecord
  belongs_to :owner, polymorphic: true
  def pending_entries
    owner.storage_entries.pending(last_entry_id)
  end
  # Exact current usage (snapshot + pending)
  def current_usage
    bytes_stored + pending_entries.sum(:delta)
  end
end

================
File: app/models/tag/attachable.rb
================
module Tag::Attachable
  extend ActiveSupport::Concern
  included do
    include ActionText::Attachable
    def attachable_plain_text_representation(...)
      "##{title}"
    end
  end
end

================
File: app/models/user/day_timeline/column.rb
================
class User::DayTimeline::Column
  include ActionView::Helpers::TagHelper, ActionView::Helpers::OutputSafetyHelper, TimeHelper
  attr_reader :index, :id, :base_title, :day_timeline, :events
  def initialize(day_timeline, id, base_title, index, events)
    @id = id
    @day_timeline = day_timeline
    @base_title = base_title
    @index = index
    @events = events
  end
  def title
    date_tag = local_datetime_tag(day_timeline.day, style: :agoorweekday)
    parts = [ base_title, date_tag ]
    parts << tag.span("(#{full_events_count})", class: "font-weight-normal") if full_events_count > 0
    safe_join(parts, " ")
  end
  def events_by_hour
    limited_events.group_by { it.created_at.hour }
  end
  def has_more_events?
    limited_events.count < full_events_count
  end
  def hidden_events_count
    full_events_count - limited_events.count
  end
  def to_param
    id
  end
  private
    def limited_events
      @limited_events ||= events.limit(100).load
    end
    def full_events_count
      @full_events_count ||= events.count
    end
end

================
File: app/models/user/day_timeline/serializable.rb
================
module User::DayTimeline::Serializable
  extend ActiveSupport::Concern
  included do
    include GlobalID::Identification # For active job serialization
    alias id to_json
  end
  class_methods do
    def find(id)
      data = JSON.parse(id).with_indifferent_access
      user = User.find(data[:user_id])
      day = Time.zone.parse(data[:day])
      filter = user.filters.from_params data[:filter_params]
      new(user, day, filter)
    end
    def tenanted?
      # TODO: Check with Mike
      false
    end
  end
  def as_json(options = {})
    { user_id: user.id, day: day.to_s, filter_params: filter.as_params }
  end
end

================
File: app/models/user/accessor.rb
================
module User::Accessor
  extend ActiveSupport::Concern
  included do
    has_many :accesses, dependent: :destroy
    has_many :boards, through: :accesses
    has_many :accessible_columns, through: :boards, source: :columns
    has_many :accessible_cards, through: :boards, source: :cards
    has_many :accessible_comments, through: :accessible_cards, source: :comments
    after_create_commit :grant_access_to_boards, unless: :system?
  end
  def draft_new_card_in(board)
    board.cards.find_or_initialize_by(creator: self, status: "drafted").tap do |card|
      card.update!(created_at: Time.current, updated_at: Time.current, last_active_at: Time.current)
    end
  end
  private
    def grant_access_to_boards
      Access.insert_all account.boards.all_access.ids.collect { |board_id| { id: ActiveRecord::Type::Uuid.generate, board_id: board_id, user_id: id, account_id: account.id } }
    end
end

================
File: app/models/user/assignee.rb
================
module User::Assignee
  extend ActiveSupport::Concern
  included do
    has_many :assignments, foreign_key: :assignee_id, dependent: :destroy
    has_many :assignings, foreign_key: :assigner_id, class_name: "Assignment"
    has_many :assigned_cards, through: :assignments, source: :card
  end
end

================
File: app/models/user/attachable.rb
================
module User::Attachable
  extend ActiveSupport::Concern
  included do
    include ActionText::Attachable
    def attachable_plain_text_representation(...)
      "@#{first_name.downcase}"
    end
  end
end

================
File: app/models/user/avatar.rb
================
module User::Avatar
  extend ActiveSupport::Concern
  ALLOWED_AVATAR_CONTENT_TYPES = %w[ image/jpeg image/png image/gif image/webp ].freeze
  MAX_AVATAR_DIMENSIONS = { width: 4096, height: 4096 }.freeze
  included do
    has_one_attached :avatar do |attachable|
      attachable.variant :thumb, resize_to_fill: [ 256, 256 ], process: :immediately
    end
    scope :with_avatars, -> { preload(:account, :avatar_attachment) }
    validate :avatar_content_type_allowed, :avatar_dimensions_allowed, if: :avatar_attached?
  end
  def avatar_attached?
    avatar.attached?
  end
  def avatar_thumbnail
    avatar.variable? ? avatar.variant(:thumb) : avatar
  end
  # Avatars are always publicly accessible
  def publicly_accessible?
    true
  end
  private
    def avatar_content_type_allowed
      if !ALLOWED_AVATAR_CONTENT_TYPES.include?(avatar.content_type)
        errors.add(:avatar, "must be a JPEG, PNG, GIF, or WebP image")
      end
    end
    def avatar_dimensions_allowed
      return unless avatar.blob.analyzed? || avatar.blob.analyze
      width = avatar.blob.metadata[:width]
      height = avatar.blob.metadata[:height]
      if width && width > MAX_AVATAR_DIMENSIONS[:width]
        errors.add(:avatar, "width must be less than #{MAX_AVATAR_DIMENSIONS[:width]}px")
      end
      if height && height > MAX_AVATAR_DIMENSIONS[:height]
        errors.add(:avatar, "height must be less than #{MAX_AVATAR_DIMENSIONS[:height]}px")
      end
    end
end

================
File: app/models/user/configurable.rb
================
module User::Configurable
  extend ActiveSupport::Concern
  included do
    has_one :settings, class_name: "User::Settings", dependent: :destroy
    has_many :push_subscriptions, class_name: "Push::Subscription", dependent: :delete_all
    after_create :create_settings, unless: :system?
    delegate :timezone, to: :settings, allow_nil: true
  end
  def in_time_zone(&block)
    Time.use_zone(timezone, &block)
  end
end

================
File: app/models/user/data_export.rb
================
class User::DataExport < Export
  private
    def filename
      "fizzy-user-data-export-#{id}.zip"
    end
    def populate_zip(zip)
      exportable_cards.find_each do |card|
        add_card_to_zip(zip, card)
      end
    end
    def exportable_cards
      user.accessible_cards.includes(
        :board,
        creator: :identity,
        comments: { creator: :identity },
        rich_text_description: { embeds_attachments: :blob }
      )
    end
    def add_card_to_zip(zip, card)
      zip.add_file("#{card.number}.json", card.export_json)
      card.export_attachments.each do |attachment|
        zip.add_file(attachment[:path], compress: false) do |f|
          attachment[:blob].download { |chunk| f.write(chunk) }
        end
      rescue ActiveStorage::FileNotFoundError
        # Skip attachments where the file is missing from storage
      end
    end
end

================
File: app/models/user/day_timeline.rb
================
class User::DayTimeline
  include Serializable
  attr_reader :user, :day, :filter
  delegate :today?, to: :day
  def initialize(user, day, filter)
    @user, @day, @filter = user, day, filter
  end
  def has_activity?
    events.any?
  end
  def events
    filtered_events.where(created_at: window).order(created_at: :desc)
  end
  def next_day
    latest_event_before&.created_at
  end
  def earliest_time
    next_day&.tomorrow&.beginning_of_day
  end
  def latest_time
    day.yesterday.beginning_of_day
  end
  def added_column
    @added_column ||= build_column(:added, "Added", 1, events.where(action: %w[card_published card_reopened]))
  end
  def updated_column
    @updated_column ||= build_column(:updated, "Updated", 2, events.where.not(action: %w[card_published card_closed card_reopened]))
  end
  def closed_column
    @closed_column ||= build_column(:closed, "Done", 3, events.where(action: "card_closed"))
  end
  def cache_key
    ActiveSupport::Cache.expand_cache_key [ user, filter, day.to_date, events ], "day-timeline"
  end
  private
    TIMELINEABLE_ACTIONS = %w[
      card_assigned
      card_unassigned
      card_published
      card_closed
      card_reopened
      card_collection_changed
      card_board_changed
      card_postponed
      card_auto_postponed
      card_triaged
      card_sent_back_to_triage
      comment_created
    ]
    def filtered_events
      @filtered_events ||= begin
        events = timelineable_events
        events = events.where(creator_id: filter.creators.ids) if filter.creators.present?
        events
      end
    end
    def timelineable_events
      Event
        .preloaded
        .where(board: boards)
        .where(action: TIMELINEABLE_ACTIONS)
    end
    def boards
      filter.boards.presence || user.boards
    end
    def latest_event_before
      filtered_events.where(created_at: ...day.beginning_of_day).chronologically.last
    end
    def build_column(id, base_title, index, events)
      Column.new(self, id, base_title, index, events)
    end
    def window
      day.all_day
    end
end

================
File: app/models/user/email_address_changeable.rb
================
module User::EmailAddressChangeable
  EMAIL_CHANGE_TOKEN_PURPOSE = "change_email_address"
  EMAIL_CHANGE_TOKEN_EXPIRATION = 30.minutes
  extend ActiveSupport::Concern
  def change_email_address_using_token(token)
    parsed_token = SignedGlobalID.parse(token, for: EMAIL_CHANGE_TOKEN_PURPOSE)
    old_email_address = parsed_token&.params&.fetch("old_email_address")
    new_email_address = parsed_token&.params&.fetch("new_email_address")
    if parsed_token.nil? || parsed_token.find != self || identity.email_address != old_email_address
      false
    else
      change_email_address(new_email_address)
    end
  end
  def send_email_address_change_confirmation(new_email_address)
    token = generate_email_address_change_token(
      to: new_email_address,
      expires_in: EMAIL_CHANGE_TOKEN_EXPIRATION
    )
    UserMailer.email_change_confirmation(
      email_address: new_email_address,
      token: token,
      user: self
    ).deliver_later
  end
  def change_email_address(new_email_address)
    transaction do
      new_identity = Identity.find_or_create_by!(email_address: new_email_address)
      update!(identity: new_identity)
    end
  end
  private
    def generate_email_address_change_token(from: identity.email_address, to:, **options)
      options = options.with_defaults(
        for: EMAIL_CHANGE_TOKEN_PURPOSE,
        old_email_address: from,
        new_email_address: to,
      )
      to_sgid(**options).to_s
    end
end

================
File: app/models/user/filtering.rb
================
class User::Filtering
  attr_reader :user, :filter, :expanded
  delegate :as_params, :single_board, to: :filter
  delegate :only_closed?, to: :filter
  def initialize(user, filter, expanded: false)
    @user, @filter, @expanded = user, filter, expanded
  end
  def boards
    @boards ||= user.boards.ordered_by_recently_accessed
  end
  def selected_board_titles
    filter.board_titles
  end
  def selected_boards_label
    filter.boards_label
  end
  def tags
    @tags ||= account.tags.all.alphabetically
  end
  def users
    @users ||= account.users.active.alphabetically
  end
  def filters
    @filters ||= user.filters.all
  end
  def expanded?
    @expanded
  end
  def any?
    filter.used?(ignore_boards: true)
  end
  def show_indexed_by?
    !filter.indexed_by.all?
  end
  def show_sorted_by?
    !filter.sorted_by.latest?
  end
  def show_tags?
    return unless Tag.any?
    filter.tags.any?
  end
  def show_assignees?
    filter.assignees.any?
  end
  def show_creators?
    filter.creators.any?
  end
  def show_closers?
    filter.closers.any?
  end
  def show_boards?
    filter.boards.any?
  end
  def single_board_or_first
    # Default to the first selected or, when no selection, to the first one
    filter.boards.first || boards.first
  end
  def cache_key
    ActiveSupport::Cache.expand_cache_key([ user, filter, expanded?, boards, tags, users, filters ], "user-filtering")
  end
  private
    def account
      user.account
    end
end

================
File: app/models/user/mentionable.rb
================
module User::Mentionable
  extend ActiveSupport::Concern
  included do
    has_many :mentions, dependent: :destroy, inverse_of: :mentionee
    # Need to set in the included block so that it overrides Action Text's
    def to_attachable_partial_path
      "users/attachable"
    end
  end
  def mentioned_by(mentioner, at:)
    mentions.find_or_create_by! source: at, mentioner: mentioner
  end
  def mentionable_handles
    [ initials, first_name, first_name_with_last_name_initial ].collect(&:downcase)
  end
  def content_type
    "application/vnd.actiontext.mention"
  end
  private
    def first_name_with_last_name_initial
      "#{first_name}#{last_name&.first}"
    end
end

================
File: app/models/user/named.rb
================
module User::Named
  extend ActiveSupport::Concern
  included do
    scope :alphabetically, -> { order("lower(name)") }
  end
  def first_name
    name.split(/\s/).first
  end
  def last_name
    name.split(/\s/, 2).last
  end
  def initials
    name.scan(/\b\p{L}/).join.upcase
  end
  def familiar_name
    names = name.split
    return name if names.length <= 1
    "#{names.first} #{names[1..].map { |n| "#{n[0]}." }.join}"
  end
end

================
File: app/models/user/notifiable.rb
================
module User::Notifiable
  extend ActiveSupport::Concern
  included do
    has_many :notifications, dependent: :destroy
    has_many :notification_bundles, class_name: "Notification::Bundle", dependent: :destroy
    generates_token_for :unsubscribe, expires_in: 1.month
  end
  def bundle(notification)
    with_lock do
      find_or_create_bundle_for(notification)
    end
  end
  private
    def find_or_create_bundle_for(notification)
      find_bundle_for(notification) || expand_pending_bundle_for(notification) || create_bundle_for(notification)
    end
    def find_bundle_for(notification)
      notification_bundles.pending.containing(notification).last
    end
    def expand_pending_bundle_for(notification)
      pending = notification_bundles.pending.last
      if pending.present? && notification.created_at < pending.starts_at
        pending.update!(starts_at: notification.created_at) # expand the window to include this notification
      end
    end
    def create_bundle_for(notification)
      notification_bundles.create!(starts_at: notification.created_at)
    end
end

================
File: app/models/user/role.rb
================
module User::Role
  extend ActiveSupport::Concern
  included do
    enum :role, %i[ owner admin member system ].index_by(&:itself), scopes: false
    scope :owner, -> { where(active: true, role: :owner) }
    scope :admin, -> { where(active: true, role: %i[ owner admin ]) }
    scope :member, -> { where(active: true, role: :member) }
    scope :active, -> { where(active: true, role: %i[ owner admin member ]) }
    def admin?
      super || owner?
    end
  end
  def can_change?(other)
    (admin? && !other.owner?) || other == self
  end
  def can_administer?(other)
    admin? && !other.owner? && other != self
  end
  def can_administer_board?(board)
    admin? || board.creator == self
  end
  def can_administer_card?(card)
    admin? || card.creator == self
  end
end

================
File: app/models/user/searcher.rb
================
module User::Searcher
  extend ActiveSupport::Concern
  included do
    has_many :search_queries, class_name: "Search::Query", dependent: :destroy
  end
  def search(terms)
    Search::Record.for(account_id).search(terms, user: self)
  end
  def remember_search(terms)
    search_queries.find_or_create_by(terms: terms).tap do |search_query|
      search_query.touch unless search_query.invalid? || search_query.previously_new_record?
    end
  end
end

================
File: app/models/user/settings.rb
================
class User::Settings < ApplicationRecord
  belongs_to :account, default: -> { user.account }
  belongs_to :user
  enum :bundle_email_frequency, %i[ never every_few_hours daily weekly ],
    default: :every_few_hours, prefix: :bundle_email
  after_update :review_pending_bundles, if: :saved_change_to_bundle_email_frequency?
  def bundle_aggregation_period
    case bundle_email_frequency
    when "every_few_hours"
      4.hours
    when "daily"
      1.day
    when "weekly"
      1.week
    else
      1.day
    end
  end
  def bundling_emails?
    !bundle_email_never? && !user.system? && user.active? && user.verified?
  end
  def timezone
    if timezone_name.present?
      ActiveSupport::TimeZone[timezone_name] || default_timezone
    else
      default_timezone
    end
  end
  private
    def review_pending_bundles
      if bundling_emails?
        flush_pending_bundles
      else
        cancel_pending_bundles
      end
    end
    def cancel_pending_bundles
      user.notification_bundles.pending.find_each do |bundle|
        bundle.destroy
      end
    end
    def flush_pending_bundles
      user.notification_bundles.pending.find_each(&:flush)
    end
    def default_timezone
      ActiveSupport::TimeZone["UTC"]
    end
end

================
File: app/models/user/timelined.rb
================
module User::Timelined
  extend ActiveSupport::Concern
  included do
    has_many :accessible_events, through: :boards, source: :events
  end
  def timeline_for(day, filter:)
    User::DayTimeline.new(self, day, filter)
  end
end

================
File: app/models/user/transferable.rb
================
module User::Transferable
  extend ActiveSupport::Concern
  TRANSFER_LINK_EXPIRY_DURATION = 4.hours
  class_methods do
    def find_by_transfer_id(id)
      find_signed(id, purpose: :transfer)
    end
  end
  def transfer_id
    signed_id(purpose: :transfer, expires_in: TRANSFER_LINK_EXPIRY_DURATION)
  end
end

================
File: app/models/user/watcher.rb
================
module User::Watcher
  extend ActiveSupport::Concern
  included do
    has_many :watches, dependent: :destroy
  end
end

================
File: app/models/webhook/delinquency_tracker.rb
================
class Webhook::DelinquencyTracker < ApplicationRecord
  DELINQUENCY_THRESHOLD = 10
  DELINQUENCY_DURATION = 1.hour
  belongs_to :account, default: -> { webhook.account }
  belongs_to :webhook
  def record_delivery_of(delivery)
    if delivery.succeeded?
      reset
    else
      mark_first_failure_time if consecutive_failures_count.zero?
      increment!(:consecutive_failures_count, touch: true)
      webhook.deactivate if delinquent?
    end
  end
  private
    def reset
      update_columns consecutive_failures_count: 0, first_failure_at: nil
    end
    def mark_first_failure_time
      update_columns first_failure_at: Time.current
    end
    def delinquent?
      failing_for_too_long? && too_many_consecutive_failures?
    end
    def failing_for_too_long?
      if first_failure_at
        first_failure_at.before?(DELINQUENCY_DURATION.ago)
      else
        false
      end
    end
    def too_many_consecutive_failures?
      consecutive_failures_count >= DELINQUENCY_THRESHOLD
    end
end

================
File: app/models/webhook/delivery.rb
================
class Webhook::Delivery < ApplicationRecord
  include Rails.application.routes.url_helpers
  class ResponseTooLarge < StandardError; end
  STALE_TRESHOLD = 7.days
  USER_AGENT = "fizzy/1.0.0 Webhook"
  ENDPOINT_TIMEOUT = 7.seconds
  MAX_RESPONSE_SIZE = 100.kilobytes
  belongs_to :account, default: -> { webhook.account }
  belongs_to :webhook
  belongs_to :event
  store :request, coder: JSON
  store :response, coder: JSON
  enum :state, %w[ pending in_progress completed errored ].index_by(&:itself), default: :pending
  scope :ordered, -> { order created_at: :desc, id: :desc }
  scope :stale, -> { where(created_at: ...STALE_TRESHOLD.ago) }
  after_create_commit :deliver_later
  def self.cleanup
    stale.delete_all
  end
  def deliver_later
    Webhook::DeliveryJob.perform_later(self)
  end
  def deliver
    in_progress!
    self.request[:headers] = headers
    self.response = perform_request
    self.state = :completed
    save!
    webhook.delinquency_tracker.record_delivery_of(self)
  rescue
    errored!
    raise
  end
  def failed?
    (errored? || completed?) && !succeeded?
  end
  def succeeded?
    completed? && response[:error].blank? && response[:code].between?(200, 299)
  end
  private
    def perform_request
      if resolved_ip.nil?
        { error: :private_uri }
      else
        request = Net::HTTP::Post.new(uri, headers).tap { |request| request.body = payload }
        response = http.request(request) do |net_http_response|
          stream_body_with_limit(net_http_response)
        end
        { code: response.code.to_i }
      end
    rescue ResponseTooLarge
      { error: :response_too_large }
    rescue Resolv::ResolvTimeout, Resolv::ResolvError, SocketError
      { error: :dns_lookup_failed }
    rescue Net::OpenTimeout, Net::ReadTimeout, Errno::ETIMEDOUT
      { error: :connection_timeout }
    rescue Errno::ECONNREFUSED, Errno::EHOSTUNREACH, Errno::ECONNRESET
      { error: :destination_unreachable }
    rescue OpenSSL::SSL::SSLError
      { error: :failed_tls }
    end
    def stream_body_with_limit(response)
      bytes_read = 0
      response.read_body do |chunk|
        bytes_read += chunk.bytesize
        raise ResponseTooLarge if bytes_read > MAX_RESPONSE_SIZE
      end
    end
    def resolved_ip
      return @resolved_ip if defined?(@resolved_ip)
      @resolved_ip = SsrfProtection.resolve_public_ip(uri.host)
    end
    def uri
      @uri ||= URI(webhook.url)
    end
    def http
      Net::HTTP.new(uri.host, uri.port).tap do |http|
        http.ipaddr = resolved_ip
        http.use_ssl = (uri.scheme == "https")
        http.open_timeout = ENDPOINT_TIMEOUT
        http.read_timeout = ENDPOINT_TIMEOUT
      end
    end
    def headers
      {
        "User-Agent" => USER_AGENT,
        "Content-Type" => content_type,
        "X-Webhook-Signature" => signature,
        "X-Webhook-Timestamp" => event.created_at.utc.iso8601
      }
    end
    def signature
      OpenSSL::HMAC.hexdigest("SHA256", webhook.signing_secret, payload)
    end
    def content_type
      if webhook.for_campfire?
        "text/html"
      elsif webhook.for_basecamp?
        "application/x-www-form-urlencoded"
      else
        "application/json"
      end
    end
    def payload
      @payload ||= if webhook.for_basecamp?
        { content: render_payload(formats: :html) }.to_query
      elsif webhook.for_campfire?
        render_payload(formats: :html)
      elsif webhook.for_slack?
        slack_payload
      else
        render_payload(formats: :json)
      end
    end
    def render_payload(**options)
      webhook.renderer.render(layout: false, template: "webhooks/event", assigns: { event: event }, **options).strip
    end
    def convert_html_to_mrkdwn(html)
      document = Nokogiri::HTML5(html)
      document.css("a").each do |a|
        a.replace("<#{a["href"].strip}|#{a.text}>") if a["href"].present?
      end
      document.css("b").each do |b|
        b.replace("*#{b.text}*")
      end
      document.css("i").each do |i|
        i.replace("_#{i.text}_")
      end
      document.text
    end
    def slack_payload
      text = event.description_for(nil).to_plain_text
      url = polymorphic_url(event.eventable, base_url_options.merge(script_name: account.slug))
      { text: "#{text} <#{url}|Open in Fizzy>" }.to_json
    end
    def base_url_options
      Rails.application.routes.default_url_options.presence ||
        Rails.application.config.action_mailer.default_url_options
    end
end

================
File: app/models/webhook/triggerable.rb
================
module Webhook::Triggerable
  extend ActiveSupport::Concern
  included do
    scope :triggered_by, ->(event) { where(board: event.board).triggered_by_action(event.action) }
    scope :triggered_by_action, ->(action) { where("subscribed_actions LIKE ?", "%\"#{action}\"%") }
  end
  def trigger(event)
    deliveries.create!(event: event) unless account.cancelled?
  end
end

================
File: app/models/zip_file/reader/io.rb
================
class ZipFile::Reader::IO
  def initialize(entry, io)
    @entry = entry
    @io = io
    @extractor = @entry.extractor_from(@io)
  end
  def read(length = nil, buffer = nil)
    return nil if @extractor.eof?
    data = @extractor.extract(length)
    return nil if data.nil?
    if buffer
      buffer.replace(data)
      buffer
    else
      data
    end
  end
  def eof?
    @extractor.eof?
  end
  def rewind
    @extractor = @entry.extractor_from(@io)
    0
  end
  def size
    @entry.uncompressed_size
  end
end

================
File: app/models/zip_file/reader.rb
================
class ZipFile::Reader
  def initialize(io)
    @io = io
    @reader = ZipKit::FileReader.read_zip_structure(io: io)
  rescue ZipKit::FileReader::InvalidStructure => e
    raise ZipFile::InvalidFileError, e.message
  end
  def read(file_path)
    entry = @reader.find { |e| e.filename == file_path }
    raise ArgumentError, "File not found in zip: #{file_path}" unless entry
    raise ArgumentError, "Cannot read directory entry: #{file_path}" if entry.filename.end_with?("/")
    if block_given?
      yield ZipFile::Reader::IO.new(entry, @io)
    else
      entry.extractor_from(@io).extract
    end
  end
  def glob(pattern)
    @reader.map(&:filename).select { |name| File.fnmatch(pattern, name) }.sort
  end
  def exists?(file_path)
    @reader.any? { |e| e.filename == file_path }
  end
end

================
File: app/models/zip_file/remote_io.rb
================
class ZipFile::RemoteIO < ZipKit::RemoteIO
  protected
    def request_range(range)
      with_http do |http|
        request = Net::HTTP::Get.new(@uri)
        request.range = range
        response = http.request(request)
        case response.code
        when "206", "200"
          response.body
        else
          raise "Remote at #{@uri} replied with code #{response.code}"
        end
      end
    end
    def request_object_size
      with_http do |http|
        request = Net::HTTP::Get.new(@uri)
        request.range = 0..0
        response = http.request(request)
        case response.code
        when "206"
          content_range_header_value = response["Content-Range"]
          content_range_header_value.split("/").last.to_i
        when "200"
          response["Content-Length"].to_i
        else
          raise "Remote at #{@uri} replied with code #{response.code}"
        end
      end
    end
  private
    def with_http
      http = Net::HTTP.new(@uri.hostname, @uri.port)
      http.use_ssl = @uri.scheme == "https"
      # FIXME: Disable SSL verification for now to avoid issues with our self-signed certificates for PureStorage
      http.verify_mode = OpenSSL::SSL::VERIFY_NONE
      http.start { yield http }
    end
end

================
File: app/models/zip_file/writer.rb
================
class ZipFile::Writer
  attr_reader :byte_size
  def initialize(io = nil)
    @entries = []
    @byte_size = 0
    @output_io = io
    @streamer = nil
    @digest = Digest::MD5.new
  end
  def stream_to(io)
    @output_io = io
  end
  def write(data)
    @output_io.write(data)
    @byte_size += data.bytesize
    @digest.update(data)
    data.bytesize
  end
  def add_file(path, content = nil, compress: true)
    @entries << path
    write_method = compress ? :write_deflated_file : :write_stored_file
    if block_given?
      streamer.public_send(write_method, path) { |sink| yield sink }
    else
      streamer.public_send(write_method, path) { |sink| sink.write(content) }
    end
  end
  def glob(pattern)
    @entries.select { |e| File.fnmatch(pattern, e) }.sort
  end
  def exists?(path)
    @entries.include?(path)
  end
  def close
    streamer.close
  end
  def checksum
    Base64.strict_encode64(@digest.digest)
  end
  private
    def streamer
      @streamer ||= ZipKit::Streamer.new(@output_io)
    end
end

================
File: app/models/access.rb
================
class Access < ApplicationRecord
  belongs_to :account, default: -> { user.account }
  belongs_to :board, touch: true
  belongs_to :user, touch: true
  enum :involvement, %i[ access_only watching ].index_by(&:itself), default: :access_only
  scope :ordered_by_recently_accessed, -> { order(accessed_at: :desc) }
  after_destroy_commit :clean_inaccessible_data_later
  def accessed
    touch :accessed_at unless recently_accessed?
  end
  private
    def recently_accessed?
      accessed_at&.> 5.minutes.ago
    end
    def clean_inaccessible_data_later
      Board::CleanInaccessibleDataJob.perform_later(user, board)
    end
end

================
File: app/models/account.rb
================
class Account < ApplicationRecord
  include Account::Storage, Cancellable, Entropic, Incineratable, MultiTenantable, Seedeable
  has_one :join_code, dependent: :destroy
  has_many :users, dependent: :destroy
  has_many :boards, dependent: :destroy
  has_many :cards, dependent: :destroy
  has_many :webhooks, dependent: :destroy
  has_many :tags, dependent: :destroy
  has_many :columns, dependent: :destroy
  has_many :entropies, dependent: :destroy
  has_many :exports, class_name: "Account::Export", dependent: :destroy
  has_many :imports, class_name: "Account::Import", dependent: :destroy
  scope :importing, -> { left_joins(:imports).where(account_imports: { status: %i[pending processing failed] }) }
  scope :active, -> { where.missing(:cancellation).and(where.not(id: importing)) }
  before_create :assign_external_account_id
  after_create :create_join_code
  validates :name, presence: true
  class << self
    def create_with_owner(account:, owner:)
      create!(**account).tap do |account|
        account.users.create!(role: :system, name: "System")
        account.users.create!(**owner.with_defaults(role: :owner, verified_at: Time.current))
      end
    end
  end
  def slug
    "/#{AccountSlug.encode(external_account_id)}"
  end
  def account
    self
  end
  def system_user
    users.find_by!(role: :system)
  end
  def active?
    !cancelled? && !importing?
  end
  def importing?
    imports.where(status: %i[pending processing failed]).exists?
  end
  private
    def assign_external_account_id
      self.external_account_id ||= ExternalIdSequence.next
    end
end

================
File: app/models/admin.rb
================
module Admin
end

================
File: app/models/application_platform.rb
================
class ApplicationPlatform < PlatformAgent
  def ios?
    match? /iPhone|iPad/
  end
  def android?
    match? /Android/
  end
  def mac?
    match? /Macintosh/
  end
  def chrome?
    user_agent.browser.match? /Chrome/
  end
  def edge?
    user_agent.browser.match? /Edg/
  end
  def firefox?
    user_agent.browser.match? /Firefox|FxiOS/
  end
  def safari?
    user_agent.browser.match? /Safari/
  end
  def mobile?
    ios? || android?
  end
  def desktop?
    !mobile?
  end
  def native?
    match? /Hotwire Native/
  end
  def windows?
    operating_system == "Windows"
  end
  def type
    if native? && android?
      "native android"
    elsif native? && ios?
      "native ios"
    elsif mobile?
      "mobile web"
    else
      "desktop web"
    end
  end
  def operating_system
    case user_agent.platform
    when /Android/   then "Android"
    when /iPad/      then "iPad"
    when /iPhone/    then "iPhone"
    when /Macintosh/ then "macOS"
    when /Windows/   then "Windows"
    when /CrOS/      then "ChromeOS"
    else
      os =~ /Linux/ ? "Linux" : os
    end
  end
end

================
File: app/models/application_record.rb
================
class ApplicationRecord < ActiveRecord::Base
  primary_abstract_class
  configure_replica_connections
end

================
File: app/models/assignment.rb
================
class Assignment < ApplicationRecord
  LIMIT = 100
  belongs_to :account, default: -> { card.account }
  belongs_to :card, touch: true
  belongs_to :assignee, class_name: "User"
  belongs_to :assigner, class_name: "User"
  validate :within_limit, on: :create
  private
    def within_limit
      if card.assignments.count >= LIMIT
        errors.add(:base, "Card already has the maximum of #{LIMIT} assignees")
      end
    end
end

================
File: app/models/board.rb
================
class Board < ApplicationRecord
  include Accessible, AutoPostponing, Board::Storage, Broadcastable, Cards, Entropic, Filterable, Publishable, ::Storage::Tracked, Triageable
  belongs_to :creator, class_name: "User", default: -> { Current.user }
  belongs_to :account, default: -> { creator.account }
  has_rich_text :public_description
  has_many :tags, -> { distinct }, through: :cards
  has_many :events
  has_many :webhooks, dependent: :destroy
  scope :alphabetically, -> { order("lower(name)") }
  scope :ordered_by_recently_accessed, -> { merge(Access.ordered_by_recently_accessed) }
end

================
File: app/models/card.rb
================
class Card < ApplicationRecord
  include Accessible, Assignable, Attachments, Broadcastable, Closeable, Colored, Commentable,
    Entropic, Eventable, Exportable, Golden, Mentions, Multistep, Pinnable, Postponable, Promptable,
    Readable, Searchable, Stallable, Statuses, Storage::Tracked, Taggable, Triageable, Watchable
  belongs_to :account, default: -> { board.account }
  belongs_to :board
  belongs_to :creator, class_name: "User", default: -> { Current.user }
  has_many :reactions, -> { order(:created_at) }, as: :reactable, dependent: :delete_all
  has_one_attached :image, dependent: :purge_later
  has_rich_text :description
  before_save :set_default_title, if: :published?
  before_create :assign_number
  after_save   -> { board.touch }, if: :published?
  after_touch  -> { board.touch }, if: :published?
  after_update :handle_board_change, if: :saved_change_to_board_id?
  scope :reverse_chronologically, -> { order created_at:     :desc, id: :desc }
  scope :chronologically,         -> { order created_at:     :asc,  id: :asc  }
  scope :latest,                  -> { order last_active_at: :desc, id: :desc }
  scope :with_users,              -> { preload(creator: [ :avatar_attachment, :account ], assignees: [ :avatar_attachment, :account ]) }
  scope :preloaded,               -> { with_users.preload(:column, :tags, :steps, :closure, :goldness, :activity_spike, :image_attachment, reactions: :reacter, board: [ :entropy, :columns ], not_now: [ :user ]).with_rich_text_description_and_embeds }
  scope :indexed_by, ->(index) do
    case index
    when "stalled" then stalled
    when "postponing_soon" then postponing_soon
    when "closed" then closed
    when "not_now" then postponed.latest
    when "golden" then golden
    when "draft" then drafted
    else all
    end
  end
  scope :sorted_by, ->(sort) do
    case sort
    when "newest" then reverse_chronologically
    when "oldest" then chronologically
    when "latest" then latest
    else latest
    end
  end
  def card
    self
  end
  def to_param
    number.to_s
  end
  def move_to(new_board)
    transaction do
      card.update!(board: new_board)
      card.events.update_all(board_id: new_board.id)
    end
  end
  def filled?
    title.present? || description.present?
  end
  private
    def set_default_title
      self.title = "Untitled" if title.blank?
    end
    def handle_board_change
      old_board = account.boards.find_by(id: board_id_before_last_save)
      transaction do
        update! column: nil
        track_board_change_event(old_board.name)
        grant_access_to_assignees unless board.all_access?
      end
      remove_inaccessible_notifications_later
      clean_inaccessible_data_later
    end
    def track_board_change_event(old_board_name)
      track_event "board_changed", particulars: { old_board: old_board_name, new_board: board.name }
    end
    def assign_number
      self.number ||= account.increment!(:cards_count).cards_count
    end
end

================
File: app/models/closure.rb
================
class Closure < ApplicationRecord
  belongs_to :account, default: -> { card.account }
  belongs_to :card, touch: true
  belongs_to :user, optional: true
end

================
File: app/models/color.rb
================
Color = Struct.new(:name, :value)
class Color
  class << self
    def for_value(value)
      COLORS.find { |it| it.value == value }
    end
  end
  def to_s
    value
  end
  COLORS = {
    "Blue" => "var(--color-card-default)",
    "Gray" => "var(--color-card-1)",
    "Tan" => "var(--color-card-2)",
    "Yellow" => "var(--color-card-3)",
    "Lime" => "var(--color-card-4)",
    "Aqua" => "var(--color-card-5)",
    "Violet" => "var(--color-card-6)",
    "Purple" => "var(--color-card-7)",
    "Pink" => "var(--color-card-8)"
  }.collect { |name, value| new(name, value) }.freeze
end

================
File: app/models/column.rb
================
class Column < ApplicationRecord
  include Colored, Positioned
  belongs_to :account, default: -> { board.account }
  belongs_to :board, touch: true
  has_many :cards, dependent: :nullify
  after_save_commit    -> { cards.touch_all }, if: -> { saved_change_to_name? || saved_change_to_color? }
  after_destroy_commit -> { board.cards.touch_all }
end

================
File: app/models/comment.rb
================
class Comment < ApplicationRecord
  include Attachments, Eventable, Mentions, Promptable, Searchable, Storage::Tracked
  belongs_to :account, default: -> { card.account }
  belongs_to :card, touch: true
  belongs_to :creator, class_name: "User", default: -> { Current.user }
  has_many :reactions, -> { order(:created_at) }, as: :reactable, dependent: :delete_all
  has_rich_text :body
  validate :card_is_commentable
  scope :chronologically, -> { order created_at: :asc, id: :desc }
  scope :preloaded, -> { with_rich_text_body.includes(reactions: :reacter) }
  scope :by_system, -> { joins(:creator).where(creator: { role: :system }) }
  scope :by_user, -> { joins(:creator).where.not(creator: { role: :system }) }
  after_create_commit :watch_card_by_creator
  delegate :publicly_accessible?, :accessible_to?, :board, :watch_by, to: :card
  def to_partial_path
    "cards/#{super}"
  end
  private
    def card_is_commentable
      errors.add(:card, "does not allow comments") unless card.commentable?
    end
    def watch_card_by_creator
      card.watch_by creator
    end
end

================
File: app/models/current.rb
================
class Current < ActiveSupport::CurrentAttributes
  attribute :session, :user, :identity, :account
  attribute :http_method, :request_id, :user_agent, :ip_address, :referrer
  def session=(value)
    super(value)
    if value.present?
      self.identity = session.identity
    end
  end
  def identity=(identity)
    super(identity)
    if identity.present?
      self.user = identity.users.find_by(account: account)
    end
  end
  def with_account(value, &)
    with(account: value, &)
  end
  def without_account(&)
    with(account: nil, &)
  end
end

================
File: app/models/entropy.rb
================
class Entropy < ApplicationRecord
  belongs_to :account, default: -> { container.account }
  belongs_to :container, polymorphic: true
  after_commit -> { container.cards.touch_all if container }
end

================
File: app/models/event.rb
================
class Event < ApplicationRecord
  include Notifiable, Particulars, Promptable
  belongs_to :account, default: -> { board.account }
  belongs_to :board
  belongs_to :creator, class_name: "User"
  belongs_to :eventable, polymorphic: true
  has_many :webhook_deliveries, class_name: "Webhook::Delivery", dependent: :delete_all
  scope :chronologically, -> { order created_at: :asc, id: :desc }
  scope :preloaded, -> {
    includes(:creator, :board, {
      eventable: [
        :goldness, :closure, :image_attachment,
        { rich_text_body: :embeds_attachments },
        { rich_text_description: :embeds_attachments },
        { card: [ :goldness, :closure, :image_attachment ] }
      ]
    })
  }
  after_create -> { eventable.event_was_created(self) }
  after_create_commit :dispatch_webhooks
  delegate :card, to: :eventable
  def action
    super.inquiry
  end
  def notifiable_target
    eventable
  end
  def description_for(user)
    Event::Description.new(self, user)
  end
  private
    def dispatch_webhooks
      Event::WebhookDispatchJob.perform_later(self)
    end
end

================
File: app/models/export.rb
================
class Export < ApplicationRecord
  belongs_to :account
  belongs_to :user
  has_one_attached :file
  enum :status, %w[ pending processing completed failed ].index_by(&:itself), default: :pending
  scope :current, -> { where(created_at: 24.hours.ago..) }
  scope :expired, -> { where(completed_at: ...24.hours.ago) }
  def self.cleanup
    expired.destroy_all
  end
  def build_later
    DataExportJob.perform_later(self)
  end
  def build
    processing!
    with_context do
      ZipFile.create_for(file, filename: filename) do |zip|
        populate_zip(zip)
      end
      mark_completed
      ExportMailer.completed(self).deliver_later
    end
  rescue => e
    update!(status: :failed)
    raise e
  end
  def mark_completed
    update!(status: :completed, completed_at: Time.current)
  end
  def accessible_to?(accessor)
    accessor == user
  end
  private
    def filename
      "fizzy-export-#{id}.zip"
    end
    def with_context
      Current.set(account: account) do
        old_url_options = ActiveStorage::Current.url_options
        ActiveStorage::Current.url_options = Rails.application.routes.default_url_options
        yield
      ensure
        ActiveStorage::Current.url_options = old_url_options
      end
    end
    def populate_zip(zip)
      raise NotImplementedError, "Subclasses must implement populate_zip"
    end
end

================
File: app/models/filter.rb
================
class Filter < ApplicationRecord
  include Fields, Params, Resources, Summarized
  belongs_to :creator, class_name: "User", default: -> { Current.user }
  belongs_to :account, default: -> { creator.account }
  class << self
    def from_params(params)
      find_by_params(params) || build(params)
    end
    def remember(attrs)
      create!(attrs)
    rescue ActiveRecord::RecordNotUnique
      find_by_params(attrs).tap(&:touch)
    end
  end
  def cards
    @cards ||= begin
      result = creator.accessible_cards.preloaded.published
      result = result.indexed_by(indexed_by)
      result = result.sorted_by(sorted_by)
      result = result.where(id: card_ids) if card_ids.present?
      result = result.where.missing(:not_now) unless include_not_now_cards?
      result = result.open unless include_closed_cards?
      result = result.unassigned if assignment_status.unassigned?
      result = result.assigned_to(assignees.ids) if assignees.present?
      result = result.where(creator_id: creators.ids) if creators.present?
      result = result.where(board: boards.ids) if boards.present?
      result = result.tagged_with(tags.ids) if tags.present?
      result = result.where(cards: { created_at: creation_window }) if creation_window
      result = result.closed_at_window(closure_window) if closure_window
      result = result.closed_by(closers) if closers.present?
      result = terms.reduce(result) do |result, term|
        result.mentioning(term, user: creator)
      end
      result.distinct
    end
  end
  def empty?
    self.class.normalize_params(as_params).blank?
  end
  def single_board
    boards.first if boards.one?
  end
  def single_workflow
    boards.first.workflow if boards.pluck(:workflow_id).uniq.one?
  end
  def cacheable?
    boards.exists?
  end
  def cache_key
    ActiveSupport::Cache.expand_cache_key params_digest, "filter"
  end
  def only_closed?
    indexed_by.closed? || closure_window || closers.present?
  end
  private
    def include_closed_cards?
      only_closed? || card_ids.present?
    end
    def include_not_now_cards?
      indexed_by.not_now? || card_ids.present?
    end
end

================
File: app/models/identity.rb
================
class Identity < ApplicationRecord
  include Joinable, Transferable
  has_many :access_tokens, dependent: :destroy
  has_many :magic_links, dependent: :destroy
  has_many :sessions, dependent: :destroy
  has_many :users, dependent: :nullify
  has_many :accounts, through: :users
  has_one_attached :avatar
  before_destroy :deactivate_users, prepend: true
  validates :email_address, format: { with: URI::MailTo::EMAIL_REGEXP }
  normalizes :email_address, with: ->(value) { value.strip.downcase.presence }
  def self.find_by_permissable_access_token(token, method:)
    if (access_token = AccessToken.find_by(token: token)) && access_token.allows?(method)
      access_token.identity
    end
  end
  def send_magic_link(**attributes)
    attributes[:purpose] = attributes.delete(:for) if attributes.key?(:for)
    magic_links.create!(attributes).tap do |magic_link|
      MagicLinkMailer.sign_in_instructions(magic_link).deliver_later
    end
  end
  private
    def deactivate_users
      users.find_each(&:deactivate)
    end
end

================
File: app/models/magic_link.rb
================
class MagicLink < ApplicationRecord
  CODE_LENGTH = 6
  EXPIRATION_TIME = 15.minutes
  belongs_to :identity
  enum :purpose, %w[ sign_in sign_up ], prefix: :for, default: :sign_in
  scope :active, -> { where(expires_at: Time.current...) }
  scope :stale, -> { where(expires_at: ..Time.current) }
  before_validation :generate_code, on: :create
  before_validation :set_expiration, on: :create
  validates :code, uniqueness: true, presence: true
  class << self
    def consume(code)
      active.find_by(code: Code.sanitize(code))&.consume
    end
    def cleanup
      stale.delete_all
    end
  end
  def consume
    destroy
    self
  end
  private
    def generate_code
      self.code ||= loop do
        candidate = Code.generate(CODE_LENGTH)
        break candidate unless self.class.exists?(code: candidate)
      end
    end
    def set_expiration
      self.expires_at ||= EXPIRATION_TIME.from_now
    end
end

================
File: app/models/mention.rb
================
class Mention < ApplicationRecord
  include Notifiable
  belongs_to :account, default: -> { source.account }
  belongs_to :source, polymorphic: true
  belongs_to :mentioner, class_name: "User"
  belongs_to :mentionee, class_name: "User", inverse_of: :mentions
  after_create_commit :watch_source_by_mentionee
  delegate :card, to: :source
  def self_mention?
    mentioner == mentionee
  end
  def notifiable_target
    source
  end
  private
    def watch_source_by_mentionee
      source.watch_by(mentionee)
    end
end

================
File: app/models/notification_pusher.rb
================
class NotificationPusher
  include Rails.application.routes.url_helpers
  include ExcerptHelper
  attr_reader :notification
  def initialize(notification)
    @notification = notification
  end
  def push
    return unless should_push?
    build_payload.tap do |payload|
      push_to_user(payload)
    end
  end
  private
    def should_push?
      notification.user.push_subscriptions.any? &&
        !notification.creator.system? &&
        notification.user.active? &&
        notification.account.active?
    end
    def build_payload
      case notification.source_type
      when "Event"
        build_event_payload
      when "Mention"
        build_mention_payload
      else
        build_default_payload
      end
    end
    def build_event_payload
      event = notification.source
      card = event.card
      base_payload = {
        title: card_notification_title(card),
        path: card_path(card)
      }
      case event.action
      when "comment_created"
        base_payload.merge(
          title: "RE: #{base_payload[:title]}",
          body: comment_notification_body(event),
          path: card_path_with_comment_anchor(event.eventable)
        )
      when "card_assigned"
        base_payload.merge(
          body: "Assigned to you by #{event.creator.name}"
        )
      when "card_published"
        base_payload.merge(
          body: "Added by #{event.creator.name}"
        )
      when "card_closed"
        base_payload.merge(
          body: card.closure ? "Moved to Done by #{event.creator.name}" : "Closed by #{event.creator.name}"
        )
      when "card_reopened"
        base_payload.merge(
          body: "Reopened by #{event.creator.name}"
        )
      else
        base_payload.merge(
          body: event.creator.name
        )
      end
    end
    def build_mention_payload
      mention = notification.source
      card = mention.card
      {
        title: "#{mention.mentioner.first_name} mentioned you",
        body: format_excerpt(mention.source.mentionable_content, length: 200),
        path: card_path(card)
      }
    end
    def build_default_payload
      {
        title: "New notification",
        body: "You have a new notification",
        path: notifications_path(script_name: notification.account.slug)
      }
    end
    def push_to_user(payload)
      subscriptions = notification.user.push_subscriptions
      enqueue_payload_for_delivery(payload, subscriptions)
    end
    def enqueue_payload_for_delivery(payload, subscriptions)
      Rails.configuration.x.web_push_pool.queue(payload, subscriptions)
    end
    def card_notification_title(card)
      card.title.presence || "Card #{card.number}"
    end
    def comment_notification_body(event)
      format_excerpt(event.eventable.body, length: 200)
    end
    def card_path(card)
      Rails.application.routes.url_helpers.card_path(card, script_name: notification.account.slug)
    end
    def card_path_with_comment_anchor(comment)
      Rails.application.routes.url_helpers.card_path(
        comment.card,
        anchor: ActionView::RecordIdentifier.dom_id(comment),
        script_name: notification.account.slug
      )
    end
end

================
File: app/models/notification.rb
================
class Notification < ApplicationRecord
  include PushNotifiable
  belongs_to :account, default: -> { user.account }
  belongs_to :user
  belongs_to :creator, class_name: "User"
  belongs_to :source, polymorphic: true
  scope :unread, -> { where(read_at: nil) }
  scope :read, -> { where.not(read_at: nil) }
  scope :ordered, -> { order(read_at: :desc, created_at: :desc) }
  after_create_commit :broadcast_unread
  after_destroy_commit :broadcast_read
  after_create :bundle
  scope :preloaded, -> { preload(:creator, :account, source: [ :board, :creator, { eventable: [ :closure, :board, :assignments ] } ]) }
  delegate :notifiable_target, to: :source
  delegate :card, to: :source
  def self.read_all
    all.each { |notification| notification.read }
  end
  def read
    update!(read_at: Time.current)
    broadcast_read
  end
  def unread
    update!(read_at: nil)
    broadcast_unread
  end
  def read?
    read_at.present?
  end
  private
    def broadcast_unread
      broadcast_prepend_later_to user, :notifications, target: "notifications"
    end
    def broadcast_read
      broadcast_remove_to user, :notifications
    end
    def bundle
      user.bundle(self) if user.settings.bundling_emails?
    end
end

================
File: app/models/notifier.rb
================
class Notifier
  attr_reader :source
  class << self
    def for(source)
      case source
      when Event
        "Notifier::#{source.eventable.class}EventNotifier".safe_constantize&.new(source)
      when Mention
        MentionNotifier.new(source)
      end
    end
  end
  def notify
    if should_notify?
      # Processing recipients in order avoids deadlocks if notifications overlap.
      recipients.sort_by(&:id).map do |recipient|
        Notification.create! user: recipient, source: source, creator: creator
      end
    end
  end
  private
    def initialize(source)
      @source = source
    end
    def should_notify?
      !creator.system?
    end
end

================
File: app/models/pin.rb
================
class Pin < ApplicationRecord
  belongs_to :account, default: -> { user.account }
  belongs_to :card
  belongs_to :user
  scope :ordered, -> { order(created_at: :desc) }
end

================
File: app/models/push.rb
================
module Push
  def self.table_name_prefix
    "push_"
  end
end

================
File: app/models/qr_code_link.rb
================
class QrCodeLink
  attr_reader :url
  class << self
    def from_signed(signed)
      new verifier.verify(signed, purpose: :qr_code)
    end
    def verifier
      ActiveSupport::MessageVerifier.new(secret, url_safe: true)
    end
    private
      def secret
        Rails.application.key_generator.generate_key("qr_codes")
      end
  end
  def initialize(url)
    @url = url
  end
  def signed
    self.class.verifier.generate(@url, purpose: :qr_code)
  end
end

================
File: app/models/reaction.rb
================
class Reaction < ApplicationRecord
  belongs_to :account, default: -> { reactable.account }
  belongs_to :reactable, polymorphic: true, touch: true
  belongs_to :reacter, class_name: "User", default: -> { Current.user }
  scope :ordered, -> { order(:created_at) }
  after_create :register_card_activity
  delegate :all_emoji?, to: :content
  private
    def register_card_activity
      reactable.card.touch_last_active_at
    end
end

================
File: app/models/search.rb
================
module Search
  def self.table_name_prefix
    "search_"
  end
end

================
File: app/models/session.rb
================
class Session < ApplicationRecord
  belongs_to :identity
end

================
File: app/models/signup.rb
================
class Signup
  include ActiveModel::Model
  include ActiveModel::Attributes
  include ActiveModel::Validations
  attr_accessor :full_name, :email_address, :identity, :skip_account_seeding
  attr_reader :account, :user
  validates :email_address, format: { with: URI::MailTo::EMAIL_REGEXP }, on: :identity_creation
  validates :full_name, :identity, presence: true, on: :completion
  validates :full_name, length: { maximum: 240 }
  def initialize(...)
    super
    @email_address = @identity.email_address if @identity
  end
  def create_identity
    @identity = Identity.find_or_create_by!(email_address: email_address)
    @identity.send_magic_link for: :sign_up
  end
  def complete
    if valid?(:completion)
      begin
        @tenant = create_tenant
        create_account
        true
      rescue => error
        destroy_account
        handle_account_creation_error(error)
        errors.add(:base, "Something went wrong, and we couldn't create your account. Please give it another try.")
        Rails.error.report(error, severity: :error)
        Rails.logger.error error
        Rails.logger.error error.backtrace.join("\n")
        false
      end
    else
      false
    end
  end
  private
    # Override to customize the handling of external accounts associated to the account.
    def create_tenant
      nil
    end
    # Override to inject custom handling for account creation errors
    def handle_account_creation_error(error)
    end
    def create_account
      @account = Account.create_with_owner(
        account: {
          external_account_id: @tenant,
          name: generate_account_name
        },
        owner: {
          name: full_name,
          identity: identity
        }
      )
      @user = @account.users.find_by!(role: :owner)
      @account.setup_customer_template unless skip_account_seeding
    end
    def generate_account_name
      AccountNameGenerator.new(identity: identity, name: full_name).generate
    end
    def destroy_account
      @account&.destroy!
      @user = nil
      @account = nil
      @tenant = nil
    end
    def subscription_attributes
      subscription = FreeV1Subscription
      {}.tap do |attributes|
        attributes[:name]  = subscription.to_param
        attributes[:price] = subscription.price
      end
    end
    def request_attributes
      {}.tap do |attributes|
        attributes[:remote_address] = Current.ip_address
        attributes[:user_agent]     = Current.user_agent
        attributes[:referrer]       = Current.referrer
      end
    end
end

================
File: app/models/ssrf_protection.rb
================
module SsrfProtection
  extend self
  DNS_RESOLUTION_TIMEOUT = 2
  DNS_NAMESERVERS = %w[
    1.1.1.1
    8.8.8.8
  ]
  DISALLOWED_IP_RANGES = [
    IPAddr.new("0.0.0.0/8"),     # "This" network (RFC1700)
    IPAddr.new("100.64.0.0/10"), # Carrier-grade NAT (RFC6598)
    IPAddr.new("198.18.0.0/15")  # Benchmark testing (RFC2544)
  ].freeze
  def resolve_public_ip(hostname)
    ip_addresses = resolve_dns(hostname)
    public_ips = ip_addresses.reject { |ip| blocked_address?(ip) }
    public_ips.sort_by { |ipaddr| ipaddr.ipv4? ? 0 : 1 }.first&.to_s
  end
  def blocked_address?(ip)
    ip = IPAddr.new(ip.to_s) unless ip.is_a?(IPAddr)
    ip.private? ||
      ip.loopback? ||
      ip.link_local? ||
      ip.ipv4_mapped? ||
      ip.ipv4_compat? ||
      in_disallowed_range?(ip)
  end
  private
    def resolve_dns(hostname)
      ip_addresses = []
      Resolv::DNS.open(nameserver: DNS_NAMESERVERS, timeouts: DNS_RESOLUTION_TIMEOUT) do |dns|
        dns.each_address(hostname) do |ip_address|
          ip_addresses << IPAddr.new(ip_address.to_s)
        end
      end
      ip_addresses
    end
    def in_disallowed_range?(ip)
      DISALLOWED_IP_RANGES.any? { |range| range.include?(ip) }
    end
end

================
File: app/models/step.rb
================
class Step < ApplicationRecord
  belongs_to :account, default: -> { card.account }
  belongs_to :card, touch: true
  scope :completed, -> { where(completed: true) }
  validates :content, presence: true
  def completed?
    completed
  end
end

================
File: app/models/storage.rb
================
module Storage
  def self.table_name_prefix
    "storage_"
  end
  # Record types that participate in storage tracking (ledger entries created on attach).
  # The no-reuse validation uses this to scope its check.
  #
  # IMPORTANT: Update this constant when adding tracked attachments to new models.
  # If you add a direct attachment (not via RichText embeds) to Comment, Board, or
  # another model with Storage::Tracked, you must add its record_type here or the
  # no-reuse validation won't protect it.
  TRACKED_RECORD_TYPES = %w[Card ActionText::RichText].freeze
  # Account ID for template/demo blobs that can be reused cross-tenant.
  # Set to nil to disable the whitelist (no exemptions).
  TEMPLATE_ACCOUNT_ID = nil
end

================
File: app/models/tag.rb
================
class Tag < ApplicationRecord
  include Attachable, Filterable
  belongs_to :account, default: -> { Current.account }
  has_many :taggings, dependent: :destroy
  has_many :cards, through: :taggings
  validates :title, format: { without: /\A#/ }
  normalizes :title, with: -> { it.downcase }
  scope :alphabetically, -> { order("lower(title)") }
  scope :unused, -> { left_outer_joins(:taggings).where(taggings: { id: nil }) }
  def hashtag
    "#" + title
  end
  def cards_count
    cards.open.count
  end
end

================
File: app/models/tagging.rb
================
class Tagging < ApplicationRecord
  belongs_to :account, default: -> { card.account }
  belongs_to :tag
  belongs_to :card, touch: true
end

================
File: app/models/time_window_parser.rb
================
class TimeWindowParser
  attr_reader :now
  HUMAN_NAMES_BY_VALUE = {
    "today" => "Today",
    "yesterday" => "Yesterday",
    "thisweek" => "This week",
    "thismonth" => "This month",
    "thisyear" => "This year",
    "lastweek" => "Last week",
    "lastmonth" => "Last month",
    "lastyear" => "Last year"
  }
  VALUES = HUMAN_NAMES_BY_VALUE.keys
  class << self
    def parse(string)
      new.parse(string)
    end
    def human_name_for(value)
      HUMAN_NAMES_BY_VALUE[value]
    end
  end
  def initialize(now: Time.current)
    @now = now
  end
  def parse(string)
    case normalize(string)
    when "today"
      now.all_day
    when "yesterday"
      (now - 1.day).all_day
    when "thisweek"
      now.all_week
    when "thismonth"
      now.all_month
    when "thisyear"
      now.all_year
    when "lastweek"
      (now - 1.week).all_week
    when "lastmonth"
      (now - 1.month).all_month
    when "lastyear"
      (now - 1.year).all_year
    end
  end
  private
    def normalize(string)
      if string
        string.downcase.gsub(/[\s_\-]/, "")
      end
    end
end

================
File: app/models/user.rb
================
class User < ApplicationRecord
  include Accessor, Assignee, Attachable, Avatar, Configurable, EmailAddressChangeable,
    Mentionable, Named, Notifiable, Role, Searcher, Watcher
  include Timelined # Depends on Accessor
  belongs_to :account
  belongs_to :identity, optional: true
  validates :name, presence: true
  has_many :comments, inverse_of: :creator, dependent: :destroy
  has_many :filters, foreign_key: :creator_id, inverse_of: :creator, dependent: :destroy
  has_many :closures, dependent: :nullify
  has_many :pins, dependent: :destroy
  has_many :pinned_cards, through: :pins, source: :card
  has_many :data_exports, class_name: "User::DataExport", dependent: :destroy
  def deactivate
    transaction do
      accesses.destroy_all
      update! active: false, identity: nil
      close_remote_connections
    end
  end
  def setup?
    name != identity.email_address
  end
  def verified?
    verified_at.present?
  end
  def verify
    update!(verified_at: Time.current) unless verified?
  end
  private
    def close_remote_connections
      ActionCable.server.remote_connections.where(current_user: self).disconnect(reconnect: false)
    end
end

================
File: app/models/watch.rb
================
class Watch < ApplicationRecord
  belongs_to :account, default: -> { user.account }
  belongs_to :user
  belongs_to :card, touch: true
  scope :watching, -> { where(watching: true) }
  scope :not_watching, -> { where(watching: false) }
end

================
File: app/models/webhook.rb
================
class Webhook < ApplicationRecord
  include Triggerable
  SLACK_WEBHOOK_URL_REGEX = %r{//hooks\.slack\.com/services/T[^\/]+/B[^\/]+/[^\/]+\Z}i
  CAMPFIRE_WEBHOOK_URL_REGEX = %r{/rooms/\d+/\d+-[^\/]+/messages\Z}i
  BASECAMP_CAMPFIRE_WEBHOOK_URL_REGEX = %r{/\d+/integrations/[^\/]+/buckets/\d+/chats/\d+/lines\Z}i
  PERMITTED_SCHEMES = %w[ http https ].freeze
  PERMITTED_ACTIONS = %w[
    card_assigned
    card_closed
    card_postponed
    card_auto_postponed
    card_board_changed
    card_published
    card_reopened
    card_sent_back_to_triage
    card_triaged
    card_unassigned
    comment_created
  ].freeze
  has_secure_token :signing_secret
  has_many :deliveries, dependent: :delete_all
  has_one :delinquency_tracker, dependent: :delete
  belongs_to :account, default: -> { board.account }
  belongs_to :board
  serialize :subscribed_actions, type: Array, coder: JSON
  scope :ordered, -> { order(name: :asc, id: :desc) }
  scope :active, -> { where(active: true) }
  after_create :create_delinquency_tracker!
  normalizes :subscribed_actions, with: ->(value) { Array.wrap(value).map(&:to_s).uniq & PERMITTED_ACTIONS }
  validates :name, presence: true
  validate :validate_url
  def activate
    update! active: true unless active?
  end
  def deactivate
    update! active: false
  end
  def renderer
    @renderer ||= ApplicationController.renderer.new(script_name: account.slug, https: !Rails.env.local?)
  end
  def for_basecamp?
    url.match? BASECAMP_CAMPFIRE_WEBHOOK_URL_REGEX
  end
  def for_campfire?
    url.match? CAMPFIRE_WEBHOOK_URL_REGEX
  end
  def for_slack?
    url.match? SLACK_WEBHOOK_URL_REGEX
  end
  private
    def validate_url
      uri = URI.parse(url.presence)
      if PERMITTED_SCHEMES.exclude?(uri.scheme)
        errors.add :url, "must use #{PERMITTED_SCHEMES.to_choice_sentence}"
      end
    rescue URI::InvalidURIError
      errors.add :url, "not a URL"
    end
end

================
File: app/models/zip_file.rb
================
class ZipFile
  class InvalidFileError < StandardError; end
  class << self
    def create_for(attachment, filename:)
      raise ArgumentError, "No block given" unless block_given?
      reflection = attachment.record.class.reflect_on_attachment(attachment.name)
      service_name = reflection.options[:service_name] || ActiveStorage::Blob.service.name
      service = ActiveStorage::Blob.services.fetch(service_name)
      if s3_service?(service)
        create_for_s3(attachment, filename: filename, service: service) { |zip| yield zip }
      else
        create_for_disk(attachment, filename: filename) { |zip| yield zip }
      end
    end
    def read_from(blob)
      raise ArgumentError, "No block given" unless block_given?
      if s3_service?(blob.service)
        read_from_s3(blob) { |zip| yield zip }
      else
        read_from_disk(blob) { |zip| yield zip }
      end
    end
    private
      def s3_service?(service)
        # The S3 service doesn't get loaded in development unless it's used
        defined?(ActiveStorage::Service::S3Service) && service.is_a?(ActiveStorage::Service::S3Service)
      end
      def create_for_s3(attachment, filename:, service:)
        blob = ActiveStorage::Blob.create_before_direct_upload!(
          filename: filename,
          content_type: "application/zip",
          byte_size: 0,
          checksum: "pending"
        )
        writer = Writer.new
        # Use S3's upload_stream directly for write-based streaming.
        # ActiveStorage's upload method expects a read-based IO, but ZipKit
        # needs a write-based stream. The TransferManager's upload_stream
        # yields a writable IO that we can stream directly to.
        service.send(:upload_stream,
          key: blob.key,
          content_type: "application/zip",
          part_size: 100.megabytes
        ) do |write_stream|
          write_stream.binmode
          writer.stream_to(write_stream)
          yield writer
          writer.close
        end
        blob.update!(byte_size: writer.byte_size, checksum: writer.checksum)
        attachment.attach(blob)
      rescue Aws::S3::MultipartUploadError => e
        if e.errors.any?
          raise e.errors.first
        else
          raise e
        end
      end
      def create_for_disk(attachment, filename:)
        tempfile = Tempfile.new([ "export", ".zip" ])
        tempfile.binmode
        writer = Writer.new(tempfile)
        yield writer
        writer.close
        tempfile.rewind
        attachment.attach(io: tempfile, filename: filename, content_type: "application/zip")
      ensure
        tempfile&.close
        tempfile&.unlink
      end
      def read_from_s3(blob)
        url = blob.url(expires_in: 6.hour)
        remote_io = RemoteIO.new(url)
        reader = Reader.new(remote_io)
        yield reader
      end
      def read_from_disk(blob)
        blob.open do |file|
          reader = Reader.new(file)
          yield reader
        end
      end
  end
end

================
File: app/views/account/exports/show.html.erb
================
<% if @export.present? %>
  <% @page_title = "Download Export" %>
<% else %>
  <% @page_title = "Download Expired" %>
<% end %>

<% content_for :header do %>
  <div class="header__actions header__actions--start">
    <%= back_link_to "Account Settings", account_settings_path, "keydown.left@document->hotkey#click keydown.esc@document->hotkey#click" %>
  </div>
<% end %>

<div class="panel panel--wide shadow center flex flex-column align-center gap">
  <h2 class="txt-large font-weight-black margin-none"><%= @page_title %></h2>

  <% if @export.present? %>
    <div>Your export is ready. The download should start automatically.</div>

    <%= link_to "Download your data", rails_blob_path(@export.file, disposition: "attachment"),
          id: "download-link",
          class: "btn btn--link",
          data: { turbo: false, controller: "auto-click" } %>
  <% else %>
    <div>That download link has expired. Youll need to <%= link_to "request a new export", account_settings_path, class: "txt-link" %>.</div>
  <% end %>

</div>

================
File: app/views/account/imports/new.html.erb
================
<% @page_title = "Import an account" %>

<div class="panel panel--centered flex flex-column gap">
  <header>
    <h1 class="txt-x-large font-weight-black txt-tight-lines margin-block-end-half">Import a Fizzy account</h1>
    <div>Create an account using data from a Fizzy export. Upload the exported .zip file below.</div>
  </header>

  <%= form_with url: account_imports_path, class: "flex flex-column gap", data: { controller: "form upload-preview" }, multipart: true do |form| %>
    <label class="btn input--upload">
      <div data-upload-preview-target="placeholder">Choose a file</div>
      <div data-upload-preview-target="fileName" hidden></div>
      <%= form.file_field :file, accept: ".zip", required: true, data: { action: "upload-preview#previewFileName", upload_preview_target: "input" } %>
    </label>

    <button type="submit" class="btn btn--link center" data-form-target="submit">
      <span>Start Import </span>
    </button>
  <% end %>
</div>

<% content_for :footer do %>
  <%= render "sessions/footer" %>
<% end %>

================
File: app/views/account/imports/show.html.erb
================
<% @page_title = "Import status" %>

<%= turbo_stream_from @import %>

<div class="panel panel--centered flex flex-column gap-half">
  <h1 class="txt-x-large font-weight-black margin-block-end">Import status</h1>

  <% case @import.status %>
  <% when "pending", "processing" %>
    <p class="txt-medium">Your import is in progress. This may take a while for large accounts.</p>
  <% when "completed" %>
    <p class="txt-medium txt-positive">Your import has completed successfully!</p>
    <%= link_to "Go to your account", landing_url(script_name: @import.account.slug), class: "btn btn--link center txt-medium" %>
  <% when "failed" %>
    <p class="txt-medium txt-negative">Your import failed.</p>
    <p class="txt-small">This may be due to corrupted export data or a conflict with existing data. Please try again with a fresh export.</p>
    <%= link_to "Try again", new_account_import_path, class: "btn btn--plain center txt-medium" %>
  <% end %>
</div>

<% content_for :footer do %>
  <%= render "sessions/footer" %>
<% end %>

================
File: app/views/account/join_codes/edit.html.erb
================
<% @page_title = "Change usage limit" %>

<% content_for :header do %>
  <div class="header__actions header__actions--start">
    <%= back_link_to "Invite link", account_join_code_path, "keydown.left@document->hotkey#click keydown.esc@document->hotkey#click" %>
  </div>
<% end %>

<article class="panel panel--wide center shadow flex flex-column gap-half" style="view-transition-name: <%= dom_id(@join_code) %>">
  <header class="margin-block-end-half">
    <h2 class="txt-large margin-none font-weight-black"><%= @page_title %></h2>
    <p class="txt-medium margin-none">How many times can this link be used to join the account?</p>
  </header>

  <%= form_with model: @join_code, url: account_join_code_path, method: :patch, data: { controller: "form" }, html: { class: "flex flex-column gap" } do |form| %>
    <%= form.number_field :usage_limit,
          required: true, autofocus: true,
          in: 0..Account::JoinCode::USAGE_LIMIT_MAX,
          class: "input center txt-large fit-content font-weight-black txt-align-center", style: "max-inline-size: 8ch",
          data: { action: "keydown.esc@document->form#cancel focus->form#select" } %>

    <% if @join_code.errors.any? %>
      <div class="txt-negative txt-small">
        <% @join_code.errors.full_messages.each do |message| %>
          <p class="margin-block-none"><%= message %></p>
        <% end %>
      </div>
    <% end %>

    <p class="margin-none txt-subtle">
      This code has been used <%= @join_code.usage_count %>/<%= @join_code.usage_limit_in_database %> times.
    </p>

    <%= form.button type: :submit, class: "btn btn--link center txt-medium", data: { form_target: "submit" } do %>
      <span>Save changes</span>
    <% end %>

    <%= link_to "Go back", account_join_code_path, data: { form_target: "cancel" }, hidden: true %>
  <% end %>
</article>

================
File: app/views/account/join_codes/show.html.erb
================
<% @page_title = "Add people" %>

<% content_for :header do %>
  <div class="header__actions header__actions--start">
    <%= back_link_to "Account Settings", account_settings_path, "keydown.left@document->hotkey#click keydown.esc@document->hotkey#click" %>
  </div>
<% end %>

<div class="panel panel--wide shadow center flex flex-column gap" style="view-transition-name: <%= dom_id(@join_code) %>">
  <header>
    <h2 class="txt-large margin-none font-weight-black"><%= @page_title %></h2>
    <p class="txt-medium margin-none">Share the link below to invite people to this account</p>
  </header>

  <% url = join_url(code: @join_code.code, script_name: Current.account.slug) %>
  <div class="flex align-center gap-half">
    <input type="text" class="input flex-item-grow" value="<%= url %>" readonly>

    <% if Current.user.admin? %>
      <%= button_to account_join_code_path, method: :delete, class: "btn btn--circle txt-small", data: {
            turbo_confirm: "Are you sure you want to generate a new link? The previous code will stop working." } do %>
        <%= icon_tag "refresh" %>
        <span class="for-screen-reader">Generate a new code</span>
      <% end %>
    <% end %>
  </div>

  <div class="center flex flex-wrap justify-center align-center gap">
    <%= tag.button class: "btn btn--link", data: {
          controller: "copy-to-clipboard", action: "copy-to-clipboard#copy",
          copy_to_clipboard_success_class: "btn--success", copy_to_clipboard_content_value: url } do %>
      <%= icon_tag "copy-paste" %>
      <span class="txt-nowrap">Copy invite link</span>
    <% end %>

    <div data-controller="dialog" data-dialog-modal-value="true" class="flex-inline">
      <%= tag.button class: "btn", data: { action: "dialog#open" } do %>
        <%= icon_tag "qr-code" %>
        <span>Get QR code</span>
      <% end %>

      <dialog class="dialog panel shadow" data-dialog-target="dialog">
        <p class="margin-none-block-start"><strong>Scan this code with the camera on your mobile device</strong></p>

        <%= qr_code_image(url) %>

        <form method="dialog" class="margin-block-start flex justify-center">
          <button class="btn">
            <span>Done</span>
          </button>
        </form>
      </dialog>
    </div>
  </div>

  <footer class="txt-small">
    <hr class="separator--horizontal full-width margin-block" style="--border-color: var(--color-ink-lighter)">

    <p class="margin-none <%= "txt-negative" if !@join_code.active? %>">
      This code has been used <%= @join_code.usage_count %>/<%= @join_code.usage_limit %> times
      (<%= @join_code.active? ? @join_code.usage_limit - @join_code.usage_count : "none" %> remaining)

      <% if Current.user.admin? %>
        <%= link_to edit_account_join_code_path, class: @join_code.active? ? "txt-link" : "txt-negative txt-underline" do %>
          <span>Change limit</span>
        <% end %>
      <% end %>
    </p>
  </footer>
</div>

================
File: app/views/account/settings/_cancellation.html.erb
================
<% if Current.account.cancellable? && Current.user.owner? %>
  <header class="margin-block-start-double">
    <h2 class="divider txt-large txt-negative">Cancel account</h2>
    <p class="margin-none-block">Delete your Fizzy account</p>
  </header>

  <div data-controller="dialog" data-dialog-modal-value="true">
    <button type="button" class="btn btn--negative" data-action="dialog#open">Delete account</button>

    <dialog class="dialog panel panel--wide shadow" data-dialog-target="dialog">
      <h2 class="margin-none txt-large txt-negative">Delete your account?</h2>
      <ul class="txt-align-start">
        <li>All users, including you, will lose access</li>
        <% if Current.account.try(:active_subscription) %>
          <li>Your subscription will be canceled</li>
        <% end %>
        <li>After 30 days your data will be permanently deleted</li>
      </ul>

      <div class="flex gap justify-center">
        <button type="button" class="btn" data-action="dialog#close">Cancel</button>
        <%= button_to "Delete my account", account_cancellation_path, method: :post, class: "btn btn--negative", form: { data: { action: "submit->dialog#close", turbo: false } } %>
      </div>
    </dialog>
  </div>
<% end %>

================
File: app/views/account/settings/_entropy.html.erb
================
<section class="settings__section">
  <header>
    <h2 class="divider">Auto close</h2>
    <div>Fizzy doesnt let stale cards stick around forever. Cards automatically move to Not Now if there is no activity for a specific period of time. <em>This is the default, global setting  you can override it on each board.</em></div>
  </header>

  <%= render "entropy/auto_close", model: account.entropy, url: account_entropy_path, disabled: !Current.user.admin? %>
</section>

================
File: app/views/account/settings/_export.html.erb
================
<section class="settings__section">
  <header>
    <h2 class="divider">Export account data</h2>
    <div>Download a complete archive of all account data.</div>
  </header>

  <div data-controller="dialog" data-dialog-modal-value="true" data-action="keydown.esc->dialog#close">
    <button type="button" class="btn" data-action="dialog#open">Begin export...</button>

    <dialog class="dialog panel panel--wide shadow" data-dialog-target="dialog" style="--panel-size: 48ch;">
      <h2 class="txt-large">Export all account data</h2>
      <p>This will generate a ZIP archive of all data in this account including all boards, cards, users, and settings.</p>
      <p>Well email you a link to download the file when its ready. The link will expire after 24 hours.</p>

      <div class="flex gap justify-center">
        <%= button_to "Start export", account_exports_path, method: :post, class: "btn btn--link", form: { data: { action: "submit->dialog#close" } } %>
        <button type="button" class="btn" data-action="dialog#close">Cancel</button>
      </div>
    </dialog>
  </div>
</section>

================
File: app/views/account/settings/_name.html.erb
================
<section class="settings__section">
  <%= form_with model: account, url: account_settings_path, method: :put, scope: :account, data: { controller: "form" }, class: "flex gap-half" do |form| %>
    <strong class="full-width"><%= form.text_field :name, required: true, class: "input input--transparent full-width txt-medium", placeholder: "Account name", data: { action: "input->form#disableSubmitWhenInvalid" }, readonly: !Current.user.admin? %></strong>

    <% if Current.user.admin? %>
      <%= form.button class: "btn btn--circle btn--link txt-medium", data: { form_target: "submit" }, disabled: form.object do %>
        <%= icon_tag "arrow-right" %>
        <span class="for-screen-reader">Save changes</span>
      <% end %>
    <% end %>
  <% end %>
</section>

================
File: app/views/account/settings/_user.html.erb
================
<li class="flex align-center gap-half" data-filter-target="item" data-navigable-list-target="item" role="option">
  <%= link_to user, class: "txt-ink flex gap-half align-center min-width" do %>
    <%= avatar_preview_tag user, hidden_for_screen_reader: true %>
    <div class="txt-align-start overflow-ellipsis">
      <strong><%= user.name %></strong>
      <div class="txt-x-small"><%= user.identity.email_address %></div>
    </div>
  <% end %>

  <hr class="separator--horizontal flex-item-grow" style="--border-color: var(--color-ink-medium); --border-style: dashed" aria-hidden="true">

  <%= form_with model: user, url: user_role_path(user), data: { controller: "form" }, method: :patch do | form | %>
    <span title="<%= role_display_name(user) %>">
      <label class="btn btn--circle" for="<%= dom_id(user, :role) %>" aria-label="Role: <%= role_display_name(user) %>">
        <%= icon_tag "crown" %>
        <span class="for-screen-reader">Role: <%= role_display_name(user) %></span>
        <%= form.check_box :role, { data: { action: "form#submit" }, disabled: !Current.user.can_administer?(user), checked: user.admin?, hidden: true, id: dom_id(user, :role) }, "admin", "member" %>
      </label>
    </span>
  <% end %>

  <%# FIXME: Move this Current.user check to a stimulus controller that just checks for admin? or the like we so we can cache user list %>
  <%= button_to user, method: :delete, class: "btn btn--circle btn--negative",
        disabled: !Current.user.can_administer?(user),
        data: { turbo_confirm: "Are you sure you want to permanently remove this person from the account?" } do %>
    <%= icon_tag "minus" %>
    <span class="for-screen-reader">Remove <%= user.name %> from the account</span>
  <% end %>
</li>

================
File: app/views/account/settings/_users.html.erb
================
<section class="settings__section">
  <header>
    <h2 class="divider">People on this account</h2>
  </header>

  <%= tag.div class: "flex flex-column gap settings__user-filter", data: {
    controller: "filter navigable-list",
    action: "keydown->navigable-list#navigate filter:changed->navigable-list#reset",
    navigable_list_focus_on_selection_value: true,
    navigable_list_actionable_items_value: true
  } do %>

    <div class="settings__user-filter">
      <input placeholder="Filter" class="input input--transparent full-width txt-small" type="search" autocorrect="off" autocomplete="off" data-1p-ignore="true" data-filter-target="input" data-action="input->filter#filter">

      <ul class="settings__user-list margin-block-half" data-filter-target="list" role="listbox">
        <%= render partial: "account/settings/user", collection: users %>
      </ul>
    </div>

    <%= link_to account_join_code_path, class: "btn btn--link center" do %>
      <%= icon_tag "add" %>
      <span>Invite people</span>
    <% end %>
  <% end %>
</section>

================
File: app/views/account/settings/show.html.erb
================
<% @page_title = "Account Settings" %>

<% content_for :header do %>
  <h1 class="header__title" data-bridge--title-target="header">
    <%= @page_title %>
    <% unless Current.user.admin? %>
      <div class="txt-normal font-weight-normal">Only admins can change these settings</div>
    <% end %>
  </h1>
<% end %>

<div class="settings margin-block-start-half">
  <div class="settings__panel settings__panel--users panel shadow center">
    <%= render "account/settings/name", account: @account %>
    <%= render "account/settings/users", users: @users %>
  </div>

  <div class="settings__panel settings__panel--entropy panel shadow center">
    <%= render "account/settings/entropy", account: @account %>
    <%= render "account/settings/export" if Current.user.admin? || Current.user.owner? %>
    <%= render "account/settings/cancellation" %>
  </div>
</div>

<%= render "account/settings/subscription_panel" if Fizzy.saas? %>

================
File: app/views/action_text/attachables/_remote_image.html.erb
================
<figure class="attachment attachment--preview">
  <%= image_tag remote_image.url, skip_pipeline: true, width: remote_image.width, height: remote_image.height %>
  <% if caption = remote_image.try(:caption) %>
    <figcaption class="attachment__caption">
      <%= caption %>
    </figcaption>
  <% end %>
</figure>

================
File: app/views/action_text/attachables/_remote_video.html.erb
================
<figure class="attachment attachment--preview attachment--video">
  <%= tag.video controls: true, width: remote_video.width, height: remote_video.height do %>
    <%= tag.source src: remote_video.url, type: remote_video.content_type %>
  <% end %>
  <% if caption = remote_video.try(:caption) %>
    <figcaption class="attachment__caption">
      <%= caption %>
    </figcaption>
  <% end %>
</figure>

================
File: app/views/active_storage/blobs/web/_representation.html.erb
================
<% variant = Attachments::VARIANTS[local_assigns[:in_gallery] ? :small : :large] %>
<% width = blob.metadata["width"] %>
<% height = blob.metadata["height"] %>

<% if blob.video? %>
  <%= tag.video \
        src: rails_blob_path(blob),
        controls: true,
        preload: :none,
        style: "aspect-ratio: #{width} / #{height};",
        width: width,
        height: height %>
<% elsif blob.audio? %>
  <audio controls="true" width="100%" preload="metadata">
    <source src="<%= rails_blob_path(blob) %>" type="<%= blob.content_type %>">
  </audio>
<% elsif blob.variable? %>
  <%= link_to rails_representation_path(blob.variant(variant)), data: { lightbox_target: "image", lightbox_caption_value: blob.filename.to_s } do %>
    <%= image_tag rails_representation_path(blob.variant(variant)), width: width, height: height %>
  <% end %>
<% elsif blob.previewable? %>
  <%= image_tag rails_representation_path(blob.preview(variant)), width: width, height: height %>
<% else %>
  <span class="attachment__icon"><%= blob.filename.extension&.downcase.presence || "unknown" %></span>
<% end %>

================
File: app/views/active_storage/blobs/_blob.html.erb
================
<% if blob.representable? %>
  <figure class="attachment attachment--preview attachment--<%= blob.filename.extension %>">
    <%= render "active_storage/blobs/web/representation", blob: blob %>

    <figcaption class="attachment__caption">
      <% if caption = blob.try(:caption) %>
        <span><%= caption %></span>
      <% else %>
        <span class="attachment__name"><%= blob.filename %></span>
      <% end %>
      <span>  </span>
      <span class="attachment__size"><%= number_to_human_size blob.byte_size %></span>
      <span>  </span>
      <%= link_to rails_blob_path(blob, disposition: :attachment), class: "attachment__link", download: blob.filename, title: "Download #{blob.filename}" do %>
        <span>Download</span>
      <% end %>
    </figcaption>
  </figure>
<% else %>
  <div class="attachment attachment--file attachment--<%= blob.filename.extension -%>">
    <%= render "active_storage/blobs/web/representation", blob: blob %>

    <div class="attachment__caption">
      <div>
        <% if caption = blob.try(:caption) %>
          <strong><%= caption %></strong>
        <% else %>
          <strong class="attachment__name"><%= blob.filename %></strong>
        <% end %>
      </div>
      <div>
        <span class="attachment__size"><%= number_to_human_size blob.byte_size %></span>
        <span>  </span>
        <%= link_to rails_blob_path(blob, disposition: :attachment), class: "attachment__link", download: blob.filename, title: "Download #{blob.filename}" do %>
          <span>Download</span>
        <% end %>
      </div>
    </div>
  </div>
<% end %>

================
File: app/views/bar/_bar.html.erb
================
<div class="bar full-width" data-controller="bar" data-bar-dialog-outlet="#bar-modal"
    data-bar-search-url-value="<%= search_path %>">
  <div class="flex justify-center bar__placeholder" data-bar-target="buttonsContainer">
    <%= tag.button class: "btn btn--plain", data: {
          controller: "hotkey", action: "bar#search keydown.k@document->hotkey#click" } do %>
      <span class="display-contents">Search <kbd class="hide-on-touch">K</kbd></span>
    <% end %>
  </div>

  <div class="bar__input" data-bar-target="search" hidden>
    <%= render "searches/form", query_terms: "", target_turbo_frame: "bar_content" %>
  </div>

  <%= tag.dialog id: "bar-modal", class: "bar__modal", data: {
        controller: "dialog", dialog_target: "dialog", action: "keydown.esc@document->bar#reset:stop" } do %>
    <%= turbo_frame_tag "bar_content", data: { bar_target: "turboFrame" } %>
  <% end %>
</div>

================
File: app/views/boards/columns/closeds/show.html.erb
================
<% @page_title = "Column: Done" %>

<% content_for :header do %>
  <div class="header__actions header__actions--start">
    <%= link_back_to_board(@board) %>
  </div>

  <h1 class="header__title divider divider--fade full-width" data-bridge--title-target="header">
    <span class="overflow-ellipsis"><%= @page_title %></span>
  </h1>
<% end %>

<section class="cards cards--grid">
  <%= turbo_frame_tag :closed_column do %>
    <div class="cards__list hide-scrollbar" data-drag-drop-item-container>
      <% if @page.used? %>
        <%= with_automatic_pagination :closed_column, @page do %>
          <%= render "cards/display/previews", cards: @page.records, draggable: true %>
        <% end %>
      <% else %>
        <%= render "boards/columns/empty_placeholder" %>
      <% end %>
    </div>
  <% end %>
</section>

================
File: app/views/boards/columns/not_nows/show.html.erb
================
<% @page_title = "Column: Not Now" %>

<% content_for :header do %>
  <div class="header__actions header__actions--start">
    <%= link_back_to_board(@board) %>
  </div>

  <h1 class="header__title divider divider--fade full-width" data-bridge--title-target="header">
    <span class="overflow-ellipsis"><%= @page_title %></span>
  </h1>
<% end %>

<section class="cards cards--grid">
  <%= turbo_frame_tag :not_now_column do %>
    <div class="cards__list hide-scrollbar" data-drag-drop-item-container>
      <% if @page.used? %>
        <%= with_automatic_pagination :not_now_column, @page do %>
          <%= render "cards/display/previews", cards: @page.records, draggable: true %>
        <% end %>
      <% else %>
        <%= render "boards/columns/empty_placeholder" %>
      <% end %>
    </div>
  <% end %>
</section>

================
File: app/views/boards/columns/streams/show.html.erb
================
<% @page_title = "Column: Maybe?" %>

<% content_for :header do %>
  <div class="header__actions header__actions--start">
    <%= link_back_to_board(@board) %>
  </div>

  <h1 class="header__title divider divider--fade full-width" data-bridge--title-target="header">
    <span class="overflow-ellipsis"><%= @page_title %></span>
  </h1>
<% end %>

<section class="cards cards--grid">
  <%= turbo_frame_tag :stream_column do %>
    <div class="cards__list hide-scrollbar" data-drag-drop-item-container>
      <% if @page.used? %>
        <%= with_automatic_pagination :stream_column, @page do %>
          <%= render "cards/display/previews", cards: @page.records, draggable: true %>
        <% end %>
      <% else %>
        <%= render "boards/columns/empty_placeholder" %>
      <% end %>
    </div>
  <% end %>
</section>

================
File: app/views/boards/columns/_empty_placeholder.html.erb
================
<div class="blank-slate blank-slate--default">No cards here</div>
<div class="blank-slate blank-slate--drag overflow-ellipsis">Drag cards here</div>

================
File: app/views/boards/columns/create.turbo_stream.erb
================
<%= turbo_stream.before("closed-cards", partial: "boards/show/column", method: :morph, locals: { column: @column }) %>
<%= render "columns/refresh_adjacent_columns", column: @column %>

================
File: app/views/boards/columns/index.json.jbuilder
================
json.array! @columns, partial: "columns/column", as: :column

================
File: app/views/boards/columns/show.html.erb
================
<% @page_title = "Column: #{ @column.name }" %>

<% content_for :header do %>
  <div class="header__actions header__actions--start">
    <%= link_back_to_board(@column.board) %>
  </div>

  <h1 class="header__title divider divider--fade full-width" data-bridge--title-target="header">
    <span class="overflow-ellipsis"><%= @page_title %></span>
  </h1>
<% end %>

<section class="cards cards--grid">
  <%= turbo_frame_tag @column, :cards do %>
    <div class="cards__list hide-scrollbar" data-drag-drop-item-container>
      <% if @page.used? %>
        <%= with_automatic_pagination dom_id(@column, :cards), @page do %>
          <%= render "cards/display/previews", cards: @page.records, draggable: true %>
        <% end %>
      <% else %>
        <%= render "boards/columns/empty_placeholder" %>
      <% end %>
    </div>
  <% end %>
</section>

================
File: app/views/boards/columns/show.json.jbuilder
================
json.partial! "columns/column", column: @column

================
File: app/views/boards/columns/update.turbo_stream.erb
================
<%= turbo_stream.replace(dom_id(@column), partial: "boards/show/column", method: :morph, locals: { column: @column }) %>

================
File: app/views/boards/edit/_auto_close.html.erb
================
<%= turbo_frame_tag board, :entropy do %>
  <div class="margin-block-end">
    <h2 class="divider txt-large">Auto close</h2>
    <p class="margin-none-block-start">Fizzy doesnt let stale cards stick around forever. Cards automatically move to Not now if no one updates, comments, or moves a card for</p>
    <%= render "entropy/auto_close", model: board, url: board_entropy_path(board), disabled: !Current.user.can_administer_board?(board) %>
  </div>
<% end %>

================
File: app/views/boards/edit/_delete.html.erb
================
<div class="txt-align-center margin-block-start-auto" data-controller="dialog" data-dialog-modal-value="true" data-action="keydown.esc->dialog#close:stop">
  <button type="button" class="btn txt-negative borderless txt-small" data-action="dialog#open">
    <%= icon_tag "trash" %>
    <span>Delete this board</span>
  </button>
  <dialog class="dialog panel fill-white shadow gap flex-column" style="--panel-size: 40ch" data-dialog-target="dialog">
    <h3 class="txt-large txt-bold">Delete this board?</h3>
    <p class="txt-medium margin-block-half">Are you sure you want to permanently delete this board and all the cards on it? This can't be undone.</p>
    <div class="flex gap-half justify-center margin-block-start">
      <button type="button" class="btn" data-action="dialog#close">Cancel</button>
      <%= button_to board_path(board), method: :delete, class: "btn txt-negative", data: { turbo_frame: "_top" } do %>
        <span>Delete board</span>
      <% end %>
    </div>
  </dialog>
</div>

================
File: app/views/boards/edit/_name.html.erb
================
<div class="flex align-center gap">
  <label class="flex-item-grow">
    <strong><%= form.text_field :name, name: "board[name]", class: "input full-width txt-medium",
          required: true, autofocus: false, placeholder: "Board name",
          data: { action: "keydown.enter->form#submit:prevent, keydown.esc->form#cancel" },
          readonly: !Current.user.can_administer_board?(board) %></strong>
  </label>
</div>

================
File: app/views/boards/edit/_publication.html.erb
================
<%= turbo_frame_tag @board, :publication do %>
  <header>
    <h2 class="divider txt-large">Public link</h2>
    <div>Turn on the Public link to share this board with anyone in the world. They wont need to log in and they wont be able to see anything else in Fizzy.</div>
  </header>

  <% if board.published? %>
    <div class="border-radius pad fill-selected">
      <%= form_with url: board_publication_path(board), method: :delete, class: "flex-inline center justify-between gap", data: { controller: "form" } do |form| %>
        <label class="flex gap cursor-pointer">
          <span class="txt-large"><%= icon_tag "lock" %></span>
          <span class="switch flex align-center justify-between">
            <%= form.check_box :published, class: "switch__input", checked: true, data: { action: "change->form#submit" }, disabled: !Current.user.can_administer_board?(@board) %>
            <span class="switch__btn round"></span>
          </span>
          <span class="for-screen-reader">Turn off the public link</span>
        </label>
        <span class="txt-large" aria-hidden="true"><%= icon_tag "world" %></span>
      <% end %>

      <div class="flex align-center gap-half margin-block">
        <%= text_field_tag :publication_url, published_board_url(board), readonly: true, class: "full-width input fill-white" %>
        <div class="flex align-center justify-center gap-half">
          <%= button_to_copy_to_clipboard(published_board_url(board)) do %>
            <%= icon_tag "copy-paste" %>
            <span class="for-screen-reader">Copy public link</span>
          <% end %>
        </div>
      </div>
      <strong class="margin-block-end-half flex justify-center txt-small">Add an optional description to the public page</strong>
      <div class="border-radius input fill-white">
        <%= form_with model: board, class: "txt-align-start", data: { controller: "form", turbo_frame: "_top" } do |form| %>
          <%= form.rich_textarea :public_description, class: "rich-text-content txt-small",
            placeholder: "Add a public note about this board",
            data: { action: "keydown.ctrl+enter->form#submit:prevent keydown.meta+enter->form#submit:prevent keydown.esc->form#cancel:stop" },
            readonly: !Current.user.can_administer_board?(@board) %>
          <%= form.button "Save changes", type: :submit, class: "btn txt-small", title: "Save changes (#{ hotkey_label(["ctrl", "enter"]) })" %>
        <% end %>
      </div>
    </div>
  <% else %>
    <div class="border-radius pad fill-shade">
      <%= form_with url: board_publication_path(board), method: :post, class: "flex-inline center justify-between gap", data: { controller: "form" } do |form| %>
        <span class="txt-large" aria-hidden="true"><%= icon_tag "lock" %></span>
        <label class="flex gap cursor-pointer">
          <span class="switch flex align-center justify-between">
            <%= form.check_box :published, class: "switch__input", checked: false, data: { action: "change->form#submit" }, disabled: !Current.user.can_administer_board?(@board) %>
            <span class="switch__btn round"></span>
          </span>
          <span class="txt-large"><%= icon_tag "world" %></span>
          <span class="for-screen-reader">Turn on the public link</span>
        </label>
      <% end %>
    </div>
  <% end %>
<% end %>

================
File: app/views/boards/edit/_users.html.erb
================
<% disabled = !Current.user.can_administer_board?(board) %>
<header>
  <h2 class="divider txt-medium margin-block-start">Who can access this board?</h2>
</header>

<%= access_menu_tag board, class: "settings__user-filter unpad margin-none" do %>
  <li class="flex align-center gap-half">
    <figure class="avatar fill-selected">
      <%= icon_tag "everyone" %>
      <span class="for-screen-reader">Everyone</span>
    </figure>

    <div class="min-width">
      <div class="overflow-ellipsis"><strong>Everyone</strong></div>
    </div>

    <hr class="separator--horizontal flex-item-grow" style="--border-color: var(--color-ink-medium); --border-style: dashed" aria-hidden="true" />

    <label for="board_all_access" class="switch">
      <%= form.check_box :all_access, class: "switch__input", checked: board.all_access?, disabled:, data: { action: "change->toggle-class#toggle" } %>
      <span class="switch__btn round"></span>
      <span class="for-screen-reader">Give everyone access to this board</span>
    </label>
  </li>

  <input placeholder="Filter" class="input input--transparent full-width txt-small" type="search" autocorrect="off" autocomplete="off" data-1p-ignore="true" data-filter-target="input" data-action="input->filter#filter">

  <div class="toggler__visible-when-off">
    <div class="flex align-center justify-end gap-half">
      <%= button_tag "Select all", type: "button", class: "btn btn--plain txt-x-small txt-link font-weight-normal", data: { action: "click->toggle-class#checkAll" }, disabled: %>
      <span class="txt-subtle">&middot;</span>
      <%= button_tag "Select none", type: "button", class: "btn btn--plain txt-x-small txt-link font-weight-normal", data: { action: "click->toggle-class#checkNone" }, disabled: %>
    </div>
  </div>

  <ul class="settings__user-list" data-filter-target="list">
    <%= access_toggles_for selected_users, selected: true, disabled: %>
    <%= access_toggles_for unselected_users, selected: false, disabled: %>
  </ul>
<% end %>

================
File: app/views/boards/entropies/update.turbo_stream.erb
================
<%= turbo_stream.replace([ @board, :entropy ], partial: "boards/edit/auto_close", locals:{ board: @board }) %>
<%= turbo_stream_flash(notice: "Saved") %>

================
File: app/views/boards/involvements/update.html.erb
================
<%= access_involvement_advance_button(@board, Current.user, show_watchers: params[:show_watchers] == "true", icon_only: params[:icon_only] == "true") %>

================
File: app/views/boards/publications/create.turbo_stream.erb
================
<%= turbo_stream.replace([ @board, :publication ], partial: "boards/edit/publication", locals:{ board: @board }) %>
<%= turbo_stream_flash(notice: "Saved") %>

================
File: app/views/boards/publications/destroy.turbo_stream.erb
================
<%= turbo_stream.replace([ @board, :publication ], partial: "boards/edit/publication", locals:{ board: @board }) %>
<%= turbo_stream_flash(notice: "Saved") %>

================
File: app/views/boards/show/menu/_column_form.html.erb
================
<%= form_with model: [board, column], data: { controller: "form", action: "turbo:submit-end->dialog#close turbo:submit-end->form#reset keydown->dialog#captureKey" } do |form| %>
  <%= form.text_field :name, class: "input", placeholder: "Name this column", value: column.name,
        required: true, autocomplete: "off", pattern: ".*\\S.*", title: "Column name cannot be blank", data: { action: "focus->form#select" } %>

  <div class="color-picker__colors">
    <% Color::COLORS.each do |color| %>
      <label class="btn txt-small borderless" style="--btn-background: <%= color %>" title="<%= color.name %>">
        <%= form.radio_button :color, color.value, checked: (column.color == color || (column.new_record? && color == Column::Colored::DEFAULT_COLOR)) %>
        <%= icon_tag "check", class: "checked" %>
        <span class="for-screen-reader"><%= color.name %></span>
      </label>
    <% end %>
  </div>

  <%= form.submit label, class: "btn btn--link" %>
<% end %>

================
File: app/views/boards/show/menu/_column.html.erb
================
<div id="<%= dom_id(column, :menu) %>" class="cards__menu" data-controller="dialog" data-action="keydown.esc->dialog#close click@document->dialog#closeOnClickOutside">
  <button class="btn btn--circle txt-x-small borderless" data-action="click->dialog#open">
    <%= icon_tag "menu-dots-horizontal", class: "translucent" %>
    <span class="for-screen-reader">Column options</span>
  </button>
  <dialog class="popup popup--align-right panel flex-column gap fill-white shadow txt-small margin-block-double" data-dialog-target="dialog">
    <ul class="popup__list">
      <li class="popup__item">
        <button class="popup__btn btn" data-action="click->clicker#click">
          <%= icon_tag "pencil" %>
          <span>Edit column</span>
        </button>
      </li>

      <li class="popup__item">
        <%= button_to column_left_position_path(column),
              class: "popup__btn btn",
              form_class: "display-contents",
              disabled: column.leftmost? do %>
          <%= icon_tag "column-left" %>
          <span>Move to the left</span>
        <% end %>
      </li>

      <li class="popup__item">
        <%= button_to column_right_position_path(column),
              class: "popup__btn btn",
              form_class: "display-contents",
              disabled: column.rightmost? do %>
          <%= icon_tag "column-right" %>
          <span>Move to the right</span>
        <% end %>
      </li>

      <li class="popup__item">
        <%= button_to board_column_path(column.board, column),
              method: :delete,
              class: "popup__btn btn txt-negative",
                form_class: "display-contents",
              form: { data: { turbo_confirm: "Are you sure you want to delete this column? This will move the cards back to Maybe." } } do %>
          <%= icon_tag "trash" %>
          <span>Delete column</span>
        <% end %>
      </li>
    </ul>
  </dialog>

  <div data-controller="dialog" data-action="keydown.esc->dialog#close click@document->dialog#closeOnClickOutside">
    <button id="<%= dom_id(column, :manage_menu) %>" class="popup__btn btn" data-action="click->dialog#open:stop" data-clicker-target="clickable" hidden aria-hidden>Save changes</button>
    <dialog class="popup panel flex-column gap-half fill-white shadow txt-small margin-block-double" data-dialog-target="dialog" data-action="turbo:before-morph-attribute->dialog#preventCloseOnMorphing">
      <%= render "boards/show/menu/column_form", board: column.board, column: column, label: "Save changes" %>
    </dialog>
  </div>
</div>

================
File: app/views/boards/show/menu/_columns.html.erb
================
<div class="cards__new-column" data-controller="dialog" data-action="keydown.esc->dialog#close click@document->dialog#closeOnClickOutside" data-turbo-permanent>
  <button class="btn btn--circle btn--circle-mobile txt-x-small borderless" data-controller="tooltip" data-action="click->dialog#open:stop">
    <%= icon_tag "add", class: "translucent" %>
    <span class="for-screen-reader">Add a column</span>
  </button>
  <dialog class="popup panel flex-column gap-half fill-white shadow txt-small margin-block-double" data-dialog-target="dialog">
    <%= render "boards/show/menu/column_form", board: board, column: Column.new, label: "Add column" %>
  </dialog>
</div>

================
File: app/views/boards/show/menu/_maximize.html.erb
================
<%= link_to column_path, class: "cards__maximize-button btn btn--circle txt-x-small borderless", data: { turbo_frame: "_top" } do %>
  <%= icon_tag "grid", class: "translucent" %>
  <span class="for-screen-reader">Expand column</span>
<% end %>

================
File: app/views/boards/show/_closed.html.erb
================
<%= column_tag id: "closed-cards", name: "Done", drop_url: columns_card_drops_closure_path("__id__"), class: "cards--closed", style: "--card-color: var(--color-card-complete);",
  data: {
    card_hotkeys_disabled: true,
    drag_and_strum_target: "container",
    collapsible_columns_target: "column",
    action: "focus->collapsible-columns#focusOnColumn"
  } do %>
  <header class="cards__header">
    <%= render "boards/show/expander", title: "Done", count: board.cards.closed.count, column_id: "closed-cards" %>
    <%= render "boards/show/menu/maximize", column_path: board_columns_closed_path(board) %>
  </header>
  <%= column_frame_tag :closed_column, src: board_columns_closed_path(board) %>
<% end %>

================
File: app/views/boards/show/_column.html.erb
================
<%= column_tag id: dom_id(column), name: column.name, drop_url: columns_card_drops_column_path("__id__", column_id: column.id), card_color: column.color.to_s,
      class: "cards--doing", style: "--card-color: #{column.color};",
  data: {
    drag_and_strum_target: "container",
    collapsible_columns_target: "column",
    controller: "clicker",
    action: "turbo:before-stream-render@document->collapsible-columns#restoreState focus->collapsible-columns#focusOnColumn"
  } do %>
  <header class="cards__header">
    <%= render "boards/show/menu/column", column: column %>
    <%= render "boards/show/expander", title: column.name, count: column.cards.active.count, column_id: dom_id(column) %>

    <%= link_to board_column_path(column.board, column), class: "cards__maximize-button btn btn--circle txt-x-small borderless", data: { turbo_frame: "_top" } do %>
      <%= icon_tag "grid", class: "translucent" %>
      <span class="for-screen-reader">Maximize column</span>
    <% end %>
  </header>
  <%= column_frame_tag dom_id(column, :cards), src: board_column_path(column.board, column) %>
<% end %>

================
File: app/views/boards/show/_columns.html.erb
================
<%= tag.div class: "card-columns hide-scrollbar", data: {
      controller: "collapsible-columns drag-and-drop drag-and-strum navigable-list card-hotkeys",
      drag_and_drop_dragged_item_class: "drag-and-drop__dragged-item",
      drag_and_drop_hover_container_class: "drag-and-drop__hover-container",
      collapsible_columns_board_value: board.id,
      collapsible_columns_collapsed_class: "is-collapsed",
      collapsible_columns_expanded_class: "is-expanded",
      collapsible_columns_no_transitions_class: "no-transitions",
      collapsible_columns_title_not_visible_class: "is-off-screen",
      navigable_list_supports_vertical_navigation_value: false,
      navigable_list_has_nested_navigation_value: true,
      navigable_list_prevent_handled_keys_value: true,
      navigable_list_auto_select_value: false,
      navigable_list_auto_scroll_value: false,
      card_hotkeys_navigable_list_outlet: ".cards__transition-container",
      action: "
        keydown->navigable-list#navigate
        keydown->card-hotkeys#handleKeydown
        turbo:morph@document->card-hotkeys#handleMorphComplete
        dragstart->drag-and-drop#dragStart
        dragover->drag-and-drop#dragOver
        dragenter->drag-and-strum#dragEnter
        drop->drag-and-drop#drop
        dragend->drag-and-drop#dragEnd
        click@document->navigable-list#deselectWhenClickingOutside" } do %>
  <div class="card-columns__left">
    <%= render "boards/show/not_now", board: board %>
  </div>

  <%= render "boards/show/stream", board: board, page: page %>

  <div class="card-columns__right">
    <%= render partial: "boards/show/column", collection: board.columns.sorted, cached: ->(column){ [ column, column.leftmost?, column.rightmost? ] } %>
    <%= render "boards/show/closed", board: board %>

    <%= render "boards/show/menu/columns", board: board %>
  </div>
<% end %>

================
File: app/views/boards/show/_expander.html.erb
================
<button class="cards__expander btn btn--plain" data-collapsible-columns-target="button" data-css-variable-counter-target="counter" data-action="click->collapsible-columns#toggle click->navigable-list#selectCurrentOrReset"
  style="--card-count: <%= [ count, 15 ].min %>" aria-controls="<%= column_id %>" aria-expanded="false">
  <span class="cards__expander-count" data-drag-and-drop-counter="true"><%= count > 99 ? "99+" : count %></span>
  <h2 class="cards__expander-title" data-collapsible-columns-target="title">
    <%= title %>
    <%= icon_tag "collapse" %>
  </h2>
</button>
<%= yield if block_given? %>

================
File: app/views/boards/show/_filtered_cards.html.erb
================
<section class="cards cards--grid">
  <div class="cards__list hide-scrollbar">
    <%= with_automatic_pagination :filtered_cards_paginated_container, page do %>
      <%= render "cards/display/previews", cards: page.records, draggable: true %>
    <% end %>
    <div class="blank-slate">No cards match this filter</div>
  </div>
</section>

================
File: app/views/boards/show/_not_now.html.erb
================
<%= column_tag id: "not-now", name: "Not Now", drop_url: columns_card_drops_not_now_path("__id__"), class: "cards--on-deck", style: "--card-color: var(--color-card-complete);",
  data: {
    card_hotkeys_disabled: true,
    collapsible_columns_target: "column",
    drag_and_strum_target: "container",
    action: "focus->collapsible-columns#focusOnColumn"
  } do %>
  <header class="cards__header">
    <%= render "boards/show/expander", title: "Not Now", count: board.cards.postponed.count, column_id: "not-now" %>
    <%= render "boards/show/menu/maximize", column_path: board_columns_not_now_path(board) %>
  </header>
  <%= column_frame_tag :not_now_column, src: board_columns_not_now_path(board) %>
<% end %>

================
File: app/views/boards/show/_stream.html.erb
================
<%= column_tag id: "maybe", name: "Maybe?", drop_url: columns_card_drops_stream_path("__id__"), collapsed: false, selected: "true", class: "cards--maybe", data: {
  drag_and_strum_target: "container",
  collapsible_columns_target: "column maybeColumn",
  action: "focus->collapsible-columns#focusOnColumn"
} do %>
  <header class="cards__header">
    <%= render "boards/show/expander", title: "Maybe?", count: board.cards.awaiting_triage.count, column_id: "maybe" %>
    <%= render "boards/show/menu/maximize", column_path: board_columns_stream_path(board) %>
  </header>
  <div data-bridge-disabled="true">
    <%= render "columns/show/add_card_button", board: board %>
  </div>
  <div class="cards__list hide-scrollbar" data-drag-drop-item-container>
    <% if page.used? %>
      <%= with_automatic_pagination "maybe", @page do %>
        <%= render "cards/display/previews", cards: page.records, draggable: true %>
      <% end %>
    <% end %>
  </div>
<% end %>

================
File: app/views/boards/_access_toggle.html.erb
================
<li class="flex align-center gap-half" data-filter-target="item" data-navigable-list-target="item">
  <%= link_to user, class: "txt-ink flex gap-half align-center min-width" do %>
    <%= avatar_preview_tag user, hidden_for_screen_reader: true %>
    <div class="txt-align-start overflow-ellipsis">
      <strong><%= user.name %></strong>
      <div class="txt-x-small"><%= user.identity.email_address %></div>
    </div>
  <% end %>

  <hr class="separator--horizontal flex-item-grow" style="--border-color: var(--color-ink-medium); --border-style: dashed" aria-hidden="true">

  <%= icon_tag "check", class: "toggler__visible-when-on margin-inline-end" %>

  <label class="switch toggler__visible-when-off flex-item-no-shrink">
    <% checkbox_data = { toggle_class_target: "checkbox" } %>
    <% checkbox_data[:boards_form_target] = "meCheckbox" if user == Current.user %>
    <%= check_box_tag "user_ids[]", user.id, selected, class: "switch__input", id: nil, data: checkbox_data, disabled: disabled %>
    <span class="switch__btn round"></span>
    <span class="for-screen-reader">Give <%= user.name %> access</span>
  </label>
</li>

================
File: app/views/boards/_board.json.jbuilder
================
json.cache! board do
  json.(board, :id, :name, :all_access)
  json.created_at board.created_at.utc
  json.url board_url(board)

  json.creator board.creator, partial: "users/user", as: :user
end

================
File: app/views/boards/edit.html.erb
================
<% @page_title = "Board Settings" %>

<% content_for :header do %>
  <div class="header__actions header__actions--start">
    <%= link_back_to_board(@board) %>
  </div>

  <h1 class="header__title" data-bridge--title-target="header">
    <div><%= @page_title %></div>
    <% unless Current.user.can_administer_board?(@board) %>
      <div class="txt-normal font-weight-normal">Only admins can change these settings</div>
    <% end %>
  </h1>
<% end %>

<section class="settings">
  <div class="settings__panel settings__panel--users panel shadow">
    <%= form_with model: @board, class: "display-contents", data: {
          controller: "form boards-form",
          boards_form_self_removal_prompt_message_value: "Are you sure you want to remove yourself from this board? You wont be able to get back in unless someone invites you.",
          action: "turbo:submit-start->boards-form#submitWithWarning" } do |form| %>
      <%= render "boards/edit/name", form: form, board: @board %>
      <%= render "boards/edit/users", board: @board, selected_users: @selected_users, unselected_users: @unselected_users, form: form %>

      <button type="submit" id="log_in" class="btn btn--link center txt-normal" <%= "disabled" unless Current.user.can_administer_board?(@board) %>>
        <span>Save changes</span>
      </button>

      <%= link_to "Cancel and go back", @board, data: { form_target: "cancel", turbo_frame: "_top" }, hidden: true %>
    <% end %>
  </div>

  <div class="settings__panel panel shadow">
    <%= render "boards/edit/auto_close", board: @board %>
    <%= render "boards/edit/publication", board: @board %>
    <%= render "boards/edit/delete", board: @board if Current.user.can_administer_board?(@board) %>
  </div>
</section>

================
File: app/views/boards/index.json.jbuilder
================
json.array! @page.records, partial: "boards/board", as: :board

================
File: app/views/boards/new.html.erb
================
<% @page_title = "Create a new board" %>
<% @body_class = "compact-on-touch" %>

<div class="panel panel--centered">
  <%= bridged_form_with model: @board, class: "flex flex-column gap", data: { controller: "form", action: "submit->form#preventEmptySubmit" } do |form| %>
    <h1 class="txt-x-large margin-none font-weight-black"><%= @page_title %></h1>
    <%= form.text_field :name, required: true, class: "input full-width", autofocus: true, autocomplete: "off", placeholder: "Name it", data: { form_target: "input", action: "keydown.esc@document->form#cancel", validation_message: "Board names cant be blank" } %>

    <button type="submit" class="btn btn--link center" data-bridge--form-target="submit">
      <span>Create board</span>
      <%= icon_tag "arrow-right" %>
    </button>

    <%= link_to "Cancel and go back", root_path, data: { form_target: "cancel", turbo_frame: "_top" }, hidden: true %>
  <% end %>
</div>

================
File: app/views/boards/show.html.erb
================
<% @page_title = @board.name %>
<% @body_class = "contained-scrolling" %>
<% turbo_exempts_page_from_cache %>

<%= turbo_stream_from @board %>

<% content_for :header do %>
  <div class="header__actions header__actions--start hide-on-native">
    <%= link_to_webhooks(@board) if Current.user.admin? %>
  </div>

  <h1 class="header__title divider divider--fade full-width" data-bridge--title-target="header">
    <span class="overflow-ellipsis"><%= @board.name %></span>
  </h1>

  <div class="header__actions header__actions--end hide-on-native">
    <%= link_to_edit_board @board %>
  </div>
<% end %>

<%= render "filters/settings", filter_url: board_path(@board), user_filtering: @user_filtering, no_filtering_url: board_path(@board) do |form| %>
  <%= hidden_field_tag "board_ids[]", @board.id %>
<% end %>

<%= turbo_frame_tag :cards_container do %>
  <% if @filter.used?(ignore_boards: true) %>
    <%= render "boards/show/filtered_cards", page: @page %>
  <% else %>
    <%= render "columns/show/add_card_button", board: @board %>
    <%= render "boards/show/columns", page: @page, board: @board %>
  <% end %>
<% end %>

================
File: app/views/boards/show.json.jbuilder
================
json.partial! "boards/board", board: @board

================
File: app/views/cards/assignments/_user.html.erb
================
<li class="popup__item" data-filter-target="item" data-navigable-list-target="item" <%= tag.attributes(data: local_assigns.fetch(:data, {})) %> aria-checked="<%= card.assignees.include?(user) %>">
  <%= button_to card_assignments_path(card, params: { assignee_id: user.id }), method: :post,
        class: "popup__btn btn", form_class: "max-width flex-item-grow" do %>
    <span class="overflow-ellipsis flex-item-grow"><%= local_assigns.fetch(:user_label, user.name) %></span>
    <%= yield if block_given? %>
    <%= icon_tag "check", size: 18, class: "checked flex-item-no-shrink flex-item-justify-end", style: "--icon-size: 1em" %>
  <% end %>
</li>

================
File: app/views/cards/assignments/create.turbo_stream.erb
================
<%= turbo_stream.replace([ @card, :meta ], partial: "/cards/display/perma/meta", method: "morph", locals: { card: @card.reload }) %>

================
File: app/views/cards/assignments/new.html.erb
================
<%= turbo_frame_tag @card, :assignment do %>
  <%= tag.div class: "max-width full-width", data: {
				action: "turbo:before-cache@document->dialog#close dialog:show@document->navigable-list#reset keydown->navigable-list#navigate filter:changed->navigable-list#reset",
				controller: "filter navigable-list assignment-limit",
				dialog_target: "dialog",
				navigable_list_focus_on_selection_value: false,
				navigable_list_actionable_items_value: true,
				assignment_limit_limit_value: Assignment::LIMIT,
				assignment_limit_count_value: @card.assignments.count } do %>

    <div class="flex align-start justify-space-between">
      <strong class="popup__title">Assign this to</strong>
      <kbd class="txt-xx-small hide-on-touch">a</kbd>
    </div>

    <%= text_field_tag :search, nil, placeholder: "Filter", class: "input input--transparent txt-small margin-block-half", autofocus: true,
          type: "search", autocorrect: "off", autocomplete: "off", data: { "1p-ignore": "true", filter_target: "input", action: "input->filter#filter" } %>

    <ul class="popup__list" data-filter-target="list">
      <%= render "user", card: @card, user: Current.user, user_label: "Me" do %>
        <span class="visually-hidden"><%= Current.user.name %></span>
        <kbd class="txt-xx-small hide-on-touch">m</kbd>
      <% end %>
      <%= render collection: @assigned_to, partial: "user", locals: { card: @card } %>
      <% @users.each do |user| %>
        <%= render "user", card: @card, user: user, data: { assignment_limit_target: "unassigned" } %>
      <% end %>
    </ul>

    <div class="popup__footer" hidden data-assignment-limit-target="limitMessage">
      Maximum <%= Assignment::LIMIT %> assignees
    </div>
  <% end %>
<% end %>

================
File: app/views/cards/boards/edit.html.erb
================
<%= turbo_frame_tag "board_picker" do %>
  <%= tag.div class: "max-width full-width", data: {
        action: "turbo:before-cache@document->dialog#close dialog:show@document->navigable-list#reset keydown->navigable-list#navigate filter:changed->navigable-list#reset",
        controller: "filter navigable-list",
        dialog_target: "dialog",
        navigable_list_focus_on_selection_value: false,
        navigable_list_actionable_items_value: true } do %>
    <%= filter_title "Move this card to" %>

    <%= text_field_tag :search, nil, placeholder: "Filter", class: "input input--transparent txt-small margin-block-half font-weight-normal", autofocus: true,
          type: "search", autocorrect: "off", autocomplete: "off", data: { "1p-ignore": "true", filter_target: "input", dialog_target: "focusMouse", action: "input->filter#filter" } %>

    <ul class="popup__list margin-block-start-half margin-none-block-end" data-filter-target="list">
      <% @boards.each do |board| %>
        <li class="popup__item" data-filter-target="item" data-navigable-list-target="item" aria-checked="<%= @card.board == board %>">
          <%= button_to card_board_path(@card, params: { board_id: board.id }), method: :patch,
                class: "popup__btn btn",
                form_class: "max-width flex-item-grow" do %>
            <span class="overflow-ellipsis flex-item-grow"><%= board.name %></span>
            <%= icon_tag "check", size: 18, class: "checked flex-item-no-shrink flex-item-justify-end", style: "--icon-size: 1em" %>
          <% end %>
        </li>
      <% end %>
    </ul>
  <% end %>
<% end %>

================
File: app/views/cards/closures/create.turbo_stream.erb
================
<%= turbo_stream.replace("closed-cards", partial: "boards/show/closed", method: :morph, locals: { board: @card.board }) %>

<% if @source_column %>
  <%= turbo_stream.replace(dom_id(@source_column), partial: "boards/show/column", method: :morph, locals: { column: @source_column }) %>
<% elsif @was_in_stream %>
  <%= turbo_stream.replace("the-stream", partial: "boards/show/stream", method: :morph, locals: { board: @card.board, page: @page }) %>
<% end %>

<%= turbo_stream.replace([ @card, :card_container ], partial: "cards/container", method: :morph, locals: { card: @card.reload }) %>

================
File: app/views/cards/closures/destroy.turbo_stream.erb
================
<%= turbo_stream.replace("closed-cards", partial: "boards/show/closed", method: :morph, locals: { board: @card.board }) %>

<% if @card.column %>
  <%= turbo_stream.replace(dom_id(@card.column), partial: "boards/show/column", method: :morph, locals: { column: @card.column }) %>
<% elsif @card.awaiting_triage? %>
  <%= turbo_stream.replace("the-stream", partial: "boards/show/stream", method: :morph, locals: { board: @card.board, page: @page }) %>
<% end %>

<%= turbo_stream.replace([ @card, :card_container ], partial: "cards/container", method: :morph, locals: { card: @card.reload }) %>

================
File: app/views/cards/columns/_column.html.erb
================
<%= render "cards/display/previews", cards: column.cards, draggable: draggable %>

================
File: app/views/cards/columns/edit.html.erb
================
<%= turbo_frame_tag @card, :columns do %>
  <div class="card__stages" role="radiogroup" data-controller="scroll-to">
    <legend class="for-screen-reader">Choose a column for this card</legend>

    <%= button_to "Not now", card_not_now_path(@card),
        class: [ "card__column-name btn", { "card__column-name--current": @card.postponed? } ],
        style: "--column-color: var(--color-card-complete)",
        disabled: @card.postponed?,
        role: "radio",
        aria: { checked: @card.postponed? },
        data: { scroll_to_target: @card.postponed? ? "target" : nil },
        form_class: "flex gap-half" %>

    <%= button_to "Maybe?", card_triage_path(@card), method: :delete,
        class: [ "card__column-name card__column-name--stream btn", { "card__column-name--current": @card.awaiting_triage? } ],
        style: "--column-color: var(--color-card-default)",
        disabled: @card.awaiting_triage?,
        role: "radio",
        aria: { checked: @card.awaiting_triage? },
        data: { scroll_to_target: @card.awaiting_triage? ? "target" : nil },
        form_class: "flex gap-half" %>

    <% @columns.each do |column| %>
      <%= button_to_set_column @card, column %>
    <% end %>

    <%= button_to "Done", card_closure_path(@card),
        class: [ "card__column-name btn", { "card__column-name--current": @card.closed? } ],
        style: "--column-color: var(--color-card-complete)",
        disabled: @card.closed?,
        role: "radio",
        aria: { checked: @card.closed? },
        data: { scroll_to_target: @card.closed? ? "target" : nil },
        form_class: "flex gap-half" %>
  </div>
<% end %>

================
File: app/views/cards/comments/_comment.html.erb
================
<% cache comment do %>
  <%# Helper Dependency Updated: avatar_image_tag 2025-12-15 %>
  <%= turbo_frame_tag comment, :container, class: { "comment-by-system": comment.creator.system? } do %>
    <%# Cache bump 2025-12-14: action text attachment rendering changed for lightbox -%>
    <div id="<%= dom_id(comment) %>" data-creator-id="<%= comment.creator_id %>" class="comment align-start full-width">
      <figure class="comment__avatar flex-item-no-shrink" aria-hidden="true">
        <%= avatar_tag comment.creator, hidden_for_screen_reader: true %>
      </figure>

      <div class="comment__content flex flex-column flex-item-grow full-width">
        <div class="comment__author flex align-center gap-half">
          <h3 class="font-weight-normal txt-normal flex-item-justify-start min-width overflow-ellipsis">
            <strong>
              <%= link_to comment.creator.name, comment.creator, class: "txt-ink btn btn--plain fill-transparent", data: { turbo_frame: "_top" } %>
            </strong>

            <%= link_to comment, class: "comment__permalink-title", data: { turbo_frame: "_top" } do %>
              <%= local_datetime_tag comment.created_at, style: :agoorweekday %>,
              <%= local_datetime_tag comment.created_at, style: :time %>
            <% end %>
          </h3>

          <button class="comment__history btn btn--circle-mobile borderless txt-x-small" data-action="toggle-class#toggle">
            <%= icon_tag "history", class: "icon--mobile-only" %>
            <span>Full history</span>
          </button>

          <%= link_to edit_card_comment_path(comment.card, comment),
                class: "comment__edit btn btn--circle borderless translucent", data: { only_visible_to_you: true } do %>
            <%= icon_tag "menu-dots-horizontal" %>
            <span class="for-screen-reader">Edit this comment</span>
          <% end %>
        </div>

        <div class="comment__body rich-text-content" data-controller="syntax-highlight retarget-links" data-turbo-permanent>
          <%= comment.body %>
        </div>

        <%= render "reactions/reactions", reactable: comment %>
      </div>
    </div>
  <% end %>
<% end %>

================
File: app/views/cards/comments/_comment.json.jbuilder
================
json.cache! comment do
  json.(comment, :id)

  json.created_at comment.created_at.utc
  json.updated_at comment.updated_at.utc

  json.body do
    json.plain_text comment.body.to_plain_text
    json.html comment.body.to_s
  end

  json.creator comment.creator, partial: "users/user", as: :user

  json.card do
    json.id comment.card_id
    json.url card_url(comment.card_id)
  end

  json.reactions_url card_comment_reactions_url(comment.card_id, comment.id)
  json.url card_comment_url(comment.card_id, comment.id)
end

================
File: app/views/cards/comments/_new.html.erb
================
<div id="<%= dom_id(card, :new_comment) %>" class="comment comment--new flex-inline align-start full-width">
  <figure class="comment__avatar flex-item-no-shrink" aria-hidden="true">
    <%= avatar_tag Current.user, hidden_for_screen_reader: true %>
  </figure>

  <div class="comment__content flex-inline flex-column full-width">
    <div class="comment__body rich-text-content" data-turbo-permanent>
      <%= form_with model: Comment.new, url: card_comments_path(card), class: "flex flex-column gap full-width",
            data: { controller: "form local-save",
                  local_save_key_value: "comment-#{card.id}",
                  action: "turbo:submit-end->local-save#submit turbo:submit-end->form#blurActiveInput keydown.ctrl+enter->form#debouncedSubmit:prevent keydown.meta+enter->form#debouncedSubmit:prevent keydown.esc->form#cancel:stop" } do |form| %>
        <%= form.rich_textarea :body, required: true, placeholder: new_comment_placeholder(card),
              data: { local_save_target: "input", action: "lexxy:change->form#disableSubmitWhenInvalid lexxy:change->local-save#save turbo:morph-element->local-save#restoreContent" } do %>
          <%= general_prompts(@card.board) %>
        <% end %>

        <span class="flex-inline align-center gap">
          <%= form.button class: "comment__submit btn btn--reversed",
              title: "Post this comment (#{ hotkey_label(["ctrl", "enter"]) })",
              data: { form_target: "submit" }, disabled: true do %>
            <span>Post</span>
          <% end %>
        </span>
      <% end %>
    </div>
  </div>
</div>

================
File: app/views/cards/comments/_watchers.html.erb
================
<div id="<%= dom_id(card, :comment_watchers) %>" class="comments__subscribers flex flex-column margin-block-start txt-align-start full-width">
  <strong class="txt-uppercase">Subscribers</strong>

  <p class="margin-none-block-start margin-block-end-half">
    <%= pluralize(card.watchers.active.count, "person") %> will be notified when someone comments on this.
  </p>

  <div class="flex align-center flex-wrap gap-half max-width txt-normal">
    <% card.watchers.active.alphabetically.each do |watcher| %>
      <%= avatar_tag watcher %>
    <% end %>
  </div>
</div>

================
File: app/views/cards/comments/create.turbo_stream.erb
================
<%= turbo_stream.before [ @card, :new_comment ], partial: "cards/comments/comment", locals: { comment: @comment } %>

<%= turbo_stream.update [ @card, :new_comment ], partial: "cards/comments/new", locals: { card: @card } %>

================
File: app/views/cards/comments/destroy.turbo_stream.erb
================
<%= turbo_stream.remove [ @comment, :container ] %>

================
File: app/views/cards/comments/edit.html.erb
================
<%= turbo_frame_tag @comment, :container do %>
  <div id="<%= dom_id(@comment) %>" class="comment flex align-start full-width">
    <figure class="comment__avatar flex-item-no-shrink" aria-hidden="true">
      <%= avatar_tag @comment.creator, hidden_for_screen_reader: true %>
    </figure>

    <div class="comment__content flex flex-column flex-item-grow full-width">
      <div class="comment__body rich-text-content" data-turbo-permanent>
        <%= form_with model: [ @card, @comment ], class: "flex flex-column gap full-width",
              data: { controller: "form", action: "keydown.ctrl+enter->form#submit:prevent keydown.meta+enter->form#submit:prevent keydown.esc->form#cancel:stop" } do |form| %>
          <%= form.rich_textarea :body, required: true, autofocus: true, placeholder: new_comment_placeholder(@card) do %>
            <%= general_prompts(@card.board) %>
          <% end %>
          <div class="flex gap-half justify-start align-center">
            <%= form.button class: "btn btn--reversed", type: :submit, title: "Save changes (#{ hotkey_label(["ctrl", "enter"]) })" do %>
              <span>Save</span>
            <% end %>
            <%= link_to card_comment_path(@card, @comment), class: "btn", data: { form_target: "cancel" },title: "Cancel (#{ hotkey_label(["esc"]) })" do %>
              <span>Cancel</span>
            <% end %>

            <%= tag.button type: :submit, class: "btn btn--negative flex-item-justify-end", form: dom_id(@comment, :delete_form),
                  data: { turbo_confirm: "Are you sure you want to delete this comment?" } do %>
              <%= icon_tag "trash" %>
              <span class="for-screen-reader">Delete</span>
            <% end %>
          </div>
        <% end %>

        <%= form_with url: card_comment_path(@card, @comment), method: :delete, id: dom_id(@comment, :delete_form), data: { turbo_frame: "_top" } %>
      </div>
    </div>
  </div>
<% end %>

================
File: app/views/cards/comments/index.json.jbuilder
================
json.array! @page.records, partial: "cards/comments/comment", as: :comment

================
File: app/views/cards/comments/show.html.erb
================
<%= render "cards/comments/comment", comment: @comment %>

================
File: app/views/cards/comments/show.json.jbuilder
================
json.partial! "cards/comments/comment", comment: @comment

================
File: app/views/cards/comments/update.turbo_stream.erb
================
<%= turbo_stream.replace [ @comment, :container ], partial: "cards/comments/comment", locals: { comment: @comment } %>

================
File: app/views/cards/container/footer/_create.html.erb
================
<div class="card-perma__notch card-perma__notch--bottom flex-column">
  <div class="card-perma__notch-new-card-buttons">
    <%= button_to card_publish_path(card), name: "creation_type", value: "add", class: "btn",
          title: "Create card (#{ hotkey_label(["ctrl", "enter"]) })",
          form: { data: { controller: "form bridge--form" } },
          data: { form_target: "submit", bridge__form_target: "submit", controller: "clicker", action: "keydown.ctrl+enter@document->clicker#click keydown.meta+enter@document->clicker#click" } do %>
      <span>Create card</span>
    <% end %>

    <%= button_to card_publish_path(card), method: :post, class: "btn btn--reversed", name: "creation_type", value: "add_another",
          title: "Create and add another (#{ hotkey_label(["ctrl", "shift", "enter"]) })", form: { data: { controller: "form" } },
          data: { form_target: "submit", controller: "clicker", action: "keydown.ctrl+shift+enter@document->clicker#click keydown.meta+shift+enter@document->clicker#click" } do %>
      <span>Create and add another</span>
    <% end %>
  </div>

  <%= render "cards/container/footer/saas/near_notice" if Fizzy.saas? %>
</div>

================
File: app/views/cards/container/footer/_published.html.erb
================
<%# FIXME: Let's move this aside outside of the card container section so these frames don't reload/flicker when card is replaced %>
<div class="card-perma__actions card-perma__actions--right">
  <%= turbo_frame_tag card, :watch, src: card_watch_path(card), target: "_top", refresh: :morph do %>
    <%= button_to card_watch_path(card), class: "btn", data: { controller: "tooltip" } do %>
      <%= icon_tag "bell-off" %> <span class="for-screen-reader">Watch this</span>
    <% end %>
  <% end %>
  <%= turbo_frame_tag card, :pin, src: card_pin_path(card), refresh: :morph do %>
    <%= button_to card_pin_path(card), class: "btn", data: { controller: "tooltip" } do %>
      <%= icon_tag "unpinned" %> <span class="for-screen-reader">Pin this card</span>
    <% end %>
  <% end %>
</div>

<%= render "cards/container/closure", card: card %>

================
File: app/views/cards/container/_closure_buttons.html.erb
================
<div class="flex gap-half">
  <%= link_to edit_card_path(card), class: "btn btn--circle-mobile borderless",
        data: { controller: "hotkey", action: "keydown.e@document->hotkey#click", bridge__buttons_target: "button", bridge_title: "Edit", bridge_icon_url: bridge_icon("pencil"), turbo_frame: dom_id(card, :edit) } do %>
    <%= icon_tag "pencil", class: "icon--mobile-only" %>
    <span>Edit</span>
    <kbd class="txt-x-small hide-on-touch">e</kbd>
  <% end %>

  <%= button_to card_closure_path(card), class: "btn btn--circle-mobile borderless",
        data: { controller: "hotkey", form_target: "submit", bridge__buttons_target: "button", bridge_title: "Mark as Done", bridge_icon_url: bridge_icon("check"), action: "keydown.d@document->hotkey#click" },
        form: { data: { controller: "form" } } do %>
    <%= icon_tag "check", class: "icon--mobile-only" %>
    <span class="overflow-ellipsis">Mark as Done</span>
    <kbd class="txt-x-small hide-on-touch">d</kbd>
  <% end %>
</div>

================
File: app/views/cards/container/_closure.html.erb
================
<div class="display-contents" id="<%= dom_id(card, :card_closure_toggle) %>">
  <% if card.closed? %>
    <div class="card-perma__closure-message flex gap-half justify-center">
      <span>Completed by <%= card.closed_by.name %> on <%= local_datetime_tag(card.closed_at, style: :shortdate) %>.</span>
      <%= button_to card_closure_path(card), method: :delete, class: "btn btn--plain borderless fill-transparent" do %>
        <span class="pad-inline-end">Undo</span>
      <% end %>
    </div>
  <% else %>
    <div class="card-perma__notch card-perma__notch--bottom">
      <%= render "cards/container/closure_buttons", card: card %>
    </div>
    <% if card.entropic? && card.open? && !card.postponed? %>
      <div class="card-perma__closure-message" id="<%= dom_id(card, :closure_notice) %>">
        Moves to Not Now <%= local_datetime_tag(card.entropy.auto_clean_at, style: :indays) -%> if theres no activity.
      </div>
    <% end %>
  <% end %>
</div>

================
File: app/views/cards/container/_content_display.html.erb
================
<h1 class="card__title flex align-start gap-half">
  <%= link_to card.title, edit_card_path(card), class: "card__title-link" %>
</h1>

<% unless card.description.blank? %>
  <div class="card__description rich-text-content" data-controller="syntax-highlight retarget-links">
    <%= card.description %>
  </div>
<% end %>

================
File: app/views/cards/container/_content.html.erb
================
<% if card.published? %>
  <div data-turbo-permanent>
  <%= turbo_frame_tag card, :edit do %>
    <%# When canceling an edit (with the ESC key), restore the button area to show "Edit" instead of "Save changes". %>
    <%= turbo_stream.replace dom_id(card, :card_closure_toggle) do %>
      <%= render "cards/container/closure", card: card %>
    <% end %>

    <%= render "cards/container/content_display", card: card %>
  <% end %>
  </div>
<% else %>
  <%= form_with model: card, id: "card_form", data: { controller: "autoresize auto-save" } do |form| %>
    <h1 class="card__title">
      <%= form.label :title, class: "flex flex-column align-center autoresize__wrapper", data: { autoresize_target: "wrapper", autoresize_clone_value: "" } do %>
        <%= form.text_area :title, placeholder: "Name it",
              class: "card-field__title autoresize__textarea input input--textarea full-width borderless txt-align-start hide-focus-ring hide-scrollbar",
              autofocus: card.title.blank?, rows: 1, dir: "auto", maxlength: 255,
              data: { autoresize_target: "textarea", action: "input->autoresize#resize auto-save#change blur->auto-save#submit keydown.enter->auto-save#submit:prevent" } %>
      <% end %>
    </h1>

    <%= form.rich_textarea :description, class: "card__description rich-text-content",
          placeholder: "Add some notes, context, pictures, or video about this",
          data: { action: "lexxy:change->auto-save#change focusout->auto-save#submit" } do %>
      <%= general_prompts(card.board) %>
    <% end %>
  <% end %>
<% end %>

================
File: app/views/cards/container/_gild.html.erb
================
<% if card.golden? %>
  <%= button_to card_goldness_path(card), method: :delete, class: "btn btn--reversed btn--circle-mobile",
        data: { controller: "tooltip hotkey", action: "keydown.shift+g@document->hotkey#click", bridge__overflow_menu_target: "item", bridge_title: "Demote to normal" } do %>
    <%= icon_tag "golden-ticket" %>
    <span class="for-screen-reader">Demote to normal (shift+g)</span>
  <% end %>
<% else %>
  <%= button_to card_goldness_path(card), class: "btn btn--circle-mobile",
        data: { controller: "tooltip hotkey", action: "keydown.shift+g@document->hotkey#click", bridge__overflow_menu_target: "item", bridge_title: "Promote to Golden Ticket" } do %>
    <%= icon_tag "golden-ticket" %>
    <span class="for-screen-reader">Promote to Golden Ticket (shift+g)</span>
  <% end %>
<% end %>

================
File: app/views/cards/container/_image.html.erb
================
<% if card.image.attached? %>
  <%= button_to card_image_path(card), method: :delete, class: "btn",
        data: { controller: "tooltip", bridge__overflow_menu_target: "item", bridge_title: "Remove background image" } do %>
    <%= icon_tag "picture-remove" %>
    <span class="for-screen-reader">Remove background image</span>
  <% end %>
<% elsif !card.closed? %>
  <%= form_with model: card, data: { controller: "form" } do |form| %>
    <label class="card-perma__image-btn btn input--file btn--circle-mobile" data-controller="tooltip" data-bridge--overflow-menu-target="item" data-bridge-title="Add background image">
      <%= icon_tag "picture-add" %>
      <span class="for-screen-reader">Add background image</span>

      <%= form.file_field :image, class: "input",
            accept: "image/png, image/jpeg, image/jpg, image/webp",
            aria: { label: "Add background image" },
            data: { action: "upload-preview#previewImage form#submit", upload_preview_target: "input" } %>
    </label>
  <% end %>
<% end %>

================
File: app/views/cards/container/_save_button.html.erb
================
<div class="card-perma__notch card-perma__notch--bottom flex-column">
  <%= button_tag type: :submit, form: dom_id(card, :edit_form), class: "btn borderless",
        title: "Save changes (#{ hotkey_label(["ctrl", "enter"]) })",
        data: { controller: "hotkey", bridge__form_target: "submit", action: "keydown.ctrl+enter@document->hotkey#click keydown.meta+enter@document->hotkey#click" } do %>
    <span>Save changes</span>
  <% end %>
</div>

================
File: app/views/cards/display/common/_assignees.html.erb
================
<div id="<%= dom_id(card, :assignees) %>" class="position-relative"
    data-controller="dialog"
    data-action="keydown.esc->dialog#close click@document->dialog#closeOnClickOutside mouseenter->dialog#loadLazyFrames" <%= "hidden" if card.closed? %>>
  <button class="card__assignees-trigger" data-action="click->dialog#open:stop keydown.a@document->hotkey#click" data-controller="tooltip hotkey" tabindex=<%= (local_assigns.key?(:preview) && local_assigns[:preview]) ? -1 : 0 %>>
    <% card.assignees.each do |assignee| %>
      <%= avatar_preview_tag assignee, tabindex: (local_assigns.key?(:preview) && local_assigns[:preview]) ? -1 : 0 %>
    <% end %>

    <span class="btn card__hide-on-index" style="--btn-background: var(--card-bg-color);">
      <%= icon_tag "person-add" %>
      <span class="for-screen-reader">Assign</span>
    </span>
  </button>

  <% if Current.user && !local_assigns[:preview] %>
    <%= button_to "Assign to me", card_assignments_path(card, params: { assignee_id: Current.user.id }), method: :post, data: {controller: "hotkey", action: "keydown.m@document->hotkey#click" }, hidden: true %>
  <% end %>

  <dialog class="popup panel flex-column align-start gap-half fill-white shadow" data-dialog-target="dialog" data-action="turbo:before-morph-attribute->dialog#preventCloseOnMorphing turbo:submit-end->dialog#close">
    <%= yield %>
  </dialog>
</div>

================
File: app/views/cards/display/common/_background.html.erb
================
<% if card.image.present? %>
  <div class="card__background">
    <%= image_tag card.image.presence || "", size: 120, data: { upload_preview_target: "image" } %>
  </div>

  <%= yield %>
<% end %>

================
File: app/views/cards/display/common/_board.html.erb
================
<div class="card__id">
  <span class="for-screen-reader">Card number</span>
  <%= card.number %>
</div>
<div class="card__board-name">
  <span class="overflow-ellipsis"><%= card.board.name %></span>
  <%= yield %>
</div>

================
File: app/views/cards/display/common/_meta.html.erb
================
<div class="card__meta" id="<%= dom_id(card, :meta) %>">
  <div class="card__meta-avatars card__meta-avatars--author">
    <%= avatar_tag card.creator, tabindex: (local_assigns.key?(:preview) && local_assigns[:preview]) ? -1 : 0 %>
  </div>

  <span class="card__meta-text card__meta-text--added">
    <%= card_drafted_or_added(card) %> <%= local_datetime_tag(card.created_at, style: :daysago) %>
  </span>

  <span class="card__meta-text card__meta-text--author">
    By <strong><%= card.creator.familiar_name %></strong>
  </span>

  <span class="card__meta-text card__meta-text--updated overflow-ellipsis">
    <%= icon_tag "refresh--meta" %>
    Updated
    <%= local_datetime_tag(card.last_active_at, style: :daysago) %>
  </span>

  <span class="card__meta-text card__meta-text--assignees overflow-ellipsis">
    <%= icon_tag "arrow-right" if card.assignees.any? %>
    <%= card.assignees.any? ? "Assigned to" : "Not assigned" %>
    <%= card.assignees.map { |assignee| "<strong>#{h assignee.familiar_name}</strong>" }.to_sentence.html_safe %>
  </span>

  <div class="card__meta-avatars card__meta-avatars--assignees">
    <%= yield %>
  </div>
</div>

================
File: app/views/cards/display/common/_stamp.html.erb
================
<% if card.postponed? %>
  <div class="card__closed <%= "card__closed--system" if card.postponed_by&.system? %>">
    <span class="card__closed-title" data-text="Not Now">Not Now</span>
    <strong class="card__closed-date"><%= card.postponed_at.strftime("%b %d, %Y") %></strong>
    <span class="card__closed-by-line">by <span class="card__closed-by"><%= card.postponed_by&.familiar_name %></span></span>
  </div>
<% end %>

<% if card.closed? %>
  <div class="card__closed">
    <span class="card__closed-title" data-text="Done">Done</span>
    <strong class="card__closed-date"><%= card.closed_at.strftime("%b %d, %Y") %></strong>
    <span class="card__closed-by-line">by <span class="card__closed-by"><%= card.closed_by.familiar_name %></span></span>
  </div>
<% end %>

================
File: app/views/cards/display/mini/_assignees.html.erb
================
<%= turbo_frame_tag card, :assignees do %>
  <% card.assignees.each do |assignee| %>
    <%= avatar_tag assignee %>
  <% end %>
<% end %>

================
File: app/views/cards/display/mini/_meta.html.erb
================
<%= render "cards/display/common/meta", card: card do %>
  <%= render "cards/display/mini/assignees", card: card %>
<% end %>

================
File: app/views/cards/display/mini/_tags.html.erb
================
<%= render "cards/display/preview/tags", card: card %>

================
File: app/views/cards/display/perma/_assignees.html.erb
================
<%= render "cards/display/common/assignees", card: card do %>
  <%= turbo_frame_tag card, :assignment, src: new_card_assignment_path(card), loading: :lazy, refresh: "morph" %>
<% end %>

================
File: app/views/cards/display/perma/_background.html.erb
================
<%= render "cards/display/common/background", card: card do %>
  <%= link_to card.image.presence, class: "card__zoom-bg-btn btn", data: { controller: "tooltip", lightbox_target: "image" } do %>
    <%= icon_tag "picture-zoom" %>
    <span class="for-screen-reader">Zoom background image</span>
  <% end %>
<% end %>

================
File: app/views/cards/display/perma/_board.html.erb
================
<div class="card__board" data-controller="dialog" data-action="keydown.esc->dialog#close:stop click@document->dialog#closeOnClickOutside mouseenter->dialog#loadLazyFrames">
  <%= render "cards/display/common/board", card: card do %>
    <%= icon_tag "caret-down", class: "txt-xx-small", hidden: card.closed? %>
  <% end %>
  <button class="card__board-picker-button btn btn--plain" data-action="click->dialog#open:stop" aria-label="Choose a board for this card" <%= "hidden" if card.closed? %>></button>
  <dialog class="popup popup--align-right panel flex-column align-start gap-half fill-white shadow" data-dialog-target="dialog" data-action="turbo:before-morph-attribute->dialog#preventCloseOnMorphing turbo:submit-end->dialog#close">
    <%= turbo_frame_tag "board_picker", src: edit_card_board_path(card), target: "_top", loading: :lazy, refresh: "morph" %>
  </dialog>
</div>

================
File: app/views/cards/display/perma/_meta.html.erb
================
<%= render "cards/display/common/meta", card: card do %>
  <%= render "cards/display/perma/assignees", card: card %>
<% end %>

================
File: app/views/cards/display/perma/_steps.html.erb
================
<ol class="steps txt-small margin-block-start-auto">
  <%= render partial: "cards/steps/step", collection: card.steps, as: :step %>

  <% unless card.closed? %>
    <li id="<%= dom_id(card, :new_step) %>" class="step">
      <input type="checkbox" class="step__checkbox" disabled>
      <%= form_with model: [card, Step.new], url: card_steps_path(card), class: "min-width", data: { controller: "form", action: "submit->form#preventEmptySubmit submit->form#preventComposingSubmit turbo:submit-end->form#reset" } do |form| %>
        <%= form.text_field :content, class: "input step__content hide-focus-ring", placeholder: "Add a step", autocomplete: "off", data: { form_target: "input", "1p-ignore": "true", action: "compositionstart->form#compositionStart compositionend->form#compositionEnd" }, aria: { label: "Add a step" } %>
      <% end %>
    </li>
  <% end %>
</ol>

================
File: app/views/cards/display/perma/_tags.html.erb
================
<div id="<%= dom_id(card, :tags) %>" class="card__tags">
  <div data-controller="dialog"
        data-action="keydown.esc->dialog#close click@document->dialog#closeOnClickOutside mouseenter->dialog#loadLazyFrames" <%= "hidden" if card.closed? %>>
    <button class="card__tag-picker-button btn card__hide-on-index" style="--btn-background: var(--card-bg-color);"
        data-controller="tooltip hotkey" data-action="click->dialog#open:stop keydown.t@document->hotkey#click">
      <%= icon_tag "tag" %>
      <span class="for-screen-reader">Add a tag</span>
    </button>

    <dialog class="popup panel flex-column align-start justify-start fill-white shadow txt-small"
        data-dialog-target="dialog"
        data-action="turbo:before-morph-attribute->dialog#preventCloseOnMorphing turbo:submit-end->dialog#close">
      <%= turbo_frame_tag card, :tagging, src: new_card_tagging_path(card), loading: :lazy, refresh: :morph %>
    </dialog>
  </div>

  <% if card.tags.any? %>
    <div class="min-width overflow-ellipsis">
      <% card.tags.each_with_index do |tag, index| %>
        <%= link_to cards_path(board_ids: [ card.board ], tag_ids: [ tag.id ]),
              class: "card__tag btn btn--plain min-width txt-uppercase fill-transparent" do %>
          <%= tag.title %>
        <% end %><%= "," unless index == card.tags.size - 1 %>
      <% end %>
    </div>
  <% end %>
</div>

================
File: app/views/cards/display/preview/_assignees.html.erb
================
<%= render "cards/display/common/assignees", card: card, preview: true %>

================
File: app/views/cards/display/preview/_board.html.erb
================
<div class="card__board">
  <%= render "cards/display/common/board", card: card  %>
</div>

================
File: app/views/cards/display/preview/_boosts.html.erb
================
<% boosts = card.reactions %>
<% if boosts.any? %>
  <div class="card__boosts">
    <%= image_tag "boost-color.svg", aria: { hidden: true } %>
    <span><%= boosts.size %></span>
  </div>
<% end %>

================
File: app/views/cards/display/preview/_bubble.html.erb
================
<%= tag.div \
      id: dom_id(card, "bubble"),
      hidden: true,
      class: "bubble",
      data: {
        controller: "bubble",
        action: "turbo:morph-element->bubble#update:self",
        bubble_entropy_value: entropy_bubble_options_for(card).to_json,
        bubble_stalled_value: stalled_bubble_options_for(card)&.to_json
      } do %>

  <svg viewBox="0 0 200 100">
    <path id="<%= dom_id(card, "bubble-top-half") %>" fill="transparent" d="M 20,100 A 80,80 0 0,1 180,100"/>
    <text text-anchor="middle" fill="currentColor">
      <textPath href="#<%= dom_id(card, "bubble-top-half") %>" startOffset="50%" dominant-baseline="middle" data-bubble-target="top"></textPath>
    </text>
  </svg>

  <span class="bubble__number" data-bubble-target="center"></span>

  <svg viewBox="0 0 200 100">
    <path id="<%= dom_id(card, "bubble-bottom-half") %>" d="M 20,0 A 80,80 0 0,0 180,0" fill="transparent"/>
    <text text-anchor="middle" fill="currentColor">
      <textPath href="#<%= dom_id(card, "bubble-bottom-half") %>" startOffset="50%" dominant-baseline="middle" data-bubble-target="bottom"></textPath>
    </text>
  </svg>
<% end %>

================
File: app/views/cards/display/preview/_columns.html.erb
================
<div class="card__stages">
    <% card.board.columns.each do |column| %>
      <%= tag.span column.name, class: ["card__column-name btn overflow-ellipsis", { "card__column-name--current": column == card.column }] %>
    <% end %>
  </div>

================
File: app/views/cards/display/preview/_comments.html.erb
================
<% comments = card.comments.by_user %>
<% if comments.any? %>
  <div class="card__comments">
    <%= icon_tag "comment" %>
    <span><%= comments.count %></span>
  </div>
<% end %>

================
File: app/views/cards/display/preview/_meta.html.erb
================
<div class="card__meta" id="<%= dom_id(card, :meta) %>">
  <div class="card__meta-avatars card__meta-avatars--author">
    <%= avatar_tag card.creator, tabindex: (local_assigns.key?(:preview) && local_assigns[:preview]) ? -1 : 0 %>
  </div>

  <span class="card__meta-text card__meta-text--added">
    <%= card_drafted_or_added(card) %> <%= local_datetime_tag(card.created_at, style: :daysago) %>
  </span>

  <span class="card__meta-text card__meta-text--author">
    <%= card.creator.familiar_name %>
  </span>

  <span class="card__meta-text card__meta-text--updated overflow-ellipsis">
    <%= icon_tag "refresh--meta", aria: { label: "Last updated" } %>
    <%= local_datetime_tag(card.last_active_at, style: :daysago) %>
  </span>

  <span class="card__meta-text card__meta-text--assignees overflow-ellipsis">
    <%= icon_tag("arrow-right", aria: { label: "Assigned to" }) if card.assignees.any? %>
    <%= card.assignees.map { |assignee| h assignee.familiar_name }.to_sentence(two_words_connector: " / ", last_word_connector: " / ").html_safe %>
  </span>

  <div class="card__meta-avatars card__meta-avatars--assignees">
    <%= render "cards/display/preview/assignees", card: card %>
  </div>
</div>

================
File: app/views/cards/display/preview/_people.html.erb
================
<%= render "cards/display/common/people", card: card do%>
  <%= render "cards/display/preview/assignees", card: card, preview: true %>
<% end %>

================
File: app/views/cards/display/preview/_steps.html.erb
================
<% if card.steps.any? %>
  <div class="card__steps align-center gap-half flex-item-justify-end flex-item-no-shrink">
    <span class="steps__icon">
      <%= icon_tag "check" %>
    </span>
    <strong><%= "#{card.steps.completed.count}/#{card.steps.count}" %></strong>
  </div>
<% end %>

================
File: app/views/cards/display/preview/_tags.html.erb
================
<% if card.tags.any?  %>
  <div class="card__tags">
    <%= icon_tag "tag-outline", class: "translucent" %>
    <div class="min-width overflow-ellipsis">
      <% card.tags.each_with_index do |tag, index| %>
        <span class="card__tag btn btn--plain overflow-ellipsis">
          <%= tag.title %><%= "," unless index == card.tags.size - 1 %>
        </span>
      <% end %>
    </div>
  </div>
<% end %>

================
File: app/views/cards/display/public_preview/_columns.html.erb
================
<div id="<%= dom_id(card, :columns) %>" class="card__stages">
  <% card.board.columns.each do |column| %>
    <%= tag.div column.name,
          class: ["card__column-name overflow-ellipsis flex align-center gap-half btn non-clickable no-hover", { "card__column-name--current": column == card.column }] %>
  <% end %>
</div>

================
File: app/views/cards/display/public_preview/_meta.html.erb
================
<div class="card__meta" id="<%= dom_id(card, :meta) %>">
  <div class="card__meta-avatars card__meta-avatars--author">
    <%= avatar_preview_tag card.creator %>
  </div>

  <span class="card__meta-text card__meta-text--added">
    <%= card_drafted_or_added(card) %> <%= local_datetime_tag(card.created_at, style: :daysago) %>
  </span>

  <span class="card__meta-text card__meta-text--author">
    By <strong><%= card.creator.familiar_name %></strong>
  </span>

  <span class="card__meta-text card__meta-text--updated overflow-ellipsis">
    Updated
    <%= local_datetime_tag(card.last_active_at, style: :daysago) %>
  </span>

  <span class="card__meta-text card__meta-text--assignees overflow-ellipsis">
    <%= "Assigned to" if card.assignees.any? %>
    <%= card.assignees.map { |assignee| "<strong>#{h assignee.familiar_name}</strong>" }.to_sentence.html_safe %>
  </span>

  <div class="card__meta-avatars card__meta-avatars--assignees" id="<%= dom_id(card, :assignees) %>">
    <% card.assignees.each do |assignee| %>
      <%= avatar_preview_tag assignee %>
    <% end %>
  </div>
</div>

================
File: app/views/cards/display/_preview.html.erb
================
<% draggable = local_assigns.fetch(:draggable, false) && card.published? %>

<% card_data = {
  id: card.number,
  drag_and_drop_target: "item",
  navigable_list_target: "item",
  css_variable_counter_target: "item"
} %>

<% if card.open? %>
  <% card_data[:card_not_now_url] = card_not_now_path(card) %>
  <% card_data[:card_closure_url] = card_closure_path(card) %>
  <% card_data[:action] = "mouseenter->navigable-list#hoverSelect" %>
  <% card_data[:card_assign_to_self_url] = card_self_assignment_path(card) %>
<% end %>

<%= card_article_tag card, class: "card", draggable: draggable, data: card_data, tabindex: 0 do %>
  <div class="flex flex-column flex-item-grow max-inline-size">
    <%= link_to card_path(card), draggable: false, class: "card__link", title: card_title_tag(card), data: { action: "dialog#close", turbo_frame: "_top" } do %>
      <span class="for-screen-reader"><%= card.title %></span>
    <% end %>

    <header class="card__header">
      <%= render "cards/display/preview/board", card: card %>
      <%= render "cards/display/preview/tags", card: card %>
      <%= render "cards/display/preview/steps", card: card %>
      <%= icon_tag "attachment", class: "card__attachments-indicator translucent" if card.has_attachments? %>

      <% if card.triaged? %>
        <span class="btn justify-start card__column-name card__column-name--current txt-uppercase min-width max-width">
          <span class="overflow-ellipsis "><%= card.column.name %></span>
        </span>
      <% end %>
    </header>

    <div class="card__body justify-space-between">
      <div class="card__content">
        <h3 class="card__title overflow-line-clamp">
          <%= card.title %>
        </h3>
      </div>

      <%= render "cards/display/preview/columns", card: card %>
      <%= render "cards/display/common/stamp", card: card %>
    </div>
  </div>

  <footer class="card__footer flex gap-half">
    <%= render "cards/display/preview/meta", card: card, preview: true %>
    <div class="card__counts">
      <%= render "cards/display/preview/boosts", card: card %>
      <%= render "cards/display/preview/comments", card: card %>
    </div>
    <%= render "cards/display/common/background", card: card %>
  </footer>

  <% if card.entropic? %>
    <%= render "cards/display/preview/bubble", card: card %>
  <% end %>
<% end %>

================
File: app/views/cards/display/_previews.html.erb
================
<%= render partial: "cards/display/preview", collection: cards, as: :card, locals: { draggable: local_assigns.fetch(:draggable, false) }, cached: true %>

================
File: app/views/cards/display/_public_preview.html.erb
================
<%= card_article_tag card, class: "card" do %>
  <div class="flex flex-column flex-item-grow max-inline-size">
    <header class="card__header">
      <div class="card__board flex align-start">
          <span class="card__id">
            <span class="for-screen-reader">Card number</span>
            <%= card.number %>
          </span>
        <span class="card__board-name">
            <span class="overflow-ellipsis"><%= card.board.name %></span>
          </span>
      </div>

      <%= render "cards/display/preview/tags", card: card %>
    </header>

    <div class="card__body justify-space-between">
      <div class="card__content">
        <h1 class="card__title overflow-line-clamp">
          <%= card.title %>
        </h1>
      </div>

      <%= render "cards/display/public_preview/columns", card: card if card.triaged? %>
      <%= render "cards/display/common/stamp", card: card %>
    </div>
  </div>

  <footer class="card__footer">
    <%= render "cards/display/public_preview/meta", card: card %>
  </footer>

  <%= render "cards/display/common/background", card: card %>

  <%= link_to published_card_path(card), class: "card__link", title: card_title_tag(card), data: { turbo_frame: "_top" } do %>
    <span class="for-screen-reader"><%= card.title %></span>
  <% end %>

  <% if card.entropic? %>
    <%= render "cards/display/preview/bubble", card: card %>
    <span class="card__board-name"></span>
  <% end %>
<% end %>

================
File: app/views/cards/display/_public_previews.html.erb
================
<%= render partial: "cards/display/public_preview", collection: cards, as: :card, cached: true %>

================
File: app/views/cards/drafts/_container.html.erb
================
<section id="<%= dom_id(card, :card_container) %>" class="card-perma" style="--card-color: <%= card.color %>;">
  <% cache card do %>
    <div class="card-perma__actions card-perma__actions--left">
      <%= render "cards/container/image", card: card %>
    </div>

    <div class="card-perma__bg">
      <%= card_article_tag card, class: "card" do %>
        <header class="card__header">
          <%= render "cards/display/perma/board", card: card %>
          <%= render "cards/display/perma/tags", card: card %>
        </header>

        <div class="card__body justify-space-between">
          <div class="card__content">
            <%= render "cards/container/content", card: card %>
            <%= render "cards/display/perma/steps", card: card %>
          </div>
        </div>

        <footer class="card__footer">
          <%= render "cards/display/perma/meta", card: card %>
          <%= render "cards/display/perma/background", card: card %>
        </footer>
      <% end %>
    </div>
  <% end %>

  <% if Fizzy.saas? %>
    <%= render "cards/container/footer/saas/create", card: card %>
  <% else %>
    <%= render "cards/container/footer/create", card: card %>
  <% end %>
</section>

================
File: app/views/cards/drafts/show.html.erb
================
<% @page_title = @card.title %>
<% @header_class = "header--card" %>

<% content_for :header do %>
  <div class="header__actions header__actions--start">
    <%= link_back_to_board(@card.board) %>
  </div>
<% end %>

<div data-controller="beacon lightbox" data-beacon-url-value="<%= card_reading_path(@card) %>">
  <%= render "cards/drafts/container", card: @card %>

  <%= render "layouts/lightbox" do %>
    <%= button_to_remove_card_image(@card) if @card.image.attached? %>
  <% end %>
</div>

================
File: app/views/cards/not_nows/create.turbo_stream.erb
================
<%= turbo_stream.replace("not-now", partial: "boards/show/not_now", method: :morph, locals: { board: @card.board }) %>

<% if @source_column %>
  <%= turbo_stream.replace(dom_id(@source_column), partial: "boards/show/column", method: :morph, locals: { column: @source_column }) %>
<% elsif @was_in_stream %>
  <%= turbo_stream.replace("the-stream", partial: "boards/show/stream", method: :morph, locals: { board: @card.board, page: @page }) %>
<% end %>

<%= turbo_stream.replace([ @card, :card_container ], partial: "cards/container", method: :morph, locals: { card: @card.reload }) %>

================
File: app/views/cards/pins/_pin_button.html.erb
================
<div id="<%= dom_id(card, :pin_button) %>">
  <% if card.pinned_by? Current.user %>
    <%= button_to card_pin_path(card), method: :delete, class: "btn btn--reversed btn--circle-mobile",
          data: { controller: "tooltip hotkey", action: "keydown.shift+p@document->hotkey#click", bridge__overflow_menu_target: "item", bridge_title: "Un-pin this card" } do %>
      <%= icon_tag "pinned" %> <span class="for-screen-reader">Un-pin this card (shift+p)</span>
    <% end %>
  <% else %>
    <%= button_to card_pin_path(card), class: "btn btn--circle-mobile",
          data: { controller: "tooltip hotkey", action: "keydown.shift+p@document->hotkey#click", bridge__overflow_menu_target: "item", bridge_title: "Pin this card" } do %>
      <%= icon_tag "unpinned" %> <span class="for-screen-reader">Pin this card (shift+p)</span>
    <% end %>
  <% end %>
</div>

================
File: app/views/cards/pins/show.html.erb
================
<%= turbo_frame_tag @card, :pin do %>
  <%= render "cards/pins/pin_button", card: @card %>
<% end %>

================
File: app/views/cards/previews/index.turbo_stream.erb
================
<%= turbo_stream.remove "#{params[:target]}-load-page-#{@page.number}" %>

<%= turbo_stream.append params[:target] do %>
  <%= render partial: "cards/display/preview", collection: @page.records, as: :card, cached: true %>

  <% unless @page.last? %>
    <%= cards_next_page_link params[:target], page: @page, filter: @filter, fetch_on_visible: @filter.indexed_by.closed? %>
  <% end %>
<% end %>

================
File: app/views/cards/readings/create.turbo_stream.erb
================
<% @notifications.each do |notification| %>
  <%= turbo_stream.remove notification %>
<% end %>

================
File: app/views/cards/steps/_step.html.erb
================
<%= turbo_frame_tag step do %>
  <li class="step">
    <%= form_with model: [step.card, step], data: { controller: "form" } do |form| %>
      <%= form.check_box :completed, { class: "step__checkbox", data: { action: "change->form#submit" } } %>
    <% end %>
    <%= link_to step.content, edit_card_step_path(step.card, step), class: "step__content" %>
  </li> 
<% end %>

================
File: app/views/cards/steps/_step.json.jbuilder
================
json.cache! step do
  json.(step, :id, :content, :completed)
end

================
File: app/views/cards/steps/create.turbo_stream.erb
================
<%= turbo_stream.before dom_id(@card, :new_step) do %>
  <%= render "cards/steps/step", step: @step %>
<% end %>

================
File: app/views/cards/steps/destroy.turbo_stream.erb
================
<%= turbo_stream.remove @step %>

================
File: app/views/cards/steps/edit.html.erb
================
<%= turbo_frame_tag @step do %>
  <div class="flex align-center gap-half">
    <%= form_with model: [@card, @step], class: "step", data: { controller: "form" } do |form| %>
      <%= form.check_box :completed, { class: "step__checkbox", checked: @step.completed?, disabled: true } %>
      <%= form.text_field :content, class: "input step__content step__content--edit hide-focus-ring", placeholder: "Name this step", required: true, autofocus: true, autocomplete: "off",
          data: { action: "keydown.esc->form#cancel focus->form#select", "1p-ignore": "true" } %>
      <%= form.button type: "submit", class: "btn btn--positive txt-xx-small" do %>
        <%= icon_tag "check" %>
        <span class="for-screen-reader">Save changes</span>
      <% end %>
      <%= link_to "Cancel changes", card_step_path(@card, @step), data: { form_target: "cancel" }, hidden: true %>
    <% end %>
    <%= button_to card_step_path(@card, @step), method: :delete, class: "btn btn--negative txt-xx-small" do %>
      <%= icon_tag "trash" %>
      <span class="for-screen-reader">Delete this step</span>
    <% end %>
  </div>
<% end %>

================
File: app/views/cards/steps/show.html.erb
================
<%= turbo_frame_tag @step do %>
  <%= render "cards/steps/step", step: @step %>
<% end %>

================
File: app/views/cards/steps/show.json.jbuilder
================
json.partial! "cards/steps/step", step: @step

================
File: app/views/cards/steps/update.turbo_stream.erb
================
<%= turbo_stream.replace @step do %>
  <%= render "cards/steps/step", step: @step %>
<% end %>

<%= turbo_stream.replace dom_id(@card, "bubble") do %>
  <%= render "cards/display/preview/bubble", card: @card %>
<% end %>

================
File: app/views/cards/taggings/_tag.html.erb
================
<li class="popup__item" data-filter-target="item" data-navigable-list-target="item" aria-checked="<%= card.tagged_with?(tag) %>">
  <%= button_to card_taggings_path(card, params: { tag_title: tag.title }), method: :post,
      class: "popup__btn btn",
      form_class: "max-width flex-item-grow" do %>
    <span class="overflow-ellipsis flex-item-grow"><%= tag.hashtag %></span>
    <%= icon_tag "check", size: 18, class: "checked flex-item-no-shrink flex-item-justify-end", style: "--icon-size: 1em" %>
  <% end %>
</li>

================
File: app/views/cards/taggings/create.turbo_stream.erb
================
<%= turbo_stream.replace([ @card, :tags ], partial: "cards/display/perma/tags", method: "morph", locals: { card: @card.reload }) %>

================
File: app/views/cards/taggings/new.html.erb
================
<%= turbo_frame_tag @card, :tagging do %>
  <div class="flex-column full-width"
    data-controller="form filter navigable-list"
    data-navigable-list-focus-on-selection-value="false"
    data-navigable-list-actionable-items-value="true"
    data-action="keydown->navigable-list#navigate filter:changed->navigable-list#reset dialog:show@document->navigable-list#reset"
  >
    <div class="flex align-start justify-space-between">
      <strong class="popup__title">Tag this</strong><kbd class="txt-xx-small hide-on-touch">t</kbd>
    </div>

    <%= form_with url: card_taggings_path(@card),
          id: dom_id(@card, :tags_form),
          data: { controller: "form", action: "submit->form#preventEmptySubmit submit->form#preventComposingSubmit" },
          class: "flex flex-column gap-half full-width margin-block-half" do |form| %>
      <%= form.text_field :tag_title, placeholder: @tags.any? ? "Add a new tag or filter" : "Name this tag", class: "input txt-small full-width",
            autocomplete: "off", autofocus: true, data: { filter_target: "input", form_target: "input", action: "input->filter#filter compositionstart->form#compositionStart compositionend->form#compositionEnd" } %>
    <% end %>

    <ul class="popup__list" data-filter-target="list">
      <%= render collection: @tagged_with, partial: "tag", locals: { card: @card } %>
      <%= render collection: @tags, partial: "tag", locals: { card: @card } %>

      <li class="popup__item" data-navigable-list-target="item">
        <%= button_tag "Create a new tag", type: "submit", form: dom_id(@card, :tags_form), class: "btn popup__btn", data: { form_target: "submit" } do %>
          <%= icon_tag "add" %>
          <span>Create tag</span>
        <% end %>
      </li>
    </ul>
  </div>
<% end %>

================
File: app/views/cards/triage/_columns.html.erb
================
<%= turbo_frame_tag card, :columns, src: edit_card_column_path(card), target: "_top", refresh: "morph" %>

================
File: app/views/cards/watches/_refresh.turbo_stream.erb
================
<%= turbo_stream.replace dom_id(card, :watch_button) do %>
  <%= render "cards/watches/watch_button", card: card %>
<% end %>

<%= turbo_stream.replace dom_id(card, :comment_watchers) do %>
  <%= render "cards/comments/watchers", card: card %>
<% end %>

================
File: app/views/cards/watches/_watch_button.html.erb
================
<div id="<%= dom_id(card, :watch_button) %>">
  <% if card.watched_by? Current.user %>
    <%= button_to card_watch_path(card), method: :delete, class: "btn btn--reversed btn--circle-mobile",
          data: { controller: "tooltip hotkey", action: "keydown.shift+n@document->hotkey#click", bridge__overflow_menu_target: "item", bridge_title: "Stop watching" } do %>
      <%= icon_tag "bell" %>
      <span class="for-screen-reader">Stop watching (shift+n)</span>
    <% end %>
  <% else %>
    <%= button_to card_watch_path(card), class: "btn btn--circle-mobile",
          data: { controller: "tooltip hotkey", action: "keydown.shift+n@document->hotkey#click", bridge__overflow_menu_target: "item", bridge_title: "Watch this" } do %>
      <%= icon_tag "bell-off" %>
      <span class="for-screen-reader">Watch this (shift+n)</span>
    <% end %>
  <% end %>
</div>

================
File: app/views/cards/watches/create.turbo_stream.erb
================
<%= render "cards/watches/refresh", card: @card %>

================
File: app/views/cards/watches/destroy.turbo_stream.erb
================
<%= render "cards/watches/refresh", card: @card %>

================
File: app/views/cards/watches/show.html.erb
================
<%= turbo_frame_tag @card, :watch do %>
  <%= render "cards/watches/watch_button", card: @card %>
<% end %>

================
File: app/views/cards/_broadcasts.html.erb
================
<% if filter.boards.any? %>
  <% filter.boards.each do |board| %>
    <%= turbo_stream_from board %>
  <% end %>
<% else %>
  <%= turbo_stream_from [ Current.account, :all_boards ] %>
<% end %>

================
File: app/views/cards/_card.json.jbuilder
================
json.cache! card do
  json.(card, :id, :number, :title, :status)
  json.description card.description.to_plain_text
  json.description_html card.description.to_s
  json.image_url card.image.presence && url_for(card.image)

  json.tags card.tags.pluck(:title).sort

  json.closed card.closed?
  json.golden card.golden?
  json.last_active_at card.last_active_at.utc
  json.created_at card.created_at.utc

  json.url card_url(card)

  json.board card.board, partial: "boards/board", as: :board
  json.column card.column, partial: "columns/column", as: :column if card.column
  json.creator card.creator, partial: "users/user", as: :user
  json.assignees card.assignees.limit(5), partial: "users/user", as: :user
  json.has_more_assignees card.assignees.size > 5

  json.comments_url card_comments_url(card)
  json.reactions_url card_reactions_url(card)
end

================
File: app/views/cards/_container.html.erb
================
<section id="<%= dom_id(card, :card_container) %>" class="card-perma" style="--card-color: <%= card.color %>;" data-controller="dialog-manager bridge--form">
  <% cache card do %>
    <div class="card-perma__actions card-perma__actions--left">
      <%= render "cards/container/gild", card: card if card.published? && !card.closed? %>
      <%= render "cards/container/image", card: card %>
    </div>

    <div class="card-perma__bg">
      <%= card_article_tag card, class: "card" do %>
        <header class="card__header">
          <%= render "cards/display/perma/board", card: card %>
          <%= render "cards/display/perma/tags", card: card %>
        </header>

        <div class="card__body justify-space-between">
          <div class="card__content">
            <%= render "cards/container/content", card: card %>
            <%= render "cards/display/perma/steps", card: card %>
          </div>

          <% if card.published? %>
            <%= render "cards/triage/columns", card: card %>
          <% end %>

          <%= render "cards/display/common/stamp", card: card %>
        </div>

        <footer class="card__footer">
          <%= render "cards/display/perma/meta", card: card %>
          <%= render "cards/display/perma/background", card: card %>
          <%= render "reactions/reactions", reactable: card %>
        </footer>
      <% end %>

      <% if card.entropic? %>
        <%= render "cards/display/preview/bubble", card: card %>
      <% end %>
    </div>
  <% end %>

  <% if card.published? %>
    <%= render "cards/container/footer/published", card: card %>
  <% end %>
</section>

================
File: app/views/cards/_delete.html.erb
================
<div data-controller="dialog" data-dialog-modal-value="true" data-action="keydown.esc->dialog#close:stop">
  <button type="button" class="btn txt-negative borderless txt-small" data-action="dialog#open">
    <%= icon_tag "trash" %>
    <span>Delete this card</span>
  </button>
  <dialog class="dialog panel fill-white shadow gap flex-column" style="--panel-size: 40ch" data-dialog-target="dialog">
    <h3 class="txt-large txt-bold">Delete this card?</h3>
    <p class="txt-medium margin-block-half">Are you sure you want to permanently delete this card?</p>
    <div class="flex gap-half justify-center margin-block-start">
      <button type="button" class="btn" data-action="dialog#close">Cancel</button>
      <%= button_to card_path(card), method: :delete, class: "btn txt-negative", data: { turbo_frame: "_top" } do %>
        <span>Delete card</span>
      <% end %>
    </div>
  </dialog>
</div>

================
File: app/views/cards/_messages.html.erb
================
<%= messages_tag(card) do %>
  <% if card.published? %>
    <%= render partial: "cards/comments/comment", collection: card.comments.preloaded.chronologically, cached: true %>
    <%= render "cards/comments/new", card: card %>

    <%= render "cards/comments/watchers", card: card %>
  <% end %>

  <% if Current.user.can_administer_card?(card) %>
    <footer class="delete-card txt-align-center full-width flex flex-column margin-block-start-double">
      <hr class="separator--horizontal full-width margin-block" style="--border-color: var(--color-ink-lighter)">
      <%= render "cards/delete", card: card %>
    </footer>
  <% end %>
<% end %>

================
File: app/views/cards/edit.html.erb
================
<%= turbo_frame_tag @card, :edit do %>
  <%# When entering edit mode, this turbo-stream updates the button area to show
      "Save changes" instead of "Edit". Turbo processes this stream as part of the
      frame response. %>
  <%= turbo_stream.update dom_id(@card, :card_closure_toggle) do %>
    <%= render "cards/container/save_button", card: @card %>
  <% end %>

  <%= form_with model: @card, id: dom_id(@card, :edit_form),
        data: { controller: "autoresize form local-save", local_save_key_value: "card-#{@card.id}", action: "turbo:submit-end->local-save#submit" } do |form| %>
    <h1 class="card__title flex align-start gap-half">
      <%= form.label :title, class: "flex flex-column align-center autoresize__wrapper", data: { autoresize_target: "wrapper", autoresize_clone_value: "" } do %>
        <%= form.text_area :title, class: "card-field__title autoresize__textarea input input--textarea full-width borderless txt-align-start hide-focus-ring hide-scrollbar",
              required: true, autofocus: true, placeholder: "Name it", rows: 1, dir: "auto", maxlength: 255,
              data: { autoresize_target: "textarea", action: "input->autoresize#resize keydown.enter->form#submit:prevent keydown.ctrl+enter->form#submit:prevent keydown.meta+enter->form#submit:prevent keydown.esc->form#cancel focus->form#select" } %>
      <% end %>
    </h1>

    <%= form.rich_textarea :description, class: "card__description rich-text-content",
          placeholder: "Add some notes, context, pictures, or video about this",
          data: { local_save_target: "input", action: "lexxy:change->local-save#save turbo:morph-element->local-save#restoreContent keydown.ctrl+enter->form#submit:prevent keydown.meta+enter->form#submit:prevent keydown.esc->form#cancel:stop" } do %>
      <%= general_prompts(@card.board) %>
    <% end %>

    <%= link_to "Close editor and discard changes", @card,
          data: { form_target: "cancel", bridge__form_target: "cancel", bridge_title: "Cancel" }, hidden: true %>
  <% end %>
<% end %>

================
File: app/views/cards/index.html.erb
================
<% @page_title = @user_filtering.selected_boards_label %>
<% turbo_exempts_page_from_cache %>

<%= render "cards/broadcasts", filter: @filter %>

<% content_for :header do %>
  <h1 class="header__title divider divider--fade full-width" data-bridge--title-target="header">
    <span class="overflow-ellipsis txt-capitalize-first-letter"><%= @user_filtering.selected_boards_label %></span>
  </h1>

  <div class="header__actions header__actions--end">
    <% if board = @filter.single_board %>
      <%= link_to_edit_board board %>
    <% end %>
  </div>
<% end %>

<%= render "filters/settings", filter_url: cards_path, user_filtering: @user_filtering, no_filtering_url: cards_path %>

<%= turbo_frame_tag :cards_container do %>
  <section class="cards cards--grid">
    <div class="cards__list hide-scrollbar">
      <%= with_automatic_pagination :cards_paginated_container, @page do %>
        <%= render "cards/display/previews", cards: @page.records, draggable: true %>
      <% end %>
      <div class="blank-slate">No cards match this filter</div>
    </div>
  </section>
<% end %>

================
File: app/views/cards/index.json.jbuilder
================
json.array! @page.records, partial: "cards/card", as: :card

================
File: app/views/cards/show.html.erb
================
<% @page_title = @card.title %>
<% @header_class = "header--card" %>

<% content_for :head do %>
  <%= card_social_tags(@card) %>
<% end %>

<% content_for :header do %>
  <div class="header__actions header__actions--start">
    <%= link_back_to_board(@card.board) %>
  </div>
<% end %>

<%= turbo_stream_from @card %>
<%= turbo_stream_from @card, :activity %>

<div data-controller="beacon lightbox" data-beacon-url-value="<%= card_reading_path(@card) %>">
  <%= render "cards/container", card: @card %>
  <%= render "cards/messages",  card: @card %>

  <%= render "layouts/lightbox" do %>
    <%= button_to_remove_card_image(@card) if @card.image.attached? %>
  <% end %>
</div>

================
File: app/views/cards/show.json.jbuilder
================
json.partial! "cards/card", card: @card
json.steps @card.steps, partial: "cards/steps/step", as: :step

================
File: app/views/cards/update.turbo_stream.erb
================
<% container_partial = @card.drafted? ? "cards/drafts/container" : "cards/container" %>
<%= turbo_stream.replace dom_id(@card, :card_container), partial: container_partial, method: :morph, locals: { card: @card.reload } %>

<%= turbo_stream.update dom_id(@card, :edit) do %>
  <%= render "cards/container/content_display", card: @card %>
<% end %>

<%= turbo_stream.replace dom_id(@card, :card_closure_toggle) do %>
  <%= render "cards/container/closure", card: @card %>
<% end %>

================
File: app/views/columns/cards/drops/closures/create.turbo_stream.erb
================
<%= turbo_stream.replace("closed-cards", partial: "boards/show/closed", method: :morph, locals:{ board: @card.board }) %>

================
File: app/views/columns/cards/drops/columns/create.turbo_stream.erb
================
<%= turbo_stream.replace(dom_id(@column), partial: "boards/show/column", method: :morph, locals: { column: @column }) %>

================
File: app/views/columns/cards/drops/not_nows/create.turbo_stream.erb
================
<%= turbo_stream.replace("not-now", partial: "boards/show/not_now", method: :morph, locals:{ board: @card.board }) %>

================
File: app/views/columns/cards/drops/streams/create.turbo_stream.erb
================
<%= turbo_stream.replace("maybe", partial: "boards/show/stream", method: :morph, locals:{ board: @card.board, page: @page }) %>

================
File: app/views/columns/left_positions/create.turbo_stream.erb
================
<% if @left_column %>
  <%= turbo_stream.remove(dom_id(@column)) %>
  <%= turbo_stream.before(@left_column, partial: "boards/show/column", locals: { column: @column }) %>
  <%= render "columns/refresh_adjacent_columns", column: @column %>
<% end %>

================
File: app/views/columns/right_positions/create.turbo_stream.erb
================
<% if @right_column %>
  <%= turbo_stream.remove(dom_id(@column)) %>
  <%= turbo_stream.after(@right_column, partial: "boards/show/column", locals: { column: @column }) %>
  <%= render "columns/refresh_adjacent_columns", column: @column %>
<% end %>

================
File: app/views/columns/show/_add_card_button.html.erb
================
<div class="board-tools card">
  <%= button_to board_cards_path(board), method: :post, class: "btn btn--link",
        form: { data: { turbo_frame: "_top" } },
        data: { controller: "hotkey", action: "keydown.c@document->hotkey#click", bridge__buttons_target: "button", bridge_title: "Add card", bridge_icon_url: bridge_icon("add") } do %>
    <%= icon_tag "add", class: "show-on-touch" %>
    <span>Add a card</span>
    <kbd class="hide-on-touch">C</kbd>
  <% end %>

  <footer>
    <%= access_involvement_advance_button(board, Current.user, show_watchers: true) %>
  </footer>
</div>

================
File: app/views/columns/_column.json.jbuilder
================
json.cache! column do
  json.(column, :id, :name, :color)
  json.created_at column.created_at.utc
end

================
File: app/views/columns/_refresh_adjacent_columns.turbo_stream.erb
================
<% column.adjacent_columns.each do |adjacent_column| %>
  <%= turbo_stream.replace(dom_id(adjacent_column), partial: "boards/show/column", method: :morph, locals: { column: adjacent_column }) %>
<% end %>

================
File: app/views/entropy/_auto_close.html.erb
================
<% url = local_assigns[:url] %>
<% disabled = local_assigns[:disabled] %>

<div class="flex align-start gap txt-align-center">
  <div class="flex flex-column flex-1">
    <%= form_with model: model, url: url, data: { controller: "form" } do |form| %>
      <%= render "entropy/knob",
            form: form,
            name: :auto_postpone_period,
            knob_options: entropy_auto_close_options,
            label: "Days until auto-close",
            disabled: disabled  %>
    <% end %>
  </div>
</div>

================
File: app/views/entropy/_knob.html.erb
================
<%
  period = form.object.send(name)
  current_index = knob_options.index(period.to_i / 1.day)
%>

<fieldset class="knob" data-controller="knob" data-knob-target="field" style="--knob-options: <%= knob_options.length %>; --knob-index: <%= current_index %>">
  <div class="position-relative" role="radiogroup" aria-labelledby="<%= dom_id(form.object, name) %>">
    <% knob_options.each_with_index do |value, index| %>
      <label class="knob__option" style="--i: <%= index %>">
        <%= form.radio_button name,
              value.days,
              data: {
                action: "change->knob#optionChanged change->form#submit",
                index: index,
                knob_target: "option"
              },
              disabled: disabled %>
        <span><%= value %></span>
      </label>
    <% end %>

    <%= form.range_field :slider,
          class: "knob__slider",
          data: { action: "input->knob#sliderChanged change->form#submit", knob_target: "slider" },
          "aria-hidden": true,
          max: knob_options.length - 1,
          min: 0,
          disabled: disabled
    %>

    <div class="knob__knob" aria-hidden></div>
  </div>

  <div id="<%= dom_id(form.object, name) %>" class="knob__label">Days</div>
</fieldset>

================
File: app/views/event_summaries/_event_summary.html.erb
================
<% unless event_summary.body.blank? %>
  <div class="comment comment__event flex full-width">
    <div class="comment__content txt-tight-lines full-width" data-controller="event-summary">
      <%= event_summary.body %>
    </div>
  </div>
<% end %>

================
File: app/views/events/day_timeline/columns/_events.html.erb
================
<div class="events--grid">
  <% column.events_by_hour.each do |hour, events| %>
    <% if events.any? %>
      <%= render partial: "events/event", collection: events, cached: true %>
    <% end %>
  <% end %>
</div>

================
File: app/views/events/day_timeline/columns/show.html.erb
================
<% @page_title = @column.base_title %>

<% content_for :header do %>
  <div class="header__actions header__actions--start">
    <%= back_link_to "Activity", root_path, "keydown.left@document->hotkey#click keydown.esc@document->hotkey#click" %>
  </div>

  <h1 class="header__title" data-bridge--title-target="header">
    <%= @column.title %>
  </h1>
<% end %>

<%= render "events/day_timeline/columns/events", column: @column %>

================
File: app/views/events/day_timeline/_column.html.erb
================
<div class="events__column">
  <h3 class="events__column-header">
    <%= column.title %>

    <% if column.events_by_hour.any? %>
      <%= link_to events_day_timeline_column_path(column, day: column.day_timeline.day.to_date), class: "events__maximize-button btn btn--circle txt-x-small borderless", data: { turbo_frame: "_top" } do %>
        <%= icon_tag "grid", class: "translucent" %>
        <span class="for-screen-reader">Expand column</span>
      <% end %>
    <% end %>
  </h3>
  <% column.events_by_hour.each do |hour, events| %>
    <%= events_at_hour_container(column, hour) do %>
      <%= render partial: "events/event", collection: events, cached: true %>
      <%= local_datetime_tag events.first.created_at, class: "event__timestamp txt-small translucent" %>
    <% end %>
  <% end %>

  <% if column.has_more_events? %>
    <div class="events__column-footer fill-highlight txt-x-small border-radius" style="grid-column-start: <%= column.index %>">
      Showing the 100 most recent (<%= column.hidden_events_count %> are hidden)
    </div>
  <% end %>
</div>

================
File: app/views/events/day_timeline/_columns.html.erb
================
<% cache [ day_timeline.events ] do %>
  <%# Template Dependency Updated: _layout.html.erb 2026-01-26 %>
  <% if day_timeline.has_activity? %>
    <div class="events__columns">
      <%= render "events/day_timeline/column", column: day_timeline.added_column %>
      <%= render "events/day_timeline/column", column: day_timeline.updated_column %>
      <%= render "events/day_timeline/column", column: day_timeline.closed_column %>
    </div>
  <% end %>
<% end %>

================
File: app/views/events/days/index.html.erb
================
<%= day_timeline_pagination_frame_tag @day_timeline do %>
  <%= render "events/day", day_timeline: @day_timeline %>
  <%= day_timeline_pagination_link(@day_timeline, @filter) %>
<% end %>

================
File: app/views/events/event/attachments/_attachment.html.erb
================
<% variant = Attachments::VARIANTS[:small] %>
<% width = attachment.metadata["width"] %>
<% height = attachment.metadata["height"] %>

<% if attachment.previewable? %>
  <%= image_tag rails_representation_path(attachment.preview(variant)), class: "attachment attachment--image", width: width, height: height %>
<% elsif attachment.variable? %>
  <%= image_tag rails_representation_path(attachment.variant(variant)), class: "attachment attachment--image", width: width, height: height %>
<% else %>
  <div class="attachment attachment--file attachment--<%= attachment.filename.extension -%>">
    <span class="attachment__icon"><%= attachment.filename.extension&.downcase.presence || "unknown" %></span>
  </div>
<% end %>

================
File: app/views/events/event/attachments/_remote_image.html.erb
================
<%= image_tag remote_image.url, skip_pipeline: true, class: "attachment attachment--image", width: remote_image.width, height: remote_image.height %>

================
File: app/views/events/event/attachments/_remote_video.html.erb
================
<%= tag.video controls: true, class: "attachment attachment--video", width: remote_video.width, height: remote_video.height do %>
  <%= tag.source src: remote_video.url, type: remote_video.content_type %>
<% end %>

================
File: app/views/events/event/eventable/_card_published.html.erb
================
<%= render "events/event/layout", card: event.eventable, event: event do %>
  <span class="txt-break overflow-line-clamp txt-tight-lines">
    <%= format_excerpt(event&.eventable.description, length: 200) -%>
  </span>

  <%= render "events/event/attachments", eventable: event.eventable %>
<% end %>

================
File: app/views/events/event/eventable/_card.html.erb
================
<%= render "events/event/layout", card: event.eventable, event: event %>

================
File: app/views/events/event/eventable/_comment.html.erb
================
<%= render "events/event/layout", card: event.eventable.card, event: event do %>
  <span class="txt-break overflow-line-clamp txt-tight-lines">
    <%= format_excerpt(event&.eventable.body, length: 200) -%>
  </span>

  <%= render "events/event/attachments", eventable: event.eventable %>
<% end %>

================
File: app/views/events/event/_attachments.html.erb
================
<% if eventable&.has_attachments? || eventable&.has_remote_images? || eventable&.has_remote_videos? %>
  <span class="event_attachments margin-block-half flex align-center gap-half">
    <%= render partial: "events/event/attachments/attachment", collection: eventable.attachments %>
    <%= render partial: "events/event/attachments/remote_image", collection: eventable.remote_images %>
    <%= render partial: "events/event/attachments/remote_video", collection: eventable.remote_videos %>
  </span>
<% end %>

================
File: app/views/events/event/_layout.html.erb
================
<%= link_to event.notifiable_target,
      id: dom_id(event, "timelined"),
      class: "event event--#{ event.action } #{ "golden-effect" if event.card.golden? } center-block flex flex-column full-width align-start justify-start position-relative",
      style: "--card-color: #{ card.closed? ? "var(--color-card-complete)" : card.color };",
      target: "_top",
      data: {
        related_element_target: "related",
        related_element_group_value: card.id,
        action: "mouseover->related-element#highlight mouseout->related-element#unhighlight" } do %>
  <div class="card__header">
    <h4 class="card__board">
      <span class="card__id">
        <span class="for-screen-reader">Card number</span>
        <%= card.number %>
      </span>
      <span class="card__board-name">
        <span class="overflow-ellipsis"><%= event.board.name %></span>
      </span>
    </h4>

    <% unless event.action.in?(%w[ card_closed card_published card_reopened ]) %>
      <%= icon_tag event_action_icon(event), class: "event__icon" %>
    <% end %>
  </div>
  <div class="event__content">
    <div class="flex align-start gap">
      <div class="avatar txt-x-small">
        <%= avatar_image_tag(event.creator) %>
      </div>

      <div class="flex flex-column min-width txt-small align-start txt-align-start" style="color: color-mix(in srgb, var(--card-color) 40%, var(--color-ink));">
        <strong class="event__title txt-break overflow-line-clamp txt-tight-lines">
          <%= event.description_for(Current.user).to_html %>
        </strong>

        <%= yield %>
      </div>
    </div>
  </div>

  <% if event.card.image.present? %>
    <div class="card__background">
      <%= image_tag event.card.image.presence || "", size: 120, aria: { hidden: true } %>
    </div>
  <% end %>
<% end %>

================
File: app/views/events/index/filter/_board.html.erb
================
<% filter = user_filtering.filter %>

<%= tag.div class: "flex-inline flex-wrap position-relative quick-filter",
      data: {
        controller: "dialog filter multi-selection-combobox",
        action: "keydown.esc->dialog#close click@document->dialog#closeOnClickOutside turbo:morph@window->multi-selection-combobox#refresh dialog:close@document->filter#clearInput",
        filter_show: user_filtering.show_boards?,
        multi_selection_combobox_no_selection_label_value: user_filtering.selected_boards_label } do %>
  <button type="button" class="btn borderless btn--plain events__filter-select" data-action="click->dialog#toggle:stop">
    <span data-multi-selection-combobox-target="label">
    </span>
  </button>

  <template data-multi-selection-combobox-target="hiddenFieldTemplate">
    <%= hidden_field_tag "board_ids[]", nil, data: { filter_settings_target: "field" } %>
  </template>

  <%= filter_dialog "Board" do %>
    <%= filter_title "Board" %>
    <%= text_field_tag nil, nil, id: nil, placeholder: "Filter", class: "input input--transparent txt-small font-weight-normal", autofocus: true,
          type: "search", autocorrect: "off", autocomplete: "off", data: { "1p-ignore": "true", filter_target: "input", dialog_target: "focusMouse", action: "input->filter#filter" } %>

    <ul class="popup__list" data-filter-target="list" role="listbox">
      <% user_filtering.boards.each do |board| %>
        <%= tag.li class: "popup__item", data: {
              filter_target: "item", navigable_list_target: "item", multi_selection_combobox_target: "item", multi_selection_combobox_value: board.id, multi_selection_combobox_label: board.name },
              role: "checkbox", aria: { checked: filter.boards.include?(board) } do %>
          <button type="button" class="btn popup__btn" data-action="dialog#close multi-selection-combobox#change filter-settings#change form#submit">
            <span class="overflow-ellipsis flex-item-grow"><%= board.name %></span>
            <%= icon_tag "check", class: "checked flex-item-justify-end" %>
          </button>
        <% end %>
      <% end %>
    </ul>
  <% end %>
<% end %>

================
File: app/views/events/index/filter/_user.html.erb
================
<% filter = user_filtering.filter %>

<%= tag.div class: "flex-inline flex-wrap position-relative quick-filter",
      data: {
        controller: "dialog filter multi-selection-combobox",
        action: "keydown.esc->dialog#close click@document->dialog#closeOnClickOutside turbo:morph@window->multi-selection-combobox#refresh dialog:close@document->filter#clearInput",
        filter_show: user_filtering.show_creators?,
        multi_selection_combobox_no_selection_label_value: "everyone" } do %>
  <button type="button" class="btn borderless btn--plain events__filter-select" data-action="click->dialog#toggle:stop">
    <span data-multi-selection-combobox-target="label">
    </span>
  </button>

  <template data-multi-selection-combobox-target="hiddenFieldTemplate">
    <%= hidden_field_tag "creator_ids[]", nil, data: { filter_settings_target: "field" } %>
  </template>

  <%= filter_dialog "Person" do %>
    <%= filter_title "Person" %>
    <%= text_field_tag nil, nil, id: nil, placeholder: "Filter", class: "input input--transparent txt-small font-weight-normal", autofocus: true,
          type: "search", autocorrect: "off", autocomplete: "off", data: { "1p-ignore": "true", filter_target: "input", dialog_target: "focusMouse", action: "input->filter#filter" } %>

    <ul class="popup__list" data-filter-target="list" role="listbox">
      <% user_filtering.users.each do |user| %>
        <%= tag.li class: "popup__item", data: {
              filter_target: "item", navigable_list_target: "item", multi_selection_combobox_target: "item", multi_selection_combobox_value: user.id, multi_selection_combobox_label: user.familiar_name },
              role: "checkbox", aria: { checked: filter.creators.include?(user) } do %>
          <button type="button" class="btn popup__btn" data-action="dialog#close multi-selection-combobox#change form#submit">
            <span class="overflow-ellipsis flex-item-grow"><%= user.name %></span>
            <%= icon_tag "check", class: "checked flex-item-justify-end" %>
          </button>
        <% end %>
      <% end %>
    </ul>
  <% end %>
<% end %>

================
File: app/views/events/index/_add_board_button.html.erb
================
<div class="header__actions header__actions--end">
  <div>
    <%= link_to new_board_path, class: "btn btn--link btn--circle-mobile",
          data: { controller: "hotkey", action: "keydown.b@document->hotkey#click", bridge__buttons_target: "button", bridge_title: "Add a board", bridge_icon_url: bridge_icon("board") } do %>
      <%= icon_tag "board" %>
      <span class="overflow-ellipsis">Add a board</span>
      <kbd class="hide-on-touch">B</kbd>
    <% end %>
  </div>
</div>

================
File: app/views/events/index/_add_card_button.html.erb
================
<div class="header__actions header__actions--start">
  <% if board = user_filtering.single_board_or_first %>
    <%= button_to board_cards_path(board), method: :post, class: "btn btn--link btn--circle-mobile",
          data: { controller: "hotkey", action: "keydown.c@document->hotkey#click", bridge__buttons_target: "button", bridge_title: "Add a card", bridge_icon_url: bridge_icon("add") } do %>
      <%= icon_tag "add" %>
      <span class="overflow-ellipsis">Add a card</span>
      <kbd class="hide-on-touch">C</kbd>
    <% end %>
  <% end %>
</div>

================
File: app/views/events/index/_filter.html.erb
================
<%= form_with url: events_path,
      method: :get, class: "display-inline position-relative",
      data: { controller: "form", turbo_frame: "cards_container", turbo_action: "advance" } do |form| %>

  <% unless user_filtering.boards.one? %>
    <%= render "events/index/filter/board", user_filtering: %>
  <% end %>

  <% unless user_filtering.users.one? %>
    <span>by</span>
    <%= render "events/index/filter/user", user_filtering: %>
  <% end %>
<% end %>

================
File: app/views/events/_day.html.erb
================
<section class="events__day" data-controller="related-element" data-related-element-highlight-class="event--related">
  <%= render "events/day_timeline/columns", day_timeline: day_timeline %>
  <%= render "events/empty_days", day_timeline: day_timeline %>
</section>

================
File: app/views/events/_empty_days.html.erb
================
<% earliest, latest = day_timeline.earliest_time, day_timeline.latest_time %>

<% if earliest.present? %>
  <% if earliest == latest %>
    <div class="events__none">
      <h2 class="txt-medium margin-none"><%= local_datetime_tag earliest, style: :agoorweekday, class: "txt-ink txt-capitalize" %></h2>
      <p class="margin-none">No activity</p>
    </div>
  <% elsif earliest < latest %>
    <div class="events__none">
      <h2 class="txt-medium margin-none"><%= local_datetime_tag earliest, style: :agoorweekday, class: "txt-ink txt-capitalize" %>  <%= local_datetime_tag latest, style: :agoorweekday, class: "txt-ink txt-capitalize" %></h2>
      <p class="margin-none">No activity for <%= (latest - earliest).seconds.in_days.round + 1 %> days</p>
    </div>
  <% end %>
<% else %>
  <div class="events__none">
    <p class="margin-none"> <%= day_timeline.has_activity? ? "No more activity" : "No activity" %></p>
  </div>
<% end %>

================
File: app/views/events/_event.html.erb
================
<% cache event do %>
  <%# Template Dependency Updated: _layout.html.erb 2026-01-26 %>
  <% if lookup_context.exists?("events/event/eventable/_#{event.action}") %>
    <%= render "events/event/eventable/#{event.action}", event: event %>
  <% else %>
    <%= render "events/event/eventable/#{event.eventable_type.demodulize.underscore}", event: event %>
  <% end %>
<% end %>

================
File: app/views/events/index.html.erb
================
<% @page_title = "Home" %>
<% @header_class = "header--events" %>

<%= render "cards/broadcasts", filter: @filter %>

<% content_for :header do %>
  <%= render "events/index/add_card_button", user_filtering: @user_filtering %>

  <h1 class="header__title" data-controller="dialog-manager" data-bridge--title-target="header">
    <% if @user_filtering.boards.many? %>
      <span>Activity <%= @user_filtering.filter.boards.any? ? "in" : "across" %></span>
    <% else %>
      <span>Latest Activity</span>
    <% end %>

    <%= render "events/index/filter", user_filtering: @user_filtering %>
  </h1>

  <%= render "events/index/add_board_button", user_filtering: @user_filtering %>
<% end %>

<%= tag.div id: "activity", class: "events", data: { controller: "pagination", pagination_paginate_on_intersection_value: true } do %>
  <%= day_timeline_pagination_frame_tag @day_timeline do %>
    <%= render "events/day", day_timeline: @day_timeline %>

    <%= day_timeline_pagination_link(@day_timeline, @filter) %>
  <% end %>
<% end %>

================
File: app/views/filters/settings/_assignees.html.erb
================
<% filter = user_filtering.filter %>
<%= tag.div class: "quick-filter",
      data: {
        controller: "dialog filter multi-selection-combobox",
        action: "keydown.esc->dialog#close click@document->dialog#closeOnClickOutside dialog:close@document->filter#clearInput",
        filter_show: user_filtering.show_assignees?,
        multi_selection_combobox_no_selection_label_value: "Assigned to",
        multi_selection_combobox_label_prefix_value: "Assigned to" } do %>
    <button type="button" class="btn input input--select flex-inline txt-x-small" data-action="click->dialog#toggle:stop">
      <span class="overflow-ellipsis" data-multi-selection-combobox-target="label">
      </span>
    </button>

    <template data-multi-selection-combobox-target="hiddenFieldTemplate">
      <%= hidden_field_tag "assignee_ids[]", nil, data: { filter_settings_target: "field" } %>
    </template>

    <%= filter_dialog "Assigned to" do %>
      <%= filter_title "Assigned to" %>
      <% if Current.account.users.active.many? %>
        <%= text_field_tag nil, nil, id: nil, placeholder: "Filter", class: "input input--transparent txt-small", autofocus: true,
              type: "search", autocorrect: "off", autocomplete: "off", data: { "1p-ignore": "true", filter_target: "input", dialog_target: "focusMouse", action: "input->filter#filter" } %>
      <% end %>

      <ul class="popup__list" data-filter-target="list" role="listbox">
        <%= tag.li class: "popup__item", data: {
              filter_target: "item", navigable_list_target: "item", multi_selection_combobox_target: "item", multi_selection_combobox_value: "unassigned",
              multi_selection_combobox_label: "No one", multi_selection_field_name: "assignment_status", multi_selection_exclusive: true },
              role: "checkbox", aria: { checked: filter.assignment_status.unassigned? } do %>
          <button type="button" class="btn popup__btn" data-action="dialog#close multi-selection-combobox#change filter-settings#change form#submit">
            <span class="overflow-ellipsis flex-item-grow">No one</span>
            <%= icon_tag "check", class: "checked flex-item-justify-end" %>
          </button>
        <% end %>

        <% user_filtering.users.each do |user| %>
          <%= tag.li class: "popup__item", data: {
                filter_target: "item", navigable_list_target: "item", multi_selection_combobox_target: "item", multi_selection_combobox_value: user.id, multi_selection_combobox_label: user.familiar_name },
                role: "checkbox", aria: { checked: filter.assignees.include?(user) } do %>
            <button type="button" class="btn popup__btn" data-action="dialog#close multi-selection-combobox#change filter-settings#change form#submit">
              <span class="overflow-ellipsis flex-item-grow"><%= user.name %></span>
              <%= icon_tag "check", class: "checked flex-item-justify-end" %>
            </button>
          <% end %>
        <% end %>
      </ul>
    <% end %>
<% end %>

================
File: app/views/filters/settings/_boards.html.erb
================
<% filter = user_filtering.filter %>

<%= tag.div class: "quick-filter",
      data: {
        controller: "dialog filter multi-selection-combobox",
        action: "keydown.esc->dialog#close click@document->dialog#closeOnClickOutside dialog:close->filter#clearInput",
        filter_show: user_filtering.show_boards?,
        multi_selection_combobox_no_selection_label_value: "Board",
        multi_selection_combobox_label_prefix_value: "" } do %>
    <button type="button" class="btn input input--select flex-inline txt-x-small" data-action="click->dialog#toggle:stop">
      <span class="overflow-ellipsis" data-multi-selection-combobox-target="label">
      </span>
    </button>

    <template data-multi-selection-combobox-target="hiddenFieldTemplate">
      <%= hidden_field_tag "board_ids[]", nil, data: { filter_settings_target: "field" } %>
    </template>

    <%= filter_dialog "Board" do %>
      <%= filter_title "Board" %>
      <% if user_filtering.boards.many? %>
        <%= text_field_tag nil, nil, id: nil, placeholder: "Filter", class: "input input--transparent txt-small", autofocus: true,
              type: "search", autocorrect: "off", autocomplete: "off", data: { "1p-ignore": "true", filter_target: "input", dialog_target: "focusMouse", action: "input->filter#filter" } %>
      <% end %>

      <ul class="popup__list" data-filter-target="list" role="listbox">
        <% user_filtering.boards.each do |board| %>
          <%= tag.li class: "popup__item", data: {
                filter_target: "item", navigable_list_target: "item", multi_selection_combobox_target: "item", multi_selection_combobox_value: board.id, multi_selection_combobox_label: board.name },
                role: "checkbox", aria: { checked: filter.boards.include?(board) } do %>
            <button type="button" class="btn popup__btn" data-action="dialog#close multi-selection-combobox#change filter-settings#change filter-settings#submitToGenericCardsView:stop">
              <span class="overflow-ellipsis flex-item-grow"><%= board.name %></span>
              <%= icon_tag "check", class: "checked flex-item-justify-end" %>
            </button>
          <% end %>
        <% end %>
      </ul>
    <% end %>
<% end %>

================
File: app/views/filters/settings/_cards.html.erb
================
<% if filter.card_ids.present? %>
  <%= filter_chip_tag "Cards #{filter.card_ids.join(", ")}", filter.as_params.without(:card_ids) %>
<% end %>

================
File: app/views/filters/settings/_closers.html.erb
================
<% filter = user_filtering.filter %>

<%= tag.div class: "quick-filter",
      data: {
        controller: "dialog filter multi-selection-combobox",
        action: "keydown.esc->dialog#close click@document->dialog#closeOnClickOutside dialog:close@document->filter#clearInput",
        filter_show: user_filtering.show_closers?,
        multi_selection_combobox_no_selection_label_value: "Closed by",
        multi_selection_combobox_label_prefix_value: "Closed by" } do %>
    <button type="button" class="btn input input--select flex-inline txt-x-small" data-action="click->dialog#toggle:stop">
      <span class="overflow-ellipsis" data-multi-selection-combobox-target="label">
      </span>
    </button>

    <template data-multi-selection-combobox-target="hiddenFieldTemplate">
      <%= hidden_field_tag "closer_ids[]", nil, data: { filter_settings_target: "field" } %>
    </template>

    <%= filter_dialog "Closed by" do %>
      <%= filter_title "Closed by" %>
      <% if user_filtering.users.many? %>
        <%= text_field_tag nil, nil, id: nil, placeholder: "Filter", class: "input input--transparent txt-small", autofocus: true,
              type: "search", autocorrect: "off", autocomplete: "off", data: { "1p-ignore": "true", filter_target: "input", dialog_target: "focusMouse", action: "input->filter#filter" } %>
      <% end %>

      <ul class="popup__list" data-filter-target="list" role="listbox">
        <% user_filtering.users.each do |user| %>
          <%= tag.li class: "popup__item", data: {
                filter_target: "item", navigable_list_target: "item", multi_selection_combobox_target: "item", multi_selection_combobox_value: user.id, multi_selection_combobox_label: user.familiar_name },
                role: "checkbox", aria: { checked: filter.closers.include?(user) } do %>
            <button type="button" class="btn popup__btn" data-action="dialog#close multi-selection-combobox#change filter-settings#change form#submit">
              <span class="overflow-ellipsis flex-item-grow"><%= user.name %></span>
              <%= icon_tag "check", class: "checked flex-item-justify-end" %>
            </button>
          <% end %>
        <% end %>
      </ul>
    <% end %>
<% end %>

================
File: app/views/filters/settings/_controls.html.erb
================
<%= render "filters/settings/boards", user_filtering: user_filtering %>
<%= render "filters/settings/sorted_by", user_filtering: user_filtering %>
<%= render "filters/settings/indexed_by", user_filtering: user_filtering %>
<%= render "filters/settings/tags", user_filtering: user_filtering %>
<%= render "filters/settings/assignees", user_filtering: user_filtering %>
<%= render "filters/settings/creators", user_filtering: user_filtering %>
<%= render "filters/settings/closers", user_filtering: user_filtering %>

================
File: app/views/filters/settings/_creators.html.erb
================
<% filter = user_filtering.filter %>

<%= tag.div class: "quick-filter",
      data: {
        controller: "dialog filter multi-selection-combobox",
        action: "keydown.esc->dialog#close click@document->dialog#closeOnClickOutside dialog:close@document->filter#clearInput",
        filter_show: user_filtering.show_creators?,
        multi_selection_combobox_no_selection_label_value: "Added by",
        multi_selection_combobox_label_prefix_value: "Added by" } do %>
    <button type="button" class="btn input input--select flex-inline txt-x-small" data-action="click->dialog#toggle:stop">
      <span class="overflow-ellipsis" data-multi-selection-combobox-target="label">
      </span>
    </button>

    <template data-multi-selection-combobox-target="hiddenFieldTemplate">
      <%= hidden_field_tag "creator_ids[]", nil, data: { filter_settings_target: "field" } %>
    </template>

    <%= filter_dialog "Added by" do %>
      <%= filter_title "Added by" %>
      <% if user_filtering.users.many? %>
        <%= text_field_tag nil, nil, id: nil, placeholder: "Filter", class: "input input--transparent txt-small", autofocus: true,
              type: "search", autocorrect: "off", autocomplete: "off", data: { "1p-ignore": "true", filter_target: "input", dialog_target: "focusMouse", action: "input->filter#filter" } %>
      <% end %>

      <ul class="popup__list" data-filter-target="list" role="listbox">
        <% user_filtering.users.each do |user| %>
          <%= tag.li class: "popup__item", data: {
                filter_target: "item", navigable_list_target: "item", multi_selection_combobox_target: "item", multi_selection_combobox_value: user.id, multi_selection_combobox_label: user.familiar_name },
                role: "checkbox", aria: { checked: filter.creators.include?(user) } do %>
            <button type="button" class="btn popup__btn" data-action="dialog#close multi-selection-combobox#change filter-settings#change form#submit">
              <span class="overflow-ellipsis flex-item-grow"><%= user.name %></span>
              <%= icon_tag "check", class: "checked flex-item-justify-end" %>
            </button>
          <% end %>
        <% end %>
      </ul>
    <% end %>
<% end %>

================
File: app/views/filters/settings/_indexed_by.html.erb
================
<% filter = user_filtering.filter %>

<%= tag.div class: class_names("quick-filter"),
      data: { controller: "dialog filter combobox",
            action: "keydown.esc->dialog#close click@document->dialog#closeOnClickOutside dialog:close@document->filter#clearInput",
            filter_show: user_filtering.show_indexed_by?,
            combobox_default_value_value: "all",
            combobox_default_label_value: "Status",
            combobox_with_default_class: "quick-filter--with-default" } do %>
    <button type="button" class="btn input input--select flex-inline txt-x-small" data-action="click->dialog#toggle:stop">
      <span class="overflow-ellipsis" data-combobox-target="label">
      </span>
    </button>

    <template data-combobox-target="hiddenFieldTemplate">
      <%= hidden_field_tag :indexed_by, nil, data: { filter_settings_target: "field" } %>
    </template>

    <%= filter_dialog "Filter by" do %>
      <strong class="popup__title">Filter by status</strong>

      <ul class="popup__list" data-filter-target="list" role="listbox">
        <% Filter::INDEXES.each do |index| %>
          <% label = Filter.indexed_by_human_name(index) %>
          <%= tag.li class: "popup__item", data: { navigable_list_target: "item", combobox_target: "item", combobox_value: index, combobox_label: label }, role: "checkbox", aria: { checked: filter.indexed_by == index } do %>
            <button type="button" class="btn popup__btn" data-action="dialog#close combobox#change filter-settings#change form#submit">
              <span class="overflow-ellipsis flex-item-grow"><%= label %></span>
              <%= icon_tag "check", class: "checked flex-item-justify-end" %>
            </button>
          <% end %>
        <% end %>
      </ul>
    <% end %>
<% end %>

================
File: app/views/filters/settings/_manage.html.erb
================
<% filter = user_filtering.filter %>
<% clear_url = filter.single_board ? board_path(filter.single_board) : no_filtering_url %>

<div class="filters__manage gap-half">
  <%= link_to clear_url, class: "btn btn--remove txt-x-small", data: { controller: "hotkey tooltip", action: "keydown.esc@document->hotkey#click"} do %>
    <%= icon_tag "close" %>
    <span class="for-screen-reader">Clear all</span>
  <% end %>
</div>

================
File: app/views/filters/settings/_sorted_by.html.erb
================
<% filter = user_filtering.filter %>

<%= tag.div class: class_names("quick-filter"),
      data: {
        controller: "dialog filter combobox",
        action: "keydown.esc->dialog#close click@document->dialog#closeOnClickOutside dialog:close@document->filter#clearInput",
        filter_show: user_filtering.show_sorted_by?,
        combobox_default_value_value: "latest",
        combobox_with_default_class: "quick-filter--with-default" } do %>
    <button type="button" class="btn input input--select flex-inline txt-x-small" data-action="click->dialog#toggle:stop">
      <span class="overflow-ellipsis" data-combobox-target="label">
      </span>
    </button>

    <template data-combobox-target="hiddenFieldTemplate">
      <%= hidden_field_tag :sorted_by, nil, data: { filter_settings_target: "field" } %>
    </template>

    <%= filter_dialog "Sort by" do %>
      <strong class="popup__title">Sort by</strong>

      <ul class="popup__list" data-filter-target="list" role="listbox">
        <% Filter::SORTED_BY.each do |sort| %>
          <%= tag.li class: "popup__item", data: {
                navigable_list_target: "item", combobox_target: "item", combobox_value: sort, combobox_label: sorted_by_label(sort) },
                role: "checkbox", aria: { checked: filter.sorted_by == sort } do %>
            <button type="button" class="btn popup__btn" data-action="dialog#close combobox#change filter-settings#change form#submit">
              <span class="overflow-ellipsis flex-item-grow"><%= sorted_by_label(sort) %></span>
              <%= icon_tag "check", class: "checked flex-item-justify-end" %>
            </button>
          <% end %>
        <% end %>
      </ul>
    <% end %>
<% end %>

================
File: app/views/filters/settings/_tags.html.erb
================
<% filter = user_filtering.filter %>

<%= tag.div class: "quick-filter",
      data: {
        controller: "dialog filter multi-selection-combobox",
        action: "keydown.esc->dialog#close click@document->dialog#closeOnClickOutside dialog:close@document->filter#clearInput",
        filter_show: user_filtering.show_tags?,
        multi_selection_combobox_no_selection_label_value: "Tagged" } do %>
  <button type="button" class="btn input input--select flex-inline txt-x-small" data-action="click->dialog#toggle:stop">
    <span class="overflow-ellipsis" data-multi-selection-combobox-target="label"></span>
  </button>

  <template data-multi-selection-combobox-target="hiddenFieldTemplate">
    <%= hidden_field_tag "tag_ids[]", nil, data: { filter_settings_target: "field" } %>
  </template>

  <%= filter_dialog "Tagged" do %>
    <%= filter_title "Tagged" %>
    <% if user_filtering.tags.many? %>
      <%= text_field_tag nil, nil, id: nil, placeholder: "Filter", class: "input input--transparent txt-small", autofocus: true,
            type: "search", autocorrect: "off", autocomplete: "off", data: { "1p-ignore": "true", filter_target: "input", dialog_target: "focusMouse", action: "input->filter#filter" } %>
    <% end %>

    <ul class="popup__list" data-filter-target="list" role="listbox">
      <% user_filtering.tags.each do |tag| %>
        <%= content_tag(:li, class: "popup__item", data: {
              filter_target: "item", navigable_list_target: "item", multi_selection_combobox_target: "item", multi_selection_combobox_value: tag.id, multi_selection_combobox_label: tag.hashtag },
              role: "checkbox", aria: { checked: filter.tags.include?(tag) }) do %>
          <button type="button" class="btn popup__btn" data-action="dialog#close multi-selection-combobox#change filter-settings#change form#submit">
            <span class="overflow-ellipsis flex-item-grow"><%= tag.hashtag %></span>
            <%= icon_tag "check", class: "checked flex-item-justify-end" %>
          </button>
        <% end %>
      <% end %>
    </ul>
  <% end %>
<% end %>

================
File: app/views/filters/settings/_terms.html.erb
================
<%= form.search_field "terms[]", placeholder: "Filter these cards [F]", class: "filter__terms input txt-x-small",
      autofocus: false, autocomplete: :off, autocorrect: "off", data: {
            "1p-ignore": "true",
            controller: "hotkey touch-placeholder",
            filter_settings_target: "field",
            touch_placeholder_placeholder_value: "Filter these cards",
            action: "keydown.f@document->hotkey#focus input->filter-settings#resetIfNoFiltering input->form#debouncedSubmit keydown.enter->form#submitToTopTarget blur->form#submitToTopTarget" } %>

<% if filter.terms.present? %>
  <% filter.terms.each do |term| %>
    <%= filter_chip_tag %Q("#{term}"), filter.as_params_without(:terms, term) %>
    <%= hidden_field_tag "terms[]", term, data: { filter_settings_target: "field" } %>
  <% end %>

  <%= yield form if block_given? %>
<% end %>

================
File: app/views/filters/settings/_time_window.html.erb
================
<% filter = user_filtering.filter %>
<%= tag.div class: "quick-filter",
      data: { controller: "dialog", action: "keydown.esc->dialog#close click@document->dialog#closeOnClickOutside", filter_show: filter.public_send("#{name}_window").present? } do %>
    <button class="btn input input--select flex-inline txt-x-small" data-action="click->dialog#open:stop">
      <span class="overflow-ellipsis">
        <%= "#{label} #{TimeWindowParser.human_name_for(filter.public_send(name))&.downcase}" %>
      </span>
    </button>

    <dialog class="events__popup popup panel flex-column align-start gap-half fill-white shadow"
      aria-label="Created" aria-description="Created"
      data-dialog-target="dialog" data-action="turbo:before-cache@document->dialog#close">
      <strong class="popup__title margin-block-start-half pad-inline-half"><%= label %></strong>
      <%= form_with url: cards_path, method: :get, class: "popup__list",
            data: { controller: "form" } do |form| %>
        <% filter.as_params.except(name).each do |key, value| %>
          <%= filter_hidden_field_tag key, value %>
        <% end %>

        <% TimeWindowParser::VALUES.each do |value| %>
          <div class="popup__btn btn">
            <%= form.radio_button name, value,
                  checked: filter.public_send(name) == value,
                  data: { action: "change->form#submit" } %>

            <%= form.label name, TimeWindowParser.human_name_for(value), value: value, class: "overflow-ellipsis" %>
            <%= icon_tag "check", class: "checked flex-item-justify-end" %>
          </div>
        <% end %>
      <% end %>
    </dialog>
<% end %>

================
File: app/views/filters/settings/_toggle.html.erb
================
<% filter = user_filtering.filter %>

<% if user_filtering.expanded? %>
  <button type="button" class="btn txt-x-small btn--reversed" aria-selected="true" data-action="toggle-class#toggle toggle-enable#toggle" data-controller="tooltip">
    <%= icon_tag "filter" %>
    <span class="for-screen-reader">Close filter options</span>
  </button>
<% else %>
  <button type="button" class="btn txt-x-small filter-toggle" data-action="toggle-class#toggle toggle-enable#toggle" data-controller="tooltip">
    <%= icon_tag "filter" %>
    <span class="filters__show-when-expanded for-screen-reader">Collapse filter options</span>
    <span class="filters__show-when-collapsed for-screen-reader">Expand filter options</span>
  </button>
<% end %>

================
File: app/views/filters/settings_refreshes/create.turbo_stream.erb
================
<%= turbo_stream.replace("filter-settings-save-toggle", partial: "filters/filter_toggle", locals: { filter: @filter }) %>

================
File: app/views/filters/_filter_toggle.html.erb
================
<div id="filter-settings-save-toggle">
  <% if filter.persisted? %>
    <%= button_to filter_path(filter), method: :delete, class: "btn txt-x-small btn--reversed", data: { controller: "tooltip" }, form_class: "inline" do %>
      <%= icon_tag "bookmark-outline" %>
      <span class="for-screen-reader">Delete custom view</span>
    <% end %>
  <% else %>
    <%= button_to filters_path(filter.as_params), method: :post, class: "btn txt-x-small", data: { controller: "tooltip" }, form_class: "inline" do %>
      <%= icon_tag "bookmark-outline" %>
      <span class="for-screen-reader">Save custom view</span>
    <% end %>
  <% end %>
</div>

================
File: app/views/filters/_settings.html.erb
================
<%= tag.details class: "expandable-on-native",
      data: {
        controller: "expandable-on-native",
        expandable_on_native_auto_expand_selector_value: "[data-filter-show=true]" } do %>
    <%= tag.summary "Toggle filters", class: "btn btn--plain margin-block-end", data: { bridge__buttons_target: "button", bridge_title: "Toggle filters", bridge_icon_url: bridge_icon("funnel") } %>
    <%= tag.aside \
          class: class_names("filters margin-block-end", { "filters--expanded": user_filtering.expanded? }),
          data: {
            controller: "toggle-enable toggle-class filter-settings dialog-manager",
            toggle_class_toggle_class: "filters--expanded",
            filter_settings_filters_set_class: "filters--has-filters-set",
            filter_settings_no_filtering_url_value: no_filtering_url,
            filter_settings_refresh_url_value: settings_refresh_path,
            filter_settings_cards_url_value: cards_path,
            turbo_permanent: true } do %>
      <%= form_with url: filter_url, method: :get, class: "display-contents", data: {
            controller: "form",
            turbo_frame: "cards_container",
            filter_settings_target: "form",
            action: "turbo:submit-end->filter-settings#resetIfNoFiltering",
            turbo_action: "advance" } do |form| %>
        <%= hidden_field_tag :expand_all, true, disabled: !user_filtering.expanded?, data: { toggle_enable_target: "element" } %>

        <%= yield form if block_given? %>

          <%= render "filters/settings/terms", filter: user_filtering.filter, form: form do %>
            <%= yield form if block_given? %>
          <% end %>
          <%= render "filters/settings/controls", user_filtering: user_filtering, form: form %>

          <%= render "filters/settings/toggle", user_filtering: user_filtering %>
      <% end %>
      <%= render "filters/settings/manage", user_filtering: user_filtering, no_filtering_url: no_filtering_url %>
    <% end %>
<% end %>

================
File: app/views/filters/create.turbo_stream.erb
================
<%= turbo_stream.replace("filter-settings-save-toggle", partial: "filters/filter_toggle", locals: { filter: @filter }) %>

================
File: app/views/filters/destroy.turbo_stream.erb
================
<%= turbo_stream.replace("filter-settings-save-toggle", partial: "filters/filter_toggle", locals: { filter: @filter }) %>

================
File: app/views/join_codes/inactive.html.erb
================
<% @page_title = "That code is all used up" %>

<div class="panel panel--centered flex flex-column gap-half">
  <h1 class="txt-x-large font-weight-black margin-none"><%= @page_title %></h1>

  <p class="txt-medium margin-none">Ask someone from <%= @join_code.account.name %> to send you a new link or increase the limit.</p>

  <p class="txt-medium">
    <%= link_to "OK", "https://www.fizzy.do", class: "btn btn--link" %>
  </p>
</div>

<% content_for :footer do %>
  <%= render "sessions/footer" %>
<% end %>

================
File: app/views/join_codes/new.html.erb
================
<% @page_title = "Join #{@join_code.account.name} in Fizzy" %>

<div class="panel panel--centered flex flex-column gap-half">
  <h1 class="txt-x-large font-weight-black margin-none"><%= @page_title %></h1>

  <%= form_with url: join_path(code: params[:code], tenant: params[:tenant]), class: "flex flex-column gap txt-medium", data: { controller: "form" } do |form| %>
    <div class="flex align-center gap">
      <label class="flex align-center gap input input--actor">
        <%= form.email_field :email_address, required: true, class: "input full-width", autofocus: true, autocomplete: "username", placeholder: "Email address" %>
      </label>
    </div>

    <button type="submit" id="log_in" class="btn btn--link center" data-form-target="submit">
      <span>Continue</span>
      <%= icon_tag "arrow-right" %>
    </button>
  <% end %>
</div>

<% content_for :footer do %>
  <%= render "sessions/footer" %>
<% end %>

================
File: app/views/layouts/action_text/contents/_content.html.erb
================
<div class="action-text-content">
  <%= format_html yield -%>
</div>

================
File: app/views/layouts/shared/_colophon.html.erb
================
<%= link_to "https://www.fizzy.do", class: "txt-current font-weight-bold txt-nowrap", target: "_blank", rel: "noopener noreferrer" do %>
  <%= icon_tag "fizzy", class: "v-align-middle" %>
  Fizzy
<% end %>
is designed, built, and backed by
<%= link_to "https://37signals.com", class: "txt-current font-weight-bold txt-nowrap", target: "_blank", rel: "noopener noreferrer" do %>
  <%= icon_tag "37signals", class: "v-align-middle" %>
  37signals
<% end %>

================
File: app/views/layouts/shared/_flash.html.erb
================
<%= turbo_frame_tag :flash do %>
  <% if notice = flash[:notice] || flash[:alert] %>
    <div class="flash" data-controller="element-removal" data-action="animationend->element-removal#remove">
      <div class="flash__inner shadow">
        <%= notice %>
      </div>
    </div>
  <% end %>
<% end %>

================
File: app/views/layouts/shared/_head.html.erb
================
<head>
  <%= page_title_tag %>

  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover">
  <% unless @disable_view_transition %>
    <meta name="view-transition" content="same-origin">
  <% end %>
  <meta name="color-scheme" content="light dark">
  <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#0d181d" media="(prefers-color-scheme: dark)">
  <%= csrf_meta_tags %>
  <%= csp_meta_tag %>
  <%= tag.meta name: "current-user-id", content: Current.user.id if Current.user %>
  <%= tag.meta name: "vapid-public-key", content: Rails.configuration.x.vapid.public_key %>

  <% turbo_refreshes_with method: :morph, scroll: :preserve %>

  <%= render "layouts/theme_preference" %>
  <%= stylesheet_link_tag :app, "data-turbo-track": "reload" %>
  <%= stylesheet_link_tag "fizzy/saas", "data-turbo-track": "reload" if Fizzy.saas? %>
  <%= javascript_importmap_tags %>

  <%= tenanted_action_cable_meta_tag %>
  <%= render "layouts/shared/user_css" %>

  <%= yield :head %>

  <link rel="manifest" href="<%= pwa_manifest_path(format: :json) %>">
  <link rel="icon" href="/favicon.png" type="image/png">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
</head>

================
File: app/views/layouts/shared/_time_zone.html.erb
================
<% if timezone_from_cookie.present? && timezone_from_cookie != Current.user.timezone %>
  <%= auto_submit_form_with url: my_timezone_path, method: :put do %>
    <%= hidden_field_tag :timezone_name, timezone_from_cookie.name %>
  <% end %>
<% end %>

================
File: app/views/layouts/shared/_user_css.html.erb
================
<% if Current.user %>
  <style>
    [data-creator-id="<%= Current.user.id %>"] {
      [data-only-visible-to-others] { display: none; }
    }
    [data-creator-id]:not([data-creator-id="<%= Current.user.id %>"]) {
      [data-only-visible-to-you] { display: none; }
    }
  </style>
<% end %>

================
File: app/views/layouts/shared/_welcome_letter.html.erb
================
<div data-controller="dialog" data-dialog-auto-open-value="true" data-dialog-modal-value="true">
  <dialog class="welcome-letter panel panel--wide shadow dialog" data-dialog-target="dialog">
    <button class="welcome-letter__close btn txt-x-small" data-action="dialog#close">
      <%= icon_tag "close" %>
      <span class="for-screen-reader">Close dialog</span>
    </button>

    <div class="txt-align-center margin-block-end">
      <span class="welcome-letter__avatar txt-xx-large avatar center"><%= image_tag "jf-avatar.jpg", size: 36%></span>
    </div>

    <h2 class="txt-medium margin-none txt-tight-lines">Welcome, and thanks for signing up for Fizzy.</h2>

    <p></p>

    <p>To get you started, we set you up with a Fizzy board called <em>Playground</em>. Its got a few cards designed to help you learn Fizzy itself. Open each card, go through the simple steps, and youll be an expert in Fizzy in no time. Youll see the <em>Playground</em> when you close this message.</p>

    <p>If you ever need a hand, please contact me directly at jason@37signals.com. I'm here for you, were all here for you.</p>

    <p>Thanks again and all the best,</p>

    <span class="welcome-letter__signature"></span>

    <p><strong>Jason Fried</strong>, jason@37signals.com<br>
      <em>CEO &amp; co-founder of 37signals, makers of Fizzy, Basecamp, and HEY</em>
    </p>
  </dialog>
</div>

================
File: app/views/layouts/_lightbox.html.erb
================
<%= tag.dialog class:"lightbox", aria: { label: "Image Viewer (Press escape to close)" },
    data: { controller: "dialog", dialog_target: "dialog", dialog_modal_value: "true", lightbox_target: "dialog", action: "keydown.esc->dialog#close:stop transitionend->lightbox#handleTransitionEnd" } do %>

  <figure class="lightbox__figure">
    <img src="" class="lightbox__image" data-lightbox-target="zoomedImage" />
    <figcaption class="lightbox__caption" data-lightbox-target="caption" tabindex="-1" data-dialog-target="focusTouch">&nbsp</figcaption>
  </figure>

  <div class="lightbox__actions">
    <%= yield %>
    <button class="btn fill-white" data-action="dialog#close" data-controller="hotkey tooltip" data-dialog-target="focusMouse">
      <%= icon_tag "remove" %>
      <span class="for-screen-reader">Close (esc)</span>
    </button>
  </div>
<% end %>

================
File: app/views/layouts/_theme_preference.html.erb
================
<%= javascript_tag nonce: true do %>
  const theme = localStorage.getItem("theme")
  if (theme && theme !== "auto") {
    document.documentElement.dataset.theme = theme
  }
<% end %>

================
File: app/views/layouts/application.html.erb
================
<!DOCTYPE html>
<html lang="en">
  <%= render "layouts/shared/head" %>

  <body class="<%= @body_class %>"
    data-controller="local-time timezone-cookie turbo-navigation theme bridge--title bridge--text-size bridge--insets"
    data-action="turbo:morph@window->local-time#refreshAll turbo:before-visit@document->turbo-navigation#rememberLocation"
    data-platform="<%= platform.type %>" data-bridge--title-title-value="<%= @page_title %>">
    <div id="global-container" data-controller="bridge--buttons bridge--overflow-menu">
      <header class="header header--mobile-actions-stack <%= @header_class %>" id="header">
        <a href="#main" class="header__skip-navigation btn" data-turbo="false">Skip to main content</a>
        <%= render "my/menu" if Current.user %>
        <%= yield :header %>
      </header>

      <%= render "layouts/shared/flash" %>
      <%= render "layouts/shared/time_zone" if Current.user %>

      <main id="main">
        <%= yield %>
      </main>
    </div>

    <footer id="footer" class="hide-on-native">
      <%= yield :footer %>

      <% if Current.user && !@hide_footer_frames %>
        <div id="footer_frames" data-turbo-permanent="true">
          <%= render "bar/bar" %>
          <%= render "my/pins/tray" %>
          <%= render "notifications/tray" %>
        </div>
      <% end %>

      <%= render "layouts/shared/welcome_letter" if flash[:welcome_letter] %>
    </footer>
  </body>
</html>

================
File: app/views/layouts/mailer.html.erb
================
<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <style>
      html {
        -ms-text-size-adjust: 100%;
        -webkit-text-size-adjust: 100%;
      }

      body {
        font-family: system-ui, sans-serif;
        font-size: 16px;
        line-height: 1.3;
        margin: 0;
        padding: 1rem;
      }

      img {
        border: 0 none;
        height: auto;
        line-height: 100%;
        outline: none;
        text-decoration: none;
      }

      a {
        color: #2d71e5;
      }

      a img {
        border: 0 none;
      }

      table, td {
        border-collapse: collapse;
      }

      #body {
        height: 100% !important;
        margin: 0;
        padding: 0;
        width: 100% !important;
      }

      .avatar__container {
        vertical-align: top;
        width: 3em;
      }

      .avatar {
        aspect-ratio: 1;
        border-radius: 2.5em;
        color: white;
        display: block;
        font-weight: 600;
        height: 2.5em;
        line-height: 2.5em;
        mso-line-height-rule: exactly;
        object-fit: cover;
        overflow: hidden;
        text-align: center;
        width: 2.5em;
      }

      .card__title {
        font-size: 1.1em;
        font-weight: 900;
        margin-bottom: 0;
        margin-top: 0;
      }

      .footer {
        border-top: 1px solid #ccc;
        margin-top: 3em;
        padding-top: 1em;
      }

      .notification {
        margin-top: 1rem;
        margin-bottom: 1rem;
      }

      .notification__author {
        font-size: 0.8em;
        opacity: 0.66;
        margin: 0;
      }

      .notification__board {
        font-size: 0.8em;
        font-weight: normal;
        margin-bottom: 0;
        margin-top: 0;
        opacity: 0.66;
        text-transform: uppercase;
      }

      .notification__details {
        margin-bottom: 0;
        margin-top: 0;
      }

      .notificaton__mention {
        background-color: #f8e3ab;
        border-radius: 0.7em 0.2em 0.7em 0.2em;
        color: inherit;
        display: inline-flex;
        padding: 0.1em 0.3em;
      }

      .margin-block-end-double {
        margin-bottom: 2em;
      }

      .margin-block-start-double {
        margin-top: 2em;
      }

      .subtitle {
        font-size: 1.2em;
        font-weight: normal;
        margin-bottom: 1em;
        margin-top: 0.1em;
      }

      .title {
        font-size: 1.4em;
        font-weight: 900;
        margin-bottom: 0;
      }

      .txt-large {
        font-size: 1.2em;
      }
    </style>
  </head>

  <body>
    <table id="body">
      <%= yield %>
    </table>
  </body>
</html>

================
File: app/views/layouts/mailer.text.erb
================
<%= yield %>

================
File: app/views/layouts/public.html.erb
================
<!DOCTYPE html>
<html lang="en">
  <%= render "layouts/shared/head" %>

  <body class="public <%= @body_class %>" data-controller="local-time timezone-cookie" data-action="turbo:morph@window->local-time#refreshAll">
    <div id="global-container">
      <header class="header" id="header">
        <a href="#main" class="header__skip-navigation btn" data-turbo="false">Skip to main content</a>
        <nav>
          <%= link_to "https://fizzy.do", class: "header__logo center flex-inline align-center" do %>
            <span><%= image_tag "logo.png", alt: "" %></span>
            <svg height="30" viewBox="0 0 96 30" width="96" xmlns="http://www.w3.org/2000/svg" title="Fizzy"><path clip-rule="evenodd" d="m93.5609 8.52856c.9033.04314 1.3769.47352 1.4199 1.33398.1291 2.40966.0859 5.24976.1289 7.48726l.1289 7.3575c0 15.4902-10.2406 15.8354-16.8242 14.7168-.8606-.1722-1.2482-.7322-1.1621-1.5928l.3867-3.7002c.086-1.0327.732-1.2905 1.6787-.9463 4.3889 1.5919 9.122-.4737 9.0791-4.7334 0-1.0757-.6026-1.2052-1.2481-.3877-.9036 1.0757-2.2802 2.1943-4.3886 2.1944-3.0552 0-8.2188-1.2046-8.2188-11.962 0-2.6677-.086-5.5076-.0429-8.47652 0-.90362.5162-1.37702 1.4199-1.33399 1.2048.04302 2.3665.00006 3.5283-.04297.9036 0 1.4199.47328 1.4199 1.41992 0 3.22686-.0859 5.63626-.0859 6.45406 0 7.7023 1.7647 8.2187 3.7871 8.2618 2.1512.0427 3.5709-1.5491 3.8291-5.2061v-.9902c0-4.604.0861-6.2821-.043-8.47659-.086-.9036.3444-1.41986 1.2481-1.46289zm-43.4629-.21484c1.1186-.04303 1.5064.68823.9472 1.63476-1.8502 3.05502-5.3796 8.73462-8.3486 13.42482-.4733.7745-.1713 1.334.7754 1.334 2.1511.043 2.9261.0431 5.5937-.086.9464-.0429 1.4199.4306 1.42 1.377-.0431.8605-.0001 1.8504 0 2.7109 0 .9036-.4305 1.3769-1.334 1.377-3.9588.043-9.4238-.1721-15.6201-.043-1.1618 0-1.5487-.6881-.9463-1.6348l8.3906-13.2099c.4733-.7315.1721-1.3769-.7315-1.377-2.4096-.043-4.9915.0429-6.8418.1289-.9036.0431-1.4199-.3874-1.4199-1.291-.043-.9035 0-1.9792 0-2.92576 0-.86059.7316-1.33399 2.0225-1.33399 6.1531.04303 12.1341-.04291 16.0928-.08593zm21.1367 0c1.1186-.04294 1.5056.68817.9463 1.63476-1.8503 3.05502-5.3787 8.73462-8.3477 13.42482-.4733.7745-.1721 1.3339.7744 1.334 2.1514.043 2.9261.0431 5.5938-.086.9465-.043 1.4198.4305 1.4199 1.377-.043.8605 0 1.8504 0 2.7109 0 .9036-.4304 1.377-1.334 1.377-3.9586.043-9.4232-.1721-15.6191-.043-1.1617 0-1.5494-.6883-.9473-1.6348l8.3916-13.2099c.4733-.7315.1712-1.377-.7324-1.377-2.4096-.043-4.9916.0429-6.8418.1289-.9033.0429-1.4199-.3875-1.4199-1.291-.0431-.9035 0-1.9792 0-2.92576 0-.86051.7318-1.3339 2.0224-1.33399 6.1533.04303 12.135-.04291 16.0938-.08593zm-43.3252.25781c.9035-.04295 1.4199.38753 1.4199 1.24805.043 1.50602 0 3.65782 0 12.39262 0 5.6796-.086 5.4215 0 6.4111.1291.9036-.3444 1.4198-1.248 1.4629l-3.9161-.086c-.8604-.0431-1.3769-.4735-1.4199-1.3339-.1291-2.4097-.0859-5.2499-.1289-7.4874-.1291-5.5505-.0429-7.8742-.0859-11.23042-.043-.90357.4733-1.37695 1.4199-1.37695 1.7212.08606 2.8832.08606 3.959 0zm-21.88185-8.56250162c2.36657.04302752 4.77645.00000269 8.30465 0 1.2909 0 3.0554.04302142 4.6905 0 .7314 0 1.119.38683562 1.1191 1.16113162-.043 1.46292-.086 3.3134-.043 4.77637 0 .77451-.4305 1.11924-1.205 1.0332-1.2909-.12909-3.3564-.25866-5.5079-.34473-2.0653-.12908-2.1945.04296-4.25972.04297-.8606 0-1.42065.43055-1.59277 1.20508v.04297c-.12909.64544-.12891 1.03327-.12891 1.67871v.51567c.04303.9035.51653 1.3338 1.37696 1.3769 2.40954.043 5.46464.0002 7.70214-.1289.7315-.043 1.1621.3016 1.1621 1.0762l-.0859 4.3886c0 .7315-.4306 1.1192-1.1621 1.0762-2.2374-.043-4.7329-.0439-7.35746-.0869-.9035-.043-1.37677.4736-1.41992 1.334l-.17285 4.3467c0 2.6244.04379 4.0872.17285 5.292.12909.7315-.25872 1.1621-.99023 1.1621l-5.29297.0429c-.731221-.0001-1.075196-.3877-1.075196-1.1191-.000045-1.2478-.2149575-2.8399-.128907-5.7656.129086-5.7659.085256-13.7261-.12988242-21.81546-.04302878-.774508.34469842-1.162087 1.07617542-1.162105 1.592-.0430291 3.70034-.1719109 4.94824-.12890662zm19.90235.34374962c2.6247.00004 3.5283 1.377542 3.5283 3.055662-.0001 1.72099-.9038 3.09762-3.5283 3.09766-2.6677 0-3.5712-1.37665-3.5713-3.09766 0-1.67815.9034-3.055662 3.5713-3.055662z" fill="currentColor" fill-rule="evenodd"/></svg>
          <% end %>
        </nav>

        <%= yield :header %>
      </header>

      <%= render "layouts/shared/flash" %>

      <main id="main">
        <%= yield %>
      </main>
    </div>

    <footer id="footer">
      <%= yield :footer %>
    </footer>
  </body>
</html>

================
File: app/views/mailers/account_mailer/cancellation.html.erb
================
<p>Your Fizzy account <strong><%= @account.name %></strong> was cancelled.</p>

<h2>What happens now?</h2>

<ul>
  <li>No one can access the account anymore</li>
  <% if @account.try(:subscription) %>
  <li>We won't charge you anymore</li>
  <% end %>
  <li>Everything in the account will be deleted in <%= distance_of_time_in_words_to_now(Account::Incineratable::INCINERATION_GRACE_PERIOD.from_now) %></li>
</ul>

<i>Changed your mind?</i>
<p>If you want to cancel this deletion and restore your account, send us an email to <a href="mailto:support@fizzy.do">support@fizzy.do</a> as soon as possible.</p>

================
File: app/views/mailers/account_mailer/cancellation.text.erb
================
Your Fizzy account "<%= @account.name %>" was cancelled.

WHAT HAPPENS NOW?

- No one can access the account anymore
<% if @account.try(:subscription) %>
- We won't charge you anymore
<% end %>
- Everything in the account will be deleted in <%= distance_of_time_in_words_to_now(Account::Incineratable::INCINERATION_GRACE_PERIOD.from_now) %>

CHANGED YOUR MIND?

If you want to cancel this deletion and restore your account, send us an email to support@fizzy.do as soon as possible.

================
File: app/views/mailers/export_mailer/completed.html.erb
================
<h1 class="title">Download your Fizzy data</h1>
<p class="subtitle">Your Fizzy data export has finished processing and is ready to download.</p>

<p><%= link_to "Download your data", export_download_url(@export) %></p>

<p class="footer">Need help? <%= mail_to "support@fizzy.do", "Send us an email" %>.</p>

================
File: app/views/mailers/export_mailer/completed.text.erb
================
Your Fizzy data export has finished processing and is ready to download.

Download your data: <%= export_download_url(@export) %>

================
File: app/views/mailers/identity_mailer/email_change_confirmation.text.erb
================
Confirm your email address change
<%= "=" * 80 %>

Hit the link below to use this email address in Fizzy:

<%= user_email_address_confirmation_url(user_id: @user.id, email_address_token: @token) %>

If you didnt request this change, you can ignore this email. Your email address WILL NOT be changed unless you hit the button.

================
File: app/views/mailers/import_mailer/completed.html.erb
================
<p class="subtitle">Your import of <%= @account.name %> is complete!</p>

<p><%= link_to "Go to your account", landing_url(script_name: @account.slug) %></p>

<p class="footer">Need help? <%= mail_to "support@fizzy.do", "Send us an email" %>.</p>

================
File: app/views/mailers/import_mailer/completed.text.erb
================
Your import of <%= @account.name %> is complete!

Here's the URL: <%= landing_url(script_name: @account.slug) %>

================
File: app/views/mailers/import_mailer/failed.html.erb
================
<p class="subtitle">Unfortunately, we couldn't import your Fizzy account.</p>

<p>
This may be due to corrupted export data or a conflict with existing data.
Please try again with a fresh export, or reach out for help if the problem persists.
</p>

<p class="footer">Need help? <%= mail_to "support@fizzy.do", "Send us an email" %>.</p>

================
File: app/views/mailers/import_mailer/failed.text.erb
================
Unfortunately, we couldn't import your Fizzy account.

This may be due to corrupted export data or a conflict with existing data.
Please try again with a fresh export, or reach out for help if the problem persists.

Need help? Send us an email at support@fizzy.do

================
File: app/views/mailers/magic_link_mailer/sign_in_instructions.html.erb
================
<% if @magic_link.for_sign_in? %>
  <h1 class="title">Fizzy verification code</h1>
  <p class="subtitle">Please enter this 6-character verification code on the Fizzy sign-in page:</p>
<% else %>
  <h1 class="title">Welcome to Fizzy!</h1>
  <p class="subtitle">Please enter this 6-character verification code on the Fizzy sign-up page to create your new account:</p>
<% end %>

<strong class="txt-large"><%= @magic_link.code %></strong>

<p>This code will work for <%= distance_of_time_in_words(MagicLink::EXPIRATION_TIME) %>.</p>

<p class="footer">Need help? <%= mail_to "support@fizzy.do", "Send us an email"%>.
</p>

================
File: app/views/mailers/magic_link_mailer/sign_in_instructions.text.erb
================
<% if @magic_link.for_sign_in? %>
Please enter this 6-character verification code on the Fizzy sign-in page:
<% else %>
Please enter this 6-character verification code on the Fizzy sign-up page to create your new account:
<% end %>

<%= @magic_link.code %>

This code will work for <%= distance_of_time_in_words(MagicLink::EXPIRATION_TIME) %>.

================
File: app/views/mailers/notification/bundle_mailer/event/_body.html.erb
================
<% event = notification.source %>

<p class="notification__author">
  <%= notification.creator.familiar_name %>
</p>
<p class="notification__details">
  <%= event_notification_body(event) %>
</p>

================
File: app/views/mailers/notification/bundle_mailer/event/_body.text.erb
================
<% event = notification.source %>

<%= notification.creator.name %>:
<%= event_notification_body(event).squish %>
<%= url_for notification %>

================
File: app/views/mailers/notification/bundle_mailer/mention/_body.html.erb
================
<% mention = notification.source %>

<strong class="notificaton__mention">
  <%= "#{mention.mentioner.first_name} mentioned you:" %>
</strong>
<p class="notification__details">
  <%= mention.source.mentionable_content.truncate(250) %>
</p>

================
File: app/views/mailers/notification/bundle_mailer/mention/_body.text.erb
================
<% mention = notification.source %>

<%= mention.mentioner.first_name %> mentioned you:
<%= mention.source.mentionable_content.truncate(250) %>
<%= url_for mention %>

================
File: app/views/mailers/notification/bundle_mailer/_notification.html.erb
================
<table class="notification">
  <tr>
    <td class="avatar__container">
      <%= mail_avatar_tag(notification.creator) %>
    </td>
    <td class="what">
      <%= render "notification/bundle_mailer/#{notification.source_type.underscore}/body", notification: notification %>
    </td>
  </tr>
</table>

================
File: app/views/mailers/notification/bundle_mailer/_notification.text.erb
================
<%= render "notification/bundle_mailer/#{notification.source_type.underscore}/body", notification: notification %>

================
File: app/views/mailers/notification/bundle_mailer/notification.html.erb
================
<tr>
  <td>
    <h1 class="title">Notifications since <%= @bundle.starts_at.strftime("%-l%P on %A, %B %-d") %></h1>
    <p class="subtitle margin-block-end-double">
      You have <%= link_to pluralize(@notifications.count, "new notification"), notifications_url %><%= " in #{ Current.account.name }" if @user.identity.accounts.many? %>.
    </p>

    <% @notifications.group_by(&:card).each do |card, notifications| %>
      <h2 class="notification__board"><%= card.board.name %></h2>
      <%= link_to "##{ card.number } #{ card.title }", card, class: "card__title" %>
      <%= render partial: "notification/bundle_mailer/notification", collection: notifications, as: :notification %>
    <% end %>

    <p class="footer">Fizzy emails you about new notifications every few hours. <br>
      <%= link_to "Change how often you get these", notifications_settings_url %>
      or <%= link_to "unsubscribe from all email notifications", new_notifications_unsubscribe_url(access_token: @unsubscribe_token) %>.
    </p>
  </td>
</tr>

================
File: app/views/mailers/notification/bundle_mailer/notification.text.erb
================
Notifications since <%= @bundle.starts_at.strftime("%-l%P on %A, %B %-d") %>
You have <%= pluralize @notifications.count, "new notification" %><%= " in #{ Current.account.name }" if @user.identity.accounts.many? %>.

<% @notifications.group_by(&:card).each do |card, notifications| %>
--------------------------------------------------------------------------------

<%= card.board.name %>
<%= "##{ card.number } #{ card.title }" %>

--------------------------------------------------------------------------------

<%= render partial: "notification/bundle_mailer/notification", collection: notifications, as: :notification %>
<% end %>

--------------------------------------------------------------------------------

Fizzy emails you about new notifications every few hours.

Change how often you get these:
<%= notifications_settings_url %>

Unsubscribe from all email notifications:
<%= new_notifications_unsubscribe_url(access_token: @unsubscribe_token) %>

================
File: app/views/my/access_tokens/_access_token.html.erb
================
<tr style="view-transition-name: <%= dom_id(access_token) %>">
  <td><strong><%= access_token.description %></strong></td>
  <td><%= access_token.permission.humanize %></td>
  <td><%= local_datetime_tag access_token.created_at, style: :datetime %></td>
  <td>
    <%= button_to my_access_token_path(access_token), method: :delete,
          class: "btn txt-negative btn--circle txt-x-small borderless fill-transparent",
          data: { turbo_confirm: "Are you sure you want to permanently revoke this access token?" } do %>
      <%= icon_tag "trash" %>
      <span class="for-screen-reader">Edit this token</span>
    <% end %>
  </td>
</tr>

================
File: app/views/my/access_tokens/index.html.erb
================
<% @page_title = "Personal access tokens" %>

<% content_for :header do %>
  <div class="header__actions header__actions--start">
    <%= back_link_to "My profile", user_path(Current.user), "keydown.left@document->hotkey#click keydown.esc@document->hotkey#click" %>
  </div>

  <h1 class="header__title" data-bridge--title-target="header"><%= @page_title %></h1>
<% end %>

<section class="panel panel--wide shadow center webhooks">
  <% if @access_tokens.any? %>
    <p class="margin-none-block-start">Tokens you have generated that can be used to access the Fizzy API.</p>
    <table class="access_tokens_table margin-block-end-double max-width txt-small">
      <thead>
        <tr>
          <th>Description</th>
          <th>Permission</th>
          <th>Created</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <%= render partial: "my/access_tokens/access_token", collection: @access_tokens %>
      </tbody>
    </table>
  <% else %>
    <p class="margin-none-block-start">Personal access tokens can be used like a password to access the Fizzy developer API. You can have as many tokens as you need and revoke access to each one at any time.</p>
  <% end %>

  <%= link_to new_my_access_token_path, class: "btn btn--link" do %>
    <%= icon_tag "add" %>
    <span>Generate a new access token</span>
  <% end %>
</section>

================
File: app/views/my/access_tokens/new.html.erb
================
<% @page_title = "Generate a personal access token" %>

<% content_for :header do %>
  <div class="header__actions header__actions--start">
    <%= back_link_to "tokens", my_access_tokens_path, "keydown.left@document->hotkey#click keydown.esc@document->hotkey#click" %>
  </div>

  <h1 class="header__title" data-bridge--title-target="header"><%= @page_title %></h1>
<% end %>

<article class="panel panel--wide shadow center txt-align-start" style="view-transition-name: <%= dom_id(@access_token) %>">
  <%= form_with model: @access_token, url: my_access_tokens_path, scope: :access_token, data: { controller: "form" }, html: { class: "flex flex-column gap" } do |form| %>
    <div class="flex flex-column gap-half">
      <strong><%= form.label :description, "Access token description" %></strong>
      <%= form.text_field :description, required: true, autofocus: true, class: "input", placeholder: "e.g. Github", data: { action: "keydown.esc@document->form#cancel" } %>
    </div>

    <div class="flex flex-column gap-half">
      <strong><%= form.label :permission %></strong>
      <%= form.select :permission, options_for_select({ "Read" => "read", "Read + Write" => "write"}), {}, class: "input input--select" %>
    </div>

    <%= form.button type: :submit, class: "btn btn--link center txt-medium" do %>
      <span>Generate access token</span>
    <% end %>

     <%= link_to "Cancel and go back", my_access_tokens_path, data: { form_target: "cancel" }, hidden: true %>
  <% end %>
</article>

================
File: app/views/my/access_tokens/show.html.erb
================
<% @page_title = "New personal access token" %>

<% content_for :header do %>
  <div class="header__actions header__actions--start">
    <%= back_link_to "Tokens", my_access_tokens_path, "keydown.left@document->hotkey#click keydown.esc@document->hotkey#click" %>
  </div>

  <h1 class="header__title" data-bridge--title-target="header"><%= @page_title %></h1>
<% end %>

<article class="panel panel--wide shadow center txt-align-start" style="view-transition-name: <%= dom_id(@access_token) %>">
  <div class="flex flex-column gap">
    <label class="flex flex-column gap-half txt-align-start">
      <strong><%= @access_token.description %> (<%= @access_token.permission == "write" ? "Read + Write" : "Read" %>)</strong>
      <input type="text" value="<%= @access_token.token %>" class="input" readonly>
    </label>
    <p class="margin-none txt-small">Be sure to save this access token now because you wont be able to see it again.</p>

    <%= tag.button class: "btn btn--link center", data: {
      controller: "copy-to-clipboard", action: "copy-to-clipboard#copy",
          copy_to_clipboard_success_class: "btn--success", copy_to_clipboard_content_value: @access_token.token } do %>
      <%= icon_tag "copy-paste" %>
      <span>Copy access token</span>
    <% end %>
  </div>
</article>

================
File: app/views/my/identities/_account.json.jbuilder
================
json.cache! account do
  json.(account, :id, :name, :slug)
  json.created_at account.created_at.utc
end

================
File: app/views/my/identities/show.json.jbuilder
================
json.accounts @identity.users do |user|
  json.partial! "my/identities/account", account: user.account
  json.user user, partial: "users/user", as: :user
end

================
File: app/views/my/menus/_accounts.html.erb
================
<% if accounts.many? %>
  <% cache [ Current.identity, accounts, Current.account ] do %>
    <%= collapsible_nav_section "Accounts" do %>
      <%# Bust cache 1 Dec 2025 %>
      <% accounts.each do |account| %>
        <%= filter_place_menu_item landing_path(script_name: account.slug), account.name, "marker", current: account == Current.account, turbo: false %>
      <% end %>
    <% end %>
  <% end %>
<% end %>

================
File: app/views/my/menus/_boards.html.erb
================
<%= collapsible_nav_section "Boards" do %>
  <li class="popup__item" data-filter-target="item" data-navigable-list-target="item">
    <%= icon_tag "add", class: "popup__icon" %>
    <%= link_to new_board_path, class: "popup__btn btn" do %>
      <span class="overflow-ellipsis">Add a board</span>
    <% end %>
  </li>

  <% boards.each do |board| %>
    <%= my_menu_board_item(board) %>
  <% end %>
<% end %>

================
File: app/views/my/menus/_custom_views.html.erb
================
<%= collapsible_nav_section "Custom views", id: "my-filters" do %>
  <%= form_with url: cards_path, method: :get, data: { controller: "form" } do |form| %>
    <li class="popup__item overflow-ellipsis" data-navigable-list-target="item" data-filter-target="item" id="filter-custom-create">
      <%= icon_tag "bookmark", class: "popup__icon" %>
      <%= link_to cards_path(expand_all: true), class: "popup__btn btn" do %>
        <span>Create a custom view</span>
      <% end %>
    </li>

    <% filters.each do |filter| %>
      <%= my_menu_filter_item(filter) %>
    <% end %>
  <% end %>
<% end %>

================
File: app/views/my/menus/_jump.html.erb
================
<div class="flex gap">
  <div class="flex flex-column full-width justify-center gap-half">
    <div class="nav__header">
      <% if Current.identity.accounts.many? %>
        <div class="nav__header-title max-width">
          <div class="overflow-ellipsis"><strong><%= Current.account.name %></strong></div>
        </div>
      <% end %>
      <div class="nav__header-actions nav__header-actions--end nav__close">
        <button class="btn txt-xx-small" data-action="dialog#close">
          <%= icon_tag "close" %>
          <span class="for-screen-reader">Close menu</span>
        </button>
      </div>
    </div>
    <%= jump_field_tag %>
  </div>
</div>

<div class="nav__scroll-container">
  <div class="nav__hotkeys margin-block-end-half" role="list">
    <%= filter_hotkey_link "Home", root_path, 1, "home" %>
    <%= filter_hotkey_link "Assigned to me", cards_path(assignee_ids: [Current.user.id]), 2, "clipboard" %>
    <%= filter_hotkey_link "Added by me", cards_path(creator_ids: [Current.user.id]), 3, "person-add" %>
  </div>

  <%= yield %>

  <div class="nav__blank-slate blank-slate">
    Nothing matches that filter
  </div>
</div>

================
File: app/views/my/menus/_people.html.erb
================
<%= collapsible_nav_section "People" do %>
  <li class="popup__item" data-filter-target="item" data-navigable-list-target="item">
    <%= icon_tag "add", class: "popup__icon" %>
    <%= link_to account_join_code_path, class: "popup__btn btn" do %>
      <span class="overflow-ellipsis">Invite people</span>
    <% end %>
  </li>

  <% users.each do |user| %>
    <%= my_menu_user_item(user) %>
  <% end %>
<% end %>

================
File: app/views/my/menus/_settings.html.erb
================
<%= collapsible_nav_section "Settings" do %>
  <%= filter_place_menu_item account_settings_path, "Account Settings", "settings" %>
  <%= filter_place_menu_item user_path(Current.user), "My Profile", "person" %>
  <%= filter_place_menu_item notifications_path, "All notifications", "bell" %>
  <%= filter_place_menu_item notifications_settings_path, "Notification Settings", "settings" %>

  <%= tag.li class: "popup__item", data: { filter_target: "item", navigable_list_target: "item" } do %>
    <%= icon_tag "logout", class: "popup__icon" %>
    <%= button_to session_path(script_name: nil), method: :delete, class: "popup__btn btn", data: { turbo: false } do %>
      <span>Sign out</span>
    <% end %>
  <% end %>
<% end %>

================
File: app/views/my/menus/_shortcuts.html.erb
================
<%= collapsible_nav_section "Shortcuts", class: "nav__section popup__section nav__section--secret" do %>
  <%= filter_place_menu_item cards_path(indexed_by: :golden), "Golden cards", "filter" %>
  <%= filter_place_menu_item cards_path(indexed_by: :stalled), "Stalled cards", "filter" %>
  <%= filter_place_menu_item cards_path(indexed_by: :postponing_soon), "Cards closing soon", "filter" %>
  <%= filter_place_menu_item cards_path(creation: "today"), "Added today", "filter" %>
  <%= filter_place_menu_item cards_path(closure: "today"), "Done today", "filter" %>
<% end %>

================
File: app/views/my/menus/_tags.html.erb
================
<%= collapsible_nav_section "Tags" do %>
  <% tags.each do |tag| %>
    <%= my_menu_tag_item(tag) %>
  <% end %>
<% end %>

================
File: app/views/my/menus/show.html.erb
================
<%= turbo_frame_tag "my_menu", target: "_top" do %>
  <%= render "my/menus/jump" do %>
    <%= render "my/menus/boards", boards: @boards %>
    <%= render "my/menus/tags", tags: @tags %>
    <%= render "my/menus/people", users: @users %>
    <%= render "my/menus/settings" %>
    <%= render "my/menus/shortcuts" %>
    <%= render "my/menus/accounts", accounts: @accounts %>
  <% end %>

  <footer class="nav__footer">
    <%= render "layouts/shared/colophon" %>
  </footer>
<% end %>

================
File: app/views/my/pins/_pin.html.erb
================
<div class="tray__item tray__item--pin" id="<%= dom_id pin %>" data-navigable-list-target="item">
  <%= render "cards/display/preview", card: pin.card %>
  <%= button_to card_pin_path(pin.card), method: :delete, class: "tray__remove-pin-btn btn btn--circle borderless" do %>
    <%= icon_tag "pinned" %> <span class="for-screen-reader">Un-pin this card</span>
  <% end %>
</div>

================
File: app/views/my/pins/_tray.html.erb
================
<%= turbo_stream_from Current.user, :pins_tray %>

<section class="tray tray--pins" data-controller="dialog">
  <%= tag.dialog id: "pin-tray", class: "tray__dialog", data: {
        action: "keydown->navigable-list#navigate dialog:show@document->navigable-list#reset keydown.esc->dialog#close:stop click@document->dialog#closeOnClickOutside",
        controller: "navigable-list",
        dialog_target: "dialog",
        navigable_list_actionable_items_value: "true",
        navigable_list_reverse_navigation_value: "true" },
        turbo_permanent: true do %>
    <%= turbo_frame_tag "pins", src: my_pins_path, data: { controller: "frame", action: "turbo:morph@document->frame#reload" } %>
  <% end %>

  <button class="tray__toggle" data-action="dialog#toggle keydown.p@document->hotkey#click" data-controller="hotkey" aria-label="Toggle pins stack" aria-haspopup="true">
    <div class="tray__toggle-btn txt-uppercase btn btn--reversed txt-x-small center full-width">
      <%= icon_tag "pinned" %>
      <span class="tray__toggle-text">Pinned <kbd class="hide-on-touch">P</kbd></span>
    </div>
  </button>
</section>

================
File: app/views/my/pins/index.html.erb
================
<% @page_title = "Pinned" %>

<% content_for :header do %>
  <div class="header__actions header__actions--start">
    <%= back_link_to "Home", root_path, "keydown.left@document->hotkey#click keydown.esc@document->hotkey#click" %>
  </div>

  <h1 class="header__title" data-bridge--title-target="header"><%= @page_title %></h1>
<% end %>

<div class="pins-list panel panel--wide flex center borderless unpad flex-column gap-half margin-block-start">
  <%= turbo_frame_tag "pins" do %>
    <%= render partial: "my/pins/pin", collection: @pins %>
  <% end %>
</div>

================
File: app/views/my/pins/index.json.jbuilder
================
json.array! @pins do |pin|
  json.partial! "cards/card", card: pin.card
end

================
File: app/views/my/_menu.html.erb
================
<nav class="nav hide-on-native"
    data-controller="dialog"
    data-action="keydown.esc->dialog#close click@document->dialog#closeOnClickOutside mouseenter->dialog#loadLazyFrames">
  <%= tag.button class:"nav__trigger input input--select center flex-inline align-center txt-normal", data: {
        action: "click->dialog#open keydown.j@document->hotkey#click keydown.meta+j@document->hotkey#click keydown.ctrl+j@document->hotkey#click",
        controller: "hotkey" } do %>
    <span><%= image_tag "logo.png", alt: "" %></span>
    <svg height="30" viewBox="0 0 96 30" width="96" xmlns="http://www.w3.org/2000/svg" title="Fizzy"><path clip-rule="evenodd" d="m93.5609 8.52856c.9033.04314 1.3769.47352 1.4199 1.33398.1291 2.40966.0859 5.24976.1289 7.48726l.1289 7.3575c0 15.4902-10.2406 15.8354-16.8242 14.7168-.8606-.1722-1.2482-.7322-1.1621-1.5928l.3867-3.7002c.086-1.0327.732-1.2905 1.6787-.9463 4.3889 1.5919 9.122-.4737 9.0791-4.7334 0-1.0757-.6026-1.2052-1.2481-.3877-.9036 1.0757-2.2802 2.1943-4.3886 2.1944-3.0552 0-8.2188-1.2046-8.2188-11.962 0-2.6677-.086-5.5076-.0429-8.47652 0-.90362.5162-1.37702 1.4199-1.33399 1.2048.04302 2.3665.00006 3.5283-.04297.9036 0 1.4199.47328 1.4199 1.41992 0 3.22686-.0859 5.63626-.0859 6.45406 0 7.7023 1.7647 8.2187 3.7871 8.2618 2.1512.0427 3.5709-1.5491 3.8291-5.2061v-.9902c0-4.604.0861-6.2821-.043-8.47659-.086-.9036.3444-1.41986 1.2481-1.46289zm-43.4629-.21484c1.1186-.04303 1.5064.68823.9472 1.63476-1.8502 3.05502-5.3796 8.73462-8.3486 13.42482-.4733.7745-.1713 1.334.7754 1.334 2.1511.043 2.9261.0431 5.5937-.086.9464-.0429 1.4199.4306 1.42 1.377-.0431.8605-.0001 1.8504 0 2.7109 0 .9036-.4305 1.3769-1.334 1.377-3.9588.043-9.4238-.1721-15.6201-.043-1.1618 0-1.5487-.6881-.9463-1.6348l8.3906-13.2099c.4733-.7315.1721-1.3769-.7315-1.377-2.4096-.043-4.9915.0429-6.8418.1289-.9036.0431-1.4199-.3874-1.4199-1.291-.043-.9035 0-1.9792 0-2.92576 0-.86059.7316-1.33399 2.0225-1.33399 6.1531.04303 12.1341-.04291 16.0928-.08593zm21.1367 0c1.1186-.04294 1.5056.68817.9463 1.63476-1.8503 3.05502-5.3787 8.73462-8.3477 13.42482-.4733.7745-.1721 1.3339.7744 1.334 2.1514.043 2.9261.0431 5.5938-.086.9465-.043 1.4198.4305 1.4199 1.377-.043.8605 0 1.8504 0 2.7109 0 .9036-.4304 1.377-1.334 1.377-3.9586.043-9.4232-.1721-15.6191-.043-1.1617 0-1.5494-.6883-.9473-1.6348l8.3916-13.2099c.4733-.7315.1712-1.377-.7324-1.377-2.4096-.043-4.9916.0429-6.8418.1289-.9033.0429-1.4199-.3875-1.4199-1.291-.0431-.9035 0-1.9792 0-2.92576 0-.86051.7318-1.3339 2.0224-1.33399 6.1533.04303 12.135-.04291 16.0938-.08593zm-43.3252.25781c.9035-.04295 1.4199.38753 1.4199 1.24805.043 1.50602 0 3.65782 0 12.39262 0 5.6796-.086 5.4215 0 6.4111.1291.9036-.3444 1.4198-1.248 1.4629l-3.9161-.086c-.8604-.0431-1.3769-.4735-1.4199-1.3339-.1291-2.4097-.0859-5.2499-.1289-7.4874-.1291-5.5505-.0429-7.8742-.0859-11.23042-.043-.90357.4733-1.37695 1.4199-1.37695 1.7212.08606 2.8832.08606 3.959 0zm-21.88185-8.56250162c2.36657.04302752 4.77645.00000269 8.30465 0 1.2909 0 3.0554.04302142 4.6905 0 .7314 0 1.119.38683562 1.1191 1.16113162-.043 1.46292-.086 3.3134-.043 4.77637 0 .77451-.4305 1.11924-1.205 1.0332-1.2909-.12909-3.3564-.25866-5.5079-.34473-2.0653-.12908-2.1945.04296-4.25972.04297-.8606 0-1.42065.43055-1.59277 1.20508v.04297c-.12909.64544-.12891 1.03327-.12891 1.67871v.51567c.04303.9035.51653 1.3338 1.37696 1.3769 2.40954.043 5.46464.0002 7.70214-.1289.7315-.043 1.1621.3016 1.1621 1.0762l-.0859 4.3886c0 .7315-.4306 1.1192-1.1621 1.0762-2.2374-.043-4.7329-.0439-7.35746-.0869-.9035-.043-1.37677.4736-1.41992 1.334l-.17285 4.3467c0 2.6244.04379 4.0872.17285 5.292.12909.7315-.25872 1.1621-.99023 1.1621l-5.29297.0429c-.731221-.0001-1.075196-.3877-1.075196-1.1191-.000045-1.2478-.2149575-2.8399-.128907-5.7656.129086-5.7659.085256-13.7261-.12988242-21.81546-.04302878-.774508.34469842-1.162087 1.07617542-1.162105 1.592-.0430291 3.70034-.1719109 4.94824-.12890662zm19.90235.34374962c2.6247.00004 3.5283 1.377542 3.5283 3.055662-.0001 1.72099-.9038 3.09762-3.5283 3.09766-2.6677 0-3.5712-1.37665-3.5713-3.09766 0-1.67815.9034-3.055662 3.5713-3.055662z" fill="currentColor" fill-rule="evenodd"/></svg>
    <kbd class="kbd txt-xx-small hide-on-touch">J</kbd>
  <% end %>

  <%= tag.dialog class: "nav__menu filter popup popup--animated panel margin-block-start-half", data: {
        action: "turbo:before-cache@document->dialog#close turbo:frame-render->navigable-list#reset keydown->navigable-list#navigate filter:changed->navigable-list#reset filter:changed->nav-section-expander#showWhileFiltering toggle->filter#filter",
        controller: "filter navigable-list nav-section-expander",
        dialog_target: "dialog",
        navigable_list_focus_on_selection_value: false,
        navigable_list_actionable_items_value: true,
        turbo_permanent: true } do %>
    <%= turbo_frame_tag "my_menu", src: my_menu_path, loading: :lazy, target: "_top" do %>
      <% # Passing empty block to avoid double-render  %>
      <%= render("my/menus/jump") { } %>
    <% end %>
  <% end %>
</nav>

================
File: app/views/notifications/index/_notification.html.erb
================
<%= notification_tag notification do %>
  <%= render "notifications/notification/header", notification: notification do %>
    <%= notification_toggle_read_button(notification, url: notification_reading_path(notification)) %>
  <% end %>
  <%= render "notifications/notification/body", notification: notification %>
<% end %>

================
File: app/views/notifications/index/_read_notifications.html.erb
================
<% if page.records.any? %>
  <section class="notifications-list notifications-list--read panel panel--wide center borderless unpad flex flex-column gap-half margin-block-start">
    <h2 class="txt-medium margin-block-start-double margin-block-end-half txt-uppercase translucent">Previously seen</h2>

    <div id="notifications_list_read" contents>
      <%= render partial: "notifications/index/notification", collection: page.records, cached: true %>
    </div>
  </section>
<% end %>

================
File: app/views/notifications/index/_unread_notifications.html.erb
================
<section class="notifications-list panel panel--wide center borderless unpad flex flex-column gap-half">
  <% if unread.any? %>
    <div class="flex align-center justify-space-between margin-block-start margin-block-end-half">
      <h2 class="txt-medium txt-uppercase txt-alert">New for you</h2>
      <%= button_to "Mark all as read", bulk_reading_path, class: "btn txt-small", form: { data: { turbo: false } }, data: { action: "badge#clear" } %>
    </div>
  <% else %>
    <div class="notifications-list__blank-slate blank-slate align-self-center">
      Nothing new for you
    </div>
  <% end %>

  <div id="notifications_list" contents>
    <%= render partial: "notifications/index/notification", collection: unread, cached: true %>
  </div>

  <% if unread.any? %>
    <% total_unread_count = Current.user.notifications.unread.count %>
    <% if Current.user.notifications.unread.count > NotificationsController::MAX_UNREAD_NOTIFICATIONS %>
      <div class="fill-highlight txt-x-small border-radius pad-block-half pad-inline">
        Showing the <%= NotificationsController::MAX_UNREAD_NOTIFICATIONS %> most recent (<%= total_unread_count - NotificationsController::MAX_UNREAD_NOTIFICATIONS %> are hidden)
      </div>
    <% end %>
  <% end %>
</section>

================
File: app/views/notifications/notification/event/_body.html.erb
================
<% event = notification.source %>

<div class="card__title overflow-ellipsis">
  <%= event_notification_title(event) %>
</div>

<div class="card__notification-body overflow-ellipsis">
  <%= event_notification_body(event) %>
</div>

================
File: app/views/notifications/notification/event/_body.json.jbuilder
================
json.title event_notification_title(notification.source)
json.body event_notification_body(notification.source)

================
File: app/views/notifications/notification/mention/_body.html.erb
================
<% mention = notification.source %>

<strong class="card__title overflow-ellipsis"><mark class="card__notification-mentioner"><%= mention.mentioner.first_name %> @mentioned you</mark></strong>
<div class="card__notification-body overflow-ellipsis">
  <%= mention.source.mentionable_content.truncate(200) %>
</div>

================
File: app/views/notifications/notification/mention/_body.json.jbuilder
================
mention = notification.source

json.title "#{mention.mentioner.first_name} @mentioned you"
json.body mention.source.mentionable_content.truncate(200)

================
File: app/views/notifications/notification/_body.html.erb
================
<div class="card__body">
  <div class="avatar txt-x-small">
    <%= avatar_image_tag notification.creator %>
  </div>

  <h3 class="flex flex-column min-width flex-item-grow font-weight-normal">
    <%= render "notifications/notification/#{notification.source_type.underscore}/body", notification: notification %>
  </h3>
</div>

================
File: app/views/notifications/notification/_header.html.erb
================
<header class="card__header">
  <div class="card__board">
  <span class="card__id">
    <span class="for-screen-reader">Card number</span>
    <%= notification.card.number %>
  </span>
    <span class="card__board-name">
    <span class="overflow-ellipsis"><%= notification.card.board.name %></span>
  </span>
  </div>

  <div class="card__notification-meta overflow-ellipsis flex-item-grow flex-item-no-shrink txt-align-end">
    <span class="card__creator"><%= notification.creator.familiar_name %></span>
  </div>

  <div class="card__notification-meta overflow-ellipsis flex-item-no-shrink">
    <span class="card__timestamp"><%= local_datetime_tag(notification.created_at, style: :timeordate) %></span>
  </div>

  <div class="card__notification-meta flex-item-no-shrink">
    <%= yield %>
  </div>
</header>

================
File: app/views/notifications/readings/create.turbo_stream.erb
================
<%= turbo_stream.remove @notification %>
<%= turbo_stream.prepend :notifications_list_read, partial: "notifications/notification", locals: { notification: @notification } %>

================
File: app/views/notifications/readings/destroy.turbo_stream.erb
================
<%= turbo_stream.remove @notification %>
<%= turbo_stream.prepend :notifications_list, partial: "notifications/notification", locals: { notification: @notification } %>

================
File: app/views/notifications/settings/_board.html.erb
================
<%= turbo_frame_tag board, :involvement do %>
  <div class="flex align-center gap">
    <h2 class="txt-medium overflow-ellipsis">
      <%= board.name %>
    </h2>

    <hr class="separator--horizontal flex-item-grow" style="--border-color: var(--color-ink-medium); --border-style: dashed" aria-hidden="true">

    <label class="flex-item-no-shrink txt-small">
      <%= access_involvement_advance_button(board, user, show_watchers: false, icon_only: true) %>
    </label>
  </div>
<% end %>

================
File: app/views/notifications/settings/_browser.html.erb
================
<% unless (platform.safari? || platform.chrome?) && platform.ios? %>
  <div class="notifications-help" data-notifications-target="details">
    <% case
      when platform.firefox? && platform.android? %>
        <h2>Turn on notifications for <%= platform.browser.capitalize %>.</h2>
        <ol>
          <li>Tap <em><%= icon_tag "lock", alt: "the View site information button" %></em> in the address bar.</li>
          <li>Tap <em>Notification</em> to change to <em>Allowed</em>.</li>
        </ol>
      <% when platform.edge? && platform.desktop? %>
        <h2>Turn on notifications for this website.</h2>
        <ol>
          <li>Click <em><%= icon_tag "lock", alt: "the View site information button" %></em> left of the address bar.</li>
          <li>Under <em>Permissions for this site &gt; Notifications</em>, choose <em>Allow</em>.</li>
        </ol>
        <h2>Turn on notifications for <%= platform.browser.capitalize %>.</h2>
        <ol>
          <% if platform.windows? %>
            <li>Click <em>Start</em>, then <em>Settings</em>.</li>
            <li>Go to <em>System &gt; Notification</em>.</li>
            <li>Click <em><%= icon_tag "switch", alt: "the switch" %></em> <em>ON</em> for <%= platform.browser.capitalize %>.</li>
          <% else %>
            <li>Click <em aria-label="the Apple menu"></em> in the top left.</li>
            <li>Click <em>System Settings</em>.</li>
            <li>Click <em>Notifications</em>.</li>
            <li>Click <em><%= platform.browser.capitalize %></em>.</li>
            <li>Click <em><%= icon_tag "switch", alt: "the switch" %></em> to <em>Allow notifications</em>.</li>
          <% end %>
        </ol>
      <% when platform.firefox? && platform.desktop? %>
        <h2>Turn on notifications for this website.</h2>
        <ol>
          <li>Click <em><%= platform.browser.capitalize %></em> in the top left.</li>
          <li>Click <em>Settings</em>.</li>
          <li>Click <em>Privacy & Security</em> in the sidebar.</li>
          <li>Scroll down to <em>Permissions</em>.</li>
          <li>Click <em>Settings</em> next to <em>Notifications</em>.</li>
          <li>Select <em>Allow</em> next to <em><%= root_url %></em>.</li>
        </ol>

        <h2>Turn on notifications for <%= platform.browser.capitalize %>.</h2>
        <ol>
          <% if platform.windows? %>
            <li>Click <em>Start</em>, then <em>Settings</em>.</li>
            <li>Go to <em>System &gt; Notification</em>.</li>
            <li>Click <em><%= icon_tag "switch", alt: "the toggle button" %></em> <em>ON</em> for <%= platform.browser.capitalize %>.</li>
          <% else %>
            <li>Click <em aria-label="the Apple menu"></em> in the top left.</li>
            <li>Click <em>System Settings</em>.</li>
            <li>Click <em>Notifications</em>.</li>
            <li>Click <em><%= platform.browser.capitalize %></em>.</li>
            <li>Click <em><%= icon_tag "switch", alt: "the switch" %></em> to <em>Allow notifications</em>.</li>
          <% end %>
        </ol>
      <% when platform.chrome? && platform.desktop? %>
        <h2>Turn on notifications for this website.</h2>
        <ol>
          <li>Click the <em><%= icon_tag "sliders", alt: "View site information" %></em> icon in the address bar.</li>
          <li>Click <em>Site Settings</em>.</li>
          <li>Ensure notifications are <em>Allowed</em>.</li>
        </ol>

        <h2>Turn on notifications for <%= platform.browser.capitalize %>.</h2>
        <ol>
          <% if platform.windows? %>
            <li>Click <em>Start</em>, then <em>Settings</em>.</li>
            <li>Go to <em>System &gt; Notification</em>.</li>
            <li>Click <em><%= icon_tag "switch", alt: "the switch" %></em> <em>ON</em> for <%= platform.browser.capitalize %>.</li>
          <% else %>
            <li>Click <em aria-label="the Apple menu"></em> in the top left.</li>
            <li>Click <em>System Settings</em>.</li>
            <li>Click <em>Notifications</em>.</li>
            <li>Click <em><%= platform.browser == "Chrome" ? "Google Chrome" : platform.browser.capitalize %></em>.</li>
            <li>Click <em><%= icon_tag "switch", alt: "the switch" %></em> to <em>Allow notifications</em>.</li>
          <% end %>
        </ol>
      <% when platform.chrome? && platform.android? %>
        <h2>Turn on notifications for <%= platform.browser.capitalize %>.</h2>
        <ol>
          <li>Tap the <em><%= icon_tag "menu-dots-vertical", alt: "More options" %></em> menu button.</li>
          <li>Tap <em>Settings</em>.</li>
          <li>Tap <em>Notifications</em>.</li>
          <li>Tap <em><%= icon_tag "switch", alt: "the switch" %></em> to <em>Allow <%= platform.browser.capitalize %> notifications</em>.</li>
          <li>Tap <em><%= icon_tag "switch", alt: "the switch" %></em> next to <em>Web apps</em>.</li>
          <li>Tap <em><%= icon_tag "bell-alert", alt: "the notification bell" %></em> and select <em>Allow</em>.</li>
        </ol>
      <% when platform.safari? && platform.desktop? %>
        <h2>Turn on notifications for this website.</h2>
        <ol>
          <li>Click <em aria-label="the Apple menu"></em> in the top left.</li>
          <li>Click <em>System Settings</em>.</li>
          <li>Click <em>Notifications</em>.</li>
          <li>Click <em><%= request.base_url %></em> in the list.</li>
          <li>Click <em><%= icon_tag "switch", alt: "the switch" %></em> to <em>Allow notifications</em>.</li>
        </ol>
        <h2>Turn on notifications for <%= platform.browser.capitalize %>.</h2>
        <ol>
          <li>Click <em><%= platform.browser.capitalize %></em> in the top left.</li>
          <li>Click <em>Settings</em>.</li>
          <li>Click the <em>Websites</em> tab.</li>
          <li>Click <em>Notifications</em> in the sidebar.</li>
          <li>Click <em><%= request.base_url %></em> in the list.</li>
          <li>Select <em>Allow</em>.</li>
        </ol>
      <% else %>
        <p>Ensure notifications are enabled for <em><%= root_url %></em> in your web browser settings.</p>
    <% end %>
  </div>
<% end %>

================
File: app/views/notifications/settings/_email.html.erb
================
<section class="settings__section">
  <heading>
    <h2 class="divider">Email Notifications</h2>
    <div>Get a single email with all your notifications every few hours, daily, or weekly.</div>
  </heading>

  <%= form_with model: settings, url: notifications_settings_path,
      method: :patch, local: true, data: { controller: "form" } do |form| %>
    <div class="margin-block-end-half"><strong><%= form.label :bundle_email_frequency, "Email me about new notifications..." %></strong></div>
    <%= form.select :bundle_email_frequency, bundle_email_frequency_options_for(settings), {}, class: "input input--select txt-align-center", data: { action: "change->form#submit" } %>
  <% end %>
</section>

================
File: app/views/notifications/settings/_install.html.erb
================
<% unless (platform.chrome? && !platform.ios?) || (platform.firefox? && !platform.android?) %>
  <div class="notifications-help pwa__instructions hide-in-pwa">
    <h2><%= platform.safari? && platform.desktop? ? "or install" : "Install " -%> Fizzy as a web app.</h2>
    <% case
      when platform.edge? %>
        <ol>
          <li>Click <em><%= icon_tag "install-edge", alt: "the app available - install Fizzy button" %></em>in the address bar.</li>
          <li>Click <em>Install</em>.</li>
        </ol>
      <% when platform.chrome? && platform.android? %>
        <ol>
          <li>Tap the <em><%= icon_tag "menu-dots-vertical", alt: "More options" %></em> menu button.</li>
          <li>Tap <em>Install app</em> in the menu.</li>
        </ol>
      <% when platform.firefox? && platform.android? %>
        <ol>
          <li>Tap the <em><%= icon_tag "menu-dots-vertical", alt: "More options" %></em> menu button.</li>
          <li>Tap <em>Install</em> in the menu.</li>
        </ol>
      <% when platform.safari? && platform.desktop? %>
        <ol>
          <li>Click <em>File</em> in the top left.</li>
          <li>Click <em>Add to Dock</em>.</li>
        </ol>
      <% when (platform.safari? || platform.chrome?) && platform.ios? %>
        <p>To receive push notifications in <%= platform.browser.capitalize %> for <%= platform.operating_system %>, you must first install Fizzy as a web app.</p>
        <ol>
          <li>Tap <em><%= icon_tag "share", alt: "the share button" %></em></li>
          <li>Tap <em>Add to Home Screen</em>.</li>
        </ol>
      <% else %>
        <p>Some platforms require you to install Fizzy as a web app to receive push notifications.</p>
    <% end %>
  </div>
<% end %>

================
File: app/views/notifications/settings/_push_notifications.html.erb
================
<section class="notifications__status settings__section panel fill-shade center hide-on-native" data-controller="notifications" data-notifications-subscriptions-url-value="<%= user_push_subscriptions_path(Current.user) %>" data-notifications-enabled-class="notifications--on">
  <heading>
    <h2 class="txt-medium">
      Push notifications are
      <span class="notifications__on-message">ON</span>
      <span class="notifications__off-message">OFF</span>
    </h2>
  </heading>

  <div class="margin-block-start-half" data-notifications-target="subscribeButton" hidden>
    <button class="btn txt-small" data-action="notifications#attemptToSubscribe">
      <%= icon_tag "bell" %>
      <span>Turn ON push notifications on this device</span>
    </button>
  </div>

  <details class="margin-block-start-half" data-notifications-target="explainer">
    <summary class="btn txt-x-small">
      <%= icon_tag "lifebuoy" %>
      <span class="notifications__off-message">Help me fix this</span>
      <span class="notifications__on-message">Not receiving notifications?</span>
    </summary>

    <div class="notifications-help__explainer fill-white margin-block-start border-radius border txt-align-start">
      <p class="margin-none-block-start notifications__on-message">When push notifications arent working, this can usually be fixed by checking your notification settings to make sure theyre allowed.</p>
      <%= render partial: "notifications/settings/browser" %>
      <%= render partial: "notifications/settings/system" %>
      <%= render partial: "notifications/settings/install" %>
    </div>
  </details>
</section>

================
File: app/views/notifications/settings/_system.html.erb
================
<div class="notifications-help hide-in-browser" data-notifications-target="details">
  <h2>Check your <%= platform.operating_system %> settings</h2>
  <% case
    when platform.firefox? && platform.android? %>
      <ol>
        <li>Tap the <em><%= icon_tag "menu-dots-vertical.svg", alt: "More options" %></em> menu button.</li>
        <li>Tap <em>Settings</em>.</li>
        <li>Tap <em>Notifications</em>.</li>
        <li>Tap <em><%= icon_tag "switch", alt: "the toggle button" %></em> to <em>Allow <%= platform.browser.capitalize %> notifications</em>.</li>
      </ol>
    <% when platform.edge? && platform.desktop? %>
      <ol>
        <li>Click <em>Start</em>, then <em>Settings</em>.</li>
        <li>Go to <em>System &gt; Notification</em>.</li>
        <li>Click <em><%= icon_tag "switch", alt: "the toggle button" %></em> <em>ON</em> for Fizzy.</li>
      </ol>
    <% when (platform.firefox? || platform.chrome?) && platform.desktop? %>
      <ol>
        <% if platform.windows? %>
          <li>Click <em>Start</em>, then <em>Settings</em>.</li>
          <li>Go to <em>System &gt; Notification</em>.</li>
          <li>Click <em><%= icon_tag "switch", alt: "the toggle button" %></em> <em>ON</em> for Fizzy.</li>
        <% else %>
          <li>Click <em aria-label="the Apple menu"></em> in the top left.</li>
          <li>Click <em>System Settings</em>.</li>
          <li>Click <em>Notifications</em>.</li>
          <li>Click <em>Fizzy</em>.</li>
          <li>Click <em><%= icon_tag "switch", alt: "the allow notifications switch" %></em> to <em>Allow notifications</em>.</li>
        <% end %>
      </ol>
    <% when platform.safari? && platform.desktop? %>
      <ol>
        <li>Click <em aria-label="the Apple menu"></em> in the top left.</li>
        <li>Click <em>System Settings</em>.</li>
        <li>Click <em>Notifications</em>.</li>
        <li>Click <em>Fizzy</em>.</li>
        <li>Click <em><%= icon_tag "switch", alt: "the allow notifications switch" %></em> to <em>Allow notifications</em>.</li>
      </ol>
    <% when (platform.safari? || platform.chrome?) && platform.ios? %>
      <ol>
        <li>Open the <em><%= icon_tag "gear", aria: { hidden: "true" } %></em> Settings app.</li>
        <li>Scroll to and tap <em>Fizzy</em>.</li>
        <li>Tap <em>Notifications</em>.</li>
        <li>Tap <em><%= icon_tag "switch", alt: "the allow notifications switch button" %></em> to <em>Allow Notifications</em>.</li>
      </ol>
    <% when platform.chrome? && platform.android? %>
      <ol>
        <li>Open the <em><%= icon_tag "gear", aria: { hidden: "true" } %></em> Settings app.</li>
        <li>Tap <em>Notifications</em>.</li>
        <li>Tap <em>App notifications</em>.</li>
        <li>Scroll to <em>Fizzy</em>.</li>
        <li>Tap <em><%= icon_tag "switch", alt: "the switch" %></em> to <em>Allow Notifications</em>.</li>
      </ol>
    <% else %>
      <p>Ensure notifications are allowed for <%= platform.browser.capitalize %> in your system settings.</p>
  <% end %>
</div>

================
File: app/views/notifications/settings/show.html.erb
================
<% @page_title = "Notification Settings" %>

<% content_for :header do %>
  <h1 class="header__title" data-bridge--title-target="header"><%= @page_title %></h1>
<% end %>

<section class="settings margin-block-start-half">
  <div class="settings__panel settings__panel--users panel shadow">
    <section class="settings__section">
      <h2 class="divider">Boards</h2>
      <div class="settings__user-list flex flex-column gap-half">
        <%= render partial: "notifications/settings/board", collection: @boards, locals: { user: Current.user } %>
      </div>
    </section>
  </div>

  <div class="settings__panel panel shadow">
    <%= render "notifications/settings/push_notifications" %>
    <%= render "notifications/settings/email", settings: @settings %>
  </div>
</section>

================
File: app/views/notifications/trays/show.html.erb
================
<%= turbo_frame_tag "notifications" do %>
  <%= render partial: "notifications/notification", collection: @notifications, cached: true %>
  <div hidden data-notifications-tray-target="hiddenNotifications"></div>
<% end %>

================
File: app/views/notifications/unsubscribes/new.html.erb
================
<p>Unsubscribing from all email notifications as <%= @user.name %></p>

<div class="push_double--top centered delayed-fade-in">
  <%= auto_submit_form_with model: @user, url: notifications_unsubscribe_path(access_token: params[:access_token]), method: :post do |form| %>
    <%= form.submit "Unsubscribe now", class: "btn" %>
  <% end %>
</div>

================
File: app/views/notifications/unsubscribes/show.html.erb
================
<div class="panel margin-block-double center shadow">
  <h1 class="font-black txt-x-large margin-none-block-end">Youre unsubscribed</h1>
  <p class="margin-block-start-half">Thanks, <%= @user.first_name %>! Fizzy wont send you any more email notifications. If you change your mind, you can turn them back on in <%= link_to "Notification Settings", notifications_settings_path %>.</p>

  <%= link_to root_path, class: "btn btn--link margin-block-start" do %>
    <%= icon_tag "arrow-left" %>
    <span>Back to Fizzy</span>
  <% end %>
</div>

================
File: app/views/notifications/_notification.html.erb
================
<% cache notification do %>
  <%# Helper Dependency Updated: avatar_image_tag 2025-12-15 %>
  <%= notification_tag notification do %>
    <%= render "notifications/notification/header", notification: notification do %>
      <%= notification_toggle_read_button(notification, url: card_reading_path(notification.card)) %>
    <% end %>
    <%= render "notifications/notification/body", notification: notification %>
  <% end %>
<% end %>

================
File: app/views/notifications/_notification.json.jbuilder
================
json.cache! notification do
  json.(notification, :id)
  json.read notification.read?
  json.read_at notification.read_at&.utc
  json.created_at notification.created_at.utc

  json.partial! "notifications/notification/#{notification.source_type.underscore}/body", notification: notification

  json.creator notification.creator, partial: "users/user", as: :user

  json.card do
    json.(notification.card, :id, :title, :status)
    json.url card_url(notification.card)
  end

  json.url notification_url(notification)
end

================
File: app/views/notifications/_tray.html.erb
================
<%= turbo_stream_from Current.user, :notifications %>

<section class="tray tray--notifications" data-controller="dialog badge" data-badge-unread-class="unread" data-action="turbo:render#update" data-dialog-sizing-value="false">
  <dialog class="tray__dialog"
      data-controller="navigable-list"
      data-dialog-target="dialog"
      data-navigable-list-actionable-items-value="true"
      data-navigable-list-reverse-navigation-value="true"
      data-action="keydown->navigable-list#navigate dialog:show@document->navigable-list#reset turbo-visit->navigable-list#reset keydown.esc->dialog#close:stop click@document->dialog#closeOnClickOutside">
    <%= turbo_frame_tag "notifications", src: tray_notifications_path, refresh: "morph", data: {
          controller: "notifications-tray frame-reloader",
          notifications_tray_grouped_class: "notification--grouped",
          action: "turbo:frame-render->notifications-tray#group focus@window->frame-reloader#reload" } %>

    <div class="tray__item tray__item--hat txt-x-small gap-half">
      <div data-navigable-list-target="item" class="full-width">
        <%= link_to notifications_settings_path,
              class: "btn borderless tray__notification-settings",
              title: "Notification Settings",
              data: { action: "dialog#close" } do %>
          <%= icon_tag "settings" %>
          <span>Settings</span>
        <% end %>
      </div>

      <div data-navigable-list-target="item" class="full-width">
        <%= link_to notifications_path, class: "btn borderless flex-item-grow position-relative overflow-ellipsis", data: { action: "click->dialog#close" } do %>
          <%= icon_tag "bell" %>
          <span class="tray__new-notifications">See more new items</span>
          <span class="tray__old-notifications">See older items</span>
        <% end %>
      </div>

      <%= button_to bulk_reading_path(from_tray: true),
            class: "btn borderless tray__clear-notifications",
            title: "Mark all notifications as read",
            data: { action: "dialog#close badge#clear", turbo_frame: "notifications" },
            form: { class: "full-width", data: { navigable_list_target: "item" } } do %>
        <%= icon_tag "check" %>
        <span>Clear all</span>
      <% end %>
    </div>
  </dialog>

  <button class="tray__toggle" data-action="dialog#toggle keydown.n@document->hotkey#click" data-controller="hotkey" aria-label="Toggle notifications stack" aria-haspopup="true">
    <div class="tray__toggle-btn txt-uppercase btn btn--reversed txt-x-small center full-width">
      <%= icon_tag "bell" %>
      <span class="tray__toggle-text">Notifications <kbd class="hide-on-touch">N</kbd></span>
    </div>
  </button>
</section>

================
File: app/views/notifications/index.html.erb
================
<% @page_title = "Notifications" %>
<% @hide_footer_frames = true %>

<% content_for :header do %>
  <div class="header__actions header__actions--start">
    <%= back_link_to "Home", root_path, "keydown.left@document->hotkey#click keydown.esc@document->hotkey#click" %>
  </div>

  <h1 class="header__title" data-bridge--title-target="header"><%= @page_title %></h1>

  <div class="header__actions header__actions--end">
    <%= link_to notifications_settings_path, class: "btn btn--circle-mobile", data: { bridge__overflow_menu_target: "item", bridge_title: "Notification settings" } do %>
      <%= icon_tag "settings" %> <span class="for-screen-reader">Notification settings</span>
    <% end %>
  </div>
<% end %>

<div data-controller="badge navigable-list" data-badge-unread-class="unread" data-action="keydown@document->navigable-list#navigate" data-navigable-list-actionable-items-value="true"
      data-navigable-list-focus-on-selection-value="false">
  <%= render "notifications/index/unread_notifications", unread: @unread if @unread %>
  <%= render "notifications/index/read_notifications", page: @page %>
</div>

<%= notifications_next_page_link(@page) if @page.records.any? %>

================
File: app/views/notifications/index.json.jbuilder
================
json.array! (@unread || []) + @page.records, partial: "notifications/notification", as: :notification

================
File: app/views/notifications/index.turbo_stream.erb
================
<%= turbo_stream.append :notifications_list_read, partial: "notifications/notification", collection: @page.records %>
<%= turbo_stream.replace :next_page, notifications_next_page_link(@page) %>

================
File: app/views/prompts/boards/users/_user.html.erb
================
<lexxy-prompt-item search="<%= "#{user.name} #{user.initials} #{"me" if user == Current.user}" %>" sgid="<%= user.attachable_sgid %>">
  <template type="menu">
    <%= avatar_image_tag user %>
    <%= user.name %>
  </template>
  <template type="editor">
    <%= avatar_image_tag user %>
    <%= user.first_name %>
  </template>
</lexxy-prompt-item>

================
File: app/views/prompts/boards/users/index.html.erb
================
<%= render partial: "prompts/boards/users/user", collection: @users %>

================
File: app/views/prompts/cards/_card.html.erb
================
<lexxy-prompt-item>
  <template type="menu">
    #<%= card.number %> <%= card.title %>
  </template>
  <template type="editor">
    <%= link_to "##{card.number} #{card.title}", card_path(card) %>
  </template>
</lexxy-prompt-item>

================
File: app/views/prompts/cards/index.html.erb
================
<%= render partial: "prompts/cards/card", collection: @cards %>

================
File: app/views/prompts/commands/_command.html.erb
================
<% command, description, editor_version = command %>

<lexxy-prompt-item search="<%= description %> <%= command %>">
  <template type="menu">
    <code><%= command %></code> <%= description %>
  </template>
  <template type="editor">
    <%= editor_version.gsub(/ +$/, "&nbsp;").html_safe %>
  </template>
</lexxy-prompt-item>

================
File: app/views/prompts/commands/index.html.erb
================
<%= render partial: "prompts/commands/command", collection: @commands %>

================
File: app/views/prompts/tags/_tag.html.erb
================
<lexxy-prompt-item search="<%= tag.title %>" sgid="<%= tag.attachable_sgid %>">
  <template type="menu">
    #<%= tag.title %>
  </template>
  <template type="editor">
    #<%= tag.title %>
  </template>
</lexxy-prompt-item>

================
File: app/views/prompts/tags/index.html.erb
================
<%= render partial: "prompts/tags/tag", collection: @tags %>

================
File: app/views/prompts/users/index.html.erb
================
<%= render partial: "prompts/boards/users/user", collection: @users %>

================
File: app/views/public/boards/card_previews/index.turbo_stream.erb
================
<%= turbo_stream.remove "#{params[:target]}-load-page-#{@page.number}" %>

<%= turbo_stream.append params[:target] do %>
  <%= render partial: "cards/display/public_preview",
        board: @page.records, as: :card, locals: { draggable: true }, cached: true %>

  <% unless @page.last? %>
    <%= public_board_cards_next_page_link @board, params[:target], page: @page, fetch_on_visible: params[:target] == "closed-cards" %>
  <% end %>
<% end %>

================
File: app/views/public/boards/columns/closeds/show.html.erb
================
<% @page_title = "Column: Done" %>

<% content_for :header do %>
  <div class="header__actions header__actions--start">
    <%= back_link_to @board.name, published_board_url(@board), "keydown.left@document->hotkey#click keydown.esc@document->hotkey#click" %>
  </div>

  <h1 class="header__title divider divider--fade full-width" data-bridge--title-target="header">
    <span class="overflow-ellipsis"><%= @page_title %></span>
  </h1>
<% end %>

<section class="cards cards--grid">
  <%= turbo_frame_tag :closed_column do %>
    <div class="cards__list hide-scrollbar">
      <% if @page.used? %>
        <%= with_automatic_pagination :closed_column, @page do %>
          <%= render "cards/display/public_previews", cards: @page.records %>
        <% end %>
      <% else %>
        <div class="blank-slate">No cards here</div>
      <% end %>
    </div>
  <% end %>
</section>

<% content_for :footer do %>
  <%= render "public/footer" %>
<% end %>

================
File: app/views/public/boards/columns/not_nows/show.html.erb
================
<% @page_title = "Column: Not now" %>

<% content_for :header do %>
  <div class="header__actions header__actions--start">
    <%= back_link_to @board.name, published_board_url(@board), "keydown.left@document->hotkey#click keydown.esc@document->hotkey#click" %>
  </div>

  <h1 class="header__title divider divider--fade full-width" data-bridge--title-target="header">
    <span class="overflow-ellipsis"><%= @page_title %></span>
  </h1>
<% end %>

<section class="cards cards--grid">
  <%= turbo_frame_tag :not_now_column do %>
    <div class="cards__list hide-scrollbar">
      <% if @page.used? %>
        <%= with_automatic_pagination :not_now_column, @page do %>
          <%= render "cards/display/public_previews", cards: @page.records %>
        <% end %>
      <% else %>
        <div class="blank-slate">No cards here</div>
      <% end %>
    </div>
  <% end %>
</section>

<% content_for :footer do %>
  <%= render "public/footer" %>
<% end %>

================
File: app/views/public/boards/columns/streams/show.html.erb
================
<% @page_title = "Column: Maybe?" %>

<% content_for :header do %>
  <div class="header__actions header__actions--start">
    <%= back_link_to @board.name, published_board_url(@board), "keydown.left@document->hotkey#click keydown.esc@document->hotkey#click" %>
  </div>

  <h1 class="header__title divider divider--fade full-width" data-bridge--title-target="header">
    <span class="overflow-ellipsis"><%= @page_title %></span>
  </h1>
<% end %>

<section class="cards cards--grid">
  <%= turbo_frame_tag :stream_column do %>
    <div class="cards__list hide-scrollbar">
      <% if @page.used? %>
        <%= with_automatic_pagination :stream_column, @page do %>
          <%= render "cards/display/public_previews", cards: @page.records %>
        <% end %>
      <% else %>
        <div class="blank-slate">No cards here</div>
      <% end %>
    </div>
  <% end %>
</section>

<% content_for :footer do %>
  <%= render "public/footer" %>
<% end %>

================
File: app/views/public/boards/columns/show.html.erb
================
<% @page_title = "Column: #{ @column.name }" %>

<% content_for :header do %>
  <div class="header__actions header__actions--start">
    <%= back_link_to @column.board.name, published_board_url(@column.board), "keydown.left@document->hotkey#click keydown.esc@document->hotkey#click" %>
  </div>

  <h1 class="header__title divider divider--fade full-width" data-bridge--title-target="header">
    <span class="overflow-ellipsis"><%= @page_title %></span>
  </h1>
<% end %>

<section class="cards cards--grid">
  <%= turbo_frame_tag @column, :cards do %>
    <div class="cards__list hide-scrollbar">
      <% if @page.used? %>
        <%= with_automatic_pagination dom_id(@column, :cards), @page do %>
          <%= render "cards/display/public_previews", cards: @page.records %>
        <% end %>
      <% else %>
        <div class="blank-slate">No cards here</div>
      <% end %>
    </div>
  <% end %>
</section>

<% content_for :footer do %>
  <%= render "public/footer" %>
<% end %>

================
File: app/views/public/boards/show/_closed.html.erb
================
<section id="closed-cards" class="cards cards--closed is-collapsed" style="--card-color: var(--color-card-complete);"
  data-collapsible-columns-target="column"
  data-action="turbo:before-morph-attribute->collapsible-columns#preventToggle"
>

  <div class="cards__transition-container">
    <header class="cards__header">
      <%= render "boards/show/expander", title: "Done", count: board.cards.closed.count, column_id: "closed-cards" %>

      <%= link_to public_board_columns_closed_url(board.publication.key), class: "cards__maximize-button btn btn--circle txt-x-small borderless", data: { turbo_frame: "_top" } do %>
        <%= icon_tag "grid", class: "translucent" %>
        <span class="for-screen-reader">Maximize column</span>
      <% end %>
    </header>

    <%= column_frame_tag :closed_column, src: public_board_columns_closed_path(board.publication.key) %>
  </div>
</section>

================
File: app/views/public/boards/show/_column.html.erb
================
<section id="<%= dom_id(column) %>"
  class="cards cards--doing is-collapsed" style="--card-color: <%= column.color %>;"
  data-collapsible-columns-target="column"
  data-controller="clicker"
  data-action="turbo:before-morph-attribute->collapsible-columns#preventToggle"
>
  <div class="cards__transition-container">
    <header class="cards__header">
      <%= render "boards/show/expander", title: column.name, count: column.cards.active.count, column_id: dom_id(column) %>

      <%= link_to public_board_column_url(column.board.publication.key, column), class: "cards__maximize-button btn btn--circle txt-x-small borderless", data: { turbo_frame: "_top" } do %>
        <%= icon_tag "grid", class: "translucent" %>
        <span class="for-screen-reader">Maximize column</span>
      <% end %>
    </header>

    <%= column_frame_tag dom_id(column, :cards), src: public_board_column_path(column.board.publication.key, column) %>
  </div>
</section>

================
File: app/views/public/boards/show/_columns.html.erb
================
<%= turbo_frame_tag :cards_container do %>
  <div class="card-columns hide-scrollbar"
    data-controller="collapsible-columns"
    data-collapsible-columns-board-value="<%= board.id %>"
    data-collapsible-columns-collapsed-class="is-collapsed"
    data-collapsible-columns-expanded-class="is-expanded"
    data-collapsible-columns-no-transitions-class="no-transitions"
    data-collapsible-columns-title-not-visible-class="is-off-screen">

    <div class="card-columns__left">
      <%= render "public/boards/show/not_now", board: board %>
    </div>

    <%= render "public/boards/show/stream", board: board, page: page %>

    <div class="card-columns__right">
      <%= render partial: "public/boards/show/column", collection: board.columns, cached: true %>
      <%= render "public/boards/show/closed", board: board %>
    </div>
  </div>
<% end %>

================
File: app/views/public/boards/show/_not_now.html.erb
================
<section id="not-now" class="cards cards--on-deck is-collapsed" style="--card-color: var(--color-card-complete);"
  data-collapsible-columns-target="column"
  data-action="turbo:before-morph-attribute->collapsible-columns#preventToggle"
>

  <div class="cards__transition-container">
    <header class="cards__header">
      <%= render "boards/show/expander", title: "Not Now", count: board.cards.postponed.count, column_id: "not-now" %>

      <%= link_to public_board_columns_not_now_url(board.publication.key), class: "cards__maximize-button btn btn--circle txt-x-small borderless", data: { turbo_frame: "_top" } do %>
        <%= icon_tag "grid", class: "translucent" %>
        <span class="for-screen-reader">Maximize column</span>
      <% end %>
    </header>

    <%= column_frame_tag :not_now_column, src: public_board_columns_not_now_path(board.publication.key) %>
  </div>
</section>

================
File: app/views/public/boards/show/_stream.html.erb
================
<section id="maybe"
  class="cards cards--maybe is-expanded"
  data-column-name="Maybe?"
  data-collapsible-columns-target="column maybeColumn"
  data-action="turbo:before-morph-attribute->collapsible-columns#preventToggle">
  <div class="cards__transition-container">
    <header class="cards__header">
      <div hidden class="cards__expander">
        <h2 class="cards__expander-title" data-collapsible-columns-target="title">Maybe?</h2>
      </div>

      <%# render "boards/show/expander", title: "Maybe?", count: column.cards.active.count, column_id: dom_id(column) %>
      <%= render "boards/show/expander", title: "Maybe?", count: 2, column_id: "maybe" %>

      <%= link_to public_board_columns_stream_url(board.publication.key), class: "cards__maximize-button btn btn--circle txt-x-small borderless", data: { turbo_frame: "_top" } do %>
        <%= icon_tag "grid", class: "translucent" %>
        <span class="for-screen-reader">Maximize column</span>
      <% end %>
    </header>

    <%= column_frame_tag :stream_column, src: public_board_columns_stream_path(board.publication.key) %>
  </div>
</section>

================
File: app/views/public/boards/show.html.erb
================
<% @page_title = @board.name %>
<% @body_class = "contained-scrolling" %>

<% content_for :head do %>
  <%= tag.meta property: "og:title", content: "#{@board.name} | #{Current.account.name}" %>
  <%= tag.meta property: "og:description", content: format_excerpt(@board&.public_description, length: 200) %>
  <%= tag.meta property: "og:image", content: "#{request.base_url}/opengraph.png" %>
  <%= tag.meta property: "og:url", content: published_board_url(@board) %>

  <%= tag.meta property: "twitter:title", content: "#{@board.name} | #{Current.account.name}" %>
  <%= tag.meta property: "twitter:description", content: format_excerpt(@board&.public_description, length: 200) %>
  <%= tag.meta property: "twitter:image", content: "#{request.base_url}/opengraph.png" %>
  <%= tag.meta property: "twitter:card", content: "summary_large_image" %>
<% end %>

<% content_for :header do %>
  <h1 class="header__title divider divider--fade full-width" data-bridge--title-target="header">
    <span class="overflow-ellipsis"><%= @page_title %></span>
  </h1>
<% end %>

<% if @board.public_description.present? %>
  <div class="card__board-public-description rich-text-content txt-align-center center margin-block-end" data-controller="syntax-highlight">
    <%= @board.public_description %>
  </div>
<% end %>

<%= render "public/boards/show/columns", page: @page, board: @board %>

<% content_for :footer do %>
  <%= render "public/footer" %>
<% end %>

================
File: app/views/public/cards/show/_content.html.erb
================
<div class="card__content">
  <h1 class="card__title flex align-start gap-half">
    <%= tag.span card.title, class: "card__title-link" %>
  </h1>
  <div class="card__description rich-text-content" data-controller="syntax-highlight">
    <%= card.description %>
  </div>
</div>

================
File: app/views/public/cards/show/_steps.html.erb
================
<ol class="steps txt-small margin-block">
  <% card.steps.each do |step| %>
    <li class="step">
      <%= check_box_tag :completed, { class: "step__checkbox", disabled: true, checked: step.completed? } %>
      <%= tag.span step.content, class: "step__content" %>
    </li> 
  <% end %>
</ol>

================
File: app/views/public/cards/show.html.erb
================
<% @page_title = @card.title %>

<% content_for :head do %>
  <%= tag.meta property: "og:title", content: "#{@card.title} | #{@card.board.name}" %>
  <%= tag.meta property: "og:description", content: format_excerpt(@card&.description, length: 200) %>
  <%= tag.meta property: "og:image", content: @card.image.attached? ? "#{request.base_url}#{url_for(@card.image)}" : "#{request.base_url}/app-icon.png" %>
  <%= tag.meta property: "og:url", content: published_card_url(@card) %>

  <%= tag.meta property: "twitter:title", content: "#{@card.title} | #{@card.board.name}" %>
  <%= tag.meta property: "twitter:description", content: format_excerpt(@card&.description, length: 200) %>
  <%= tag.meta property: "twitter:image", content: @card.image.attached? ? "#{request.base_url}#{url_for(@card.image)}" : "#{request.base_url}/app-icon.png" %>
  <%= tag.meta property: "twitter:card", content: "summary_large_image" %>
<% end %>

<% content_for :header do %>
  <div class="header__actions header__actions--start">
    <%= back_link_to @card.board.name, published_board_url(@card.board), "keydown.left@document->hotkey#click keydown.esc@document->hotkey#click" %>
  </div>
<% end %>

<section id="<%= dom_id(@card, :card_container) %>"
  class="card-perma card-perma--public" data-controller="lightbox" style="--card-color: <%= @card.color %>;">
  <div class="card-perma__bg">
    <%= card_article_tag @card, class: "card" do %>
      <header class="card__header">
        <%= render "cards/display/preview/board", card: @card %>
        <%= render "cards/display/preview/tags", card: @card %>
      </header>

      <div class="card__body justify-space-between">
        <%= render "public/cards/show/content", card: @card %>
        <%= render "cards/display/public_preview/columns", card: @card if @card.open? %>
        <%= render "cards/display/common/stamp", card: @card %>
      </div>

      <%= render "public/cards/show/steps", card: @card %>

      <footer class="card__footer">
        <%= render "cards/display/public_preview/meta", card: @card %>
        <%= render "cards/display/perma/background", card: @card %>
      </footer>
    <% end %>
  </div>

  <%= render "layouts/lightbox" %>
</section>

<% content_for :footer do %>
  <%= render "public/footer" %>
<% end %>

================
File: app/views/public/_footer.html.erb
================
<div class="txt-align-center center margin-block-double txt-subtle txt-small">
  <%= render "layouts/shared/colophon" %>
</div>

================
File: app/views/pwa/manifest.json.erb
================
{
  "name": <%= [ "Fizzy", Rails.env.production? ? nil : Rails.env ].compact.join(" - ").to_json.html_safe %>,
  "icons": [
    {
      "src": "/app-icon-192.png",
      "type": "image/png",
      "sizes": "192x192"
    },
    {
      "src": "/app-icon.png",
      "type": "image/png",
      "sizes": "512x512"
    },
    {
      "src": "/app-icon-192-maskable.png",
      "type": "image/png",
      "sizes": "192x192",
      "purpose": "maskable"
    }
  ],
  "start_url": "/",
  "display": "standalone",
  "scope": "/",
  "description": "Card-up the biggest issues in your projects",
  "categories": ["bugs", "business", "productivity"],
  "shortcuts": [
    {
      "name": "Notifications",
      "description": "Catch up on recent notifications",
      "url": "<%= notifications_path %>",
      "icons": [{ "src": "<%= image_url("bell.svg") %>", "sizes": "any" }]
    },
    {
      "name": "Latest Activity",
      "description": "See whats new",
      "url": "<%= root_path %>",
      "icons": [{ "src": "<%= image_url("activity.svg") %>", "sizes": "any" }]
    }
  ]
}

================
File: app/views/pwa/service_worker.js
================
self.addEventListener('fetch', (event) => {
  if (event.request.method !== 'GET') return
  if (event.request.destination === 'document') {
    event.respondWith(
      fetch(event.request, { cache: 'no-cache' })
        .catch(() => caches.match(event.request))
    )
  }
})
self.addEventListener("push", (event) => {
  const data = event.data.json()
  event.waitUntil(Promise.all([ showNotification(data), updateBadgeCount(data.options) ]))
})
async function showNotification({ title, options }) {
  return self.registration.showNotification(title, options)
}
async function updateBadgeCount({ data: { badge } }) {
  return self.navigator.setAppBadge?.(badge || 0)
}
self.addEventListener("notificationclick", (event) => {
  event.notification.close()
  const url = new URL(event.notification.data.path, self.location.origin).href
  event.waitUntil(openURL(url))
})
async function openURL(url) {
  const clients = await self.clients.matchAll({ type: "window" })
  const focused = clients.find((client) => client.focused)
  if (focused) {
    await focused.navigate(url)
  } else {
    await self.clients.openWindow(url)
  }
}

================
File: app/views/reactions/_menu.html.erb
================
<div class="reaction__menu" data-controller="dialog" data-action="keydown.esc->dialog#close:stop click@document->dialog#closeOnClickOutside">
  <button class="reaction__menu-btn btn btn--circle borderless" data-action="click->dialog#open:stop" type="button">
    <%= icon_tag "reaction" %>
  </button>

  <dialog class="reaction__popup popup panel fill-white shadow" data-dialog-target="dialog">
    <div class="reaction__emoji-list">
      <% EmojiHelper::REACTIONS.each do |character, title| %>
        <%= tag.button character, title: title, class: "reaction__emoji-btn btn btn--circle borderless hide-focus-ring", type: "button", data: { action: "reaction-emoji#insertEmoji dialog#close", emoji: character } %>
      <% end %>
    </div>
  </dialog>
</div>

================
File: app/views/reactions/_reaction.html.erb
================
<div id="<%= dom_id(reaction) %>"
      class="reaction"
      data-controller="reaction-delete"
      data-reaction-delete-reacter-id-value="<%= reaction.reacter.id %>"
      data-controller="reaction-delete"
      data-reaction-delete-perform-class="reaction--deleting"
      data-reaction-delete-reveal-class="expanded"
      data-reaction-delete-deleteable-class="reaction--deleteable"
      data-reaction-delete-reacter-id-value="<%= reaction.reacter.id %>">
  <figure class="reaction__avatar margin-none flex-item-no-shrink">
    <%= avatar_tag reaction.reacter, aria: { label: "#{reaction.reacter.name} reacted #{reaction.content}" } %>
  </figure>

  <%= tag.span reaction.content, role: "button",
        class: [ "txt-small", { "txt-medium": reaction.all_emoji? } ],
        data: { action: "click->reaction-delete#reveal keydown.enter->reaction-delete#reveal:prevent", reaction_delete_target: "content" } %>

  <%= button_to polymorphic_path([ *reaction_path_prefix_for(reaction.reactable), reaction ]),
        method: :delete,
        class: "reaction__delete btn btn--negative flex-item-justify-end",
        data: { action: "reaction-delete#perform", reaction_delete_target: "button" } do %>
    <%= icon_tag "trash" %>
    <span class="for-screen-reader">Delete this reaction</span>
  <% end %>
</div>

<span id="delete_reaction_accessible_label" class="for-screen-reader">Press enter to delete this reaction</span>

================
File: app/views/reactions/_reaction.json.jbuilder
================
json.cache! reaction do
  json.(reaction, :id, :content)
  json.reacter reaction.reacter, partial: "users/user", as: :user
  json.url polymorphic_url([ *reaction_path_prefix_for(reaction.reactable), reaction ])
end

================
File: app/views/reactions/_reactions.html.erb
================
<%= turbo_frame_tag reactable, :reacting do %>
  <div class="reactions">
    <div id="<%= dom_id(reactable, :reactions) %>" class="reactions__list">
      <%= render partial: "reactions/reaction", collection: reactable.reactions %>
    </div>

    <%= turbo_frame_tag reactable, :new_reaction do %>
      <%= link_to new_polymorphic_path([ *reaction_path_prefix_for(reactable), :reaction ]), role: "button",
            class: "reactions__trigger btn btn--circle", action: "soft-keyboard#open",
            data: { turbo_frame: dom_id(reactable, :new_reaction), action: "dialog#close" } do %>
        <%= image_tag "boost-color.svg", aria: { hidden: true } %>
        <span class="for-screen-reader">Add your own reaction</span>
      <% end %>
    <% end %>
  </div>
<% end %>

================
File: app/views/reactions/create.turbo_stream.erb
================
<%= turbo_stream.replace([ @reactable, :reacting ]) do %>
  <%= render "reactions/reactions", reactable: @reactable.reload %>
<% end %>

================
File: app/views/reactions/destroy.turbo_stream.erb
================
<%= turbo_stream.remove @reaction %>

================
File: app/views/reactions/index.html.erb
================
<%= render "reactions/reactions", reactable: @reactable %>

================
File: app/views/reactions/index.json.jbuilder
================
json.array! @reactable.reactions.ordered, partial: "reactions/reaction", as: :reaction

================
File: app/views/reactions/new.html.erb
================
<%= turbo_frame_tag @reactable, :new_reaction do %>
  <%= form_with model: [ *reaction_path_prefix_for(@reactable), Reaction.new ],
        class: "reaction reaction__form expanded",
        html: { aria: { label: "New reaction" } },
        data: { controller: "form reaction-emoji", turbo_frame: dom_id(@reactable, :reacting), action: "keydown.esc->form#cancel submit->form#preventEmptySubmit submit->form#preventComposingSubmit" } do |form| %>
    <label class="reaction__form-label flex gap" style="--column-gap: 0.4ch;">
      <figure class="reaction__avatar margin-none flex-item-no-shrink">
        <%= avatar_tag Current.user %>
      </figure>

      <%= form.text_field :content, autofocus: true, autocomplete: "off", autocorrect: "off", maxlength: 16,
            pattern: /\S+.*/, class: "input reaction__input txt-small", data: { form_target: "input", reaction_emoji_target: "input", action: "compositionstart->form#compositionStart compositionend->form#compositionEnd" }, aria: { label: "Add a reaction" } %>
    </label>

    <%= render "reactions/menu" %>

    <%= form.button class: "reaction__submit-btn btn btn--circle borderless", type: "submit", data: { form_target: "submit" } do %>
      <%= icon_tag "check-circle" %> <span class="for-screen-reader">Submit</span>
    <% end %>

    <%= link_to polymorphic_path([ *reaction_path_prefix_for(@reactable), :reactions ]), role: "button",
          data: { turbo_frame: dom_id(@reactable, :reacting), form_target: "cancel" }, class: "reaction__cancel-btn btn btn--circle borderless" do %>
      <%= icon_tag "close-circle" %> <span class="for-screen-reader">Cancel</span>
    <% end %>
  <% end %>
<% end %>

================
File: app/views/searches/_form.html.erb
================
<%= form_with url: search_path, method: :get, class: "search__form flex align-center justify-center gap-half", data: { bar_target: "form", turbo_frame: defined?(target_turbo_frame) ? target_turbo_frame : nil } do |form| %>
  <%= form.label :q, "Search Fizzy", class: "font-weight-black txt-nowrap" %>
  <%= text_field_tag :q, query_terms,
        class: "search__input input",
        type: "search",
        placeholder: "Find something",
        autocomplete: "off",
        autofocus: true,
        data: {
          bar_target: "searchInput",
          action: "keydown.enter->bar#showModalAndSubmit:prevent keydown.esc->bar#reset" } %>
  <button class="search__reset btn btn--circle borderless" data-action="bar#clearInput">
    <%= icon_tag "close" %>
    <span class="for-screen-reader">Close search</span>
  </button>
<% end %>

================
File: app/views/searches/_result.html.erb
================
<li>
  <%= link_to result.source, class: "search__result", data: { turbo_frame: "_top", action: "bar#reset" } do %>
    <div>
      <h3 class="search__title txt--medium margin-none">
        # <%= result.card.number %> <%= result.card_title %>
      </h3>

      <% if result.comment.present? %>
        <div class="search__excerpt search__excerpt--comment">
          <%= avatar_preview_tag result.card.creator %>
          <div><%= result.comment_body %></div>
        </div>
      <% elsif result.card_id.present? %>
        <div class="search__excerpt"><%= result.card_description %></div>
      <% end %>
    </div>
    <div class="overflow-ellipsis translucent txt-ink">
      <%= result.card.board.name %>  <%= local_datetime_tag(result.created_at, style: :timeordate) %>
    </div>
  <% end %>
</li>

================
File: app/views/searches/_results.html.erb
================
<section class="search">
  <div class="search__results">
    <% unless page.used? %>
      <div class="search__blank-slate blank-slate">
        No matches
      </div>
    <% end %>

    <ul class="search__list">
      <%= with_automatic_pagination :filtered_search_results, page do %>
        <%= render partial: "searches/result", collection: page.records %>
      <% end %>
    </ul>
  </div>
</section>

================
File: app/views/searches/show.html.erb
================
<% @page_title = params.has_key?(:q) ? "Search results for \"#{params[:q]}\"" : "Search" %>

<% content_for :header do %>
  <div class="header__actions header__actions--start">
    <%= back_link_to "Home", root_path, "keydown.left@document->hotkey#click keydown.esc@document->hotkey#click" %>
  </div>

  <h1 class="header__title" data-bridge--title-target="header"><%= @page_title %></h1>
<% end %>

<div class="search-perma margin-block-start">
  <%= render "form", query_terms: params[:q] %>
  <%= turbo_frame_tag "bar_content" do %>
    <% if @card %>
      <%= auto_submit_form_with url: card_path(@card), method: :get, data: { turbo_action: "advance", turbo_frame: "_top", search_redirect: true } %>
    <% else %>
      <%= render "results", page: @page %>
    <% end %>
  <% end %>
</div>

================
File: app/views/sessions/magic_links/show.html.erb
================
<% @page_title = "Check your email" %>

<div class="panel panel--centered flex flex-column gap-half <%= "shake" if flash[:alert] || flash[:shake] %>">
  <header>
    <h1 class="txt-x-large font-weight-black margin-none"><%= @page_title %></h1>
    <p class="margin-none-block-start txt-medium txt-balance">
      Then enter the verification code included in the email below:
    </p>
  </header>

  <%= form_with url: session_magic_link_path, method: :post, html: { data: { controller: "magic-link" } } do |form| %>
    <%= form.text_field :code, required: true, class: "input center txt-align-enter txt-large txt-uppercase",
        autofocus: true, autocorrect: "off", autocapitalize: "off", spellcheck: "false", "data-1p-ignore": true,
        autocomplete: "one-time-code", maxlength: "6", placeholder: "", value: params[:code],
        data: { magic_link_target: "input", action: "keydown.enter->magic-link#submitOnEnter paste->magic-link#submitOnPaste" } %>
  <% end %>

  <p class="txt-small txt-balance">The code sent to <strong><%= email_address_pending_authentication %></strong> will work for <%= distance_of_time_in_words(MagicLink::EXPIRATION_TIME) %>.</p>
</div>

<% if Rails.env.development? && flash[:magic_link_code].present? %>
  <div class="flex align-center justify-center gap fill-shade border-radius pad margin-block-start full-width position-relative" style="animation: slide-up-fade-in 400ms ease-out both; max-width: 42ch; overflow: hidden;">
    <span class="txt-uppercase translucent txt-tight-lines">Psst, here's your code:</span>
    <code class="txt-large font-weight-black txt-tight-lines"><%= flash[:magic_link_code] %></code>
    <span class="txt-xx-small txt-uppercase font-weight-black txt-align-center flex align-center justify-center" style="position: absolute; top: 0; bottom: 0; left: 0; background: var(--color-ink-lighter); padding: 0 0.5em; writing-mode: vertical-rl; transform: rotate(180deg); line-height: 1;">DEV</span>
  </div>
<% end %>

<% content_for :footer do %>
  <%= render "sessions/footer" %>
<% end %>

================
File: app/views/sessions/menus/show.html.erb
================
<% @page_title = "Choose an account" %>

<% cache [ Current.identity, @accounts ] do %>
  <section
    class="panel panel--centered flex flex-column gap"
    style="--popup-icon-size: 24px; --popup-item-padding-inline: 0.5rem;"
  >
    <% if @accounts.any? %>
      <h1 class="txt-x-large font-weight-black txt-tight-lines margin-none">
        Your Fizzy accounts
      </h1>
      <menu class="popup__list pad border-radius border" style="--block-space: var(--inline-space);">
        <% @accounts.each do |account| %>
          <li class="popup__item txt-medium">
            <%= icon_tag "marker", class: "popup__icon" %>
            <%= link_to landing_path(script_name: account.slug), class: "btn overflow-ellipsis fill-transparent popup__btn" do %>
              <strong><%= account.name %></strong>
            <% end %>
          </li>
        <% end %>
      </menu>
    <% else %>
      <h1 class="txt-x-large font-weight-black margin-none">Hmm...</h1>
      <p class="margin-none-block-start">You dont have any Fizzy accounts.</p>
    <% end %>

    <%= link_to new_signup_path, class: "btn center txt-small margin-block-start", data: { turbo_prefetch: false } do %>
      <span>Sign up for a new Fizzy account</span>
    <% end %>

    <%= link_to new_account_import_path, class: "btn btn--plain txt-link center txt-small", data: { turbo_prefetch: false } do %>
      <span>Import an exported account</span>
    <% end %>
  </section>
<% end %>

<% content_for :footer do %>
  <%= render "sessions/footer" %>
<% end %>

================
File: app/views/sessions/starts/new.html.erb
================
<% @hide_footer_frames = true %>
<% @page_title = "Signing in..." %>

<div class="panel panel--centered flex flex-column gap-half">
  <header>
    <h1 class="txt-x-large font-weight-black margin-none">
      <%= @page_title %>
    </h1>
    <p class="margin-none">Just a sec while we sign you in with <%= Current.account.name %>.</p>
  </header>

  <%= form_with url: session_start_path, method: :post, data: { controller: "form auto-submit" } do |form| %>
    <%= form.button "Sign in", type: "submit", class: "btn btn-primary", data: { form_target: "submit", turbo_submits_with: "Signing in..." } %>
  <% end %>
</div>

<% content_for :footer do %>
  <%= render "sessions/footer" %>
<% end %>

================
File: app/views/sessions/transfers/show.html.erb
================
<%= auto_submit_form_with method: :put %>

================
File: app/views/sessions/_footer.html.erb
================
<div class="pad-inline txt-align-center center margin-block-double txt-subtle txt-small">
  <%= render "layouts/shared/colophon" %>.
  Need help? <%= mail_to "support@fizzy.do", "Send us an email", class: "txt-link" %>.
</div>

================
File: app/views/sessions/new.html.erb
================
<% @page_title = "Enter your email" %>

<div class="panel panel--centered flex flex-column gap-half">
  <h1 class="txt-x-large font-weight-black margin-block-end">Get into Fizzy</h1>

  <%= form_with url: session_path, class: "flex flex-column gap-half txt-medium" do |form| %>
    <div class="flex align-center gap">
      <label class="flex align-center gap input input--actor">
        <%= form.email_field :email_address, required: true, class: "input txt-large full-width", autofocus: true, autocomplete: "username", placeholder: "Enter your email address" %>
      </label>
    </div>

    <% if Account.accepting_signups? %>
      <p><strong>New here?</strong> <%= link_to "Sign up", new_signup_path %> to create an account. <strong>Already have an account?</strong> Enter your email and well get you signed in.</p>
    <% else %>
      <p>Enter your email and well get you signed in.</p>
    <% end %>

    <button type="submit" id="log_in" class="btn btn--link center txt-medium">
      <span>Lets go</span>
      <%= icon_tag "arrow-right" %>
    </button>
  <% end %>
</div>

<% content_for :footer do %>
  <%= render "sessions/footer" %>
<% end %>

================
File: app/views/signups/completions/new.html.erb
================
<% @page_title = "Complete your sign-up" %>

<div class="panel panel--centered flex flex-column gap-half <%= "shake" if flash[:alert] %>">
  <h1 class="txt-x-large font-weight-black margin-block-end"><%= @page_title %></h1>

  <%= form_with model: @signup, url: signup_completion_path, scope: "signup", class: "flex flex-column gap", data: { controller: "form" } do |form| %>
    <%= form.text_field :full_name, class: "input txt-large", autocomplete: "name", placeholder: "Enter your full name", autofocus: true, required: true, maxlength: 240 %>

    <p>You're one step away. Just enter your name to get your own Fizzy account.</p>

    <% if @signup.errors.any? %>
      <div class="margin-block-half txt-negative txt-small" style="text-align: left;">
        <p class="margin-block-none font-weight-bold">Your changes couldn't be saved:</p>
        <ul class="margin-block-none">
          <% @signup.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <button type="submit" class="btn btn--link center" data-form-target="submit">
      <span>Continue</span>
      <%= icon_tag "arrow-right" %>
    </button>
  <% end %>
</div>

<% content_for :footer do %>
  <%= render "sessions/footer" %>
<% end %>

================
File: app/views/signups/new.html.erb
================
<% @page_title = "Signup for Fizzy" %>

<div class="panel panel--centered flex flex-column gap-half">
  <h1 class="txt-x-large font-weight-black margin-block-end">Sign up</h1>

  <%= form_with model: @signup, url: signup_path, scope: "signup", class: "flex flex-column gap", data: { turbo: false, controller: "form" } do |form| %>
    <div class="flex align-center gap">
      <label class="flex align-center gap input input--actor">
        <%= form.email_field :email_address, required: true, class: "input txt-large full-width", autofocus: true, autocomplete: "username", placeholder: "Enter your email address" %>
      </label>
    </div>

    <p>Enter your email to create an account.</p>

    <button type="submit" id="log_in" class="btn btn--link center txt-medium">
      <span>Lets go</span>
      <%= icon_tag "arrow-right" %>
    </button>
  <% end %>
</div>

<% content_for :footer do %>
  <%= render "sessions/footer" %>
<% end %>

================
File: app/views/tags/_tag.json.jbuilder
================
json.cache! tag do
  json.(tag, :id, :title)
  json.created_at tag.created_at.utc
  json.url cards_url(tag_ids: [ tag ])
end

================
File: app/views/tags/index.html.erb
================
<section class="panel borderless center margin pad">
  <h1>All tags</h1>
  <ul class="txt-align-start">
    <% @tags.each do |tag| %>
      <li class="flex align-start justify-space-between gap pad" style="border-block-end: 1px solid var(--color-ink-lighter)">
        <span>
          <strong class="txt-nowrap"><%= tag.title %></strong>
        </span>

        <span>
          <%= tag.cards.pluck(:title).to_sentence %>
        </span>

        <%= button_to tag_path(tag), class: "btn txt-small", method: :delete, data: { turbo_confirm: "Are you sure?" } do %>
          <%= icon_tag "remove" %>
          <span class="for-screen-reader">Delete</span>
        <% end %>
      </li>
    <% end %>
  </ul>
</section>

================
File: app/views/tags/index.json.jbuilder
================
json.array! @page.records, partial: "tags/tag", as: :tag

================
File: app/views/user_mailer/email_change_confirmation.html.erb
================
<p class="subtitle">Confirm your email address change</p>

<%= link_to "Yes use this email address", user_email_address_confirmation_url(script_name: @user.account.slug, user_id: @user.id, email_address_token: @token), class: "btn" %>

<p class="margin-block-start-double">If you didnt request this change, you can ignore this email. Your email address WILL NOT be changed unless you hit the button.</p>

<p class="footer">Need help? <%= mail_to "support@fizzy.do", "Send us an email"%>.
</p>

================
File: app/views/users/avatars/show.svg.erb
================
<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  viewBox="0 0 512 512" class="avatar" aria-hidden="true">
  <defs>
    <clipPath id="porthole">
      <circle cx="50%" cy="50%" r="50%" />
    </clipPath>
  </defs>

  <g>
    <rect width="100%" height="100%" rx="50" fill="<%= avatar_background_color(@user) %>" />

    <text x="50%" y="50%" fill="#FFFFFF"
      text-anchor="middle" dy="0.35em"
      <%=raw 'textLength="85%" lengthAdjust="spacingAndGlyphs"' if @user.initials.size >= 3 %>
      font-family="-apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial, sans-serif"
      font-size="230"
      font-weight="800"
      letter-spacing="-5">
      <%= @user.initials %>
    </text>
  </g>
</svg>

================
File: app/views/users/data_exports/show.html.erb
================
<% if @export.present? %>
  <% @page_title = "Download Export" %>
<% else %>
  <% @page_title = "Download Expired" %>
<% end %>

<% content_for :header do %>
  <div class="header__actions header__actions--start">
    <%= back_link_to @user.name, user_path(@user), "keydown.left@document->hotkey#click keydown.esc@document->hotkey#click" %>
  </div>
<% end %>

<div class="panel panel--wide shadow center flex flex-column align-center gap">
  <h2 class="txt-large font-weight-black margin-none"><%= @page_title %></h2>

  <% if @export.present? %>
    <div>Your export is ready. The download should start automatically.</div>

    <%= link_to "Download your data", rails_blob_path(@export.file, disposition: "attachment"),
          id: "download-link",
          class: "btn btn--link",
          data: { turbo: false, controller: "auto-click" } %>
  <% else %>
    <div>That download link has expired. You'll need to <%= link_to "request a new export", user_path(@user), class: "txt-link" %>.</div>
  <% end %>

</div>

================
File: app/views/users/email_addresses/confirmations/invalid_token.html.erb
================
<% @page_title = "Link expired" %>

<div class="panel panel--centered center flex flex-column gap-half" style="--panel-size: 50ch;">
  <h1 class="txt-x-large font-weight-black margin-none">
    <%= @page_title %>
  </h1>
  <p class="margin-none-block-start margin-block-end-half">
    That email confirmation link is no longer validthey expire after 30 minutes. Youll have to try again.
  </p>

  <%= link_to "Change my email address", new_user_email_address_path(user_id: @user, script_name: @user.account.slug), class: "btn btn--link center" %>

  <p class="txt-small txt-subtle">
    If you get stuck, <%= mail_to "support@fizzy.do", "send us an email" %> and well get you back on track.
  </p>
</div>

================
File: app/views/users/email_addresses/confirmations/show.html.erb
================
<% @page_title = "Confirm email change" %>

<div class="panel panel--centered center flex flex-column gap-half" style="--panel-size: 45ch;">
  <header>
    <h1 class="txt-x-large font-weight-black margin-none">
      <%= @page_title %>
    </h1>
    <p class="margin-none-block-start margin-block-end-half">Just a sec while we confirm your new email address.</p>
  </header>

  <%= form_with url: user_email_address_confirmation_path(user_id: @user.id), method: :post, data: { controller: "form auto-submit" } do |form| %>
    <%= form.hidden_field :email_address_token, value: params[:email_address_token] %>

    <button type="submit" class="btn btn--link center" data-form-target="submit">
      <span>Done</span>
    </button>
  <% end %>
</div>

================
File: app/views/users/email_addresses/create.html.erb
================
<% @page_title = "Confirm your new email address" %>

<% content_for :header do %>
  <div class="header__actions header__actions--start">
    <%= back_link_to "My profile", edit_user_path(@user, script_name: @user.account.slug), "keydown.left@document->hotkey#click keydown.esc@document->hotkey#click" %>
  </div>
<% end %>

<div class="panel panel--centered flex flex-column gap-half" style="--panel-size: 50ch;">
  <h1 class="txt-x-large font-weight-black margin-none">Check your email</h1>
  <p class="margin-none">We just sent an email to <strong><%= params[:email_address] %></strong></p>
  <p class="margin-none-block-start margin-block-end-half">Hit the link in the email to confirm this is the email address you want to use with Fizzy going forward.</p>

  <%= link_to "Done", edit_user_path(@user, script_name: @user.account.slug), class: "btn btn--link center" %>
</div>

================
File: app/views/users/email_addresses/new.html.erb
================
<% @page_title = "Change your email" %>

<% content_for :header do %>
  <div class="header__actions header__actions--start">
    <%= back_link_to "My profile", edit_user_path(@user, script_name: @user.account.slug), "keydown.left@document->hotkey#click keydown.esc@document->hotkey#click" %>
  </div>
<% end %>

<div class="panel panel--centered flex flex-column gap-half" style="--panel-size: 45ch;">
  <h1 class="txt-x-large font-weight-black margin-none">
    <%= @page_title %>
  </h1>

  <%= form_with url: user_email_addresses_path(user_id: @user.id), method: :post, class: "flex flex-column gap-half", data: { controller: "form", turbo: false } do |form| %>
    <div class="flex align-center gap-half">
      <label class="flex align-center gap input input--actor">
        <%= form.email_field :email_address, class: "input full-width", autocomplete: "email", placeholder: "New email address", autofocus: true, required: true %>
      </label>
    </div>

    <p class="margin-none-block-start margin-block-end-half">Enter your new email address, then check your email to confirm the change.</p>

    <button type="submit" class="btn btn--link center" data-form-target="submit">
      <span>Continue</span>
      <%= icon_tag "arrow-right" %>
    </button>
  <% end %>
</div>

================
File: app/views/users/events/show.html.erb
================
<turbo-frame id="user_events">
  <h1 class="font-weight-black txt-large margin-block-double"><%= "What #{Current.user == @user ? "have you" : "has #{@user.first_name}"} been up to?" %></h1>

  <div class="events margin-block-double" id="activity" data-controller="pagination" data-pagination-paginate-on-intersection-value="true">
    <%= day_timeline_pagination_frame_tag @day_timeline do %>
      <%= render "events/day", day_timeline: @day_timeline %>

      <% if @day_timeline.next_day %>
        <%= link_to "Load more", user_events_path(@user, day: @day_timeline.next_day.strftime("%Y-%m-%d"), **@filter.as_params),
              class: "day-timeline-pagination-link", data: { frame: day_timeline_pagination_frame_id_for(@day_timeline.next_day), pagination_target: "paginationLink" } %>
      <% end %>
    <% end %>
  </div>
</turbo-frame>

================
File: app/views/users/joins/new.html.erb
================
<% @page_title = "Great! Now enter your name" %>

<div class="panel panel--centered flex flex-column gap-half">
  <h1 class="txt-large font-weight-black margin-none"><%= @page_title %></h1>

  <%= form_with scope: "user", url: users_joins_path, class: "flex flex-column gap txt-medium", data: { controller: "form" } do |form| %>
    <div class="flex align-center gap">
      <label class="flex align-center gap input input--actor">
        <%= form.text_field :name, class: "input full-width", autocomplete: "name", placeholder: "Full name", autofocus: true, required: true, data: { "1p-ignore": true } %>
      </label>
    </div>

    <button type="submit" id="log_in" class="btn btn--link center" data-form-target="submit">
      <span>Continue</span>
      <%= icon_tag "arrow-right" %>
    </button>
  <% end %>
</div>

<% content_for :footer do %>
  <%= render "sessions/footer" %>
<% end %>

================
File: app/views/users/verifications/new.html.erb
================
<%= auto_submit_form_with url: users_verifications_path, method: :post %>

================
File: app/views/users/_access_tokens.html.erb
================
<section class="settings__section flex flex-column align-center">
  <header>
    <h2 class="divider">Developer</h2>
    <div>Manage <%= link_to "personal access tokens", my_access_tokens_path, class: "btn btn--plain txt-link" %> used with the Fizzy developer API.</div>
  </header>
</section>

================
File: app/views/users/_activity_timeline.html.erb
================
<div class="events margin-block-double" id="activity" data-controller="pagination" data-pagination-paginate-on-intersection-value="true">
  <%= day_timeline_pagination_frame_tag day_timeline do %>
    <%= render "events/day", day_timeline: day_timeline %>

    <% if day_timeline.next_day %>
      <%= link_to "Load more", user_path(user, day: day_timeline.next_day.strftime("%Y-%m-%d"), **filter.as_params),
            class: "day-timeline-pagination-link", data: { frame: day_timeline_pagination_frame_id_for(day_timeline.next_day), pagination_target: "paginationLink" } %>
    <% end %>
  <% end %>
</div>

================
File: app/views/users/_attachable.html.erb
================
<%= avatar_image_tag user %>
<%= user.first_name %>

================
File: app/views/users/_data_export.html.erb
================
<section class="settings__section">
  <header>
    <h2 class="divider">Export your data</h2>
    <div>Download an archive of your Fizzy data.</div>
  </header>

  <div data-controller="dialog" data-dialog-modal-value="true" data-action="keydown.esc->dialog#close">
    <button type="button" class="btn" data-action="dialog#open">Begin export...</button>

    <dialog class="dialog panel panel--wide shadow" data-dialog-target="dialog" style="--panel-size: 48ch;">
      <h2 class="txt-large">Export your data</h2>
      <p>This will generate a ZIP archive of all cards you have access to.</p>
      <p>Well email you a link to download the file when its ready. The link will expire after 24 hours.</p>

      <div class="flex gap justify-center">
        <%= button_to "Start export", user_data_exports_path(@user), method: :post, class: "btn btn--link", form: { data: { action: "submit->dialog#close" } } %>
        <button type="button" class="btn" data-action="dialog#close">Cancel</button>
      </div>
    </dialog>
  </div>
</section>

================
File: app/views/users/_theme.html.erb
================
<section class="settings__section">
  <header>
    <h2 class="divider">Appearance</h2>
  </header>

  <div class="theme-switcher flex gap max-width justify-center txt-small margin-block-start-half">
    <label class="btn theme-switcher__btn">
      <%= icon_tag "sun" %>
      <span class="overflow-ellipsis">Always light</span>
      <input type="radio" name="theme" data-action="click->theme#setLight" data-theme-target="lightButton">
    </label>

    <label class="btn theme-switcher__btn" >
      <%= icon_tag "moon" %>
      <span class="overflow-ellipsis">Always dark</span>
      <input type="radio" name="theme" data-action="click->theme#setDark" data-theme-target="darkButton">
    </label>

    <label class="btn theme-switcher__btn">
      <%= icon_tag "monitor" %>
      <span class="overflow-ellipsis">Same as OS</span>
      <input type="radio" name="theme" data-action="click->theme#setAuto" data-theme-target="autoButton">
    </label>
  </div>
</section>

================
File: app/views/users/_transfer.html.erb
================
<section class="settings__section">
  <% url = session_transfer_url(user.identity.transfer_id, script_name: nil) %>

  <header>
    <h2 class="divider">Devices</h2>
    <p class="margin-none" id="session_transfer_label">Link to automatically log in on another device.</p>
  </header>

  <input type="text" class="input fill-white" id="session_transfer_url" value="<%= url %>" aria-labelledby="session_transfer_label" readonly>

  <div class="flex justify-center gap">
    <div data-controller="dialog" data-dialog-modal-value="true" class="flex-inline">
      <%= tag.button class: "btn", data: { action: "dialog#open", controller: "tooltip" } do %>
        <%= icon_tag "qr-code" %>
        <span class="for-screen-reader">Display auto-login QR code</span>
      <% end %>

      <dialog class="dialog panel shadow" data-dialog-target="dialog">
        <%= qr_code_image(url) %>

        <form method="dialog" class="margin-block-start flex justify-center">
          <button class="btn" data-controller="tooltip">
            <%= icon_tag "remove" %>
            <span class="for-screen-reader">Close dialog</span>
          </button>
        </form>
      </dialog>
    </div>

    <%= button_to_copy_to_clipboard(url) do %>
      <%= icon_tag "copy-paste" %>
      <span class="for-screen-reader">Copy auto-login link</span>
    <% end %>
  </div>
</section>

================
File: app/views/users/_user.json.jbuilder
================
json.cache! user do
  json.(user, :id, :name, :role, :active)

  json.email_address user.identity&.email_address
  json.created_at user.created_at.utc

  json.url user_url(user)
end

================
File: app/views/users/edit.html.erb
================
<% @page_title = "Edit your profile" %>

<% content_for :header do %>
  <div class="header__actions header__actions--start">
    <%= back_link_to "profile", user_path(@user), "keydown.left@document->hotkey#click keydown.esc@document->hotkey#click" %>
  </div>
<% end %>

<div class="panel shadow center" style="--panel-size: 45ch;">
  <div class="flex flex-column gap txt-medium">
    <%= form_with model: @user, method: :patch, class: "flex flex-column gap", data: { controller: "form upload-preview" } do |form| %>
      <div class="align-center center avatar__form gap">
        <span class="btn btn--placeholder txt-small"></span>

        <label class="avatar btn btn--circle input--file txt-xx-large center fill-white">
          <%= image_tag user_avatar_path(@user), aria: { hidden: "true" }, class: "avatar", size: 128, data: { upload_preview_target: "image" } %>
          <%= form.file_field :avatar, id: "file", class: "input", accept: User::Avatar::ALLOWED_AVATAR_CONTENT_TYPES.join(","),
                data: { upload_preview_target: "input", action: "upload-preview#previewImage" } %>
          <span class="for-screen-reader">Profile avatar for <%= @user.name %></span>
        </label>

        <% if @user.avatar.attached? %>
          <%= tag.button type: :submit, form: "avatar-delete-form", class: "btn btn--negative txt-small", data: { turbo_confirm: "Are you sure you want to remove your avatar? This can't be undone." } do %>
            <%= icon_tag "minus" %>
            <span class="for-screen-reader">Delete avatar</span>
          <% end %>
        <% end %>
      </div>

      <div class="flex align-center gap">
        <label class="flex align-center gap input input--actor">
          <%= form.text_field :name, class: "input full-width", autocomplete: "name", placeholder: "Name", autofocus: true, required: true, data: { "1p-ignore": true, action: "keydown.esc@document->form#cancel" } %>
        </label>
      </div>
      <div class="flex align-center gap">
        <div class="flex align-center gap input input--actor">
          <%= form.email_field :email_address, class: "input full-width", autocomplete: "username", placeholder: "Email address", required: true, readonly: true, value: @user.identity.email_address %>
          <%= link_to "Change email", new_user_email_address_path(user_id: Current.user.id), class: "btn btn--plain txt-link txt-small txt-nowrap" %>
        </div>
      </div>

      <% if @user.errors.any? %>
        <div class="margin-block-half txt-negative txt-small" style="text-align: left;">
          <p class="margin-block-none font-weight-bold">Your changes couldn't be saved:</p>
          <ul class="margin-block-none">
            <% @user.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <button type="submit" id="log_in" class="btn btn--reversed center" data-form-target="submit">
        <span>Save changes</span>
      </button>

      <%= link_to "Cancel and go back", user_path(@user), data: { form_target: "cancel", turbo_frame: "_top" }, hidden: true %>
    <% end %>

    <%= form_with url: user_avatar_url(@user), method: :delete, id: "avatar-delete-form" %>
  </div>
</div>

================
File: app/views/users/index.json.jbuilder
================
json.array! @page.records, partial: "users/user", as: :user

================
File: app/views/users/show.html.erb
================
<% @page_title = @user.name %>
<% me_or_you = Current.user == @user ? "me" : @user.first_name %>

<div class="settings settings--profile">
  <div class="settings__panel panel shadow txt-align-center">
    <div class="flex flex-column gap position-relative">
      <% if Current.user == @user %>
        <%= link_to edit_user_path(@user), class: "user-edit-link btn", data: { controller: "tooltip" } do %>
          <%= icon_tag "pencil" %>
          <span class="for-screen-reader">Edit profile</span>
        <% end %>
      <% end %>

      <div class="avatar txt-xx-large center fill-white btn--circle hide-focus-ring">
        <%= image_tag user_avatar_path(@user), alt: "Profile avatar for #{@user.name}" %>
      </div>

      <div class="flex flex-column gap-half margin-block-end">
        <h1 class="txt-x-large margin-none"><%= @user.name %></h1>
        <div class="txt-medium">
          <% if !@user.active? %>
            <%= @user.name %> is no longer on this account
          <% elsif !@user.verified? %>
            Unverified
            <div class="txt-small txt-tinted">A sign-in code has been sent to this email address, but the user has not yet logged in to confirm their identity.</div>
          <% else %>
            <%= mail_to @user.identity.email_address %>
          <% end %>
        </div>
      </div>

      <% if @user.verified? %>
        <div class="flex-inline center justify-center flex-wrap gap">
          <%= link_to "Which cards are assigned to #{me_or_you}?",
                cards_path(assignee_ids: [ @user.id ], sorted_by: "newest"), class: "btn btn--link", data: { turbo_frame: "_top" } %>
          <%= link_to "Which cards were added by #{me_or_you}?",
                cards_path(creator_ids: [ @user.id ], sorted_by: "newest"), class: "btn btn--link", data: { turbo_frame: "_top" } %>
        </div>
      <% end %>

      <% if Current.user == @user %>
        <hr class="separator--horizontal full-width flex-item-grow margin-block-start-double" style="--border-color: var(--color-ink-light);" aria-hidden="true">

        <%= button_to session_path(script_name: nil), method: :delete, class: "btn txt-x-small center", data: { turbo: false } do %>
          <span>Sign out of Fizzy on this device</span>
        <% end %>
      <% end %>
    </div>
  </div>

  <% if Current.user == @user %>
    <div class="settings__panel panel shadow hide-on-native">
      <%= render "users/theme" %>
      <%= render "users/transfer", user: @user %>
      <%= render "users/access_tokens" %>
      <%= render "users/data_export" %>
    </div>
  <% end %>
</div>

<% if @user.verified? %>
  <%= turbo_frame_tag "user_events", src: user_events_path(@user) %>
<% end %>

================
File: app/views/users/show.json.jbuilder
================
json.partial! "users/user", user: @user

================
File: app/views/webhooks/form/_actions.html.erb
================
<div data-controller="toggle-class">
  <div class="flex align-center gap-half margin-block-end-half">
    <%= button_tag "Enable all", type: "button", class: "btn btn--plain txt-x-small txt-link font-weight-normal", data: { action: "click->toggle-class#checkAll" } %>
    <span class="txt-subtle">&middot;</span>
    <%= button_tag "Disable all", type: "button", class: "btn btn--plain txt-x-small txt-link font-weight-normal", data: { action: "click->toggle-class#checkNone" } %>
  </div>
  <ul class="flex flex-column align-start gap-half margin-none unpad">
    <%= form.collection_check_boxes \
          :subscribed_actions,
          webhook_action_options,
          :first,
          :last do |item| %>
      <li class="list-style-none margin-none">
        <label class="toggler__visible-when-off flex align-center gap cursor-pointer">
          <span class="switch txt-x-small flex-item-no-shrink">
            <%= item.check_box(class: "switch__input", data: { toggle_class_target: "checkbox" }) %>
            <span class="switch__btn round"></span>
          </span>
          <span class="min-width"><%= item.text %></span>
        </label>
      </li>
    <% end %>
  </ul>
</div>

================
File: app/views/webhooks/_delivery.html.erb
================
<%= tag.li id: dom_id(delivery), class: token_list(delivery.succeeded? && "delivery--succeeded") do %>
  <strong>
    <%= delivery.state %>
  </strong>
  <div class="txt-subtle">
    <%= time_tag delivery.created_at, time_ago_in_words(delivery.created_at) %>
  </div>
<% end %>

================
File: app/views/webhooks/_webhook.html.erb
================
<li class="list-style-none margin-none flex align-center gap full-width">
  <%= link_to webhook, class: "txt-ink flex gap-half align-center min-width txt-medium" do %>
    <strong class="overflow-ellipsis"><%= webhook.name %></strong>
  <% end %>

  <hr class="separator--horizontal flex-item-grow" style="--border-color: var(--color-ink-medium); --border-style: dashed" aria-hidden="true">

  <%= button_to webhook, method: :delete, class: "btn btn--circle btn--negative txt-xx-small flex-item-no-shrink",
        data: { turbo_confirm: "Are you sure you want to permanently remove this webhook?" } do %>
    <%= icon_tag "minus" %>
    <span class="for-screen-reader">Remove <%= webhook.name %></span>
  <% end %>
</li>

================
File: app/views/webhooks/edit.html.erb
================
<% @page_title = @webhook.name %>

<% content_for :header do %>
  <div class="header__actions header__actions--start">
    <%= back_link_to @page_title, @webhook, "keydown.left@document->hotkey#click keydown.esc@document->hotkey#click" %>
  </div>
<% end %>

<article class="panel panel--wide center txt-align-start" style="view-transition-name: <%= dom_id(@webhook) %>">
  <%= form_with model: @webhook, url: @webhook, method: :put, data: { controller: "form" }, html: { class: "flex flex-column gap" } do |form| %>
    <h2 class="txt-large margin-none">
      <%= form.text_field :name, required: true, autofocus: true, class: "input full-width", placeholder: "Name your Webhook", data: { action: "keydown.esc@document->form#cancel" } %>
    </h2>

    <div class="flex flex-column gap-half">
      <%= form.label :actions do %>
        <strong>Events</strong><br>
        <p class="margin-none txt-x-small txt-subtle">Trigger a call to the Payload URL when:</p>
      <% end %>
      <%= render "webhooks/form/actions", form: form %>
    </div>

    <%= form.button type: :submit, class: "btn btn--link center txt-medium" do %>
      <span>Save Changes</span>
    <% end %>

    <%= link_to "Go back", board_webhooks_path, data: { form_target: "cancel" }, hidden: true %>
  <% end %>
</article>

================
File: app/views/webhooks/event.html.erb
================
<%= @event.description_for(Current.user).to_plain_text %>
<% if @event.eventable %>
<%= link_to "", polymorphic_url(@event.eventable) %>
<% end %>

================
File: app/views/webhooks/event.json.jbuilder
================
json.cache! @event do
  json.(@event, :id, :action)
  json.created_at @event.created_at.utc

  json.eventable do
    case @event.eventable
    when Card then json.partial! "cards/card", card: @event.eventable
    when Comment then json.partial! "cards/comments/comment", comment: @event.eventable
    end
  end

  json.board @event.board, partial: "boards/board", as: :board
  json.creator @event.creator, partial: "users/user", as: :user
end

================
File: app/views/webhooks/index.html.erb
================
<% @page_title = "Webhooks" %>

<% content_for :header do %>
  <div class="header__actions header__actions--start">
    <%= link_back_to_board(@board) %>
  </div>

  <h1 class="header__title" data-bridge--title-target="header"><%= @page_title %></h1>
<% end %>

<%= tag.section class: "panel panel--wide shadow center webhooks" do %>
  <% if @page.records.any? %>
    <ul class="flex flex-column align-start gap margin-none-block-start unpad webhooks-list">
      <%= render partial: "webhooks/webhook", collection: @page.records %>
    </ul>
  <% else %>
    <p>Webhooks can notify another application when something happens in this Fizzy board. Youll choose which events to subscribe to and provide a URL to receive the data.</p>
    <p>For example, you could create a webhook that posts to a Campfire chat in Basecamp when new cards are added to Fizzy.</p>
  <% end %>

  <%= link_to new_board_webhook_path, class: "btn btn--link" do %>
    <%= icon_tag "add" %>
    <span>Set up a new webhook</span>
  <% end %>
<% end %>

================
File: app/views/webhooks/new.html.erb
================
<% @page_title = "Set up a Webhook" %>

<% content_for :header do %>
  <div class="header__actions header__actions--start">
    <%= back_link_to "Webhooks", board_webhooks_path, "keydown.left@document->hotkey#click keydown.esc@document->hotkey#click" %>
  </div>

  <h1 class="header__title" data-bridge--title-target="header"><%= @page_title %></h1>
<% end %>

<article class="panel panel--wide center txt-align-start" style="view-transition-name: <%= dom_id(@webhook) %>">
  <%= form_with model: @webhook, url: board_webhooks_path, data: { controller: "form" }, html: { class: "flex flex-column gap" } do |form| %>
    <h2 class="txt-large margin-none">
      <%= form.text_field :name, required: true, autofocus: true, class: "input", placeholder: "Name this Webhook", data: { action: "keydown.esc@document->form#cancel" } %>
    </h2>

    <div class="flex flex-column gap-half">
      <%= form.label :url do %>
        <strong>Payload URL</strong><br>
        <p class="margin-none txt-x-small txt-subtle">This is the URL for the app that will receive payloads from Fizzy.</p>
      <% end %>
      <%= form.url_field :url,
            required: true,
            pattern: "https?://.*",
            title: "Must be an http:// or https:// URL",
            class: "input",
            placeholder: "https://example.com",
            data: { action: "keydown.esc@document->form#cancel" } %>
    </div>

    <div class="flex flex-column gap-half">
      <%= form.label :actions do %>
        <strong>Events</strong><br>
        <p class="margin-none txt-x-small txt-subtle">Trigger a call to the Payload URL when:</p>
      <% end %>
      <%= render "webhooks/form/actions", form: form %>
    </div>

    <%= form.button type: :submit, class: "btn btn--link center txt-medium" do %>
      <span>Create Webhook</span>
    <% end %>

    <%= link_to "Go back", board_webhooks_path, data: { form_target: "cancel" }, hidden: true %>
  <% end %>
</article>

================
File: app/views/webhooks/show.html.erb
================
<% @page_title = @webhook.name %>

<% content_for :header do %>
  <div class="header__actions header__actions--start">
    <div class="header__actions header__actions--start">
      <%= back_link_to "Webhooks", board_webhooks_path, "keydown.left@document->hotkey#click keydown.esc@document->hotkey#click" %>
    </div>
  </div>

  <div class="header__actions header__actions--end">
    <%= link_to edit_board_webhook_path(@webhook.board_id, @webhook), class: "btn" do %>
      <%= icon_tag "pencil" %>
      <span class="for-screen-reader">Edit</span>
    <% end %>
  </div>
<% end %>

<div class="panel panel--wide shadow center flex flex-column gap txt-align-start">
  <header>
    <h1 class="txt-x-large margin-none"><%= @webhook.name %></h1>
    <span class="txt-medium txt-break"><%= @webhook.url %></span>
  </header>
  <% unless @webhook.active? %>
    <div>
      <%= button_to "Reactivate", board_webhook_activation_path(@webhook.board_id, @webhook), method: :post %>
    </div>
  <% end %>

  <div>
    <h2 class="margin-none txt-uppercase txt-medium">Secret</h2>
    <strong><code><%= @webhook.signing_secret %></code></strong>
    <p class="txt-small txt-subtle margin-none">
      We'll send a <code>X-Webhook-Signature</code> header with each request.
      You can generate a <code>HMAC</code> using <code>SHA256</code> of the request body with this secret
      to verify that the request came from us.
    </p>
  </div>

    <div class="flex flex-column">
      <h2 class="margin-none txt-uppercase txt-medium">Subscribed to</h2>
      <% if @webhook.subscribed_actions.empty? %>
        <p class="margin-none txt-subtle">This Webhook isn't subscribed to any events. It will never trigger.</p>
      <% else %>
        <ul class="margin-none unpad-block">
          <% @webhook.subscribed_actions.each do |action| %>
            <li><%= webhook_action_label(action) %></li>
          <% end %>
        </ul>
      <% end %>
    </div>

    <div class="flex flex-column">
      <h2 class="margin-none txt-uppercase txt-medium">Deliveries</h2>
      <% if @webhook.deliveries.empty? %>
        <p class="margin-none txt-subtle">This Webhook hasn't been triggered yet</p>
      <% else %>
        <ul class="margin-none unpad-block">
          <%= render partial: "webhooks/delivery", collection: @webhook.deliveries.ordered.limit(20), as: :delivery %>
        </ul>
      <% end %>
    </div>
</div>

================
File: bin/brakeman
================
#!/usr/bin/env ruby
# frozen_string_literal: true

#
# This file was generated by Bundler.
#
# The application 'brakeman' is installed as part of a gem, and
# this file is here to facilitate running it.
#

ENV["BUNDLE_GEMFILE"] ||= File.expand_path("../Gemfile", __dir__)

bundle_binstub = File.expand_path("bundle", __dir__)

if File.file?(bundle_binstub)
  if File.read(bundle_binstub, 300).include?("This file was generated by Bundler")
    load(bundle_binstub)
  else
    abort("Your `bin/bundle` was not generated by Bundler, so this binstub cannot run.
Replace `bin/bundle` by running `bundle binstubs bundler --force`, then run this command again.")
  end
end

require "rubygems"
require "bundler/setup"

load Gem.bin_path("brakeman", "brakeman")

================
File: bin/bundle-both
================
#!/usr/bin/env bash
set -euo pipefail

echo
gum style --foreground 135 --bold " OSS: Gemfile"
gum style --foreground 240 "bundle $*"
BUNDLE_GEMFILE=Gemfile bundle "$@"

echo
gum style --foreground 135 --bold " SaaS: Gemfile.saas"
gum style --foreground 240 "bundle $*"
BUNDLE_GEMFILE=Gemfile.saas bundle "$@"

================
File: bin/bundle-drift
================
#!/usr/bin/env ruby
# Checks that Gemfile.lock and Gemfile.saas.lock are in sync for shared dependencies.
# Since Gemfile.saas evals Gemfile, shared gems should have identical versions.
#
# Usage:
#   bin/bundle-drift [check]   # check for drift (default subcommand)
#   bin/bundle-drift correct   # restore alignment (Gemfile.saas.lock is authoritative)
require "bundler"
require "fileutils"

GEMFILE_LOCK = "Gemfile.lock"
GEMFILE_SAAS_LOCK = "Gemfile.saas.lock"

class GemfileDriftChecker
  def initialize
    @oss_lockfile = parse_lockfile(GEMFILE_LOCK)
    @saas_lockfile = parse_lockfile(GEMFILE_SAAS_LOCK)
  end

  def check
    find_drift.tap do
      report it
    end
  end

  private
    def parse_lockfile(path)
      Bundler::LockfileParser.new(File.read(path))
    end

    def find_drift
      oss_specs, saas_specs = specs_hash(@oss_lockfile), specs_hash(@saas_lockfile)
      shared_gems = oss_specs.keys & saas_specs.keys

      shared_gems.filter_map do |name|
        oss_version, saas_version = oss_specs[name], saas_specs[name]
        if oss_version != saas_version
          { name: name, oss: oss_version, saas: saas_version }
        end
      end.sort_by { |d| d[:name] }
    end

    def specs_hash(lockfile)
      lockfile.specs.to_h { |spec| [ spec.name, spec.version.to_s ] }
    end

    def report(drift)
      if drift.empty?
        puts " Gemfile.lock and Gemfile.saas.lock are in sync"
      else
        puts " Gemfile lock files have drifted!\n\n"

        name_width = [ drift.map { |d| d[:name].length }.max, "Gem".length ].max
        oss_width = [ drift.map { |d| d[:oss].length }.max, "Gemfile.lock".length ].max
        saas_width = [ drift.map { |d| d[:saas].length }.max, "Gemfile.saas.lock".length ].max

        puts "  #{"Gem".ljust(name_width)}  #{"Gemfile.lock".ljust(oss_width)}  Gemfile.saas.lock"
        puts "  #{"-" * name_width}  #{"-" * oss_width}  #{"-" * saas_width}"

        drift.each do |d|
          puts "  #{d[:name].ljust(name_width)}  #{d[:oss].ljust(oss_width)}  #{d[:saas]}"
        end

        puts "\nRun 'bin/bundle-drift correct' to restore alignment."
      end
    end
end

class GemfileDriftCorrector
  def correct
    drift = GemfileDriftChecker.new.check
    return puts "\nNothing to correct." if drift.empty?

    puts "\nRestoring alignment (Gemfile.saas.lock is authoritative)...\n\n"

    # Save original for diff
    original_content = File.read(GEMFILE_LOCK)

    # Seed Gemfile.lock with Gemfile.saas.lock - Bundler will use these as version hints
    FileUtils.cp(GEMFILE_SAAS_LOCK, GEMFILE_LOCK)

    # Re-lock: Bundler prunes SaaS-only gems while preserving shared versions
    puts " Re-locking Gemfile (seeded from Gemfile.saas.lock)"
    unless system("BUNDLE_GEMFILE=Gemfile bundle lock")
      File.write(GEMFILE_LOCK, original_content)
      abort("Failed to lock Gemfile. Restored original.")
    end

    puts "\n Verifying alignment"
    new_drift = GemfileDriftChecker.new.check

    if new_drift.empty?
      puts "\n Lock files are now in sync"
      show_diff(original_content, File.read(GEMFILE_LOCK))
    else
      puts "\n Lock files still have drift after correction."
      puts "  Bundler couldn't resolve to matching versions."
      puts "  Restoring original Gemfile.lock."
      File.write(GEMFILE_LOCK, original_content)
      exit 1
    end
  end

  private
    def show_diff(original, corrected)
      require "tempfile"

      Tempfile.create("gemfile-lock-original") do |f|
        f.write(original)
        f.flush

        diff = `diff -u #{f.path} #{GEMFILE_LOCK} 2>/dev/null`
        unless diff.empty?
          puts "\nChanges made to Gemfile.lock:"
          puts diff
        end
      end
    end
end

case command = ARGV[0] || "check"
when "check"
  exit 1 unless GemfileDriftChecker.new.check.empty?
when "correct"
  GemfileDriftCorrector.new.correct
else
  abort "Usage: bin/bundle-drift [check|correct]"
end

================
File: bin/bundler-audit
================
#!/usr/bin/env ruby
require_relative "../config/boot"
require "bundler/audit/cli"

ARGV.concat %w[ --config config/bundler-audit.yml ] if ARGV.empty? || ARGV.include?("check")
Bundler::Audit::CLI.start

================
File: bin/ci
================
#!/usr/bin/env ruby
require_relative "../config/boot"
require "active_support/continuous_integration"

CI = ActiveSupport::ContinuousIntegration
require_relative "../config/ci.rb"

================
File: bin/dev
================
#!/usr/bin/env sh

PORT=3006
USE_TAILSCALE=0

for arg in "$@"; do
  case $arg in
    --tailscale) USE_TAILSCALE=1 ;;
  esac
done

if [ ! -f tmp/solid-queue.txt ]; then
  export SOLID_QUEUE_IN_PUMA=false
fi

if [ -f tmp/oss-config.txt ]; then
  export OSS_CONFIG=1
fi

if [ "$USE_TAILSCALE" = "1" ]; then
  if ! command -v tailscale >/dev/null 2>&1; then
    echo "Error: tailscale not found" >&2
    exit 1
  fi

  TS_STATUS=$(tailscale status --self --json 2>&1)
  if [ $? -ne 0 ]; then
    echo "Error: tailscale not logged in" >&2
    exit 1
  fi

  TS_HOSTNAME=$(echo "$TS_STATUS" | jq -r '.Self.DNSName | rtrimstr(".")')
  TS_PORT="4$PORT"

  stop_tailscale() { tailscale serve --https=$TS_PORT off >/dev/null 2>&1; }
  trap stop_tailscale EXIT INT TERM

  tailscale serve --bg --https=$TS_PORT localhost:$PORT >/dev/null 2>&1
  if ! tailscale serve status --json 2>/dev/null | jq -e ".TCP.\"$TS_PORT\"" >/dev/null 2>&1; then
    echo "Error: tailscale serve failed. On Linux, run once: sudo tailscale set --operator=\$USER" >&2
    exit 1
  fi
  echo "Login with david@example.com to: https://$TS_HOSTNAME:$TS_PORT/"
else
  echo "Login with david@example.com to: http://fizzy.localhost:$PORT/"
fi

./bin/rails server -b 0.0.0.0 -p $PORT

================
File: bin/docker-entrypoint
================
#!/bin/bash -e

# If running the rails server then create or migrate existing database
if [ "${1}" == "./bin/thrust" ] && [ "${2}" == "./bin/rails" ] && [ "${3}" == "server" ]; then
  MIGRATE=1 ./bin/rails db:prepare
fi

exec "${@}"

================
File: bin/gitleaks-audit
================
#!/usr/bin/env bash

if ! which gitleaks > /dev/null 2>&1 ; then
  echo "gitleaks is not installed, please install it first" 1>&2
  exit 1
fi

mkdir -p tmp
if ! gitleaks dir --redact=50 --report-path tmp/gitleaks-report.json ; then
  echo "gitleaks found potential secrets, please check tmp/gitleaks-report.json" 1>&2
  exit 1
fi

exit 0

================
File: bin/importmap
================
#!/usr/bin/env ruby

require_relative '../config/application'
require 'importmap/commands'

================
File: bin/jobs
================
#!/usr/bin/env ruby

require_relative "../config/environment"
require "solid_queue/cli"

SolidQueue::Cli.start(ARGV)

================
File: bin/kamal
================
#!/usr/bin/env ruby
# frozen_string_literal: true

#
# This file was generated by Bundler.
#
# The application 'kamal' is installed as part of a gem, and
# this file is here to facilitate running it.
#

ENV["BUNDLE_GEMFILE"] ||= File.expand_path("../Gemfile", __dir__)

bundle_binstub = File.expand_path("bundle", __dir__)

if File.file?(bundle_binstub)
  if File.read(bundle_binstub, 300).include?("This file was generated by Bundler")
    load(bundle_binstub)
  else
    abort("Your `bin/bundle` was not generated by Bundler, so this binstub cannot run.
Replace `bin/bundle` by running `bundle binstubs bundler --force`, then run this command again.")
  end
end

require "rubygems"

require_relative "../lib/fizzy"
Fizzy.configure_bundle

require "bundler/setup"

if Fizzy.saas?
  gem_path = Gem::Specification.find_by_name("fizzy-saas").gem_dir
  deploy_config = File.join(gem_path, "config", "deploy.yml")

  unless ARGV.include?("-c") || ARGV.include?("--config-file")
    if ARGV.empty? || ARGV.first.start_with?("-")
      ARGV.unshift("-c", deploy_config)
    else
      ARGV.insert(1, "-c", deploy_config)
    end
  end
end

load Gem.bin_path("kamal", "kamal")

================
File: bin/minio-setup
================
#!/usr/bin/env ruby
#
#  Make sure the bucket we rely upon in development exists.
#  Configuration and credentials are in config/storage.yml
#
require_relative "../config/environment"
require "aws-sdk-s3"

# Load storage configuration
storage_config = YAML.load(ERB.new(File.read("config/storage.yml")).result)
minio_config = storage_config["devminio"]

bucket_name = minio_config["bucket"]
endpoint = minio_config["endpoint"]
access_key = minio_config["access_key_id"]
secret_key = minio_config["secret_access_key"]
region = minio_config["region"]

# Create S3 client
s3_client = Aws::S3::Client.new(
  endpoint: endpoint,
  access_key_id: access_key,
  secret_access_key: secret_key,
  region: region,
  force_path_style: minio_config["force_path_style"]
)

# Check if bucket exists
begin
  s3_client.head_bucket(bucket: bucket_name)
  puts "Bucket '#{bucket_name}' already exists"
rescue Aws::S3::Errors::NotFound
  # Create the bucket
  puts "Creating bucket '#{bucket_name}'..."
  s3_client.create_bucket(bucket: bucket_name)
  puts "Successfully created bucket '#{bucket_name}'"
rescue => e
  puts "Error checking/creating bucket: #{e.message}"
  exit 1
end

================
File: bin/notify_dash_of_deployment
================
#!/bin/sh

# Example usage: bin/notify_dash_of_deployment $MESSAGE $KAMAL_VERSION $KAMAL_PERFORMER $CURRENT_BRANCH $KAMAL_DESTINATION $KAMAL_RUNTIME

if [ -n "$DASH_BASIC_AUTH_SECRET" ]; then
  jq -n -c --arg message "${1}" \
    --arg commit "${2}" \
    --arg author "${3}" \
    --arg branch "${4}" \
    --arg env "${5}" \
    --arg duration "${6}" \
    '{
      "application":"fizzy",
      "rails_env": $env,
      "branch": $branch,
      "deployer": $author,
      "message": $message,
      "rev": $commit,
      "duration": $duration
      }' |
    curl --user "$DASH_BASIC_AUTH_SECRET" -H "Content-Type: application/json" --data-binary @- \
      https://dash.37signals.com/deploy
else
  echo "WARNING: Dash deploy notification not sent."
fi

================
File: bin/rails
================
#!/usr/bin/env ruby
APP_PATH = File.expand_path("../config/application", __dir__)

require_relative "../lib/fizzy"
Fizzy.configure_bundle

require_relative "../config/boot"

require "rails/commands"

if Fizzy.saas? && ENV["RAILS_ENV"] == "test"
  # the app is not loaded by rails/commands if there are additional arguments to "rails test"
  require APP_PATH
  Fizzy::Saas.append_test_paths
end

================
File: bin/rake
================
#!/usr/bin/env ruby
require_relative '../config/boot'
require 'rake'
Rake.application.run

================
File: bin/rubocop
================
#!/usr/bin/env ruby
# frozen_string_literal: true

#
# This file was generated by Bundler.
#
# The application 'rubocop' is installed as part of a gem, and
# this file is here to facilitate running it.
#

ENV['BUNDLE_GEMFILE'] ||= File.expand_path('../Gemfile', __dir__)

bundle_binstub = File.expand_path('bundle', __dir__)

if File.file?(bundle_binstub)
  if File.read(bundle_binstub, 300).include?('This file was generated by Bundler')
    load(bundle_binstub)
  else
    abort("Your `bin/bundle` was not generated by Bundler, so this binstub cannot run.
Replace `bin/bundle` by running `bundle binstubs bundler --force`, then run this command again.")
  end
end

require 'rubygems'
require 'bundler/setup'

load Gem.bin_path('rubocop', 'rubocop')

================
File: bin/setup
================
#!/usr/bin/env bash
set -eo pipefail

# Prefer app executables
app_root="$(
  cd "$(dirname "$0")/.."
  pwd
)"
export PATH="$app_root/bin:$PATH"

if [ -e tmp/saas.txt ]; then
  export SAAS=1
fi

if [ -n "$SAAS" ]; then
  export BUNDLE_GEMFILE="Gemfile.saas"
fi

# Install gum if needed
if ! command -v gum &>/dev/null; then
  echo
  echo " Installing gum"
  if command -v pacman &>/dev/null; then
    sudo pacman -S --noconfirm gum
  elif command -v brew &>/dev/null; then
    brew install gum
  else
    echo "Please install gum: https://github.com/charmbracelet/gum"
    exit 1
  fi
  echo
fi

# Install mise if needed
if ! command -v mise &>/dev/null; then
  echo
  echo " Installing mise"
  if command -v pacman &>/dev/null; then
    sudo pacman -S --noconfirm mise
  elif command -v brew &>/dev/null; then
    brew install mise
  else
    echo "Please install mise: https://mise.jdx.dev/installing-mise.html#installation-methods"
    exit 1
  fi
  echo
fi

# Install gh if needed
if ! command -v gh &>/dev/null; then
  echo
  echo " Installing GitHub CLI"
  if command -v pacman &>/dev/null; then
    sudo pacman -S --noconfirm github-cli
  elif command -v brew &>/dev/null; then
    brew install gh
  else
    echo "Please install GitHub CLI: https://github.com/cli/cli#installation"
    exit 1
  fi
  echo
fi

step() {
  local step_name="$1"
  shift

  gum style --foreground 135 --bold " $step_name"
  gum style --foreground 240 "$*"

  "$@"

  local exit_code=$?
  echo
  return $exit_code
}

needs_seeding() {
  if [ "$CI" != "" ]; then
    return 1
  fi

  has_data=$(bin/rails runner "pp Account.all.any?" 2>/dev/null)
  if [ "$has_data" = "true" ] ; then
    return 1
  else
    return 0
  fi
}

oss_mysql_setup() {
  if ! nc -z localhost 3306 2>/dev/null; then
    if docker ps -aq -f name=fizzy-mysql | grep -q .; then
      step "Starting MySQL" docker start fizzy-mysql
    else
      step "Setting up MySQL" bash -c '
        docker pull mysql:8.4
        docker run -d \
          --name fizzy-mysql \
          -e MYSQL_ALLOW_EMPTY_PASSWORD=yes \
          -p 3306:3306 \
          mysql:8.4
        echo "MySQL is starting (it may take a few seconds)"
      '
    fi
  fi
}

echo
gum style --foreground 153 "                     "
gum style --foreground 111 --bold "        "
echo

step "Installing Ruby" mise install --yes
eval "$(mise hook-env -s bash)"

if which pacman >/dev/null 2>&1; then
  packages=(imagemagick mariadb-libs openslide libvips gitleaks)
  if ! pacman -Q "${packages[@]}" >/dev/null 2>&1; then
    step "Installing packages" sudo pacman -S --noconfirm --needed "${packages[@]}"
  fi
elif which brew >/dev/null 2>&1; then
  packages=(imagemagick openslide vips gitleaks)
  missing_packages=()
  for pkg in "${packages[@]}"; do
    if ! brew list "$pkg" &>/dev/null; then
      missing_packages+=("$pkg")
    fi
  done
  if [ ${#missing_packages[@]} -gt 0 ]; then
    step "Installing packages" brew install "${missing_packages[@]}"
  fi
fi

bundle config set --local auto_install true
step "Installing RubyGems" bundle install

if [ -n "$SAAS" ]; then
  source "$app_root/saas/bin/setup"
else
  if [ "$DATABASE_ADAPTER" = "mysql" ]; then
    oss_mysql_setup
  fi
fi

if [[ $* == *--reset* ]]; then
  step "Resetting the database" rails db:reset
else
  step "Preparing the database" rails db:prepare

  if needs_seeding; then
    step "Seeding the database" rails db:seed
  fi
fi

step "Cleaning up logs and tempfiles" rails log:clear tmp:clear

gum style --foreground 46 " Done (${SECONDS} sec)"

================
File: bin/thrust
================
#!/usr/bin/env ruby
# frozen_string_literal: true

#
# This file was generated by Bundler.
#
# The application 'thrust' is installed as part of a gem, and
# this file is here to facilitate running it.
#

ENV["BUNDLE_GEMFILE"] ||= File.expand_path("../Gemfile", __dir__)

bundle_binstub = File.expand_path("bundle", __dir__)

if File.file?(bundle_binstub)
  if File.read(bundle_binstub, 300).include?("This file was generated by Bundler")
    load(bundle_binstub)
  else
    abort("Your `bin/bundle` was not generated by Bundler, so this binstub cannot run.
Replace `bin/bundle` by running `bundle binstubs bundler --force`, then run this command again.")
  end
end

require "rubygems"
require "bundler/setup"

load Gem.bin_path("thruster", "thrust")

================
File: config/environments/beta.rb
================
require_relative "production"

================
File: config/environments/development.rb
================
require "active_support/core_ext/integer/time"
Rails.application.configure do
  # Settings specified here will take precedence over those in config/application.rb.
  # In the development environment your application's code is reloaded any time
  # it changes. This slows down response time but is perfect for development
  # since you don't have to restart the web server when you make code changes.
  config.enable_reloading = true
  # Do not eager load code on boot.
  config.eager_load = false
  # Show full error reports.
  config.consider_all_requests_local = true
  # Enable server timing
  config.server_timing = true
  # Enable/disable caching. By default caching is disabled.
  # Run rails dev:cache to toggle caching.
  if Rails.root.join("tmp/caching-dev.txt").exist?
    config.action_controller.perform_caching = true
    config.action_controller.enable_fragment_cache_logging = true
    config.cache_store = :memory_store
    config.public_file_server.headers = { "Cache-Control" => "public, max-age=#{2.days.to_i}" }
  else
    config.action_controller.perform_caching = false
    config.cache_store = :null_store
  end
  # Store uploaded files on the local file system (see config/storage.yml for options).
  if Rails.root.join("tmp/minio-dev.txt").exist?
    config.active_storage.service = :devminio
    config.x.content_security_policy.connect_src = "http://minio.localhost:39000"
    config.x.content_security_policy.img_src = "http://minio.localhost:39000"
  else
    config.active_storage.service = :local
  end
  # Don't care if the mailer can't send.
  config.action_mailer.raise_delivery_errors = false
  config.action_mailer.perform_caching = false
  # Print deprecation notices to the Rails logger.
  config.active_support.deprecation = :log
  # Raise exceptions for disallowed deprecations.
  config.active_support.disallowed_deprecation = :raise
  # Tell Active Support which deprecation messages to disallow.
  config.active_support.disallowed_deprecation_warnings = []
  # Raise an error on page load if there are pending migrations.
  config.active_record.migration_error = :page_load
  # Highlight code that triggered database queries in logs.
  config.active_record.verbose_query_logs = true
  # Highlight code that enqueued background job in logs.
  config.active_job.verbose_enqueue_logs = true
  # Raises error for missing translations.
  # config.i18n.raise_on_missing_translations = true
  # Annotate rendered view with file names.
  config.action_view.annotate_rendered_view_with_filenames = true
  # Uncomment if you wish to allow Action Cable access from any origin.
  # config.action_cable.disable_request_forgery_protection = true
  # Raise error when a before_action's only/except options reference missing actions
  config.action_controller.raise_on_missing_callback_actions = true
  # Prepend all log lines with the following tags.
  config.log_tags = [ :request_id ]
  if Rails.root.join("tmp/email-dev.txt").exist?
    config.action_mailer.delivery_method = :letter_opener
    config.action_mailer.perform_deliveries = true
  else
    config.action_mailer.raise_delivery_errors = false
  end
  config.hosts = [
    "fizzy.localhost",
    "localhost",
    "127.0.0.1",
    /fizzy-\d+/,   # review apps: fizzy-123, fizzy-456:3000
    /.*\.ts\.net/, # tailscale serve: hostname.tail1234.ts.net
    /.*\.nip\.io/  # nip.io for mobile apps
  ]
  # Canonical host for mailer URLs (emails always link here, not personal Tailscale URLs)
  config.action_mailer.default_url_options = { host: "#{config.hosts.first}:3006" }
end

================
File: config/environments/production.rb
================
require "active_support/core_ext/integer/time"
Rails.application.configure do
  # Settings specified here will take precedence over those in config/application.rb.
  # Email provider Settings
  #
  # SMTP setting can be configured via environment variables.
  # For other configuration options, consult the Action Mailer documentation.
  if smtp_address = ENV["SMTP_ADDRESS"].presence
    config.action_mailer.delivery_method = :smtp
    config.action_mailer.smtp_settings = {
      address: smtp_address,
      port: ENV.fetch("SMTP_PORT", ENV["SMTP_TLS"] == "true" ? "465" : "587").to_i,
      domain: ENV.fetch("SMTP_DOMAIN", nil),
      user_name: ENV.fetch("SMTP_USERNAME", nil),
      password: ENV.fetch("SMTP_PASSWORD", nil),
      authentication: ENV.fetch("SMTP_AUTHENTICATION", "plain"),
      tls: ENV["SMTP_TLS"] == "true",
      openssl_verify_mode: ENV["SMTP_SSL_VERIFY_MODE"]
    }
  end
  # Base URL for links in emails and other external references.
  # Set BASE_URL to your instance's public URL (e.g., https://fizzy.example.com)
  if base_url = ENV["BASE_URL"].presence
    uri = URI.parse(base_url)
    url_options = { host: uri.host, protocol: uri.scheme }
    url_options[:port] = uri.port if uri.port != uri.default_port
    routes.default_url_options = url_options
    config.action_mailer.default_url_options = url_options
  end
  # Code is not reloaded between requests.
  config.enable_reloading = false
  # Eager load code on boot. This eager loads most of Rails and
  # your application in memory, allowing both threaded web servers
  # and those relying on copy on write to perform better.
  # Rake tasks automatically ignore this option for performance.
  config.eager_load = true
  # Full error reports are disabled and caching is turned on.
  config.consider_all_requests_local = false
  config.action_controller.perform_caching = true
  # Ensures that a master key has been made available in ENV["RAILS_MASTER_KEY"], config/master.key, or an environment
  # key such as config/credentials/production.key. This key is used to decrypt credentials (and other encrypted files).
  # config.require_master_key = true
  config.public_file_server.enabled = true
  config.public_file_server.headers = {
    "Cache-Control" => "public, max-age=#{5.minutes.to_i}"
  }
  # Select Active Storage service via env var; default to local disk.
  # Don't overwrite if it's already been set (e.g. by fizzy-saas)
  if config.active_storage.service.blank?
    config.active_storage.service = ENV.fetch("ACTIVE_STORAGE_SERVICE", "local").to_sym
  end
  # Enable serving of images, stylesheets, and JavaScripts from an asset server.
  # config.asset_host = "http://assets.example.com"
  # Specifies the header that your server uses for sending files.
  # config.action_dispatch.x_sendfile_header = "X-Sendfile" # for Apache
  # config.action_dispatch.x_sendfile_header = "X-Accel-Redirect" # for NGINX
  # Mount Action Cable outside main process or domain.
  # config.action_cable.mount_path = nil
  # config.action_cable.url = "wss://example.com/cable"
  # config.action_cable.allowed_request_origins = [ "http://example.com", /http:\/\/example.*/ ]
  # Set DISABLE_SSL=true to disable all SSL options, rather than specify each individually
  ssl_enabled = "true" unless ENV["DISABLE_SSL"] == "true"
  # Assume all access to the app is happening through a SSL-terminating reverse proxy.
  # Can be used together with config.force_ssl for Strict-Transport-Security and secure cookies.
  config.assume_ssl = ENV.fetch("ASSUME_SSL", ssl_enabled) == "true"
  # Force all access to the app over SSL, use Strict-Transport-Security, and use secure cookies.
  config.force_ssl = ENV.fetch("FORCE_SSL", ssl_enabled) == "true"
  # Log to STDOUT by default
  config.logger = ActiveSupport::Logger.new(STDOUT)
                                       .tap  { |logger| logger.formatter = ::Logger::Formatter.new }
                                       .then { |logger| ActiveSupport::TaggedLogging.new(logger) }
  # Prepend all log lines with the following tags.
  config.log_tags = [ :request_id ]
  # "info" includes generic and useful information about system operation, but avoids logging too much
  # information to avoid inadvertent exposure of personally identifiable information (PII). If you
  # want to log everything, set the level to "debug".
  config.log_level = ENV.fetch("RAILS_LOG_LEVEL", "info")
  # Use a different cache store in production.
  config.cache_store = :solid_cache_store
  # Use a real queuing backend for Active Job (and separate queues per environment).
  config.active_job.queue_adapter = :solid_queue
  config.solid_queue.connects_to = { database: { writing: :queue, reading: :queue } }
  # config.active_job.queue_name_prefix = "fizzy_production"
  config.action_mailer.perform_caching = false
  # Ignore bad email addresses and do not raise email delivery errors.
  # Set this to true and configure the email server for immediate delivery to raise delivery errors.
  # config.action_mailer.raise_delivery_errors = false
  # Enable locale fallbacks for I18n (makes lookups for any locale fall back to
  # the I18n.default_locale when a translation cannot be found).
  config.i18n.fallbacks = true
  # Don't log any deprecations.
  config.active_support.report_deprecations = false
  # Do not dump schema after migrations.
  config.active_record.dump_schema_after_migration = false
  # Skip DNS rebinding protection for the default health check endpoint.
  # config.host_authorization = { exclude: ->(request) { request.path == "/up" } }
end

================
File: config/environments/staging.rb
================
require_relative "production"

================
File: config/environments/test.rb
================
require "active_support/core_ext/integer/time"
# The test environment is used exclusively to run your application's
# test suite. You never need to work with it otherwise. Remember that
# your test database is "scratch space" for the test suite and is wiped
# and recreated between test runs. Don't rely on the data there!
Rails.application.configure do
  # Settings specified here will take precedence over those in config/application.rb.
  # While tests run files are not watched, reloading is not necessary.
  config.enable_reloading = false
  # Eager loading loads your entire application. When running a single test locally,
  # this is usually not necessary, and can slow down your test suite. However, it's
  # recommended that you enable it in continuous integration systems to ensure eager
  # loading is working properly before deploying your code.
  config.eager_load = ENV["CI"].present?
  # Configure public file server for tests with Cache-Control for performance.
  config.public_file_server.enabled = true
  config.public_file_server.headers = {
    "Cache-Control" => "public, max-age=#{1.hour.to_i}"
  }
  # Show full error reports and disable caching.
  config.consider_all_requests_local = true
  config.action_controller.perform_caching = false
  config.cache_store = :null_store
  # Render exception templates for rescuable exceptions and raise for other exceptions.
  config.action_dispatch.show_exceptions = :rescuable
  # Disable request forgery protection in test environment.
  config.action_controller.allow_forgery_protection = false
  # Store uploaded files on the local file system in a temporary directory.
  config.active_storage.service = :test
  config.action_mailer.perform_caching = false
  # Tell Action Mailer not to deliver emails to the real world.
  # The :test delivery method accumulates sent emails in the
  # ActionMailer::Base.deliveries array.
  config.action_mailer.delivery_method = :test
  # Set host to be used by links generated in mailer templates.
  config.action_mailer.default_url_options = { host: "example.com" }
  # Print deprecation notices to the stderr.
  config.active_support.deprecation = :stderr
  # Raise exceptions for disallowed deprecations.
  config.active_support.disallowed_deprecation = :raise
  # Tell Active Support which deprecation messages to disallow.
  config.active_support.disallowed_deprecation_warnings = []
  # Raises error for missing translations.
  # config.i18n.raise_on_missing_translations = true
  # Annotate rendered view with file names.
  # config.action_view.annotate_rendered_view_with_filenames = true
  # Raise error when a before_action's only/except options reference missing actions
  config.action_controller.raise_on_missing_callback_actions = true
  # Load test helpers
  config.autoload_paths += %w[ test/test_helpers ]
  # Enable multi-tenant mode for tests
  config.x.multi_tenant.enabled = true
end

================
File: config/initializers/tenanting/account_slug.rb
================
module AccountSlug
  PATTERN = /(\d+)/
  PATH_INFO_MATCH = /\A(\/#{AccountSlug::PATTERN})/
  class Extractor
    def initialize(app)
      @app = app
    end
    # We're using account id prefixes in the URL path. Rather than namespace
    # all our routes, we're "mounting" the Rails app at this URL prefix.
    def call(env)
      request = ActionDispatch::Request.new(env)
      # $1, $2, $' == script_name, slug, path_info
      if request.script_name && request.script_name =~ PATH_INFO_MATCH
        # Likely due to restarting the action cable connection after upgrade
        env["fizzy.external_account_id"] = AccountSlug.decode($2)
      elsif request.path_info =~ PATH_INFO_MATCH
        # Yanks the prefix off PATH_INFO and move it to SCRIPT_NAME
        request.engine_script_name = request.script_name = $1
        request.path_info   = $'.empty? ? "/" : $'
        # Stash the account's Queenbee ID.
        env["fizzy.external_account_id"] = AccountSlug.decode($2)
      end
      if env["fizzy.external_account_id"]
        account = Account.find_by(external_account_id: env["fizzy.external_account_id"])
        Current.with_account(account) do
          @app.call env
        end
      else
        Current.without_account do
          @app.call env
        end
      end
    end
  end
  def self.decode(slug) slug.to_i end
  def self.encode(id) id.to_s end
end
Rails.application.config.middleware.insert_after Rack::TempfileReaper, AccountSlug::Extractor

================
File: config/initializers/tenanting/turbo.rb
================
module TurboStreamsJobExtensions
  extend ActiveSupport::Concern
  class_methods do
    def render_format(format, **rendering)
      if Current.account.present?
        ApplicationController.renderer.new(script_name: Current.account.slug).render(formats: [ format ], **rendering)
      else
        super
      end
    end
  end
end
Rails.application.config.after_initialize do
  Turbo::StreamsChannel.prepend TurboStreamsJobExtensions
end

================
File: config/initializers/action_text.rb
================
module ActionText
  module Extensions
    module RichText
      extend ActiveSupport::Concern
      included do
        # This overrides the default :embeds association!
        has_many_attached :embeds do |attachable|
          ::Attachments::VARIANTS.each do |variant_name, variant_options|
            attachable.variant variant_name, **variant_options, process: :immediately
          end
        end
      end
      # Delegate storage tracking to the parent record (Card, Comment, Board, etc.)
      def storage_tracked_record
        record.try(:storage_tracked_record)
      end
      def accessible_to?(user)
        record.try(:accessible_to?, user) || record.try(:publicly_accessible?)
      end
      def publicly_accessible?
        record.try(:publicly_accessible?)
      end
    end
  end
end
ActiveSupport.on_load(:action_text_rich_text) do
  include ActionText::Extensions::RichText
end

================
File: config/initializers/active_job.rb
================
# frozen_string_literal: true
# inspired from code in ActiveRecord::Tenanted
module FizzyActiveJobExtensions
  extend ActiveSupport::Concern
  prepended do
    attr_reader :account
    self.enqueue_after_transaction_commit = true
  end
  def initialize(...)
    super
    @account = Current.account
  end
  def serialize
    super.merge({ "account" => @account&.to_gid })
  end
  def deserialize(job_data)
    super
    if _account = job_data.fetch("account", nil)
      @account = GlobalID::Locator.locate(_account)
    end
  end
  def perform_now
    if account.present?
      Current.with_account(account) { super }
    else
      super
    end
  end
end
ActiveSupport.on_load(:active_job) do
  prepend FizzyActiveJobExtensions
end

================
File: config/initializers/active_storage_no_reuse.rb
================
# Enforce storage ledger integrity by preventing blob reuse in tracked contexts.
#
# Two invariants:
# 1. Account match: blob.account_id == record.account_id (multi-tenant safety)
# 2. No reuse within tracked contexts: a blob can only have one tracked attachment
#
# With per-attachment reconcile, blob reuse inside an account wouldn't break correctness -
# ledger would still count each attach, and reconcile would agree. However, we intentionally
# forbid reuse (except templates) as a product/control decision:
# - Simpler mental model (one blob = one attachment)
# - Prevents accidental quota manipulation via direct blob_id reuse
# - Cleaner audit trail in ledger entries
#
# Scope note: The no-reuse validation only blocks reuse when the *new* attachment is tracked
# AND only checks *existing* attachments in Storage::TRACKED_RECORD_TYPES. A blob first
# attached to an untracked type (avatar/export) could theoretically be reused in a tracked
# context. This is acceptable - user-accessible blob IDs from untracked contexts are
# basically nonexistent in practice.
#
# Exception: ActionText embeds are allowed to reuse blobs to support copy/paste.
ActiveSupport.on_load(:active_storage_attachment) do
  validate :blob_account_matches_record, on: :create
  validate :no_tracked_blob_reuse, on: :create
  private
    # Multi-tenant safety: blob must belong to same account as record
    # NOTE: Skips validation if record.account is nil. This is a theoretical bypass
    # if someone attaches before account assignment, but our flows assign account
    # before attachment. Global/unaccounted attachments (Identity/User avatars, exports)
    # bypass tenancy checks via try(:account) returning nil - this is intentional as
    # these classes don't participate in storage tracking.
    def blob_account_matches_record
      if record&.try(:account).present? && !whitelisted_for_cross_account?
        unless blob&.account_id == record.account.id
          errors.add(:blob_id, "blob account must match record account")
        end
      end
    end
    # Ledger integrity: blob can only have one tracked attachment
    def no_tracked_blob_reuse
      tracked_record = record&.try(:storage_tracked_record)
      if tracked_record.present? &&
          !whitelisted_for_cross_account? &&
          !(record_type == "ActionText::RichText" && name == "embeds")
        # Check for existing attachment of this blob in tracked contexts
        # Uses Storage::TRACKED_RECORD_TYPES constant to stay generic
        existing = ActiveStorage::Attachment
          .where(blob_id: blob_id)
          .where(record_type: Storage::TRACKED_RECORD_TYPES)
          .where.not(id: id)
          .exists?
        if existing
          errors.add(:blob_id, "cannot reuse blob in tracked storage context")
        end
      end
    end
    def whitelisted_for_cross_account?
      # Only template account blobs can be reused cross-tenant.
      # When TEMPLATE_ACCOUNT_ID is nil, no exemptions are granted.
      Storage::TEMPLATE_ACCOUNT_ID.present? && blob&.account_id == Storage::TEMPLATE_ACCOUNT_ID
    end
end

================
File: config/initializers/active_storage_purge_on_last_attachment.rb
================
# Fizzy-specific override: ActiveStorage's default purge path uses `delete`,
# which skips attachment callbacks. We need `destroy` so storage ledger detaches
# are recorded and reused blobs (ActionText embeds) aren't purged until the
# last attachment is gone. Keep this local to Fizzy; it's not a Rails default.
module ActiveStorage
  module PurgeOnLastAttachment
    def purge
      @purge_mode = :purge
      destroy
      purge_blob_if_last(:purge) if destroyed?
    ensure
      @purge_mode = nil
    end
    def purge_later
      @purge_mode = :purge_later
      destroy
      purge_blob_if_last(:purge_later) if destroyed?
    ensure
      @purge_mode = nil
    end
    private
      def purge_dependent_blob_later
        if (record.nil? || dependent == :purge_later) && !@purge_mode
          purge_blob_if_last(:purge_later)
        end
      end
      def purge_blob_if_last(mode)
        if blob && !blob.attachments.exists?
          mode == :purge ? blob.purge : blob.purge_later
        end
      end
  end
end
ActiveSupport.on_load(:active_storage_attachment) do
  prepend ActiveStorage::PurgeOnLastAttachment
end

================
File: config/initializers/active_storage.rb
================
ActiveSupport.on_load(:active_storage_attachment) do
  include Storage::AttachmentTracking
end
ActiveSupport.on_load(:active_storage_blob) do
  ActiveStorage::DiskController.after_action only: :show do
    expires_in 5.minutes, public: true
  end
end
ActiveSupport.on_load(:action_text_content) do
  # Install our extensions after ActionText::Engine's
  ActiveSupport.on_load(:active_storage_blob) do
    # Ensure all <action-text-attachment>s have a "url" attribute that's a relative
    # path (for portability across host name changes, beta environments, etc).
    def to_rich_text_attributes(*)
      super.merge url: Rails.application.routes.url_helpers.polymorphic_url(self, only_path: true)
    end
  end
end
# Don't configure replica connections for ActiveStorage::Record.
# When ActiveStorage uses `connects_to`, it creates a separate connection pool
# from ApplicationRecord. This causes after_commit callbacks to fire in
# non-deterministic order - the Attachment's create_variants callback can fire
# before the User model's upload callback, causing FileNotFoundError when
# using `process: :immediately` for variants.
# See: https://github.com/rails/rails/issues/53694
ActiveSupport.on_load(:active_storage_record) do
  configure_replica_connections
end
module ActiveStorageControllerExtensions
  extend ActiveSupport::Concern
  included do
    before_action do
      # Add script_name so that Disk Service will generate correct URLs for uploads
      ActiveStorage::Current.url_options = {
        protocol: request.protocol,
        host: request.host,
        port: request.port,
        script_name: request.script_name
      }
    end
  end
end
module ActiveStorageDirectUploadsControllerExtensions
  extend ActiveSupport::Concern
  included do
    include Authentication
    include Authorization
    skip_forgery_protection if: :authenticate_by_bearer_token
  end
end
Rails.application.config.to_prepare do
  ActiveStorage::BaseController.include ActiveStorageControllerExtensions
  ActiveStorage::DirectUploadsController.include ActiveStorageDirectUploadsControllerExtensions
end

================
File: config/initializers/assets.rb
================
# Be sure to restart your server when you modify this file.
# Version of your assets, change this if you want to expire all your assets.
Rails.application.config.assets.version = "1.0"
# Add additional assets to the asset load path.
# Rails.application.config.assets.paths << Emoji.images_path

================
File: config/initializers/autotuner.rb
================
# Enable autotuner. Alternatively, call Autotuner.sample_ratio= with a value
# between 0 and 1.0 to sample on a portion of instances.
Autotuner.enabled = true
# This callback is called whenever a suggestion is provided by this gem.
# Log to structured logging for query/analysis in Loki. This is called
# once per autotuner heuristic.
Autotuner.reporter = proc do |heuristic_report|
  report = heuristic_report.to_s
  Rails.logger.info "GCAUTOTUNE: #{report}"
  RailsStructuredLogging.instrument_script "autotuner" do
    Rails.logger.info report.to_s
  end if defined? RailsStructuredLogging
end

================
File: config/initializers/content_security_policy.rb
================
# Be sure to restart your server when you modify this file.
# Define an application-wide Content Security Policy.
# https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy
#
# Directives are configurable via environment variables with fallback to config.x
# settings. This allows fizzy-saas (or other deployments) to extend the base policy
# without duplicating it.
#
# ENV vars (space-separated sources):
#   CSP_DEFAULT_SRC, CSP_SCRIPT_SRC, CSP_STYLE_SRC, CSP_CONNECT_SRC, CSP_FRAME_SRC,
#   CSP_IMG_SRC, CSP_FONT_SRC, CSP_MEDIA_SRC, CSP_WORKER_SRC, CSP_FRAME_ANCESTORS,
#   CSP_FORM_ACTION, CSP_REPORT_URI, CSP_REPORT_ONLY, DISABLE_CSP
#
# config.x.content_security_policy.* (string, space-separated string, or array):
#   script_src, style_src, connect_src, frame_src, img_src, font_src, media_src,
#   worker_src, frame_ancestors, form_action, report_uri, report_only
Rails.application.configure do
  # Helper to get additional CSP sources from ENV or config.x.
  # Supports: nil, string, space-separated string, or array.
  sources = ->(directive) do
    env_key = "CSP_#{directive.to_s.upcase}"
    value = if ENV.key?(env_key)
      ENV[env_key]
    else
      config.x.content_security_policy.send(directive)
    end
    case value
    when nil then []
    when Array then value
    when String then value.split
    else []
    end
  end
  # Report URI and report-only mode
  report_uri = ENV.fetch("CSP_REPORT_URI") { config.x.content_security_policy.report_uri }
  report_only =
    if ENV.key?("CSP_REPORT_ONLY")
      ENV["CSP_REPORT_ONLY"] == "true"
    else
      config.x.content_security_policy.report_only
    end
  # Generate nonces for importmap and inline scripts
  config.content_security_policy_nonce_generator = ->(request) { SecureRandom.base64(16) }
  config.content_security_policy_nonce_directives = %w[ script-src ]
  config.content_security_policy do |policy|
    policy.default_src :self, *sources.(:default_src)
    policy.script_src :self, *sources.(:script_src)
    policy.connect_src :self, *sources.(:connect_src)
    policy.frame_src :self, *sources.(:frame_src)
    # Don't fight user tools: permit inline styles, data:/https: sources, and
    # blob: workers for accessibility extensions, privacy tools, and custom fonts.
    policy.style_src :self, :unsafe_inline, *sources.(:style_src)
    policy.img_src :self, "blob:", "data:", "https:", *sources.(:img_src)
    policy.font_src :self, "data:", "https:", *sources.(:font_src)
    policy.media_src :self, "blob:", "data:", "https:", *sources.(:media_src)
    policy.worker_src :self, "blob:", *sources.(:worker_src)
    # Security-critical defaults (not configurable)
    policy.object_src :none
    policy.base_uri :none
    policy.form_action :self, *sources.(:form_action)
    policy.frame_ancestors :self, *sources.(:frame_ancestors)
    # Specify URI for violation reports (e.g., Sentry CSP endpoint)
    policy.report_uri report_uri if report_uri
  end
  # Report violations without enforcing the policy.
  config.content_security_policy_report_only = report_only
end unless ENV["DISABLE_CSP"]

================
File: config/initializers/database_role_logging.rb
================
require_relative "extensions"
class DatabaseRoleLogger
  def initialize(app)
    @app = app
  end
  def call(env)
    Rails.logger.tagged(ActiveRecord::Base.current_role.to_s) do
      @app.call(env)
    end
  end
end
if ActiveRecord::Base.replica_configured?
  Rails.application.config.middleware.insert_after ActiveRecord::Middleware::DatabaseSelector, DatabaseRoleLogger
end

================
File: config/initializers/error_context.rb
================
# Lazily add identity and account context to error reports.
# Only evaluated when an error is actually reported.
Rails.error.add_middleware ->(error, context:, **) do
  context.merge \
    identity_id: Current.identity&.id,
    account_id: Current.account&.external_account_id
end

================
File: config/initializers/extensions.rb
================
Dir["#{Rails.root}/lib/rails_ext/*"].each { |path| require "rails_ext/#{File.basename(path)}" }

================
File: config/initializers/filter_parameter_logging.rb
================
# Be sure to restart your server when you modify this file.
# Configure parameters to be partially matched (e.g. passw matches password) and filtered from the log file.
# Use this to limit dissemination of sensitive information.
# See the ActiveSupport::ParameterFilter documentation for supported notations and behaviors.
Rails.application.config.filter_parameters += %i[
  passw secret token _key crypt salt certificate otp ssn
]

================
File: config/initializers/inflections.rb
================
# Be sure to restart your server when you modify this file.
# Add new inflection rules using the following format. Inflections
# are locale specific, and you may define rules for as many different
# locales as you wish. All of these examples are active by default:
# ActiveSupport::Inflector.inflections(:en) do |inflect|
#   inflect.plural /^(ox)$/i, "\\1en"
#   inflect.singular /^(ox)en/i, "\\1"
#   inflect.irregular "person", "people"
#   inflect.uncountable %w( fish sheep )
# end
# These inflection rules are supported but not enabled by default:
ActiveSupport::Inflector.inflections(:en) do |inflect|
  inflect.acronym "SQLite"
  inflect.acronym "IO"
  inflect.singular "quotas", "quota"
  inflect.plural "quota", "quotas"
end

================
File: config/initializers/mission_control.rb
================
Rails.application.config.before_initialize do
  MissionControl::Jobs.base_controller_class = "AdminController"
  MissionControl::Jobs.show_console_help = false
end

================
File: config/initializers/multi_db.rb
================
require "deployment"
require_relative "extensions"
if ActiveRecord::Base.replica_configured?
  Rails.application.configure do
    config.active_record.database_selector = { delay: 0.seconds }
    config.active_record.database_resolver = Deployment::DatabaseResolver
    config.active_record.database_resolver_context = ActiveRecord::Middleware::DatabaseSelector::Resolver::Session
  end
end

================
File: config/initializers/multi_tenant.rb
================
Rails.application.configure do
  config.after_initialize do
    Account.multi_tenant = ENV["MULTI_TENANT"] == "true" || config.x.multi_tenant.enabled == true
  end
end

================
File: config/initializers/permissions_policy.rb
================
# Be sure to restart your server when you modify this file.
# Define an application-wide HTTP permissions policy. For further
# information see: https://developers.google.com/web/updates/2018/06/feature-policy
# Rails.application.config.permissions_policy do |policy|
#   policy.camera      :none
#   policy.gyroscope   :none
#   policy.microphone  :none
#   policy.usb         :none
#   policy.fullscreen  :self
#   policy.payment     :self, "https://secure.example.com"
# end

================
File: config/initializers/rack_mini_profiler.rb
================
if defined?(Rack::MiniProfiler)
  Rack::MiniProfiler.config.tap do |config|
    config.position = "top-right"
    config.enable_hotwire_turbo_drive_support = true
    config.pre_authorize_cb = ->(_env) { !Rails.env.test? && File.exist?(Rails.root.join("tmp/rack-mini-profiler-dev.txt")) }
  end
end

================
File: config/initializers/sanitization.rb
================
Rails.application.config.after_initialize do
  Rails::HTML5::SafeListSanitizer.allowed_tags.merge(%w[ s table tr td th thead tbody details summary video source ])
  Rails::HTML5::SafeListSanitizer.allowed_attributes.merge(%w[ data-turbo-frame data-lightbox-target data-lightbox-caption-value controls type width ])
  # ugh, see https://github.com/rails/rails/issues/54478 which I need to fix upstream --mike
  ActionText::ContentHelper.allowed_tags = Rails::HTML5::SafeListSanitizer.allowed_tags.to_a + [ ActionText::Attachment.tag_name, "figure", "figcaption" ] + ActionText::ContentHelper.allowed_tags.to_a
  ActionText::ContentHelper.allowed_attributes = Rails::HTML5::SafeListSanitizer.allowed_attributes.to_a + ActionText::Attachment::ATTRIBUTES + ActionText::ContentHelper.allowed_attributes.to_a
end

================
File: config/initializers/sqlite_schema_dumper.rb
================
# Fix for SQLite FTS5 virtual table schema dumping
# Rails has a bug where it doesn't handle FTS5 content= and content_rowid= options
module SQLiteFTS5SchemaDumperFix
  # Override the virtual_tables method to handle FTS5 syntax properly
  def virtual_tables(stream)
    # Query sqlite_master for all virtual tables
    virtual_table_sqls = @connection.select_rows(
      "SELECT name, sql FROM sqlite_master WHERE type='table' AND sql LIKE 'CREATE VIRTUAL TABLE%'"
    )
    virtual_table_sqls.each do |table_name, sql|
      # Just output the raw SQL since create_virtual_table doesn't handle our syntax
      stream.puts "  execute #{sql.inspect}"
      stream.puts
    end
  end
end
ActiveSupport.on_load(:active_record_sqlite3adapter) do
  ActiveRecord::ConnectionAdapters::SQLite3::SchemaDumper.prepend(SQLiteFTS5SchemaDumperFix)
end

================
File: config/initializers/table_definition_column_limits.rb
================
# Apply MySQL-compatible column limits when defining tables.
#
# For string columns: defaults to 255 (MySQL's VARCHAR default)
#
# For text columns: converts MySQL's `size:` option to equivalent limits:
#   - (blank/default): 65,535 (TEXT)
#   - size: :tiny: 255 (TINYTEXT)
#   - size: :medium: 16,777,215 (MEDIUMTEXT)
#   - size: :long: 4,294,967,295 (LONGTEXT)
#
module TableDefinitionColumnLimits
  TEXT_SIZE_TO_LIMIT = {
    tiny: 255,
    medium: 16_777_215,
    long: 4_294_967_295
  }.freeze
  TEXT_DEFAULT_LIMIT = 65_535
  STRING_DEFAULT_LIMIT = 255
  def column(name, type, **options)
    if type == :string
      options[:limit] ||= STRING_DEFAULT_LIMIT
    end
    if type == :text || type == :binary
      if options.key?(:size)
        size = options.delete(:size)
        options[:limit] ||= TEXT_SIZE_TO_LIMIT.fetch(size) do
          raise ArgumentError, "Unknown text size: #{size.inspect}. Use :tiny, :medium, or :long"
        end
      elsif type == :text
        options[:limit] ||= TEXT_DEFAULT_LIMIT
      end
    end
    super
  end
end
# For SQLite: append inline CHECK constraints to enforce string/text length limits.
# since SQLite doesn't natively enforce VARCHAR/TEXT length limits.
module SQLiteColumnLimitCheckConstraints
  def add_column_options!(sql, options)
    super
    column = options[:column]
    if column && column.limit && %i[string text].include?(column.type)
      check_expr = if column.type == :string
        # VARCHAR limits are in characters
        %(length("#{column.name}") <= #{column.limit})
      else
        # TEXT limits are in bytes
        %(length(CAST("#{column.name}" AS BLOB)) <= #{column.limit})
      end
      sql << " CHECK(#{check_expr})"
    end
    sql
  end
end
ActiveSupport.on_load(:active_record) do
  ActiveRecord::ConnectionAdapters::TableDefinition.prepend(TableDefinitionColumnLimits)
end
ActiveSupport.on_load(:active_record_sqlite3adapter) do
  ActiveRecord::ConnectionAdapters::SQLite3::SchemaCreation.prepend(SQLiteColumnLimitCheckConstraints)
end

================
File: config/initializers/true_client_ip.rb
================
#
#  Cloudflare sets a True-Client-IP header, which for most 37signals apps gets copied to
#  X-Forwarded-For by an iRule on the F5 load balancers:
#
#  https://github.com/basecamp/f5-tf/blob/1543f7bfa3961a79e397f80cf041d75567f1b2f8/ams-base/iRules/manage_x_forwarded.tcl
#
#  However, for Fizzy the F5s are configured to do passthrough, so the header value isn't being
#  copied for us. Let's do that bit of work here, before Rails' RemoteIp middleware.
#
class TrackTrueClientIp
  def initialize(app)
    @app = app
  end
  def call(env)
    if env["HTTP_TRUE_CLIENT_IP"].present?
      env["HTTP_X_FORWARDED_FOR"] = env["HTTP_TRUE_CLIENT_IP"]
    end
    @app.call(env)
  end
end
Rails.application.config.middleware.insert_before ActionDispatch::RemoteIp, TrackTrueClientIp

================
File: config/initializers/uuid_framework_models.rb
================
# Inject account associations into Rails framework models
Rails.application.config.to_prepare do
  ActionText::RichText.belongs_to :account, default: -> { record.account }
  ActiveStorage::Attachment.belongs_to :account, default: -> { record.account }
  ActiveStorage::Blob.belongs_to :account, default: -> { Current.account }
  ActiveStorage::VariantRecord.belongs_to :account, default: -> { blob.account }
end

================
File: config/initializers/uuid_primary_keys.rb
================
# Automatically use UUID type for all binary(16) columns and generate defaults
module UuidPrimaryKeyDefault
  def load_schema!
    define_uuid_primary_key_pending_default
    super
  end
  private
    def define_uuid_primary_key_pending_default
      if uuid_primary_key?
        pending_attribute_modifications << PendingUuidDefault.new(primary_key)
      end
    rescue ActiveRecord::StatementInvalid
      # Table doesn't exist yet
    end
    def uuid_primary_key?
      table_name && primary_key && schema_cache.columns_hash(table_name)[primary_key]&.type == :uuid
    end
    PendingUuidDefault = Struct.new(:name) do
      def apply_to(attribute_set)
        attribute_set[name] = attribute_set[name].with_user_default(-> { ActiveRecord::Type::Uuid.generate })
      end
    end
end
module MysqlUuidAdapter
  extend ActiveSupport::Concern
  # Override lookup_cast_type to recognize binary(16) as UUID type
  def lookup_cast_type(sql_type)
    if sql_type == "binary(16)"
      ActiveRecord::Type.lookup(:uuid, adapter: :trilogy)
    else
      super
    end
  end
  # Override fetch_type_metadata to preserve UUID type and limit
  def fetch_type_metadata(sql_type, extra = "")
    if sql_type == "binary(16)"
      simple_type = ActiveRecord::ConnectionAdapters::SqlTypeMetadata.new(
        sql_type: sql_type,
        type: :uuid,
        limit: 16
      )
      ActiveRecord::ConnectionAdapters::MySQL::TypeMetadata.new(simple_type, extra: extra)
    else
      super
    end
  end
  class_methods do
    def native_database_types
      @native_database_types_with_uuid ||= super.merge(uuid: { name: "binary", limit: 16 })
    end
  end
end
module SqliteUuidAdapter
  extend ActiveSupport::Concern
  # Override lookup_cast_type to recognize BLOB as UUID type
  def lookup_cast_type(sql_type)
    if sql_type == "blob(16)"
      ActiveRecord::Type.lookup(:uuid, adapter: :sqlite3)
    else
      super
    end
  end
  # Override fetch_type_metadata to preserve UUID type and limit
  def fetch_type_metadata(sql_type)
    if sql_type == "blob(16)"
      ActiveRecord::ConnectionAdapters::SqlTypeMetadata.new(
        sql_type: sql_type,
        type: :uuid,
        limit: 16
      )
    else
      super
    end
  end
  class_methods do
    def native_database_types
      @native_database_types_with_uuid ||= super.merge(uuid: { name: "blob", limit: 16 })
    end
  end
end
module SchemaDumperUuidType
  # Map binary(16) and blob(16) columns to :uuid type in schema.rb
  def schema_type(column)
    if column.sql_type == "binary(16)" || column.sql_type == "blob(16)"
      :uuid
    else
      super
    end
  end
end
module TableDefinitionUuidSupport
  def uuid(name, **options)
    column(name, :uuid, **options)
  end
end
ActiveSupport.on_load(:active_record) do
  ActiveRecord::Base.singleton_class.prepend(UuidPrimaryKeyDefault)
  ActiveRecord::ConnectionAdapters::TableDefinition.prepend(TableDefinitionUuidSupport)
end
ActiveSupport.on_load(:active_record_trilogyadapter) do
  ActiveRecord::ConnectionAdapters::AbstractMysqlAdapter.prepend(MysqlUuidAdapter)
  ActiveRecord::ConnectionAdapters::MySQL::SchemaDumper.prepend(SchemaDumperUuidType)
end
ActiveSupport.on_load(:active_record_sqlite3adapter) do
  ActiveRecord::ConnectionAdapters::SQLite3Adapter.prepend(SqliteUuidAdapter)
  ActiveRecord::ConnectionAdapters::SQLite3::SchemaDumper.prepend(SchemaDumperUuidType)
end

================
File: config/initializers/vapid.rb
================
Rails.application.configure do
  config.x.vapid.private_key = ENV["VAPID_PRIVATE_KEY"]
  config.x.vapid.public_key = ENV["VAPID_PUBLIC_KEY"]
end

================
File: config/initializers/vips.rb
================
raise LoadError, "Please install libvips" unless defined?(Vips::LIBRARY_VERSION)
# Disable Openslide to prevent sqlite segfault in forked parallel workers
# Requires libvips 8.13+
Vips.block "VipsForeignLoadOpenslide", true if Vips.respond_to?(:block)
# Limit libvips to 4 threads for each thread pool. Default is #CPUs.
Vips.concurrency_set 4
# Limit libvips caches to reduce memory pressure.
#
# Do not disable entirely since libvips relies on some caching internally.
# (When we disabled caches, we hit a ton of JPEG out of order read errors.)
Vips.cache_set_max 10               # Default 100
Vips.cache_set_max_mem 10.megabytes # Default 100MB
Vips.cache_set_max_files 10         # Default 100

================
File: config/initializers/web_push.rb
================
require "web-push"
require "web_push/pool"
require "web_push/notification"
Rails.application.configure do
  config.x.web_push_pool = WebPush::Pool.new(
    invalid_subscription_handler: ->(subscription_id) do
      Rails.application.executor.wrap do
        Rails.logger.info "Destroying push subscription: #{subscription_id}"
        Push::Subscription.find_by(id: subscription_id)&.destroy
      end
    end
  )
  at_exit { config.x.web_push_pool.shutdown }
end
module WebPush::PersistentRequest
  def perform
    endpoint_ip = @options[:endpoint_ip]
    if endpoint_ip
      http = Net::HTTP.new(uri.host, uri.port)
      http.ipaddr = endpoint_ip
      http.use_ssl = true
      http.ssl_timeout = @options[:ssl_timeout] unless @options[:ssl_timeout].nil?
      http.open_timeout = @options[:open_timeout] unless @options[:open_timeout].nil?
      http.read_timeout = @options[:read_timeout] unless @options[:read_timeout].nil?
    elsif @options[:connection]
      http = @options[:connection]
    else
      http = Net::HTTP.new(uri.host, uri.port, *proxy_options)
      http.use_ssl = true
      http.ssl_timeout = @options[:ssl_timeout] unless @options[:ssl_timeout].nil?
      http.open_timeout = @options[:open_timeout] unless @options[:open_timeout].nil?
      http.read_timeout = @options[:read_timeout] unless @options[:read_timeout].nil?
    end
    req = Net::HTTP::Post.new(uri.request_uri, headers)
    req.body = body
    if http.is_a?(Net::HTTP::Persistent)
      response = http.request uri, req
    else
      resp = http.request(req)
      verify_response(resp)
    end
    resp
  end
end
WebPush::Request.prepend WebPush::PersistentRequest

================
File: config/locales/en.yml
================
# Files in the config/locales directory are used for internationalization and
# are automatically loaded by Rails. If you want to use locales other than
# English, add the necessary files in this directory.
#
# To use the locales, use `I18n.t`:
#
#     I18n.t "hello"
#
# In views, this is aliased to just `t`:
#
#     <%= t("hello") %>
#
# To use a different locale, set it with `I18n.locale`:
#
#     I18n.locale = :es
#
# This would use the information in config/locales/es.yml.
#
# To learn more about the API, please read the Rails Internationalization guide
# at https://guides.rubyonrails.org/i18n.html.
#
# Be aware that YAML interprets the following case-insensitive strings as
# booleans: `true`, `false`, `on`, `off`, `yes`, `no`. Therefore, these strings
# must be quoted to be interpreted as strings. For example:
#
#     en:
#       "yes": yup
#       enabled: "ON"
en:
  hello: "Hello world"

================
File: config/application.rb
================
require_relative "boot"
require "rails/all"
require_relative "../lib/fizzy"
Bundler.require(*Rails.groups)
module Fizzy
  class Application < Rails::Application
    # Initialize configuration defaults for originally generated Rails version.
    config.load_defaults 8.1
    # Include the `lib` directory in autoload paths. Use the `ignore:` option
    # to list subdirectories that don't contain `.rb` files or that shouldn't
    # be reloaded or eager loaded.
    config.autoload_lib ignore: %w[ assets tasks rails_ext ]
    # Enable debug mode for Rails event logging so we get SQL query logs.
    # This was made necessary by the change in https://github.com/rails/rails/pull/55900
    config.after_initialize do
      Rails.event.debug_mode = true
    end
    # Use UUID primary keys for all new tables
    config.generators do |g|
      g.orm :active_record, primary_key_type: :uuid
    end
    config.mission_control.jobs.http_basic_auth_enabled = false
  end
end

================
File: config/boot.rb
================
ENV["BUNDLE_GEMFILE"] ||= File.expand_path("../Gemfile", __dir__)
require "bundler/setup" # Set up gems listed in the Gemfile.
require "bootsnap/setup" # Speed up boot time by caching expensive operations.

================
File: config/brakeman.ignore
================
{
  "ignored_warnings": [
    {
      "warning_type": "SQL Injection",
      "warning_code": 0,
      "fingerprint": "4ea2e6d704b817af1d896dcdf148a89da8b9e428b3327497631ef8d9ed587307",
      "check_name": "SQL",
      "message": "Possible SQL injection",
      "file": "app/models/card/entropic.rb",
      "line": 19,
      "link": "https://brakemanscanner.org/docs/warning_types/sql_injection/",
      "code": "active.joins(:board => :account).left_outer_joins(:board => :entropy).joins(\"LEFT OUTER JOIN entropies AS account_entropies ON account_entropies.account_id = accounts.id AND account_entropies.container_type = 'Account' AND account_entropies.container_id = accounts.id\").where(\"last_active_at > #{connection.date_subtract(\"?\", \"COALESCE(entropies.auto_postpone_period, account_entropies.auto_postpone_period)\")}\", Time.now)",
      "render_path": null,
      "location": {
        "type": "method",
        "class": "Card::Entropic",
        "method": null
      },
      "user_input": "connection.date_subtract(\"?\", \"COALESCE(entropies.auto_postpone_period, account_entropies.auto_postpone_period)\")",
      "confidence": "Weak",
      "cwe_id": [
        89
      ],
      "note": "No user input allowed"
    },
    {
      "warning_type": "Dangerous Send",
      "warning_code": 23,
      "fingerprint": "746ab8227e04231f0002e099e2f670bcc2b8927af85cdc69fab1440002d5c2a6",
      "check_name": "Send",
      "message": "User controlled method execution",
      "file": "app/controllers/events/day_timeline/columns_controller.rb",
      "line": 19,
      "link": "https://brakemanscanner.org/docs/warning_types/dangerous_send/",
      "code": "Current.user.timeline_for(day, :filter => ((Current.user.filters.find(params[:filter_id]) or Current.user.filters.from_params(filter_params)))).public_send(\"#{params[:id]}_column\")",
      "render_path": null,
      "location": {
        "type": "method",
        "class": "Events::DayTimeline::ColumnsController",
        "method": "set_column"
      },
      "user_input": "params[:id]",
      "confidence": "High",
      "cwe_id": [
        77
      ],
      "note": ""
    },
    {
      "warning_type": "SSL Verification Bypass",
      "warning_code": 71,
      "fingerprint": "8e566e1a52e48940c840541ea4e33f41a39dc0f2a97eb83c52e76f9582667a3c",
      "check_name": "SSLVerify",
      "message": "SSL certificate verification was bypassed",
      "file": "app/models/zip_file/remote_io.rb",
      "line": 41,
      "link": "https://brakemanscanner.org/docs/warning_types/ssl_verification_bypass/",
      "code": "Net::HTTP.new(@uri.hostname, @uri.port).verify_mode = OpenSSL::SSL::VERIFY_NONE",
      "render_path": null,
      "location": {
        "type": "method",
        "class": "ZipFile::RemoteIO",
        "method": "with_http"
      },
      "user_input": null,
      "confidence": "High",
      "cwe_id": [
        295
      ],
      "note": "Required for internal PureStorage self-signed certificates. Only used for trusted internal storage URLs."
    },
    {
      "warning_type": "Mass Assignment",
      "warning_code": 70,
      "fingerprint": "ac0fa1970dea215e2f47a5676ffd63d8728951e361da12a53dd424bf6dc46f2a",
      "check_name": "MassAssignment",
      "message": "Specify exact keys allowed for mass assignment instead of using `permit!` which allows any keys",
      "file": "app/helpers/pagination_helper.rb",
      "line": 14,
      "link": "https://brakemanscanner.org/docs/warning_types/mass_assignment/",
      "code": "params.permit!",
      "render_path": null,
      "location": {
        "type": "method",
        "class": "PaginationHelper",
        "method": "pagination_link"
      },
      "user_input": null,
      "confidence": "Medium",
      "cwe_id": [
        915
      ],
      "note": ""
    },
    {
      "warning_type": "Remote Code Execution",
      "warning_code": 24,
      "fingerprint": "b00571393e95a8c7d77b1ed963cfc5cc89333bc82f447cf8783549d817990305",
      "check_name": "UnsafeReflection",
      "message": "Unsafe reflection method `safe_constantize` called on model attribute",
      "file": "app/models/notifier.rb",
      "line": 8,
      "link": "https://brakemanscanner.org/docs/warning_types/remote_code_execution/",
      "code": "\"Notifier::#{Event.eventable.class}EventNotifier\".safe_constantize",
      "render_path": null,
      "location": {
        "type": "method",
        "class": "Notifier",
        "method": "s(:self).for"
      },
      "user_input": "Event.eventable.class",
      "confidence": "Medium",
      "cwe_id": [
        470
      ],
      "note": ""
    },
    {
      "warning_type": "SQL Injection",
      "warning_code": 0,
      "fingerprint": "bbd8fe3cbbc6b393df770d3142d6fa46e2b9441b21f48a52175211acaae4efad",
      "check_name": "SQL",
      "message": "Possible SQL injection",
      "file": "app/models/card/entropic.rb",
      "line": 10,
      "link": "https://brakemanscanner.org/docs/warning_types/sql_injection/",
      "code": "active.joins(:board => :account).left_outer_joins(:board => :entropy).joins(\"LEFT OUTER JOIN entropies AS account_entropies ON account_entropies.account_id = accounts.id AND account_entropies.container_type = 'Account' AND account_entropies.container_id = accounts.id\").where(\"last_active_at <= #{connection.date_subtract(\"?\", \"COALESCE(entropies.auto_postpone_period, account_entropies.auto_postpone_period)\")}\", Time.now)",
      "render_path": null,
      "location": {
        "type": "method",
        "class": "Card::Entropic",
        "method": null
      },
      "user_input": "connection.date_subtract(\"?\", \"COALESCE(entropies.auto_postpone_period, account_entropies.auto_postpone_period)\")",
      "confidence": "Weak",
      "cwe_id": [
        89
      ],
      "note": "No user input allowed"
    }
  ],
  "brakeman_version": "7.1.2"
}

================
File: config/cable.yml
================
cable: &cable
  adapter: solid_cable
  connects_to:
    database:
      writing: cable
      reading: cable
  polling_interval: 0.1.seconds
  message_retention: 1.day
development: *cable
test:
  adapter: test
beta: *cable
staging: *cable
production: *cable

================
File: config/cache.yml
================
default_options: &default_options
  store_options:
    max_age: <%= 60.days.to_i %>
    namespace: <%= "#{Rails.env}#{"-#{ENV["CACHE_NAMESPACE"]}" if ENV["CACHE_NAMESPACE"]}" %>
default_connection: &default_connection
  database: cache
default: &default
  <<: *default_connection
  <<: *default_options
development: *default
test: *default_options
beta: *default
staging: *default
production: *default

================
File: config/ci.rb
================
# Run using bin/ci
require_relative "../lib/fizzy"
OSS_ENV = "SAAS=false BUNDLE_GEMFILE=Gemfile"
SAAS_ENV = "SAAS=true BUNDLE_GEMFILE=Gemfile.saas"
SYSTEM_TEST_ENV = "PARALLEL_WORKERS=1" # system tests can't run reliably in parallel
CI.run do
  step "Setup", "bin/setup --skip-server"
  step "Style: Ruby", "bin/rubocop"
  step "Gemfile: Drift check", "bin/bundle-drift check"
  step "Security: Gem audit", "bin/bundler-audit check --update"
  step "Security: Importmap audit", "bin/importmap audit"
  step "Security: Brakeman audit", "bin/brakeman --quiet --no-pager --exit-on-warn --exit-on-error"
  step "Security: Gitleaks audit", "bin/gitleaks-audit"
  if Fizzy.saas?
    step "Tests: SaaS",          "#{SAAS_ENV} bin/rails test"
    step "Tests: SaaS System",   "#{SAAS_ENV} #{SYSTEM_TEST_ENV} bin/rails test:system"
    step "Tests: OSS",           "#{OSS_ENV} bin/rails test"
    step "Tests: OSS System",    "#{OSS_ENV} #{SYSTEM_TEST_ENV} bin/rails test:system"
  else
    step "Tests: SQLite",        "#{OSS_ENV} bin/rails test"
    step "Tests: SQLite System", "#{OSS_ENV} #{SYSTEM_TEST_ENV} bin/rails test:system"
  end
  if success?
    step "Signoff: All systems go. Ready for merge and deploy.", "gh signoff"
  else
    failure "Signoff: CI failed. Do not merge or deploy.", "Fix the issues and try again."
  end
end

================
File: config/database.mysql.yml
================
default: &default
  adapter: trilogy
  host: <%= ENV.fetch("MYSQL_HOST", "127.0.0.1") %>
  port: <%= ENV.fetch("MYSQL_PORT", "3306") %>
  username: <%= ENV.fetch("MYSQL_USER", "root") %>
  password: <%= ENV["MYSQL_PASSWORD"] %>
  pool: 50
  ssl_mode: <%= ENV["MYSQL_SSL_MODE"] %>
  timeout: 5000
development:
  primary:
    <<: *default
    database: fizzy_development
  cable:
    <<: *default
    database: fizzy_development_cable
    migrations_paths: db/cable_migrate
test:
  primary:
    <<: *default
    database: fizzy_test
  cable:
    <<: *default
    database: fizzy_test_cable
    migrations_paths: db/cable_migrate
production:
  primary:
    <<: *default
    database: fizzy_production
  cable:
    <<: *default
    database: fizzy_production_cable
    migrations_paths: db/cable_migrate
  queue:
    <<: *default
    database: fizzy_production_queue
    migrations_paths: db/queue_migrate
  cache:
    <<: *default
    database: fizzy_production_cache
    migrations_paths: db/cache_migrate

================
File: config/database.sqlite.yml
================
default: &default
  adapter: sqlite3
  pool: 5
  timeout: 5000
development:
  primary:
    <<: *default
    database: storage/development.sqlite3
    schema_dump: schema_sqlite.rb
  cable:
    <<: *default
    database: storage/development_cable.sqlite3
    migrations_paths: db/cable_migrate
test:
  primary:
    <<: *default
    database: storage/test.sqlite3
    schema_dump: schema_sqlite.rb
  cable:
    <<: *default
    database: storage/test_cable.sqlite3
    migrations_paths: db/cable_migrate
production:
  primary:
    <<: *default
    database: storage/production.sqlite3
    schema_dump: schema_sqlite.rb
  cable:
    <<: *default
    database: storage/production_cable.sqlite3
    migrations_paths: db/cable_migrate
  cache:
    <<: *default
    database: storage/production_cache.sqlite3
    migrations_paths: db/cache_migrate
  queue:
    <<: *default
    database: storage/production_queue.sqlite3
    migrations_paths: db/queue_migrate

================
File: config/database.yml
================
<%
  config_path = if Fizzy.saas?
    gem_path = Rails.root.join("saas").to_s
    File.join(gem_path, "config", "database.yml")
  else
    File.join("config", "database.#{Fizzy.db_adapter}.yml")
  end
%>
<%= ERB.new(File.read(config_path)).result %>

================
File: config/deploy.yml
================
# Name of this app
service: fizzy
image: fizzy
#-- About your deployment --#
# Where to deploy fizzy
servers:
  web:
    - fizzy.example.com  # Set your server name here
# How you connect to your server
ssh:
  user: root  # If you use a different username to SSH to your server, specify it here
# Automatic SSL
proxy:
  ssl: true                # Set this to false if you *don't* want SSL
  host: fizzy.example.com  # Set your server name here to use automatic SSL
# Your application configuration (secrets come from .kamal/secrets).
env:
  secret:
    - SECRET_KEY_BASE
    - VAPID_PUBLIC_KEY
    - VAPID_PRIVATE_KEY
    - SMTP_USERNAME
    - SMTP_PASSWORD
  clear:
    BASE_URL: https://fizzy.example.com # The public URL of your Fizzy instance
    MAILER_FROM_ADDRESS: support@example.com # The email "from" address that Fizzy sends email from
    SMTP_ADDRESS: mail.example.com # The SMTP server you'll use to send email
    MULTI_TENANT: false # Set to true to allow multiple accounts to sign up
    SOLID_QUEUE_IN_PUMA: true # Run background jobs in the app container
#-- General configuration --#
# Use a local registry to deploy
registry:
  server: localhost:5555
# Handy aliases for interacting with your deployment. For eaxmple: `bin/kamal console` will connect to a
# Rails console in production.
aliases:
  console: app exec --interactive --reuse "bin/rails console"
  shell: app exec --interactive --reuse "bash"
  logs: app logs -f
  dbc: app exec --interactive --reuse "bin/rails dbconsole --include-password"
# Use a persistent storage volume for sqlite database files and local Active Storage files.
# Recommended to change this to a mounted volume path that is backed up off server.
volumes:
  - "fizzy_storage:/rails/storage"
# Bridge fingerprinted assets, like JS and CSS, between versions to avoid
# hitting 404 on in-flight requests. Combines all files from new and old
# version inside the asset_path.
asset_path: /rails/public/assets
# Configure the image builder.
builder:
  arch: amd64

================
File: config/environment.rb
================
# Load the Rails application.
require_relative "application"
# Initialize the Rails application.
Rails.application.initialize!

================
File: config/importmap.rb
================
# Pin npm packages by running ./bin/importmap
pin "application"
pin "@hotwired/turbo-rails", to: "turbo.min.js"
pin "@hotwired/stimulus", to: "stimulus.min.js"
pin "@hotwired/stimulus-loading", to: "stimulus-loading.js"
pin "@hotwired/hotwire-native-bridge", to: "@hotwired--hotwire-native-bridge.js"
pin "@rails/request.js", to: "@rails--request.js" # @0.0.13
pin_all_from "app/javascript/controllers", under: "controllers"
pin_all_from "app/javascript/helpers", under: "helpers"
pin_all_from "app/javascript/initializers", under: "initializers"
pin_all_from "app/javascript/bridge/initializers", under: "bridge/initializers"
pin_all_from "app/javascript/bridge/helpers", under: "bridge/helpers"
pin_all_from "app/javascript/bridge/controllers/bridge", under: "controllers/bridge", to: "bridge/controllers/bridge"
pin "marked" # @15.0.11
pin "lexxy"
pin "@rails/activestorage", to: "activestorage.esm.js"
pin "@rails/actiontext", to: "actiontext.esm.js"

================
File: config/puma.rb
================
# Specifies the `port` that Puma will listen on to receive requests; default is 3000.
port ENV.fetch("PORT", 3000)
# Specifies the `pidfile` that Puma will use.
pidfile ENV.fetch("PIDFILE", "tmp/pids/server.pid")
# Allow puma to be restarted by `bin/rails restart` command.
plugin :tmp_restart
# Run Solid Queue with Puma by default.
# Disabled when running fizzy-saas or via SOLID_QUEUE_IN_PUMA=false.
unless Fizzy.saas? || ENV["SOLID_QUEUE_IN_PUMA"] == "false"
  plugin :solid_queue
end
# Expose Prometheus metrics at http://0.0.0.0:9394/metrics (SaaS only).
# In dev, overridden to http://127.0.0.1:9306/metrics in .mise.toml.
if Fizzy.saas?
  control_uri = Rails.env.local? ? "unix://tmp/pumactl.sock" : "auto"
  activate_control_app control_uri, no_token: true
  plugin :yabeda
  plugin :yabeda_prometheus
end
if !Rails.env.local?
  # Because we expect fewer I/O waits than Rails apps that connect to the
  # database over the network, let's start with a baseline config of 1
  # worker per CPU, 1 thread per worker and tune it from there.
  #
  # https://edgeguides.rubyonrails.org/tuning_performance_for_deployment.html#puma
  workers Integer(ENV.fetch("WEB_CONCURRENCY") { Concurrent.physical_processor_count })
  threads 1, 1
  # Tell the Ruby VM that we're finished booting up.
  #
  # Now's the time to tidy the heap (GC, compact, free empty, malloc_trim, etc)
  # for optimal copy-on-write efficiency.
  before_fork do
    Process.warmup
  end
  # Defer major GC (full marking phase) until after request handling,
  # and perform major GC deferred during request handling.
  before_worker_boot do
    GC.config(rgengc_allow_full_mark: false)
  end
  out_of_band do
    GC.start if GC.latest_gc_info(:need_major_by)
  end
end

================
File: config/queue.yml
================
default: &default
  dispatchers:
    - polling_interval: 1
      batch_size: 500
  workers:
    - queues: [ "default", "solid_queue_recurring", "backend", "webhooks", "*" ]
      threads: 3
      processes: <%= Integer(ENV.fetch("JOB_CONCURRENCY") { Concurrent.physical_processor_count }) %>
      polling_interval: 0.1
development: *default
test: *default
beta: *default
staging: *default
production: *default

================
File: config/recurring.yml
================
<% require_relative "../lib/fizzy" %>
production: &production
  # Application functionality: notifications and summaries
  deliver_bundled_notifications:
    command: "Notification::Bundle.deliver_all_later"
    schedule: every 30 minutes
  # Application cleanup
  auto_postpone_all_due:
    command: "Card.auto_postpone_all_due"
    schedule: every hour at minute 50
  delete_unused_tags:
    class: DeleteUnusedTagsJob
    schedule: every day at 04:02
  # Operations cleanup and backups
  clear_solid_queue_finished_jobs:
    command: "SolidQueue::Job.clear_finished_in_batches(sleep_between_batches: 0.3)"
    schedule: every hour at minute 12
  cleanup_webhook_deliveries:
    command: "Webhook::Delivery.cleanup"
    schedule: every 4 hours at minute 51
  cleanup_magic_links:
    command: "MagicLink.cleanup"
    schedule: every 4 hours
  cleanup_exports:
    command: "Export.cleanup"
    schedule: every hour at minute 20
  cleanup_imports:
    command: "Account::Import.cleanup"
    schedule: every hour at minute 25
  incineration:
    class: "Account::IncinerateDueJob"
    schedule: every 8 hours at minute 16
<% if Fizzy.saas? %>
  # Metrics
  yabeda_actioncable:
    command: "Yabeda::ActionCable.measure"
    schedule: every 60 seconds
<% end %>
beta:
  # Only Solid Queue maintenance
  clear_solid_queue_finished_jobs:
    command: "SolidQueue::Job.clear_finished_in_batches(sleep_between_batches: 0.3)"
    schedule: every hour at minute 12
staging: *production
development: *production

================
File: config/routes.rb
================
Rails.application.routes.draw do
  root "events#index"
  namespace :account do
    resource :cancellation, only: [ :create ]
    resource :entropy
    resource :join_code
    resource :settings
    resources :exports, only: [ :create, :show ]
    resources :imports, only: [ :new, :create, :show ]
  end
  resources :users do
    scope module: :users do
      resource :avatar
      resource :role
      resource :events
      resources :push_subscriptions
      resources :email_addresses, param: :token do
        resource :confirmation, module: :email_addresses
      end
      resources :data_exports, only: [ :create, :show ]
    end
  end
  resources :boards do
    scope module: :boards do
      resource :subscriptions
      resource :involvement
      resource :publication
      resource :entropy
      namespace :columns do
        resource :not_now
        resource :stream
        resource :closed
      end
      resources :columns
    end
    resources :cards, only: :create
    resources :webhooks do
      scope module: :webhooks do
        resource :activation, only: :create
      end
    end
  end
  resources :columns, only: [] do
    resource :left_position, module: :columns
    resource :right_position, module: :columns
  end
  namespace :columns do
    resources :cards do
      scope module: :cards do
        namespace :drops do
          resource :not_now
          resource :stream
          resource :closure
          resource :column
        end
      end
    end
  end
  namespace :cards do
    resources :previews
  end
  resources :cards do
    scope module: :cards do
      resource :draft, only: :show
      resource :board
      resource :closure
      resource :column
      resource :goldness
      resource :image
      resource :not_now
      resource :pin
      resource :publish
      resource :reading
      resource :triage
      resource :watch
      resource :reading
      resources :reactions
      resources :assignments
      resource :self_assignment, only: :create
      resources :steps
      resources :taggings
      resources :comments do
        resources :reactions, module: :comments
      end
    end
  end
  resources :tags, only: :index
  namespace :notifications do
    resource :settings
    resource :unsubscribe
  end
  resources :notifications do
    scope module: :notifications do
      get "tray", to: "trays#show", on: :collection
      resource :reading
      collection do
        resource :bulk_reading, only: :create
      end
    end
  end
  resource :search
  namespace :searches do
    resources :queries
  end
  resources :filters do
    scope module: :filters do
      collection do
        resource :settings_refresh, only: :create
      end
    end
  end
  resources :events, only: :index
  namespace :events do
    resources :days
    namespace :day_timeline do
      resources :columns, only: :show
    end
  end
  resources :qr_codes
  get "join/:code", to: "join_codes#new", as: :join
  post "join/:code", to: "join_codes#create"
  namespace :users do
    resources :joins
    resources :verifications, only: %i[ new create ]
  end
  resource :session do
    scope module: :sessions do
      resources :transfers
      resource :magic_link
      resource :menu
    end
  end
  get "/signup", to: redirect("/signup/new")
  resource :signup, only: %i[ new create ] do
    collection do
      scope module: :signups, as: :signup do
        resource :completion, only: %i[ new create ]
      end
    end
  end
  resource :landing
  namespace :my do
    resource :identity, only: :show
    resources :access_tokens
    resources :pins
    resource :timezone
    resource :menu
  end
  namespace :prompts do
    resources :cards
    resources :tags
    resources :users
    resources :boards do
      scope module: :boards do
        resources :users
      end
    end
  end
  namespace :public do
    resources :boards do
      scope module: :boards do
        namespace :columns do
          resource :not_now, only: :show
          resource :stream, only: :show
          resource :closed, only: :show
        end
        resources :columns, only: :show
      end
      resources :cards, only: :show
    end
  end
  direct :published_board do |board, options|
    route_for :public_board, board.publication.key
  end
  direct :published_card do |card, options|
    route_for :public_board_card, card.board.publication.key, card
  end
  resolve "Comment" do |comment, options|
    options[:anchor] = ActionView::RecordIdentifier.dom_id(comment)
    route_for :card, comment.card, options
  end
  resolve "Mention" do |mention, options|
    polymorphic_url(mention.source, options)
  end
  resolve "Notification" do |notification, options|
    polymorphic_url(notification.notifiable_target, options)
  end
  resolve "Event" do |event, options|
    polymorphic_url(event.eventable, options)
  end
  resolve "Webhook" do |webhook, options|
    route_for :board_webhook, webhook.board, webhook, options
  end
  # Support for legacy URLs
  get "/collections/:collection_id/cards/:id", to: redirect { |params, request| "#{request.script_name}/cards/#{params[:id]}" }
  get "/collections/:id", to: redirect { |params, request| "#{request.script_name}/boards/#{params[:id]}" }
  get "/public/collections/:id", to: redirect { |params, request| "#{request.script_name}/public/boards/#{params[:id]}" }
  get "up", to: "rails/health#show", as: :rails_health_check
  get "manifest" => "rails/pwa#manifest", as: :pwa_manifest
  get "service-worker" => "pwa#service_worker"
  namespace :admin do
    mount MissionControl::Jobs::Engine, at: "/jobs"
  end
end

================
File: config/storage.oss.yml
================
test:
  service: Disk
  root: <%= Rails.root.join("tmp/storage/files") %>
local:
  service: Disk
  root: <%= Rails.root.join("storage", Rails.env, "files") %>
devminio:
  service: S3
  bucket: fizzy-dev-activestorage
  endpoint: "http://minio.localhost:39000"
  force_path_style: true
  request_checksum_calculation: when_required # default is when_supported with CRC64NVME checksum which FlashBlade doesn't support
  response_checksum_validation: when_required # default is when_supported with CRC64NVME checksum which FlashBlade doesn't support
  region: us-east-1 # default region required for signer
  access_key_id: minioadmin
  secret_access_key: minioadmin
s3:
  service: S3
  access_key_id: <%= ENV["S3_ACCESS_KEY_ID"] %>
  bucket: <%= ENV["S3_BUCKET"] || "fizzy-#{Rails.env}-activestorage" %>
  endpoint: <%= ENV["S3_ENDPOINT"] %>
  force_path_style: <%= ENV["S3_FORCE_PATH_STYLE"] == "true" %>
  region: <%= ENV.fetch("S3_REGION", "us-east-1") %>
  request_checksum_calculation: <%= ENV.fetch("S3_REQUEST_CHECKSUM_CALCULATION", "when_supported") %>
  response_checksum_validation: <%= ENV.fetch("S3_RESPONSE_CHECKSUM_VALIDATION", "when_supported") %>
  secret_access_key: <%= ENV["S3_SECRET_ACCESS_KEY"] %>

================
File: config/storage.yml
================
<%
  config_path = if Fizzy.saas?
    gem_path = Gem::Specification.find_by_name("fizzy-saas").gem_dir
    File.join(gem_path, "config", "storage.yml")
  else
    File.join(__dir__, "storage.oss.yml")
  end
%>
<%= ERB.new(File.read(config_path)).result %>

================
File: db/migrate/20251111122540_initial_schema.rb
================
class InitialSchema < ActiveRecord::Migration[8.2]
  def change
    create_table "accesses", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci" do |t|
      t.datetime "accessed_at"
      t.uuid "board_id", null: false
      t.datetime "created_at", null: false
      t.string "involvement", limit: 255, default: "access_only", null: false
      t.datetime "updated_at", null: false
      t.uuid "user_id", null: false
      t.index ["accessed_at"], name: "index_accesses_on_accessed_at", order: :desc
      t.index ["board_id", "user_id"], name: "index_accesses_on_board_id_and_user_id", unique: true
      t.index ["board_id"], name: "index_accesses_on_board_id"
      t.index ["user_id"], name: "index_accesses_on_user_id"
    end
    create_table "account_join_codes", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci" do |t|
      t.uuid "account_id"
      t.string "code", limit: 255, null: false
      t.datetime "created_at", null: false
      t.datetime "updated_at", null: false
      t.integer "usage_count", default: 0, null: false
      t.integer "usage_limit", default: 10, null: false
      t.index ["code"], name: "index_account_join_codes_on_code", unique: true
    end
    create_table "accounts", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci" do |t|
      t.datetime "created_at", null: false
      t.integer "external_account_id"
      t.string "name", limit: 255, null: false
      t.datetime "updated_at", null: false
      t.index ["external_account_id"], name: "index_accounts_on_external_account_id", unique: true
    end
    create_table "action_text_rich_texts", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci" do |t|
      t.text "body", size: :long
      t.datetime "created_at", null: false
      t.string "name", limit: 255, null: false
      t.uuid "record_id", null: false
      t.string "record_type", limit: 255, null: false
      t.datetime "updated_at", null: false
      t.index ["record_type", "record_id", "name"], name: "index_action_text_rich_texts_uniqueness", unique: true
    end
    create_table "active_storage_attachments", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci" do |t|
      t.uuid "blob_id", null: false
      t.datetime "created_at", null: false
      t.string "name", limit: 255, null: false
      t.uuid "record_id", null: false
      t.string "record_type", limit: 255, null: false
      t.index ["blob_id"], name: "index_active_storage_attachments_on_blob_id"
      t.index ["record_type", "record_id", "name", "blob_id"], name: "index_active_storage_attachments_uniqueness", unique: true
    end
    create_table "active_storage_blobs", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci" do |t|
      t.bigint "byte_size", null: false
      t.string "checksum", limit: 255
      t.string "content_type", limit: 255
      t.datetime "created_at", null: false
      t.string "filename", limit: 255, null: false
      t.string "key", limit: 255, null: false
      t.text "metadata"
      t.string "service_name", limit: 255, null: false
      t.index ["key"], name: "index_active_storage_blobs_on_key", unique: true
    end
    create_table "active_storage_variant_records", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci" do |t|
      t.uuid "blob_id", null: false
      t.string "variation_digest", limit: 255, null: false
      t.index ["blob_id", "variation_digest"], name: "index_active_storage_variant_records_uniqueness", unique: true
    end
    create_table "assignees_filters", id: false, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci" do |t|
      t.uuid "assignee_id", null: false
      t.uuid "filter_id", null: false
      t.index ["assignee_id"], name: "index_assignees_filters_on_assignee_id"
      t.index ["filter_id"], name: "index_assignees_filters_on_filter_id"
    end
    create_table "assigners_filters", id: false, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci" do |t|
      t.uuid "assigner_id", null: false
      t.uuid "filter_id", null: false
      t.index ["assigner_id"], name: "index_assigners_filters_on_assigner_id"
      t.index ["filter_id"], name: "index_assigners_filters_on_filter_id"
    end
    create_table "assignments", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci" do |t|
      t.uuid "assignee_id", null: false
      t.uuid "assigner_id", null: false
      t.uuid "card_id", null: false
      t.datetime "created_at", null: false
      t.datetime "updated_at", null: false
      t.index ["assignee_id", "card_id"], name: "index_assignments_on_assignee_id_and_card_id", unique: true
      t.index ["card_id"], name: "index_assignments_on_card_id"
    end
    create_table "board_publications", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci" do |t|
      t.uuid "board_id", null: false
      t.datetime "created_at", null: false
      t.string "key", limit: 255
      t.datetime "updated_at", null: false
      t.index ["board_id"], name: "index_board_publications_on_board_id"
      t.index ["key"], name: "index_board_publications_on_key", unique: true
    end
    create_table "boards", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci" do |t|
      t.uuid "account_id"
      t.boolean "all_access", default: false, null: false
      t.datetime "created_at", null: false
      t.uuid "creator_id", null: false
      t.string "name", limit: 255, null: false
      t.datetime "updated_at", null: false
      t.index ["creator_id"], name: "index_boards_on_creator_id"
    end
    create_table "boards_filters", id: false, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci" do |t|
      t.uuid "board_id", null: false
      t.uuid "filter_id", null: false
      t.index ["board_id"], name: "index_boards_filters_on_board_id"
      t.index ["filter_id"], name: "index_boards_filters_on_filter_id"
    end
    create_table "card_activity_spikes", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci" do |t|
      t.uuid "card_id", null: false
      t.datetime "created_at", null: false
      t.datetime "updated_at", null: false
      t.index ["card_id"], name: "index_card_activity_spikes_on_card_id"
    end
    create_table "card_engagements", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci" do |t|
      t.uuid "card_id"
      t.datetime "created_at", null: false
      t.string "status", limit: 255, default: "doing", null: false
      t.datetime "updated_at", null: false
      t.index ["card_id"], name: "index_card_engagements_on_card_id"
      t.index ["status"], name: "index_card_engagements_on_status"
    end
    create_table "card_goldnesses", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci" do |t|
      t.uuid "card_id", null: false
      t.datetime "created_at", null: false
      t.datetime "updated_at", null: false
      t.index ["card_id"], name: "index_card_goldnesses_on_card_id", unique: true
    end
    create_table "card_not_nows", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci" do |t|
      t.uuid "card_id", null: false
      t.datetime "created_at", null: false
      t.datetime "updated_at", null: false
      t.uuid "user_id"
      t.index ["card_id"], name: "index_card_not_nows_on_card_id", unique: true
      t.index ["user_id"], name: "index_card_not_nows_on_user_id"
    end
    create_table "cards", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci" do |t|
      t.uuid "account_id"
      t.uuid "board_id", null: false
      t.uuid "column_id"
      t.datetime "created_at", null: false
      t.uuid "creator_id", null: false
      t.date "due_on"
      t.datetime "last_active_at", null: false
      t.string "status", limit: 255, default: "drafted", null: false
      t.string "title", limit: 255
      t.datetime "updated_at", null: false
      t.index ["board_id"], name: "index_cards_on_board_id"
      t.index ["column_id"], name: "index_cards_on_column_id"
      t.index ["last_active_at", "status"], name: "index_cards_on_last_active_at_and_status"
    end
    create_table "closers_filters", id: false, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci" do |t|
      t.uuid "closer_id", null: false
      t.uuid "filter_id", null: false
      t.index ["closer_id"], name: "index_closers_filters_on_closer_id"
      t.index ["filter_id"], name: "index_closers_filters_on_filter_id"
    end
    create_table "closures", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci" do |t|
      t.uuid "card_id", null: false
      t.datetime "created_at", null: false
      t.datetime "updated_at", null: false
      t.uuid "user_id"
      t.index ["card_id", "created_at"], name: "index_closures_on_card_id_and_created_at"
      t.index ["card_id"], name: "index_closures_on_card_id", unique: true
      t.index ["user_id"], name: "index_closures_on_user_id"
    end
    create_table "columns", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci" do |t|
      t.uuid "account_id"
      t.uuid "board_id", null: false
      t.string "color", limit: 255, null: false
      t.datetime "created_at", null: false
      t.string "name", limit: 255, null: false
      t.integer "position", default: 0, null: false
      t.datetime "updated_at", null: false
      t.index ["board_id", "position"], name: "index_columns_on_board_id_and_position"
      t.index ["board_id"], name: "index_columns_on_board_id"
    end
    create_table "comments", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci" do |t|
      t.uuid "account_id"
      t.uuid "card_id", null: false
      t.datetime "created_at", null: false
      t.uuid "creator_id", null: false
      t.datetime "updated_at", null: false
      t.index ["card_id"], name: "index_comments_on_card_id"
    end
    create_table "creators_filters", id: false, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci" do |t|
      t.uuid "creator_id", null: false
      t.uuid "filter_id", null: false
      t.index ["creator_id"], name: "index_creators_filters_on_creator_id"
      t.index ["filter_id"], name: "index_creators_filters_on_filter_id"
    end
    create_table "entropies", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci" do |t|
      t.bigint "auto_postpone_period", default: 2592000, null: false
      t.uuid "container_id", null: false
      t.string "container_type", limit: 255, null: false
      t.datetime "created_at", null: false
      t.datetime "updated_at", null: false
      t.index ["container_type", "container_id", "auto_postpone_period"], name: "idx_on_container_type_container_id_auto_postpone_pe_3d79b50517"
      t.index ["container_type", "container_id"], name: "index_entropy_configurations_on_container", unique: true
    end
    create_table "events", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci" do |t|
      t.uuid "account_id"
      t.string "action", limit: 255, null: false
      t.uuid "board_id", null: false
      t.datetime "created_at", null: false
      t.uuid "creator_id", null: false
      t.uuid "eventable_id", null: false
      t.string "eventable_type", limit: 255, null: false
      t.json "particulars", default: -> { "(json_object())" }
      t.datetime "updated_at", null: false
      t.index ["action"], name: "index_events_on_summary_id_and_action"
      t.index ["board_id", "action", "created_at"], name: "index_events_on_board_id_and_action_and_created_at"
      t.index ["board_id"], name: "index_events_on_board_id"
      t.index ["creator_id"], name: "index_events_on_creator_id"
      t.index ["eventable_type", "eventable_id"], name: "index_events_on_eventable"
    end
    create_table "filters", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci" do |t|
      t.uuid "account_id"
      t.datetime "created_at", null: false
      t.uuid "creator_id", null: false
      t.json "fields", default: -> { "(json_object())" }, null: false
      t.string "params_digest", limit: 255, null: false
      t.datetime "updated_at", null: false
      t.index ["creator_id", "params_digest"], name: "index_filters_on_creator_id_and_params_digest", unique: true
    end
    create_table "filters_tags", id: false, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci" do |t|
      t.uuid "filter_id", null: false
      t.uuid "tag_id", null: false
      t.index ["filter_id"], name: "index_filters_tags_on_filter_id"
      t.index ["tag_id"], name: "index_filters_tags_on_tag_id"
    end
    create_table "identities", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci" do |t|
      t.datetime "created_at", null: false
      t.string "email_address", limit: 255, null: false
      t.datetime "updated_at", null: false
      t.index ["email_address"], name: "index_identities_on_email_address", unique: true
    end
    create_table "magic_links", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci" do |t|
      t.string "code", limit: 255, null: false
      t.datetime "created_at", null: false
      t.datetime "expires_at", null: false
      t.uuid "identity_id"
      t.datetime "updated_at", null: false
      t.index ["code"], name: "index_magic_links_on_code", unique: true
      t.index ["expires_at"], name: "index_magic_links_on_expires_at"
      t.index ["identity_id"], name: "index_magic_links_on_identity_id"
    end
    create_table "memberships", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci" do |t|
      t.datetime "created_at", null: false
      t.uuid "identity_id", null: false
      t.string "join_code", limit: 255
      t.string "tenant", limit: 255, null: false
      t.datetime "updated_at", null: false
      t.index ["identity_id"], name: "index_memberships_on_identity_id"
      t.index ["tenant", "identity_id"], name: "index_memberships_on_tenant_and_identity_id", unique: true
      t.index ["tenant"], name: "index_memberships_on_user_tenant_and_user_id"
    end
    create_table "mentions", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci" do |t|
      t.datetime "created_at", null: false
      t.uuid "mentionee_id", null: false
      t.uuid "mentioner_id", null: false
      t.uuid "source_id", null: false
      t.string "source_type", limit: 255, null: false
      t.datetime "updated_at", null: false
      t.index ["mentionee_id"], name: "index_mentions_on_mentionee_id"
      t.index ["mentioner_id"], name: "index_mentions_on_mentioner_id"
      t.index ["source_type", "source_id"], name: "index_mentions_on_source"
    end
    create_table "notification_bundles", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci" do |t|
      t.uuid "account_id"
      t.datetime "created_at", null: false
      t.datetime "ends_at", null: false
      t.datetime "starts_at", null: false
      t.integer "status", default: 0, null: false
      t.datetime "updated_at", null: false
      t.uuid "user_id", null: false
      t.index ["ends_at", "status"], name: "index_notification_bundles_on_ends_at_and_status"
      t.index ["user_id", "starts_at", "ends_at"], name: "idx_on_user_id_starts_at_ends_at_7eae5d3ac5"
      t.index ["user_id", "status"], name: "index_notification_bundles_on_user_id_and_status"
    end
    create_table "notifications", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci" do |t|
      t.uuid "account_id"
      t.datetime "created_at", null: false
      t.uuid "creator_id"
      t.datetime "read_at"
      t.uuid "source_id", null: false
      t.string "source_type", limit: 255, null: false
      t.datetime "updated_at", null: false
      t.uuid "user_id", null: false
      t.index ["creator_id"], name: "index_notifications_on_creator_id"
      t.index ["source_type", "source_id"], name: "index_notifications_on_source"
      t.index ["user_id", "read_at", "created_at"], name: "index_notifications_on_user_id_and_read_at_and_created_at", order: { read_at: :desc, created_at: :desc }
      t.index ["user_id"], name: "index_notifications_on_user_id"
    end
    create_table "pins", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci" do |t|
      t.uuid "card_id", null: false
      t.datetime "created_at", null: false
      t.datetime "updated_at", null: false
      t.uuid "user_id", null: false
      t.index ["card_id", "user_id"], name: "index_pins_on_card_id_and_user_id", unique: true
      t.index ["card_id"], name: "index_pins_on_card_id"
      t.index ["user_id"], name: "index_pins_on_user_id"
    end
    create_table "push_subscriptions", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci" do |t|
      t.uuid "account_id"
      t.string "auth_key", limit: 255
      t.datetime "created_at", null: false
      t.text "endpoint"
      t.string "p256dh_key", limit: 255
      t.datetime "updated_at", null: false
      t.string "user_agent", limit: 255
      t.uuid "user_id", null: false
      t.index ["endpoint", "p256dh_key", "auth_key"], name: "idx_on_endpoint_p256dh_key_auth_key_7553014576"
      t.index ["endpoint"], name: "index_push_subscriptions_on_endpoint"
      t.index ["user_agent"], name: "index_push_subscriptions_on_user_agent"
      t.index ["user_id", "endpoint"], name: "index_push_subscriptions_on_user_id_and_endpoint", unique: true
      t.index ["user_id"], name: "index_push_subscriptions_on_user_id"
    end
    create_table "reactions", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci" do |t|
      t.uuid "comment_id", null: false
      t.string "content", limit: 16, null: false
      t.datetime "created_at", null: false
      t.uuid "reacter_id", null: false
      t.datetime "updated_at", null: false
      t.index ["comment_id"], name: "index_reactions_on_comment_id"
      t.index ["reacter_id"], name: "index_reactions_on_reacter_id"
    end
    create_table "search_queries", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci" do |t|
      t.datetime "created_at", null: false
      t.string "terms", limit: 2000, null: false
      t.datetime "updated_at", null: false
      t.uuid "user_id", null: false
      t.index ["user_id", "terms"], name: "index_search_queries_on_user_id_and_terms", length: { terms: 255 }
      t.index ["user_id", "updated_at"], name: "index_search_queries_on_user_id_and_updated_at", unique: true
      t.index ["user_id"], name: "index_search_queries_on_user_id"
    end
    create_table "search_results", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci" do |t|
      t.datetime "created_at", null: false
      t.datetime "updated_at", null: false
    end
    create_table "sessions", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci" do |t|
      t.datetime "created_at", null: false
      t.uuid "identity_id", null: false
      t.string "ip_address", limit: 255
      t.datetime "updated_at", null: false
      t.string "user_agent", limit: 255
      t.index ["identity_id"], name: "index_sessions_on_identity_id"
    end
    create_table "steps", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci" do |t|
      t.uuid "account_id"
      t.uuid "card_id", null: false
      t.boolean "completed", default: false, null: false
      t.text "content", null: false
      t.datetime "created_at", null: false
      t.datetime "updated_at", null: false
      t.index ["card_id", "completed"], name: "index_steps_on_card_id_and_completed"
      t.index ["card_id"], name: "index_steps_on_card_id"
    end
    create_table "taggings", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci" do |t|
      t.uuid "card_id", null: false
      t.datetime "created_at", null: false
      t.uuid "tag_id", null: false
      t.datetime "updated_at", null: false
      t.index ["card_id", "tag_id"], name: "index_taggings_on_card_id_and_tag_id", unique: true
      t.index ["tag_id"], name: "index_taggings_on_tag_id"
    end
    create_table "tags", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci" do |t|
      t.uuid "account_id"
      t.datetime "created_at", null: false
      t.string "title", limit: 255
      t.datetime "updated_at", null: false
      t.index ["title"], name: "index_tags_on_title", unique: true
    end
    create_table "user_settings", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci" do |t|
      t.integer "bundle_email_frequency", default: 0, null: false
      t.datetime "created_at", null: false
      t.string "timezone_name", limit: 255
      t.datetime "updated_at", null: false
      t.uuid "user_id", null: false
      t.index ["user_id", "bundle_email_frequency"], name: "index_user_settings_on_user_id_and_bundle_email_frequency"
      t.index ["user_id"], name: "index_user_settings_on_user_id"
    end
    create_table "users", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci" do |t|
      t.uuid "account_id"
      t.boolean "active", default: true, null: false
      t.datetime "created_at", null: false
      t.uuid "membership_id"
      t.string "name", limit: 255, null: false
      t.string "role", limit: 255, default: "member", null: false
      t.datetime "updated_at", null: false
      t.index ["membership_id"], name: "index_users_on_membership_id"
      t.index ["role"], name: "index_users_on_role"
    end
    create_table "watches", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci" do |t|
      t.uuid "card_id", null: false
      t.datetime "created_at", null: false
      t.datetime "updated_at", null: false
      t.uuid "user_id", null: false
      t.boolean "watching", default: true, null: false
      t.index ["card_id"], name: "index_watches_on_card_id"
      t.index ["user_id", "card_id"], name: "index_watches_on_user_id_and_card_id"
      t.index ["user_id"], name: "index_watches_on_user_id"
    end
    create_table "webhook_delinquency_trackers", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci" do |t|
      t.integer "consecutive_failures_count", default: 0
      t.datetime "created_at", null: false
      t.datetime "first_failure_at"
      t.datetime "updated_at", null: false
      t.uuid "webhook_id", null: false
      t.index ["webhook_id"], name: "index_webhook_delinquency_trackers_on_webhook_id"
    end
    create_table "webhook_deliveries", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci" do |t|
      t.datetime "created_at", null: false
      t.uuid "event_id", null: false
      t.text "request"
      t.text "response"
      t.string "state", limit: 255, null: false
      t.datetime "updated_at", null: false
      t.uuid "webhook_id", null: false
      t.index ["event_id"], name: "index_webhook_deliveries_on_event_id"
      t.index ["webhook_id"], name: "index_webhook_deliveries_on_webhook_id"
    end
    create_table "webhooks", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci" do |t|
      t.uuid "account_id"
      t.boolean "active", default: true, null: false
      t.uuid "board_id", null: false
      t.datetime "created_at", null: false
      t.string "name", limit: 255
      t.string "signing_secret", limit: 255, null: false
      t.text "subscribed_actions"
      t.datetime "updated_at", null: false
      t.text "url", null: false
      t.index ["board_id"], name: "index_webhooks_on_board_id"
      t.index ["subscribed_actions"], name: "index_webhooks_on_subscribed_actions", length: 255
    end
    add_foreign_key "active_storage_attachments", "active_storage_blobs", column: "blob_id"
    add_foreign_key "active_storage_variant_records", "active_storage_blobs", column: "blob_id"
    add_foreign_key "board_publications", "boards"
    add_foreign_key "card_activity_spikes", "cards"
    add_foreign_key "card_goldnesses", "cards"
    add_foreign_key "card_not_nows", "cards"
    add_foreign_key "card_not_nows", "users"
    add_foreign_key "cards", "columns"
    add_foreign_key "closures", "cards"
    add_foreign_key "closures", "users"
    add_foreign_key "columns", "boards"
    add_foreign_key "comments", "cards"
    add_foreign_key "events", "boards"
    add_foreign_key "magic_links", "identities"
    add_foreign_key "memberships", "identities"
    add_foreign_key "mentions", "users", column: "mentionee_id"
    add_foreign_key "mentions", "users", column: "mentioner_id"
    add_foreign_key "notification_bundles", "users"
    add_foreign_key "notifications", "users"
    add_foreign_key "notifications", "users", column: "creator_id"
    add_foreign_key "pins", "cards"
    add_foreign_key "pins", "users"
    add_foreign_key "push_subscriptions", "users"
    add_foreign_key "search_queries", "users"
    add_foreign_key "sessions", "identities"
    add_foreign_key "steps", "cards"
    add_foreign_key "taggings", "cards"
    add_foreign_key "taggings", "tags"
    add_foreign_key "user_settings", "users"
    add_foreign_key "watches", "cards"
    add_foreign_key "watches", "users"
    add_foreign_key "webhook_delinquency_trackers", "webhooks"
    add_foreign_key "webhook_deliveries", "events"
    add_foreign_key "webhook_deliveries", "webhooks"
    add_foreign_key "webhooks", "boards"
  end
end

================
File: db/migrate/20251111153019_add_number_to_cards.rb
================
class AddNumberToCards < ActiveRecord::Migration[8.2]
  def change
    add_column :cards, :number, :bigint, null: false
    add_column :accounts, :cards_count, :bigint, default: 0, null: false
    add_index :cards, [:account_id, :number], unique: true
  end
end

================
File: db/migrate/20251112093037_create_search_indices.rb
================
class CreateSearchIndices < ActiveRecord::Migration[8.2]
  def up
    # Skip for SQLite - it doesn't use these tables
    return if connection.adapter_name == "SQLite"
    16.times do |i|
      create_table "search_index_#{i}".to_sym, id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci" do |t|
        t.string :searchable_type, null: false
        t.uuid :searchable_id, null: false
        t.uuid :card_id, null: false
        t.uuid :board_id, null: false
        t.string :title
        t.text :content
        t.datetime :created_at, null: false
        t.index [:searchable_type, :searchable_id], unique: true, name: "idx_si#{i}_type_id"
        t.index [:content, :title], type: :fulltext, name: "idx_si#{i}_fulltext"
      end
    end
  end
  def down
    # Skip for SQLite - it doesn't use these tables
    return if connection.adapter_name == "SQLite"
    16.times do |i|
      drop_table "search_index_#{i}".to_sym
    end
  end
end

================
File: db/migrate/20251112184932_remove_join_code_from_memberships.rb
================
class RemoveJoinCodeFromMemberships < ActiveRecord::Migration[8.2]
  def change
    remove_column :memberships, :join_code, :string
  end
end

================
File: db/migrate/20251113111501_drop_memberships.rb
================
class DropMemberships < ActiveRecord::Migration[8.2]
  def change
    add_reference :users, :identity, type: :uuid, null: true, foreign_key: true
    remove_column :users, :membership_id, :bigint
    drop_table :memberships
  end
end

================
File: db/migrate/20251113160907_add_missing_account_id_columns.rb
================
class AddMissingAccountIdColumns < ActiveRecord::Migration[8.2]
  MISSING_TABLES= %w[
    accesses
    assignments
    board_publications
    card_activity_spikes
    card_engagements
    card_goldnesses
    card_not_nows
    closures
    entropies
    mentions
    pins
    reactions
    search_queries
    taggings
    user_settings
    watches
    webhook_delinquency_trackers
    webhook_deliveries
    action_text_rich_texts
    active_storage_attachments
    active_storage_blobs
    active_storage_variant_records
  ]
  NOT_REQUIRED_TABLES = %w[
    account_join_codes
    boards
    cards
    columns
    comments
    events
    filters
    notification_bundles
    notifications
    push_subscriptions
    steps
    tags
    users
    webhooks
  ]
  def change
    MISSING_TABLES.each do |table|
      add_column table, "account_id", :uuid, null: false
    end
    NOT_REQUIRED_TABLES.each do |table|
      change_column table, "account_id", :uuid, null: false
    end
  end
end

================
File: db/migrate/20251113163145_ensure_account_id_index.rb
================
class EnsureAccountIdIndex < ActiveRecord::Migration[8.2]
  def change
    remove_index :accesses, :accessed_at
    add_index :accesses, [:account_id, :accessed_at]
    remove_index :account_join_codes, :code
    add_index :account_join_codes, [:account_id, :code], unique: true
    add_index :assignments, :account_id
    remove_index :board_publications, :key
    add_index :board_publications, [:account_id, :key]
    add_index :boards, :account_id
    add_index :card_activity_spikes, :account_id
    remove_index :card_engagements, :status
    add_index :card_engagements, [:account_id, :status]
    add_index :card_goldnesses, :account_id
    add_index :card_not_nows, :account_id
    remove_index :cards, [:last_active_at, :status]
    add_index :cards, [:account_id, :last_active_at, :status]
    add_index :closures, :account_id
    add_index :columns, :account_id
    add_index :comments, :account_id
    add_index :entropies, :account_id
    remove_index :events, :action
    add_index :events, [:account_id, :action]
    add_index :filters, :account_id
    add_index :mentions, :account_id
    add_index :notification_bundles, :account_id
    add_index :notifications, :account_id
    add_index :pins, :account_id
    add_index :push_subscriptions, :account_id
    remove_index :push_subscriptions, :endpoint # duplicative because we always query [user_id, endpoint]
    remove_index :push_subscriptions, [:endpoint, :p256dh_key, :auth_key] # duplicative and not necessary
    remove_index :push_subscriptions, :user_agent # not necessary
    remove_index :push_subscriptions, :user_id # duplicative of [user_id, endpoint]
    add_index :reactions, :account_id
    add_index :search_queries, :account_id
    add_index :steps, :account_id
    add_index :taggings, :account_id
    remove_index :tags, :title
    add_index :tags, [:account_id, :title], unique: true
    add_index :user_settings, :account_id
    remove_index :users, :role
    add_index :users, [:account_id, :role]
    add_index :watches, :account_id
    add_index :webhook_delinquency_trackers, :account_id
    add_index :webhook_deliveries, :account_id
    # For webhooks, I'm making an additional change to collapse board_id and subscribed_actions into
    # a single index, since Triggerable only queries for `subscribed_actions` in conjunction with
    # `board_id`.
    add_index :webhooks, :account_id
    remove_index :webhooks, :subscribed_actions
    add_index :webhooks, [:board_id, :subscribed_actions], length: { subscribed_actions: 255 }
    remove_index :webhooks, :board_id
    # Rails models
    add_index :action_text_rich_texts, :account_id
    add_index :active_storage_attachments, :account_id
    add_index :active_storage_blobs, :account_id
    add_index :active_storage_variant_records, :account_id
  end
end

================
File: db/migrate/20251113190256_create_search_record_shards.rb
================
class CreateSearchRecordShards < ActiveRecord::Migration[8.2]
  SHARD_COUNT = 16
  def change
    # Skip for SQLite - it uses a single search_records table instead
    return if connection.adapter_name == "SQLite"
    # Create 16 sharded search_records tables
    SHARD_COUNT.times do |shard_id|
      create_table "search_records_#{shard_id}", id: :uuid do |t|
        t.uuid :account_id, null: false
        t.string :searchable_type, null: false
        t.uuid :searchable_id, null: false
        t.uuid :card_id, null: false
        t.uuid :board_id, null: false
        t.string :title
        t.text :content
        t.datetime :created_at, null: false
        t.index [:searchable_type, :searchable_id], unique: true
        t.index :account_id
        t.index [:content, :title], type: :fulltext
      end
    end
    # Drop old search_index tables
    SHARD_COUNT.times do |shard_id|
      drop_table "search_index_#{shard_id}", if_exists: true do |t|
        t.string :searchable_type, null: false
        t.uuid :searchable_id, null: false
        t.uuid :card_id, null: false
        t.uuid :board_id, null: false
        t.string :title
        t.text :content
        t.datetime :created_at, null: false
        t.index [:searchable_type, :searchable_id], unique: true, name: "idx_si#{shard_id}_type_id"
        t.index [:content, :title], type: :fulltext, name: "idx_si#{shard_id}_fulltext"
      end
    end
  end
end

================
File: db/migrate/20251114084325_drop_search_results.rb
================
class DropSearchResults < ActiveRecord::Migration[8.2]
  def change
    drop_table :search_results do |t|
      t.timestamps
    end
  end
end

================
File: db/migrate/20251114183203_ensure_an_identit_can_only_have_one_user_in_an_account.rb
================
class EnsureAnIdentitCanOnlyHaveOneUserInAnAccount < ActiveRecord::Migration[8.2]
  def change
    add_index :users, [:account_id, :identity_id], unique: true
  end
end

================
File: db/migrate/20251117190817_change_endpoint_to_text_in_push_subscriptions.rb
================
class ChangeEndpointToTextInPushSubscriptions < ActiveRecord::Migration[8.2]
  def change
    # Remove foreign key first, then the index
    remove_foreign_key :push_subscriptions, :users
    remove_index :push_subscriptions, column: [:user_id, :endpoint]
    # Change the column type
    change_column :push_subscriptions, :endpoint, :text
    # Re-add the index and foreign key
    add_index :push_subscriptions, [:user_id, :endpoint], unique: true, length: { endpoint: 255 }
    add_foreign_key :push_subscriptions, :users
  end
end

================
File: db/migrate/20251117192434_change_external_account_id_to_bigint_in_accounts.rb
================
class ChangeExternalAccountIdToBigintInAccounts < ActiveRecord::Migration[8.2]
  def change
    change_column :accounts, :external_account_id, :bigint
  end
end

================
File: db/migrate/20251117202517_change_usage_limit_to_bigint_in_account_join_codes.rb
================
class ChangeUsageLimitToBigintInAccountJoinCodes < ActiveRecord::Migration[8.2]
  def change
    change_column :account_join_codes, :usage_count, :bigint
    change_column :account_join_codes, :usage_limit, :bigint
  end
end

================
File: db/migrate/20251120110206_add_search_records.rb
================
class AddSearchRecords < ActiveRecord::Migration[8.2]
  def up
    return unless connection.adapter_name == "SQLite"
    # Create regular table with integer primary key for FTS5 rowid compatibility
    create_table :search_records do |t|
      t.uuid :account_id, null: false
      t.string :searchable_type, limit: 255, null: false
      t.uuid :searchable_id, null: false
      t.uuid :card_id, null: false
      t.uuid :board_id, null: false
      t.string :title, limit: 255
      t.text :content
      t.datetime :created_at, null: false
      t.index [:searchable_type, :searchable_id], unique: true
      t.index :account_id
    end
    # Create FTS5 virtual table using Porter stemmer
    # No triggers needed - Searchable concern handles sync via callbacks
    execute <<-SQL
      CREATE VIRTUAL TABLE search_records_fts USING fts5(
        title,
        content,
        tokenize='porter'
      )
    SQL
  end
  def down
    return unless connection.adapter_name == "SQLite"
    execute "DROP TABLE IF EXISTS search_records_fts"
    drop_table :search_records, if_exists: true
  end
end

================
File: db/migrate/20251120194700_remove_all_foreign_key_constraints.rb
================
class RemoveAllForeignKeyConstraints < ActiveRecord::Migration[8.2]
  def change
    remove_foreign_key "active_storage_attachments", "active_storage_blobs", column: "blob_id" rescue nil
    remove_foreign_key "active_storage_variant_records", "active_storage_blobs", column: "blob_id" rescue nil
    remove_foreign_key "board_publications", "boards" rescue nil
    remove_foreign_key "card_activity_spikes", "cards" rescue nil
    remove_foreign_key "card_goldnesses", "cards" rescue nil
    remove_foreign_key "card_not_nows", "cards" rescue nil
    remove_foreign_key "card_not_nows", "users" rescue nil
    remove_foreign_key "cards", "columns" rescue nil
    remove_foreign_key "closures", "cards" rescue nil
    remove_foreign_key "closures", "users" rescue nil
    remove_foreign_key "columns", "boards" rescue nil
    remove_foreign_key "comments", "cards" rescue nil
    remove_foreign_key "events", "boards" rescue nil
    remove_foreign_key "magic_links", "identities" rescue nil
    remove_foreign_key "mentions", "users", column: "mentionee_id" rescue nil
    remove_foreign_key "mentions", "users", column: "mentioner_id" rescue nil
    remove_foreign_key "notification_bundles", "users" rescue nil
    remove_foreign_key "notifications", "users" rescue nil
    remove_foreign_key "notifications", "users", column: "creator_id" rescue nil
    remove_foreign_key "pins", "cards" rescue nil
    remove_foreign_key "pins", "users" rescue nil
    remove_foreign_key "push_subscriptions", "users" rescue nil
    remove_foreign_key "search_queries", "users" rescue nil
    remove_foreign_key "sessions", "identities" rescue nil
    remove_foreign_key "steps", "cards" rescue nil
    remove_foreign_key "taggings", "cards" rescue nil
    remove_foreign_key "taggings", "tags" rescue nil
    remove_foreign_key "user_settings", "users" rescue nil
    remove_foreign_key "users", "identities" rescue nil
    remove_foreign_key "watches", "cards" rescue nil
    remove_foreign_key "watches", "users" rescue nil
    remove_foreign_key "webhook_delinquency_trackers", "webhooks" rescue nil
    remove_foreign_key "webhook_deliveries", "events" rescue nil
    remove_foreign_key "webhook_deliveries", "webhooks" rescue nil
    remove_foreign_key "webhooks", "boards" rescue nil
  end
end

================
File: db/migrate/20251120203100_add_unique_index_to_card_activity_spikes_on_card_id.rb
================
class AddUniqueIndexToCardActivitySpikesOnCardId < ActiveRecord::Migration[8.2]
  def change
    if ActiveRecord::Base.connection.adapter_name != "SQLite"
      reversible do |dir|
        dir.up do
          execute <<-SQL
            DELETE s1 FROM card_activity_spikes s1
            INNER JOIN card_activity_spikes s2
            WHERE s1.card_id = s2.card_id
            AND s1.updated_at < s2.updated_at
          SQL
        end
      end
    end
    remove_index :card_activity_spikes, :card_id
    add_index :card_activity_spikes, :card_id, unique: true
  end
end

================
File: db/migrate/20251121092508_add_account_key_to_search_records.rb
================
class AddAccountKeyToSearchRecords < ActiveRecord::Migration[8.2]
  def up
    return if ActiveRecord::Base.connection.adapter_name == "SQLite"
    16.times do |shard_id|
      table_name = "search_records_#{shard_id}"
      add_column table_name, :account_key, :string, null: false, default: ""
      add_index table_name, [:account_key, :content, :title], type: :fulltext
    end
  end
  def down
    return if ActiveRecord::Base.connection.adapter_name == "SQLite"
    16.times do |shard_id|
      table_name = "search_records_#{shard_id}"
      remove_index table_name, column: [:account_key, :content, :title], type: :fulltext
      remove_column table_name, :account_key
    end
  end
end

================
File: db/migrate/20251121112416_remove_old_fulltext_indexes_from_search_records.rb
================
class RemoveOldFulltextIndexesFromSearchRecords < ActiveRecord::Migration[8.2]
  def up
    return if ActiveRecord::Base.connection.adapter_name == "SQLite"
    (0..15).each do |shard|
      remove_index "search_records_#{shard}", name: "index_search_records_#{shard}_on_content_and_title"
    end
  end
  def down
    return if ActiveRecord::Base.connection.adapter_name == "SQLite"
    (0..15).each do |shard|
      add_index "search_records_#{shard}", [ :content, :title ], type: :fulltext, name: "index_search_records_#{shard}_on_content_and_title"
    end
  end
end

================
File: db/migrate/20251125110629_increase_user_agent_length.rb
================
class IncreaseUserAgentLength < ActiveRecord::Migration[8.2]
  def change
    change_column :sessions, :user_agent, :string, limit: 4096
    change_column :push_subscriptions, :user_agent, :string, limit: 4096
  end
end

================
File: db/migrate/20251125130010_add_a_staff_flag_to_identities.rb
================
class AddAStaffFlagToIdentities < ActiveRecord::Migration[8.2]
  def change
    add_column :identities, :staff, :boolean, null: false, default: false
  end
end

================
File: db/migrate/20251127000001_create_account_external_id_sequences.rb
================
class CreateAccountExternalIdSequences < ActiveRecord::Migration[8.0]
  def change
    create_table :account_external_id_sequences, id: :uuid do |t|
      t.bigint :value, null: false, default: 0
      t.index :value, unique: true
    end
  end
end

================
File: db/migrate/20251129110120_add_purpose_to_magic_links.rb
================
class AddPurposeToMagicLinks < ActiveRecord::Migration[8.2]
  def change
    add_column :magic_links, :purpose, :integer, null: true
    execute <<-SQL
      UPDATE magic_links SET purpose = 0
    SQL
    change_column_null :magic_links, :purpose, false
  end
end

================
File: db/migrate/20251129175717_promote_first_admin_to_owner.rb
================
class PromoteFirstAdminToOwner < ActiveRecord::Migration[8.2]
  def up
    Account.find_each do |account|
      next if account.users.exists?(role: :owner)
      first_admin = account.users.where(role: :admin).order(:created_at).first
      first_admin&.update!(role: :owner)
    end
  end
  def down
    User.where(role: :owner).update_all(role: :admin)
  end
end

================
File: db/migrate/20251201100607_create_account_exports.rb
================
class CreateAccountExports < ActiveRecord::Migration[8.2]
  def change
    create_table :account_exports, id: :uuid do |t|
      t.uuid :account_id, null: false
      t.uuid :user_id, null: false
      t.string :status, default: "pending", null: false
      t.datetime :completed_at
      t.timestamps
      t.index :account_id
      t.index :user_id
    end
  end
end

================
File: db/migrate/20251201132341_create_identity_access_tokens.rb
================
class CreateIdentityAccessTokens < ActiveRecord::Migration[8.2]
  def change
    create_table :identity_access_tokens, id: :uuid do |t|
      t.uuid :identity_id, null: false
      t.string :token
      t.string :permission
      t.text :description
      t.timestamps
      t.index ["identity_id"], name: "index_access_token_on_identity_id"
    end
  end
end

================
File: db/migrate/20251205010536_add_verified_at_to_users.rb
================
class AddVerifiedAtToUsers < ActiveRecord::Migration[8.2]
  def change
    add_column :users, :verified_at, :datetime
  end
end

================
File: db/migrate/20251205205826_create_storage_tables.rb
================
class CreateStorageTables < ActiveRecord::Migration[8.0]
  def change
    # Storage ledger: debit/credit event stream
    create_table :storage_entries, id: :uuid do |t|
      t.references :account, type: :uuid, null: false
      t.references :board, type: :uuid, null: true
      t.references :recordable, type: :uuid, polymorphic: true, null: true
      t.bigint :delta, null: false
      t.string :operation, null: false
      t.datetime :created_at, null: false
    end
    # Storage totals: cached snapshots
    create_table :storage_totals, id: :uuid do |t|
      t.references :owner, type: :uuid, polymorphic: true, null: false, index: false
      t.bigint :bytes_stored, null: false, default: 0
      t.uuid :last_entry_id  # Cursor: includes all entries <= this ID
      t.timestamps
      t.index %i[ owner_type owner_id ], unique: true
    end
  end
end

================
File: db/migrate/20251210054934_add_blob_id_and_audit_context_to_storage_entries.rb
================
class AddBlobIdAndAuditContextToStorageEntries < ActiveRecord::Migration[8.2]
  def change
    change_table :storage_entries do |t|
      t.references :blob, type: :uuid, foreign_key: false, index: true
      t.references :user, type: :uuid, foreign_key: false, index: true
      t.string :request_id, index: true
    end
  end
end

================
File: db/migrate/20251219120755_drop_card_engagements.rb
================
class DropCardEngagements < ActiveRecord::Migration[8.2]
  def up
    drop_table :card_engagements
  end
  def down
    create_table :card_engagements, id: :uuid do |t|
      t.references :account, type: :uuid, null: false
      t.references :card, type: :uuid, null: false, index: true
      t.string :status, null: false
      t.timestamps
    end
    add_index :card_engagements, [ :account_id, :status ]
  end
end

================
File: db/migrate/20251223000001_rename_account_exports_to_exports.rb
================
class RenameAccountExportsToExports < ActiveRecord::Migration[8.2]
  def change
    rename_table :account_exports, :exports
    add_column :exports, :type, :string
    add_index :exports, :type
  end
end

================
File: db/migrate/20251223000002_create_account_imports.rb
================
class CreateAccountImports < ActiveRecord::Migration[8.2]
  def change
    create_table :account_imports, id: :uuid do |t|
      t.uuid :identity_id, null: false
      t.uuid :account_id
      t.string :status, default: "pending", null: false
      t.datetime :completed_at
      t.timestamps
      t.index :identity_id
      t.index :account_id
    end
  end
end

================
File: db/migrate/20251224092315_create_account_cancellations.rb
================
class CreateAccountCancellations < ActiveRecord::Migration[8.2]
  def change
    create_table :account_cancellations, id: :uuid do |t|
      t.uuid :account_id, null: false, index: { unique: true }
      t.uuid :initiated_by_id, null: false
      t.timestamps
    end
  end
end

================
File: db/migrate/20260121155752_make_reactions_polymorphic.rb
================
class MakeReactionsPolymorphic < ActiveRecord::Migration[8.0]
  def change
    add_column :reactions, :reactable_type, :string
    add_column :reactions, :reactable_id, :uuid
    reversible do |dir|
      dir.up do
        execute <<~SQL
          UPDATE reactions SET reactable_type = 'Comment', reactable_id = comment_id
        SQL
      end
      dir.down do
        execute <<~SQL
          UPDATE reactions SET comment_id = reactable_id WHERE reactable_type = 'Comment'
        SQL
      end
    end
    change_column_null :reactions, :reactable_type, false
    change_column_null :reactions, :reactable_id, false
    remove_column :reactions, :comment_id, :uuid
    add_index :reactions, [:reactable_type, :reactable_id]
  end
end

================
File: db/seeds/37signals.rb
================
create_tenant "37signals"
david = find_or_create_user "David Heinemeier Hansson", "david@example.com"
jason = find_or_create_user "Jason Fried", "jason@example.com"
jz    = find_or_create_user "Jason Zimdars", "jz@example.com"
kevin = find_or_create_user "Kevin Mcconnell", "kevin@example.com"
login_as david
create_board("Fizzy", access_to: [ jason, jz, kevin ]).tap do |fizzy|
  create_card("Prepare sign-up page", description: "We need to do this before the launch.", board: fizzy)
  create_card("Prepare sign-up page", description: "We need to do this before the launch.", board: fizzy).tap do |card|
    card.toggle_assignment(kevin)
    if column = card.board&.columns&.sample
      card.triage_into(column)
    end
  end
  create_card("Plain text mentions", description: "We'll support plain text mentions first.", board: fizzy).tap do |card|
    card.toggle_assignment(david)
    card.close
  end
end

================
File: db/seeds/cleanslate.rb
================
create_tenant "cleanslate"

================
File: db/seeds/honcho.rb
================
create_tenant "Honcho"
david = find_or_create_user "David Heinemeier Hansson", "david@example.com"
jason = find_or_create_user "Jason Fried", "jason@example.com"
jz    = find_or_create_user "Jason Zimdars", "jz@example.com"
kevin = find_or_create_user "Kevin McConnell", "kevin@example.com"
jorge = find_or_create_user "Jorge Manrubia", "jorge@example.com"
mike  = find_or_create_user "Mike Dalessio", "mike@example.com"
login_as david
authors = [ david, jason, jz, kevin, jorge, mike ]
card_titles = [
  "Implement authentication",
  "Design landing page",
  "Set up database",
  "Create API endpoints",
  "Write unit tests",
  "Optimize performance",
  "Add user profiles",
  "Implement search",
  "Create admin panel",
  "Set up CI/CD"
]
boards = [
  "Project Launch",
  "Frontend Dev",
  "Backend Dev",
  "Design System",
  "Testing Suite"
]
time_range = (60 .. 30.days.in_minutes)
boards.each_with_index do |board_name, index|
  create_board(board_name, access_to: authors.sample(3)).tap do |board|
    card_titles.each do |title|
      travel(-rand(time_range).minutes) do
        card = create_card title,
                           description: "#{title} for #{board_name} phase #{index + 1}.",
                           board: board,
                           creator: authors.sample
        # Randomly assign to 1-2 authors
        travel rand(0..20).minutes
        card.toggle_assignment(authors.sample)
        if rand > 0.5
          travel rand(0..20).minutes
          card.toggle_assignment(authors.sample)
        end
        # Randomly set card state
        travel rand(0..20).minutes
        case rand(3)
        when 0
          if column = card.board&.columns&.sample
            card.triage_into(column)
          end
        when 1
          card.close
          # 2 remains open
        end
      end
    end
  end
end

================
File: db/cable_schema.rb
================
# This file is auto-generated from the current state of the database. Instead
# of editing this file, please use the migrations feature of Active Record to
# incrementally modify your database, and then regenerate this schema definition.
#
# This file is the source Rails uses to define your schema when running `bin/rails
# db:schema:load`. When creating a new database, `bin/rails db:schema:load` tends to
# be faster and is potentially less error prone than running all of your
# migrations from scratch. Old migrations may fail to apply correctly if those
# migrations use external dependencies or application code.
#
# It's strongly recommended that you check this file into your version control system.
ActiveRecord::Schema[8.2].define(version: 1) do
  create_table "solid_cable_messages", charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.binary "channel", limit: 1024, null: false
    t.bigint "channel_hash", null: false
    t.datetime "created_at", null: false
    t.binary "payload", size: :long, null: false
    t.index ["channel"], name: "index_solid_cable_messages_on_channel"
    t.index ["channel_hash"], name: "index_solid_cable_messages_on_channel_hash"
    t.index ["created_at"], name: "index_solid_cable_messages_on_created_at"
  end
end

================
File: db/cache_schema.rb
================
# This file is auto-generated from the current state of the database. Instead
# of editing this file, please use the migrations feature of Active Record to
# incrementally modify your database, and then regenerate this schema definition.
#
# This file is the source Rails uses to define your schema when running `bin/rails
# db:schema:load`. When creating a new database, `bin/rails db:schema:load` tends to
# be faster and is potentially less error prone than running all of your
# migrations from scratch. Old migrations may fail to apply correctly if those
# migrations use external dependencies or application code.
#
# It's strongly recommended that you check this file into your version control system.
ActiveRecord::Schema[8.2].define(version: 1) do
  create_table "solid_cache_entries", charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.integer "byte_size", null: false
    t.datetime "created_at", null: false
    t.binary "key", limit: 1024, null: false
    t.bigint "key_hash", null: false
    t.binary "value", size: :long, null: false
    t.index ["byte_size"], name: "index_solid_cache_entries_on_byte_size"
    t.index ["key_hash", "byte_size"], name: "index_solid_cache_entries_on_key_hash_and_byte_size"
    t.index ["key_hash"], name: "index_solid_cache_entries_on_key_hash", unique: true
  end
end

================
File: db/queue_schema.rb
================
# This file is auto-generated from the current state of the database. Instead
# of editing this file, please use the migrations feature of Active Record to
# incrementally modify your database, and then regenerate this schema definition.
#
# This file is the source Rails uses to define your schema when running `bin/rails
# db:schema:load`. When creating a new database, `bin/rails db:schema:load` tends to
# be faster and is potentially less error prone than running all of your
# migrations from scratch. Old migrations may fail to apply correctly if those
# migrations use external dependencies or application code.
#
# It's strongly recommended that you check this file into your version control system.
ActiveRecord::Schema[8.2].define(version: 1) do
  create_table "solid_queue_blocked_executions", charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.string "concurrency_key", null: false
    t.datetime "created_at", null: false
    t.datetime "expires_at", null: false
    t.bigint "job_id", null: false
    t.integer "priority", default: 0, null: false
    t.string "queue_name", null: false
    t.index ["concurrency_key", "priority", "job_id"], name: "index_solid_queue_blocked_executions_for_release"
    t.index ["expires_at", "concurrency_key"], name: "index_solid_queue_blocked_executions_for_maintenance"
    t.index ["job_id"], name: "index_solid_queue_blocked_executions_on_job_id", unique: true
  end
  create_table "solid_queue_claimed_executions", charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.datetime "created_at", null: false
    t.bigint "job_id", null: false
    t.bigint "process_id"
    t.index ["job_id"], name: "index_solid_queue_claimed_executions_on_job_id", unique: true
    t.index ["process_id", "job_id"], name: "index_solid_queue_claimed_executions_on_process_id_and_job_id"
  end
  create_table "solid_queue_failed_executions", charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.datetime "created_at", null: false
    t.text "error"
    t.bigint "job_id", null: false
    t.index ["job_id"], name: "index_solid_queue_failed_executions_on_job_id", unique: true
  end
  create_table "solid_queue_jobs", charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.string "active_job_id"
    t.text "arguments"
    t.string "class_name", null: false
    t.string "concurrency_key"
    t.datetime "created_at", null: false
    t.datetime "finished_at"
    t.integer "priority", default: 0, null: false
    t.string "queue_name", null: false
    t.datetime "scheduled_at"
    t.datetime "updated_at", null: false
    t.index ["active_job_id"], name: "index_solid_queue_jobs_on_active_job_id"
    t.index ["class_name"], name: "index_solid_queue_jobs_on_class_name"
    t.index ["finished_at"], name: "index_solid_queue_jobs_on_finished_at"
    t.index ["queue_name", "finished_at"], name: "index_solid_queue_jobs_for_filtering"
    t.index ["scheduled_at", "finished_at"], name: "index_solid_queue_jobs_for_alerting"
  end
  create_table "solid_queue_pauses", charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.datetime "created_at", null: false
    t.string "queue_name", null: false
    t.index ["queue_name"], name: "index_solid_queue_pauses_on_queue_name", unique: true
  end
  create_table "solid_queue_processes", charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.datetime "created_at", null: false
    t.string "hostname"
    t.string "kind", null: false
    t.datetime "last_heartbeat_at", null: false
    t.text "metadata"
    t.string "name", null: false
    t.integer "pid", null: false
    t.bigint "supervisor_id"
    t.index ["last_heartbeat_at"], name: "index_solid_queue_processes_on_last_heartbeat_at"
    t.index ["name", "supervisor_id"], name: "index_solid_queue_processes_on_name_and_supervisor_id", unique: true
    t.index ["supervisor_id"], name: "index_solid_queue_processes_on_supervisor_id"
  end
  create_table "solid_queue_ready_executions", charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.datetime "created_at", null: false
    t.bigint "job_id", null: false
    t.integer "priority", default: 0, null: false
    t.string "queue_name", null: false
    t.index ["job_id"], name: "index_solid_queue_ready_executions_on_job_id", unique: true
    t.index ["priority", "job_id"], name: "index_solid_queue_poll_all"
    t.index ["queue_name", "priority", "job_id"], name: "index_solid_queue_poll_by_queue"
  end
  create_table "solid_queue_recurring_executions", charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.datetime "created_at", null: false
    t.bigint "job_id", null: false
    t.datetime "run_at", null: false
    t.string "task_key", null: false
    t.index ["job_id"], name: "index_solid_queue_recurring_executions_on_job_id", unique: true
    t.index ["task_key", "run_at"], name: "index_solid_queue_recurring_executions_on_task_key_and_run_at", unique: true
  end
  create_table "solid_queue_recurring_tasks", charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.text "arguments"
    t.string "class_name"
    t.string "command", limit: 2048
    t.datetime "created_at", null: false
    t.text "description"
    t.string "key", null: false
    t.integer "priority", default: 0
    t.string "queue_name"
    t.string "schedule", null: false
    t.boolean "static", default: true, null: false
    t.datetime "updated_at", null: false
    t.index ["key"], name: "index_solid_queue_recurring_tasks_on_key", unique: true
    t.index ["static"], name: "index_solid_queue_recurring_tasks_on_static"
  end
  create_table "solid_queue_scheduled_executions", charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.datetime "created_at", null: false
    t.bigint "job_id", null: false
    t.integer "priority", default: 0, null: false
    t.string "queue_name", null: false
    t.datetime "scheduled_at", null: false
    t.index ["job_id"], name: "index_solid_queue_scheduled_executions_on_job_id", unique: true
    t.index ["scheduled_at", "priority", "job_id"], name: "index_solid_queue_dispatch_all"
  end
  create_table "solid_queue_semaphores", charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.datetime "created_at", null: false
    t.datetime "expires_at", null: false
    t.string "key", null: false
    t.datetime "updated_at", null: false
    t.integer "value", default: 1, null: false
    t.index ["expires_at"], name: "index_solid_queue_semaphores_on_expires_at"
    t.index ["key", "value"], name: "index_solid_queue_semaphores_on_key_and_value"
    t.index ["key"], name: "index_solid_queue_semaphores_on_key", unique: true
  end
  add_foreign_key "solid_queue_blocked_executions", "solid_queue_jobs", column: "job_id", on_delete: :cascade
  add_foreign_key "solid_queue_claimed_executions", "solid_queue_jobs", column: "job_id", on_delete: :cascade
  add_foreign_key "solid_queue_failed_executions", "solid_queue_jobs", column: "job_id", on_delete: :cascade
  add_foreign_key "solid_queue_ready_executions", "solid_queue_jobs", column: "job_id", on_delete: :cascade
  add_foreign_key "solid_queue_recurring_executions", "solid_queue_jobs", column: "job_id", on_delete: :cascade
  add_foreign_key "solid_queue_scheduled_executions", "solid_queue_jobs", column: "job_id", on_delete: :cascade
end

================
File: db/schema_sqlite.rb
================
# This file is auto-generated from the current state of the database. Instead
# of editing this file, please use the migrations feature of Active Record to
# incrementally modify your database, and then regenerate this schema definition.
#
# This file is the source Rails uses to define your schema when running `bin/rails
# db:schema:load`. When creating a new database, `bin/rails db:schema:load` tends to
# be faster and is potentially less error prone than running all of your
# migrations from scratch. Old migrations may fail to apply correctly if those
# migrations use external dependencies or application code.
#
# It's strongly recommended that you check this file into your version control system.
ActiveRecord::Schema[8.2].define(version: 2026_01_21_155752) do
  create_table "accesses", id: :uuid, force: :cascade do |t|
    t.datetime "accessed_at"
    t.uuid "account_id", null: false
    t.uuid "board_id", null: false
    t.datetime "created_at", null: false
    t.string "involvement", limit: 255, default: "access_only", null: false
    t.datetime "updated_at", null: false
    t.uuid "user_id", null: false
    t.index ["account_id", "accessed_at"], name: "index_accesses_on_account_id_and_accessed_at"
    t.index ["board_id", "user_id"], name: "index_accesses_on_board_id_and_user_id", unique: true
    t.index ["board_id"], name: "index_accesses_on_board_id"
    t.index ["user_id"], name: "index_accesses_on_user_id"
  end
  create_table "account_cancellations", id: :uuid, force: :cascade do |t|
    t.uuid "account_id", null: false
    t.datetime "created_at", null: false
    t.uuid "initiated_by_id", null: false
    t.datetime "updated_at", null: false
    t.index ["account_id"], name: "index_account_cancellations_on_account_id", unique: true
  end
  create_table "account_external_id_sequences", id: :uuid, force: :cascade do |t|
    t.bigint "value", default: 0, null: false
    t.index ["value"], name: "index_account_external_id_sequences_on_value", unique: true
  end
  create_table "account_imports", id: :uuid, force: :cascade do |t|
    t.uuid "account_id"
    t.datetime "completed_at"
    t.datetime "created_at", null: false
    t.uuid "identity_id", null: false
    t.string "status", limit: 255, default: "pending", null: false
    t.datetime "updated_at", null: false
    t.index ["account_id"], name: "index_account_imports_on_account_id"
    t.index ["identity_id"], name: "index_account_imports_on_identity_id"
  end
  create_table "account_join_codes", id: :uuid, force: :cascade do |t|
    t.uuid "account_id", null: false
    t.string "code", limit: 255, null: false
    t.datetime "created_at", null: false
    t.datetime "updated_at", null: false
    t.bigint "usage_count", default: 0, null: false
    t.bigint "usage_limit", default: 10, null: false
    t.index ["account_id", "code"], name: "index_account_join_codes_on_account_id_and_code", unique: true
  end
  create_table "accounts", id: :uuid, force: :cascade do |t|
    t.bigint "cards_count", default: 0, null: false
    t.datetime "created_at", null: false
    t.bigint "external_account_id"
    t.string "name", limit: 255, null: false
    t.datetime "updated_at", null: false
    t.index ["external_account_id"], name: "index_accounts_on_external_account_id", unique: true
  end
  create_table "action_text_rich_texts", id: :uuid, force: :cascade do |t|
    t.uuid "account_id", null: false
    t.text "body", limit: 4294967295
    t.datetime "created_at", null: false
    t.string "name", limit: 255, null: false
    t.uuid "record_id", null: false
    t.string "record_type", limit: 255, null: false
    t.datetime "updated_at", null: false
    t.index ["account_id"], name: "index_action_text_rich_texts_on_account_id"
    t.index ["record_type", "record_id", "name"], name: "index_action_text_rich_texts_uniqueness", unique: true
  end
  create_table "active_storage_attachments", id: :uuid, force: :cascade do |t|
    t.uuid "account_id", null: false
    t.uuid "blob_id", null: false
    t.datetime "created_at", null: false
    t.string "name", limit: 255, null: false
    t.uuid "record_id", null: false
    t.string "record_type", limit: 255, null: false
    t.index ["account_id"], name: "index_active_storage_attachments_on_account_id"
    t.index ["blob_id"], name: "index_active_storage_attachments_on_blob_id"
    t.index ["record_type", "record_id", "name", "blob_id"], name: "index_active_storage_attachments_uniqueness", unique: true
  end
  create_table "active_storage_blobs", id: :uuid, force: :cascade do |t|
    t.uuid "account_id", null: false
    t.bigint "byte_size", null: false
    t.string "checksum", limit: 255
    t.string "content_type", limit: 255
    t.datetime "created_at", null: false
    t.string "filename", limit: 255, null: false
    t.string "key", limit: 255, null: false
    t.text "metadata", limit: 65535
    t.string "service_name", limit: 255, null: false
    t.index ["account_id"], name: "index_active_storage_blobs_on_account_id"
    t.index ["key"], name: "index_active_storage_blobs_on_key", unique: true
  end
  create_table "active_storage_variant_records", id: :uuid, force: :cascade do |t|
    t.uuid "account_id", null: false
    t.uuid "blob_id", null: false
    t.string "variation_digest", limit: 255, null: false
    t.index ["account_id"], name: "index_active_storage_variant_records_on_account_id"
    t.index ["blob_id", "variation_digest"], name: "index_active_storage_variant_records_uniqueness", unique: true
  end
  create_table "assignees_filters", id: false, force: :cascade do |t|
    t.uuid "assignee_id", null: false
    t.uuid "filter_id", null: false
    t.index ["assignee_id"], name: "index_assignees_filters_on_assignee_id"
    t.index ["filter_id"], name: "index_assignees_filters_on_filter_id"
  end
  create_table "assigners_filters", id: false, force: :cascade do |t|
    t.uuid "assigner_id", null: false
    t.uuid "filter_id", null: false
    t.index ["assigner_id"], name: "index_assigners_filters_on_assigner_id"
    t.index ["filter_id"], name: "index_assigners_filters_on_filter_id"
  end
  create_table "assignments", id: :uuid, force: :cascade do |t|
    t.uuid "account_id", null: false
    t.uuid "assignee_id", null: false
    t.uuid "assigner_id", null: false
    t.uuid "card_id", null: false
    t.datetime "created_at", null: false
    t.datetime "updated_at", null: false
    t.index ["account_id"], name: "index_assignments_on_account_id"
    t.index ["assignee_id", "card_id"], name: "index_assignments_on_assignee_id_and_card_id", unique: true
    t.index ["card_id"], name: "index_assignments_on_card_id"
  end
  create_table "board_publications", id: :uuid, force: :cascade do |t|
    t.uuid "account_id", null: false
    t.uuid "board_id", null: false
    t.datetime "created_at", null: false
    t.string "key", limit: 255
    t.datetime "updated_at", null: false
    t.index ["account_id", "key"], name: "index_board_publications_on_account_id_and_key"
    t.index ["board_id"], name: "index_board_publications_on_board_id"
  end
  create_table "boards", id: :uuid, force: :cascade do |t|
    t.uuid "account_id", null: false
    t.boolean "all_access", default: false, null: false
    t.datetime "created_at", null: false
    t.uuid "creator_id", null: false
    t.string "name", limit: 255, null: false
    t.datetime "updated_at", null: false
    t.index ["account_id"], name: "index_boards_on_account_id"
    t.index ["creator_id"], name: "index_boards_on_creator_id"
  end
  create_table "boards_filters", id: false, force: :cascade do |t|
    t.uuid "board_id", null: false
    t.uuid "filter_id", null: false
    t.index ["board_id"], name: "index_boards_filters_on_board_id"
    t.index ["filter_id"], name: "index_boards_filters_on_filter_id"
  end
  create_table "card_activity_spikes", id: :uuid, force: :cascade do |t|
    t.uuid "account_id", null: false
    t.uuid "card_id", null: false
    t.datetime "created_at", null: false
    t.datetime "updated_at", null: false
    t.index ["account_id"], name: "index_card_activity_spikes_on_account_id"
    t.index ["card_id"], name: "index_card_activity_spikes_on_card_id", unique: true
  end
  create_table "card_goldnesses", id: :uuid, force: :cascade do |t|
    t.uuid "account_id", null: false
    t.uuid "card_id", null: false
    t.datetime "created_at", null: false
    t.datetime "updated_at", null: false
    t.index ["account_id"], name: "index_card_goldnesses_on_account_id"
    t.index ["card_id"], name: "index_card_goldnesses_on_card_id", unique: true
  end
  create_table "card_not_nows", id: :uuid, force: :cascade do |t|
    t.uuid "account_id", null: false
    t.uuid "card_id", null: false
    t.datetime "created_at", null: false
    t.datetime "updated_at", null: false
    t.uuid "user_id"
    t.index ["account_id"], name: "index_card_not_nows_on_account_id"
    t.index ["card_id"], name: "index_card_not_nows_on_card_id", unique: true
    t.index ["user_id"], name: "index_card_not_nows_on_user_id"
  end
  create_table "cards", id: :uuid, force: :cascade do |t|
    t.uuid "account_id", null: false
    t.uuid "board_id", null: false
    t.uuid "column_id"
    t.datetime "created_at", null: false
    t.uuid "creator_id", null: false
    t.date "due_on"
    t.datetime "last_active_at", null: false
    t.bigint "number", null: false
    t.string "status", limit: 255, default: "drafted", null: false
    t.string "title", limit: 255
    t.datetime "updated_at", null: false
    t.index ["account_id", "last_active_at", "status"], name: "index_cards_on_account_id_and_last_active_at_and_status"
    t.index ["account_id", "number"], name: "index_cards_on_account_id_and_number", unique: true
    t.index ["board_id"], name: "index_cards_on_board_id"
    t.index ["column_id"], name: "index_cards_on_column_id"
  end
  create_table "closers_filters", id: false, force: :cascade do |t|
    t.uuid "closer_id", null: false
    t.uuid "filter_id", null: false
    t.index ["closer_id"], name: "index_closers_filters_on_closer_id"
    t.index ["filter_id"], name: "index_closers_filters_on_filter_id"
  end
  create_table "closures", id: :uuid, force: :cascade do |t|
    t.uuid "account_id", null: false
    t.uuid "card_id", null: false
    t.datetime "created_at", null: false
    t.datetime "updated_at", null: false
    t.uuid "user_id"
    t.index ["account_id"], name: "index_closures_on_account_id"
    t.index ["card_id", "created_at"], name: "index_closures_on_card_id_and_created_at"
    t.index ["card_id"], name: "index_closures_on_card_id", unique: true
    t.index ["user_id"], name: "index_closures_on_user_id"
  end
  create_table "columns", id: :uuid, force: :cascade do |t|
    t.uuid "account_id", null: false
    t.uuid "board_id", null: false
    t.string "color", limit: 255, null: false
    t.datetime "created_at", null: false
    t.string "name", limit: 255, null: false
    t.integer "position", default: 0, null: false
    t.datetime "updated_at", null: false
    t.index ["account_id"], name: "index_columns_on_account_id"
    t.index ["board_id", "position"], name: "index_columns_on_board_id_and_position"
    t.index ["board_id"], name: "index_columns_on_board_id"
  end
  create_table "comments", id: :uuid, force: :cascade do |t|
    t.uuid "account_id", null: false
    t.uuid "card_id", null: false
    t.datetime "created_at", null: false
    t.uuid "creator_id", null: false
    t.datetime "updated_at", null: false
    t.index ["account_id"], name: "index_comments_on_account_id"
    t.index ["card_id"], name: "index_comments_on_card_id"
  end
  create_table "creators_filters", id: false, force: :cascade do |t|
    t.uuid "creator_id", null: false
    t.uuid "filter_id", null: false
    t.index ["creator_id"], name: "index_creators_filters_on_creator_id"
    t.index ["filter_id"], name: "index_creators_filters_on_filter_id"
  end
  create_table "entropies", id: :uuid, force: :cascade do |t|
    t.uuid "account_id", null: false
    t.bigint "auto_postpone_period", default: 2592000, null: false
    t.uuid "container_id", null: false
    t.string "container_type", limit: 255, null: false
    t.datetime "created_at", null: false
    t.datetime "updated_at", null: false
    t.index ["account_id"], name: "index_entropies_on_account_id"
    t.index ["container_type", "container_id", "auto_postpone_period"], name: "idx_on_container_type_container_id_auto_postpone_pe_3d79b50517"
    t.index ["container_type", "container_id"], name: "index_entropy_configurations_on_container", unique: true
  end
  create_table "events", id: :uuid, force: :cascade do |t|
    t.uuid "account_id", null: false
    t.string "action", limit: 255, null: false
    t.uuid "board_id", null: false
    t.datetime "created_at", null: false
    t.uuid "creator_id", null: false
    t.uuid "eventable_id", null: false
    t.string "eventable_type", limit: 255, null: false
    t.json "particulars", default: -> { "json_object()" }
    t.datetime "updated_at", null: false
    t.index ["account_id", "action"], name: "index_events_on_account_id_and_action"
    t.index ["board_id", "action", "created_at"], name: "index_events_on_board_id_and_action_and_created_at"
    t.index ["board_id"], name: "index_events_on_board_id"
    t.index ["creator_id"], name: "index_events_on_creator_id"
    t.index ["eventable_type", "eventable_id"], name: "index_events_on_eventable"
  end
  create_table "exports", id: :uuid, force: :cascade do |t|
    t.uuid "account_id", null: false
    t.datetime "completed_at"
    t.datetime "created_at", null: false
    t.string "status", limit: 255, default: "pending", null: false
    t.string "type"
    t.datetime "updated_at", null: false
    t.uuid "user_id", null: false
    t.index ["account_id"], name: "index_exports_on_account_id"
    t.index ["type"], name: "index_exports_on_type"
    t.index ["user_id"], name: "index_exports_on_user_id"
  end
  create_table "filters", id: :uuid, force: :cascade do |t|
    t.uuid "account_id", null: false
    t.datetime "created_at", null: false
    t.uuid "creator_id", null: false
    t.json "fields", default: -> { "json_object()" }, null: false
    t.string "params_digest", limit: 255, null: false
    t.datetime "updated_at", null: false
    t.index ["account_id"], name: "index_filters_on_account_id"
    t.index ["creator_id", "params_digest"], name: "index_filters_on_creator_id_and_params_digest", unique: true
  end
  create_table "filters_tags", id: false, force: :cascade do |t|
    t.uuid "filter_id", null: false
    t.uuid "tag_id", null: false
    t.index ["filter_id"], name: "index_filters_tags_on_filter_id"
    t.index ["tag_id"], name: "index_filters_tags_on_tag_id"
  end
  create_table "identities", id: :uuid, force: :cascade do |t|
    t.datetime "created_at", null: false
    t.string "email_address", limit: 255, null: false
    t.boolean "staff", default: false, null: false
    t.datetime "updated_at", null: false
    t.index ["email_address"], name: "index_identities_on_email_address", unique: true
  end
  create_table "identity_access_tokens", id: :uuid, force: :cascade do |t|
    t.datetime "created_at", null: false
    t.text "description", limit: 65535
    t.uuid "identity_id", null: false
    t.string "permission", limit: 255
    t.string "token", limit: 255
    t.datetime "updated_at", null: false
    t.index ["identity_id"], name: "index_access_token_on_identity_id"
  end
  create_table "magic_links", id: :uuid, force: :cascade do |t|
    t.string "code", limit: 255, null: false
    t.datetime "created_at", null: false
    t.datetime "expires_at", null: false
    t.uuid "identity_id"
    t.integer "purpose", null: false
    t.datetime "updated_at", null: false
    t.index ["code"], name: "index_magic_links_on_code", unique: true
    t.index ["expires_at"], name: "index_magic_links_on_expires_at"
    t.index ["identity_id"], name: "index_magic_links_on_identity_id"
  end
  create_table "mentions", id: :uuid, force: :cascade do |t|
    t.uuid "account_id", null: false
    t.datetime "created_at", null: false
    t.uuid "mentionee_id", null: false
    t.uuid "mentioner_id", null: false
    t.uuid "source_id", null: false
    t.string "source_type", limit: 255, null: false
    t.datetime "updated_at", null: false
    t.index ["account_id"], name: "index_mentions_on_account_id"
    t.index ["mentionee_id"], name: "index_mentions_on_mentionee_id"
    t.index ["mentioner_id"], name: "index_mentions_on_mentioner_id"
    t.index ["source_type", "source_id"], name: "index_mentions_on_source"
  end
  create_table "notification_bundles", id: :uuid, force: :cascade do |t|
    t.uuid "account_id", null: false
    t.datetime "created_at", null: false
    t.datetime "ends_at", null: false
    t.datetime "starts_at", null: false
    t.integer "status", default: 0, null: false
    t.datetime "updated_at", null: false
    t.uuid "user_id", null: false
    t.index ["account_id"], name: "index_notification_bundles_on_account_id"
    t.index ["ends_at", "status"], name: "index_notification_bundles_on_ends_at_and_status"
    t.index ["user_id", "starts_at", "ends_at"], name: "idx_on_user_id_starts_at_ends_at_7eae5d3ac5"
    t.index ["user_id", "status"], name: "index_notification_bundles_on_user_id_and_status"
  end
  create_table "notifications", id: :uuid, force: :cascade do |t|
    t.uuid "account_id", null: false
    t.datetime "created_at", null: false
    t.uuid "creator_id"
    t.datetime "read_at"
    t.uuid "source_id", null: false
    t.string "source_type", limit: 255, null: false
    t.datetime "updated_at", null: false
    t.uuid "user_id", null: false
    t.index ["account_id"], name: "index_notifications_on_account_id"
    t.index ["creator_id"], name: "index_notifications_on_creator_id"
    t.index ["source_type", "source_id"], name: "index_notifications_on_source"
    t.index ["user_id", "read_at", "created_at"], name: "index_notifications_on_user_id_and_read_at_and_created_at", order: { read_at: :desc, created_at: :desc }
    t.index ["user_id"], name: "index_notifications_on_user_id"
  end
  create_table "pins", id: :uuid, force: :cascade do |t|
    t.uuid "account_id", null: false
    t.uuid "card_id", null: false
    t.datetime "created_at", null: false
    t.datetime "updated_at", null: false
    t.uuid "user_id", null: false
    t.index ["account_id"], name: "index_pins_on_account_id"
    t.index ["card_id", "user_id"], name: "index_pins_on_card_id_and_user_id", unique: true
    t.index ["card_id"], name: "index_pins_on_card_id"
    t.index ["user_id"], name: "index_pins_on_user_id"
  end
  create_table "push_subscriptions", id: :uuid, force: :cascade do |t|
    t.uuid "account_id", null: false
    t.string "auth_key", limit: 255
    t.datetime "created_at", null: false
    t.text "endpoint", limit: 65535
    t.string "p256dh_key", limit: 255
    t.datetime "updated_at", null: false
    t.string "user_agent", limit: 4096
    t.uuid "user_id", null: false
    t.index ["account_id"], name: "index_push_subscriptions_on_account_id"
    t.index ["user_id", "endpoint"], name: "index_push_subscriptions_on_user_id_and_endpoint", unique: true
  end
  create_table "reactions", id: :uuid, force: :cascade do |t|
    t.uuid "account_id", null: false
    t.string "content", limit: 16, null: false
    t.datetime "created_at", null: false
    t.uuid "reactable_id", null: false
    t.string "reactable_type", limit: 255, null: false
    t.uuid "reacter_id", null: false
    t.datetime "updated_at", null: false
    t.index ["account_id"], name: "index_reactions_on_account_id"
    t.index ["reactable_type", "reactable_id"], name: "index_reactions_on_reactable_type_and_reactable_id"
    t.index ["reacter_id"], name: "index_reactions_on_reacter_id"
  end
  create_table "search_queries", id: :uuid, force: :cascade do |t|
    t.uuid "account_id", null: false
    t.datetime "created_at", null: false
    t.string "terms", limit: 2000, null: false
    t.datetime "updated_at", null: false
    t.uuid "user_id", null: false
    t.index ["account_id"], name: "index_search_queries_on_account_id"
    t.index ["user_id", "terms"], name: "index_search_queries_on_user_id_and_terms"
    t.index ["user_id", "updated_at"], name: "index_search_queries_on_user_id_and_updated_at", unique: true
    t.index ["user_id"], name: "index_search_queries_on_user_id"
  end
  create_table "search_records", force: :cascade do |t|
    t.uuid "account_id", null: false
    t.uuid "board_id", null: false
    t.uuid "card_id", null: false
    t.text "content", limit: 65535
    t.datetime "created_at", null: false
    t.uuid "searchable_id", null: false
    t.string "searchable_type", limit: 255, null: false
    t.string "title", limit: 255
    t.index ["account_id"], name: "index_search_records_on_account_id"
    t.index ["searchable_type", "searchable_id"], name: "index_search_records_on_searchable_type_and_searchable_id", unique: true
  end
  create_table "sessions", id: :uuid, force: :cascade do |t|
    t.datetime "created_at", null: false
    t.uuid "identity_id", null: false
    t.string "ip_address", limit: 255
    t.datetime "updated_at", null: false
    t.string "user_agent", limit: 4096
    t.index ["identity_id"], name: "index_sessions_on_identity_id"
  end
  create_table "steps", id: :uuid, force: :cascade do |t|
    t.uuid "account_id", null: false
    t.uuid "card_id", null: false
    t.boolean "completed", default: false, null: false
    t.text "content", limit: 65535, null: false
    t.datetime "created_at", null: false
    t.datetime "updated_at", null: false
    t.index ["account_id"], name: "index_steps_on_account_id"
    t.index ["card_id", "completed"], name: "index_steps_on_card_id_and_completed"
    t.index ["card_id"], name: "index_steps_on_card_id"
  end
  create_table "storage_entries", id: :uuid, force: :cascade do |t|
    t.uuid "account_id", null: false
    t.uuid "blob_id"
    t.uuid "board_id"
    t.datetime "created_at", null: false
    t.bigint "delta", null: false
    t.string "operation", limit: 255, null: false
    t.uuid "recordable_id"
    t.string "recordable_type", limit: 255
    t.string "request_id"
    t.uuid "user_id"
    t.index ["account_id"], name: "index_storage_entries_on_account_id"
    t.index ["blob_id"], name: "index_storage_entries_on_blob_id"
    t.index ["board_id"], name: "index_storage_entries_on_board_id"
    t.index ["recordable_type", "recordable_id"], name: "index_storage_entries_on_recordable"
    t.index ["request_id"], name: "index_storage_entries_on_request_id"
    t.index ["user_id"], name: "index_storage_entries_on_user_id"
  end
  create_table "storage_totals", id: :uuid, force: :cascade do |t|
    t.bigint "bytes_stored", default: 0, null: false
    t.datetime "created_at", null: false
    t.uuid "last_entry_id"
    t.uuid "owner_id", null: false
    t.string "owner_type", limit: 255, null: false
    t.datetime "updated_at", null: false
    t.index ["owner_type", "owner_id"], name: "index_storage_totals_on_owner_type_and_owner_id", unique: true
  end
  create_table "taggings", id: :uuid, force: :cascade do |t|
    t.uuid "account_id", null: false
    t.uuid "card_id", null: false
    t.datetime "created_at", null: false
    t.uuid "tag_id", null: false
    t.datetime "updated_at", null: false
    t.index ["account_id"], name: "index_taggings_on_account_id"
    t.index ["card_id", "tag_id"], name: "index_taggings_on_card_id_and_tag_id", unique: true
    t.index ["tag_id"], name: "index_taggings_on_tag_id"
  end
  create_table "tags", id: :uuid, force: :cascade do |t|
    t.uuid "account_id", null: false
    t.datetime "created_at", null: false
    t.string "title", limit: 255
    t.datetime "updated_at", null: false
    t.index ["account_id", "title"], name: "index_tags_on_account_id_and_title", unique: true
  end
  create_table "user_settings", id: :uuid, force: :cascade do |t|
    t.uuid "account_id", null: false
    t.integer "bundle_email_frequency", default: 0, null: false
    t.datetime "created_at", null: false
    t.string "timezone_name", limit: 255
    t.datetime "updated_at", null: false
    t.uuid "user_id", null: false
    t.index ["account_id"], name: "index_user_settings_on_account_id"
    t.index ["user_id", "bundle_email_frequency"], name: "index_user_settings_on_user_id_and_bundle_email_frequency"
    t.index ["user_id"], name: "index_user_settings_on_user_id"
  end
  create_table "users", id: :uuid, force: :cascade do |t|
    t.uuid "account_id", null: false
    t.boolean "active", default: true, null: false
    t.datetime "created_at", null: false
    t.uuid "identity_id"
    t.string "name", limit: 255, null: false
    t.string "role", limit: 255, default: "member", null: false
    t.datetime "updated_at", null: false
    t.datetime "verified_at"
    t.index ["account_id", "identity_id"], name: "index_users_on_account_id_and_identity_id", unique: true
    t.index ["account_id", "role"], name: "index_users_on_account_id_and_role"
    t.index ["identity_id"], name: "index_users_on_identity_id"
  end
  create_table "watches", id: :uuid, force: :cascade do |t|
    t.uuid "account_id", null: false
    t.uuid "card_id", null: false
    t.datetime "created_at", null: false
    t.datetime "updated_at", null: false
    t.uuid "user_id", null: false
    t.boolean "watching", default: true, null: false
    t.index ["account_id"], name: "index_watches_on_account_id"
    t.index ["card_id"], name: "index_watches_on_card_id"
    t.index ["user_id", "card_id"], name: "index_watches_on_user_id_and_card_id"
    t.index ["user_id"], name: "index_watches_on_user_id"
  end
  create_table "webhook_delinquency_trackers", id: :uuid, force: :cascade do |t|
    t.uuid "account_id", null: false
    t.integer "consecutive_failures_count", default: 0
    t.datetime "created_at", null: false
    t.datetime "first_failure_at"
    t.datetime "updated_at", null: false
    t.uuid "webhook_id", null: false
    t.index ["account_id"], name: "index_webhook_delinquency_trackers_on_account_id"
    t.index ["webhook_id"], name: "index_webhook_delinquency_trackers_on_webhook_id"
  end
  create_table "webhook_deliveries", id: :uuid, force: :cascade do |t|
    t.uuid "account_id", null: false
    t.datetime "created_at", null: false
    t.uuid "event_id", null: false
    t.text "request", limit: 65535
    t.text "response", limit: 65535
    t.string "state", limit: 255, null: false
    t.datetime "updated_at", null: false
    t.uuid "webhook_id", null: false
    t.index ["account_id"], name: "index_webhook_deliveries_on_account_id"
    t.index ["event_id"], name: "index_webhook_deliveries_on_event_id"
    t.index ["webhook_id"], name: "index_webhook_deliveries_on_webhook_id"
  end
  create_table "webhooks", id: :uuid, force: :cascade do |t|
    t.uuid "account_id", null: false
    t.boolean "active", default: true, null: false
    t.uuid "board_id", null: false
    t.datetime "created_at", null: false
    t.string "name", limit: 255
    t.string "signing_secret", limit: 255, null: false
    t.text "subscribed_actions", limit: 65535
    t.datetime "updated_at", null: false
    t.text "url", limit: 65535, null: false
    t.index ["account_id"], name: "index_webhooks_on_account_id"
    t.index ["board_id", "subscribed_actions"], name: "index_webhooks_on_board_id_and_subscribed_actions"
  end
  execute "CREATE VIRTUAL TABLE search_records_fts USING fts5(\n        title,\n        content,\n        tokenize='porter'\n      )"
end

================
File: db/schema.rb
================
# This file is auto-generated from the current state of the database. Instead
# of editing this file, please use the migrations feature of Active Record to
# incrementally modify your database, and then regenerate this schema definition.
#
# This file is the source Rails uses to define your schema when running `bin/rails
# db:schema:load`. When creating a new database, `bin/rails db:schema:load` tends to
# be faster and is potentially less error prone than running all of your
# migrations from scratch. Old migrations may fail to apply correctly if those
# migrations use external dependencies or application code.
#
# It's strongly recommended that you check this file into your version control system.
ActiveRecord::Schema[8.2].define(version: 2026_01_21_155752) do
  create_table "accesses", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.datetime "accessed_at"
    t.uuid "account_id", null: false
    t.uuid "board_id", null: false
    t.datetime "created_at", null: false
    t.string "involvement", default: "access_only", null: false
    t.datetime "updated_at", null: false
    t.uuid "user_id", null: false
    t.index ["account_id", "accessed_at"], name: "index_accesses_on_account_id_and_accessed_at"
    t.index ["board_id", "user_id"], name: "index_accesses_on_board_id_and_user_id", unique: true
    t.index ["board_id"], name: "index_accesses_on_board_id"
    t.index ["user_id"], name: "index_accesses_on_user_id"
  end
  create_table "account_cancellations", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "account_id", null: false
    t.datetime "created_at", null: false
    t.uuid "initiated_by_id", null: false
    t.datetime "updated_at", null: false
    t.index ["account_id"], name: "index_account_cancellations_on_account_id", unique: true
  end
  create_table "account_external_id_sequences", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.bigint "value", default: 0, null: false
    t.index ["value"], name: "index_account_external_id_sequences_on_value", unique: true
  end
  create_table "account_imports", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "account_id"
    t.datetime "completed_at"
    t.datetime "created_at", null: false
    t.uuid "identity_id", null: false
    t.string "status", default: "pending", null: false
    t.datetime "updated_at", null: false
    t.index ["account_id"], name: "index_account_imports_on_account_id"
    t.index ["identity_id"], name: "index_account_imports_on_identity_id"
  end
  create_table "account_join_codes", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "account_id", null: false
    t.string "code", null: false
    t.datetime "created_at", null: false
    t.datetime "updated_at", null: false
    t.bigint "usage_count", default: 0, null: false
    t.bigint "usage_limit", default: 10, null: false
    t.index ["account_id", "code"], name: "index_account_join_codes_on_account_id_and_code", unique: true
  end
  create_table "accounts", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.bigint "cards_count", default: 0, null: false
    t.datetime "created_at", null: false
    t.bigint "external_account_id"
    t.string "name", null: false
    t.datetime "updated_at", null: false
    t.index ["external_account_id"], name: "index_accounts_on_external_account_id", unique: true
  end
  create_table "action_text_rich_texts", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "account_id", null: false
    t.text "body", size: :long
    t.datetime "created_at", null: false
    t.string "name", null: false
    t.uuid "record_id", null: false
    t.string "record_type", null: false
    t.datetime "updated_at", null: false
    t.index ["account_id"], name: "index_action_text_rich_texts_on_account_id"
    t.index ["record_type", "record_id", "name"], name: "index_action_text_rich_texts_uniqueness", unique: true
  end
  create_table "active_storage_attachments", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "account_id", null: false
    t.uuid "blob_id", null: false
    t.datetime "created_at", null: false
    t.string "name", null: false
    t.uuid "record_id", null: false
    t.string "record_type", null: false
    t.index ["account_id"], name: "index_active_storage_attachments_on_account_id"
    t.index ["blob_id"], name: "index_active_storage_attachments_on_blob_id"
    t.index ["record_type", "record_id", "name", "blob_id"], name: "index_active_storage_attachments_uniqueness", unique: true
  end
  create_table "active_storage_blobs", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "account_id", null: false
    t.bigint "byte_size", null: false
    t.string "checksum"
    t.string "content_type"
    t.datetime "created_at", null: false
    t.string "filename", null: false
    t.string "key", null: false
    t.text "metadata"
    t.string "service_name", null: false
    t.index ["account_id"], name: "index_active_storage_blobs_on_account_id"
    t.index ["key"], name: "index_active_storage_blobs_on_key", unique: true
  end
  create_table "active_storage_variant_records", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "account_id", null: false
    t.uuid "blob_id", null: false
    t.string "variation_digest", null: false
    t.index ["account_id"], name: "index_active_storage_variant_records_on_account_id"
    t.index ["blob_id", "variation_digest"], name: "index_active_storage_variant_records_uniqueness", unique: true
  end
  create_table "assignees_filters", id: false, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "assignee_id", null: false
    t.uuid "filter_id", null: false
    t.index ["assignee_id"], name: "index_assignees_filters_on_assignee_id"
    t.index ["filter_id"], name: "index_assignees_filters_on_filter_id"
  end
  create_table "assigners_filters", id: false, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "assigner_id", null: false
    t.uuid "filter_id", null: false
    t.index ["assigner_id"], name: "index_assigners_filters_on_assigner_id"
    t.index ["filter_id"], name: "index_assigners_filters_on_filter_id"
  end
  create_table "assignments", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "account_id", null: false
    t.uuid "assignee_id", null: false
    t.uuid "assigner_id", null: false
    t.uuid "card_id", null: false
    t.datetime "created_at", null: false
    t.datetime "updated_at", null: false
    t.index ["account_id"], name: "index_assignments_on_account_id"
    t.index ["assignee_id", "card_id"], name: "index_assignments_on_assignee_id_and_card_id", unique: true
    t.index ["card_id"], name: "index_assignments_on_card_id"
  end
  create_table "board_publications", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "account_id", null: false
    t.uuid "board_id", null: false
    t.datetime "created_at", null: false
    t.string "key"
    t.datetime "updated_at", null: false
    t.index ["account_id", "key"], name: "index_board_publications_on_account_id_and_key"
    t.index ["board_id"], name: "index_board_publications_on_board_id"
  end
  create_table "boards", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "account_id", null: false
    t.boolean "all_access", default: false, null: false
    t.datetime "created_at", null: false
    t.uuid "creator_id", null: false
    t.string "name", null: false
    t.datetime "updated_at", null: false
    t.index ["account_id"], name: "index_boards_on_account_id"
    t.index ["creator_id"], name: "index_boards_on_creator_id"
  end
  create_table "boards_filters", id: false, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "board_id", null: false
    t.uuid "filter_id", null: false
    t.index ["board_id"], name: "index_boards_filters_on_board_id"
    t.index ["filter_id"], name: "index_boards_filters_on_filter_id"
  end
  create_table "card_activity_spikes", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "account_id", null: false
    t.uuid "card_id", null: false
    t.datetime "created_at", null: false
    t.datetime "updated_at", null: false
    t.index ["account_id"], name: "index_card_activity_spikes_on_account_id"
    t.index ["card_id"], name: "index_card_activity_spikes_on_card_id", unique: true
  end
  create_table "card_goldnesses", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "account_id", null: false
    t.uuid "card_id", null: false
    t.datetime "created_at", null: false
    t.datetime "updated_at", null: false
    t.index ["account_id"], name: "index_card_goldnesses_on_account_id"
    t.index ["card_id"], name: "index_card_goldnesses_on_card_id", unique: true
  end
  create_table "card_not_nows", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "account_id", null: false
    t.uuid "card_id", null: false
    t.datetime "created_at", null: false
    t.datetime "updated_at", null: false
    t.uuid "user_id"
    t.index ["account_id"], name: "index_card_not_nows_on_account_id"
    t.index ["card_id"], name: "index_card_not_nows_on_card_id", unique: true
    t.index ["user_id"], name: "index_card_not_nows_on_user_id"
  end
  create_table "cards", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "account_id", null: false
    t.uuid "board_id", null: false
    t.uuid "column_id"
    t.datetime "created_at", null: false
    t.uuid "creator_id", null: false
    t.date "due_on"
    t.datetime "last_active_at", null: false
    t.bigint "number", null: false
    t.string "status", default: "drafted", null: false
    t.string "title"
    t.datetime "updated_at", null: false
    t.index ["account_id", "last_active_at", "status"], name: "index_cards_on_account_id_and_last_active_at_and_status"
    t.index ["account_id", "number"], name: "index_cards_on_account_id_and_number", unique: true
    t.index ["board_id"], name: "index_cards_on_board_id"
    t.index ["column_id"], name: "index_cards_on_column_id"
  end
  create_table "closers_filters", id: false, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "closer_id", null: false
    t.uuid "filter_id", null: false
    t.index ["closer_id"], name: "index_closers_filters_on_closer_id"
    t.index ["filter_id"], name: "index_closers_filters_on_filter_id"
  end
  create_table "closures", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "account_id", null: false
    t.uuid "card_id", null: false
    t.datetime "created_at", null: false
    t.datetime "updated_at", null: false
    t.uuid "user_id"
    t.index ["account_id"], name: "index_closures_on_account_id"
    t.index ["card_id", "created_at"], name: "index_closures_on_card_id_and_created_at"
    t.index ["card_id"], name: "index_closures_on_card_id", unique: true
    t.index ["user_id"], name: "index_closures_on_user_id"
  end
  create_table "columns", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "account_id", null: false
    t.uuid "board_id", null: false
    t.string "color", null: false
    t.datetime "created_at", null: false
    t.string "name", null: false
    t.integer "position", default: 0, null: false
    t.datetime "updated_at", null: false
    t.index ["account_id"], name: "index_columns_on_account_id"
    t.index ["board_id", "position"], name: "index_columns_on_board_id_and_position"
    t.index ["board_id"], name: "index_columns_on_board_id"
  end
  create_table "comments", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "account_id", null: false
    t.uuid "card_id", null: false
    t.datetime "created_at", null: false
    t.uuid "creator_id", null: false
    t.datetime "updated_at", null: false
    t.index ["account_id"], name: "index_comments_on_account_id"
    t.index ["card_id"], name: "index_comments_on_card_id"
  end
  create_table "creators_filters", id: false, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "creator_id", null: false
    t.uuid "filter_id", null: false
    t.index ["creator_id"], name: "index_creators_filters_on_creator_id"
    t.index ["filter_id"], name: "index_creators_filters_on_filter_id"
  end
  create_table "entropies", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "account_id", null: false
    t.bigint "auto_postpone_period", default: 2592000, null: false
    t.uuid "container_id", null: false
    t.string "container_type", null: false
    t.datetime "created_at", null: false
    t.datetime "updated_at", null: false
    t.index ["account_id"], name: "index_entropies_on_account_id"
    t.index ["container_type", "container_id", "auto_postpone_period"], name: "idx_on_container_type_container_id_auto_postpone_pe_3d79b50517"
    t.index ["container_type", "container_id"], name: "index_entropy_configurations_on_container", unique: true
  end
  create_table "events", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "account_id", null: false
    t.string "action", null: false
    t.uuid "board_id", null: false
    t.datetime "created_at", null: false
    t.uuid "creator_id", null: false
    t.uuid "eventable_id", null: false
    t.string "eventable_type", null: false
    t.json "particulars", default: -> { "(json_object())" }
    t.datetime "updated_at", null: false
    t.index ["account_id", "action"], name: "index_events_on_account_id_and_action"
    t.index ["board_id", "action", "created_at"], name: "index_events_on_board_id_and_action_and_created_at"
    t.index ["board_id"], name: "index_events_on_board_id"
    t.index ["creator_id"], name: "index_events_on_creator_id"
    t.index ["eventable_type", "eventable_id"], name: "index_events_on_eventable"
  end
  create_table "exports", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "account_id", null: false
    t.datetime "completed_at"
    t.datetime "created_at", null: false
    t.string "status", default: "pending", null: false
    t.string "type"
    t.datetime "updated_at", null: false
    t.uuid "user_id", null: false
    t.index ["account_id"], name: "index_exports_on_account_id"
    t.index ["type"], name: "index_exports_on_type"
    t.index ["user_id"], name: "index_exports_on_user_id"
  end
  create_table "filters", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "account_id", null: false
    t.datetime "created_at", null: false
    t.uuid "creator_id", null: false
    t.json "fields", default: -> { "(json_object())" }, null: false
    t.string "params_digest", null: false
    t.datetime "updated_at", null: false
    t.index ["account_id"], name: "index_filters_on_account_id"
    t.index ["creator_id", "params_digest"], name: "index_filters_on_creator_id_and_params_digest", unique: true
  end
  create_table "filters_tags", id: false, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "filter_id", null: false
    t.uuid "tag_id", null: false
    t.index ["filter_id"], name: "index_filters_tags_on_filter_id"
    t.index ["tag_id"], name: "index_filters_tags_on_tag_id"
  end
  create_table "identities", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.datetime "created_at", null: false
    t.string "email_address", null: false
    t.boolean "staff", default: false, null: false
    t.datetime "updated_at", null: false
    t.index ["email_address"], name: "index_identities_on_email_address", unique: true
  end
  create_table "identity_access_tokens", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.datetime "created_at", null: false
    t.text "description"
    t.uuid "identity_id", null: false
    t.string "permission"
    t.string "token"
    t.datetime "updated_at", null: false
    t.index ["identity_id"], name: "index_access_token_on_identity_id"
  end
  create_table "magic_links", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.string "code", null: false
    t.datetime "created_at", null: false
    t.datetime "expires_at", null: false
    t.uuid "identity_id"
    t.integer "purpose", null: false
    t.datetime "updated_at", null: false
    t.index ["code"], name: "index_magic_links_on_code", unique: true
    t.index ["expires_at"], name: "index_magic_links_on_expires_at"
    t.index ["identity_id"], name: "index_magic_links_on_identity_id"
  end
  create_table "mentions", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "account_id", null: false
    t.datetime "created_at", null: false
    t.uuid "mentionee_id", null: false
    t.uuid "mentioner_id", null: false
    t.uuid "source_id", null: false
    t.string "source_type", null: false
    t.datetime "updated_at", null: false
    t.index ["account_id"], name: "index_mentions_on_account_id"
    t.index ["mentionee_id"], name: "index_mentions_on_mentionee_id"
    t.index ["mentioner_id"], name: "index_mentions_on_mentioner_id"
    t.index ["source_type", "source_id"], name: "index_mentions_on_source"
  end
  create_table "notification_bundles", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "account_id", null: false
    t.datetime "created_at", null: false
    t.datetime "ends_at", null: false
    t.datetime "starts_at", null: false
    t.integer "status", default: 0, null: false
    t.datetime "updated_at", null: false
    t.uuid "user_id", null: false
    t.index ["account_id"], name: "index_notification_bundles_on_account_id"
    t.index ["ends_at", "status"], name: "index_notification_bundles_on_ends_at_and_status"
    t.index ["user_id", "starts_at", "ends_at"], name: "idx_on_user_id_starts_at_ends_at_7eae5d3ac5"
    t.index ["user_id", "status"], name: "index_notification_bundles_on_user_id_and_status"
  end
  create_table "notifications", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "account_id", null: false
    t.datetime "created_at", null: false
    t.uuid "creator_id"
    t.datetime "read_at"
    t.uuid "source_id", null: false
    t.string "source_type", null: false
    t.datetime "updated_at", null: false
    t.uuid "user_id", null: false
    t.index ["account_id"], name: "index_notifications_on_account_id"
    t.index ["creator_id"], name: "index_notifications_on_creator_id"
    t.index ["source_type", "source_id"], name: "index_notifications_on_source"
    t.index ["user_id", "read_at", "created_at"], name: "index_notifications_on_user_id_and_read_at_and_created_at", order: { read_at: :desc, created_at: :desc }
    t.index ["user_id"], name: "index_notifications_on_user_id"
  end
  create_table "pins", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "account_id", null: false
    t.uuid "card_id", null: false
    t.datetime "created_at", null: false
    t.datetime "updated_at", null: false
    t.uuid "user_id", null: false
    t.index ["account_id"], name: "index_pins_on_account_id"
    t.index ["card_id", "user_id"], name: "index_pins_on_card_id_and_user_id", unique: true
    t.index ["card_id"], name: "index_pins_on_card_id"
    t.index ["user_id"], name: "index_pins_on_user_id"
  end
  create_table "push_subscriptions", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "account_id", null: false
    t.string "auth_key"
    t.datetime "created_at", null: false
    t.text "endpoint"
    t.string "p256dh_key"
    t.datetime "updated_at", null: false
    t.string "user_agent", limit: 4096
    t.uuid "user_id", null: false
    t.index ["account_id"], name: "index_push_subscriptions_on_account_id"
    t.index ["user_id", "endpoint"], name: "index_push_subscriptions_on_user_id_and_endpoint", unique: true, length: { endpoint: 255 }
  end
  create_table "reactions", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "account_id", null: false
    t.string "content", limit: 16, null: false
    t.datetime "created_at", null: false
    t.uuid "reactable_id", null: false
    t.string "reactable_type", null: false
    t.uuid "reacter_id", null: false
    t.datetime "updated_at", null: false
    t.index ["account_id"], name: "index_reactions_on_account_id"
    t.index ["reactable_type", "reactable_id"], name: "index_reactions_on_reactable_type_and_reactable_id"
    t.index ["reacter_id"], name: "index_reactions_on_reacter_id"
  end
  create_table "search_queries", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "account_id", null: false
    t.datetime "created_at", null: false
    t.string "terms", limit: 2000, null: false
    t.datetime "updated_at", null: false
    t.uuid "user_id", null: false
    t.index ["account_id"], name: "index_search_queries_on_account_id"
    t.index ["user_id", "terms"], name: "index_search_queries_on_user_id_and_terms", length: { terms: 255 }
    t.index ["user_id", "updated_at"], name: "index_search_queries_on_user_id_and_updated_at", unique: true
    t.index ["user_id"], name: "index_search_queries_on_user_id"
  end
  create_table "search_records_0", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "account_id", null: false
    t.string "account_key", default: "", null: false
    t.uuid "board_id", null: false
    t.uuid "card_id", null: false
    t.text "content"
    t.datetime "created_at", null: false
    t.uuid "searchable_id", null: false
    t.string "searchable_type", null: false
    t.string "title"
    t.index ["account_id"], name: "index_search_records_0_on_account_id"
    t.index ["account_key", "content", "title"], name: "index_search_records_0_on_account_key_and_content_and_title", type: :fulltext
    t.index ["searchable_type", "searchable_id"], name: "index_search_records_0_on_searchable_type_and_searchable_id", unique: true
  end
  create_table "search_records_1", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "account_id", null: false
    t.string "account_key", default: "", null: false
    t.uuid "board_id", null: false
    t.uuid "card_id", null: false
    t.text "content"
    t.datetime "created_at", null: false
    t.uuid "searchable_id", null: false
    t.string "searchable_type", null: false
    t.string "title"
    t.index ["account_id"], name: "index_search_records_1_on_account_id"
    t.index ["account_key", "content", "title"], name: "index_search_records_1_on_account_key_and_content_and_title", type: :fulltext
    t.index ["searchable_type", "searchable_id"], name: "index_search_records_1_on_searchable_type_and_searchable_id", unique: true
  end
  create_table "search_records_10", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "account_id", null: false
    t.string "account_key", default: "", null: false
    t.uuid "board_id", null: false
    t.uuid "card_id", null: false
    t.text "content"
    t.datetime "created_at", null: false
    t.uuid "searchable_id", null: false
    t.string "searchable_type", null: false
    t.string "title"
    t.index ["account_id"], name: "index_search_records_10_on_account_id"
    t.index ["account_key", "content", "title"], name: "index_search_records_10_on_account_key_and_content_and_title", type: :fulltext
    t.index ["searchable_type", "searchable_id"], name: "index_search_records_10_on_searchable_type_and_searchable_id", unique: true
  end
  create_table "search_records_11", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "account_id", null: false
    t.string "account_key", default: "", null: false
    t.uuid "board_id", null: false
    t.uuid "card_id", null: false
    t.text "content"
    t.datetime "created_at", null: false
    t.uuid "searchable_id", null: false
    t.string "searchable_type", null: false
    t.string "title"
    t.index ["account_id"], name: "index_search_records_11_on_account_id"
    t.index ["account_key", "content", "title"], name: "index_search_records_11_on_account_key_and_content_and_title", type: :fulltext
    t.index ["searchable_type", "searchable_id"], name: "index_search_records_11_on_searchable_type_and_searchable_id", unique: true
  end
  create_table "search_records_12", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "account_id", null: false
    t.string "account_key", default: "", null: false
    t.uuid "board_id", null: false
    t.uuid "card_id", null: false
    t.text "content"
    t.datetime "created_at", null: false
    t.uuid "searchable_id", null: false
    t.string "searchable_type", null: false
    t.string "title"
    t.index ["account_id"], name: "index_search_records_12_on_account_id"
    t.index ["account_key", "content", "title"], name: "index_search_records_12_on_account_key_and_content_and_title", type: :fulltext
    t.index ["searchable_type", "searchable_id"], name: "index_search_records_12_on_searchable_type_and_searchable_id", unique: true
  end
  create_table "search_records_13", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "account_id", null: false
    t.string "account_key", default: "", null: false
    t.uuid "board_id", null: false
    t.uuid "card_id", null: false
    t.text "content"
    t.datetime "created_at", null: false
    t.uuid "searchable_id", null: false
    t.string "searchable_type", null: false
    t.string "title"
    t.index ["account_id"], name: "index_search_records_13_on_account_id"
    t.index ["account_key", "content", "title"], name: "index_search_records_13_on_account_key_and_content_and_title", type: :fulltext
    t.index ["searchable_type", "searchable_id"], name: "index_search_records_13_on_searchable_type_and_searchable_id", unique: true
  end
  create_table "search_records_14", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "account_id", null: false
    t.string "account_key", default: "", null: false
    t.uuid "board_id", null: false
    t.uuid "card_id", null: false
    t.text "content"
    t.datetime "created_at", null: false
    t.uuid "searchable_id", null: false
    t.string "searchable_type", null: false
    t.string "title"
    t.index ["account_id"], name: "index_search_records_14_on_account_id"
    t.index ["account_key", "content", "title"], name: "index_search_records_14_on_account_key_and_content_and_title", type: :fulltext
    t.index ["searchable_type", "searchable_id"], name: "index_search_records_14_on_searchable_type_and_searchable_id", unique: true
  end
  create_table "search_records_15", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "account_id", null: false
    t.string "account_key", default: "", null: false
    t.uuid "board_id", null: false
    t.uuid "card_id", null: false
    t.text "content"
    t.datetime "created_at", null: false
    t.uuid "searchable_id", null: false
    t.string "searchable_type", null: false
    t.string "title"
    t.index ["account_id"], name: "index_search_records_15_on_account_id"
    t.index ["account_key", "content", "title"], name: "index_search_records_15_on_account_key_and_content_and_title", type: :fulltext
    t.index ["searchable_type", "searchable_id"], name: "index_search_records_15_on_searchable_type_and_searchable_id", unique: true
  end
  create_table "search_records_2", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "account_id", null: false
    t.string "account_key", default: "", null: false
    t.uuid "board_id", null: false
    t.uuid "card_id", null: false
    t.text "content"
    t.datetime "created_at", null: false
    t.uuid "searchable_id", null: false
    t.string "searchable_type", null: false
    t.string "title"
    t.index ["account_id"], name: "index_search_records_2_on_account_id"
    t.index ["account_key", "content", "title"], name: "index_search_records_2_on_account_key_and_content_and_title", type: :fulltext
    t.index ["searchable_type", "searchable_id"], name: "index_search_records_2_on_searchable_type_and_searchable_id", unique: true
  end
  create_table "search_records_3", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "account_id", null: false
    t.string "account_key", default: "", null: false
    t.uuid "board_id", null: false
    t.uuid "card_id", null: false
    t.text "content"
    t.datetime "created_at", null: false
    t.uuid "searchable_id", null: false
    t.string "searchable_type", null: false
    t.string "title"
    t.index ["account_id"], name: "index_search_records_3_on_account_id"
    t.index ["account_key", "content", "title"], name: "index_search_records_3_on_account_key_and_content_and_title", type: :fulltext
    t.index ["searchable_type", "searchable_id"], name: "index_search_records_3_on_searchable_type_and_searchable_id", unique: true
  end
  create_table "search_records_4", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "account_id", null: false
    t.string "account_key", default: "", null: false
    t.uuid "board_id", null: false
    t.uuid "card_id", null: false
    t.text "content"
    t.datetime "created_at", null: false
    t.uuid "searchable_id", null: false
    t.string "searchable_type", null: false
    t.string "title"
    t.index ["account_id"], name: "index_search_records_4_on_account_id"
    t.index ["account_key", "content", "title"], name: "index_search_records_4_on_account_key_and_content_and_title", type: :fulltext
    t.index ["searchable_type", "searchable_id"], name: "index_search_records_4_on_searchable_type_and_searchable_id", unique: true
  end
  create_table "search_records_5", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "account_id", null: false
    t.string "account_key", default: "", null: false
    t.uuid "board_id", null: false
    t.uuid "card_id", null: false
    t.text "content"
    t.datetime "created_at", null: false
    t.uuid "searchable_id", null: false
    t.string "searchable_type", null: false
    t.string "title"
    t.index ["account_id"], name: "index_search_records_5_on_account_id"
    t.index ["account_key", "content", "title"], name: "index_search_records_5_on_account_key_and_content_and_title", type: :fulltext
    t.index ["searchable_type", "searchable_id"], name: "index_search_records_5_on_searchable_type_and_searchable_id", unique: true
  end
  create_table "search_records_6", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "account_id", null: false
    t.string "account_key", default: "", null: false
    t.uuid "board_id", null: false
    t.uuid "card_id", null: false
    t.text "content"
    t.datetime "created_at", null: false
    t.uuid "searchable_id", null: false
    t.string "searchable_type", null: false
    t.string "title"
    t.index ["account_id"], name: "index_search_records_6_on_account_id"
    t.index ["account_key", "content", "title"], name: "index_search_records_6_on_account_key_and_content_and_title", type: :fulltext
    t.index ["searchable_type", "searchable_id"], name: "index_search_records_6_on_searchable_type_and_searchable_id", unique: true
  end
  create_table "search_records_7", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "account_id", null: false
    t.string "account_key", default: "", null: false
    t.uuid "board_id", null: false
    t.uuid "card_id", null: false
    t.text "content"
    t.datetime "created_at", null: false
    t.uuid "searchable_id", null: false
    t.string "searchable_type", null: false
    t.string "title"
    t.index ["account_id"], name: "index_search_records_7_on_account_id"
    t.index ["account_key", "content", "title"], name: "index_search_records_7_on_account_key_and_content_and_title", type: :fulltext
    t.index ["searchable_type", "searchable_id"], name: "index_search_records_7_on_searchable_type_and_searchable_id", unique: true
  end
  create_table "search_records_8", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "account_id", null: false
    t.string "account_key", default: "", null: false
    t.uuid "board_id", null: false
    t.uuid "card_id", null: false
    t.text "content"
    t.datetime "created_at", null: false
    t.uuid "searchable_id", null: false
    t.string "searchable_type", null: false
    t.string "title"
    t.index ["account_id"], name: "index_search_records_8_on_account_id"
    t.index ["account_key", "content", "title"], name: "index_search_records_8_on_account_key_and_content_and_title", type: :fulltext
    t.index ["searchable_type", "searchable_id"], name: "index_search_records_8_on_searchable_type_and_searchable_id", unique: true
  end
  create_table "search_records_9", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "account_id", null: false
    t.string "account_key", default: "", null: false
    t.uuid "board_id", null: false
    t.uuid "card_id", null: false
    t.text "content"
    t.datetime "created_at", null: false
    t.uuid "searchable_id", null: false
    t.string "searchable_type", null: false
    t.string "title"
    t.index ["account_id"], name: "index_search_records_9_on_account_id"
    t.index ["account_key", "content", "title"], name: "index_search_records_9_on_account_key_and_content_and_title", type: :fulltext
    t.index ["searchable_type", "searchable_id"], name: "index_search_records_9_on_searchable_type_and_searchable_id", unique: true
  end
  create_table "sessions", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.datetime "created_at", null: false
    t.uuid "identity_id", null: false
    t.string "ip_address"
    t.datetime "updated_at", null: false
    t.string "user_agent", limit: 4096
    t.index ["identity_id"], name: "index_sessions_on_identity_id"
  end
  create_table "steps", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "account_id", null: false
    t.uuid "card_id", null: false
    t.boolean "completed", default: false, null: false
    t.text "content", null: false
    t.datetime "created_at", null: false
    t.datetime "updated_at", null: false
    t.index ["account_id"], name: "index_steps_on_account_id"
    t.index ["card_id", "completed"], name: "index_steps_on_card_id_and_completed"
    t.index ["card_id"], name: "index_steps_on_card_id"
  end
  create_table "storage_entries", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "account_id", null: false
    t.uuid "blob_id"
    t.uuid "board_id"
    t.datetime "created_at", null: false
    t.bigint "delta", null: false
    t.string "operation", null: false
    t.uuid "recordable_id"
    t.string "recordable_type"
    t.string "request_id"
    t.uuid "user_id"
    t.index ["account_id"], name: "index_storage_entries_on_account_id"
    t.index ["blob_id"], name: "index_storage_entries_on_blob_id"
    t.index ["board_id"], name: "index_storage_entries_on_board_id"
    t.index ["recordable_type", "recordable_id"], name: "index_storage_entries_on_recordable"
    t.index ["request_id"], name: "index_storage_entries_on_request_id"
    t.index ["user_id"], name: "index_storage_entries_on_user_id"
  end
  create_table "storage_totals", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.bigint "bytes_stored", default: 0, null: false
    t.datetime "created_at", null: false
    t.uuid "last_entry_id"
    t.uuid "owner_id", null: false
    t.string "owner_type", null: false
    t.datetime "updated_at", null: false
    t.index ["owner_type", "owner_id"], name: "index_storage_totals_on_owner_type_and_owner_id", unique: true
  end
  create_table "taggings", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "account_id", null: false
    t.uuid "card_id", null: false
    t.datetime "created_at", null: false
    t.uuid "tag_id", null: false
    t.datetime "updated_at", null: false
    t.index ["account_id"], name: "index_taggings_on_account_id"
    t.index ["card_id", "tag_id"], name: "index_taggings_on_card_id_and_tag_id", unique: true
    t.index ["tag_id"], name: "index_taggings_on_tag_id"
  end
  create_table "tags", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "account_id", null: false
    t.datetime "created_at", null: false
    t.string "title"
    t.datetime "updated_at", null: false
    t.index ["account_id", "title"], name: "index_tags_on_account_id_and_title", unique: true
  end
  create_table "user_settings", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "account_id", null: false
    t.integer "bundle_email_frequency", default: 0, null: false
    t.datetime "created_at", null: false
    t.string "timezone_name"
    t.datetime "updated_at", null: false
    t.uuid "user_id", null: false
    t.index ["account_id"], name: "index_user_settings_on_account_id"
    t.index ["user_id", "bundle_email_frequency"], name: "index_user_settings_on_user_id_and_bundle_email_frequency"
    t.index ["user_id"], name: "index_user_settings_on_user_id"
  end
  create_table "users", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "account_id", null: false
    t.boolean "active", default: true, null: false
    t.datetime "created_at", null: false
    t.uuid "identity_id"
    t.string "name", null: false
    t.string "role", default: "member", null: false
    t.datetime "updated_at", null: false
    t.datetime "verified_at"
    t.index ["account_id", "identity_id"], name: "index_users_on_account_id_and_identity_id", unique: true
    t.index ["account_id", "role"], name: "index_users_on_account_id_and_role"
    t.index ["identity_id"], name: "index_users_on_identity_id"
  end
  create_table "watches", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "account_id", null: false
    t.uuid "card_id", null: false
    t.datetime "created_at", null: false
    t.datetime "updated_at", null: false
    t.uuid "user_id", null: false
    t.boolean "watching", default: true, null: false
    t.index ["account_id"], name: "index_watches_on_account_id"
    t.index ["card_id"], name: "index_watches_on_card_id"
    t.index ["user_id", "card_id"], name: "index_watches_on_user_id_and_card_id"
    t.index ["user_id"], name: "index_watches_on_user_id"
  end
  create_table "webhook_delinquency_trackers", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "account_id", null: false
    t.integer "consecutive_failures_count", default: 0
    t.datetime "created_at", null: false
    t.datetime "first_failure_at"
    t.datetime "updated_at", null: false
    t.uuid "webhook_id", null: false
    t.index ["account_id"], name: "index_webhook_delinquency_trackers_on_account_id"
    t.index ["webhook_id"], name: "index_webhook_delinquency_trackers_on_webhook_id"
  end
  create_table "webhook_deliveries", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "account_id", null: false
    t.datetime "created_at", null: false
    t.uuid "event_id", null: false
    t.text "request"
    t.text "response"
    t.string "state", null: false
    t.datetime "updated_at", null: false
    t.uuid "webhook_id", null: false
    t.index ["account_id"], name: "index_webhook_deliveries_on_account_id"
    t.index ["event_id"], name: "index_webhook_deliveries_on_event_id"
    t.index ["webhook_id"], name: "index_webhook_deliveries_on_webhook_id"
  end
  create_table "webhooks", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "account_id", null: false
    t.boolean "active", default: true, null: false
    t.uuid "board_id", null: false
    t.datetime "created_at", null: false
    t.string "name"
    t.string "signing_secret", null: false
    t.text "subscribed_actions"
    t.datetime "updated_at", null: false
    t.text "url", null: false
    t.index ["account_id"], name: "index_webhooks_on_account_id"
    t.index ["board_id", "subscribed_actions"], name: "index_webhooks_on_board_id_and_subscribed_actions", length: { subscribed_actions: 255 }
  end
end

================
File: db/seeds.rb
================
unless Rails.env.development?
  puts "WARN: Seeding is just for development!"
else
  require "active_support/testing/time_helpers"
  include ActiveSupport::Testing::TimeHelpers
  # Seed DSL
  def seed_account(name)
    print "  #{name}"
    elapsed = Benchmark.realtime { require_relative "seeds/#{name}" }
    puts " #{elapsed.round(2)} sec"
  end
  def create_tenant(signal_account_name)
    tenant_id = ActiveRecord::FixtureSet.identify signal_account_name
    email_address = "david@example.com"
    identity = Identity.find_or_create_by!(email_address: email_address, staff: true)
    unless account = Account.find_by(external_account_id: tenant_id)
      account = Account.create_with_owner(
        account: {
          external_account_id: tenant_id,
          name: signal_account_name
        },
        owner: {
          name: "David Heinemeier Hansson",
          identity: identity
        }
      )
    end
    Current.account = account
  end
  def find_or_create_user(full_name, email_address)
    identity = Identity.find_or_create_by!(email_address: email_address)
    if user = identity.users.find_by(account: Current.account)
      user
    else
      User.create!(name: full_name, identity: identity, account: Current.account, verified_at: Time.current)
    end
  end
  def login_as(user)
    Current.session = user.identity.sessions.create
  end
  def create_board(name, creator: Current.user, all_access: true, access_to: [])
    Board.find_or_create_by!(name:, creator:, all_access:).tap { it.accesses.grant_to(access_to) }
  end
  def create_card(title, board:, description: nil, status: :published, creator: Current.user)
    board.cards.create!(title:, description:, creator:, status:)
  end
  # Seed accounts
  seed_account "cleanslate"
  seed_account "37signals"
  seed_account "honcho"
end

================
File: docs/API.md
================
# Fizzy API

Fizzy has an API that allows you to integrate your application with it or to create
a bot to perform various actions for you.

## Authentication

There are two ways to authenticate with the Fizzy API:

1. **Personal access tokens** - Long-lived tokens for scripts and integrations
2. **Magic link authentication** - Session-based authentication for native apps

### Personal Access Tokens

To use the API you'll need an access token. To get one, go to your profile, then,
in the API section, click on "Personal access tokens" and then click on
"Generate new access token".

Give it a description and pick what kind of permission you want the access token to have:
- `Read`: allows reading data from your account
- `Read + Write`: allows reading and writing data to your account on your behalf

Then click on "Generate access token".

<details>
  <summary>Access token generation guide with screenshots</summary>

  | Step | Description | Screenshot |
  |:----:|-------------|:----------:|
  | 1 | Go to your profile | <img width="400" alt="Profile page with API section" src="https://github.com/user-attachments/assets/49e7e12b-2952-4220-84fd-cef99b13bc04" /> |
  | 2 | In the API section click on "Personal access token" | <img width="400" alt="Personal access tokens page" src="https://github.com/user-attachments/assets/2f026ea0-416f-4fbe-a097-61313f24f180" /> |
  | 3 | Click on "Generate a new access token" | <img width="400" alt="Generate new access token dialog" src="https://github.com/user-attachments/assets/d766f047-8628-416d-8e21-b89522f6c0d9" /> |
  | 4 | Give it a description and assign it a permission | <img width="400" alt="Access token created" src="https://github.com/user-attachments/assets/49b8e350-d152-4946-8aad-e13260b983fd" /> |
</details>

> [!IMPORTANT]
> __An access token is like a password, keep it secret and do not share it with anyone.__
> Any person or application that has your access token can perform actions on your behalf.

To authenticate a request using your access token, include it in the `Authorization` header:

```bash
curl -H "Authorization: Bearer put-your-access-token-here" -H "Accept: application/json" https://app.fizzy.do/my/identity
```

### Magic Link Authentication

For native apps, you can authenticate users via magic links. This is a two-step process:

#### 1. Request a magic link

Send the user's email address to request a magic link be sent to them:

```bash
curl -X POST \
  -H "Content-Type: application/json" \
  -H "Accept: application/json" \
  -d '{"email_address": "user@example.com"}' \
  https://app.fizzy.do/session
```

__Response:__

```
HTTP/1.1 201 Created
Set-Cookie: pending_authentication_token=...; HttpOnly; SameSite=Lax
```

```json
{
  "pending_authentication_token": "eyJfcmFpbHMi..."
}
```

The response includes a `pending_authentication_token` both in the JSON body and as a cookie.
Native apps should store this token and include it as a cookie when submitting the magic link code.

__Error responses:__

| Status Code | Description |
|--------|-------------|
| `422 Unprocessable entity` | Invalid email address, if sign ups are enabled and the value isn't a valid email address |
| `429 Too Many Requests` | Rate limit exceeded |

#### 2. Submit the magic link code

Once the user receives the magic link email, they'll have a 6-character code. Submit it to complete authentication:

```bash
curl -X POST \
  -H "Content-Type: application/json" \
  -H "Accept: application/json" \
  -H "Cookie: pending_authentication_token=eyJfcmFpbHMi..." \
  -d '{"code": "ABC123"}' \
  https://app.fizzy.do/session/magic_link
```

__Response:__

```json
{
  "session_token": "eyJfcmFpbHMi..."
}
```

The `session_token` can be used to authenticate subsequent requests by including it as a cookie:

```bash
curl -H "Cookie: session_token=eyJfcmFpbHMi..." \
  -H "Accept: application/json" \
  https://app.fizzy.do/my/identity
```

__Error responses:__

| Status Code | Description |
|--------|-------------|
| `401 Unauthorized` | Invalid `pending_authentication_token` or `code` |
| `429 Too Many Requests` | Rate limit exceeded |


#### Delete server-side session (_log out_)

To log out and destroy the server-side session:

```bash
curl -X DELETE \
  -H "Accept: application/json" \
  -H "Cookie: session_token=eyJfcmFpbHMi..." \
  https://app.fizzy.do/session
```

__Response:__

Returns `204 No Content` on success.

## Caching

Most endpoints return [ETag](https://developer.mozilla.org/en-US/docs/Web/HTTP/Reference/Headers/ETag) and [Cache-Control](https://developer.mozilla.org/en-US/docs/Web/HTTP/Reference/Headers/Cache-Control) headers. You can use these to avoid re-downloading unchanged data.

### Using ETags

When you make a request, the response includes an `ETag` header:

```
HTTP/1.1 200 OK
ETag: "abc123"
Cache-Control: max-age=0, private, must-revalidate
```

On subsequent requests, include the ETag value in the `If-None-Match` header:

```
GET /1234567/cards/42.json
If-None-Match: "abc123"
```

If the resource hasn't changed, you'll receive a `304 Not Modified` response with no body, saving bandwidth and processing time:

```
HTTP/1.1 304 Not Modified
ETag: "abc123"
```

If the resource has changed, you'll receive the full response with a new ETag.

__Example in Ruby:__

```ruby
# Store the ETag from the response
etag = response.headers["ETag"]

# On next request, send it back
headers = { "If-None-Match" => etag }
response = client.get("/1234567/cards/42.json", headers: headers)

if response.status == 304
  # Nothing to do, the card hasn't changed
else
  # The card has changed, process the new data
end
```

## Error Responses

When a request fails, the API response will communicate the source of the problem through the HTTP status code.

| Status Code | Description |
|-------------|-------------|
| `400 Bad Request` | The request was malformed or missing required parameters |
| `401 Unauthorized` | Authentication failed or access token is invalid |
| `403 Forbidden` | You don't have permission to perform this action |
| `404 Not Found` | The requested resource doesn't exist or you don't have access to it |
| `422 Unprocessable Entity` | Validation failed (see error response format above) |
| `500 Internal Server Error` | An unexpected error occurred on the server |

If a request contains invalid data for fields, such as entering a string into a number field, in most cases the API will respond with a `500 Internal Server Error`. Clients are expected to perform some validation on their end before making a request.

A validation error will produce a `422 Unprocessable Entity` response, which will sometimes be accompanied by details about the error:

```json
{
  "avatar": ["must be a JPEG, PNG, GIF, or WebP image"]
}
```

## Pagination

All endpoints that return a list of items are paginated. The page size can vary from endpoint to endpoint,
and we use a dynamic page size where initial pages return fewer results than later pages.

If there are more results to fetch, the response will include a `Link` header with a `rel="next"` link to the next page of results:

```bash
curl -H "Authorization: Bearer put-your-access-token-here" -H "Accept: application/json" -v http://fizzy.localhost:3006/686465299/cards
# ...
< link: <http://fizzy.localhost:3006/686465299/cards?page=2>; rel="next"
# ...
```

## List parameters

When an endpoint accepts a list of values as a parameter, you can provide multiple values by repeating the parameter name:

```
?tag_ids[]=tag1&tag_ids[]=tag2&tag_ids[]=tag3
```

List parameters always end with `[]`.

## File Uploads

Some endpoints accept file uploads. To upload a file, send a `multipart/form-data` request instead of JSON.
You can combine file uploads with other parameters in the same request.

__Example using curl:__

```bash
curl -X PUT \
  -H "Authorization: Bearer put-your-access-token-here" \
  -F "user[name]=David H. Hansson" \
  -F "user[avatar]=@/path/to/avatar.jpg" \
  http://fizzy.localhost:3006/686465299/users/03f5v9zjw7pz8717a4no1h8a7
```

## Rich Text Fields

Some fields accept rich text content. These fields accept HTML input, which will be sanitized to remove unsafe tags and attributes.

```json
{
  "card": {
    "title": "My card",
    "description": "<p>This is <strong>bold</strong> and this is <em>italic</em>.</p><ul><li>Item 1</li><li>Item 2</li></ul>"
  }
}
```

### Attaching files to rich text

To attach files (images, documents) to rich text fields, use ActionText's direct upload flow:

#### 1. Create a direct upload

First, request a direct upload URL by sending file metadata:

```bash
curl -X POST \
  -H "Authorization: Bearer put-your-access-token-here" \
  -H "Content-Type: application/json" \
  -d '{
    "blob": {
      "filename": "screenshot.png",
      "byte_size": 12345,
      "checksum": "GQ5SqLsM7ylnji0Wgd9wNA==",
      "content_type": "image/png"
    }
  }' \
  https://app.fizzy.do/123456/rails/active_storage/direct_uploads
```

The `checksum` is a Base64-encoded MD5 hash of the file content.
The direct upload endpoint is scoped to your account (replace `/123456` with your account slug).

__Response:__

```json
{
  "id": "abc123",
  "key": "abc123def456",
  "filename": "screenshot.png",
  "content_type": "image/png",
  "byte_size": 12345,
  "checksum": "GQ5SqLsM7ylnji0Wgd9wNA==",
  "direct_upload": {
    "url": "https://storage.example.com/...",
    "headers": {
      "Content-Type": "image/png",
      "Content-MD5": "GQ5SqLsM7ylnji0Wgd9wNA=="
    }
  },
  "signed_id": "eyJfcmFpbHMi..."
}
```

#### 2. Upload the file

Upload the file directly to the provided URL with the specified headers:

```bash
curl -X PUT \
  -H "Content-Type: image/png" \
  -H "Content-MD5: GQ5SqLsM7ylnji0Wgd9wNA==" \
  --data-binary @screenshot.png \
  "https://storage.example.com/..."
```

#### 3. Reference the file in rich text

Use the `signed_id` from step 1 to embed the file in your rich text using an `<action-text-attachment>` tag:

```json
{
  "card": {
    "title": "Card with image",
    "description": "<p>Here's a screenshot:</p><action-text-attachment sgid=\"eyJfcmFpbHMi...\"></action-text-attachment>"
  }
}
```

The `sgid` attribute should contain the `signed_id` returned from the direct upload response.

## Identity

An Identity represents a person using Fizzy.

### `GET /my/identity`

Returns a list of accounts the identity has access to, including the user for each account.

```json
{
  "accounts": [
    {
      "id": "03f5v9zjskhcii2r45ih3u1rq",
      "name": "37signals",
      "slug": "/897362094",
      "created_at": "2025-12-05T19:36:35.377Z",
      "user": {
        "id": "03f5v9zjw7pz8717a4no1h8a7",
        "name": "David Heinemeier Hansson",
        "role": "owner",
        "active": true,
        "email_address": "david@example.com",
        "created_at": "2025-12-05T19:36:35.401Z",
        "url": "http://fizzy.localhost:3006/users/03f5v9zjw7pz8717a4no1h8a7"
      }
    },
    {
      "id": "03f5v9zpko7mmhjzwum3youpp",
      "name": "Honcho",
      "slug": "/686465299",
      "created_at": "2025-12-05T19:36:36.746Z",
      "user": {
        "id": "03f5v9zppzlksuj4mxba2nbzn",
        "name": "David Heinemeier Hansson",
        "role": "owner",
        "active": true,
        "email_address": "david@example.com",
        "created_at": "2025-12-05T19:36:36.783Z",
        "url": "http://fizzy.localhost:3006/users/03f5v9zppzlksuj4mxba2nbzn"
      }
    }
  ]
}
```

## Boards

Boards are where you organize your work - they contain your cards.

### `GET /:account_slug/boards`

Returns a list of boards that you can access in the specified account.

__Response:__

```json
[
  {
    "id": "03f5v9zkft4hj9qq0lsn9ohcm",
    "name": "Fizzy",
    "all_access": true,
    "created_at": "2025-12-05T19:36:35.534Z",
    "url": "http://fizzy.localhost:3006/897362094/boards/03f5v9zkft4hj9qq0lsn9ohcm",
    "creator": {
      "id": "03f5v9zjw7pz8717a4no1h8a7",
      "name": "David Heinemeier Hansson",
      "role": "owner",
      "active": true,
      "email_address": "david@example.com",
      "created_at": "2025-12-05T19:36:35.401Z",
      "url": "http://fizzy.localhost:3006/897362094/users/03f5v9zjw7pz8717a4no1h8a7"
    }
  }
]
```

### `GET /:account_slug/boards/:board_id`

Returns the specified board.

__Response:__

```json
{
  "id": "03f5v9zkft4hj9qq0lsn9ohcm",
  "name": "Fizzy",
  "all_access": true,
  "created_at": "2025-12-05T19:36:35.534Z",
  "url": "http://fizzy.localhost:3006/897362094/boards/03f5v9zkft4hj9qq0lsn9ohcm",
  "creator": {
    "id": "03f5v9zjw7pz8717a4no1h8a7",
    "name": "David Heinemeier Hansson",
    "role": "owner",
    "active": true,
    "email_address": "david@example.com",
    "created_at": "2025-12-05T19:36:35.401Z",
    "url": "http://fizzy.localhost:3006/897362094/users/03f5v9zjw7pz8717a4no1h8a7"
  }
}
```

### `POST /:account_slug/boards`

Creates a new Board in the account.

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `name` | string | Yes | The name of the board |
| `all_access` | boolean | No | Whether any user in the account can access this board. Defaults to `true` |
| `auto_postpone_period` | integer | No | Number of days of inactivity before cards are automatically postponed |
| `public_description` | string | No | Rich text description shown on the public board page |

__Request:__

```json
{
  "board": {
    "name": "My new board",
  }
}
```

__Response:__

Returns `201 Created` with a `Location` header pointing to the new board:

```
HTTP/1.1 201 Created
Location: /897362094/boards/03f5v9zkft4hj9qq0lsn9ohcm.json
```

### `PUT /:account_slug/boards/:board_id`

Updates a Board. Only board administrators can update a board.

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `name` | string | No | The name of the board |
| `all_access` | boolean | No | Whether any user in the account can access this board |
| `auto_postpone_period` | integer | No | Number of days of inactivity before cards are automatically postponed |
| `public_description` | string | No | Rich text description shown on the public board page |
| `user_ids` | array | No | Array of *all* user IDs who should have access to this board (only applicable when `all_access` is `false`) |

__Request:__

```json
{
  "board": {
    "name": "Updated board name",
    "auto_postpone_period": 14,
    "public_description": "This is a **public** description of the board.",
    "all_access": false,
    "user_ids": [
      "03f5v9zppzlksuj4mxba2nbzn",
      "03f5v9zjw7pz8717a4no1h8a7"
    ]
  }
}
```

__Response:__

Returns `204 No Content` on success.

### `DELETE /:account_slug/boards/:board_id`

Deletes a Board. Only board administrators can delete a board.

__Response:__

Returns `204 No Content` on success.

## Cards

Cards are tasks or items of work on a board. They can be organized into columns, tagged, assigned to users, and have comments.

### `GET /:account_slug/cards`

Returns a paginated list of cards you have access to. Results can be filtered using query parameters.

__Query Parameters:__

| Parameter | Description |
|-----------|-------------|
| `board_ids[]` | Filter by board ID(s) |
| `tag_ids[]` | Filter by tag ID(s) |
| `assignee_ids[]` | Filter by assignee user ID(s) |
| `creator_ids[]` | Filter by card creator ID(s) |
| `closer_ids[]` | Filter by user ID(s) who closed the cards |
| `card_ids[]` | Filter to specific card ID(s) |
| `indexed_by` | Filter by: `all` (default), `closed`, `not_now`, `stalled`, `postponing_soon`, `golden` |
| `sorted_by` | Sort order: `latest` (default), `newest`, `oldest` |
| `assignment_status` | Filter by assignment status: `unassigned` |
| `creation` | Filter by creation date: `today`, `yesterday`, `thisweek`, `lastweek`, `thismonth`, `lastmonth`, `thisyear`, `lastyear` |
| `closure` | Filter by closure date: `today`, `yesterday`, `thisweek`, `lastweek`, `thismonth`, `lastmonth`, `thisyear`, `lastyear` |
| `terms[]` | Search terms to filter cards |

__Response:__

```json
[
  {
    "id": "03f5vaeq985jlvwv3arl4srq2",
    "number": 1,
    "title": "First!",
    "status": "published",
    "description": "Hello, World!",
    "description_html": "<div class=\"action-text-content\"><p>Hello, World!</p></div>",
    "image_url": null,
    "tags": ["programming"],
    "golden": false,
    "last_active_at": "2025-12-05T19:38:48.553Z",
    "created_at": "2025-12-05T19:38:48.540Z",
    "url": "http://fizzy.localhost:3006/897362094/cards/4",
    "board": {
      "id": "03f5v9zkft4hj9qq0lsn9ohcm",
      "name": "Fizzy",
      "all_access": true,
      "created_at": "2025-12-05T19:36:35.534Z",
      "url": "http://fizzy.localhost:3006/897362094/boards/03f5v9zkft4hj9qq0lsn9ohcm",
      "creator": {
        "id": "03f5v9zjw7pz8717a4no1h8a7",
        "name": "David Heinemeier Hansson",
        "role": "owner",
        "active": true,
        "email_address": "david@example.com",
        "created_at": "2025-12-05T19:36:35.401Z",
        "url": "http://fizzy.localhost:3006/897362094/users/03f5v9zjw7pz8717a4no1h8a7"
      }
    },
    "creator": {
      "id": "03f5v9zjw7pz8717a4no1h8a7",
      "name": "David Heinemeier Hansson",
      "role": "owner",
      "active": true,
      "email_address": "david@example.com",
      "created_at": "2025-12-05T19:36:35.401Z",
      "url": "http://fizzy.localhost:3006/897362094/users/03f5v9zjw7pz8717a4no1h8a7"
    },
    "comments_url": "http://fizzy.localhost:3006/897362094/cards/4/comments",
    "reactions_url": "http://fizzy.localhost:3006/897362094/cards/4/reactions"
  },
]
```

### `GET /:account_slug/cards/:card_number`

Returns a specific card by its number.

__Response:__

```json
{
  "id": "03f5vaeq985jlvwv3arl4srq2",
  "number": 1,
  "title": "First!",
  "status": "published",
  "description": "Hello, World!",
  "description_html": "<div class=\"action-text-content\"><p>Hello, World!</p></div>",
  "image_url": null,
  "tags": ["programming"],
  "closed": false,
  "golden": false,
  "last_active_at": "2025-12-05T19:38:48.553Z",
  "created_at": "2025-12-05T19:38:48.540Z",
  "url": "http://fizzy.localhost:3006/897362094/cards/4",
  "board": {
    "id": "03f5v9zkft4hj9qq0lsn9ohcm",
    "name": "Fizzy",
    "all_access": true,
    "created_at": "2025-12-05T19:36:35.534Z",
    "url": "http://fizzy.localhost:3006/897362094/boards/03f5v9zkft4hj9qq0lsn9ohcm",
    "creator": {
      "id": "03f5v9zjw7pz8717a4no1h8a7",
      "name": "David Heinemeier Hansson",
      "role": "owner",
      "active": true,
      "email_address": "david@example.com",
      "created_at": "2025-12-05T19:36:35.401Z",
      "url": "http://fizzy.localhost:3006/897362094/users/03f5v9zjw7pz8717a4no1h8a7"
    }
  },
  "column": {
    "id": "03f5v9zkft4hj9qq0lsn9ohcn",
    "name": "In Progress",
    "color": {
      "name": "Lime",
      "value": "var(--color-card-4)"
    },
    "created_at": "2025-12-05T19:36:35.534Z"
  },
  "creator": {
    "id": "03f5v9zjw7pz8717a4no1h8a7",
    "name": "David Heinemeier Hansson",
    "role": "owner",
    "active": true,
    "email_address": "david@example.com",
    "created_at": "2025-12-05T19:36:35.401Z",
    "url": "http://fizzy.localhost:3006/897362094/users/03f5v9zjw7pz8717a4no1h8a7"
  },
  "comments_url": "http://fizzy.localhost:3006/897362094/cards/4/comments",
  "reactions_url": "http://fizzy.localhost:3006/897362094/cards/4/reactions",
  "steps": [
    {
      "id": "03f8huu0sog76g3s975963b5e",
      "content": "This is the first step",
      "completed": false
    },
    {
      "id": "03f8huu0sog76g3s975969734",
      "content": "This is the second step",
      "completed": false
    }
  ]
}
```

> **Note:** The `closed` field indicates whether the card is in the "Done" state. The `column` field is only present when the card has been triaged into a column; cards in "Maybe?", "Not Now" or "Done" will not have this field.

### `POST /:account_slug/boards/:board_id/cards`

Creates a new card in a board.

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `title` | string | Yes | The title of the card |
| `description` | string | No | Rich text description of the card |
| `status` | string | No | Initial status: `published` (default), `drafted` |
| `image` | file | No | Header image for the card |
| `tag_ids` | array | No | Array of tag IDs to apply to the card |
| `created_at` | datetime | No | Override creation timestamp (ISO 8601 format) |
| `last_active_at` | datetime | No | Override last activity timestamp (ISO 8601 format) |

__Request:__

```json
{
  "card": {
    "title": "Add dark mode support",
    "description": "We need to add dark mode to the app"
  }
}
```

__Response:__

Returns `201 Created` with a `Location` header pointing to the new card.

### `PUT /:account_slug/cards/:card_number`

Updates a card.

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `title` | string | No | The title of the card |
| `description` | string | No | Rich text description of the card |
| `status` | string | No | Card status: `drafted`, `published` |
| `image` | file | No | Header image for the card |
| `tag_ids` | array | No | Array of tag IDs to apply to the card |
| `last_active_at` | datetime | No | Override last activity timestamp (ISO 8601 format) |

__Request:__

```json
{
  "card": {
    "title": "Add dark mode support (Updated)"
  }
}
```

__Response:__

Returns the updated card.

### `DELETE /:account_slug/cards/:card_number`

Deletes a card. Only the card creator or board administrators can delete cards.

__Response:__

Returns `204 No Content` on success.

### `DELETE /:account_slug/cards/:card_number/image`

Removes the header image from a card.

__Response:__

Returns `204 No Content` on success.

### `POST /:account_slug/cards/:card_number/closure`

Closes a card.

__Response:__

Returns `204 No Content` on success.

### `DELETE /:account_slug/cards/:card_number/closure`

Reopens a closed card.

__Response:__

Returns `204 No Content` on success.

### `POST /:account_slug/cards/:card_number/not_now`

Moves a card to "Not Now" status.

__Response:__

Returns `204 No Content` on success.

### `POST /:account_slug/cards/:card_number/triage`

Moves a card from triage into a column.

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `column_id` | string | Yes | The ID of the column to move the card into |

__Response:__

Returns `204 No Content` on success.

### `DELETE /:account_slug/cards/:card_number/triage`

Sends a card back to triage.

__Response:__

Returns `204 No Content` on success.

### `POST /:account_slug/cards/:card_number/taggings`

Toggles a tag on or off for a card. If the tag doesn't exist, it will be created.

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `tag_title` | string | Yes | The title of the tag (leading `#` is stripped) |

__Response:__

Returns `204 No Content` on success.

### `POST /:account_slug/cards/:card_number/assignments`

Toggles assignment of a user to/from a card.

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `assignee_id` | string | Yes | The ID of the user to assign/unassign |

__Response:__

Returns `204 No Content` on success.

### `POST /:account_slug/cards/:card_number/watch`

Subscribes the current user to notifications for this card.

__Response:__

Returns `204 No Content` on success.

### `DELETE /:account_slug/cards/:card_number/watch`

Unsubscribes the current user from notifications for this card.

__Response:__

Returns `204 No Content` on success.

### `POST /:account_slug/cards/:card_number/goldness`

Marks a card as golden.

__Response:__

Returns `204 No Content` on success.

### `DELETE /:account_slug/cards/:card_number/goldness`

Removes golden status from a card.

__Response:__

Returns `204 No Content` on success.

## Pins

Pins let users keep quick access to important cards.

### `POST /:account_slug/cards/:card_number/pin`

Pins a card for the current user.

__Response:__

Returns `204 No Content` on success.

### `DELETE /:account_slug/cards/:card_number/pin`

Unpins a card for the current user.

__Response:__

Returns `204 No Content` on success.

### `GET /my/pins`

Returns the current user's pinned cards. This endpoint is not paginated and returns up to 100 cards.

__Response:__

```json
[
  {
    "id": "03f5vaeq985jlvwv3arl4srq2",
    "number": 1,
    "title": "First!",
    "status": "published",
    "description": "Hello, World!",
    "description_html": "<div class=\"action-text-content\"><p>Hello, World!</p></div>",
    "image_url": null,
    "tags": ["programming"],
    "golden": false,
    "last_active_at": "2025-12-05T19:38:48.553Z",
    "created_at": "2025-12-05T19:38:48.540Z",
    "url": "http://fizzy.localhost:3006/897362094/cards/4",
    "board": {
      "id": "03f5v9zkft4hj9qq0lsn9ohcm",
      "name": "Fizzy",
      "all_access": true,
      "created_at": "2025-12-05T19:36:35.534Z",
      "url": "http://fizzy.localhost:3006/897362094/boards/03f5v9zkft4hj9qq0lsn9ohcm",
      "creator": {
        "id": "03f5v9zjw7pz8717a4no1h8a7",
        "name": "David Heinemeier Hansson",
        "role": "owner",
        "active": true,
        "email_address": "david@example.com",
        "created_at": "2025-12-05T19:36:35.401Z",
        "url": "http://fizzy.localhost:3006/897362094/users/03f5v9zjw7pz8717a4no1h8a7",
        "avatar_url": "http://fizzy.localhost:3006/897362094/users/03f5v9zjw7pz8717a4no1h8a7/avatar"
      }
    },
    "creator": {
      "id": "03f5v9zjw7pz8717a4no1h8a7",
      "name": "David Heinemeier Hansson",
      "role": "owner",
      "active": true,
      "email_address": "david@example.com",
      "created_at": "2025-12-05T19:36:35.401Z",
      "url": "http://fizzy.localhost:3006/897362094/users/03f5v9zjw7pz8717a4no1h8a7",
      "avatar_url": "http://fizzy.localhost:3006/897362094/users/03f5v9zjw7pz8717a4no1h8a7/avatar"
    },
    "comments_url": "http://fizzy.localhost:3006/897362094/cards/4/comments"
  }
]
```

## Comments

Comments are attached to cards and support rich text.

### `GET /:account_slug/cards/:card_number/comments`

Returns a paginated list of comments on a card, sorted chronologically (oldest first).

__Response:__

```json
[
  {
    "id": "03f5v9zo9qlcwwpyc0ascnikz",
    "created_at": "2025-12-05T19:36:35.534Z",
    "updated_at": "2025-12-05T19:36:35.534Z",
    "body": {
      "plain_text": "This looks great!",
      "html": "<div class=\"action-text-content\">This looks great!</div>"
    },
    "creator": {
      "id": "03f5v9zjw7pz8717a4no1h8a7",
      "name": "David Heinemeier Hansson",
      "role": "owner",
      "active": true,
      "email_address": "david@example.com",
      "created_at": "2025-12-05T19:36:35.401Z",
      "url": "http://fizzy.localhost:3006/897362094/users/03f5v9zjw7pz8717a4no1h8a7"
    },
    "card": {
      "id": "03f5v9zo9qlcwwpyc0ascnikz",
      "url": "http://fizzy.localhost:3006/897362094/cards/03f5v9zo9qlcwwpyc0ascnikz"
    },
    "reactions_url": "http://fizzy.localhost:3006/897362094/cards/3/comments/03f5v9zo9qlcwwpyc0ascnikz/reactions",
    "url": "http://fizzy.localhost:3006/897362094/cards/3/comments/03f5v9zo9qlcwwpyc0ascnikz"
  }
]
```

### `GET /:account_slug/cards/:card_number/comments/:comment_id`

Returns a specific comment.

__Response:__

```json
{
  "id": "03f5v9zo9qlcwwpyc0ascnikz",
  "created_at": "2025-12-05T19:36:35.534Z",
  "updated_at": "2025-12-05T19:36:35.534Z",
  "body": {
    "plain_text": "This looks great!",
    "html": "<div class=\"action-text-content\">This looks great!</div>"
  },
  "creator": {
    "id": "03f5v9zjw7pz8717a4no1h8a7",
    "name": "David Heinemeier Hansson",
    "role": "owner",
    "active": true,
    "email_address": "david@example.com",
    "created_at": "2025-12-05T19:36:35.401Z",
    "url": "http://fizzy.localhost:3006/897362094/users/03f5v9zjw7pz8717a4no1h8a7"
  },
  "card": {
    "id": "03f5v9zo9qlcwwpyc0ascnikz",
    "url": "http://fizzy.localhost:3006/897362094/cards/03f5v9zo9qlcwwpyc0ascnikz"
  },
  "reactions_url": "http://fizzy.localhost:3006/897362094/cards/3/comments/03f5v9zo9qlcwwpyc0ascnikz/reactions",
  "url": "http://fizzy.localhost:3006/897362094/cards/3/comments/03f5v9zo9qlcwwpyc0ascnikz"
}
```

### `POST /:account_slug/cards/:card_number/comments`

Creates a new comment on a card.

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `body` | string | Yes | The comment body (supports rich text) |
| `created_at` | datetime | No | Override creation timestamp (ISO 8601 format) |

__Request:__

```json
{
  "comment": {
    "body": "This looks great!"
  }
}
```

__Response:__

Returns `201 Created` with a `Location` header pointing to the new comment.

### `PUT /:account_slug/cards/:card_number/comments/:comment_id`

Updates a comment. Only the comment creator can update their comments.

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `body` | string | Yes | The updated comment body |

__Request:__

```json
{
  "comment": {
    "body": "This looks even better now!"
  }
}
```

__Response:__

Returns the updated comment.

### `DELETE /:account_slug/cards/:card_number/comments/:comment_id`

Deletes a comment. Only the comment creator can delete their comments.

__Response:__

Returns `204 No Content` on success.

## Card Reactions (Boosts)

Card reactions (also called "boosts") let users add short responses directly to cards. These are limited to 16 characters.

### `GET /:account_slug/cards/:card_number/reactions`

Returns a list of reactions on a card.

__Response:__

```json
[
  {
    "id": "03f5v9zo9qlcwwpyc0ascnikz",
    "content": "",
    "reacter": {
      "id": "03f5v9zjw7pz8717a4no1h8a7",
      "name": "David Heinemeier Hansson",
      "role": "owner",
      "active": true,
      "email_address": "david@example.com",
      "created_at": "2025-12-05T19:36:35.401Z",
      "url": "http://fizzy.localhost:3006/897362094/users/03f5v9zjw7pz8717a4no1h8a7"
    },
    "url": "http://fizzy.localhost:3006/897362094/cards/3/reactions/03f5v9zo9qlcwwpyc0ascnikz"
  }
]
```

### `POST /:account_slug/cards/:card_number/reactions`

Adds a reaction (boost) to a card.

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `content` | string | Yes | The reaction text (max 16 characters) |

__Request:__

```json
{
  "reaction": {
    "content": "Great "
  }
}
```

__Response:__

Returns `201 Created` on success.

### `DELETE /:account_slug/cards/:card_number/reactions/:reaction_id`

Removes your reaction from a card. Only the reaction creator can remove their own reactions.

__Response:__

Returns `204 No Content` on success.

## Comment Reactions

Reactions are short (16-character max) responses to comments.

### `GET /:account_slug/cards/:card_number/comments/:comment_id/reactions`

Returns a list of reactions on a comment.

__Response:__

```json
[
  {
    "id": "03f5v9zo9qlcwwpyc0ascnikz",
    "content": "",
    "reacter": {
      "id": "03f5v9zjw7pz8717a4no1h8a7",
      "name": "David Heinemeier Hansson",
      "role": "owner",
      "active": true,
      "email_address": "david@example.com",
      "created_at": "2025-12-05T19:36:35.401Z",
      "url": "http://fizzy.localhost:3006/897362094/users/03f5v9zjw7pz8717a4no1h8a7"
    },
    "url": "http://fizzy.localhost:3006/897362094/cards/3/comments/03f5v9zo9qlcwwpyc0ascnikz/reactions/03f5v9zo9qlcwwpyc0ascnikz"
  }
]
```

### `POST /:account_slug/cards/:card_number/comments/:comment_id/reactions`

Adds a reaction to a comment.

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `content` | string | Yes | The reaction text |

__Request:__

```json
{
  "reaction": {
    "content": "Great "
  }
}
```

__Response:__

Returns `201 Created` on success.

### `DELETE /:account_slug/cards/:card_number/comments/:comment_id/reactions/:reaction_id`

Removes your reaction from a comment.

__Response:__

Returns `204 No Content` on success.

## Steps

Steps are to-do items on a card.

### `GET /:account_slug/cards/:card_number/steps/:step_id`

Returns a specific step.

__Response:__

```json
{
  "id": "03f5v9zo9qlcwwpyc0ascnikz",
  "content": "Write tests",
  "completed": false
}
```

### `POST /:account_slug/cards/:card_number/steps`

Creates a new step on a card.

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `content` | string | Yes | The step text |
| `completed` | boolean | No | Whether the step is completed (default: `false`) |

__Request:__

```json
{
  "step": {
    "content": "Write tests"
  }
}
```

__Response:__

Returns `201 Created` with a `Location` header pointing to the new step.

### `PUT /:account_slug/cards/:card_number/steps/:step_id`

Updates a step.

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `content` | string | No | The step text |
| `completed` | boolean | No | Whether the step is completed |

__Request:__

```json
{
  "step": {
    "completed": true
  }
}
```

__Response:__

Returns the updated step.

### `DELETE /:account_slug/cards/:card_number/steps/:step_id`

Deletes a step.

__Response:__

Returns `204 No Content` on success.

## Tags

Tags are labels that can be applied to cards for organization and filtering.

### `GET /:account_slug/tags`

Returns a list of all tags in the account, sorted alphabetically.

__Response:__

```json
[
  {
    "id": "03f5v9zo9qlcwwpyc0ascnikz",
    "title": "bug",
    "created_at": "2025-12-05T19:36:35.534Z",
    "url": "http://fizzy.localhost:3006/897362094/cards?tag_ids[]=03f5v9zo9qlcwwpyc0ascnikz"
  },
  {
    "id": "03f5v9zo9qlcwwpyc0ascnilz",
    "title": "feature",
    "created_at": "2025-12-05T19:36:35.534Z",
    "url": "http://fizzy.localhost:3006/897362094/cards?tag_ids[]=03f5v9zo9qlcwwpyc0ascnilz"
  }
]
```

## Columns

Columns represent stages in a workflow on a board. Cards move through columns as they progress.

### `GET /:account_slug/boards/:board_id/columns`

Returns a list of columns on a board, sorted by position.

__Response:__

```json
[
  {
    "id": "03f5v9zkft4hj9qq0lsn9ohcm",
    "name": "Recording",
    "color": "var(--color-card-default)",
    "created_at": "2025-12-05T19:36:35.534Z"
  },
  {
    "id": "03f5v9zkft4hj9qq0lsn9ohcn",
    "name": "Published",
    "color": "var(--color-card-4)",
    "created_at": "2025-12-05T19:36:35.534Z"
  }
]
```

### `GET /:account_slug/boards/:board_id/columns/:column_id`

Returns the specified column.

__Response:__

```json
{
  "id": "03f5v9zkft4hj9qq0lsn9ohcm",
  "name": "In Progress",
  "color": "var(--color-card-default)",
  "created_at": "2025-12-05T19:36:35.534Z"
}
```

### `POST /:account_slug/boards/:board_id/columns`

Creates a new column on the board.

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `name` | string | Yes | The name of the column |
| `color` | string | No | The column color. One of: `var(--color-card-default)` (Blue), `var(--color-card-1)` (Gray), `var(--color-card-2)` (Tan), `var(--color-card-3)` (Yellow), `var(--color-card-4)` (Lime), `var(--color-card-5)` (Aqua), `var(--color-card-6)` (Violet), `var(--color-card-7)` (Purple), `var(--color-card-8)` (Pink) |

__Request:__

```json
{
  "column": {
    "name": "In Progress",
    "color": "var(--color-card-4)"
  }
}
```

__Response:__

Returns `201 Created` with a `Location` header pointing to the new column.

### `PUT /:account_slug/boards/:board_id/columns/:column_id`

Updates a column.

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `name` | string | No | The name of the column |
| `color` | string | No | The column color |

__Request:__

```json
{
  "column": {
    "name": "Done"
  }
}
```

__Response:__

Returns `204 No Content` on success.

### `DELETE /:account_slug/boards/:board_id/columns/:column_id`

Deletes a column.

__Response:__

Returns `204 No Content` on success.

## Users

Users represent people who have access to an account.

### `GET /:account_slug/users`

Returns a list of active users in the account.

__Response:__

```json
[
  {
    "id": "03f5v9zjw7pz8717a4no1h8a7",
    "name": "David Heinemeier Hansson",
    "role": "owner",
    "active": true,
    "email_address": "david@example.com",
    "created_at": "2025-12-05T19:36:35.401Z",
    "url": "http://fizzy.localhost:3006/897362094/users/03f5v9zjw7pz8717a4no1h8a7"
  },
  {
    "id": "03f5v9zjysoy0fqs9yg0ei3hq",
    "name": "Jason Fried",
    "role": "member",
    "active": true,
    "email_address": "jason@example.com",
    "created_at": "2025-12-05T19:36:35.419Z",
    "url": "http://fizzy.localhost:3006/897362094/users/03f5v9zjysoy0fqs9yg0ei3hq"
  },
  {
    "id": "03f5v9zk1dtqduod5bkhv3k8m",
    "name": "Jason Zimdars",
    "role": "member",
    "active": true,
    "email_address": "jz@example.com",
    "created_at": "2025-12-05T19:36:35.435Z",
    "url": "http://fizzy.localhost:3006/897362094/users/03f5v9zk1dtqduod5bkhv3k8m"
  },
  {
    "id": "03f5v9zk3nw9ja92e7s4h2wbe",
    "name": "Kevin Mcconnell",
    "role": "member",
    "active": true,
    "email_address": "kevin@example.com",
    "created_at": "2025-12-05T19:36:35.451Z",
    "url": "http://fizzy.localhost:3006/897362094/users/03f5v9zk3nw9ja92e7s4h2wbe"
  }
]
```

### `GET /:account_slug/users/:user_id`

Returns the specified user.

__Response:__

```json
{
  "id": "03f5v9zjw7pz8717a4no1h8a7",
  "name": "David Heinemeier Hansson",
  "role": "owner",
  "active": true,
  "email_address": "david@example.com",
  "created_at": "2025-12-05T19:36:35.401Z",
  "url": "http://fizzy.localhost:3006/897362094/users/03f5v9zjw7pz8717a4no1h8a7"
}
```

### `PUT /:account_slug/users/:user_id`

Updates a user. You can only update users you have permission to change.

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `name` | string | No | The user's display name |
| `avatar` | file | No | The user's avatar image |

__Request:__

```json
{
  "user": {
    "name": "David H. Hansson"
  }
}
```

__Response:__

Returns `204 No Content` on success.

### `DELETE /:account_slug/users/:user_id`

Deactivates a user. You can only deactivate users you have permission to change.

__Response:__

Returns `204 No Content` on success.

## Notifications

Notifications inform users about events that happened in the account, such as comments, assignments, and card updates.

### `GET /:account_slug/notifications`

Returns a list of notifications for the current user. Unread notifications are returned first, followed by read notifications.

__Response:__

```json
[
  {
    "id": "03f5va03bpuvkcjemcxl73ho2",
    "read": false,
    "read_at": null,
    "created_at": "2025-11-19T04:03:58.000Z",
    "title": "Plain text mentions",
    "body": "Assigned to self",
    "creator": {
      "id": "03f5v9zjw7pz8717a4no1h8a7",
      "name": "David Heinemeier Hansson",
      "role": "owner",
      "active": true,
      "email_address": "david@example.com",
      "created_at": "2025-12-05T19:36:35.401Z",
      "url": "http://fizzy.localhost:3006/897362094/users/03f5v9zjw7pz8717a4no1h8a7"
    },
    "card": {
      "id": "03f5v9zo9qlcwwpyc0ascnikz",
      "title": "Plain text mentions",
      "status": "published",
      "url": "http://fizzy.localhost:3006/897362094/cards/3"
    },
    "url": "http://fizzy.localhost:3006/897362094/notifications/03f5va03bpuvkcjemcxl73ho2"
  }
]
```

### `POST /:account_slug/notifications/:notification_id/reading`

Marks a notification as read.

__Response:__

Returns `204 No Content` on success.

### `DELETE /:account_slug/notifications/:notification_id/reading`

Marks a notification as unread.

__Response:__

Returns `204 No Content` on success.

### `POST /:account_slug/notifications/bulk_reading`

Marks all unread notifications as read.

__Response:__

Returns `204 No Content` on success.

================
File: docs/development.md
================
## Development

### Setting up

First, get everything installed and configured with:

```sh
bin/setup
bin/setup --reset # Reset the database and seed it
```

And then run the development server:

```sh
bin/dev
```

You'll be able to access the app in development at http://fizzy.localhost:3006.

To login, enter `david@example.com` and grab the verification code from the browser console to sign in.

### Web Push Notifications

Fizzy uses VAPID (Voluntary Application Server Identification) keys to send browser push notifications. For notifications to work in development you'll need to generate a key pair and set these environment variables:

- `VAPID_PRIVATE_KEY`
- `VAPID_PUBLIC_KEY`

Generate them with the `web-push` gem:

```ruby
vapid_key = WebPush.generate_key

puts "VAPID_PRIVATE_KEY=#{vapid_key.private_key}"
puts "VAPID_PUBLIC_KEY=#{vapid_key.public_key}"
```

### Running tests

For fast feedback loops, unit tests can be run with:

```sh
bin/rails test
```

The full continuous integration tests can be run with:

```sh
bin/ci
```

### Database configuration

Fizzy works with SQLite by default and supports MySQL too. You can switch adapters with the `DATABASE_ADAPTER` environment variable. For example, to develop locally against MySQL:

```sh
DATABASE_ADAPTER=mysql bin/setup --reset
DATABASE_ADAPTER=mysql bin/ci
```

The remote CI pipeline will run tests against both SQLite and MySQL.

### Outbound Emails

You can view email previews at http://fizzy.localhost:3006/rails/mailers.

You can enable or disable [`letter_opener`](https://github.com/ryanb/letter_opener) to open sent emails automatically with:

```sh
bin/rails dev:email
```

Under the hood, this will create or remove `tmp/email-dev.txt`.

## SaaS gem

37signals bundles Fizzy with [`fizzy-saas`](https://github.com/basecamp/fizzy/tree/main/saas), a companion gem that links Fizzy with our billing system and contains our production setup.

This gem depends on some private git repositories and it is not meant to be used by third parties. But we hope it can serve as inspiration for anyone wanting to run fizzy on their own infrastructure.

================
File: docs/docker-deployment.md
================
## Deploying with Docker

We provide pre-built Docker images that can be used to run Fizzy on your own server.

If you don't need to change the source code, and just want the out-of-the-box Fizzy experience, this can be a great way to get started.

You'll find the latest version of Fizzy's Docker image at `ghcr.io/basecamp/fizzy:main`.
To run it you'll need three things: a machine that runs Docker; a mounted volume (so that your database is stored somewhere that is kept around between restarts); and some environment variables for configuration.

### Mounting a storage volume

The standard Fizzy setup keeps all of its storage inside the path `/rails/storage`.
By default Docker containers don't persist storage between runs, so you'll want to mount a persistent volume into that location.

The simplest way to do this is with the `--volume` flag with `docker run`. For example:

```sh
docker run --volume fizzy:/rails/storage ghcr.io/basecamp/fizzy:main
```

That will create a named volume (called `fizzy`) and mount it into the correct path.
Docker will manage where that volume is actually stored on your server.

You can also specify the data location yourself, mount a network drive, and more.
Check the Docker documentation to find out more about what's available.

### Configuring with environment variables

To configure your Fizzy installation, you can use environment variables.
Fizzy has several of them.
Many of these are optional, but at a minimum you'll want to configure your secret key, your SSL domain, and your SMTP email settings.

#### Secret Key Base

Various features inside Fizzy rely on cryptography to work (such as secure links).
To set this up, you need to provide a secret value that will be used as the basis of those secrets.
This value can be anything, but it should be unguessable, and specific to your instance.

You can use any long random string for this, or you can have the Fizzy codebase generate one for you by running:

```sh
bin/rails secret
```

Once you have one, set it in the `SECRET_KEY_BASE` environment variable:

```sh
docker run --env SECRET_KEY_BASE=abcdefabcdef ...
```

#### SSL

If you want the Fizzy container to handle its own SSL automatically, you just need to specify the domain name that you're running it on.
You can do that with the `TLS_DOMAIN` environment variable.
Note that if you're using SSL, you'll want to allow traffic on ports 80 and 443.
So if you were running on `fizzy.example.com` you could enable SSL like this:

```sh
docker run --publish 80:80 --publish 443:443 --env TLS_DOMAIN=fizzy.example.com ...
```

If you are terminating SSL in some other proxy in front of Fizzy, then you don't need to set `TLS_DOMAIN`, and can just publish port 80:
```sh
docker run --publish 80:80 ...
```

If you aren't using SSL at all (for example, if you want to run it locally on your laptop) then you should specify `DISABLE_SSL=true` instead:

```sh
docker run --publish 80:80 --env DISABLE_SSL=true ...
```

#### SMTP Email

Fizzy needs to be able to send email for its sign up/sign in flow, and for its regular summary emails.
The easiest way to set this up is to use a 3rd-party email provider (such as Postmark, Sendgrid, and so on).
You can then plug all your SMTP settings from that provider into Fizzy via the following environment variables:

- `MAILER_FROM_ADDRESS` - the "from" address that Fizzy should use to send email
- `SMTP_ADDRESS` - the address of the SMTP server you'll send through
- `SMTP_PORT` - the port number (defaults to 465 when `SMTP_TLS` is set, 587 otherwise)
- `SMTP_USERNAME`/`SMTP_PASSWORD` - the credentials for logging in to the SMTP server

Less commonly, you might also need to set some of the following:

- `SMTP_TLS` - set to `true` only for servers requiring implicit TLS (SMTPS on port 465); STARTTLS is used automatically by default so most servers don't need this
- `SMTP_DOMAIN` - the domain name advertised to the server when connecting
- `SMTP_AUTHENTICATION` - if you need an authentication method other than the default `plain`
- `SMTP_SSL_VERIFY_MODE` - set to `none` to skip certificate verification (for self-signed certs)

You can find out more about all these settings in the [Rails Action Mailer documentation](https://guides.rubyonrails.org/action_mailer_basics.html#action-mailer-configuration).

#### Base URL

Fizzy needs to know the public URL of your instance so it can generate correct links in certain situations (like when sending emails).
Set `BASE_URL` to the full URL where your Fizzy instance is accessible:

```sh
docker run --env BASE_URL=https://fizzy.example.com ...
```

#### VAPID keys

Fizzy can also send Web Push notifications.
To do this it needs a VAPID key pair.

You can create your own keys by starting a development console with:

```sh
bin/rails c
```

And then run the following to create the keypair:

```ruby
vapid_key = WebPush.generate_key

puts "VAPID_PRIVATE_KEY=#{vapid_key.private_key}"
puts "VAPID_PUBLIC_KEY=#{vapid_key.public_key}"
```

Set those in the `VAPID_PRIVATE_KEY` and `VAPID_PUBLIC_KEY` environment variables.

#### S3 storage (optional)

If you'd prefer that uploaded files were stored in an S3 bucket rather than in your mounted volume, you can set that up.

First set `ACTIVE_STORAGE_SERVICE` to `s3`.
Then set the following as appropriate for your S3 bucket:

- `S3_BUCKET`
- `S3_REGION`
- `S3_ACCESS_KEY_ID`
- `S3_SECRET_ACCESS_KEY`

If you're using a provider other than AWS, you will also need some of the following:

- `S3_ENDPOINT`
- `S3_FORCE_PATH_STYLE`
- `S3_REQUEST_CHECKSUM_CALCULATION`
- `S3_RESPONSE_CHECKSUM_VALIDATION`

#### Multi-tenant mode

By default, when you run the Fizzy Docker image you'll be limited to creating a single account (although that account can have as many users as you like).
This is for convenience: typically when you self-host you'll be running a single account, so in this mode new account signups are automatically disabled as soon as you've created your first account.

If you do want to allow multiple accounts to be created in your instance, set `MULTI_TENANT=true`

## Example

Here's an example of a `docker-compose.yml` that you could use to run Fizzy via `docker compose up`

```yaml
services:
  web:
    image: ghcr.io/basecamp/fizzy:main
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    environment:
      - SECRET_KEY_BASE=abcdefabcdef
      - TLS_DOMAIN=fizzy.example.com
      - BASE_URL=https://fizzy.example.com
      - MAILER_FROM_ADDRESS=fizzy@example.com
      - SMTP_ADDRESS=mail.example.com
      - SMTP_USERNAME=user
      - SMTP_PASSWORD=pass
      - VAPID_PRIVATE_KEY=myvapidprivatekey
      - VAPID_PUBLIC_KEY=myvapidpublickey
    volumes:
      - fizzy:/rails/storage

volumes:
  fizzy:
```

================
File: docs/kamal-deployment.md
================
## Deploying Fizzy with Kamal

If you'd like to run Fizzy on your own server while having the freedom to easily make changes to its code, we recommend deploying it with [Kamal](https://kamal-deploy.org/).
Kamal makes it easy to set up a bare server, copy the application to it, and manage the configuration settings that it uses.

(Kamal is also what we use to deploy Fizzy at 37signals. If you're curious about what our deployment configuration looks like, you can find it inside [`fizzy-saas`](https://github.com/basecamp/fizzy-saas).)

This repo contains a starter deployment file that you can modify for your own specific use. That file lives at [config/deploy.yml](config/deploy.yml), which is the default place where Kamal will look for it.

The steps to configure your very own Fizzy are:

1. Fork the repo
2. Initialize Kamal by running `kamal init`. This command generates the `.kamal` directory along with the required configuration files, including `.kamal/secrets`.
3. Edit few things in config/deploy.yml and .kamal/secrets
4. Run `kamal setup` to do your first deploy.

We'll go through each of these in turn.

### Fork the repo

To make it easy to customise Fizzy's settings for your own instance, you should start by creating your own GitHub fork of the repo.
That allows you to commit your changes, and track them over time.
You can always re-sync your fork to pick up new changes from the main repo over time.

Once you've got your fork ready, run `bin/setup` from within it, to make sure everything is installed.

### Editing the configuration

The config/deploy.yml has been mostly set up for you, but you'll need to fill out some sections that are specific to your instance.
To get started, the parts you need to change are all in the "About your deployment" section.
We've added comments to that file to highlight what each setting needs to be, but the main ones are:

- `servers/web`: Enter the hostname of the server you're deploying to here. This should be an address that you can access via `ssh`.
- `ssh/user`: If you access your server a `root` you can leave this alone; if you use a different user, set it here.
- `proxy/ssl` and `proxy/host`: Kamal can set up SSL certificates for you automatically. To enable that, set the hostname again as `host`. If you don't want SSL for some reason, you can set `ssl: false` to turn it off.
- `env/clear/BASE_URL`: The public URL of your Fizzy instance (e.g., `https://fizzy.example.com`). Used when generating links.
- `env/clear/MAILER_FROM_ADDRESS`: This is the email address that Fizzy will send emails from. It should usually be an address from the same domain where you're running Fizzy.
- `env/clear/SMTP_ADDRESS`: The address of an SMTP server that you can send email through. You can use a 3rd-party service for this, like Sendgrid or Postmark, in which case their documentation will tell you what to use for this.
- `env/clear/MULTI_TENANT`: Set to `true` if you want to allow multiple accounts to sign up on your server (by default, Fizzy will allow you to create a single account).

Fizzy also requires a few environment variables to be set up, some of which contain secrets.
The simplest way to do this is to put them in a file called `.kamal/secrets`.
Because this file will contain secret credentials, it's important that you DON'T CHECK THIS FILE INTO YOUR REPO! You can add the filename to `.gitignore` to ensure you don't commit this file accidentally.

If you use a password manager like 1Password, you can also opt to keep your secrets there instead.
Refer to the [Kamal documentation](https://kamal-deploy.org/docs/configuration/environment-variables/#secrets) for more information about how to do that.

To store your secrets, create the file `.kamal/secrets` and enter something like the following:

```ini
SECRET_KEY_BASE=12345
VAPID_PUBLIC_KEY=something
VAPID_PRIVATE_KEY=somethingelse
SMTP_USERNAME=email-provider-username
SMTP_PASSWORD=email-provider-password
```

The values you enter here will be specific to you, and you can get or create them as follows:

- `SECRET_KEY_BASE` should be a long, random secret. You can run `bin/rails secret` to create a suitable value for this.
- `SMTP_USERNAME` & `SMTP_PASSWORD` should be valid credentials for your SMTP server. If you're using a 3rd-party service here, consult their documentation for what to use.
- `VAPID_PUBLIC_KEY` & `VAPID_PRIVATE_KEY` are a pair of credentials that are used for sending notifications. You can create your own keys by starting a development console with:

  ```sh
  bin/rails c
  ```

  And then run the following to create a new pair of keys:

  ```ruby
  vapid_key = WebPush.generate_key

  puts "VAPID_PRIVATE_KEY=#{vapid_key.private_key}"
  puts "VAPID_PUBLIC_KEY=#{vapid_key.public_key}"
  ```

Once you've made all those changes, commit them to your fork so they're saved.

### Deploy Fizzy!

You can now do your first deploy by running:

```sh
bin/kamal setup
```

This will set up Docker (if needed), build your Fizzy app container, configure it, and start it running.

After the first deploy is done, any subsequent steps won't need to do that initial setup. So for future deploys you can just run:

```sh
bin/kamal deploy
```

### Configuring file storage (Active Storage)

Production uses the local disk service by default. To use any other service defined in `config/storage.yml`, set `ACTIVE_STORAGE_SERVICE`.

To use the included `s3` service, set:

- `ACTIVE_STORAGE_SERVICE=s3`
- `S3_ACCESS_KEY_ID`
- `S3_BUCKET` (defaults to `fizzy-#{Rails.env}-activestorage`)
- `S3_REGION` (defaults to `us-east-1`)
- `S3_SECRET_ACCESS_KEY`

Optional for S3-compatible endpoints:

- `S3_ENDPOINT`
- `S3_FORCE_PATH_STYLE=true`
- `S3_REQUEST_CHECKSUM_CALCULATION` (defaults to `when_supported`)
- `S3_RESPONSE_CHECKSUM_VALIDATION` (defaults to `when_supported`)

================
File: lib/assets/.keep
================


================
File: lib/deployment/database_resolver.rb
================
module Deployment
  class DatabaseResolver < ActiveRecord::Middleware::DatabaseSelector::Resolver
    def self.in_primary_datacenter?
      ENV["PRIMARY_DATACENTER"].present? || Rails.env.local?
    end
    def reading_request?(request)
      # Disables writes (and so primary-DB stickiness) in non-primary datacenters
      super || !DatabaseResolver.in_primary_datacenter?
    end
    private
      def read_from_primary?
        # Only the primary datacenter can read from the primary database, non-primary DCs have local DB replicas
        super && DatabaseResolver.in_primary_datacenter?
      end
  end
end

================
File: lib/rails_ext/action_mailer_mail_delivery_job.rb
================
Rails.application.config.to_prepare do
  ActionMailer::MailDeliveryJob.include SmtpDeliveryErrorHandling
end

================
File: lib/rails_ext/active_record_date_arithmetic.rb
================
# frozen_string_literal: true
# Adds database-agnostic date arithmetic methods to ActiveRecord adapters.
# This allows code to perform date calculations without checking which database adapter is in use.
#
# Usage:
#   connection.date_subtract("created_at", "3600")
#   # MySQL/Trilogy: "DATE_SUB(created_at, INTERVAL 3600 SECOND)"
#   # SQLite: "datetime(created_at, '-' || (3600) || ' seconds')"
# Module for MySQL-based adapters (Trilogy, Mysql2, etc.)
module MysqlDateArithmetic
  # Generates SQL for subtracting seconds from a date/time column in MySQL.
  #
  # @param date_column [String] The date/time column or expression
  # @param seconds_expression [String] SQL expression that evaluates to number of seconds
  # @return [String] MySQL DATE_SUB expression
  #
  # Example:
  #   date_subtract("last_active_at", "COALESCE(auto_postpone_period, 3600)")
  #   # => "DATE_SUB(last_active_at, INTERVAL COALESCE(auto_postpone_period, 3600) SECOND)"
  def date_subtract(date_column, seconds_expression)
    "DATE_SUB(#{date_column}, INTERVAL #{seconds_expression} SECOND)"
  end
end
# Module for SQLite adapter
module SqliteDateArithmetic
  # Generates SQL for subtracting seconds from a date/time column in SQLite.
  #
  # @param date_column [String] The date/time column or expression
  # @param seconds_expression [String] SQL expression that evaluates to number of seconds
  # @return [String] SQLite datetime expression
  #
  # Example:
  #   date_subtract("last_active_at", "COALESCE(auto_postpone_period, 3600)")
  #   # => "datetime(last_active_at, '-' || (COALESCE(auto_postpone_period, 3600)) || ' seconds')"
  def date_subtract(date_column, seconds_expression)
    "datetime(#{date_column}, '-' || (#{seconds_expression}) || ' seconds')"
  end
end
ActiveSupport.on_load(:active_record) do
  # Prepend MySQL date arithmetic to AbstractMysqlAdapter (covers Trilogy, Mysql2, etc.)
  if defined?(ActiveRecord::ConnectionAdapters::AbstractMysqlAdapter)
    ActiveRecord::ConnectionAdapters::AbstractMysqlAdapter.prepend(MysqlDateArithmetic)
  end
  # Prepend SQLite date arithmetic to SQLite3Adapter
  if defined?(ActiveRecord::ConnectionAdapters::SQLite3Adapter)
    ActiveRecord::ConnectionAdapters::SQLite3Adapter.prepend(SqliteDateArithmetic)
  end
end

================
File: lib/rails_ext/active_record_replica_support.rb
================
# frozen_string_literal: true
# Adds a helper method to check if replica database connections are configured
# and automatically configures read/write splitting when replicas are available.
#
# Usage:
#   class ApplicationRecord < ActiveRecord::Base
#     configure_replica_connections
#   end
module ActiveRecordReplicaSupport
  extend ActiveSupport::Concern
  class_methods do
    # Automatically configures connects_to for read/write splitting if a replica
    # database is configured for the current environment. This is a no-op if no
    # replica configuration exists.
    #
    # Example:
    #   class ApplicationRecord < ActiveRecord::Base
    #     configure_replica_connections
    #   end
    def configure_replica_connections
      if replica_configured?
        connects_to database: { writing: :primary, reading: :replica }
      end
    end
    # Returns true if a replica database configuration exists for the current
    # environment. This allows different database adapters to opt in or out of
    # read/write splitting based on their database.yml configuration.
    #
    # Example:
    #   ApplicationRecord.replica_configured? # => true for MySQL, false for SQLite
    def replica_configured?
      configurations.find_db_config("replica").present?
    end
    # Execute block using read replica if available, otherwise use primary.
    #
    # Example:
    #   ApplicationRecord.with_reading_role { User.count }
    def with_reading_role(&block)
      if replica_configured?
        connected_to(role: :reading, &block)
      else
        yield
      end
    end
  end
end
ActiveRecord::Base.include ActiveRecordReplicaSupport

================
File: lib/rails_ext/active_record_uuid_type.rb
================
# Custom UUID attribute type for MySQL binary storage with base36 string representation
module ActiveRecord
  module Type
    class Uuid < Binary
      BASE36_LENGTH = 25 # 36^25 > 2^128
      class << self
        def generate
          uuid = SecureRandom.uuid_v7
          hex = uuid.delete("-")
          hex_to_base36(hex)
        end
        def hex_to_base36(hex)
          hex.to_i(16).to_s(36).rjust(BASE36_LENGTH, "0")
        end
        def base36_to_hex(base36)
          base36.to_s.to_i(36).to_s(16).rjust(32, "0")
        end
      end
      def serialize(value)
        return unless value
        binary = Uuid.base36_to_hex(value).scan(/../).map(&:hex).pack("C*")
        super(binary)
      end
      def deserialize(value)
        return unless value
        hex = value.to_s.unpack1("H*")
        Uuid.hex_to_base36(hex)
      end
      def cast(value)
        value
      end
    end
  end
end
# Register the UUID type for Trilogy (MySQL) and SQLite3 adapters
ActiveRecord::Type.register(:uuid, ActiveRecord::Type::Uuid, adapter: :trilogy)
ActiveRecord::Type.register(:uuid, ActiveRecord::Type::Uuid, adapter: :sqlite3)

================
File: lib/rails_ext/active_storage_analyze_job_suppress_broadcasts.rb
================
# Avoid page refreshes from Active Storage analyzing blobs when these are attached.
#
# A better option would be to disable touching with +touch_attachment_records+ but
# there is currently a bug https://github.com/rails/rails/issues/55144
module ActiveStorageAnalyzeJobSuppressBroadcasts
  def perform(blob)
    Board.suppressing_turbo_broadcasts do
      Card.suppressing_turbo_broadcasts do
        super
      end
    end
  end
end
ActiveSupport.on_load :active_storage_blob do
  ActiveStorage::AnalyzeJob.prepend ActiveStorageAnalyzeJobSuppressBroadcasts
end

================
File: lib/rails_ext/active_storage_authorization.rb
================
ActiveSupport.on_load :active_storage_blob do
  def accessible_to?(user)
    attachments.includes(:record).any? { |attachment| attachment.accessible_to?(user) } || attachments.none?
  end
  def publicly_accessible?
    attachments.includes(:record).any? { |attachment| attachment.publicly_accessible? }
  end
end
ActiveSupport.on_load :active_storage_attachment do
  def accessible_to?(user)
    record.try(:accessible_to?, user)
  end
  def publicly_accessible?
    record.try(:publicly_accessible?)
  end
end
Rails.application.config.to_prepare do
  module ActiveStorage::Authorize
    extend ActiveSupport::Concern
    include Authentication
    included do
      # Ensure require_authentication runs after set_blob.
      skip_before_action :require_authentication
      before_action :require_authentication, :ensure_accessible, unless: :publicly_accessible_blob?
    end
    private
      def publicly_accessible_blob?
        @blob.publicly_accessible?
      end
      def ensure_accessible
        unless @blob.accessible_to?(Current.user)
          head :forbidden
        end
      end
  end
  ActiveStorage::Blobs::RedirectController.include ActiveStorage::Authorize
  ActiveStorage::Blobs::ProxyController.include ActiveStorage::Authorize
  ActiveStorage::Representations::RedirectController.include ActiveStorage::Authorize
  ActiveStorage::Representations::ProxyController.include ActiveStorage::Authorize
end

================
File: lib/rails_ext/active_storage_blob_service_url_for_direct_upload_expiry.rb
================
#
#  see https://github.com/basecamp/haystack/pull/7862
#
module ActiveStorage
  mattr_accessor :service_urls_for_direct_uploads_expire_in, default: 48.hours
end
module ActiveStorageBlobServiceUrlForDirectUploadExpiry
  # Override default expires_in to accommodate long upload URL expiry
  # without having to lengthen download URL expiry.
  #
  # Accounts for Cloudflare only proxying slow client uploads once they're
  # fully buffered, long after the URL expired.
  #
  # 48 hours covers a 10GB upload at 0.5Mbps.
  def service_url_for_direct_upload(expires_in: ActiveStorage.service_urls_for_direct_uploads_expire_in)
    super
  end
end
ActiveSupport.on_load :active_storage_blob do
  prepend ::ActiveStorageBlobServiceUrlForDirectUploadExpiry
end

================
File: lib/rails_ext/active_support_array_conversions.rb
================
module ChoiceSentenceArrayConversion
  def to_choice_sentence
    to_sentence two_words_connector: " or ", last_word_connector: ", or "
  end
end
Array.include ChoiceSentenceArrayConversion

================
File: lib/rails_ext/prepend_order.rb
================
module ActiveRecordRelationPrependOrder
  extend ActiveSupport::Concern
  included do
    def prepend_order(*args)
      new_orders = args.flatten.map { |arg| arg.is_a?(String) ? arg : arg.to_sql }
      spawn.tap do |relation|
        relation.order_values = new_orders + order_values
      end
    end
  end
end
ActiveRecord::Relation.include(ActiveRecordRelationPrependOrder)
ActiveRecord::AssociationRelation.include(ActiveRecordRelationPrependOrder)

================
File: lib/rails_ext/string.rb
================
class String
  def all_emoji?
    self.match?(/\A(\p{Emoji_Presentation}|\p{Extended_Pictographic}|\uFE0F)+\z/u)
  end
end

================
File: lib/tasks/dev.rake
================
namespace :dev do
  desc "Toggle using Letter Opener to preview emails"
  task :email do
    file_path = Rails.root.join("tmp", "email-dev.txt")

    if File.exist?(file_path)
      File.delete(file_path)
      puts "Letter Opener turned off"
    else
      FileUtils.touch(file_path)
      puts "Letter Opener turned on"
    end

    %x(bin/rails restart)
  end
end

================
File: lib/tasks/saas.rake
================
namespace :saas do
  SAAS_FILE_PATH = "tmp/saas.txt"

  desc "Enable SaaS mode"
  task enable: :environment do
    file_path = Rails.root.join(SAAS_FILE_PATH)
    FileUtils.mkdir_p(File.dirname(file_path))
    FileUtils.touch(file_path)
    puts "SaaS mode enabled (#{file_path} created)"
  end

  desc "Disable SaaS mode"
  task disable: :environment do
    file_path = Rails.root.join(SAAS_FILE_PATH)
    FileUtils.rm_f(file_path)
    puts "SaaS mode disabled (#{file_path} removed)"
  end
end

================
File: lib/tasks/search.rake
================
namespace :search do
  desc "Reindex all cards and comments in the search index"
  task reindex: :environment do
    puts "Clearing search records..."
    if ActiveRecord::Base.connection.adapter_name == "SQLite"
      ActiveRecord::Base.connection.execute("DELETE FROM search_records")
      ActiveRecord::Base.connection.execute("DELETE FROM search_records_fts")
    else
      Search::Record::Trilogy::SHARD_COUNT.times do |shard_id|
        ActiveRecord::Base.connection.execute("DELETE FROM search_records_#{shard_id}")
      end
    end

    puts "Reindexing cards..."
    Card.includes(:rich_text_description).find_each(&:reindex)

    puts "Reindexing comments..."
    Comment.includes(:rich_text_body, :card).find_each(&:reindex)

    puts "Done! Reindexed #{Card.count} cards and #{Comment.count} comments."
  end
end

================
File: lib/web_push/notification.rb
================
class WebPush::Notification
  def initialize(title:, body:, path:, badge:, endpoint:, endpoint_ip:, p256dh_key:, auth_key:)
    @title, @body, @path, @badge = title, body, path, badge
    @endpoint, @endpoint_ip, @p256dh_key, @auth_key = endpoint, endpoint_ip, p256dh_key, auth_key
  end
  def deliver(connection: nil)
    WebPush.payload_send \
      message: encoded_message,
      endpoint: @endpoint, endpoint_ip: @endpoint_ip, p256dh: @p256dh_key, auth: @auth_key,
      vapid: vapid_identification,
      connection: connection,
      urgency: "high"
  end
  private
    def vapid_identification
      { subject: "mailto:support@fizzy.do" }.merge \
        Rails.configuration.x.vapid.symbolize_keys
    end
    def encoded_message
      JSON.generate title: @title, options: { body: @body, icon: icon_path, data: { path: @path, badge: @badge } }
    end
    def icon_path
      "/apple-touch-icon.png"
    end
end

================
File: lib/web_push/pool.rb
================
# This is in lib so we can use it in a thread pool without the Rails executor
class WebPush::Pool
  attr_reader :delivery_pool, :invalidation_pool, :connection, :invalid_subscription_handler
  def initialize(invalid_subscription_handler:)
    @delivery_pool = Concurrent::ThreadPoolExecutor.new(max_threads: 50, queue_size: 10000)
    @invalidation_pool = Concurrent::FixedThreadPool.new(1)
    @connection = Net::HTTP::Persistent.new(name: "web_push", pool_size: 150)
    @invalid_subscription_handler = invalid_subscription_handler
  end
  def queue(payload, subscriptions)
    subscriptions.find_each do |subscription|
      deliver_later(payload, subscription)
    end
  end
  def shutdown
    connection.shutdown
    shutdown_pool(delivery_pool)
    shutdown_pool(invalidation_pool)
  end
  private
    def deliver_later(payload, subscription)
      # Ensure any AR operations happen before we post to the thread pool
      notification = subscription.notification(**payload)
      subscription_id = subscription.id
      delivery_pool.post do
        deliver(notification, subscription_id)
      rescue Exception => e
        Rails.logger.error "Error in WebPush::Pool.deliver: #{e.class} #{e.message}"
      end
    rescue Concurrent::RejectedExecutionError
    end
    def deliver(notification, id)
      notification.deliver(connection: connection)
    rescue WebPush::ExpiredSubscription, OpenSSL::OpenSSLError => ex
      invalidate_subscription_later(id) if invalid_subscription_handler
    end
    def invalidate_subscription_later(id)
      invalidation_pool.post do
        invalid_subscription_handler.call(id)
      rescue Exception => e
        Rails.logger.error "Error in WebPush::Pool.invalid_subscription_handler: #{e.class} #{e.message}"
      end
    end
    def shutdown_pool(pool)
      pool.shutdown
      pool.kill unless pool.wait_for_termination(1)
    end
end

================
File: lib/auto_link_scrubber.rb
================
# Loofah scrubber to auto-link URLs and email addresses in HTML text nodes.
#
# This scrubber does not perform HTML sanitization; it's assumed that the input is already sanitized
# (for example, ActionText rich text).
class AutoLinkScrubber < Loofah::Scrubber
  EXCLUDED_ELEMENTS = %w[a figcaption pre code].freeze
  # This regexp is similar to URI::MailTo::EMAIL_REGEXP but uses \b word boundaries instead of \A/\z
  # anchors, allowing it to match email addresses embedded within longer strings.
  #
  # It's named EMAIL_AUTOLINK_REGEXP (not EMAIL_REGEXP) to avoid confusing Brakeman's imprecise
  # constant lookup, which otherwise assumes Identity's email validation uses this \b-anchored pattern.
  # See https://github.com/presidentbeef/brakeman/pull/1981
  EMAIL_AUTOLINK_REGEXP = /\b[a-zA-Z0-9.!#$%&'*+\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*\b/
  URL_REGEXP = URI::DEFAULT_PARSER.make_regexp(%w[http https])
  AUTOLINK_REGEXP = /(?<url>#{URL_REGEXP})|(?<email>#{EMAIL_AUTOLINK_REGEXP})/
  TRAILING_PUNCTUATION = %(.?,:!;"'<>)
  TRAILING_PUNCTUATION_REGEXP = /[#{Regexp.escape(TRAILING_PUNCTUATION)}]+\z/
  def initialize
    @direction = :top_down
  end
  def scrub(node)
    return Loofah::Scrubber::STOP if EXCLUDED_ELEMENTS.include?(node.name)
    if node.text?
      replacement = autolink_text_node(node)
      node.replace(replacement) if replacement
    end
    Loofah::Scrubber::CONTINUE
  end
  private
    def autolink_text_node(node)
      text = node.text
      links = find_links(text)
      return nil if links.empty?
      doc = node.document
      nodes = Nokogiri::XML::NodeSet.new(doc)
      pos = 0
      links.each do |link|
        nodes << doc.create_text_node(text[pos...link[:start]]) if link[:start] > pos
        nodes << doc.create_element("a", link[:text], href: link[:href], rel: "noopener noreferrer")
        pos = link[:start] + link[:length]
      end
      nodes << doc.create_text_node(text[pos..]) if pos < text.length
      nodes
    end
    def find_links(text)
      links = []
      text.scan(AUTOLINK_REGEXP) do
        match_data = Regexp.last_match
        start_pos = match_data.begin(0)
        if match_data[:url]
          url = clean_url(match_data[:url])
          links << { start: start_pos, length: url.length, text: url, href: url }
        else
          email = match_data[:email]
          links << { start: start_pos, length: email.length, text: email, href: "mailto:#{email}" }
        end
      end
      links
    end
    def clean_url(url)
      url.sub(TRAILING_PUNCTUATION_REGEXP, "")
    end
end

================
File: lib/deployment.rb
================
require_relative "deployment/database_resolver.rb"

================
File: lib/fizzy.rb
================
module Fizzy
  class << self
    def saas?
      return @saas if defined?(@saas)
      @saas = !!(((ENV["SAAS"] || File.exist?(File.expand_path("../tmp/saas.txt", __dir__))) && ENV["SAAS"] != "false"))
    end
    def db_adapter
      @db_adapter ||= DbAdapter.new ENV.fetch("DATABASE_ADAPTER", saas? ? "mysql" : "sqlite")
    end
    def configure_bundle
      if saas?
        ENV["BUNDLE_GEMFILE"] = "Gemfile.saas"
      end
    end
  end
  class DbAdapter
    def initialize(name)
      @name = name.to_s
    end
    def to_s
      @name
    end
    # Not using inquiry so that it works before Rails env loads.
    def sqlite?
      @name == "sqlite"
    end
  end
end

================
File: log/.keep
================


================
File: public/400.html
================
<!doctype html>
<html lang="en">
  <head>
    <title>400 Bad Request</title>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, width=device-width">
    <meta name="robots" content="noindex, nofollow">
    <link rel="stylesheet" href="/error.css">
  </head>
  <body>
    <hgroup class="error-page__stamp">
      <h1>400</h1>
      <h2>Bad request</h2>
      <hr />
      <div>Your request could not be understood by the server.</div>
    </hgroup>
    <a href="/">&larr; Back home</a>
  </body>
</html>

================
File: public/404.html
================
<!doctype html>
<html lang="en">
  <head>
    <title>404 Not Found</title>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, width=device-width">
    <meta name="robots" content="noindex, nofollow">
    <link rel="stylesheet" href="/error.css">
  </head>
  <body>
    <hgroup class="error-page__stamp">
      <h1>404</h1>
      <h2>Sorry, that page doesnt exist!</h2>
      <hr />
      <div>You may have mistyped the address or the page may have moved.</div>
    </hgroup>
    <a href="/">&larr; Back home</a>
  </body>
</html>

================
File: public/406-unsupported-browser.html
================
<!doctype html>
<html lang="en">
  <head>
    <title>406 Unsupported Browser</title>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, width=device-width">
    <meta name="robots" content="noindex, nofollow">
    <link rel="stylesheet" href="/error.css">
  </head>
  <body>
    <hgroup class="error-page__stamp">
      <h1>406</h1>
      <h2>You need to upgrade your browser</h2>
      <hr />
      <div>This application requires a modern browser. Please upgrade to the latest version.</div>
    </hgroup>
    <a href="/">&larr; Back home</a>
  </body>
</html>

================
File: public/422.html
================
<!doctype html>
<html lang="en">
  <head>
    <title>422 Unprocessable Entity</title>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, width=device-width">
    <meta name="robots" content="noindex, nofollow">
    <link rel="stylesheet" href="/error.css">
  </head>
  <body>
    <hgroup class="error-page__stamp">
      <h1>422</h1>
      <h2>Unprocessable entity</h2>
      <hr />
      <div>The server understands the request but was unable to process it.</div>
    </hgroup>
    <a href="/">&larr; Back home</a>
  </body>
</html>

================
File: public/500.html
================
<!doctype html>
<html lang="en">
  <head>
    <title>500 Internal Server Error</title>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, width=device-width">
    <meta name="robots" content="noindex, nofollow">
    <link rel="stylesheet" href="/error.css">
  </head>
  <body>
    <hgroup class="error-page__stamp">
      <h1>500</h1>
      <h2>Internal server error</h2>
      <hr />
      <div>Something went wrong on our end; please try again later.</div>
    </hgroup>
    <a href="/">&larr; Back home</a>
  </body>
</html>

================
File: public/error.css
================
:root {
  --color-canvas: white;
  --color-ink: oklch(26% 0.05 264);
  --color-accent: oklch(57.02% 0.1895 260.46);
  --text-large: 6rem;
  --text-medium: 2rem;
  --text-normal: 1rem;
  @media (prefers-color-scheme: dark) {
    --color-canvas: oklch(20% 0.0195 232.58);
    --color-ink: oklch(96.02% 0.0034 260);
    --color-accent: oklch(74% 0.1293 256);
  }
}
*, *::before, *::after {
  box-sizing: border-box;
  margin: 0;
}
html {
  font-size: 1.5rem;
  overflow: hidden;
}
body {
  -moz-osx-font-smoothing: grayscale;
  -webkit-font-smoothing: antialiased;
  -webkit-text-size-adjust: none;
  align-items: center;
  background-color: var(--color-canvas);
  color: var(--color-ink);
  display: flex;
  flex-direction: column;
  font-family: system-ui;
  font-size: var(--text-normal);
  font-style: normal;
  font-weight: 500;
  gap: 2rem;
  line-height: 1.375;
  min-height: 100vh;
  overflow: hidden;
  padding-inline: 1rem;
  justify-content: center;
  text-align: center;
  text-rendering: optimizeLegibility;
  text-size-adjust: none;
  /* Cool wavy striped lines */
  &:before {
    --mask:
    radial-gradient(6px at 50% calc(100% + 3px), #0000 calc(99% - 2px), #000 calc(101% - 2px) 99%, #0000 101%) calc(50% - 8px) calc(50% - 3px + .5px)/16px 6px ,
    radial-gradient(6px at 50% -3px, #0000 calc(99% - 2px), #000 calc(101% - 2px) 99%, #0000 101%) 50% calc(50% + 3px)/16px 6px ;
    -webkit-mask: var(--mask);
    mask: var(--mask);
    background: var(--color-accent);
    content: "";
    inset: 0;
    opacity: 0.15;
    position: absolute;
    z-index: -1;
  }
}
.error-page__stamp {
  --padding: 1rem 2rem;
  --stroke-width: 0.25rem;
  align-items: center;
  background-color: color-mix(in oklch, var(--color-canvas), transparent 50%);
  background-color: var(--color-canvas);
  border-radius: calc(var(--stroke-width) * 2);
  border: calc(var(--stroke-width) * 1) dashed var(--color-accent);
  color: var(--color-accent);
  display: flex;
  flex-direction: column;
  justify-content: center;
  line-height: 1.25;
  max-inline-size: 36ch;
  rotate: -5deg;
  padding: var(--padding);
  position: relative;
}
h1 {
  font-size: var(--text-large);
  font-weight: 900;
  line-height: 1;
  position: relative;
  text-transform: uppercase;
  @supports (-webkit-text-stroke: 1px black) {
    -webkit-text-stroke: var(--stroke-width) var(--color-accent);
    -webkit-text-fill-color: transparent;
  }
}
h2 {
  font-size: var(--text-normal);
  font-weight: inherit;
}
hr {
  inline-size: 100%;
  border: 0;
  border-block-start: calc(var(--stroke-width) / 2) solid currentcolor;
  color: currentcolor;
  margin: 1ch auto;
}
a {
  color: inherit;
  line-height: 2rem;
  display: inline-block;
  padding-inline: 1ch;
  border-radius: 99rem;
  text-decoration: none;
  span {
    text-decoration: underline;
    text-underline-offset: 0.25ch;
  }
  &:hover {
    color: var(--color-accent);
  }
}

================
File: public/robots.txt
================
User-Agent: *
Disallow: /

================
File: saas/.kamal/hooks/post-deploy
================
#!/usr/bin/env bash

MESSAGE="$KAMAL_PERFORMER deployed $KAMAL_SERVICE_VERSION to $KAMAL_DESTINATION in $KAMAL_RUNTIME seconds"
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)

bin/notify_dash_of_deployment "$MESSAGE" $KAMAL_VERSION $KAMAL_PERFORMER $CURRENT_BRANCH $KAMAL_DESTINATION $KAMAL_RUNTIME

if [[ $CURRENT_BRANCH == "main" && $KAMAL_DESTINATION == "production" ]]; then
  gh release create $KAMAL_SERVICE_VERSION --target $KAMAL_VERSION --generate-notes 2> /dev/null || true

  RELEASE_URL=$(gh release view $KAMAL_SERVICE_VERSION --json url,body --jq .url)
  RELEASE_BODY=$(gh release view $KAMAL_SERVICE_VERSION --json url,body --jq .body)

  saas/bin/broadcast_to_bc "$MESSAGE "$'\n'"$RELEASE_URL "$'\n'"$RELEASE_BODY"
else
  saas/bin/broadcast_to_bc "$MESSAGE"
fi

================
File: saas/.kamal/hooks/pre-connect
================
#!/usr/bin/env bash

# Validate hostnames are FQDNs ending in -int.37signals.com
if command -v yq >/dev/null 2>&1; then
  declare -A SUGGESTIONS
  while IFS= read -r host; do
    if [[ ! $host =~ -int\.37signals\.com$ ]]; then
      if [[ $host =~ -4[0-9]{2}$ ]]; then
        SUGGESTIONS["$host"]="$host.df-ams-int.37signals.com"
      elif [[ $host =~ -1[0-9]{2}$ ]]; then
        SUGGESTIONS["$host"]="$host.df-iad-int.37signals.com"
      else
        SUGGESTIONS["$host"]="$host.sc-chi-int.37signals.com"
      fi
    fi
  done < <(bin/kamal config -d "${KAMAL_DESTINATION:-production}" 2>/dev/null | yq -r '.":hosts"[]')

  if [ ${#SUGGESTIONS[@]} -gt 0 ]; then
    echo "Unqualified hostnames found in config/deploy.${KAMAL_DESTINATION:-production}.yml:" >&2
    echo "" >&2
    echo "Update to use fully-qualified hostnames:" >&2
    for host in "${!SUGGESTIONS[@]}"; do
      echo "  $host  ${SUGGESTIONS[$host]}" >&2
    done
    exit 1
  fi
fi

# Verify Tailscale connection and SSH authentication before deploying.
tailscale_cmd() {
  if command -v tailscale >/dev/null 2>&1; then
    tailscale "$@"
  elif [ -f "/Applications/Tailscale.app/Contents/MacOS/Tailscale" ]; then
    env TAILSCALE_BE_CLI=1 /Applications/Tailscale.app/Contents/MacOS/Tailscale "$@"
  else
    return 1
  fi
}

on_tailscale() {
  tailscale_cmd status --json 2>/dev/null | jq -e '.Self.Online' >/dev/null 2>&1
}

# Check Tailscale connection
if ! on_tailscale; then
  echo "" >&2
  echo "You must be connected to Tailscale to deploy." >&2
  echo "" >&2
  echo " Connect to Tailscale and try again" >&2
  echo "" >&2
  exit 1
fi

# Verify SSH access
echo "Deploying via Tailscale. Verifying SSH access" >&2

TEST_HOST="fizzy-app-101.df-iad-int.37signals.com"

SSH_OUTPUT=$(ssh -o ConnectTimeout=5 "app@$TEST_HOST" true 2>&1)
SSH_EXIT=$?

echo "$SSH_OUTPUT" >&2

if echo "$SSH_OUTPUT" | grep -q "Permission denied"; then
  GITHUB_USER=$(gh api user 2>/dev/null | jq -r '.login // "unknown"')
  GITHUB_KEYS_URL="https://github.com/${GITHUB_USER}.keys"

  echo "" >&2
  echo "ERROR: SSH authentication failed" >&2
  echo "" >&2
  echo "You must deploy with an SSH key that's on your GitHub account." >&2
  echo "" >&2
  echo " Verify your public key is at $GITHUB_KEYS_URL" >&2
  echo "  Add it at https://github.com/settings/keys if not" >&2
  echo "" >&2
  echo "Note that SSH keys are pulled from GitHub every 5 minutes, so if you've" >&2
  echo "just added a new key to GitHub, try again in five." >&2
  echo "" >&2
  exit 1
fi

exit $SSH_EXIT

================
File: saas/.kamal/secrets.beta
================
SECRETS=$(kamal secrets fetch --adapter 1password --account 23QPQDKZC5BKBIIG7UGT5GR5RM --from Deploy/Fizzy Deployments/BASECAMP_REGISTRY_PASSWORD Deployments/DASH_BASIC_AUTH_SECRET Beta/RAILS_MASTER_KEY Beta/MYSQL_ALTER_PASSWORD Beta/MYSQL_ALTER_USER Beta/MYSQL_APP_PASSWORD Beta/MYSQL_APP_USER Beta/MYSQL_READONLY_PASSWORD Beta/MYSQL_READONLY_USER Beta/SECRET_KEY_BASE Beta/VAPID_PUBLIC_KEY Beta/VAPID_PRIVATE_KEY Beta/ACTIVE_STORAGE_ACCESS_KEY_ID Beta/ACTIVE_STORAGE_SECRET_ACCESS_KEY Beta/QUEENBEE_API_TOKEN Beta/SIGNAL_ID_SECRET Beta/SENTRY_DSN Beta/ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY Beta/ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY Beta/ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT Beta/STRIPE_MONTHLY_V1_PRICE_ID Beta/STRIPE_MONTHLY_EXTRA_STORAGE_V1_PRICE_ID Beta/STRIPE_SECRET_KEY Beta/STRIPE_WEBHOOK_SECRET)

GITHUB_TOKEN=$(gh config get -h github.com oauth_token)
BASECAMP_REGISTRY_PASSWORD=$(kamal secrets extract BASECAMP_REGISTRY_PASSWORD $SECRETS)
DASH_BASIC_AUTH_SECRET=$(kamal secrets extract DASH_BASIC_AUTH_SECRET $SECRETS)
RAILS_MASTER_KEY=$(kamal secrets extract RAILS_MASTER_KEY $SECRETS)
MYSQL_ALTER_PASSWORD=$(kamal secrets extract MYSQL_ALTER_PASSWORD $SECRETS)
MYSQL_ALTER_USER=$(kamal secrets extract MYSQL_ALTER_USER $SECRETS)
MYSQL_APP_PASSWORD=$(kamal secrets extract MYSQL_APP_PASSWORD $SECRETS)
MYSQL_APP_USER=$(kamal secrets extract MYSQL_APP_USER $SECRETS)
MYSQL_READONLY_PASSWORD=$(kamal secrets extract MYSQL_READONLY_PASSWORD $SECRETS)
MYSQL_READONLY_USER=$(kamal secrets extract MYSQL_READONLY_USER $SECRETS)
SECRET_KEY_BASE=$(kamal secrets extract SECRET_KEY_BASE $SECRETS)
VAPID_PUBLIC_KEY=$(kamal secrets extract VAPID_PUBLIC_KEY $SECRETS)
VAPID_PRIVATE_KEY=$(kamal secrets extract VAPID_PRIVATE_KEY $SECRETS)
ACTIVE_STORAGE_ACCESS_KEY_ID=$(kamal secrets extract ACTIVE_STORAGE_ACCESS_KEY_ID $SECRETS)
ACTIVE_STORAGE_SECRET_ACCESS_KEY=$(kamal secrets extract ACTIVE_STORAGE_SECRET_ACCESS_KEY $SECRETS)
QUEENBEE_API_TOKEN=$(kamal secrets extract QUEENBEE_API_TOKEN $SECRETS)
SIGNAL_ID_SECRET=$(kamal secrets extract SIGNAL_ID_SECRET $SECRETS)
SENTRY_DSN=$(kamal secrets extract SENTRY_DSN $SECRETS)
ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY=$(kamal secrets extract ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY $SECRETS)
ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY=$(kamal secrets extract ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY $SECRETS)
ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT=$(kamal secrets extract ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT $SECRETS)
STRIPE_MONTHLY_V1_PRICE_ID=$(kamal secrets extract STRIPE_MONTHLY_V1_PRICE_ID $SECRETS)
STRIPE_MONTHLY_EXTRA_STORAGE_V1_PRICE_ID=$(kamal secrets extract STRIPE_MONTHLY_EXTRA_STORAGE_V1_PRICE_ID $SECRETS)
STRIPE_SECRET_KEY=$(kamal secrets extract STRIPE_SECRET_KEY $SECRETS)
STRIPE_WEBHOOK_SECRET=$(kamal secrets extract STRIPE_WEBHOOK_SECRET $SECRETS)

================
File: saas/.kamal/secrets.beta1
================
secrets.beta

================
File: saas/.kamal/secrets.beta2
================
secrets.beta

================
File: saas/.kamal/secrets.beta3
================
secrets.beta

================
File: saas/.kamal/secrets.beta4
================
secrets.beta

================
File: saas/.kamal/secrets.production
================
SECRETS=$(kamal secrets fetch --adapter 1password --account 23QPQDKZC5BKBIIG7UGT5GR5RM --from Deploy/Fizzy Deployments/BASECAMP_REGISTRY_PASSWORD Deployments/DASH_BASIC_AUTH_SECRET Production/RAILS_MASTER_KEY Production/MYSQL_ALTER_PASSWORD Production/MYSQL_ALTER_USER Production/MYSQL_APP_PASSWORD Production/MYSQL_APP_USER Production/MYSQL_READONLY_PASSWORD Production/MYSQL_READONLY_USER Production/SECRET_KEY_BASE Production/VAPID_PUBLIC_KEY Production/VAPID_PRIVATE_KEY Production/ACTIVE_STORAGE_ACCESS_KEY_ID Production/ACTIVE_STORAGE_SECRET_ACCESS_KEY Production/QUEENBEE_API_TOKEN Production/SIGNAL_ID_SECRET Production/SENTRY_DSN Production/ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY Production/ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY Production/ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT Production/STRIPE_MONTHLY_V1_PRICE_ID Production/STRIPE_MONTHLY_EXTRA_STORAGE_V1_PRICE_ID Production/STRIPE_SECRET_KEY Production/STRIPE_WEBHOOK_SECRET)

GITHUB_TOKEN=$(gh config get -h github.com oauth_token)
BASECAMP_REGISTRY_PASSWORD=$(kamal secrets extract BASECAMP_REGISTRY_PASSWORD $SECRETS)
DASH_BASIC_AUTH_SECRET=$(kamal secrets extract DASH_BASIC_AUTH_SECRET $SECRETS)
RAILS_MASTER_KEY=$(kamal secrets extract RAILS_MASTER_KEY $SECRETS)
MYSQL_ALTER_PASSWORD=$(kamal secrets extract MYSQL_ALTER_PASSWORD $SECRETS)
MYSQL_ALTER_USER=$(kamal secrets extract MYSQL_ALTER_USER $SECRETS)
MYSQL_APP_PASSWORD=$(kamal secrets extract MYSQL_APP_PASSWORD $SECRETS)
MYSQL_APP_USER=$(kamal secrets extract MYSQL_APP_USER $SECRETS)
MYSQL_READONLY_PASSWORD=$(kamal secrets extract MYSQL_READONLY_PASSWORD $SECRETS)
MYSQL_READONLY_USER=$(kamal secrets extract MYSQL_READONLY_USER $SECRETS)
SECRET_KEY_BASE=$(kamal secrets extract SECRET_KEY_BASE $SECRETS)
VAPID_PUBLIC_KEY=$(kamal secrets extract VAPID_PUBLIC_KEY $SECRETS)
VAPID_PRIVATE_KEY=$(kamal secrets extract VAPID_PRIVATE_KEY $SECRETS)
ACTIVE_STORAGE_ACCESS_KEY_ID=$(kamal secrets extract ACTIVE_STORAGE_ACCESS_KEY_ID $SECRETS)
ACTIVE_STORAGE_SECRET_ACCESS_KEY=$(kamal secrets extract ACTIVE_STORAGE_SECRET_ACCESS_KEY $SECRETS)
QUEENBEE_API_TOKEN=$(kamal secrets extract QUEENBEE_API_TOKEN $SECRETS)
SIGNAL_ID_SECRET=$(kamal secrets extract SIGNAL_ID_SECRET $SECRETS)
SENTRY_DSN=$(kamal secrets extract SENTRY_DSN $SECRETS)
ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY=$(kamal secrets extract ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY $SECRETS)
ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY=$(kamal secrets extract ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY $SECRETS)
ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT=$(kamal secrets extract ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT $SECRETS)
STRIPE_MONTHLY_V1_PRICE_ID=$(kamal secrets extract STRIPE_MONTHLY_V1_PRICE_ID $SECRETS)
STRIPE_MONTHLY_EXTRA_STORAGE_V1_PRICE_ID=$(kamal secrets extract STRIPE_MONTHLY_EXTRA_STORAGE_V1_PRICE_ID $SECRETS)
STRIPE_SECRET_KEY=$(kamal secrets extract STRIPE_SECRET_KEY $SECRETS)
STRIPE_WEBHOOK_SECRET=$(kamal secrets extract STRIPE_WEBHOOK_SECRET $SECRETS)

================
File: saas/.kamal/secrets.staging
================
SECRETS=$(kamal secrets fetch --adapter 1password --account 23QPQDKZC5BKBIIG7UGT5GR5RM --from Deploy/Fizzy Deployments/BASECAMP_REGISTRY_PASSWORD Deployments/DASH_BASIC_AUTH_SECRET Staging/RAILS_MASTER_KEY Staging/MYSQL_ALTER_PASSWORD Staging/MYSQL_ALTER_USER Staging/MYSQL_APP_PASSWORD Staging/MYSQL_APP_USER Staging/MYSQL_READONLY_PASSWORD Staging/MYSQL_READONLY_USER Staging/SECRET_KEY_BASE Staging/VAPID_PUBLIC_KEY Staging/VAPID_PRIVATE_KEY Staging/ACTIVE_STORAGE_ACCESS_KEY_ID Staging/ACTIVE_STORAGE_SECRET_ACCESS_KEY Staging/QUEENBEE_API_TOKEN Staging/SIGNAL_ID_SECRET Staging/SENTRY_DSN Staging/ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY Staging/ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY Staging/ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT Staging/STRIPE_MONTHLY_V1_PRICE_ID Staging/STRIPE_MONTHLY_EXTRA_STORAGE_V1_PRICE_ID Staging/STRIPE_SECRET_KEY Staging/STRIPE_WEBHOOK_SECRET)

GITHUB_TOKEN=$(gh config get -h github.com oauth_token)
BASECAMP_REGISTRY_PASSWORD=$(kamal secrets extract BASECAMP_REGISTRY_PASSWORD $SECRETS)
DASH_BASIC_AUTH_SECRET=$(kamal secrets extract DASH_BASIC_AUTH_SECRET $SECRETS)
RAILS_MASTER_KEY=$(kamal secrets extract RAILS_MASTER_KEY $SECRETS)
MYSQL_ALTER_PASSWORD=$(kamal secrets extract MYSQL_ALTER_PASSWORD $SECRETS)
MYSQL_ALTER_USER=$(kamal secrets extract MYSQL_ALTER_USER $SECRETS)
MYSQL_APP_PASSWORD=$(kamal secrets extract MYSQL_APP_PASSWORD $SECRETS)
MYSQL_APP_USER=$(kamal secrets extract MYSQL_APP_USER $SECRETS)
MYSQL_READONLY_PASSWORD=$(kamal secrets extract MYSQL_READONLY_PASSWORD $SECRETS)
MYSQL_READONLY_USER=$(kamal secrets extract MYSQL_READONLY_USER $SECRETS)
SECRET_KEY_BASE=$(kamal secrets extract SECRET_KEY_BASE $SECRETS)
VAPID_PUBLIC_KEY=$(kamal secrets extract VAPID_PUBLIC_KEY $SECRETS)
VAPID_PRIVATE_KEY=$(kamal secrets extract VAPID_PRIVATE_KEY $SECRETS)
ACTIVE_STORAGE_ACCESS_KEY_ID=$(kamal secrets extract ACTIVE_STORAGE_ACCESS_KEY_ID $SECRETS)
ACTIVE_STORAGE_SECRET_ACCESS_KEY=$(kamal secrets extract ACTIVE_STORAGE_SECRET_ACCESS_KEY $SECRETS)
QUEENBEE_API_TOKEN=$(kamal secrets extract QUEENBEE_API_TOKEN $SECRETS)
SIGNAL_ID_SECRET=$(kamal secrets extract SIGNAL_ID_SECRET $SECRETS)
SENTRY_DSN=$(kamal secrets extract SENTRY_DSN $SECRETS)
ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY=$(kamal secrets extract ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY $SECRETS)
ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY=$(kamal secrets extract ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY $SECRETS)
ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT=$(kamal secrets extract ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT $SECRETS)
STRIPE_MONTHLY_V1_PRICE_ID=$(kamal secrets extract STRIPE_MONTHLY_V1_PRICE_ID $SECRETS)
STRIPE_MONTHLY_EXTRA_STORAGE_V1_PRICE_ID=$(kamal secrets extract STRIPE_MONTHLY_EXTRA_STORAGE_V1_PRICE_ID $SECRETS)
STRIPE_SECRET_KEY=$(kamal secrets extract STRIPE_SECRET_KEY $SECRETS)
STRIPE_WEBHOOK_SECRET=$(kamal secrets extract STRIPE_WEBHOOK_SECRET $SECRETS)

================
File: saas/app/assets/images/fizzy/saas/.keep
================


================
File: saas/app/assets/stylesheets/fizzy/saas.css
================
/* Subscriptions
/* ------------------------------------------------------------------------ */
:root {
  --settings-subscription-background: linear-gradient(to bottom, var(--color-canvas), oklch(var(--lch-violet-lighter)));
  --settings-subscription-color: oklch(var(--lch-violet-medium));
  --settings-subscription-text-color: oklch(var(--lch-violet-dark));
  .settings-subscription__button {
    --btn-background: var(--settings-subscription-color);
    --btn-border-color: var(--color-canvas);
    --btn-color: var(--color-canvas);
    --focus-ring-color: var(--color-ink);
  }
  .settings-subscription__divider {
    --divider-color: currentColor;
    color: var(--settings-subscription-color);
    margin-block-start: calc(var(--block-space-half) * -1);
  }
  .settings-subscription__footer {
    color: var(--settings-subscription-text-color);
    &::before {
      border-block-start: 1px solid var(--settings-subscription-text-color);
      content: "";
      display: block;
      inline-size: 8ch;
      margin: 0 auto 1ch;
    }
  }
  .settings-subscription__link {
    color: var(--settings-subscription-text-color);
  }
  .settings-subscription__notch {
    animation: wiggle 500ms ease;
    background: var(--settings-subscription-background);
    border-radius: 3em;
    box-shadow: 0 0 0.3em 0.2em var(--settings-subscription-color);
    color: var(--settings-subscription-text-color);
    margin-inline: auto;
    padding: 0.3em 0.3em 0.3em 1.2em;
    transform: rotate(-1deg);
    @media (max-width: 640px) {
      border-radius: 1ch;
      padding-block: 1ch;
      padding-inline: 2ch;
    }
    .btn {
      /* margin-block: 0.3em; */
    }
  }
  .settings-subscription__panel {
    background: var(--settings-subscription-background);
  }
  .settings_subscription__warning {
    color: var(--settings-subscription-text-color);
    a {
      color: var(--settings-subscription-text-color);
    }
  }
}

================
File: saas/app/controllers/account/subscriptions/downgrades_controller.rb
================
class Account::Subscriptions::DowngradesController < Account::Subscriptions::UpdatePlanController
  before_action :ensure_downgradeable
  private
    def target_plan
      Plan.paid
    end
    def ensure_downgradeable
      head :bad_request unless subscription.plan == Plan.paid_with_extra_storage
    end
end

================
File: saas/app/controllers/account/subscriptions/update_plan_controller.rb
================
class Account::Subscriptions::UpdatePlanController < ApplicationController
  before_action :ensure_admin
  def create
    portal_session = Stripe::BillingPortal::Session.create(
      customer: subscription.stripe_customer_id,
      return_url: account_settings_url(anchor: "subscription"),
      flow_data: {
        type: "subscription_update_confirm",
        subscription_update_confirm: {
          subscription: subscription.stripe_subscription_id,
          items: [ { id: stripe_subscription_item_id, price: target_plan.stripe_price_id } ]
        }
      }
    )
    redirect_to portal_session.url, allow_other_host: true
  end
  private
    def target_plan
      raise NotImplementedError
    end
    def subscription
      @subscription ||= Current.account.subscription
    end
    def stripe_subscription_item_id
      Stripe::Subscription.retrieve(subscription.stripe_subscription_id).items.data.first.id
    end
end

================
File: saas/app/controllers/account/subscriptions/upgrades_controller.rb
================
class Account::Subscriptions::UpgradesController < Account::Subscriptions::UpdatePlanController
  before_action :ensure_upgradeable
  private
    def target_plan
      Plan.paid_with_extra_storage
    end
    def ensure_upgradeable
      head :bad_request unless subscription.plan == Plan.paid
    end
end

================
File: saas/app/controllers/account/billing_portals_controller.rb
================
class Account::BillingPortalsController < ApplicationController
  before_action :ensure_admin
  before_action :ensure_subscribed_account
  def show
    redirect_to create_stripe_billing_portal_session.url, allow_other_host: true
  end
  private
    def ensure_subscribed_account
      unless Current.account.subscribed?
        redirect_to account_subscription_path, alert: "No billing information found"
      end
    end
    def create_stripe_billing_portal_session
      Stripe::BillingPortal::Session.create(customer: Current.account.subscription.stripe_customer_id, return_url: account_settings_url)
    end
end

================
File: saas/app/controllers/account/subscriptions_controller.rb
================
class Account::SubscriptionsController < ApplicationController
  before_action :ensure_admin
  before_action :set_stripe_session, only: :show
  def show
  end
  def create
    session = Stripe::Checkout::Session.create \
      customer: find_or_create_stripe_customer,
      mode: "subscription",
      line_items: [ { price: plan_param.stripe_price_id, quantity: 1 } ],
      success_url: account_subscription_url + "?session_id={CHECKOUT_SESSION_ID}",
      cancel_url: account_subscription_url,
      metadata: { account_id: Current.account.id, plan_key: plan_param.key },
      automatic_tax: { enabled: true },
      tax_id_collection: { enabled: true },
      billing_address_collection: "required",
      customer_update: { address: "auto", name: "auto" }
    redirect_to session.url, allow_other_host: true
  end
  private
    def plan_param
      @plan_param ||= Plan[params[:plan_key]] || Plan.paid
    end
    def set_stripe_session
      @stripe_session = Stripe::Checkout::Session.retrieve(params[:session_id]) if params[:session_id]
    end
    def find_or_create_stripe_customer
      find_stripe_customer || create_stripe_customer
    end
    def find_stripe_customer
      Stripe::Customer.retrieve(Current.account.subscription.stripe_customer_id) if Current.account.subscription&.stripe_customer_id
    end
    def create_stripe_customer
      Stripe::Customer.create(email: Current.user.identity.email_address, name: Current.account.name, metadata: { account_id: Current.account.id }).tap do |customer|
        Current.account.create_subscription!(stripe_customer_id: customer.id, plan_key: plan_param.key, status: "incomplete")
      end
    end
end

================
File: saas/app/controllers/admin/account_searches_controller.rb
================
class Admin::AccountSearchesController < AdminController
  def create
    redirect_to saas.edit_admin_account_path(params[:q])
  end
end

================
File: saas/app/controllers/admin/accounts_controller.rb
================
class Admin::AccountsController < AdminController
  include Admin::AccountScoped
  layout "public"
  before_action :set_account, only: %i[ edit update ]
  def index
  end
  def edit
  end
  def update
    @account.override_limits(**overridden_limits_params.to_h.symbolize_keys)
    redirect_to saas.edit_admin_account_path(@account.external_account_id), notice: "Account limits updated"
  end
  private
    def set_account
      @account = Account.find_by!(external_account_id: params[:id])
    end
    def overridden_limits_params
      params.expect(account: [ :card_count, :bytes_used ])
    end
end

================
File: saas/app/controllers/admin/audits_controller.rb
================
class Admin::AuditsController < ::AdminController
  private
    # Extend Fizzy's authentication to support auditor bearer tokens.
    def require_authentication
      authenticate_by_audit_bearer_token || super
    end
    def authenticate_by_audit_bearer_token
      if auditor = auditor_from_bearer_token
        Current.identity = auditor
      end
    end
    def find_current_auditor
      Current.identity
    end
end

================
File: saas/app/controllers/admin/billing_waivers_controller.rb
================
class Admin::BillingWaiversController < AdminController
  include Admin::AccountScoped
  def create
    @account.comp
    redirect_to saas.edit_admin_account_path(@account.external_account_id), notice: "Account comped"
  end
  def destroy
    @account.uncomp
    redirect_to saas.edit_admin_account_path(@account.external_account_id), notice: "Account uncomped"
  end
end

================
File: saas/app/controllers/admin/overridden_limits_controller.rb
================
class Admin::OverriddenLimitsController < AdminController
  include Admin::AccountScoped
  def destroy
    @account.reset_overridden_limits
    redirect_to saas.edit_admin_account_path(@account.external_account_id), notice: "Limits reset"
  end
end

================
File: saas/app/controllers/admin/stats_controller.rb
================
class Admin::StatsController < AdminController
  layout "public"
  def show
    @accounts_total = Account.count
    @accounts_last_7_days = Account.where(created_at: 7.days.ago..).count
    @accounts_last_24_hours = Account.where(created_at: 24.hours.ago..).count
    @paid_accounts_total = paid_subscriptions.distinct.count(:account_id)
    @paid_accounts_last_7_days = paid_subscriptions.where(created_at: 7.days.ago..).distinct.count(:account_id)
    @paid_accounts_last_24_hours = paid_subscriptions.where(created_at: 24.hours.ago..).distinct.count(:account_id)
    @identities_total = Identity.count
    @identities_last_7_days = Identity.where(created_at: 7.days.ago..).count
    @identities_last_24_hours = Identity.where(created_at: 24.hours.ago..).count
    @top_accounts = Account
      .where("cards_count > 0")
      .order(cards_count: :desc)
      .limit(20)
    @recent_accounts = Account.order(created_at: :desc).limit(10)
  end
  private
    def paid_subscriptions
      Account::Subscription
        .where(status: %w[active trialing past_due])
        .where(plan_key: %w[monthly_v1 monthly_extra_storage_v1])
        .where.not(account_id: Account::BillingWaiver.select(:account_id))
    end
end

================
File: saas/app/controllers/concerns/admin/account_scoped.rb
================
module Admin::AccountScoped
  extend ActiveSupport::Concern
  included do
    before_action :set_account
  end
  private
    def set_account
      @account = Account.find_by!(external_account_id: params[:account_id] || params[:id])
    end
end

================
File: saas/app/controllers/concerns/card/limited_creation.rb
================
module Card::LimitedCreation
  extend ActiveSupport::Concern
  included do
    include Card::Limited
    # Only limit API requests. We let you create drafts in the app to actually show the banner, no matter the card count.
    # We limit card publications separately. See +Card::LimitedPublishing+.
    before_action :ensure_under_limits, only: %i[ create ], if: -> { request.format.json? }
  end
end

================
File: saas/app/controllers/concerns/card/limited_publishing.rb
================
module Card::LimitedPublishing
  extend ActiveSupport::Concern
  included do
    include Card::Limited
    before_action :ensure_under_limits, only: %i[ create ]
  end
end

================
File: saas/app/controllers/concerns/card/limited.rb
================
module Card::Limited
  extend ActiveSupport::Concern
  private
    def ensure_under_limits
      head :forbidden if Current.account.exceeding_limits?
    end
end

================
File: saas/app/controllers/stripe/webhooks_controller.rb
================
class Stripe::WebhooksController < ApplicationController
  allow_unauthenticated_access
  skip_before_action :require_account
  skip_forgery_protection
  def create
    if event = verify_webhook_signature
      dispatch_stripe_event(event)
      head :ok
    else
      head :bad_request
    end
  end
  private
    def dispatch_stripe_event(event)
      case event.type
      when "checkout.session.completed"
        sync_new_subscription(event.data.object.subscription, plan_key: event.data.object.metadata["plan_key"]) if event.data.object.mode == "subscription"
      when "customer.subscription.updated", "customer.subscription.deleted"
        sync_subscription(event.data.object.id)
      end
    end
    def verify_webhook_signature
      payload = request.body.read
      sig_header = request.env["HTTP_STRIPE_SIGNATURE"]
      Stripe::Webhook.construct_event(payload, sig_header, ENV["STRIPE_WEBHOOK_SECRET"])
    rescue Stripe::SignatureVerificationError => e
      Rails.logger.error "Stripe webhook signature verification failed: #{e.message}"
      nil
    end
    def sync_new_subscription(stripe_subscription_id, plan_key:)
      sync_subscription(stripe_subscription_id) do |subscription_properties|
        subscription_properties[:plan_key] = plan_key if plan_key
      end
    end
    # Always fetch fresh subscription data from Stripe to handle out-of-order
    # event delivery. Not relying on payload data.
    def sync_subscription(stripe_subscription_id)
      stripe_subscription = Stripe::Subscription.retrieve(stripe_subscription_id)
      if subscription = find_subscription_by_stripe_customer(stripe_subscription.customer)
        subscription_properties = {
          stripe_subscription_id: stripe_subscription.id,
          status: stripe_subscription.status,
          current_period_end: current_period_end_for(stripe_subscription),
          cancel_at: stripe_subscription.cancel_at ? Time.at(stripe_subscription.cancel_at) : nil,
          next_amount_due_in_cents: next_amount_due_for(stripe_subscription),
          plan_key: plan_key_for(stripe_subscription)
        }
        yield subscription_properties if block_given?
        subscription_properties[:stripe_subscription_id] = nil if stripe_subscription.status == "canceled"
        subscription.update!(subscription_properties)
      end
    end
    def find_subscription_by_stripe_customer(id)
      Account::Subscription.find_by(stripe_customer_id: id)
    end
    def current_period_end_for(stripe_subscription)
      timestamp = stripe_subscription.items.data.first&.current_period_end
      Time.at(timestamp) if timestamp
    end
    def next_amount_due_for(stripe_subscription)
      return nil if stripe_subscription.status == "canceled"
      preview = Stripe::Invoice.create_preview(customer: stripe_subscription.customer, subscription: stripe_subscription.id)
      preview.amount_due
    rescue Stripe::InvalidRequestError
      nil
    end
    def plan_key_for(stripe_subscription)
      price_id = stripe_subscription.items.data.first&.price&.id
      Plan.find_by_price_id(price_id)&.key
    end
end

================
File: saas/app/helpers/subscriptions_helper.rb
================
module SubscriptionsHelper
  def storage_to_human_size(bytes)
    number_to_human_size(bytes).delete(" ")
  end
  def subscription_period_end_action(subscription)
    if subscription.to_be_canceled?
      "Your Fizzy subscription ends on"
    elsif subscription.canceled?
      "Your Fizzy subscription ended on"
    else
      "Your next payment is <b>#{ format_currency(subscription.next_amount_due) }</b> on".html_safe
    end
  end
  def format_currency(amount)
    number_to_currency(amount, precision: (amount % 1).zero? ? 0 : 2)
  end
end

================
File: saas/app/jobs/account/sync_stripe_customer_email_job.rb
================
class Account::SyncStripeCustomerEmailJob < ApplicationJob
  queue_as :default
  retry_on Stripe::StripeError, wait: :polynomially_longer
  def perform(subscription)
    subscription.sync_customer_email_to_stripe
  end
end

================
File: saas/app/models/account/billing_waiver.rb
================
class Account::BillingWaiver < SaasRecord
  belongs_to :account
  def subscription
    @subscription ||= Account::Subscription.new(plan: Plan.paid_with_extra_storage)
  end
end

================
File: saas/app/models/account/billing.rb
================
module Account::Billing
  extend ActiveSupport::Concern
  included do
    has_one :subscription, class_name: "Account::Subscription", dependent: :destroy
    has_one :billing_waiver, class_name: "Account::BillingWaiver", dependent: :destroy
    set_callback :incinerate, :before, -> { subscription&.cancel }
    set_callback :cancel, :after, -> { subscription&.pause }
    set_callback :reactivate, :before, -> { subscription&.resume }
  end
  def plan
    active_subscription&.plan || Plan.free
  end
  def subscribed?
    subscription.present?
  end
  def comped?
    billing_waiver.present?
  end
  def comp
    create_billing_waiver unless billing_waiver
  end
  def uncomp
    billing_waiver&.destroy
    reload_billing_waiver
  end
  def owner_email_changed
    Account::SyncStripeCustomerEmailJob.perform_later(subscription) if subscription
  end
  private
    def active_subscription
      if comped?
        comped_subscription
      elsif subscription&.active?
        subscription
      end
    end
    def comped_subscription
      @comped_subscription ||= billing_waiver&.subscription
    end
end

================
File: saas/app/models/account/limited.rb
================
module Account::Limited
  extend ActiveSupport::Concern
  included do
    has_one :overridden_limits, class_name: "Account::OverriddenLimits", dependent: :destroy
  end
  NEAR_CARD_LIMIT_THRESHOLD = 100
  NEAR_STORAGE_LIMIT_THRESHOLD = 500.megabytes
  def override_limits(card_count: nil, bytes_used: nil)
    (overridden_limits || build_overridden_limits).update!(card_count:, bytes_used:)
  end
  def billed_cards_count
    overridden_limits&.card_count || cards_count
  end
  def billed_bytes_used
    overridden_limits&.bytes_used || bytes_used
  end
  def nearing_plan_cards_limit?
    plan.limit_cards? && remaining_cards_count < NEAR_CARD_LIMIT_THRESHOLD
  end
  def exceeding_card_limit?
    plan.limit_cards? && billed_cards_count > plan.card_limit
  end
  def nearing_plan_storage_limit?
    remaining_storage < NEAR_STORAGE_LIMIT_THRESHOLD
  end
  def exceeding_storage_limit?
    billed_bytes_used > plan.storage_limit
  end
  def exceeding_limits?
    exceeding_card_limit? || exceeding_storage_limit?
  end
  def reset_overridden_limits
    overridden_limits&.destroy
    reload_overridden_limits
  end
  private
    def remaining_cards_count
      plan.card_limit - billed_cards_count
    end
    def remaining_storage
      plan.storage_limit - billed_bytes_used
    end
end

================
File: saas/app/models/account/overridden_limits.rb
================
# To ease testing of limits
class Account::OverriddenLimits < SaasRecord
  belongs_to :account
end

================
File: saas/app/models/account/subscription.rb
================
class Account::Subscription < SaasRecord
  belongs_to :account
  enum :status, %w[ active past_due unpaid canceled incomplete incomplete_expired trialing paused ].index_by(&:itself)
  validates :plan_key, presence: true, inclusion: { in: Plan::PLANS.keys.map(&:to_s) }
  delegate :paid?, to: :plan
  def plan
    @plan ||= Plan.find(plan_key)
  end
  def plan=(plan)
    self.plan_key = plan.key
  end
  def to_be_canceled?
    active? && cancel_at.present?
  end
  def next_amount_due
    next_amount_due_in_cents ? next_amount_due_in_cents / 100.0 : plan.price
  end
  def pause
    if stripe_subscription_id.present?
      Stripe::Subscription.update(
        stripe_subscription_id,
        pause_collection: { behavior: "void" }
      )
    end
  end
  def resume
    if stripe_subscription_id.present?
      Stripe::Subscription.update(
        stripe_subscription_id,
        pause_collection: ""
      )
    end
  end
  def cancel
    Stripe::Subscription.cancel(stripe_subscription_id) if stripe_subscription_id.present?
  rescue Stripe::InvalidRequestError => e
    # Subscription already deleted/canceled in Stripe - treat as success
    Rails.logger.warn "Stripe subscription #{stripe_subscription_id} not found during cancel: #{e.message}"
  end
  def sync_customer_email_to_stripe
    if stripe_customer_id && (email = owner_email)
      Stripe::Customer.update(stripe_customer_id, email: email)
    end
  rescue Stripe::InvalidRequestError => e
    # Customer already deleted in Stripe - treat as success
    Rails.logger.warn "Stripe customer #{stripe_customer_id} not found during email sync: #{e.message}"
  end
  private
    # Account owner email for Stripe customer record. Returns nil when:
    # - No owner exists (ownership being transferred, account in limbo)
    # - Owner has no identity (deactivated user)
    def owner_email
      account.users.owner.first&.identity&.email_address
    end
end

================
File: saas/app/models/user/notifies_account_of_email_change.rb
================
module User::NotifiesAccountOfEmailChange
  extend ActiveSupport::Concern
  included do
    after_update :notify_account_of_owner_change, if: :account_owner_changed?
  end
  private
    # Account owner changed when:
    # - The current owner changed their email
    # - A user just became the owner (ownership transfer)
    def account_owner_changed?
      owner? && identity && (saved_change_to_identity_id? || became_owner?)
    end
    def became_owner?
      saved_change_to_role? && role_before_last_save != "owner"
    end
    def notify_account_of_owner_change
      account.owner_email_changed
    end
end

================
File: saas/app/models/plan.rb
================
class Plan
  PLANS = {
    free_v1: { name: "Free", price: 0, card_limit: 1000, storage_limit: 1.gigabytes },
    monthly_v1: { name: "Unlimited", price: 20, card_limit: Float::INFINITY, storage_limit: 5.gigabytes, stripe_price_id: ENV["STRIPE_MONTHLY_V1_PRICE_ID"] },
    monthly_extra_storage_v1: { name: "Unlimited + Extra Storage", price: 25, card_limit: Float::INFINITY, storage_limit: 500.gigabytes, stripe_price_id: ENV["STRIPE_MONTHLY_EXTRA_STORAGE_V1_PRICE_ID"] }
  }
  attr_reader :key, :name, :price, :card_limit, :storage_limit, :stripe_price_id
  class << self
    def all
      @all ||= PLANS.map { |key, properties| new(key: key, **properties) }
    end
    def free
      @free ||= find(:free_v1)
    end
    def paid
      @paid ||= find(:monthly_v1)
    end
    def paid_with_extra_storage
      @paid_with_extra_storage ||= find(:monthly_extra_storage_v1)
    end
    def find(key)
      @all_by_key ||= all.index_by(&:key).with_indifferent_access
      @all_by_key[key]
    end
    def find_by_price_id(price_id)
      all.find { |plan| plan.stripe_price_id == price_id }
    end
    alias [] find
  end
  def initialize(key:, name:, price:, card_limit:, storage_limit:, stripe_price_id: nil)
    @key = key
    @name = name
    @price = price
    @card_limit = card_limit
    @storage_limit = storage_limit
    @stripe_price_id = stripe_price_id
  end
  def free?
    price.zero?
  end
  def paid?
    !free?
  end
  def limit_cards?
    !card_limit.infinite?
  end
end

================
File: saas/app/models/saas_record.rb
================
class SaasRecord < ActiveRecord::Base
  self.abstract_class = true
  connects_to database: { writing: :saas, reading: :saas }
end

================
File: saas/app/models/subscription.rb
================
class Subscription < Queenbee::Subscription
  SHORT_NAMES = %w[ FreeV1 ]
  def self.short_name
    name.demodulize
  end
  class FreeV1 < Subscription
    property :proper_name,  "Free Subscription"
    property :price,        0
    property :frequency,    "yearly"
  end
end

================
File: saas/app/views/account/settings/_free_plan.html.erb
================
<h3 class="margin-block-start txt-large font-weight-black txt-tight-lines">
  <% if Current.account.exceeding_card_limit? && Current.account.exceeding_storage_limit? %>
    Youve used up your <u><%= number_with_delimiter(Plan.free.card_limit) %></u> free cards and all <u><%= storage_to_human_size(Plan.free.storage_limit) %></u> of free storage
  <% elsif Current.account.exceeding_card_limit? %>
    Youve used up your <u><%= number_with_delimiter(Plan.free.card_limit) %></u> free cards
  <% elsif Current.account.exceeding_storage_limit? %>
    Youve used up all <u><%= storage_to_human_size(Plan.free.storage_limit) %></u> of free storage
  <% else %>
    Youve used <u><%= Current.account.billed_cards_count %></u> free cards out of <%= number_with_delimiter(Plan.free.card_limit) %>
  <% end %>
</h3>

<p class="margin-block-start-half">To keep using Fizzy <%= "past #{ number_with_delimiter(Plan.free.card_limit) } cards," unless Current.account.exceeding_storage_limit? %> its only <strong><%= format_currency(Plan.paid.price) %>/month</strong> for <strong class="txt-nowrap">unlimited cards</strong>, <strong class="txt-nowrap">unlimited users</strong>, and <strong><%= storage_to_human_size(Plan.paid.storage_limit) %></strong> of storage.</p>

<%= button_to "Upgrade to #{Plan.paid.name} for #{ format_currency(Plan.paid.price) }/month", account_subscription_path, class: "btn settings-subscription__button txt-medium", form: { data: { turbo: false } } %>

<p>Cancel anytime, no contracts, take your data with you whenever.</p>
<p class="settings-subscription__footer txt-small margin-none-block-end">Right now youre on the <strong><%= Current.account.plan.name %></strong> plan which includes <%= number_with_delimiter(Plan.free.card_limit) %> cards, unlimited users, and <%= storage_to_human_size(Plan.free.storage_limit) %> of storage.</p>

================
File: saas/app/views/account/settings/_paid_plan.html.erb
================
<h3 class="margin-block-start txt-x-large font-weight-black txt-tight-lines">
  <% if Current.account.exceeding_storage_limit? %>
    Youve run out of storage
  <% elsif Current.account.nearing_plan_storage_limit? %>
    Youve used <strong><%= storage_to_human_size(Current.account.billed_bytes_used) %></strong> of storage
  <% else %>
    Thank you for buying Fizzy
  <% end %>
</h3>

<% if Current.account.nearing_plan_storage_limit? || Current.account.exceeding_storage_limit? %>
  <p class="margin-block-start-half">
    The <strong><%= Current.account.plan.name %></strong> plan includes <strong><%= storage_to_human_size(Plan.paid.storage_limit) %></strong>. Upgrade to get <strong><%= storage_to_human_size(Plan.paid_with_extra_storage.storage_limit) %></strong> extra storage for <%= format_currency(Plan.paid_with_extra_storage.price - Plan.paid.price) %>/month more.
  </p>

  <%= button_to "Upgrade to #{Plan.paid_with_extra_storage.name} for #{ number_to_currency(Plan.paid_with_extra_storage.price, strip_insignificant_zeros: true) }/month", account_subscription_upgrade_path, class: "btn settings-subscription__button txt-medium", form: { data: { turbo: false } } %>
<% end %>

<% if Current.account.subscription %>
  <%= render "account/settings/subscription", subscription: Current.account.subscription %>
<% end %>

================
File: saas/app/views/account/settings/_subscription_panel.html.erb
================
<% if Current.user.admin? && !Current.account.comped? %>
  <section class="panel panel--wide settings-subscription__panel shadow center margin-block-double">
    <h2 id="subscription" class="divider settings-subscription__divider txt-small txt-uppercase margin-none">Subscription</h2>

    <% if Current.account.plan.free? %>
      <%= render "account/settings/free_plan" %>
    <% else %>
      <%= render "account/settings/paid_plan" %>
    <% end %>
  </section>
<% end %>

================
File: saas/app/views/account/settings/_subscription.html.erb
================
<% if subscription.current_period_end %>
  <p class="margin-block-start-half"><%= subscription_period_end_action(subscription) %> <strong><%= subscription.current_period_end.to_date.to_fs(:long) %></strong></p>
<% end %>

<p>
  <%= link_to "Manage your subscription", account_billing_portal_path, class: "btn btn--plain settings-subscription__link txt-link", data: { turbo_prefetch: false } %>
</p>

<div class="settings-subscription__footer txt-small margin-block">
  Right now youre on the <strong><%= Current.account.plan.name %></strong> plan which includes unlimited cards, unlimited users, and <%= storage_to_human_size(Current.account.plan.storage_limit) %> of storage.

  <% if subscription.plan == Plan.paid && !(Current.account.nearing_plan_storage_limit? || Current.account.exceeding_storage_limit?) %>
    <%= button_to "Upgrade", account_subscription_upgrade_path, class: "btn btn--plain settings-subscription__link txt-link", form: { class: "flex-inline flex-wrap", data: { turbo: false } } %>
    to <%= storage_to_human_size(Plan.paid_with_extra_storage.storage_limit) %> storage for <%= format_currency(Plan.paid_with_extra_storage.price - Plan.paid.price) %>/month more.
  <% elsif subscription.plan == Plan.paid_with_extra_storage && !Current.account.exceeding_storage_limit? %>
    <%= button_to "Downgrade", account_subscription_downgrade_path, class: "btn btn--plain settings-subscription__link txt-link", form: { class: "flex-inline flex-wrap", data: { turbo: false } } %>
    to <%= storage_to_human_size(Plan.paid.storage_limit) %> storage.
  <% end %>
</div>

================
File: saas/app/views/account/subscriptions/notices/_admin_exceeding_card_limit.html.erb
================
<strong>Youve used your <u><%= Plan.free.card_limit %></u> free cards.</strong>
<%= link_to account_settings_path(anchor: "subscription"), class: "btn settings-subscription__button" do %>
  <span>Upgrade to Unlimited</span>
<% end %>

================
File: saas/app/views/account/subscriptions/notices/_admin_exceeding_storage_limit.html.erb
================
<strong>Youve run out of <%= Current.account.plan.free? ? "free storage" : "storage" %>.</strong>
<%= link_to account_settings_path(anchor: "subscription"), class: "btn settings-subscription__button" do %>
  <span>Upgrade to get more</span>
<% end %>

================
File: saas/app/views/account/subscriptions/notices/_user_exceeding_card_limit.html.erb
================
<div class="pad-inline pad-block-half">
  <strong>This account has used <u><%= Plan.free.card_limit %></u> free cards. Upgrade to get more.</strong>
</div>

================
File: saas/app/views/account/subscriptions/notices/_user_exceeding_storage_limit.html.erb
================
<div class="pad-inline pad-block-half">
  <strong>This account has run out of <%= Current.account.plan.free? ? "free storage" : "storage" %>. Upgrade to get more.</strong>
</div>

================
File: saas/app/views/account/subscriptions/_upgrade.html.erb
================
<div class="settings-subscription__notch card-perma__notch card-perma__notch--bottom">
  <% if Current.user.admin? %>
    <%= render "account/subscriptions/notices/admin_exceeding_card_limit" if Current.account.exceeding_card_limit? %>
    <%= render "account/subscriptions/notices/admin_exceeding_storage_limit" if Current.account.exceeding_storage_limit? %>
  <% else %>
    <%= render "account/subscriptions/notices/user_exceeding_card_limit" if Current.account.exceeding_card_limit? %>
    <%= render "account/subscriptions/notices/user_exceeding_storage_limit" if Current.account.exceeding_storage_limit? %>
  <% end %>
</div>

================
File: saas/app/views/account/subscriptions/show.html.erb
================
<% @page_title = "Thank you" %>

<% if @stripe_session&.payment_status == "paid" %>
  <section class="panel panel--wide panel--centered center borderless">
    <h1 class="txt-x-large font-weight-black margin-none">Thanks for buying Fizzy!</h1>
    <p class="txt-medium margin-none-block-start">Your payment was successful. Youre now on the <strong><%= Current.account.plan.name %></strong> plan.</p>
    <%= link_to "Done", account_settings_path, class: "btn settings-subscription__button txt-medium" %>
  </section>
<% end %>

================
File: saas/app/views/admin/accounts/edit.html.erb
================
<% @page_title = "Account admin" %>

<% content_for :header do %>
  <div class="header__actions header__actions--start">
    <%= back_link_to "Accounts", saas.admin_accounts_path, "keydown.left@document->hotkey#click keydown.esc@document->hotkey#click" %>
  </div>
<% end %>


<div class="panel panel--wide shadow center">
  <div class="flex flex-column gap txt-medium">
    <h1 class="txt-x-large font-weight-black margin-none">Edit Account <%= @account.external_account_id %></h1>

    <%= form_with model: @account, url: saas.admin_account_path(@account.external_account_id), class: "flex flex-column gap" do |form| %>
      <table class="txt-align-start">
        <tr>
          <td class="txt-subtle">Account Name:</td>
          <td class="margin-inline-start-none"><%= @account.name %></td>
        </tr>
        <tr>
          <td class="txt-subtle">Subscription plan:</td>
          <td class="margin-inline-start-none"><%= @account.plan.name %></td>
        </tr>
        <tr>
          <td class="txt-subtle">Actual card count:</td>
          <td class="margin-inline-start-none"><%= @account.cards_count %> cards </td>
        </tr>
        <tr>
          <td class="txt-subtle">Actual bytes used:</td>
          <td class="margin-inline-start-none"><%= storage_to_human_size(@account.bytes_used) %></td>
        </tr>
        <tr>
          <td>
            <%= form.label :card_count, class: "txt-subtle" do %>
              <span>Override card count</span><br><%= "(Exceeds plan limit)" if @account.exceeding_card_limit? %>
            <% end %>
          </td>
          <td><%= form.number_field :card_count, value: @account.overridden_limits&.card_count, class: "input" %></td>
        </tr>
        <tr>
          <td>
            <%= form.label :bytes_used, class: "txt-subtle" do %>
              <span>Override bytes used</span><br><%= "(Exceeds plan limit)" if @account.exceeding_storage_limit? %>
            <% end %>
          </td>
          <td><%= form.number_field :bytes_used, value: @account.overridden_limits&.bytes_used, class: "input" %></td>
        </tr>
      </table>

      <button type="submit" class="btn btn--link full-width">Save changes</button>
    <% end %>

    <% if @account.overridden_limits %>
      <%= button_to "Reset limits", saas.admin_account_overridden_limits_path(@account.external_account_id), method: :delete, class: "btn btn--negative full-width" %>
    <% end %>

    <% if @account.comped? %>
      <%= button_to "Uncomp account", saas.admin_account_billing_waiver_path(@account.external_account_id), method: :delete, class: "btn btn--plain txt-negative txt-underline" %>
    <% else %>
      <%= button_to "Comp account", saas.admin_account_billing_waiver_path(@account.external_account_id), method: :post, class: "btn btn--plain txt-positive txt-underline" %>
    <% end %>
  </div>
</div>

================
File: saas/app/views/admin/accounts/index.html.erb
================
<div class="panel panel--centered">
  <div class="flex flex-column gap txt-medium">
    <h1 class="txt-x-large font-weight-black margin-none">Find an account</h1>

    <%= form_with url: saas.admin_account_search_path, class: "flex flex-column gap" do |form| %>
      <%= form.text_field :q, placeholder: "Account ID", autofocus: true, class: "input" %>
      <%= form.submit "Search", class: "btn btn--link" %>
    <% end %>
  </div>
</div>

================
File: saas/app/views/admin/stats/show.html.erb
================
<% @page_title = "Account Statistics" %>

<% content_for :header do %>
  <h1 class="header__title"><%= @page_title %></h1>
<% end %>

<section class="settings">
  <div class="settings__panel panel shadow">
    <div class="flex flex-column gap margin-block-half">
      <div class="flex flex-column gap-half">
        <header>
          <h2 class="divider txt-medium margin-block-start">Accounts Created</h2>
        </header>
        <div class="flex gap-half">
          <div class="flex flex-column gap-quarter flex-item-grow">
            <div class="txt-x-small">Total</div>
            <div class="txt-large">
              <strong><%= @accounts_total %></strong>
            </div>
          </div>
          <div class="flex flex-column gap-quarter flex-item-grow">
            <div class="txt-x-small">7 days</div>
            <div class="txt-large">
              <strong><%= @accounts_last_7_days %></strong>
            </div>
          </div>
          <div class="flex flex-column gap-quarter flex-item-grow">
            <div class="txt-x-small">24 hours</div>
            <div class="txt-large">
              <strong><%= @accounts_last_24_hours %></strong>
            </div>
          </div>
        </div>
      </div>

      <div class="flex flex-column gap-half">
        <header>
          <h2 class="divider txt-medium margin-block-start">Accounts Subscribed</h2>
        </header>
        <div class="flex gap-half">
          <div class="flex flex-column gap-quarter flex-item-grow">
            <div class="txt-x-small">Total</div>
            <div class="txt-large">
              <strong><%= @paid_accounts_total %></strong>
            </div>
          </div>
          <div class="flex flex-column gap-quarter flex-item-grow">
            <div class="txt-x-small">7 days</div>
            <div class="txt-large">
              <strong><%= @paid_accounts_last_7_days %></strong>
            </div>
          </div>
          <div class="flex flex-column gap-quarter flex-item-grow">
            <div class="txt-x-small">24 hours</div>
            <div class="txt-large">
              <strong><%= @paid_accounts_last_24_hours %></strong>
            </div>
          </div>
        </div>
      </div>

      <div class="flex flex-column gap-half">
        <header>
          <h2 class="divider txt-medium margin-block-start">Identities Created</h2>
        </header>
        <div class="flex gap-half">
          <div class="flex flex-column gap-quarter flex-item-grow">
            <div class="txt-x-small">Total</div>
            <div class="txt-large">
              <strong><%= @identities_total %></strong>
            </div>
          </div>
          <div class="flex flex-column gap-quarter flex-item-grow">
            <div class="txt-x-small">7 days</div>
            <div class="txt-large">
              <strong><%= @identities_last_7_days %></strong>
            </div>
          </div>
          <div class="flex flex-column gap-quarter flex-item-grow">
            <div class="txt-x-small">24 hours</div>
            <div class="txt-large">
              <strong><%= @identities_last_24_hours %></strong>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="settings__panel panel shadow">
    <header>
      <h2 class="divider txt-medium margin-block-start">
        10 Most Recent Signups
      </h2>
    </header>

    <ul class="margin-block-half">
      <% @recent_accounts.each do |account| %>
        <% admin_user = account.users.owner.first %>
        <li class="flex align-start gap-half margin-block-start-half">
          <div
            class="flex-item-grow min-width overflow-ellipsis"
            style="text-align: left"
          >
            <strong><%= account.name %></strong>
            <br>
            <span class="txt-x-small txt-ink-medium">
              #<%= account.external_account_id %> 
              <%= admin_user&.identity&.email_address || "No admin" %>
            </span>
          </div>

          <div class="txt-medium txt-ink-medium" style="text-align: right">
            <%= time_ago_in_words(account.created_at) %> ago
          </div>
        </li>
      <% end %>
    </ul>
  </div>

  <div class="settings__panel panel shadow">
    <header>
      <h2 class="divider txt-medium margin-block-start">
        Top 20 Accounts by Card Count
      </h2>
    </header>

    <ul class="margin-block-half">
      <% @top_accounts.each do |account| %>
        <% admin_user = account.users.owner.first %>
        <li class="flex align-start gap-half margin-block-start-half">
          <div
            class="flex-item-grow min-width overflow-ellipsis"
            style="text-align: left"
          >
            <strong><%= account.name %></strong>
            <br>
            <span class="txt-x-small txt-ink-medium">
              #<%= account.external_account_id %> 
              <%= admin_user&.identity&.email_address || "No admin" %>
            </span>
          </div>

          <div class="txt-medium">
            <strong><%= number_with_delimiter(account.cards_count) %></strong>
            <span class="txt-x-small txt-ink-medium">cards</span>
          </div>
        </li>
      <% end %>
    </ul>
  </div>
</section>

================
File: saas/app/views/cards/container/footer/saas/notices/_admin_nearing_card_limit.html.erb
================
Youve used <%= Current.account.billed_cards_count %> out of <%= Plan.free.card_limit %> free cards. <strong><%= link_to "Upgrade to unlimited", account_settings_path(anchor: "subscription") %></strong>.

================
File: saas/app/views/cards/container/footer/saas/notices/_admin_nearing_storage_limit.html.erb
================
Youve used <%= storage_to_human_size(Current.account.billed_bytes_used) %> out of <%= storage_to_human_size(Current.account.plan.storage_limit) %> <%= Current.account.plan.free? ? "free storage" : "storage" %>. <strong><%= link_to "Upgrade to get more", account_settings_path(anchor: "subscription") %></strong>.

================
File: saas/app/views/cards/container/footer/saas/notices/_user_nearing_card_limit.html.erb
================
This account has used <%= Current.account.billed_cards_count %> out of <%= Plan.free.card_limit %> free cards. Upgrade soon.

================
File: saas/app/views/cards/container/footer/saas/notices/_user_nearing_storage_limit.html.erb
================
This account has used <%= storage_to_human_size(Current.account.billed_bytes_used) %> out of <%= storage_to_human_size(Current.account.plan.storage_limit) %> <%= Current.account.plan.free? ? "free storage" : "storage" %>. Upgrade soon.

================
File: saas/app/views/cards/container/footer/saas/_create.html.erb
================
<% if Current.account.exceeding_limits? %>
  <%= render "account/subscriptions/upgrade" %>
<% else %>
  <%= render "cards/container/footer/create", card: card %>
<% end %>

================
File: saas/app/views/cards/container/footer/saas/_near_notice.html.erb
================
<div class="settings_subscription__warning full-width pad-inline center margin-block-half">
  <% if Current.user.admin? %>
    <%= render "cards/container/footer/saas/notices/admin_nearing_card_limit" if Current.account.nearing_plan_cards_limit? %>
    <%= render "cards/container/footer/saas/notices/admin_nearing_storage_limit" if Current.account.nearing_plan_storage_limit? %>
  <% else %>
    <%= render "cards/container/footer/saas/notices/user_nearing_card_limit" if Current.account.nearing_plan_cards_limit? %>
    <%= render "cards/container/footer/saas/notices/user_nearing_storage_limit" if Current.account.nearing_plan_storage_limit? %>
  <% end %>
</div>

================
File: saas/app/views/layouts/fizzy/saas/application.html.erb
================
<!DOCTYPE html>
<html>
<head>
  <title>Fizzy saas</title>
  <%= csrf_meta_tags %>
  <%= csp_meta_tag %>

  <%= yield :head %>

  <%= stylesheet_link_tag    "fizzy/saas/application", media: "all" %>
</head>
<body>

<%= yield %>

</body>
</html>

================
File: saas/app/views/signup/completions/new.html.erb
================
<% @page_title = "Complete your sign-up" %>

<div class="panel panel--centered flex flex-column gap-half <%= "shake" if flash[:alert] %>">
  <h1 class="txt-x-large font-weight-black margin-block-end"><%= @page_title %></h1>

  <%= form_with model: @signup, url: saas.signup_completion_path, scope: "signup", class: "flex flex-column gap", data: { controller: "form" } do |form| %>
    <%= form.text_field :full_name, class: "input txt-large", autocomplete: "name", placeholder: "Enter your full name", autofocus: true, required: true %>

    <p>Youre one step away. Just enter your name to get your own Fizzy account.</p>

    <% if @signup.errors.any? %>
      <div class="margin-block-half">
        <ul class="margin-block-none txt-negative txt-small">
          <% @signup.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <button type="submit" class="btn btn--link center" data-form-target="submit">
      <span>Continue</span>
      <%= icon_tag "arrow-right" %>
    </button>
  <% end %>
</div>

<% content_for :footer do %>
  <%= render "sessions/footer" %>
<% end %>

================
File: saas/app/views/signup/new.html.erb
================
<% @page_title = "Sign up for Fizzy" %>

<div class="panel panel--centered flex flex-column gap-half <%= "shake" if flash[:alert] %>">
  <h1 class="txt-xx-large margin-block-end-double">Sign up</h1>

  <%= form_with model: @signup, url: saas.signup_path, scope: "signup", class: "flex flex-column gap", data: { turbo: false, controller: "form" } do |form| %>
    <%= form.email_field :email_address, class: "input", autocomplete: "username", placeholder: "Email address", required: true %>

    <% if @signup.errors.any? %>
      <div class="margin-block-half">
        <ul class="margin-block-none txt-negative txt-small">
          <% @signup.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <button type="submit" class="btn btn--link center" data-form-target="submit">
      <span>Continue</span>
      <%= icon_tag "arrow-right" %>
    </button>
  <% end %>
</div>

<% content_for :footer do %>
  <%= render "sessions/footer" %>
<% end %>

================
File: saas/bin/broadcast_to_bc
================
#!/usr/bin/env bash

url=$(op read "op://Deploy/Deploy Chatbot/url" --account 23QPQDKZC5BKBIIG7UGT5GR5RM)
curl -s -d content="[Fizzy] ${1}" "${url}"

================
File: saas/bin/rails
================
#!/usr/bin/env ruby
# This command will automatically be run when you run "rails" with Rails gems
# installed from the root of your application.

ENGINE_ROOT = File.expand_path("..", __dir__)
ENGINE_PATH = File.expand_path("../lib/fizzy/saas/engine", __dir__)
APP_PATH = File.expand_path("../test/dummy/config/application", __dir__)

# Set up gems listed in the Gemfile.
ENV["BUNDLE_GEMFILE"] ||= File.expand_path("../Gemfile", __dir__)
require "bundler/setup" if File.exist?(ENV["BUNDLE_GEMFILE"])

require "rails/all"
require "rails/engine/commands"

================
File: saas/bin/rubocop
================
#!/usr/bin/env ruby
require "rubygems"
require "bundler/setup"

# explicit rubocop config increases performance slightly while avoiding config confusion.
ARGV.unshift("--config", File.expand_path("../.rubocop.yml", __dir__))

load Gem.bin_path("rubocop", "rubocop")

================
File: saas/bin/setup
================
#!/usr/bin/env bash
set -eo pipefail

# SaaS-specific setup tasks
# This script is called from the main Fizzy bin/setup when SAAS is enabled

if [ -e tmp/minio-dev.txt ]; then
  step "Starting Docker services" bash -c "[ -d ~/Work/basecamp/docker-dev ] && git -C ~/Work/basecamp/docker-dev pull || gh repo clone basecamp/docker-dev ~/Work/basecamp/docker-dev && ~/Work/basecamp/docker-dev/setup minio"
  step "Configuring MinIO" bin/minio-setup
fi

step "Starting mysql" bash -c "[ -d ~/Work/basecamp/docker-dev ] && git -C ~/Work/basecamp/docker-dev pull || gh repo clone basecamp/docker-dev ~/Work/basecamp/docker-dev && ~/Work/basecamp/docker-dev/setup mysql80"

================
File: saas/config/environments/beta.rb
================
require_relative "production"
Rails.application.configure do
  config.action_mailer.smtp_settings[:domain] = ENV.fetch("APP_FQDN", "fizzy-beta.com")
  config.action_mailer.smtp_settings[:address] = "smtp-outbound-staging"
  config.action_mailer.default_url_options     = { host: ENV.fetch("APP_FQDN", "fizzy-beta.com"), protocol: "https" }
  config.action_controller.default_url_options = { host: ENV.fetch("APP_FQDN", "fizzy-beta.com"), protocol: "https" }
end

================
File: saas/config/environments/development.rb
================
Rails.application.configure do
  # SaaS version of Fizzy is multi-tenanted
  config.x.multi_tenant.enabled = true
  if Rails.root.join("tmp/structured-logging.txt").exist?
    config.structured_logging.logger = ActiveSupport::Logger.new("log/structured-development.log")
  end
  if Rails.root.join("tmp/solid-queue.txt").exist?
    config.active_job.queue_adapter = :solid_queue
    config.solid_queue.connects_to = { database: { writing: :queue, reading: :queue } }
  end
end

================
File: saas/config/environments/production.rb
================
Rails.application.configure do
  config.active_storage.service = :purestorage
  # Enable structured logging
  config.structured_logging.logger = ActiveSupport::Logger.new(STDOUT)
  config.action_controller.default_url_options = { host: "app.fizzy.do", protocol: "https" }
  config.action_mailer.default_url_options     = { host: "app.fizzy.do", protocol: "https" }
  config.action_mailer.smtp_settings = { domain: "app.fizzy.do", address: "smtp-outbound", port: 25, enable_starttls_auto: false }
  # SaaS version of Fizzy is multi-tenanted
  config.x.multi_tenant.enabled = true
  # Content Security Policy
  config.x.content_security_policy.report_only = false
  config.x.content_security_policy.report_uri = "https://o33603.ingest.us.sentry.io/api/4510481339187200/security/?sentry_key=9f126ba30d5f703451a13a2929bb5a10" # gitleaks:allow (public DSN for CSP reports)
  config.x.content_security_policy.script_src = "https://challenges.cloudflare.com"
  config.x.content_security_policy.frame_src = "https://challenges.cloudflare.com"
  config.x.content_security_policy.connect_src = "https://storage.basecamp.com"
end

================
File: saas/config/environments/staging.rb
================
require_relative "production"
Rails.application.configure do
  config.action_mailer.smtp_settings[:domain] = "app.fizzy-staging.com"
  config.action_mailer.smtp_settings[:address] = "smtp-outbound-staging"
  config.action_mailer.default_url_options     = { host: "app.fizzy-staging.com", protocol: "https" }
  config.action_controller.default_url_options = { host: "app.fizzy-staging.com", protocol: "https" }
end

================
File: saas/config/database.yml
================
<%
  if ENV["MIGRATE"].present?
    mysql_app_user_key = "MYSQL_ALTER_USER"
    mysql_app_password_key = "MYSQL_ALTER_PASSWORD"
    max_execution_time_ms = 0 # No limit
  else
    mysql_app_user_key = "MYSQL_APP_USER"
    mysql_app_password_key = "MYSQL_APP_PASSWORD"
    max_execution_time_ms = 5_000
  end
  mysql_app_user = ENV[mysql_app_user_key]
  mysql_app_password = ENV[mysql_app_password_key]
  gem_path = Gem::Specification.find_by_name("fizzy-saas").gem_dir
%>
default: &default
  adapter: trilogy
  host: <%= ENV.fetch "FIZZY_DB_HOST", "127.0.0.1" %>
  port: <%= ENV.fetch "FIZZY_DB_PORT", 3306 %>
  pool: 50
  timeout: 5000
  variables:
    transaction_isolation: READ-COMMITTED
    max_execution_time: <%= max_execution_time_ms %>
development:
  primary:
    <<: *default
    database: fizzy_development
    port: <%= ENV.fetch "FIZZY_DB_PORT", 33380 %>
  replica:
    <<: *default
    database: fizzy_development
    port: <%= ENV.fetch "FIZZY_DB_PORT", 33380 %>
    replica: true
  cable:
    <<: *default
    database: development_cable
    port: <%= ENV.fetch "FIZZY_DB_PORT", 33380 %>
    migrations_paths: db/cable_migrate
  cache:
    <<: *default
    database: development_cache
    port: <%= ENV.fetch "FIZZY_DB_PORT", 33380 %>
    migrations_paths: db/cache_migrate
  queue:
    <<: *default
    database: development_queue
    port: <%= ENV.fetch "FIZZY_DB_PORT", 33380 %>
    migrations_paths: db/queue_migrate
  saas:
    <<: *default
    database: fizzy_saas_development
    port: <%= ENV.fetch "FIZZY_DB_PORT", 33380 %>
    migrations_paths: <%= File.join(gem_path, "db", "migrate") %>
    schema_dump: <%= File.join(gem_path, "db", "saas_schema.rb") %>
# Warning: The database defined as "test" will be erased and
# re-generated from your development database when you run "rake".
# Do not set this db to the same as development or production.
test:
  primary:
    <<: *default
    database: fizzy_test
    port: <%= ENV.fetch "FIZZY_DB_PORT", 33380 %>
  replica:
    <<: *default
    database: fizzy_test
    port: <%= ENV.fetch "FIZZY_DB_PORT", 33380 %>
    replica: true
  saas:
    <<: *default
    database: fizzy_saas_test
    port: <%= ENV.fetch "FIZZY_DB_PORT", 33380 %>
    migrations_paths: <%= File.join(gem_path, "db", "migrate") %>
    schema_dump: <%= File.join(gem_path, "db", "saas_schema.rb") %>
production: &production
  primary:
    <<: *default
    database: fizzy_production
    host: <%= ENV["MYSQL_DATABASE_HOST"] %>
    username: <%= mysql_app_user %>
    password: <%= mysql_app_password %>
  replica:
    <<: *default
    database: fizzy_production
    host: <%= ENV["MYSQL_DATABASE_REPLICA_HOST"] %>
    username: <%= ENV["MYSQL_READONLY_USER"] %>
    password: <%= ENV["MYSQL_READONLY_PASSWORD"] %>
    replica: true
  cable:
    <<: *default
    database: fizzy_solidcable_production
    host: <%= ENV["MYSQL_SOLID_CABLE_HOST"] %>
    username: <%= mysql_app_user %>
    password: <%= mysql_app_password %>
    migrations_paths: db/cable_migrate
  queue:
    <<: *default
    database: fizzy_solidqueue_production
    host: <%= ENV["MYSQL_SOLID_QUEUE_HOST"] %>
    username: <%= mysql_app_user %>
    password: <%= mysql_app_password %>
    migrations_paths: db/queue_migrate
  cache:
    <<: *default
    database: fizzy_solidcache_production
    host: <%= ENV["MYSQL_SOLID_CACHE_HOST"] %>
    username: <%= mysql_app_user %>
    password: <%= mysql_app_password %>
    migrations_paths: db/cache_migrate
  saas:
    <<: *default
    database: fizzy_saas_production
    host: <%= ENV["MYSQL_DATABASE_HOST"] %>
    username: <%= mysql_app_user %>
    password: <%= mysql_app_password %>
    migrations_paths: <%= File.join(gem_path, "db", "migrate") %>
    schema_dump: <%= File.join(gem_path, "db", "saas_schema.rb") %>
beta: *production
staging: *production

================
File: saas/config/deploy.beta.yml
================
<%
  raise "The BETA_NUMBER environment variable must be given" unless ENV["BETA_NUMBER"]
  @data = {
    "1" => {
      "hosts" => {
        "web" => ["fizzy-beta-app-101.df-iad-int.37signals.com"],
        "jobs" => ["fizzy-beta-jobs-101.df-iad-int.37signals.com"],
        "lb" => "fizzy-beta-lb-101.df-iad-int.37signals.com"
      },
      "dbs" => {
        "solidqueue" => "fizzy-beta-solidqueue-db-101.df-iad-int.37signals.com"
      }
    },
    "2" => {
      "hosts" => {
        "web" => ["fizzy-beta-app-102.df-iad-int.37signals.com"],
        "jobs" => ["fizzy-beta-jobs-102.df-iad-int.37signals.com"],
        "lb" => "fizzy-beta-lb-102.df-iad-int.37signals.com"
      },
      "dbs" => {
        "solidqueue" => "fizzy-beta-solidqueue-db-102.df-iad-int.37signals.com"
      }
    },
    "3" => {
      "hosts" => {
        "web" => ["fizzy-beta-app-103.df-iad-int.37signals.com"],
        "jobs" => ["fizzy-beta-jobs-103.df-iad-int.37signals.com"],
        "lb" => "fizzy-beta-lb-103.df-iad-int.37signals.com"
      },
      "dbs" => {
        "solidqueue" => "fizzy-beta-solidqueue-db-103.df-iad-int.37signals.com"
      }
    },
    "4" => {
      "hosts" => {
        "web" => ["fizzy-beta-app-104.df-iad-int.37signals.com"],
        "jobs" => ["fizzy-beta-jobs-104.df-iad-int.37signals.com"],
        "lb" => "fizzy-beta-lb-104.df-iad-int.37signals.com"
      },
      "dbs" => {
        "solidqueue" => "fizzy-beta-solidqueue-db-104.df-iad-int.37signals.com"
      }
    }
  }
  @beta_number = ENV["BETA_NUMBER"]
  raise "Beta #{@beta_number} doesn't appear to be defined" unless @data[@beta_number]
  @web_hosts = @data[@beta_number]["hosts"]["web"]
  @job_hosts = @data[@beta_number]["hosts"]["jobs"]
  @lb_host = @data[@beta_number]["hosts"]["lb"]
  @solidqueue_db = @data[@beta_number]["dbs"]["solidqueue"]
%>
retain_containers: 1
servers:
  web:
    hosts:
      - <%= @web_hosts[0] %>: df_iad
    labels:
      otel_scrape_enabled: true
  jobs:
    hosts:
      - <%= @job_hosts[0] %>: df_iad
    labels:
      otel_scrape_enabled: true
proxy:
  ssl: false
ssh:
  user: app
env:
  clear:
    APP_FQDN: beta<%= @beta_number %>.fizzy-beta.com
    CACHE_NAMESPACE: <%= @beta_number %>
    RAILS_ENV: beta
    RAILS_LOG_LEVEL: fatal # suppress unstructured log lines
    MYSQL_DATABASE_HOST: fizzy-mysql-primary
    MYSQL_DATABASE_REPLICA_HOST: fizzy-mysql-replica
    MYSQL_SOLID_CABLE_HOST: fizzy-mysql-primary
    MYSQL_SOLID_QUEUE_HOST: <%= @solidqueue_db %>
    MYSQL_SOLID_CACHE_HOST: fizzy-beta-solidcache-db-101.df-iad-int.37signals.com
  secret:
    - RAILS_MASTER_KEY
    - MYSQL_ALTER_PASSWORD
    - MYSQL_ALTER_USER
    - MYSQL_APP_PASSWORD
    - MYSQL_APP_USER
    - MYSQL_READONLY_PASSWORD
    - MYSQL_READONLY_USER
    - SECRET_KEY_BASE
    - VAPID_PUBLIC_KEY
    - VAPID_PRIVATE_KEY
    - ACTIVE_STORAGE_ACCESS_KEY_ID
    - ACTIVE_STORAGE_SECRET_ACCESS_KEY
    - QUEENBEE_API_TOKEN
    - SIGNAL_ID_SECRET
    - SENTRY_DSN
    - ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY
    - ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY
    - ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT
    - STRIPE_MONTHLY_V1_PRICE_ID
    - STRIPE_MONTHLY_EXTRA_STORAGE_V1_PRICE_ID
    - STRIPE_SECRET_KEY
    - STRIPE_WEBHOOK_SECRET
  tags:
    df_iad:
      PRIMARY_DATACENTER: true
accessories:
  load-balancer:
    image: basecamp/kamal-proxy:lb
    host: <%= @lb_host %>
    labels:
      otel_role: load-balancer
      otel_service: fizzy-load-balancer
      otel_scrape_enabled: true
    options:
      publish:
        - 80:80
        - 443:443
    volumes:
      - load-balancer:/home/kamal-proxy/.config/kamal-proxy

================
File: saas/config/deploy.beta1.yml
================
<% ENV["BETA_NUMBER"] = "1" %>
<%= ERB.new(File.read(File.join(Gem::Specification.find_by_name("fizzy-saas").gem_dir, "config", "deploy.beta.yml")), trim_mode: 2).result %>

================
File: saas/config/deploy.beta2.yml
================
<% ENV["BETA_NUMBER"] = "2" %>
<%= ERB.new(File.read(File.join(Gem::Specification.find_by_name("fizzy-saas").gem_dir, "config", "deploy.beta.yml")), trim_mode: 2).result %>

================
File: saas/config/deploy.beta3.yml
================
<% ENV["BETA_NUMBER"] = "3" %>
<%= ERB.new(File.read(File.join(Gem::Specification.find_by_name("fizzy-saas").gem_dir, "config", "deploy.beta.yml")), trim_mode: 2).result %>

================
File: saas/config/deploy.beta4.yml
================
<% ENV["BETA_NUMBER"] = "4" %>
<%= ERB.new(File.read(File.join(Gem::Specification.find_by_name("fizzy-saas").gem_dir, "config", "deploy.beta.yml")), trim_mode: 2).result %>

================
File: saas/config/deploy.production.yml
================
retain_containers: 2
servers:
  web:
    hosts:
      - fizzy-app-01.sc-chi-int.37signals.com: sc_chi
      - fizzy-app-02.sc-chi-int.37signals.com: sc_chi
      - fizzy-app-101.df-iad-int.37signals.com: df_iad
      - fizzy-app-102.df-iad-int.37signals.com: df_iad
      - fizzy-app-401.df-ams-int.37signals.com: df_ams
      - fizzy-app-402.df-ams-int.37signals.com: df_ams
    labels:
      otel_scrape_enabled: true
  jobs:
    hosts:
      - fizzy-jobs-101.df-iad-int.37signals.com: df_iad
      - fizzy-jobs-102.df-iad-int.37signals.com: df_iad
    labels:
      otel_scrape_enabled: true
proxy:
  ssl: false
ssh:
  user: app
env:
  clear:
    RAILS_ENV: production
    RAILS_LOG_LEVEL: fatal # suppress unstructured log lines
    MYSQL_DATABASE_HOST: fizzy-mysql-primary
    MYSQL_DATABASE_REPLICA_HOST: fizzy-mysql-replica
    MYSQL_SOLID_CABLE_HOST: fizzy-mysql-primary
    MYSQL_SOLID_QUEUE_HOST: fizzy-mysql-primary
  secret:
    - RAILS_MASTER_KEY
    - MYSQL_ALTER_PASSWORD
    - MYSQL_ALTER_USER
    - MYSQL_APP_PASSWORD
    - MYSQL_APP_USER
    - MYSQL_READONLY_PASSWORD
    - MYSQL_READONLY_USER
    - SECRET_KEY_BASE
    - VAPID_PUBLIC_KEY
    - VAPID_PRIVATE_KEY
    - ACTIVE_STORAGE_ACCESS_KEY_ID
    - ACTIVE_STORAGE_SECRET_ACCESS_KEY
    - QUEENBEE_API_TOKEN
    - SIGNAL_ID_SECRET
    - SENTRY_DSN
    - ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY
    - ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY
    - ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT
    - STRIPE_MONTHLY_V1_PRICE_ID
    - STRIPE_MONTHLY_EXTRA_STORAGE_V1_PRICE_ID
    - STRIPE_SECRET_KEY
    - STRIPE_WEBHOOK_SECRET
  tags:
    sc_chi:
      MYSQL_SOLID_CACHE_HOST: fizzy-solidcache-db-01.sc-chi-int.37signals.com
    df_iad:
      MYSQL_SOLID_CACHE_HOST: fizzy-solidcache-db-101.df-iad-int.37signals.com
      PRIMARY_DATACENTER: true
    df_ams:
      MYSQL_SOLID_CACHE_HOST: fizzy-solidcache-db-401.df-ams-int.37signals.com
accessories:
  load-balancer:
    image: basecamp/kamal-proxy:lb
    hosts:
      - fizzy-lb-101.df-iad-int.37signals.com
      - fizzy-lb-102.df-iad-int.37signals.com
      - fizzy-lb-01.sc-chi-int.37signals.com
      - fizzy-lb-02.sc-chi-int.37signals.com
      - fizzy-lb-401.df-ams-int.37signals.com
      - fizzy-lb-402.df-ams-int.37signals.com
    labels:
      otel_role: load-balancer
      otel_service: fizzy-load-balancer
      otel_scrape_enabled: true
    options:
      publish:
        - 80:80
        - 443:443
      # NFS mount for certificates
      # See https://3.basecamp.com/2914079/buckets/37331921/todos/9180260061
      mount: type=volume,src=certificates,dst=/certificates,volume-driver=local,volume-opt=type=nfs,volume-opt=device=:/fizzy-production-certificates,"volume-opt=o=addr=purestorage.sc-chi-int.37signals.com,nfsvers=3,rw,noatime,nconnect=8,soft,timeo=30,retrans=2"
    volumes:
      - load-balancer:/home/kamal-proxy/.config/kamal-proxy

================
File: saas/config/deploy.staging.yml
================
retain_containers: 1
servers:
  web:
    hosts:
      - fizzy-staging-app-101.df-iad-int.37signals.com: df_iad
      - fizzy-staging-app-102.df-iad-int.37signals.com: df_iad
      - fizzy-staging-app-01.sc-chi-int.37signals.com: sc_chi
      - fizzy-staging-app-02.sc-chi-int.37signals.com: sc_chi
      - fizzy-staging-app-401.df-ams-int.37signals.com: df_ams
      - fizzy-staging-app-402.df-ams-int.37signals.com: df_ams
    labels:
      otel_scrape_enabled: true
  jobs:
    hosts:
      - fizzy-staging-jobs-101.df-iad-int.37signals.com: df_iad
      - fizzy-staging-jobs-102.df-iad-int.37signals.com: df_iad
    labels:
      otel_scrape_enabled: true
proxy:
  ssl: false
ssh:
  user: app
env:
  clear:
    RAILS_ENV: staging
    RAILS_LOG_LEVEL: fatal # suppress unstructured log lines
    MYSQL_DATABASE_HOST: fizzy-staging-mysql-primary
    MYSQL_DATABASE_REPLICA_HOST: fizzy-staging-mysql-replica
    MYSQL_SOLID_CABLE_HOST: fizzy-staging-mysql-primary
    MYSQL_SOLID_QUEUE_HOST: fizzy-staging-mysql-primary
  secret:
    - RAILS_MASTER_KEY
    - MYSQL_ALTER_PASSWORD
    - MYSQL_ALTER_USER
    - MYSQL_APP_PASSWORD
    - MYSQL_APP_USER
    - MYSQL_READONLY_PASSWORD
    - MYSQL_READONLY_USER
    - SECRET_KEY_BASE
    - VAPID_PUBLIC_KEY
    - VAPID_PRIVATE_KEY
    - ACTIVE_STORAGE_ACCESS_KEY_ID
    - ACTIVE_STORAGE_SECRET_ACCESS_KEY
    - QUEENBEE_API_TOKEN
    - SIGNAL_ID_SECRET
    - SENTRY_DSN
    - ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY
    - ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY
    - ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT
    - STRIPE_MONTHLY_V1_PRICE_ID
    - STRIPE_MONTHLY_EXTRA_STORAGE_V1_PRICE_ID
    - STRIPE_SECRET_KEY
    - STRIPE_WEBHOOK_SECRET
  tags:
    sc_chi:
      MYSQL_SOLID_CACHE_HOST: fizzy-staging-solidcache-db-01.sc-chi-int.37signals.com
    df_iad:
      MYSQL_SOLID_CACHE_HOST: fizzy-staging-solidcache-db-101.df-iad-int.37signals.com
      PRIMARY_DATACENTER: true
    df_ams:
      MYSQL_SOLID_CACHE_HOST: fizzy-staging-solidcache-db-401.df-ams-int.37signals.com
accessories:
  load-balancer:
    image: basecamp/kamal-proxy:lb
    hosts:
      - fizzy-staging-lb-01.sc-chi-int.37signals.com
      - fizzy-staging-lb-101.df-iad-int.37signals.com
      - fizzy-staging-lb-401.df-ams-int.37signals.com
    labels:
      otel_role: load-balancer
      otel_service: fizzy-load-balancer
      otel_scrape_enabled: true
    options:
      publish:
        - 80:80
        - 443:443
      # NFS mount for certificates
      # See https://3.basecamp.com/2914079/buckets/37331921/todos/9180260061
      mount: type=volume,src=certificates,dst=/certificates,volume-driver=local,volume-opt=type=nfs,volume-opt=device=:/fizzy-staging-certificates,"volume-opt=o=addr=purestorage.sc-chi-int.37signals.com,nfsvers=3,rw,noatime,nconnect=8,soft,timeo=30,retrans=2"
    volumes:
      - load-balancer:/home/kamal-proxy/.config/kamal-proxy

================
File: saas/config/deploy.yml
================
service: fizzy
image: basecamp/fizzy
asset_path: /rails/public/assets
hooks_path: <%= File.join(Gem::Specification.find_by_name("fizzy-saas").gem_dir, ".kamal", "hooks") %>
secrets_path: <%= File.join(Gem::Specification.find_by_name("fizzy-saas").gem_dir, ".kamal/secrets") %>
servers:
  jobs:
    cmd: bin/jobs
volumes:
  - fizzy:/rails/storage
proxy:
  ssl: true
registry:
  server: registry.37signals.com
  username: robot$harbor-bot
  password:
    - BASECAMP_REGISTRY_PASSWORD
builder:
  arch: amd64
  dockerfile: <%= File.join(Gem::Specification.find_by_name("fizzy-saas").gem_dir, "Dockerfile") %>
  secrets:
    - GITHUB_TOKEN
  remote: ssh://app@docker-builder-102
  local: <%= ENV.fetch("KAMAL_BUILDER_LOCAL", "true") %>
aliases:
  console: app exec -i --reuse -e CONSOLE_USER:<%= ENV["USER"] %> "bin/rails console"
  ssh: app exec -i --reuse -e CONSOLE_USER:<%= ENV["USER"] %> /bin/bash

================
File: saas/config/routes.rb
================
Fizzy::Saas::Engine.routes.draw do
  Queenbee.routes(self)
  namespace :admin do
    mount Audits1984::Engine, at: "/console"
    get "stats", to: "stats#show"
    resource :account_search, only: :create
    resources :accounts do
      resource :overridden_limits, only: :destroy
      resource :billing_waiver, only: [ :create, :destroy ]
    end
  end
end

================
File: saas/config/storage.yml
================
test:
  service: Disk
  root: <%= Rails.root.join("tmp/storage/files") %>
local:
  service: Disk
  root: <%= Rails.root.join("storage", Rails.env, "files") %>
devminio:
  service: S3
  bucket: fizzy-dev-activestorage
  endpoint: "http://minio.localhost:39000"
  force_path_style: true
  request_checksum_calculation: when_required # default is when_supported with CRC64NVME checksum which FlashBlade doesn't support
  response_checksum_validation: when_required # default is when_supported with CRC64NVME checksum which FlashBlade doesn't support
  region: us-east-1 # default region required for signer
  access_key_id: minioadmin
  secret_access_key: minioadmin
# We have "development", "staging", and "production" buckets configured. Note that we don't have a
# "beta" bucket. (As of 2025-06-01.)
<% pure_env = Rails.env.beta? ? "production" : Rails.env %>
purestorage:
  service: S3
  bucket: fizzy-<%= pure_env %>-activestorage
  endpoint: "https://storage.basecamp.com"
  ssl_verify_peer: false # FIXME: using self-signed cert internally
  force_path_style: true
  request_checksum_calculation: when_required # default is when_supported with CRC64NVME checksum which FlashBlade doesn't support
  response_checksum_validation: when_required # default is when_supported with CRC64NVME checksum which FlashBlade doesn't support
  region: us-east-1 # default region required for signer
  access_key_id: <%= ENV["ACTIVE_STORAGE_ACCESS_KEY_ID"] %>
  secret_access_key: <%= ENV["ACTIVE_STORAGE_SECRET_ACCESS_KEY"] %>

================
File: saas/db/migrate/20251202200249_create_console1984_tables.console1984.rb
================
# This migration comes from console1984 (originally 20210517203931)
class CreateConsole1984Tables < ActiveRecord::Migration[7.0]
  def change
    create_table :console1984_sessions do |t|
      t.text :reason
      t.references :user, null: false, index: false
      t.timestamps
      t.index :created_at
      t.index [ :user_id, :created_at ]
    end
    create_table :console1984_users do |t|
      t.string :username, null: false
      t.timestamps
      t.index [:username]
    end
    create_table :console1984_commands do |t|
      t.text :statements
      t.references :sensitive_access
      t.references :session, null: false, index: false
      t.timestamps
      t.index [ :session_id, :created_at, :sensitive_access_id ], name: "on_session_and_sensitive_chronologically"
    end
    create_table :console1984_sensitive_accesses do |t|
      t.text :justification
      t.references :session, null: false
      t.timestamps
    end
  end
end

================
File: saas/db/migrate/20251202205753_create_auditing_tables.audits1984.rb
================
# This migration comes from audits1984 (originally 20210810092639)
class CreateAuditingTables < ActiveRecord::Migration[7.0]
  def change
    create_table :audits1984_audits do |t|
      t.integer :status, default: 0, null: false
      t.text :notes
      t.references :session, null: false
      t.uuid :auditor_id, null: false
      t.timestamps
    end
  end
end

================
File: saas/db/migrate/20251203144630_create_account_subscriptions.rb
================
class CreateAccountSubscriptions < ActiveRecord::Migration[8.2]
  def change
    create_table :account_subscriptions, id: :uuid do |t|
      t.references :account, null: false, type: :uuid, index: true
      t.string :plan_key
      t.string :stripe_customer_id, null: false, index: { unique: true }
      t.string :stripe_subscription_id, index: { unique: true }
      t.string :status
      t.datetime :current_period_end
      t.datetime :cancel_at
      t.timestamps
    end
  end
end

================
File: saas/db/migrate/20251215140000_create_account_overridden_limits.rb
================
class CreateAccountOverriddenLimits < ActiveRecord::Migration[8.2]
  def change
    create_table :account_overridden_limits, id: :uuid do |t|
      t.references :account, null: false, type: :uuid, index: { unique: true }
      t.integer :card_count
      t.timestamps
    end
  end
end

================
File: saas/db/migrate/20251215160000_create_account_billing_waivers.rb
================
class CreateAccountBillingWaivers < ActiveRecord::Migration[8.2]
  def change
    create_table :account_billing_waivers, id: :uuid do |t|
      t.references :account, null: false, type: :uuid, index: { unique: true }
      t.timestamps
    end
  end
end

================
File: saas/db/migrate/20251215170000_add_next_amount_due_in_cents_to_account_subscriptions.rb
================
class AddNextAmountDueInCentsToAccountSubscriptions < ActiveRecord::Migration[8.2]
  def change
    add_column :account_subscriptions, :next_amount_due_in_cents, :integer
  end
end

================
File: saas/db/migrate/20251216000000_add_bytes_used_to_account_overridden_limits.rb
================
class AddBytesUsedToAccountOverriddenLimits < ActiveRecord::Migration[8.2]
  def change
    add_column :account_overridden_limits, :bytes_used, :bigint
  end
end

================
File: saas/db/migrate/20260126230838_create_auditor_tokens.audits1984.rb
================
# This migration comes from audits1984 (originally 20260126000000)
class CreateAuditorTokens < ActiveRecord::Migration[7.0]
  def change
    create_table :audits1984_auditor_tokens do |t|
      t.uuid :auditor_id, null: false, index: { unique: true }
      t.string :token_digest, null: false
      t.datetime :expires_at, null: false
      t.timestamps
      t.index :token_digest, unique: true
    end
  end
end

================
File: saas/db/saas_schema.rb
================
# This file is auto-generated from the current state of the database. Instead
# of editing this file, please use the migrations feature of Active Record to
# incrementally modify your database, and then regenerate this schema definition.
#
# This file is the source Rails uses to define your schema when running `bin/rails
# db:schema:load`. When creating a new database, `bin/rails db:schema:load` tends to
# be faster and is potentially less error prone than running all of your
# migrations from scratch. Old migrations may fail to apply correctly if those
# migrations use external dependencies or application code.
#
# It's strongly recommended that you check this file into your version control system.
ActiveRecord::Schema[8.2].define(version: 2026_01_26_230838) do
  create_table "account_billing_waivers", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "account_id", null: false
    t.datetime "created_at", null: false
    t.datetime "updated_at", null: false
    t.index ["account_id"], name: "index_account_billing_waivers_on_account_id", unique: true
  end
  create_table "account_overridden_limits", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "account_id", null: false
    t.bigint "bytes_used"
    t.integer "card_count"
    t.datetime "created_at", null: false
    t.datetime "updated_at", null: false
    t.index ["account_id"], name: "index_account_overridden_limits_on_account_id", unique: true
  end
  create_table "account_subscriptions", id: :uuid, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "account_id", null: false
    t.datetime "cancel_at"
    t.datetime "created_at", null: false
    t.datetime "current_period_end"
    t.integer "next_amount_due_in_cents"
    t.string "plan_key"
    t.string "status"
    t.string "stripe_customer_id", null: false
    t.string "stripe_subscription_id"
    t.datetime "updated_at", null: false
    t.index ["account_id"], name: "index_account_subscriptions_on_account_id"
    t.index ["stripe_customer_id"], name: "index_account_subscriptions_on_stripe_customer_id", unique: true
    t.index ["stripe_subscription_id"], name: "index_account_subscriptions_on_stripe_subscription_id", unique: true
  end
  create_table "audits1984_auditor_tokens", charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "auditor_id", null: false
    t.datetime "created_at", null: false
    t.datetime "expires_at", null: false
    t.string "token_digest", null: false
    t.datetime "updated_at", null: false
    t.index ["auditor_id"], name: "index_audits1984_auditor_tokens_on_auditor_id", unique: true
    t.index ["token_digest"], name: "index_audits1984_auditor_tokens_on_token_digest", unique: true
  end
  create_table "audits1984_audits", charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.uuid "auditor_id", null: false
    t.datetime "created_at", null: false
    t.text "notes"
    t.bigint "session_id", null: false
    t.integer "status", default: 0, null: false
    t.datetime "updated_at", null: false
    t.index ["session_id"], name: "index_audits1984_audits_on_session_id"
  end
  create_table "console1984_commands", charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.datetime "created_at", null: false
    t.bigint "sensitive_access_id"
    t.bigint "session_id", null: false
    t.text "statements"
    t.datetime "updated_at", null: false
    t.index ["sensitive_access_id"], name: "index_console1984_commands_on_sensitive_access_id"
    t.index ["session_id", "created_at", "sensitive_access_id"], name: "on_session_and_sensitive_chronologically"
  end
  create_table "console1984_sensitive_accesses", charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.datetime "created_at", null: false
    t.text "justification"
    t.bigint "session_id", null: false
    t.datetime "updated_at", null: false
    t.index ["session_id"], name: "index_console1984_sensitive_accesses_on_session_id"
  end
  create_table "console1984_sessions", charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.datetime "created_at", null: false
    t.text "reason"
    t.datetime "updated_at", null: false
    t.bigint "user_id", null: false
    t.index ["created_at"], name: "index_console1984_sessions_on_created_at"
    t.index ["user_id", "created_at"], name: "index_console1984_sessions_on_user_id_and_created_at"
  end
  create_table "console1984_users", charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.datetime "created_at", null: false
    t.datetime "updated_at", null: false
    t.string "username", null: false
    t.index ["username"], name: "index_console1984_users_on_username"
  end
end

================
File: saas/exe/stripe-dev
================
#!/usr/bin/env ruby
#
# Fetches Stripe development environment variables from 1Password and starts
# the Stripe CLI webhook listener.
#
# Usage: eval "$(bundle exec stripe-dev)"

require "json"
require "fileutils"

LOG_FILE = "log/stripe.development.log"
PID_FILE = "tmp/stripe.tunnel.pid"

# Ensure directories exist
FileUtils.mkdir_p("log")
FileUtils.mkdir_p("tmp")

# Kill any existing stripe tunnel process
if File.exist?(PID_FILE)
  old_pid = File.read(PID_FILE).strip.to_i
  if old_pid > 0
    Process.kill("TERM", old_pid) rescue nil
  end
  File.delete(PID_FILE)
end

# Fetch secrets from 1Password
secrets_escaped = `kamal secrets fetch \
  --adapter 1password \
  --account 23QPQDKZC5BKBIIG7UGT5GR5RM \
  --from "Deploy/Fizzy" \
  "Development/STRIPE_SECRET_KEY" \
  "Development/STRIPE_MONTHLY_V1_PRICE_ID" \
  "Development/STRIPE_MONTHLY_EXTRA_STORAGE_V1_PRICE_ID" 2>/dev/null`

secrets_json = secrets_escaped.gsub(/\\(.)/, '\1')
secrets = JSON.parse(secrets_json)

stripe_secret_key = secrets["Deploy/Fizzy/Development/STRIPE_SECRET_KEY"]
stripe_price_id = secrets["Deploy/Fizzy/Development/STRIPE_MONTHLY_V1_PRICE_ID"]
stripe_extra_storage_price_id = secrets["Deploy/Fizzy/Development/STRIPE_MONTHLY_EXTRA_STORAGE_V1_PRICE_ID"]

# Clear previous log file
File.write(LOG_FILE, "")

# Start stripe listen in background
pid = spawn(
  "stripe", "listen", "--forward-to", "localhost:3006/stripe/webhooks",
  out: [ LOG_FILE, "a" ],
  err: [ LOG_FILE, "a" ]
)
Process.detach(pid)

# Save PID for cleanup
File.write(PID_FILE, pid.to_s)

# Wait for the webhook secret to appear in logs
webhook_secret = nil
20.times do
  sleep 0.5
  if File.exist?(LOG_FILE)
    content = File.read(LOG_FILE)
    if match = content.match(/webhook signing secret is (whsec_\w+)/)
      webhook_secret = match[1]
      break
    end
  end
end

if webhook_secret.nil?
  warn "Warning: Could not capture webhook secret from stripe listen"
end

# Output export statements
puts %Q(export STRIPE_SECRET_KEY="#{stripe_secret_key}")
puts %Q(export STRIPE_MONTHLY_V1_PRICE_ID="#{stripe_price_id}")
puts %Q(export STRIPE_MONTHLY_EXTRA_STORAGE_V1_PRICE_ID="#{stripe_extra_storage_price_id}")
puts %Q(export STRIPE_WEBHOOK_SECRET="#{webhook_secret}") if webhook_secret

# Informational message to stderr (won't be eval'd)
warn ""
warn "Stripe CLI listening (PID: #{pid})"
warn "Logs: #{LOG_FILE}"

================
File: saas/lib/fizzy/saas/authorization.rb
================
module Fizzy
  module Saas
    module Authorization
      module Controller
        extend ActiveSupport::Concern
        included do
          before_action :ensure_only_employees_can_access_non_production_remote_environments, if: :authenticated?
        end
        private
          def ensure_only_employees_can_access_non_production_remote_environments
            head :forbidden if Rails.env.staging? && !Current.identity.employee?
          end
      end
      module Identity
        extend ActiveSupport::Concern
        EMPLOYEE_DOMAINS = [ "@37signals.com", "@basecamp.com" ].freeze
        def employee?
          email_address.end_with?(*EMPLOYEE_DOMAINS)
        end
      end
    end
  end
end

================
File: saas/lib/fizzy/saas/engine.rb
================
require_relative "transaction_pinning"
require_relative "signup"
require_relative "authorization"
require_relative "../../rails_ext/active_record_tasks_database_tasks.rb"
module Fizzy
  module Saas
    class Engine < ::Rails::Engine
      # moved from config/initializers/queenbee.rb
      Queenbee.host_app = Fizzy
      initializer "fizzy_saas.content_security_policy", before: :load_config_initializers do |app|
        app.config.x.content_security_policy.form_action = "https://checkout.stripe.com https://billing.stripe.com"
      end
      initializer "fizzy_saas.assets" do |app|
        app.config.assets.paths << root.join("app/assets/stylesheets")
      end
      initializer "fizzy_saas.public_files" do |app|
        app.middleware.insert_after ActionDispatch::Static, ActionDispatch::Static, root.join("public").to_s,
          headers: app.config.public_file_server.headers
      end
      initializer "fizzy.saas.routes", after: :add_routing_paths do |app|
        # Routes that rely on the implicit account tenant should go here instead of in +routes.rb+.
        app.routes.prepend do
          namespace :account do
            resource :billing_portal, only: :show
            resource :subscription do
              scope module: :subscriptions do
                resource :upgrade, only: :create
                resource :downgrade, only: :create
              end
            end
          end
          namespace :stripe do
            resource :webhooks, only: :create
          end
        end
      end
      initializer "fizzy.saas.mount" do |app|
        app.routes.append do
          mount Fizzy::Saas::Engine => "/", as: "saas"
        end
      end
      initializer "fizzy_saas.transaction_pinning" do |app|
        app.config.middleware.insert_after(ActiveRecord::Middleware::DatabaseSelector, TransactionPinning::Middleware)
      end
      initializer "fizzy_saas.solid_queue" do
        SolidQueue.on_start do
          Process.warmup
          Yabeda::Prometheus::Exporter.start_metrics_server!
        end
      end
      initializer "fizzy_saas.logging.session" do |app|
        ActiveSupport.on_load(:action_controller_base) do
          before_action do
            if Current.identity.present?
              logger.struct(authentication: { identity: { id: Current.identity.id } })
            end
            if Current.account.present?
              logger.struct(account: { queenbee_id: Current.account.external_account_id })
            end
          end
        end
      end
      # Load test mocks automatically in test environment
      initializer "fizzy_saas.test_mocks", after: :load_config_initializers do
        if Rails.env.test?
          require_relative "testing"
        end
      end
      initializer "fizzy_saas.stripe" do
        Stripe.api_key = ENV["STRIPE_SECRET_KEY"]
      end
      initializer "fizzy_saas.sentry" do
        if !Rails.env.local? && ENV["SKIP_TELEMETRY"].blank?
          Sentry.init do |config|
            config.dsn = ENV["SENTRY_DSN"]
            config.breadcrumbs_logger = %i[ active_support_logger http_logger ]
            config.send_default_pii = false
            config.release = ENV["KAMAL_VERSION"]
            config.excluded_exceptions += [ "ActiveRecord::ConcurrentMigrationError" ]
            # Receive Rails.error.report and retry_on/discard_on report: true
            config.rails.register_error_subscriber = true
          end
        end
      end
      initializer "fizzy_saas.yabeda" do
        require "prometheus/client/support/puma"
        Prometheus::Client.configuration.logger = Rails.logger
        Prometheus::Client.configuration.pid_provider = Prometheus::Client::Support::Puma.method(:worker_pid_provider)
        Yabeda::Rails.config.controller_name_case = :camel
        Yabeda::Rails.config.ignore_actions = %w[
          Rails::HealthController#show
        ]
        Yabeda::ActiveJob.install!
        require "yabeda/solid_queue"
        Yabeda::SolidQueue.install!
        Yabeda::ActionCable.configure do |config|
          config.channel_class_name = "ActionCable::Channel::Base"
        end
        require_relative "metrics"
      end
      config.before_initialize do
        config.console1984.protected_environments = %i[ production beta staging ]
        config.console1984.ask_for_username_if_empty = true
        config.console1984.base_record_class = "::SaasRecord"
        config.console1984.incinerate_after = 60.days
        config.audits1984.base_controller_class = "::Admin::AuditsController"
        config.audits1984.auditor_class = "::Identity"
        config.audits1984.auditor_name_attribute = :email_address
        if config.console1984.protected_environments.include?(Rails.env.to_sym)
          config.active_record.encryption.primary_key = ENV.fetch("ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY")
          config.active_record.encryption.deterministic_key = ENV.fetch("ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY")
          config.active_record.encryption.key_derivation_salt = ENV.fetch("ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT")
        end
      end
      config.to_prepare do
        ::Account.include Account::Billing, Account::Limited
        ::User.include User::NotifiesAccountOfEmailChange
        ::Signup.prepend Fizzy::Saas::Signup
        CardsController.include(Card::LimitedCreation)
        Cards::PublishesController.include(Card::LimitedPublishing)
        Queenbee::Subscription.short_names = Subscription::SHORT_NAMES
        # Default to local dev QB token if not set
        Queenbee::ApiToken.token = ENV.fetch("QUEENBEE_API_TOKEN") { "69a4cfb8705913e6323f7b4c0c0cff9bd8df37da532f4375b85e9655b8100bb023591b48d308205092aa0a04dd28cb6c62d6798364a6f44cc1e675814eb148a1" } # gitleaks:allow development-only token
        Subscription::SHORT_NAMES.each do |short_name|
          const_name = "#{short_name}Subscription"
          ::Object.send(:remove_const, const_name) if ::Object.const_defined?(const_name)
          ::Object.const_set const_name, Subscription.const_get(short_name, false)
        end
        ::ApplicationController.include Fizzy::Saas::Authorization::Controller
        ::Identity.include Fizzy::Saas::Authorization::Identity
      end
    end
  end
end

================
File: saas/lib/fizzy/saas/metrics.rb
================
Yabeda.configure do
  SHORT_HISTOGRAM_BUCKETS = [ 0.001, 0.005, 0.01, 0.025, 0.05, 0.1, 0.25, 0.5 ]
  group :fizzy do
    counter :replica_stale,
      comment: "Number of requests served from a stale replica"
    histogram :replica_wait,
      unit: :seconds,
      comment: "Time spent waiting for replica to catch up with transaction",
      buckets: SHORT_HISTOGRAM_BUCKETS
  end
end

================
File: saas/lib/fizzy/saas/signup.rb
================
module Fizzy
  module Saas
    module Signup
      extend ActiveSupport::Concern
      included do
        attr_reader :queenbee_account
      end
      private
        def create_tenant
          @queenbee_account = Queenbee::Remote::Account.create!(queenbee_account_attributes)
          @queenbee_account.id.to_s
        end
        def handle_account_creation_error(error)
          @queenbee_account&.cancel
        end
        def queenbee_account_attributes
          {}.tap do |attributes|
            attributes[:product_name]   = "fizzy"
            attributes[:name]           = generate_account_name
            attributes[:owner_name]     = full_name
            attributes[:owner_email]    = email_address
            attributes[:trial]          = true
            attributes[:subscription]   = subscription_attributes
            attributes[:remote_request] = request_attributes
            # # TODO: Terms of Service
            # attributes[:terms_of_service] = true
            # We've confirmed the email
            attributes[:auto_allow]     = true
            # Tell Queenbee to skip the request to create a local account. We've created it ourselves.
            attributes[:skip_remote]    = true
          end
        end
    end
  end
end

================
File: saas/lib/fizzy/saas/testing.rb
================
require "queenbee/testing/mocks"
Queenbee::Remote::Account.class_eval do
  # because we use the account ID as the tenant name, we need it to be unique in each test to avoid
  # parallelized tests clobbering each other.
  def next_id
    super + Random.rand(1000000)
  end
end
# Add engine fixtures to the test fixture paths
module Fizzy::Saas::EngineFixtures
  def included(base)
    super
    engine_fixtures = Fizzy::Saas::Engine.root.join("test", "fixtures").to_s
    base.fixture_paths << engine_fixtures unless base.fixture_paths.include?(engine_fixtures)
  end
end
ActiveRecord::TestFixtures.singleton_class.prepend(Fizzy::Saas::EngineFixtures)

================
File: saas/lib/fizzy/saas/transaction_pinning.rb
================
module TransactionPinning
  class Middleware
    SESSION_KEY = :last_txn
    DEFAULT_MAX_WAIT = 0.25
    def initialize(app)
      @app = app
      @timeout = Rails.application.config.x.transaction_pinning&.timeout&.to_f || DEFAULT_MAX_WAIT
    end
    def call(env)
      request = ActionDispatch::Request.new(env)
      replica_metrics = {}
      if ApplicationRecord.current_role == :reading
        wait_for_replica_catchup(request, replica_metrics)
      end
      status, headers, body = @app.call(env)
      headers.merge!(replica_metrics.transform_values(&:to_s))
      if ApplicationRecord.current_role == :writing
        capture_transaction_id(request)
      end
      [ status, headers, body ]
    end
    private
      def wait_for_replica_catchup(request, replica_metrics)
        if last_txn = request.session[SESSION_KEY].presence
          has_transaction = tracking_replica_wait_time(replica_metrics) do
            replica_has_transaction(last_txn)
          end
          unless has_transaction
            Yabeda.fizzy.replica_stale.increment
            replica_metrics["X-Replica-Stale"] = true
          end
        end
      end
      def capture_transaction_id(request)
        request.session[SESSION_KEY] = ApplicationRecord.connection.show_variable("global.gtid_executed")
      end
      def replica_has_transaction(txn)
        sql = ApplicationRecord.sanitize_sql_array([ "SELECT WAIT_FOR_EXECUTED_GTID_SET(?, ?)", txn, @timeout ])
        ApplicationRecord.connection.select_value(sql) == 0
      rescue => e
        Sentry.capture_exception(e, extra: { gtid: txn })
        true # Treat as if we're up to date, since we don't know
      end
      def tracking_replica_wait_time(replica_metrics)
        started_at = Time.current
        Yabeda.fizzy.replica_wait.measure do
          yield
        end.tap do
          replica_metrics["X-Replica-Wait"] = Time.current - started_at
        end
      end
  end
end

================
File: saas/lib/fizzy/saas/version.rb
================
module Fizzy
  module Saas
    VERSION = "0.1.0"
  end
end

================
File: saas/lib/fizzy/saas.rb
================
require "fizzy/saas/version"
require "fizzy/saas/engine"
module Fizzy
  module Saas
    def self.append_test_paths
      engine_test_path = Engine.root.join("test")
      ENV["DEFAULT_TEST"] = "{#{engine_test_path},test}/**/*_test.rb"
      ENV["DEFAULT_TEST_EXCLUDE"] = "{#{engine_test_path},test}/{system,dummy,fixtures}/**/*_test.rb"
    end
  end
end

================
File: saas/lib/rails_ext/active_record_tasks_database_tasks.rb
================
module ActiveRecordTasksDatabaseTasksExtension
  extend ActiveSupport::Concern
  class_methods do
    # proposed upstream in https://github.com/rails/rails/pull/56290
    def schema_dump_path(db_config, format = db_config.schema_format)
      return ENV["SCHEMA"] if ENV["SCHEMA"]
      filename = db_config.schema_dump(format)
      return unless filename
      if Pathname.new(filename).absolute?
        filename
      else
        super
      end
    end
  end
end
ActiveSupport.on_load(:active_record) do
  ActiveRecord::Tasks::DatabaseTasks.include(ActiveRecordTasksDatabaseTasksExtension)
end

================
File: saas/lib/tasks/fizzy/saas_tasks.rake
================
require "rake/testtask"

namespace :test do
  desc "Run tests for fizzy-saas gem"
  Rake::TestTask.new(saas: :environment) do |t|
    t.libs << "test"
    t.test_files = FileList[Fizzy::Saas::Engine.root.join("test/**/*_test.rb")]
    t.warning = false
  end
end

================
File: saas/lib/yabeda/solid_queue.rb
================
module Yabeda
  module SolidQueue
    def self.install!
      Yabeda.configure do
        group :solid_queue
        gauge :jobs_failed_count, comment: "Number of failed jobs"
        gauge :jobs_unreleased_count, comment: "Number of claimed jobs that don't belong to any process"
        gauge :jobs_scheduled_and_delayed_count, comment: "Number of scheduled jobs that have over 5 minutes delay"
        gauge :recurring_tasks_count, comment: "Number of recurring jobs scheduled"
        gauge :recurring_tasks_delayed_count, comment: "Number of recurring jobs that haven't been enqueued within their schedule"
        collect do
          if ::SolidQueue.supervisor?
            solid_queue.jobs_failed_count.set({}, ::SolidQueue::FailedExecution.count)
            solid_queue.jobs_unreleased_count.set({}, ::SolidQueue::ClaimedExecution.where(process: nil).count)
            solid_queue.jobs_scheduled_and_delayed_count.set({}, ::SolidQueue::ScheduledExecution.where(scheduled_at: ..5.minutes.ago).count)
            solid_queue.recurring_tasks_count.set({}, ::SolidQueue::RecurringTask.count)
            solid_queue.recurring_tasks_delayed_count.set({}, ::SolidQueue::RecurringTask.count do |task|
              task.last_enqueued_time.present? && (task.previous_time - task.last_enqueued_time) > 5.minutes
            end)
          end
        end
      end
    end
  end
end

================
File: saas/public/.well-known/assetlinks.json
================
[
  {
    "relation": ["delegate_permission/common.handle_all_urls"],
    "target": {
      "namespace": "android_app",
      "package_name": "do.fizzy.app",
      "sha256_cert_fingerprints": [
        "3B:17:E4:FF:F0:2E:E0:CE:D7:94:F9:9E:71:3C:A8:14:7C:FA:B7:F2:99:35:98:03:E9:E0:EB:B3:6E:12:E2:0F",
        "3B:4C:33:46:FD:F4:AD:4D:FE:9E:49:1D:B1:2F:EA:B1:04:33:02:97:BB:09:39:20:D4:18:69:2D:D2:9E:B5:5C"
      ]
    }
  }
]

================
File: saas/script/configure-lb-beta.sh
================
#!/usr/bin/env bash
set -e
# Beta 1: fizzy-beta-lb-101 -> fizzy-beta-app-101
ssh app@fizzy-beta-lb-101.df-iad-int.37signals.com \
  docker exec fizzy-load-balancer \
    kamal-proxy deploy fizzy \
      --force \
      --tls \
      --host=beta1.fizzy-beta.com \
      --target=fizzy-beta-app-101.df-iad-int.37signals.com
# Beta 2: fizzy-beta-lb-102 -> fizzy-beta-app-102
ssh app@fizzy-beta-lb-102.df-iad-int.37signals.com \
  docker exec fizzy-load-balancer \
    kamal-proxy deploy fizzy \
      --force \
      --tls \
      --host=beta2.fizzy-beta.com \
      --target=fizzy-beta-app-102.df-iad-int.37signals.com
# Beta 3: fizzy-beta-lb-103 -> fizzy-beta-app-103
ssh app@fizzy-beta-lb-103.df-iad-int.37signals.com \
  docker exec fizzy-load-balancer \
    kamal-proxy deploy fizzy \
      --force \
      --tls \
      --host=beta3.fizzy-beta.com \
      --target=fizzy-beta-app-103.df-iad-int.37signals.com
# Beta 4: fizzy-beta-lb-104 -> fizzy-beta-app-104
ssh app@fizzy-beta-lb-104.df-iad-int.37signals.com \
  docker exec fizzy-load-balancer \
    kamal-proxy deploy fizzy \
      --force \
      --tls \
      --host=beta4.fizzy-beta.com \
      --target=fizzy-beta-app-104.df-iad-int.37signals.com

================
File: saas/script/configure-lb-production.sh
================
#!/usr/bin/env bash
set -e
# fizzy-lb-101.df-iad-int.37signals.com
#
ssh app@fizzy-lb-101.df-iad-int.37signals.com \
  docker exec fizzy-load-balancer \
    kamal-proxy deploy fizzy \
      --force \
      --tls \
      --host=app.fizzy.do \
      --writer-affinity-timeout=0 \
      --tls-acme-cache-path=/certificates \
      --target=fizzy-app-101.df-iad-int.37signals.com \
      --target=fizzy-app-102.df-iad-int.37signals.com
# fizzy-lb-102.df-iad-int.37signals.com
#
ssh app@fizzy-lb-102.df-iad-int.37signals.com \
  docker exec fizzy-load-balancer \
    kamal-proxy deploy fizzy \
      --force \
      --tls \
      --host=app.fizzy.do \
      --writer-affinity-timeout=0 \
      --tls-acme-cache-path=/certificates \
      --target=fizzy-app-101.df-iad-int.37signals.com \
      --target=fizzy-app-102.df-iad-int.37signals.com
# fizzy-lb-01.sc-chi-int.37signals.com
#
ssh app@fizzy-lb-01.sc-chi-int.37signals.com \
  docker exec fizzy-load-balancer \
    kamal-proxy deploy fizzy \
      --force \
      --tls \
      --host=app.fizzy.do \
      --writer-affinity-timeout=0 \
      --tls-acme-cache-path=/certificates \
      --target=fizzy-app-101.df-iad-int.37signals.com \
      --target=fizzy-app-102.df-iad-int.37signals.com \
      --read-target=fizzy-app-01.sc-chi-int.37signals.com \
      --read-target=fizzy-app-02.sc-chi-int.37signals.com
# fizzy-lb-02.sc-chi-int.37signals.com
#
ssh app@fizzy-lb-02.sc-chi-int.37signals.com \
  docker exec fizzy-load-balancer \
    kamal-proxy deploy fizzy \
      --force \
      --tls \
      --host=app.fizzy.do \
      --writer-affinity-timeout=0 \
      --tls-acme-cache-path=/certificates \
      --target=fizzy-app-101.df-iad-int.37signals.com \
      --target=fizzy-app-102.df-iad-int.37signals.com \
      --read-target=fizzy-app-01.sc-chi-int.37signals.com \
      --read-target=fizzy-app-02.sc-chi-int.37signals.com
# fizzy-lb-401.df-ams-int.37signals.com
#
ssh app@fizzy-lb-401.df-ams-int.37signals.com \
  docker exec fizzy-load-balancer \
    kamal-proxy deploy fizzy \
      --force \
      --tls \
      --host=app.fizzy.do \
      --writer-affinity-timeout=0 \
      --tls-acme-cache-path=/certificates \
      --target=fizzy-app-101.df-iad-int.37signals.com \
      --target=fizzy-app-102.df-iad-int.37signals.com \
      --read-target=fizzy-app-401.df-ams-int.37signals.com \
      --read-target=fizzy-app-402.df-ams-int.37signals.com
# fizzy-lb-402.df-ams-int.37signals.com
#
ssh app@fizzy-lb-402.df-ams-int.37signals.com \
  docker exec fizzy-load-balancer \
    kamal-proxy deploy fizzy \
      --force \
      --tls \
      --host=app.fizzy.do \
      --writer-affinity-timeout=0 \
      --tls-acme-cache-path=/certificates \
      --target=fizzy-app-101.df-iad-int.37signals.com \
      --target=fizzy-app-102.df-iad-int.37signals.com \
      --read-target=fizzy-app-401.df-ams-int.37signals.com \
      --read-target=fizzy-app-402.df-ams-int.37signals.com

================
File: saas/script/configure-lb-staging.sh
================
#!/usr/bin/env bash
set -e
# fizzy-staging-lb-01.sc-chi-int.37signals.com
#
ssh app@fizzy-staging-lb-01.sc-chi-int.37signals.com \
  docker exec fizzy-load-balancer \
    kamal-proxy deploy fizzy \
      --force \
      --tls \
      --host=app.fizzy-staging.com \
      --writer-affinity-timeout=0 \
      --tls-acme-cache-path=/certificates \
      --target=fizzy-staging-app-101.df-iad-int.37signals.com \
      --target=fizzy-staging-app-102.df-iad-int.37signals.com \
      --read-target=fizzy-staging-app-01.sc-chi-int.37signals.com \
      --read-target=fizzy-staging-app-02.sc-chi-int.37signals.com
# fizzy-staging-lb-101.df-iad-int.37signals.com
#
ssh app@fizzy-staging-lb-101.df-iad-int.37signals.com \
  docker exec fizzy-load-balancer \
    kamal-proxy deploy fizzy \
      --force \
      --tls \
      --host=app.fizzy-staging.com \
      --writer-affinity-timeout=0 \
      --tls-acme-cache-path=/certificates \
      --target=fizzy-staging-app-101.df-iad-int.37signals.com \
      --target=fizzy-staging-app-102.df-iad-int.37signals.com
# fizzy-staging-lb-401.df-ams-int.37signals.com
#
ssh app@fizzy-staging-lb-401.df-ams-int.37signals.com \
  docker exec fizzy-load-balancer \
    kamal-proxy deploy fizzy \
      --force \
      --tls \
      --host=app.fizzy-staging.com \
      --writer-affinity-timeout=0 \
      --tls-acme-cache-path=/certificates \
      --target=fizzy-staging-app-101.df-iad-int.37signals.com \
      --target=fizzy-staging-app-102.df-iad-int.37signals.com \
      --read-target=fizzy-staging-app-401.df-ams-int.37signals.com \
      --read-target=fizzy-staging-app-402.df-ams-int.37signals.com

================
File: saas/test/controllers/accounts/subscriptions/card_creation_test.rb
================
require "test_helper"
class Account::Subscriptions::CardCreationTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :mike
  end
  # Nearing limits - shown in card creation footer
  test "admin sees nearing card limit notice" do
    accounts(:initech).update_column(:cards_count, 950)
    get card_draft_path(cards(:unfinished_thoughts), script_name: accounts(:initech).slug)
    assert_response :success
    assert_match /upgrade to unlimited/i, response.body
  end
  test "admin sees nearing storage limit notice" do
    Account.any_instance.stubs(:bytes_used).returns(600.megabytes)
    get card_draft_path(cards(:unfinished_thoughts), script_name: accounts(:initech).slug)
    assert_response :success
    assert_match /upgrade to get more/i, response.body
  end
  # Exceeding limits - shown instead of create buttons
  test "admin sees exceeding card limit notice" do
    accounts(:initech).update_column(:cards_count, 1001)
    get card_draft_path(cards(:unfinished_thoughts), script_name: accounts(:initech).slug)
    assert_response :success
    assert_match /youve used your.*free cards/i, response.body
  end
  test "admin sees exceeding storage limit notice" do
    Account.any_instance.stubs(:bytes_used).returns(1.1.gigabytes)
    get card_draft_path(cards(:unfinished_thoughts), script_name: accounts(:initech).slug)
    assert_response :success
    assert_match /youve run out of.*free storage/i, response.body
  end
  # Paid accounts under limits - no notices
  test "paid account under limits sees no notices" do
    logout_and_sign_in_as :kevin
    accounts(:"37s").subscription.update!(plan: Plan.paid, status: :active)
    get card_path(cards(:layout), script_name: accounts(:"37s").slug)
    assert_response :success
    assert_no_match /upgrade/i, response.body
    assert_no_match /youve used your/i, response.body
  end
  # Comped accounts under limits - no notices
  test "comped account under limits sees no notices" do
    accounts(:initech).comp
    get card_draft_path(cards(:unfinished_thoughts), script_name: accounts(:initech).slug)
    assert_response :success
    assert_no_match /upgrade/i, response.body
    assert_no_match /youve used your/i, response.body
  end
end

================
File: saas/test/controllers/accounts/subscriptions/downgrades_controller_test.rb
================
require "test_helper"
require "ostruct"
class Account::Subscriptions::DowngradesControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
    accounts(:"37s").subscription.update!(stripe_subscription_id: "sub_123", plan: Plan.paid_with_extra_storage)
  end
  test "downgrade redirects to stripe billing portal" do
    stripe_subscription = OpenStruct.new(items: OpenStruct.new(data: [ OpenStruct.new(id: "si_123") ]))
    portal_session = OpenStruct.new(url: "https://billing.stripe.com/session/abc123")
    Stripe::Subscription.stubs(:retrieve).with("sub_123").returns(stripe_subscription)
    Stripe::BillingPortal::Session.stubs(:create).returns(portal_session)
    post account_subscription_downgrade_path
    assert_redirected_to "https://billing.stripe.com/session/abc123"
  end
  test "downgrade requires admin" do
    logout_and_sign_in_as :david
    post account_subscription_downgrade_path
    assert_response :forbidden
  end
  test "downgrade requires downgradeable plan" do
    accounts(:"37s").subscription.update!(plan: Plan.paid)
    post account_subscription_downgrade_path
    assert_response :bad_request
  end
end

================
File: saas/test/controllers/accounts/subscriptions/settings_test.rb
================
require "test_helper"
class Account::Subscriptions::SettingsTest < ActionDispatch::IntegrationTest
  test "free users see current usage" do
    sign_in_as :mike
    accounts(:initech).update_column(:cards_count, 3)
    get account_settings_path(script_name: accounts(:initech).slug)
    assert_response :success
    assert_match /Youve used.*3.*free cards out of 1,000/i, response.body
  end
  test "paid users see thank you message" do
    sign_in_as :kevin
    accounts(:"37s").subscription.update!(plan: Plan.paid, status: :active)
    get account_settings_path(script_name: accounts(:"37s").slug)
    assert_response :success
    assert_select "h3", text: "Thank you for buying Fizzy"
  end
  test "regular plan users see upgrade option" do
    sign_in_as :kevin
    accounts(:"37s").subscription.update!(plan: Plan.paid, status: :active)
    get account_settings_path(script_name: accounts(:"37s").slug)
    assert_response :success
    assert_select "button", text: /upgrade/i
    assert_select "button", text: /downgrade/i, count: 0
  end
  test "extra storage plan users see downgrade option" do
    sign_in_as :kevin
    accounts(:"37s").subscription.update!(plan: Plan.paid_with_extra_storage, status: :active)
    get account_settings_path(script_name: accounts(:"37s").slug)
    assert_response :success
    assert_select "button", text: /downgrade/i
  end
  test "comped accounts see no subscription panel" do
    sign_in_as :mike
    accounts(:initech).comp
    get account_settings_path(script_name: accounts(:initech).slug)
    assert_response :success
    assert_no_match /thank you for buying/i, response.body
    assert_no_match /free cards out of/i, response.body
    assert_no_match /upgrade/i, response.body
    assert_no_match /downgrade/i, response.body
  end
end

================
File: saas/test/controllers/accounts/subscriptions/upgrades_controller_test.rb
================
require "test_helper"
require "ostruct"
class Account::Subscriptions::UpgradesControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
    accounts(:"37s").subscription.update!(stripe_subscription_id: "sub_123", plan: Plan.paid)
  end
  test "upgrade redirects to stripe billing portal" do
    stripe_subscription = OpenStruct.new(items: OpenStruct.new(data: [ OpenStruct.new(id: "si_123") ]))
    portal_session = OpenStruct.new(url: "https://billing.stripe.com/session/abc123")
    Stripe::Subscription.stubs(:retrieve).with("sub_123").returns(stripe_subscription)
    Stripe::BillingPortal::Session.stubs(:create).returns(portal_session)
    post account_subscription_upgrade_path
    assert_redirected_to "https://billing.stripe.com/session/abc123"
  end
  test "upgrade requires admin" do
    logout_and_sign_in_as :david
    post account_subscription_upgrade_path
    assert_response :forbidden
  end
  test "upgrade requires upgradeable plan" do
    accounts(:"37s").subscription.update!(plan: Plan.paid_with_extra_storage)
    post account_subscription_upgrade_path
    assert_response :bad_request
  end
end

================
File: saas/test/controllers/accounts/billing_portals_controller_test.rb
================
require "test_helper"
require "ostruct"
class Account::BillingPortalsControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
  end
  test "redirects to stripe billing portal" do
    Current.account.subscription.update!(stripe_customer_id: "cus_test123")
    session = OpenStruct.new(url: "https://billing.stripe.com/session123")
    Stripe::BillingPortal::Session.expects(:create)
      .with(customer: "cus_test123", return_url: account_settings_url)
      .returns(session)
    get account_billing_portal_path
    assert_redirected_to "https://billing.stripe.com/session123"
  end
  test "requires admin" do
    logout_and_sign_in_as :david
    get account_billing_portal_path
    assert_response :forbidden
  end
end

================
File: saas/test/controllers/accounts/subscriptions_controller_test.rb
================
require "test_helper"
require "ostruct"
class Account::SubscriptionsControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
  end
  test "show" do
    get account_subscription_path
    assert_response :success
  end
  test "show with session_id retrieves stripe session" do
    Stripe::Checkout::Session.stubs(:retrieve).with("sess_123").returns(OpenStruct.new(id: "sess_123"))
    get account_subscription_path(session_id: "sess_123")
    assert_response :success
  end
  test "show requires admin" do
    logout_and_sign_in_as :david
    get account_subscription_path
    assert_response :forbidden
  end
  test "create redirects to stripe checkout" do
    customer = OpenStruct.new(id: "cus_test_37signals")
    session = OpenStruct.new(url: "https://checkout.stripe.com/session123")
    Stripe::Customer.stubs(:retrieve).returns(customer)
    Stripe::Checkout::Session.stubs(:create).returns(session)
    post account_subscription_path
    assert_redirected_to "https://checkout.stripe.com/session123"
  end
  test "create requires admin" do
    logout_and_sign_in_as :david
    post account_subscription_path
    assert_response :forbidden
  end
  test "create with custom plan_key redirects to stripe checkout" do
    customer = OpenStruct.new(id: "cus_test_37signals")
    session = OpenStruct.new(url: "https://checkout.stripe.com/session123")
    Stripe::Customer.stubs(:retrieve).returns(customer)
    Stripe::Checkout::Session.stubs(:create).with do |params|
      params[:metadata][:plan_key] == :monthly_extra_storage_v1
    end.returns(session)
    post account_subscription_path(plan_key: :monthly_extra_storage_v1)
    assert_redirected_to "https://checkout.stripe.com/session123"
  end
end

================
File: saas/test/controllers/admin/accounts_controller_test.rb
================
require "test_helper"
class Admin::AccountsControllerTest < ActionDispatch::IntegrationTest
  test "staff can access index" do
    sign_in_as :david
    untenanted do
      get saas.admin_accounts_path
    end
    assert_response :success
  end
  test "search account" do
    sign_in_as :david
    untenanted do
      post saas.admin_account_search_path, params: { q: accounts(:"37s").external_account_id }
      assert_redirected_to saas.edit_admin_account_path(accounts(:"37s").external_account_id)
    end
  end
  test "staff can edit account" do
    sign_in_as :david
    untenanted do
      get saas.edit_admin_account_path(accounts(:"37s").external_account_id)
    end
    assert_response :success
  end
  test "staff can override card count" do
    sign_in_as :david
    untenanted do
      patch saas.admin_account_path(accounts(:"37s").external_account_id), params: { account: { card_count: 500 } }
      assert_redirected_to saas.edit_admin_account_path(accounts(:"37s").external_account_id)
    end
    assert_equal 500, accounts(:"37s").reload.billed_cards_count
  end
  test "non-staff cannot access accounts" do
    sign_in_as :jz
    untenanted do
      patch saas.admin_account_path(accounts(:"37s").external_account_id), params: { account: { cards_count: 9999 } }
    end
    assert_response :forbidden
    assert_not_equal 9999, accounts(:"37s").reload.cards_count
  end
end

================
File: saas/test/controllers/admin/audits_controller_test.rb
================
require "test_helper"
class Admin::AuditsControllerTest < ActionDispatch::IntegrationTest
  # Test authentication via the Audits1984::SessionsController#index endpoint,
  # which inherits from Admin::AuditsController through Audits1984::ApplicationController.
  test "unauthenticated access is forbidden" do
    untenanted do
      get saas.admin_audits1984_path
      assert_redirected_to new_session_path
    end
  end
  test "logged-in non-staff access is forbidden" do
    sign_in_as :jz
    untenanted do
      get saas.admin_audits1984_path
    end
    assert_response :forbidden
  end
  test "logged-in staff access is allowed" do
    sign_in_as :david
    untenanted do
      get saas.admin_audits1984_path
    end
    assert_response :success
  end
  test "invalid bearer token is forbidden" do
    untenanted do
      get saas.admin_audits1984_path, headers: { "Authorization" => "Bearer invalid_token" }
    end
    assert_response :unauthorized
  end
  test "valid bearer token is allowed" do
    token = Audits1984::AuditorToken.generate_for(identities(:david))
    untenanted do
      get saas.admin_audits1984_path, headers: { "Authorization" => "Bearer #{token}" }
    end
    assert_response :success
  end
  test "expired bearer token is forbidden" do
    token = Audits1984::AuditorToken.generate_for(identities(:david))
    Audits1984::AuditorToken.update_all(expires_at: 1.day.ago)
    untenanted do
      get saas.admin_audits1984_path, headers: { "Authorization" => "Bearer #{token}" }
    end
    assert_response :unauthorized
  end
  test "bearer token for non-staff user is forbidden" do
    # Even with a valid token, non-staff users should be denied access.
    # This handles the case where a user's staff privileges are revoked
    # after a token was issued.
    token = Audits1984::AuditorToken.generate_for(identities(:jz))
    untenanted do
      get saas.admin_audits1984_path, headers: { "Authorization" => "Bearer #{token}" }
    end
    assert_response :forbidden
  end
end

================
File: saas/test/controllers/admin/billing_waivers_controller_test.rb
================
require "test_helper"
class Admin::BillingWaiversControllerTest < ActionDispatch::IntegrationTest
  test "staff can comp an account" do
    sign_in_as :david
    account = accounts(:"37s")
    assert_not account.comped?
    untenanted do
      post saas.admin_account_billing_waiver_path(account.external_account_id)
      assert_redirected_to saas.edit_admin_account_path(account.external_account_id)
    end
    assert account.reload.comped?
  end
  test "staff can uncomp an account" do
    sign_in_as :david
    account = accounts(:"37s")
    account.comp
    assert account.comped?
    untenanted do
      delete saas.admin_account_billing_waiver_path(account.external_account_id)
      assert_redirected_to saas.edit_admin_account_path(account.external_account_id)
    end
    assert_not account.reload.comped?
  end
end

================
File: saas/test/controllers/admin/overridden_limits_controller_test.rb
================
require "test_helper"
class Admin::OverriddenLimitsControllerTest < ActionDispatch::IntegrationTest
  test "staff can reset overridden limits" do
    sign_in_as :david
    account = accounts(:"37s")
    # First set an override
    account.override_limits(card_count: 500)
    assert_equal 500, account.reload.billed_cards_count
    # Then reset it
    untenanted do
      delete saas.admin_account_overridden_limits_path(account.external_account_id)
      assert_redirected_to saas.edit_admin_account_path(account.external_account_id)
    end
    # Verify override was removed
    assert_nil account.reload.overridden_limits
    assert_equal account.cards_count, account.billed_cards_count
  end
end

================
File: saas/test/controllers/admin/stats_controller_test.rb
================
require "test_helper"
class Admin::StatsControllerTest < ActionDispatch::IntegrationTest
  test "staff can access stats" do
    sign_in_as :david
    untenanted do
      get saas.admin_stats_path
    end
    assert_response :success
  end
  test "non-staff cannot access stats" do
    sign_in_as :jz
    untenanted do
      get saas.admin_stats_path
    end
    assert_response :forbidden
  end
end

================
File: saas/test/controllers/card/limited_creation_test.rb
================
require "test_helper"
class Card::LimitedCreationTest < ActionDispatch::IntegrationTest
  test "cannot create cards via JSON when card limit exceeded" do
    sign_in_as :mike
    accounts(:initech).update_column(:cards_count, 1001)
    assert_no_difference -> { Card.count } do
      post board_cards_path(boards(:miltons_wish_list), script_name: accounts(:initech).slug, format: :json)
    end
    assert_response :forbidden
  end
  test "can create cards via HTML when card limit exceeded but they are drafts" do
    sign_in_as :mike
    accounts(:initech).update_column(:cards_count, 1001)
    boards(:miltons_wish_list).cards.drafted.where(creator: users(:mike)).destroy_all
    assert_difference -> { Card.count } do
      post board_cards_path(boards(:miltons_wish_list), script_name: accounts(:initech).slug)
    end
    assert_response :redirect
    assert Card.last.drafted?
  end
  test "cannot force published status via HTML when card limit exceeded" do
    sign_in_as :mike
    accounts(:initech).update_column(:cards_count, 1001)
    boards(:miltons_wish_list).cards.drafted.where(creator: users(:mike)).destroy_all
    assert_difference -> { Card.count } do
      post board_cards_path(boards(:miltons_wish_list), script_name: accounts(:initech).slug), params: { card: { status: "published" } }
    end
    assert_response :redirect
    assert Card.last.drafted?
  end
  test "cannot create cards via JSON when storage limit exceeded" do
    sign_in_as :mike
    Account.any_instance.stubs(:bytes_used).returns(1.1.gigabytes)
    assert_no_difference -> { Card.count } do
      post board_cards_path(boards(:miltons_wish_list), script_name: accounts(:initech).slug, format: :json)
    end
    assert_response :forbidden
  end
end

================
File: saas/test/controllers/card/limited_publishing_test.rb
================
require "test_helper"
class Card::LimitedPublishingTest < ActionDispatch::IntegrationTest
  test "cannot publish cards when card limit exceeded" do
    sign_in_as :mike
    accounts(:initech).update_column(:cards_count, 1001)
    post card_publish_path(cards(:unfinished_thoughts), script_name: accounts(:initech).slug)
    assert_response :forbidden
    assert cards(:unfinished_thoughts).reload.drafted?
  end
  test "cannot publish cards when storage limit exceeded" do
    sign_in_as :mike
    Account.any_instance.stubs(:bytes_used).returns(1.1.gigabytes)
    post card_publish_path(cards(:unfinished_thoughts), script_name: accounts(:initech).slug)
    assert_response :forbidden
    assert cards(:unfinished_thoughts).reload.drafted?
  end
end

================
File: saas/test/controllers/stripe/webhooks_controller_test.rb
================
require "test_helper"
require "ostruct"
class Stripe::WebhooksControllerTest < ActionDispatch::IntegrationTest
  setup do
    @account = Account.create!(name: "Test")
    @subscription = @account.create_subscription! \
      plan_key: "monthly_v1",
      status: "incomplete",
      stripe_customer_id: "cus_test123"
  end
  test "invalid signature returns bad request" do
    Stripe::Webhook.stubs(:construct_event).raises(Stripe::SignatureVerificationError.new("invalid", "sig"))
    post stripe_webhooks_path
    assert_response :bad_request
  end
  test "checkout session completed activates subscription" do
    stripe_sub = OpenStruct.new(id: "sub_123", customer: "cus_test123", status: "active", cancel_at: nil, items: stub_items(1.month.from_now.to_i))
    event = stripe_event("checkout.session.completed",
      mode: "subscription",
      customer: "cus_test123",
      subscription: "sub_123",
      metadata: { "plan_key" => "monthly_v1" }
    )
    Stripe::Webhook.stubs(:construct_event).returns(event)
    Stripe::Subscription.stubs(:retrieve).returns(stripe_sub)
    Stripe::Invoice.stubs(:create_preview).returns(OpenStruct.new(amount_due: 1999))
    post stripe_webhooks_path
    assert_response :ok
    @subscription.reload
    assert_equal "sub_123", @subscription.stripe_subscription_id
    assert_equal "active", @subscription.status
  end
  test "subscription updated changes status and syncs next amount due" do
    @subscription.update!(stripe_subscription_id: "sub_123", status: "active")
    stripe_sub = OpenStruct.new(
      id: "sub_123",
      customer: "cus_test123",
      status: "past_due",
      cancel_at: nil,
      items: stub_items(1.month.from_now.to_i)
    )
    event = stripe_event("customer.subscription.updated", id: "sub_123")
    Stripe::Webhook.stubs(:construct_event).returns(event)
    Stripe::Subscription.stubs(:retrieve).returns(stripe_sub)
    Stripe::Invoice.stubs(:create_preview).returns(OpenStruct.new(amount_due: 1999))
    post stripe_webhooks_path
    assert_response :ok
    @subscription.reload
    assert_equal "past_due", @subscription.status
    assert_equal 1999, @subscription.next_amount_due_in_cents
  end
  test "subscription deleted cancels subscription" do
    @subscription.update!(stripe_subscription_id: "sub_123", status: "active")
    stripe_sub = OpenStruct.new(
      id: "sub_123",
      customer: "cus_test123",
      status: "canceled",
      cancel_at: nil,
      items: stub_items(1.month.from_now.to_i)
    )
    event = stripe_event("customer.subscription.deleted", id: "sub_123")
    Stripe::Webhook.stubs(:construct_event).returns(event)
    Stripe::Subscription.stubs(:retrieve).returns(stripe_sub)
    post stripe_webhooks_path
    assert_response :ok
    @subscription.reload
    assert_equal "canceled", @subscription.status
    assert_nil @subscription.stripe_subscription_id
    assert_nil @subscription.next_amount_due_in_cents
  end
  private
    def stripe_event(type, **attributes)
      OpenStruct.new(type: type, data: OpenStruct.new(object: OpenStruct.new(attributes)))
    end
    def stub_items(current_period_end)
      OpenStruct.new(data: [ OpenStruct.new(current_period_end: current_period_end) ])
    end
end

================
File: saas/test/controllers/.keep
================


================
File: saas/test/controllers/non_production_remote_access_test.rb
================
require "test_helper"
class NonProductionRemoteAccessTest < ActionDispatch::IntegrationTest
  test "employee can access in staging environment" do
    assert_predicate identities(:david), :employee?
    sign_in_as :david
    Rails.stubs(:env).returns(ActiveSupport::EnvironmentInquirer.new("staging"))
    get cards_path
    assert_response :success
  end
  test "non-employee cannot access in staging environment" do
    identities(:jz).update!(email_address: "david@example.com")
    assert_not_predicate identities(:jz), :employee?
    sign_in_as :jz
    Rails.stubs(:env).returns(ActiveSupport::EnvironmentInquirer.new("staging"))
    get cards_path
    assert_response :forbidden
  end
  test "non-employee can access in production environment" do
    identities(:jz).update!(email_address: "david@example.com")
    assert_not_predicate identities(:jz), :employee?
    sign_in_as :jz
    Rails.stubs(:env).returns(ActiveSupport::EnvironmentInquirer.new("production"))
    get cards_path
    assert_response :success
  end
  test "non-employee can access in beta environment" do
    identities(:jz).update!(email_address: "david@example.com")
    assert_not_predicate identities(:jz), :employee?
    sign_in_as :jz
    Rails.stubs(:env).returns(ActiveSupport::EnvironmentInquirer.new("beta"))
    get cards_path
    assert_response :success
  end
  test "non-employee can access in local environment" do
    identities(:jz).update!(email_address: "david@example.com")
    assert_not_predicate identities(:jz), :employee?
    sign_in_as :jz
    get cards_path
    assert_response :success
  end
end

================
File: saas/test/fixtures/files/.keep
================


================
File: saas/test/fixtures/account_subscriptions.yml
================
_fixture:
  model_class: Account::Subscription
signals_monthly:
  id: <%= ActiveRecord::FixtureSet.identify("signals_monthly", :uuid) %>
  account_id: <%= ActiveRecord::FixtureSet.identify("37s", :uuid) %>
  plan_key: monthly_v1
  status: active
  stripe_customer_id: cus_test_37signals
  created_at: <%= Time.current %>
  updated_at: <%= Time.current %>

================
File: saas/test/helpers/.keep
================


================
File: saas/test/integration/.keep
================


================
File: saas/test/mailers/.keep
================


================
File: saas/test/models/account/billing_test.rb
================
require "test_helper"
class Account::BillingTest < ActiveSupport::TestCase
  test "plan reflects active subscription" do
    account = accounts(:initech)
    # No subscription
    assert_equal Plan.free, account.plan
    # Subscription but it is not active
    account.create_subscription!(plan_key: "monthly_v1", status: "canceled", stripe_customer_id: "cus_test")
    assert_equal Plan.free, account.plan
    # Active subscription exists
    account.subscription.update!(status: "active")
    assert_equal Plan.paid, account.plan
  end
  test "comped account" do
    account = accounts(:"37s")
    assert_not account.comped?
    account.comp
    assert account.comped?
    # Calling comp again does not create duplicate
    account.comp
    assert_equal 1, Account::BillingWaiver.where(account: account).count
  end
  test "cancel callback pauses subscription" do
    account = accounts(:"37s")
    user = users(:david)
    subscription = mock("subscription")
    subscription.expects(:pause).once
    account.stubs(:subscription).returns(subscription)
    account.cancel(initiated_by: user)
  end
  test "reactivate callback resumes subscription" do
    account = accounts(:"37s")
    user = users(:david)
    # First cancel with a subscription mock
    subscription_for_cancel = mock("subscription")
    subscription_for_cancel.expects(:pause).once
    account.stubs(:subscription).returns(subscription_for_cancel)
    account.cancel(initiated_by: user)
    # Now stub for reactivation
    subscription_for_reactivate = mock("subscription")
    subscription_for_reactivate.expects(:resume).once
    account.stubs(:subscription).returns(subscription_for_reactivate)
    account.reactivate
  end
  test "incinerate callback cancels subscription before destroying account" do
    account = accounts(:"37s")
    subscription = mock("subscription")
    subscription.expects(:cancel).once
    account.stubs(:subscription).returns(subscription)
    account.incinerate
  end
  test "owner_email_changed enqueues sync job when subscription exists" do
    account = accounts(:"37s")
    account.create_subscription!(
      stripe_customer_id: "cus_test",
      plan_key: "monthly_v1",
      status: "active"
    )
    assert_enqueued_with(job: Account::SyncStripeCustomerEmailJob, args: [ account.subscription ]) do
      account.owner_email_changed
    end
  end
  test "owner_email_changed does nothing without subscription" do
    account = accounts(:initech)
    account.subscription&.destroy
    assert_no_enqueued_jobs do
      account.owner_email_changed
    end
  end
end

================
File: saas/test/models/account/limited_test.rb
================
require "test_helper"
class Account::LimitedTest < ActiveSupport::TestCase
  test "detect nearing card limit" do
    # Paid plans are never limited
    accounts(:"37s").update_column(:cards_count, 1_000_000)
    assert_not accounts(:"37s").nearing_plan_cards_limit?
    # Free plan not near limit
    accounts(:initech).update_column(:cards_count, 899)
    assert_not accounts(:initech).nearing_plan_cards_limit?
    # Free plan near limit
    accounts(:initech).update_column(:cards_count, 900)
    assert_not accounts(:initech).nearing_plan_cards_limit?
    accounts(:initech).update_column(:cards_count, 901)
    assert accounts(:initech).nearing_plan_cards_limit?
  end
  test "detect exceeding card limit" do
    # Paid plans are never limited
    accounts(:"37s").update_column(:cards_count, 1_000_000)
    assert_not accounts(:"37s").exceeding_card_limit?
    # Free plan under limit
    accounts(:initech).update_column(:cards_count, 999)
    assert_not accounts(:initech).exceeding_card_limit?
    # Free plan over limit
    accounts(:initech).update_column(:cards_count, 1001)
    assert accounts(:initech).exceeding_card_limit?
  end
  test "override limits" do
    account = accounts(:initech)
    account.update_column(:cards_count, 1001)
    assert account.exceeding_card_limit?
    assert_equal 1001, account.billed_cards_count
    account.override_limits card_count: 500
    assert_not account.exceeding_card_limit?
    assert_equal 500, account.billed_cards_count
    assert_equal 1001, account.cards_count # original unchanged
    account.reset_overridden_limits
    assert account.exceeding_card_limit?
    assert_equal 1001, account.billed_cards_count
  end
  test "comped accounts are never limited" do
    account = accounts(:initech)
    account.update_column(:cards_count, 1_000_000)
    assert account.exceeding_card_limit?
    assert account.nearing_plan_cards_limit?
    account.comp
    assert_not account.exceeding_card_limit?
    assert_not account.nearing_plan_cards_limit?
  end
  test "uncomping an account restores limits" do
    account = accounts(:initech)
    account.update_column(:cards_count, 1_000_000)
    account.comp
    assert_not account.exceeding_card_limit?
    account.uncomp
    assert account.exceeding_card_limit?
  end
  test "detect nearing storage limit" do
    # Paid plans have large storage limits
    accounts(:"37s").stubs(:bytes_used).returns(4.gigabytes)
    assert_not accounts(:"37s").nearing_plan_storage_limit?
    # Free plan not near limit
    accounts(:initech).stubs(:bytes_used).returns(400.megabytes)
    assert_not accounts(:initech).nearing_plan_storage_limit?
    # Free plan near limit
    accounts(:initech).stubs(:bytes_used).returns(600.megabytes)
    assert accounts(:initech).nearing_plan_storage_limit?
  end
  test "detect exceeding storage limit" do
    # Free plan under limit
    accounts(:initech).stubs(:bytes_used).returns(900.megabytes)
    assert_not accounts(:initech).exceeding_storage_limit?
    # Free plan over limit
    accounts(:initech).stubs(:bytes_used).returns(1.1.gigabytes)
    assert accounts(:initech).exceeding_storage_limit?
  end
  test "override bytes_used limits" do
    account = accounts(:initech)
    account.stubs(:bytes_used).returns(1.1.gigabytes)
    assert account.exceeding_storage_limit?
    assert_equal 1.1.gigabytes, account.billed_bytes_used
    account.override_limits bytes_used: 500.megabytes
    assert_not account.exceeding_storage_limit?
    assert_equal 500.megabytes, account.billed_bytes_used
    assert_equal 1.1.gigabytes, account.bytes_used # original unchanged
    account.reset_overridden_limits
    assert account.exceeding_storage_limit?
    assert_equal 1.1.gigabytes, account.billed_bytes_used
  end
end

================
File: saas/test/models/account/subscription_test.rb
================
require "test_helper"
class Account::SubscriptionTest < ActiveSupport::TestCase
  test "get the account plan" do
    subscription = Account::Subscription.new(plan_key: "free_v1")
    assert_equal Plan[:free_v1], subscription.plan
  end
  test "check if account is active" do
    subscription = Account::Subscription.new(status: "active")
    assert subscription.active?
  end
  test "check if account is paid" do
    assert Account::Subscription.new(plan_key: "monthly_v1", status: "active").paid?
    assert_not Account::Subscription.new(plan_key: "free_v1", status: "active").paid?
  end
  test "pause pauses Stripe subscription with void behavior" do
    subscription = Account::Subscription.new(stripe_subscription_id: "sub_123")
    Stripe::Subscription.expects(:update).with(
      "sub_123",
      pause_collection: { behavior: "void" }
    ).returns(true)
    subscription.pause
  end
  test "pause does nothing when no stripe_subscription_id" do
    subscription = Account::Subscription.new(stripe_subscription_id: nil)
    Stripe::Subscription.expects(:update).never
    subscription.pause
  end
  test "pause raises on Stripe errors" do
    subscription = Account::Subscription.new(stripe_subscription_id: "sub_123")
    Stripe::Subscription.stubs(:update).raises(
      Stripe::APIConnectionError.new("Network error")
    )
    assert_raises Stripe::APIConnectionError do
      subscription.pause
    end
  end
  test "resume resumes Stripe subscription" do
    subscription = Account::Subscription.new(stripe_subscription_id: "sub_123")
    Stripe::Subscription.expects(:update).with(
      "sub_123",
      pause_collection: ""
    ).returns(true)
    subscription.resume
  end
  test "resume does nothing when no stripe_subscription_id" do
    subscription = Account::Subscription.new(stripe_subscription_id: nil)
    Stripe::Subscription.expects(:update).never
    subscription.resume
  end
  test "resume raises on Stripe errors" do
    subscription = Account::Subscription.new(stripe_subscription_id: "sub_123")
    Stripe::Subscription.stubs(:update).raises(
      Stripe::AuthenticationError.new("Invalid API key")
    )
    assert_raises Stripe::AuthenticationError do
      subscription.resume
    end
  end
  test "cancel cancels Stripe subscription" do
    subscription = Account::Subscription.new(stripe_subscription_id: "sub_123")
    Stripe::Subscription.expects(:cancel).with("sub_123").returns(true)
    subscription.cancel
  end
  test "cancel does nothing when no stripe_subscription_id" do
    subscription = Account::Subscription.new(stripe_subscription_id: nil)
    Stripe::Subscription.expects(:cancel).never
    subscription.cancel
  end
  test "cancel treats 404 as success" do
    subscription = Account::Subscription.new(stripe_subscription_id: "sub_deleted")
    Stripe::Subscription.stubs(:cancel).raises(
      Stripe::InvalidRequestError.new("No such subscription", {})
    )
    assert_nothing_raised do
      subscription.cancel
    end
  end
  test "cancel raises on other Stripe errors" do
    subscription = Account::Subscription.new(stripe_subscription_id: "sub_123")
    Stripe::Subscription.stubs(:cancel).raises(
      Stripe::RateLimitError.new("Rate limit exceeded")
    )
    assert_raises Stripe::RateLimitError do
      subscription.cancel
    end
  end
  test "sync_customer_email_to_stripe updates Stripe customer with owner email" do
    account = accounts(:"37s")
    owner = account.users.find_by(role: :owner) || account.users.first.tap { |u| u.update!(role: :owner) }
    subscription = account.create_subscription!(
      stripe_customer_id: "cus_test",
      plan_key: "monthly_v1",
      status: "active"
    )
    Stripe::Customer.expects(:update).with("cus_test", email: owner.identity.email_address).once
    subscription.sync_customer_email_to_stripe
  end
  test "sync_customer_email_to_stripe does nothing without stripe_customer_id" do
    account = accounts(:"37s")
    subscription = account.build_subscription(
      stripe_customer_id: nil,
      plan_key: "free_v1",
      status: "active"
    )
    Stripe::Customer.expects(:update).never
    subscription.sync_customer_email_to_stripe
  end
  test "sync_customer_email_to_stripe does nothing without owner" do
    account = accounts(:"37s")
    account.users.update_all(role: :member)
    subscription = account.create_subscription!(
      stripe_customer_id: "cus_test",
      plan_key: "monthly_v1",
      status: "active"
    )
    Stripe::Customer.expects(:update).never
    subscription.sync_customer_email_to_stripe
  end
  test "sync_customer_email_to_stripe does nothing when owner has no identity" do
    account = accounts(:"37s")
    owner = account.users.find_by(role: :owner) || account.users.first.tap { |u| u.update!(role: :owner) }
    owner.update_column(:identity_id, nil)
    subscription = account.create_subscription!(
      stripe_customer_id: "cus_test",
      plan_key: "monthly_v1",
      status: "active"
    )
    Stripe::Customer.expects(:update).never
    subscription.sync_customer_email_to_stripe
  end
  test "sync_customer_email_to_stripe treats deleted customer as success" do
    account = accounts(:"37s")
    account.users.find_by(role: :owner) || account.users.first.tap { |u| u.update!(role: :owner) }
    subscription = account.create_subscription!(
      stripe_customer_id: "cus_deleted",
      plan_key: "monthly_v1",
      status: "active"
    )
    Stripe::Customer.stubs(:update).raises(
      Stripe::InvalidRequestError.new("No such customer", {})
    )
    assert_nothing_raised do
      subscription.sync_customer_email_to_stripe
    end
  end
end

================
File: saas/test/models/user/notifies_account_of_email_change_test.rb
================
require "test_helper"
class User::NotifiesAccountOfEmailChangeTest < ActiveSupport::TestCase
  setup do
    @account = accounts(:"37s")
    @owner = @account.users.find_by(role: :owner) || @account.users.first.tap { |u| u.update!(role: :owner) }
    @member = @account.users.where.not(id: @owner.id).first || @account.users.create!(
      name: "Member",
      identity: Identity.create!(email_address: "member@example.com"),
      role: :member
    )
  end
  test "notifies account when owner changes email" do
    @account.expects(:owner_email_changed).once
    new_identity = Identity.create!(email_address: "new-owner@example.com")
    @owner.update!(identity: new_identity)
  end
  test "does not notify account when non-owner changes email" do
    @account.expects(:owner_email_changed).never
    new_identity = Identity.create!(email_address: "new-member@example.com")
    @member.update!(identity: new_identity)
  end
  test "does not notify account when owner is deactivated" do
    @account.expects(:owner_email_changed).never
    @owner.update!(identity: nil)
  end
  test "does not notify account when identity unchanged" do
    @account.expects(:owner_email_changed).never
    @owner.update!(name: "New Name")
  end
  test "notifies account when user becomes owner" do
    @account.expects(:owner_email_changed).once
    @member.update!(role: :owner)
  end
  test "does not notify account when owner becomes member" do
    @account.expects(:owner_email_changed).never
    @owner.update!(role: :member)
  end
end

================
File: saas/test/models/identity_test.rb
================
require "test_helper"
class Fizzy::Saas::IdentityTest < ActiveSupport::TestCase
  test "#employee? returns true for 37signals.com domains" do
    identity = Identity.new(email_address: "mike@37signals.com")
    assert_predicate identity, :employee?
  end
  test "#employee? returns true for basecamp.com domains" do
    identity = Identity.new(email_address: "mike@basecamp.com")
    assert_predicate identity, :employee?
  end
  test "#employee? returns false for other domains" do
    identity = Identity.new(email_address: "mike@example.com")
    assert_not_predicate identity, :employee?
  end
end

================
File: saas/test/models/plan_test.rb
================
require "test_helper"
class PlanTest < ActiveSupport::TestCase
  test "free plan is free" do
    assert Plan[:free_v1].free?
  end
  test "monthly plan is not free" do
    assert_not Plan[:monthly_v1].free?
  end
  test "find plan by its price id" do
    Plan.paid.stubs(:stripe_price_id).returns("price_monthly_v1")
    assert_equal Plan.paid, Plan.find_by_price_id("price_monthly_v1")
    assert_nil Plan.find_by_price_id("unknown_price_id")
  end
end

================
File: saas/test/models/signup_test.rb
================
require "test_helper"
class Fizzy::Saas::SignupTest < ActiveSupport::TestCase
  test "#complete creates queenbee account and uses its id as tenant" do
    queenbee_account = mock("queenbee_account")
    queenbee_account.stubs(:id).returns(123456)
    Queenbee::Remote::Account.expects(:create!).once.returns(queenbee_account)
    Account.any_instance.expects(:setup_customer_template).once
    Current.without_account do
      assert_changes -> { Account.count }, +1 do
        sequence_value_before = Account::ExternalIdSequence.value
        signup = Signup.new(
          full_name: "Kevin",
          identity: identities(:kevin)
        )
        assert signup.complete
        assert signup.account
        assert_equal 123456, signup.account.external_account_id
        assert_equal sequence_value_before, Account::ExternalIdSequence.value
      end
    end
  end
  test "#complete calls cancel on queenbee account when account creation fails" do
    queenbee_account = mock("queenbee_account")
    queenbee_account.stubs(:id).returns(789012)
    queenbee_account.expects(:cancel).once
    Queenbee::Remote::Account.expects(:create!).once.returns(queenbee_account)
    Account.any_instance.stubs(:setup_customer_template).raises(StandardError.new("Account setup failed"))
    Current.without_account do
      signup = Signup.new(
        full_name: "Kevin",
        identity: identities(:kevin)
      )
      assert_not signup.complete
      assert_includes signup.errors[:base], "Something went wrong, and we couldn't create your account. Please give it another try."
    end
  end
end

================
File: saas/Dockerfile
================
# Make sure RUBY_VERSION matches the Ruby version in .ruby-version
ARG RUBY_VERSION=3.4.7
FROM registry.docker.com/library/ruby:$RUBY_VERSION-slim AS base

# Rails app lives here
WORKDIR /rails

# Set production environment
ENV RAILS_ENV="production" \
    BUNDLE_DEPLOYMENT="1" \
    SAAS="1" \
    BUNDLE_PATH="/usr/local/bundle" \
    BUNDLE_GEMFILE="Gemfile.saas" \
    BUNDLE_WITHOUT="development"


# Throw-away build stage to reduce size of final image
FROM base AS build

# Install packages needed to build gems
RUN apt-get update -qq && \
    apt-get install -y --no-install-recommends -y build-essential pkg-config git libvips libyaml-dev libssl-dev && \
    rm -rf /var/lib/apt/lists /var/cache/apt/archives

# Install application gems
COPY Gemfile Gemfile.lock Gemfile.saas Gemfile.saas.lock .ruby-version ./
COPY lib/fizzy.rb ./lib/fizzy.rb
COPY saas/fizzy-saas.gemspec ./saas/
COPY saas/lib/fizzy/saas/version.rb ./saas/lib/fizzy/saas/
RUN --mount=type=secret,id=GITHUB_TOKEN --mount=type=cache,id=fizzy-permabundle-${RUBY_VERSION},sharing=locked,target=/permabundle \
    gem install bundler && \
    BUNDLE_PATH=/permabundle BUNDLE_GITHUB__COM="$(cat /run/secrets/GITHUB_TOKEN):x-oauth-basic" bundle install && \
    cp -a /permabundle/. "$BUNDLE_PATH"/ && \
    bundle clean --force && \
    rm -rf "$BUNDLE_PATH"/ruby/*/bundler/gems/*/.git && \
    find "$BUNDLE_PATH" -type f \( -name '*.gem' -o -iname '*.a' -o -iname '*.o' -o -iname '*.h' -o -iname '*.c' -o -iname '*.hpp' -o -iname '*.cpp' \) -delete && \
    bundle exec bootsnap precompile --gemfile

# Copy application code
COPY . .

# Precompile bootsnap code for faster boot times
RUN bundle exec bootsnap precompile app/ lib/

# Precompiling assets for production
RUN SECRET_KEY_BASE_DUMMY=1 \
    ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY=1 \
    ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY=1 \
    ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT=1 \
    ./bin/rails assets:precompile

# Final stage for app image
FROM base

# Install packages needed for deployment
RUN apt-get update -qq && \
    apt-get install --no-install-recommends -y curl libsqlite3-0 libvips build-essential ffmpeg groff libreoffice-writer libreoffice-impress libreoffice-calc mupdf-tools sqlite3 libjemalloc-dev && \
    rm -rf /var/lib/apt/lists /var/cache/apt/archives

# Copy built artifacts: gems, application
COPY --from=build /usr/local/bundle /usr/local/bundle
COPY --from=build /rails /rails

# Run and own only the runtime files as a non-root user for security
RUN useradd rails --create-home --shell /bin/bash && \
    chown -R rails:rails db log storage tmp
USER rails:rails

# Entrypoint prepares the database.
ENTRYPOINT ["/rails/bin/docker-entrypoint"]

# Ruby GC tuning values pulled from Autotuner recommendations
ENV RUBY_GC_HEAP_0_INIT_SLOTS=692636 \
    RUBY_GC_HEAP_1_INIT_SLOTS=175943 \
    RUBY_GC_HEAP_2_INIT_SLOTS=148807 \
    RUBY_GC_HEAP_3_INIT_SLOTS=9169 \
    RUBY_GC_HEAP_4_INIT_SLOTS=3054 \
    RUBY_GC_MALLOC_LIMIT=67108864 \
    RUBY_GC_MALLOC_LIMIT_MAX=134217728 \
    LD_PRELOAD=/usr/lib/x86_64-linux-gnu/libjemalloc.so.2

# Start the server by default, this can be overwritten at runtime
EXPOSE 80 443 9394
CMD ["./bin/thrust", "./bin/rails", "server"]

================
File: saas/fizzy-saas.gemspec
================
require_relative "lib/fizzy/saas/version"

Gem::Specification.new do |spec|
  spec.name        = "fizzy-saas"
  spec.version     = Fizzy::Saas::VERSION
  spec.authors     = [ "Mike Dalessio" ]
  spec.email       = [ "mike@37signals.com" ]
  spec.homepage    = "https://github.com/basecamp/fizzy-saas"
  spec.summary     = "37signals SaaS companion for Fizzy"
  spec.description = "Rails engine that bundles with Fizzy to offer the hosted version at https://app.fizzy.do"
  spec.license     = "O'Saasy"

  # Prevent pushing this gem to RubyGems.org. To allow pushes either set the "allowed_push_host"
  # to allow pushing to a single host or delete this section to allow pushing to any host.
  spec.metadata["allowed_push_host"] = "https://rubygems.org"

  spec.metadata["homepage_uri"] = spec.homepage
  spec.metadata["source_code_uri"] = "https://github.com/basecamp/fizzy-saas"

  spec.files = Dir.chdir(File.expand_path(__dir__)) do
    Dir["{app,config,db,lib,exe}/**/*", "test/fixtures/**/*", "LICENSE.md", "Rakefile", "README.md"]
  end

  spec.bindir = "exe"
  spec.executables = [ "stripe-dev" ]

  spec.add_dependency "rails", ">= 8.1.0.beta1"
  spec.add_dependency "queenbee"
  spec.add_dependency "rails_structured_logging"
  spec.add_dependency "sentry-ruby"
  spec.add_dependency "sentry-rails"
  spec.add_dependency "yabeda"
  spec.add_dependency "yabeda-actioncable"
  spec.add_dependency "yabeda-activejob"
  spec.add_dependency "yabeda-gc"
  spec.add_dependency "yabeda-http_requests"
  spec.add_dependency "yabeda-prometheus-mmap"
  spec.add_dependency "yabeda-puma-plugin"
  spec.add_dependency "yabeda-rails", ">= 0.10"
  spec.add_dependency "prometheus-client-mmap", "~> 1.4.0"
  spec.add_dependency "console1984"
  spec.add_dependency "audits1984"
end

================
File: saas/Gemfile
================
source "https://rubygems.org"
git_source(:bc) { |repo| "https://github.com/basecamp/#{repo}" }

# 37id and Queenbee integration
gem "queenbee", bc: "queenbee-plugin", ref: "14312a940471e20617b38cdec7c092a01567d18b"
gem "rails_structured_logging", bc: "rails-structured-logging"
gem "activeresource", require: "active_resource" # needed by queenbee

gem "rubocop-rails-omakase", require: false

================
File: saas/LICENSE.md
================
# O'Saasy License Agreement

Copyright  2025, 37signals LLC.

Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:

1. The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.
2. No licensee or downstream recipient may use the Software (including any modified or derivative versions) to directly compete with the original Licensor by offering it to third parties as a hosted, managed, or Software-as-a-Service (SaaS) product or cloud service where the primary value of the service is the functionality of the Software itself.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

================
File: saas/Rakefile
================
require "bundler/setup"

APP_RAKEFILE = File.expand_path("test/dummy/Rakefile", __dir__)
load "rails/tasks/engine.rake"

load "rails/tasks/statistics.rake"

require "bundler/gem_tasks"

================
File: saas/README.md
================
This is a Rails engine that [37signals](https://37signals.com/) bundles with [Fizzy](https://github.com/basecamp/fizzy) to offer the hosted version at https://fizzy.do.

## Development

To make Fizzy run in SaaS mode, run this in the terminal:

```ruby
bin/rails saas:enable
```

To go back to open source mode:

```ruby
bin/rails saas:disable
```

Then you can work do [Fizzy development as usual](https://github.com/basecamp/fizzy).

## How to update Fizzy

After making changes to this gem, you need to update Fizzy to pick up the changes:

```ruby
BUNDLE_GEMFILE=Gemfile.saas bundle update --conservative fizzy-saas
```

## Working with Stripe

The first time, you need to:

1. Install Stripe CLI: https://stripe.com/docs/stripe-cli
2. Run `stripe login` and authorize the environment `37signals Development`

Then, for working on the Stripe integration locally, you need to run this script to start the tunneling and set the environment variables:

```sh
eval "$(BUNDLE_GEMFILE=Gemfile.saas bundle exec stripe-dev)"
bin/dev # You need to start the dev server in the same terminal session
```

This will ask for your 1password authorization to read and set the environment variables that Stripe needs.

### Stripe environments

* [Development](https://dashboard.stripe.com/acct_1SdTFtRus34tgjsJ/test/dashboard)
* [Staging](https://dashboard.stripe.com/acct_1SdTbuRvb8txnPBR/test/dashboard)
* [Production](https://dashboard.stripe.com/acct_1SNy97RwChFE4it8/dashboard)

## Environments

Fizzy is deployed with [Kamal](https://kamal-deploy.org/). You'll need to have the 1Password CLI set up in order to access the secrets that are used when deploying. Provided you have that, it should be as simple as `bin/kamal deploy` to the correct environment.

## Handbook

See the [Fizzy handbook](https://handbooks.37signals.works/18/fizzy) for runbooks and more.

### Production

- https://app.fizzy.do/

This environment uses a FlashBlade bucket for blob storage.

### Beta

Beta is primarily intended for testing product features. It uses the same production database and Active Storage configuration.

There are 4 beta environments:

- https://beta1.fizzy-beta.com
- https://beta2.fizzy-beta.com
- https://beta3.fizzy-beta.com
- https://beta4.fizzy-beta.com

Deploy with: `bin/kamal deploy -d beta1` (or `-d beta2`, `-d beta3`, `-d beta4`)

### Staging

Staging is primarily intended for testing infrastructure changes. It uses production-like but separate database and Active Storage configurations.

- https://app.fizzy-staging.com/

## License

fizzy-saas is released under the [O'Saasy License](LICENSE.md).

================
File: script/maintenance/fix_cross_account_taggings.rb
================
#!/usr/bin/env ruby
require_relative "../../config/environment"
cross_account_taggings = Tagging.joins(:tag).where("taggings.account_id != tags.account_id")
puts "Found #{cross_account_taggings.count} cross-account taggings to fix"
cross_account_taggings.find_each do |tagging|
  correct_tag = tagging.account.tags.find_or_create_by!(title: tagging.tag.title)
  tagging.update!(tag: correct_tag)
  puts "Fixed tagging #{tagging.id}: reassigned to tag #{correct_tag.id}"
end
puts "Done!"

================
File: script/maintenance/remove_duplicated_search_queries.rb
================
#!/usr/bin/env ruby
require_relative "../config/environment"
ApplicationRecord.with_each_tenant do |tenant|
  User.find_each do |user|
    search_queries = Set.new
    to_delete = []
    user.search_queries.find_each do |search_query|
      if search_queries.include?(search_query.terms)
        to_delete << search_query
      end
      search_queries << search_query.terms
    end
    to_delete.each(&:destroy)
  end
end

================
File: script/maintenance/remove_duplicated_tags.rb
================
#!/usr/bin/env ruby
require_relative "../config/environment"
ApplicationRecord.with_each_tenant do |tenant|
  Account.find_each do |account|
    tags_grouped_by_title = account.tags.group_by { |tag| tag.title.downcase }
    tags_grouped_by_title.each do |title, tags|
      if tags.length > 1
        to_keep, to_merge = tags.first, tags[1..]
        to_merge.each do |tag_to_merge|
          tag_to_merge.cards.each do |card|
            to_keep.cards << card unless to_keep.cards.include?(card)
          end
          tag_to_merge.destroy
        end
      end
    end
  end
end

================
File: script/migrations/renaming/content.rb
================
#!/usr/bin/env ruby
require "find"
require "active_support/core_ext/string" # for camelize
RENAME_RULES = {
  "bubble" => "card",
  "closed" => "closed",
  "poppable" => "closeable",
  "pop" => "closure",
  "bucket" => "board"
}
EXTENSIONS = %w[.rb .yml .html .js .css .erb]
EXCLUDED_DIRS = %w[db .git script/renaming vendor/javascript]
# Helper to build replacement regex patterns respecting case and separators
def build_patterns(from, to)
  boundary = "(?<=\\A|[^a-zA-Z0-9])#{from}(?=[^a-zA-Z0-9]|\\z)"
  camel = from.camelize
  camel_plural = camel.pluralize
  underscore_plural = from.pluralize.underscore
  dasherized_plural = underscore_plural.dasherize
  [
    # Match lowercase boundary-delimited
    [ /#{boundary}/, to ],
    # Match capitalized version (e.g., Bubble => Card)
    [ /(?<![a-zA-Z0-9])#{from.capitalize}(?![a-z])/, to.capitalize ],
    # Match all-uppercase
    [ /(?<![a-zA-Z0-9])#{from.upcase}(?![A-Z])/, to.upcase ],
    # Match CamelCase and plural CamelCase
    [ /(?<![a-zA-Z0-9])#{camel}(?![a-z])/, to.camelize ],
    [ /(?<![a-zA-Z0-9])#{camel_plural}(?![a-z])/, to.camelize.pluralize ],
    # Match lowerCamelCase
    [ /(?<![a-zA-Z0-9])#{from.camelize(:lower)}(?![a-z])/, to.camelize(:lower) ],
    # Match underscore and dashed plural forms (e.g. bubbles(:logo) => cards(:logo))
    [ /(?<![a-zA-Z0-9])#{underscore_plural}(?![a-z])/, to.pluralize.underscore ],
    [ /(?<![a-zA-Z0-9])#{dasherized_plural}(?![a-z])/, to.pluralize.underscore.dasherize ]
  ]
end
patterns = []
RENAME_RULES.each do |from, to|
  patterns.concat(build_patterns(from, to))
end
Find.find(".") do |path|
  next if File.directory?(path)
  next unless EXTENSIONS.include?(File.extname(path))
  next if EXCLUDED_DIRS.any? { |dir| path.start_with?("./#{dir}/") }
  content = File.read(path)
  original_content = content.dup
  patterns.each do |regex, replacement|
    content.gsub!(regex, replacement)
  end
  if content != original_content
    puts "Renaming in: #{path}"
    File.write(path, content)
  end
end

================
File: script/migrations/renaming/files.rb
================
#!/usr/bin/env ruby
require "fileutils"
require "active_support/core_ext/string" # for camelize
# Configuration
EXCLUDED_DIRS = [ "db", ".git", "script/renaming" ].freeze
RENAMES = {
  "bubble" => "card",
  "poppable" => "closeable",
  "closed" => "closed",
  "pop" => "closure",
  "bucket" => "board"
}.freeze
FILE_EXTENSIONS = %w[rb yml html css js jpg jpeg png gif svg erb].freeze
def excluded_path?(path)
  EXCLUDED_DIRS.any? { |excluded| path.split(File::SEPARATOR).include?(excluded) }
end
def rename_path(path)
  new_path = path.dup
  RENAMES.each do |from, to|
    # Replace snake_case, kebab-case, plain, and CamelCase versions
    patterns = [
      [ /(?<=\A|[^a-zA-Z0-9])#{from}(?=[^a-zA-Z0-9]|\z)/i, to ],
      [ from.camelize, to.camelize ],
      [ from.camelize(:lower), to.camelize(:lower) ],
      [ from.underscore.dasherize, to.underscore.dasherize ],
      [ from.underscore, to.underscore ]
    ]
    patterns.each do |pattern, replacement|
      new_path.gsub!(pattern, replacement)
    end
  end
  new_path
end
# Rename Directories First
dirs = Dir.glob("**/*/").reject { |path| excluded_path?(path) }.sort_by { |dir| -dir.count("/") }
puts "Renaming directories..."
dirs.each do |dir|
  clean_dir = dir.chomp("/")
  new_dir = rename_path(clean_dir)
  next if clean_dir == new_dir
  next if File.exist?(new_dir)
  puts "Renaming dir: #{clean_dir} => #{new_dir}"
  FileUtils.mkdir_p(File.dirname(new_dir))
  FileUtils.mv(clean_dir, new_dir)
end
# Rename Files
files = Dir.glob("**/*.{#{FILE_EXTENSIONS.join(",")}}").reject { |path| excluded_path?(path) }
puts "Renaming files..."
files.each do |file|
  new_file = rename_path(file)
  next if file == new_file
  next if File.exist?(new_file)
  puts "Renaming file: #{file} => #{new_file}"
  FileUtils.mkdir_p(File.dirname(new_file))
  FileUtils.mv(file, new_file)
end
puts "Renaming complete!"

================
File: script/migrations/20250924-populate-identities.rb
================
#!/usr/bin/env ruby
require_relative "../../config/environment"
ApplicationRecord.with_each_tenant do |tenant|
  puts "# #{tenant}"
  User.find_each do |user|
    next if user.system? || !user.active?
    if user.membership.present?
      puts "Found identity #{user.identity.id} for user #{user.id} (#{user.email_address})"
    else
      memberships = Membership.where(email_address: user.email_address)
      if memberships.empty?
        # Create a new Identity
        Identity.transaction do
          identity = Identity.create!
          user.membership = identity.memberships.create!(user_id: user.id, user_tenant: user.tenant, email_address: user.email_address, account_name: Current.account.name)
          puts "Created identity #{identity.id} for user #{user.id} (#{user.email_address})"
        end
      else
        # Merge this User's Membership into the existing Identity
        identity = memberships.first.identity
        user.membership = identity.memberships.create!(user_id: user.id, user_tenant: user.tenant, email_address: user.email_address, account_name: Current.account.name)
        puts "Merged membership for user #{user.id} (#{user.email_address}) into identity #{identity.id}"
      end
    end
  end
end

================
File: script/migrations/20251028-populate_membership_id_on_users.rb
================
#!/usr/bin/env ruby
require_relative "../../config/environment"
ApplicationRecord.with_each_tenant do |tenant|
  puts " #{tenant}"
  User.find_each do |user|
    next if user.system? || !user.active?
    if user.membership.present?
      puts " User #{user.id} has a membership"
    else
      puts " Creating membership for user #{user.id}"
      identity = Identity.find_or_create_by(email_address: user.email_address)
      membership = identity.memberships.find_or_create_by(tenant: tenant)
      user.update_columns(membership_id: membership.id)
    end
  end
end

================
File: script/migrations/20251029-populate-column-positions.rb
================
#!/usr/bin/env ruby
require_relative "../../config/environment"
ApplicationRecord.with_each_tenant do |tenant|
  puts "Processing tenant: #{tenant}"
  Board.find_each do |board|
    puts "  Processing board: #{board.name} (ID: #{board.id})"
    columns = board.columns.order(:id)
    columns.each_with_index do |column, index|
      column.update_column(:position, index)
      puts "    Set position #{index} for column '#{column.name}' (ID: #{column.id})"
    end
  end
end
puts "Migration completed!"

================
File: script/migrations/20251205-backfill-verified-at.rb
================
#!/usr/bin/env ruby
require_relative "../../config/environment"
BACKFILL_TIMESTAMP = Time.parse("2025-12-02 12:00:00 UTC")
def collect_verified_user_ids
  verified_ids = Set.new
  # Owners (they created the account)
  verified_ids.merge(User.where(role: :owner).pluck(:id))
  puts "After owners: #{verified_ids.size} users"
  # Card creators
  verified_ids.merge(Card.distinct.pluck(:creator_id).compact)
  puts "After card creators: #{verified_ids.size} users"
  # Comment creators
  verified_ids.merge(Comment.distinct.pluck(:creator_id).compact)
  puts "After comment creators: #{verified_ids.size} users"
  # Board creators
  verified_ids.merge(Board.distinct.pluck(:creator_id).compact)
  puts "After board creators: #{verified_ids.size} users"
  # Event creators
  verified_ids.merge(Event.distinct.pluck(:creator_id).compact)
  puts "After event creators: #{verified_ids.size} users"
  # Assigners (not assignees - they could be assigned without logging in)
  verified_ids.merge(Assignment.distinct.pluck(:assigner_id).compact)
  puts "After assigners: #{verified_ids.size} users"
  # Manual closers (user_id is nil for automatic closures)
  verified_ids.merge(Closure.where.not(user_id: nil).distinct.pluck(:user_id).compact)
  puts "After closers: #{verified_ids.size} users"
  # Manual postponers (user_id is nil for automatic entropy postponements)
  verified_ids.merge(Card::NotNow.where.not(user_id: nil).distinct.pluck(:user_id).compact)
  puts "After postponers: #{verified_ids.size} users"
  # Reactors
  verified_ids.merge(Reaction.distinct.pluck(:reacter_id).compact)
  puts "After reactors: #{verified_ids.size} users"
  # Filter creators
  verified_ids.merge(Filter.distinct.pluck(:creator_id).compact)
  puts "After filter creators: #{verified_ids.size} users"
  # Pinners
  verified_ids.merge(Pin.distinct.pluck(:user_id).compact)
  puts "After pinners: #{verified_ids.size} users"
  # Board accessors (accessed_at is touched when viewing boards)
  verified_ids.merge(Access.where.not(accessed_at: nil).distinct.pluck(:user_id).compact)
  puts "After board accessors: #{verified_ids.size} users"
  # Export requesters
  verified_ids.merge(Account::Export.distinct.pluck(:user_id).compact)
  puts "After export requesters: #{verified_ids.size} users"
  # Push subscribers
  verified_ids.merge(Push::Subscription.distinct.pluck(:user_id).compact)
  puts "After push subscribers: #{verified_ids.size} users"
  # Users who completed setup (name != email)
  verified_ids.merge(
    User.joins(:identity)
        .where.not("users.name = identities.email_address")
        .pluck(:id)
  )
  puts "After setup completers: #{verified_ids.size} users"
  # Users whose identity has at least one session
  verified_ids.merge(
    User.where(identity_id: Session.distinct.select(:identity_id)).pluck(:id)
  )
  puts "After identity sessions: #{verified_ids.size} users"
  verified_ids
end
puts "Collecting verified user IDs..."
verified_user_ids = collect_verified_user_ids
puts "\nFiltering to unverified users only..."
users_to_update = User.where(id: verified_user_ids.to_a)
                      .where(verified_at: nil)
                      .where(active: true)
                      .where.not(identity_id: nil)
                      .where.not(role: :system)
update_count = users_to_update.count
puts "Found #{update_count} users to backfill"
# Report remaining unverified users (before update)
remaining_before = User.where(verified_at: nil, active: true)
                       .where.not(identity_id: nil)
                       .where.not(role: :system)
                       .count
remaining_after = remaining_before - update_count
puts "\nCurrently unverified active users: #{remaining_before}"
puts "After backfill, remaining unverified: #{remaining_after}"
puts "These users will need to verify on next login."
if update_count > 0
  puts "\nBackfilling verified_at..."
  updated = users_to_update.update_all(verified_at: BACKFILL_TIMESTAMP)
  puts "Updated #{updated} users"
end
puts "\nDone!"

================
File: script/migrations/20260123-remove-draft-cards-from-search-index.rb
================
#!/usr/bin/env ruby
require_relative "../../config/environment"
total_deleted = 0
Account.find_each do |account|
  search_record_class = Search::Record.for(account.id)
  # Find search records for draft cards (both Card and Comment searchables)
  draft_card_ids = Card.where(account_id: account.id, status: "drafted").pluck(:id)
  if draft_card_ids.any?
    count = search_record_class.where(card_id: draft_card_ids).delete_all
    if count > 0
      puts "#{account.name}: deleted #{count} search records for draft cards"
      total_deleted += count
    end
  end
end
puts "Migration completed! Total deleted: #{total_deleted}"

================
File: script/migrations/backfill-storage-ledger.rb
================
#!/usr/bin/env ruby
# Backfill storage ledger with attach entries for all existing attachments.
#
# Run locally:
#   bin/rails runner script/migrations/backfill-storage-ledger.rb
#
# Run via Kamal:
#   kamal app exec -d <stage> -p --reuse "bin/rails runner script/migrations/backfill-storage-ledger.rb"
#
# Safe to re-run: skips attachments that already have entries (by blob_id + recordable).
#
# OPTIONAL: If you want to enforce no-reuse for direct attachments, verify there are
# no existing violations (ActionText embeds may legitimately reuse blobs):
#
#   ActiveStorage::Attachment
#     .joins(:blob)
#     .where(record_type: Storage::TRACKED_RECORD_TYPES)
#     .where.not(record_type: "ActionText::RichText")
#     .where.not(active_storage_blobs: { account_id: Storage::TEMPLATE_ACCOUNT_ID })
#     .select(:blob_id)
#     .group(:blob_id)
#     .having("COUNT(*) > 1")
#     .count
#   # Should return empty hash if no direct-attachment reuse exists
#
# If reuse exists (excluding template blobs), fix the data first.
class BackfillStorageLedger
  def run
    puts "Backfilling storage entries"
    backfill_entries
    puts "\nMaterializing totals"
    materialize_totals
  end
  private
    def backfill_entries
      created = 0
      skipped = 0
      ActiveStorage::Attachment.includes(:blob).find_each do |attachment|
        record = attachment.record.try(:storage_tracked_record)
        # Backfill creates one entry PER ATTACHMENT (not per blob) to match the ledger model.
        # Storage tracking is a business abstraction at the attachment level.
        # IMPORTANT: This assumes no historic blob reuse. Run pre-check query above first.
        if record.nil? || Storage::Entry.exists?(blob_id: attachment.blob_id, recordable: record)
          skipped += 1
          next
        end
        Storage::Entry.create! \
          account_id: record.account.id,
          board_id: record.board_for_storage_tracking&.id,
          recordable_type: record.class.name,
          recordable_id: record.id,
          blob_id: attachment.blob_id,
          delta: attachment.blob.byte_size,
          operation: "attach"
        created += 1
        print "." if created % 100 == 0
      end
      puts "\n\nBackfill complete!"
      puts "  Entries created: #{created}"
      puts "  Attachments skipped: #{skipped}"
    end
    def materialize_totals
      boards_materialized = 0
      accounts_materialized = 0
      Board.find_each do |board|
        board.materialize_storage
        boards_materialized += 1
        print "." if boards_materialized % 100 == 0
      end
      Account.find_each do |account|
        account.materialize_storage
        accounts_materialized += 1
      end
      puts "\n\nMaterialization complete!"
      puts "  Boards: #{boards_materialized}"
      puts "  Accounts: #{accounts_materialized}"
    end
end
BackfillStorageLedger.new.run

================
File: script/migrations/convert-absolute-attachment-urls-to-relative.rb
================
#!/usr/bin/env ruby
# Convert absolute attachment URLs in rich text content to relative paths.
# This fixes URLs that were stored with full hostnames (e.g., https://app.fizzy.do/...)
# making them portable across beta environments and host changes.
#
# MUST BE RUN AFTER `decrypt!` when using ActiveRecord Encryption
#
# Run locally:
#   bin/rails runner script/migrations/convert-absolute-attachment-urls-to-relative.rb --help
#
# Run via Kamal:
#   kamal app exec -d <stage> -p --reuse "bin/rails runner script/migrations/convert-absolute-attachment-urls-to-relative.rb --help"
#
# Safe to re-run: won't modify already-relative URLs
class ConvertAbsoluteAttachmentUrlsToRelative
  # Match absolute URLs pointing to Active Storage routes, keeping the account slug
  ABSOLUTE_URL_PATTERN = %r{https?://[^/]+(/\d+/rails/active_storage/[^"']+)}
  attr_reader :account, :dry_run
  def initialize(account_id: nil, dry_run: false)
    @account = Account.find_by(external_account_id: account_id)
    @dry_run = dry_run
  end
  def run
    puts "Converting absolute attachment URLs to relative paths"
    puts dry_run ? "DRY RUN MODE - no changes will be saved" : "LIVE MODE - changes will be saved"
    puts account ? "Only account: #{account.external_account_id} - #{account.name}" : "For **ALL ACCOUNTS**"
    puts "\nPress ENTER to continue running or CTRL-C to bail..."
    gets
    puts "\nRunning..."
    # Suppress SQL logs
    Rails.event.debug_mode = false
    seconds = Benchmark.realtime do
      suppressing_turbo_broadcasts do
        convert_urls
      end
    end
    puts "\n\n"
    puts "Finished in %.2f seconds." % seconds
  end
  private
    def suppressing_turbo_broadcasts
      Board.suppressing_turbo_broadcasts do
        Card.suppressing_turbo_broadcasts do
          yield
        end
      end
    end
    def convert_urls
      scanned = 0
      fixed = 0
      urls_converted = 0
      action_texts_scope.find_each do |rich_text|
        scanned += 1
        body = rich_text.body
        edited = false
        conversions = 0
        body.send(:attachment_nodes).each do |node|
          url = node["url"]
          next unless url
          if url.match?(ABSOLUTE_URL_PATTERN)
            node["url"] = url.gsub(ABSOLUTE_URL_PATTERN, '\1')
            edited = true
            conversions += 1
          end
        end
        if edited
          record = rich_text.record
          puts " - modifying #{record.class.name} #{record.to_param} (account: #{record.account&.external_account_id}) - #{conversions} URL(s)"
          unless dry_run
            rich_text.update! body: body.fragment.to_html
          end
          fixed += 1
          urls_converted += conversions
        end
      end
      puts "\n\nConversion complete!"
      puts "  Rich texts examined: #{scanned}"
      puts "  Rich texts modified: #{fixed}"
      puts "  URLs converted: #{urls_converted}"
    end
    def action_texts_scope
      # Only examine rich texts that have embedded attachments
      scope = ActionText::RichText.joins(:embeds_attachments)
      scope = scope.where(account: account) if account
      scope
    end
end
require "optparse"
options = { account_id: nil, dry_run: true }
OptionParser.new do |opts|
  opts.banner = "Usage: bin/rails runner #{__FILE__} [options]"
  opts.on("-a", "--account ACCOUNT_ID", "Restrict to a specific account (external_account_id)") do |id|
    options[:account_id] = id
  end
  opts.on("--[no-]dry-run", "Run in dry-run mode (default: --dry-run)") do |v|
    options[:dry_run] = v
  end
  opts.on("-h", "--help", "Show this help message") do
    puts opts
    exit
  end
end.parse!
ConvertAbsoluteAttachmentUrlsToRelative.new(**options).run

================
File: script/migrations/convert-relative-attachment-urls-to-absolute.rb
================
#!/usr/bin/env ruby
# Rollback script: Convert relative attachment URLs back to absolute URLs.
# Use this if you need to rollback the relative URL changes and want to
# convert rich texts created during the rollout back to absolute URLs.
#
# Run locally:
#   bin/rails runner script/migrations/convert-relative-attachment-urls-to-absolute.rb --help
#
# Run via Kamal:
#   kamal app exec -d <stage> -p --reuse "bin/rails runner script/migrations/convert-relative-attachment-urls-to-absolute.rb --help"
class ConvertRelativeAttachmentUrlsToAbsolute
  # Match relative URLs pointing to Active Storage routes (with account slug)
  RELATIVE_URL_PATTERN = %r{\A(/\d+/rails/active_storage/[^"']+)\z}
  attr_reader :host, :since
  def initialize(host:, since:)
    @host = host
    @since = since
  end
  def run
    puts "Converting relative attachment URLs to absolute URLs"
    puts "Host: #{host}"
    puts "Processing rich texts created since: #{since}"
    puts "\nPress ENTER to continue running or CTRL-C to bail..."
    gets
    puts "\nRunning..."
    seconds = Benchmark.realtime do
      suppressing_turbo_broadcasts do
        convert_urls
      end
    end
    puts "\n\n"
    puts "Finished in %.2f seconds." % seconds
  end
  private
    def suppressing_turbo_broadcasts
      Board.suppressing_turbo_broadcasts do
        Card.suppressing_turbo_broadcasts do
          yield
        end
      end
    end
    def convert_urls
      scanned = 0
      fixed = 0
      urls_converted = 0
      action_texts_scope.find_each do |rich_text|
        scanned += 1
        body = rich_text.body
        edited = false
        conversions = 0
        body.send(:attachment_nodes).each do |node|
          url = node["url"]
          next unless url
          if url.match?(RELATIVE_URL_PATTERN)
            node["url"] = "#{host}#{url}"
            edited = true
            conversions += 1
          end
        end
        if edited
          record = rich_text.record
          puts " - modifying #{record.class.name} #{record.to_param} (account: #{record.account&.external_account_id}) - #{conversions} URL(s)"
          rich_text.update! body: body.fragment.to_html
          fixed += 1
          urls_converted += conversions
        end
      end
      puts "\n\nConversion complete!"
      puts "  Rich texts examined: #{scanned}"
      puts "  Rich texts modified: #{fixed}"
      puts "  URLs converted: #{urls_converted}"
    end
    def action_texts_scope
      ActionText::RichText.joins(:embeds_attachments).where("action_text_rich_texts.created_at >= ?", since)
    end
end
require "optparse"
require "time"
options = {}
OptionParser.new do |opts|
  opts.banner = "Usage: bin/rails runner #{__FILE__} [options]"
  opts.on("--host HOST", "Host to prepend (e.g., https://app.fizzy.do)") do |host|
    options[:host] = host
  end
  opts.on("--since TIME", "Process rich texts created since this time (ISO 8601 format)") do |time|
    options[:since] = Time.parse(time)
  end
  opts.on("-h", "--help", "Show this help message") do
    puts opts
    exit
  end
end.parse!
if options[:host].nil? || options[:since].nil?
  puts "Error: --host and --since are required"
  puts "Example: bin/rails runner #{__FILE__} --host https://app.fizzy.do --since 2026-01-14T10:00:00Z"
  exit 1
end
ConvertRelativeAttachmentUrlsToAbsolute.new(**options).run

================
File: script/migrations/copy-blobs-to-pure.rb
================
#! /usr/bin/env ruby
require_relative "../config/environment"
def migrate(source_service_name, target_service_name)
  ApplicationRecord.with_each_tenant do |tenant|
    puts "\n## #{tenant}"
    report = { updated: 0, skipped: 0, errors: 0 }
    if ActiveStorage::Blob.count == 0
      puts "No blobs found, skipping."
      next
    end
    ActiveStorage::Blob.service = source_service = ActiveStorage::Blob.services.fetch(source_service_name)
    target_service = ActiveStorage::Blob.services.fetch(target_service_name)
    ActiveStorage::Blob.find_each do |blob|
      if target_service.name.to_sym == blob.service_name.to_sym
        report[:skipped] += 1
        putc "-"
      elsif target_service.exist?(blob.key)
        report[:skipped] += 1
        putc "S"
      else
        begin
          blob.open do |stream|
            target_service.upload(blob.key, stream, checksum: blob.checksum)
          end
          report[:updated] += 1
          putc "."
        rescue ActiveStorage::FileNotFoundError
          report[:errors] += 1
          putc "E"
        end
      end
      # Update the service name of the blob.
      blob.update_column :service_name, target_service_name
    end
    puts
    pp report
  end
end
migrate :local, :purestorage

================
File: script/migrations/fill_account_closure_reasons.rb
================
#!/usr/bin/env ruby
require_relative "../config/environment"
ApplicationRecord.with_each_tenant do |tenant|
  Account.find_each do |account|
    account.send(:create_default_closure_reasons)
  end
end

================
File: script/migrations/generate_comments_from_events.rb
================
#!/usr/bin/env ruby
require_relative "../config/environment"
ApplicationRecord.with_each_tenant do |tenant|
  Card.find_each do |card|
    card.events.find_each do |event|
      Card::Eventable::SystemCommenter.new(card.reload, event).comment
    end
  end
end

================
File: script/migrations/migrate_to_flat_card_urls.rb
================
#!/usr/bin/env ruby
require_relative "../config/environment"
def replace_url(string)
  string.gsub(%r{/boards/\d+/cards/(\d+)}) do
    "/cards/#{$1}"
  end
end
def fix_rich_text(rich_text)
  original_html = rich_text.body_before_type_cast
  new_html = replace_url(original_html)
  if original_html != new_html
    rich_text.update_columns(body: new_html)
  end
end
ApplicationRecord.with_each_tenant do
  ActionText::RichText.where(record_type: "Card", name: "description").find_each do |rich_text|
    fix_rich_text rich_text
  end
  ActionText::RichText.where(record_type: "Comment", name: "body").find_each do |rich_text|
    fix_rich_text rich_text
  end
end

================
File: script/migrations/migrate_to_new_cards_url_scheme.rb
================
#!/usr/bin/env ruby
require_relative "../config/environment"
def replace_url(string)
  string.gsub(%r{/buckets/(\d+)/bubbles/(\d+)}) do
    "/boards/#{$1}/cards/#{$2}"
  end
end
ApplicationRecord.with_each_tenant do |tenant|
  Account.find_each do |account|
    Comment.find_each do |comment|
      comment.update!(body: replace_url(comment.body.content.to_s))
    end
  end
end

================
File: script/migrations/migrate-content-to-slugged-urls.rb
================
#!/usr/bin/env ruby
require_relative "../config/environment"
domains = {
  "production" => "app.fizzy.do",
  "beta" => ENV.fetch("APP_FQDN", "beta1.fizzy-beta.com"),
  "staging" => "app.fizzy-staging.com"
}
def fix_attachments(rich_text)
  if rich_text.body
    rich_text.body.send(:attachment_nodes).each do |node|
      sgid = SignedGlobalID.parse(node["sgid"], for: ActionText::Attachable::LOCATOR_NAME)
      if sgid
        puts "Fixing attachment node: #{node.to_html}"
        model = sgid.model_class.find(sgid.model_id)
        node["sgid"] = model.attachable_sgid
      else
        puts "Skipping attachment node without valid sgid: #{node.to_html}"
      end
    end
    rich_text.save!
  end
end
ApplicationRecord.with_each_tenant do |tenant|
  account_id = Current.account.queenbee_id
  unless account_id
    puts "Skipping URL fixup for tenant: #{tenant}"
    next
  end
  puts "\n## Processing tenant: #{tenant}\n"
  domain = domains[Rails.env] || domains["production"]
  regex = %r{://\w+\.#{domain}/}
  pp [ Current.account.name, account_id, domain, regex ]
  puts
  Card.find_each do |card|
    puts "### Processing card #{card.id} in #{Rails.application.routes.url_helpers.board_card_path(card.board, card)}"
    fix_attachments(card.description)
    card.reload
    old_body = card.description.body.to_s
    if match = regex.match(old_body)
      puts "URL found in card #{card.id} in #{Rails.application.routes.url_helpers.board_card_path(card.board, card)}"
      new_body = old_body.gsub(regex, "://#{domain}/#{account_id}/")
      card.description.update(body: new_body) || raise("Failed to update card description for card #{card.id}")
    end
  end
  Comment.find_each do |comment|
    puts "### Processing comment #{comment.id} in #{Rails.application.routes.url_helpers.board_card_path(comment.card.board, comment.card)}"
    fix_attachments(comment.body)
    comment.reload
    old_body = comment.body.body.to_s
    if match = regex.match(old_body)
      puts "URL found in comment #{comment.id} in #{Rails.application.routes.url_helpers.board_card_path(comment.card.board, comment.card)}"
      new_body = old_body.gsub(regex, "://#{domain}/#{account_id}/")
      comment.body.update(body: new_body) || raise("Failed to update comment body for comment #{comment.id}")
    end
  end
end

================
File: script/migrations/migrate-disk-service-blobs.rb
================
#! /usr/bin/env ruby
require_relative "../config/environment"
ApplicationRecord.with_each_tenant do |tenant|
  puts "\n## #{tenant}"
  report = { updated: 0, skipped: 0 }
  ActiveStorage::Blob.find_each do |blob|
    if blob.key.start_with?("#{tenant}/")
      report[:skipped] += 1
    else
      blob.update_column :key, "#{tenant}/#{blob.key}"
      report[:updated] += 1
    end
  end
  pp report
  disk_service = ActiveStorage::Blob.services.fetch(:local)
  new_root = File.join(disk_service.root, tenant)
  old_root = File.join("storage", "tenants", Rails.env, tenant, "files")
  FileUtils.mkdir_p(new_root, verbose: true) unless File.directory?(new_root)
  Dir.glob(File.join(old_root, "??")).each_slice(20) do |blob_dirs|
    FileUtils.mv(blob_dirs, new_root, verbose: true)
  end
end

================
File: script/migrations/populate_columns_from_workflow_stages.rb
================
#!/usr/bin/env ruby
require_relative "../../config/environment"
class Card
  has_one :engagement, dependent: :destroy, class_name: "Card::Engagement"
  def doing?
    open? && published? && engagement&.status == "doing"
  end
  def on_deck?
    open? && published? && engagement&.status == "on_deck"
  end
  def considering?
    open? && published? && engagement.blank?
  end
end
ApplicationRecord.with_each_tenant do |tenant|
  puts "Processing tenant: #{tenant}"
  Column.destroy_all
  Board.find_each do |board|
    next unless board.workflow.present?
    # Map to track stage_id -> column
    columns_by_stage = {}
    # Create columns from workflow stages
    board.workflow.stages.find_each do |stage|
      column = board.columns.create!(
        name: stage.name,
        color: stage.color || Card::Colored::COLORS.first
      )
      columns_by_stage[stage] = column
      puts "Created column '#{column.name}' for board '#{board.name}'"
    end
    # Associate cards with their corresponding columns based on stages
    board.cards.includes(:stage).find_each do |card|
      next if !card.doing? || card.stage.blank?
      unless card.stage.workflow.boards.include?(board)
        puts "Corrupt data: the card with id #{card.id} has the stage #{card.stage.name} with id #{card.stage.id} that belongs to a workflow not asociated ot its board"
        next
      end
      stage = columns_by_stage[card.stage]
      card.update!(column: stage)
      puts "Associated card ##{card.id} with column '#{stage.name}'"
    end
  end
end
puts "Migration completed!"

================
File: script/migrations/reset_boards_ids.rb
================
#!/usr/bin/env ruby
require_relative "../config/environment"
ApplicationRecord.with_each_tenant do |tenant|
  id_mapping = {}
  puts "Processing tenant: #{tenant}"
  # Disable foreign key constraints
  ApplicationRecord.connection.execute("PRAGMA foreign_keys = OFF;")
  begin
    # Get all boards ordered by ID
    boards = Board.order(:id).to_a
    # Create mapping of old IDs to new IDs
    boards.each_with_index do |board, index|
      id_mapping[board.id] = index + 1
    end
    # Update foreign keys in related tables
    puts "Updating foreign keys in related tables..."
    # Update accesses table
    Access.where.not(board_id: nil).find_each do |access|
      if id_mapping[access.board_id]
        access.update_column(:board_id, id_mapping[access.board_id])
      end
    end
    # Update cards table
    Card.where.not(board_id: nil).find_each do |card|
      if id_mapping[card.board_id]
        card.update_column(:board_id, id_mapping[card.board_id])
      end
    end
    # Update boards_filters table (join table)
    ApplicationRecord.connection.execute("SELECT board_id FROM boards_filters").each do |row|
      old_id = row[0]
      if id_mapping[old_id]
        ApplicationRecord.connection.execute("UPDATE boards_filters SET board_id = #{id_mapping[old_id]} WHERE board_id = #{old_id}")
      end
    end
    # Update events table
    Event.where.not(board_id: nil).find_each do |event|
      if id_mapping[event.board_id]
        event.update_column(:board_id, id_mapping[event.board_id])
      end
    end
    # Update events table (polymorphic relationship)
    Event.where(eventable_type: "Board").find_each do |event|
      if id_mapping[event.eventable_id]
        event.update_column(:eventable_id, id_mapping[event.eventable_id])
      end
    end
    # Update mentions table (polymorphic relationship)
    Mention.where(source_type: "Board").find_each do |mention|
      if id_mapping[mention.source_id]
        mention.update_column(:source_id, id_mapping[mention.source_id])
      end
    end
    # Update notifications table (polymorphic relationship)
    Notification.where(source_type: "Board").find_each do |notification|
      if id_mapping[notification.source_id]
        notification.update_column(:source_id, id_mapping[notification.source_id])
      end
    end
    # Update action_text_markdowns table (polymorphic relationship)
    ActionText::RichText.where(record_type: "Board").find_each do |rich_text|
      if id_mapping[rich_text.record_id]
        rich_text.update_column(:record_id, id_mapping[rich_text.record_id])
      end
    end
    # Update active_storage_attachments table (polymorphic relationship)
    ActiveStorage::Attachment.where(record_type: "Board").find_each do |attachment|
      if id_mapping[attachment.record_id]
        attachment.update_column(:record_id, id_mapping[attachment.record_id])
      end
    end
    # Reset the boards table IDs
    puts "Resetting board IDs..."
    boards.each do |board|
      new_id = id_mapping[board.id]
      # Use direct SQL to update the ID to avoid ActiveRecord validations
      ApplicationRecord.connection.execute("UPDATE boards SET id = #{new_id} WHERE id = #{board.id}")
    end
    # Reset the SQLite sequence for the boards table
    ApplicationRecord.connection.execute("DELETE FROM sqlite_sequence WHERE name = 'boards'")
    max_id = Board.maximum(:id) || 0
    ApplicationRecord.connection.execute("INSERT INTO sqlite_sequence (name, seq) VALUES ('boards', #{max_id})")
    puts "Board IDs have been reset successfully!"
  rescue => e
    puts "Error: #{e.message}"
    puts e.backtrace
  ensure
    # Re-enable foreign key constraints
    ApplicationRecord.connection.execute("PRAGMA foreign_keys = ON;")
  end
  # Update links in card descriptions and comment bodies
  Card.find_each do |card|
    description = card.description.content.dup
    description.gsub!(/boards\/(\d+)\//) do |match|
      old_id = $1.to_i
      new_id = id_mapping[old_id]
      new_id ? "boards/#{new_id}/" : match
    end
    if description != card.description.content
      puts "Updating links in card #{card.id}"
      card.update!(description: description)
    end
  end
  Comment.find_each do |comment|
    body = comment.body.content.dup
    body.gsub!(/boards\/(\d+)\//) do |match|
      old_id = $1.to_i
      new_id = id_mapping[old_id]
      new_id ? "boards/#{new_id}/" : match
    end
    if body != comment.body.content
      puts "Updating links in comment #{comment.id}"
      comment.update!(body: body)
    end
  end
  # Output the mapping of old IDs to new IDs
  puts "\nMapping of old IDs to new IDs:"
  puts id_mapping.inspect
end

================
File: script/migrations/reset_cards_ids.rb
================
#!/usr/bin/env ruby
require_relative "../config/environment"
ApplicationRecord.with_each_tenant do |tenant|
  id_mapping = {}
  puts "Processing tenant: #{tenant}"
  # Disable foreign key constraints
  ApplicationRecord.connection.execute("PRAGMA foreign_keys = OFF;")
  begin
    # Get all cards ordered by ID
    cards = Card.order(:id).to_a
    # Create mapping of old IDs to new IDs
    cards.each_with_index do |card, index|
      id_mapping[card.id] = index + 1
    end
    # Update foreign keys in related tables
    puts "Updating foreign keys in related tables..."
    # Update assignments table
    Assignment.where.not(card_id: nil).find_each do |assignment|
      if id_mapping[assignment.card_id]
        assignment.update_column(:card_id, id_mapping[assignment.card_id])
      end
    end
    # Update card_engagements table
    Card::Engagement.where.not(card_id: nil).find_each do |engagement|
      if id_mapping[engagement.card_id]
        engagement.update_column(:card_id, id_mapping[engagement.card_id])
      end
    end
    # Update card_goldnesses table
    Card::Goldness.where.not(card_id: nil).find_each do |goldness|
      if id_mapping[goldness.card_id]
        goldness.update_column(:card_id, id_mapping[goldness.card_id])
      end
    end
    # Update closures table
    Closure.where.not(card_id: nil).find_each do |closure|
      if id_mapping[closure.card_id]
        closure.update_column(:card_id, id_mapping[closure.card_id])
      end
    end
    # Update comments table
    Comment.where.not(card_id: nil).find_each do |comment|
      if id_mapping[comment.card_id]
        comment.update_column(:card_id, id_mapping[comment.card_id])
      end
    end
    # Update pins table
    Pin.where.not(card_id: nil).find_each do |pin|
      if id_mapping[pin.card_id]
        pin.update_column(:card_id, id_mapping[pin.card_id])
      end
    end
    # Update taggings table
    Tagging.where.not(card_id: nil).find_each do |tagging|
      if id_mapping[tagging.card_id]
        tagging.update_column(:card_id, id_mapping[tagging.card_id])
      end
    end
    # Update watches table
    Watch.where.not(card_id: nil).find_each do |watch|
      if id_mapping[watch.card_id]
        watch.update_column(:card_id, id_mapping[watch.card_id])
      end
    end
    # Update events table (polymorphic relationship)
    Event.where(eventable_type: "Card").find_each do |event|
      if id_mapping[event.eventable_id]
        event.update_column(:eventable_id, id_mapping[event.eventable_id])
      end
    end
    # Update mentions table (polymorphic relationship)
    Mention.where(source_type: "Card").find_each do |mention|
      if id_mapping[mention.source_id]
        mention.update_column(:source_id, id_mapping[mention.source_id])
      end
    end
    # Update notifications table (polymorphic relationship)
    Notification.where(source_type: "Card").find_each do |notification|
      if id_mapping[notification.source_id]
        notification.update_column(:source_id, id_mapping[notification.source_id])
      end
    end
    # Update action_text_markdowns table (polymorphic relationship)
    ActionText::RichText.where(record_type: "Card").find_each do |rich_text|
      if id_mapping[rich_text.record_id]
        rich_text.update_column(:record_id, id_mapping[rich_text.record_id])
      end
    end
    # Reset the cards table IDs
    puts "Resetting card IDs..."
    cards.each do |card|
      new_id = id_mapping[card.id]
      # Use direct SQL to update the ID to avoid ActiveRecord validations
      ApplicationRecord.connection.execute("UPDATE cards SET id = #{new_id} WHERE id = #{card.id}")
    end
    # Reset the SQLite sequence for the cards table
    ApplicationRecord.connection.execute("DELETE FROM sqlite_sequence WHERE name = 'cards'")
    max_id = Card.maximum(:id) || 0
    ApplicationRecord.connection.execute("INSERT INTO sqlite_sequence (name, seq) VALUES ('cards', #{max_id})")
    puts "Card IDs have been reset successfully!"
  rescue => e
    puts "Error: #{e.message}"
    puts e.backtrace
  ensure
    # Re-enable foreign key constraints
    ApplicationRecord.connection.execute("PRAGMA foreign_keys = ON;")
  end
  Card.find_each do |card|
    description = card.description.content.dup
    description.gsub!(/cards\/(\d+)\)/) do |match|
      old_id = $1.to_i
      new_id = id_mapping[old_id]
      new_id ? "cards/#{new_id})" : match
    end
    if description != card.description.content
      puts "Updating links in card #{card.id}"
      card.update!(description: description)
    end
  end
  Comment.find_each do |comment|
    body = comment.body.content.dup
    body.gsub!(/cards\/(\d+)\)/) do |match|
      old_id = $1.to_i
      new_id = id_mapping[old_id]
      new_id ? "cards/#{new_id})" : match
    end
    if body != comment.body.content
      puts "Updating links in comment #{comment.id}"
      comment.update!(body: body)
    end
  end
  # Output the mapping of old IDs to new IDs
  puts "\nMapping of old IDs to new IDs:"
  puts id_mapping.inspect
end

================
File: script/migrations/split-sibling-paragraphs-with-p-br.rb
================
#!/usr/bin/env ruby
BACKFILL_TIMESTAMP = Time.parse("2025-12-19 00:07:00 UTC")
ACCOUNT_ID = nil # restrict to an account_id
# Split sibling <p> tags with content by inserting <p><br</p> to replicaate previous view.
# Run for the time range before paragraphs were not spaced
# See https://app.fizzy.do/5986089/cards/3472
# and https://github.com/basecamp/fizzy/pull/2107
#
# MUST BE RUN AFTER `decrypt!` when using ActiveRecord Encryption
#
# Run locally:
#   bin/rails runner script/migrations/split-sibling-paragraphs-with-p-br.rb
#
# Run via Kamal:
#   kamal app exec -d <stage> -p --reuse "bin/rails runner script/migrations/split-sibling-paragraphs-with-p-br.rb"
#
# Safe to re-run for a time range: won't re-detect unsplit paragraphs and updated_at will be outside time window
class SeparateSiblingParagraphs
  attr_reader :updated_at, :account_id
  def initialize(updated_at, account_id: nil)
    @updated_at = updated_at
    @account_id = account_id
  end
  def run
    puts "Separating non-blank sibling paragraphs"
    puts "Updated at: #{updated_at}"
    puts account_id ? "Only account id: #{account_id}" : "For **ALL ACCOUNTS**"
    puts "\nPress ENTER to continue running or CTRL-C to bail..."
    gets
    puts "\nRunning..."
    # Suppress SQL logs
    Rails.event.debug_mode = false
    seconds = Benchmark.realtime do
      suppressing_turbo_broadcasts do
        separate_nonblank_paragraphs
      end
    end
    puts "\n\n"
    puts "Finished splitting non-blank <p>s in %.2f seconds." % seconds
  end
  private
    def suppressing_turbo_broadcasts
      Board.suppressing_turbo_broadcasts do
        Card.suppressing_turbo_broadcasts do
          yield
        end
      end
    end
    def separate_nonblank_paragraphs
      scanned = 0
      fixed = 0
      insertions = 0
      action_texts_scope.find_each(**batch_options) do |rich_text|
        next if account_id && rich_text.record.account.external_account_id != account_id
        scanned += 1
        edited = false
        rich_text.body&.fragment.tap do |fragment|
          next unless fragment
          fragment.find_all("p + p").each do |node|
            unless empty_node?(node) || empty_node?(node.previous_sibling)
              node.add_previous_sibling empty_node_markup
              edited = true
              insertions += 1
            end
          end
          if edited
            puts " - modifying #{rich_text.record.class.name} #{rich_text.record.to_param} (account: #{rich_text.record.account.external_account_id})" unless demo_card?(rich_text.record)
            # allow implicit touching to invalidate caches
            rich_text.update! body: fragment.to_html
            fixed +=1
          end
        end
      end
      puts "\n\Separation complete!"
      puts "  Rich texts examined: #{scanned}"
      puts "  Rich texts modified: #{fixed}"
      puts "  Paragraphs inserted: #{insertions}"
      fixed
    end
    def action_texts_scope
      ActionText::RichText.where(updated_at: updated_at)
    end
    def batch_options
      { batch_size: 20, order: :desc }
    end
    def empty_node?(node)
      node.to_html == empty_node_markup
    end
    def empty_node_markup
      "<p><br></p>"
    end
    def demo_card?(record)
      record.is_a?(Card) && record.number <= 8
    end
end
SeparateSiblingParagraphs.new(..BACKFILL_TIMESTAMP, account_id: ACCOUNT_ID).run

================
File: script/create-identities.rb
================
#!/usr/bin/env ruby
require_relative "../config/environment"
# Loop through all tenants and create identities for users
ApplicationRecord.with_each_tenant do |tenant|
  puts "Processing tenant: #{tenant}"
  User.find_each do |user|
    next if user.system?
    # Use IdentityProvider to link the user's email to this tenant
    # This will find_or_create the identity and link it to the tenant
    IdentityProvider.link(email_address: user.email_address, to: tenant)
    puts "   Linked identity for user #{user.id} (#{user.email_address}) to tenant '#{tenant}'"
  end
  puts "  Completed tenant: #{tenant}"
  puts
end
puts "All identities created successfully!"

================
File: script/fetch-prod-db.rb
================
#!/usr/bin/env ruby
require "tmpdir"
require "fileutils"
require "open3"
if ARGV.size != 1
  warn "Usage: #{$PROGRAM_NAME} TENANT_ID"
  exit 1
end
tenant_id = ARGV[0]
# Automatically detect the fizzy-web-production container
puts " Detecting fizzy-web-production container..."
container_output, status = Open3.capture2(%(ssh app@fizzy-app-101 "docker ps --format '{{.Names}}' | grep fizzy-web-production"))
abort("Failed to detect container") unless status.success?
CONTAINER = container_output.strip
abort("No fizzy-web-production container found") if CONTAINER.empty?
puts " Using container: #{CONTAINER}"
REMOTE_PATH = "/rails/storage/tenants/production/#{tenant_id}/db/main.sqlite3.1"
Dir.mktmpdir do |tmpdir|
  local_file = File.join(tmpdir, "main.sqlite3")
  puts " Copying #{REMOTE_PATH} from container to #{local_file}"
  cmd = %(ssh app@fizzy-app-101 "docker cp #{CONTAINER}:#{REMOTE_PATH} -" | tar -xOf - > #{local_file})
  system(cmd) or abort("Failed to copy database file")
  puts " Running script/load-prod-db-in-dev.rb with #{local_file}"
  exec("bundle", "exec", "ruby", "script/load-prod-db-in-dev.rb", local_file)
end

================
File: script/fix-active-storage-links.rb
================
#!/usr/bin/env ruby
require_relative "../config/environment"
require "pathname"
require "uri"
require "base64"
require "json"
class FixActiveStorage
  attr_reader :skipped, :processed, :scope
  def initialize(scope = nil)
    @scope = scope || ActionText::RichText.all.where("body LIKE '%/rails/active_storage/%'")
    @mapping = {}
    @skipped = 0
    @processed = 0
    @users = {}
    @memberships = {}
    @attachments = {}
    @identities = {}
  end
  def ingest_blob_keys(db_path)
    models = Models.new(db_path)
    @mapping[models.accounts.sole.external_account_id.to_s] = models.blobs.all.index_by(&:id)
    @attachments[models.accounts.sole.external_account_id.to_s] = models.attachments.all.index_by(&:id)
    @users[models.accounts.sole.external_account_id.to_s] = models.users.all.index_by(&:id)
  end
  def ingest_untenanted(untenanted_db_path)
    untenanted = Models.new(untenanted_db_path)
    @memberships = untenanted.memberships.all.index_by(&:id)
    @identities = untenanted.identities.all.index_by(&:id)
  end
  def perform
    fix_avatars
    fix_mentions
    fix_attachments
    pp [ @processed, @skipped ]
  end
  private
    def fix_avatars
      User.all.active.preload(:identity).find_each do |user|
        tenant = user.account.external_account_id.to_s
        email_address = user.identity.email_address
        membership = @memberships.values.find { |m| m.tenant == tenant && @identities[m.identity_id]&.email_address == email_address }
        old_user = @users[tenant]&.values&.find { |u| u.membership_id == membership&.id }
        next if user.avatar.attached? || old_user.nil?
        old_avatar_attachment = @attachments[tenant]&.values&.find do |attachment|
          attachment.record_type == "User" && attachment.record_id == old_user.id && attachment.name == "avatar"
        end
        if old_avatar_attachment.nil?
          @skipped += 1
          next
        end
        old_blob = old_avatar_attachment.blob
        if old_blob.nil?
          @skipped += 1
          next
        end
        new_blob = ActiveStorage::Blob.find_by(key: old_blob.key)
        unless new_blob
          new_blob = ActiveStorage::Blob.create!(
            account_id: user.account_id,
            byte_size: old_blob.byte_size,
            checksum: old_blob.checksum,
            content_type: old_blob.content_type,
            created_at: old_blob.created_at,
            filename: old_blob.filename,
            key: old_blob.key,
            metadata: old_blob.metadata,
            service_name: old_blob.service_name
          )
        end
          ActiveStorage::Attachment.find_or_create_by!(
            account_id: user.account_id,
            blob_id: new_blob.id,
            name: "avatar",
            record: user
          )
        @processed += 1
      end
    end
    def fix_mentions
      ActionText::RichText.where("body LIKE '%action-text-attachment%'").find_each do |rich_text|
        rich_text.body.send(:attachment_nodes).each do |node|
          next unless node["content-type"] == "application/vnd.actiontext.mention"
          sgid = SignedGlobalID.parse(node["sgid"], for: ActionText::Attachable::LOCATOR_NAME)
          user = @users.dig(sgid.params[:tenant], sgid.model_id.to_i)
          membership = @memberships[user&.membership_id]
          unless membership
            @skipped += 1
            next
          end
          identity = @identities[membership&.identity_id]
          unless identity
            @skipped += 1
            next
          end
          new_identity = Identity.find_by(email_address: identity.email_address)
          new_account = Account.find_by(external_account_id: sgid.params[:tenant])
          new_user = User.find_by(identity: new_identity, account: new_account)
          new_sgid = new_user.attachable_sgid
          node["sgid"] = new_sgid.to_s
        end
        rich_text.save!
      end
    end
    def fix_attachments
      scope.find_each do |rich_text|
        next unless rich_text.body
        rich_text.body.send(:attachment_nodes).each do |node|
          sgid = node["sgid"]
          url = node["url"]
          next if url.blank? || sgid.blank?
          sgid = SignedGlobalID.parse(node["sgid"], for: ActionText::Attachable::LOCATOR_NAME)
          old_blob = @mapping.dig(sgid.params[:tenant], sgid.model_id.to_i)
          # There are some old files that got lost in a previous migration
          unless old_blob
            @skipped += 1
            next
          end
          new_blob = ActiveStorage::Blob.find_by(key: old_blob.key)
          unless new_blob
            new_blob = ActiveStorage::Blob.create!(
              account_id: rich_text.account_id,
              byte_size: old_blob.byte_size,
              checksum: old_blob.checksum,
              content_type: old_blob.content_type,
              created_at: old_blob.created_at,
              filename: old_blob.filename,
              key: old_blob.key,
              metadata: old_blob.metadata,
              service_name: old_blob.service_name
            )
            ActiveStorage::Attachment.create!(
              account_id: rich_text.account_id,
              blob_id: new_blob.id,
              created_at: old_blob.created_at,
              name: "embeds",
              record: rich_text
            )
          end
          node["sgid"] = new_blob.attachable_sgid
          @processed += 1
        end
        rich_text.save!
      rescue ActiveStorage::FileNotFoundError
        @skipped += 1
        next
      end
    end
end
class Models
  attr_reader :application_record
  def initialize(db_path)
    const_name = "ImportBase#{db_path.hash.abs}"
    if self.class.const_defined?(const_name)
      @application_record = self.class.const_get(const_name)
    else
      @application_record = Class.new(ActiveRecord::Base) do
        self.abstract_class = true
        def self.models
          const_get("MODELS")
        end
        delegate :models, to: :class
      end
      self.class.const_set(const_name, @application_record)
    end
    @application_record.establish_connection adapter: "sqlite3", database: db_path
    @application_record.const_set("MODELS", self)
  end
  def accounts
    @accounts ||= Class.new(application_record) do
      self.table_name = "accounts"
    end
  end
  def blobs
    models = self
    @blobs ||= Class.new(application_record) do
      self.table_name = "active_storage_blobs"
      def attachments
        models.attachments.where(blob_id: id)
      end
    end
  end
  def attachments
    models = self
    @attachments ||= Class.new(application_record) do
      self.table_name = "active_storage_attachments"
      def blob
        models.blobs.find_by(id: blob_id)
      end
    end
  end
  def users
    @users ||= Class.new(application_record) do
      self.table_name = "users"
    end
  end
  def identities
    @identities ||= Class.new(application_record) do
      self.table_name = "identities"
    end
  end
  def memberships
    @memberships ||= Class.new(application_record) do
      self.table_name = "memberships"
    end
  end
end
# tenanted_db_paths = ARGV
tenanted_db_paths = Dir[Rails.root.join("storage/tenants/production/*/db/main.sqlite3")]
untenanted_db_path = Rails.root.join("storage/untenanted/production.sqlite3")
if tenanted_db_paths.empty?
  $stderr.puts "Error: at least one tenanted database path is required"
  $stderr.puts
  exit 1
end
fix = FixActiveStorage.new
fix.ingest_untenanted(untenanted_db_path)
tenanted_db_paths.each_with_index do |db_path, _index|
  fix.ingest_blob_keys(db_path)
end
fix.perform

================
File: script/import-sqlite-database.rb
================
#!/usr/bin/env ruby
require_relative "../config/environment"
require "pathname"
require "optparse"
class AccountExistsError < StandardError; end
class Import
  FIX_LINK_HOSTS = {
    "fizzy.37signals.com" => "app.fizzy.do",
    "box-car.com" => "app.fizzy.do",
    "app.box-car.com" => "app.fizzy.do"
  }.freeze
  attr_reader :db_path, :untenanted_db_path, :skip_already_imported
  attr_reader :account, :tenant, :mapping
  def initialize(db_path, untenanted_db_path, skip_already_imported: false)
    @db_path = Pathname(db_path)
    @untenanted_db_path = Pathname(untenanted_db_path)
    @skip_already_imported = skip_already_imported
    @mapping = nil
  end
  def import_database
    raise "The given database file doesn't exist" unless db_path.exist?
    @mapping = {}
    duration = ActiveSupport::Benchmark.realtime do
      ApplicationRecord.transaction do
        setup_account
        ActiveRecord::Base.no_touching do
          Current.with(account: account) do
            begin
              Webhook.skip_callback(:create, :after, :create_delinquency_tracker!)
              Comment.skip_callback(:commit, :after, :watch_card_by_creator)
              Comment.skip_callback(:commit, :after, :track_creation)
              Mention.skip_callback(:commit, :after, :watch_source_by_mentionee)
              Notification.skip_callback(:commit, :after, :broadcast_unread)
              Notification.skip_callback(:create, :after, :bundle)
              Reaction.skip_callback(:create, :after, :register_card_activity)
              Card.skip_callback(:save, :before, :set_default_title)
              Card.skip_callback(:update, :after, :handle_board_change)
              ActiveStorage::Blob.skip_callback(:update, :after, :touch_attachments)
              ActiveStorage::Blob.skip_callback(:commit, :after, :update_service_metadata)
              ActiveStorage::Attachment.skip_callback(:commit, :after, :mirror_blob_later)
              ActiveStorage::Attachment.skip_callback(:commit, :after, :analyze_blob_later)
              ActiveStorage::Attachment.skip_callback(:commit, :after, :transform_variants_later)
              ActiveStorage::Attachment.skip_callback(:commit, :after, :purge_dependent_blob_later)
            rescue => e
              puts "  Warning: Could not skip some callbacks: #{e.message}"
            end
            Event.suppress do
              copy_users
              copy_boards
              copy_accesses
              copy_columns
              copy_cards
              copy_steps
              copy_comments
              copy_mentions
              copy_reactions
              copy_tags
              copy_watches
              copy_pins
            end
            copy_events
            Event.suppress do
              copy_webhooks
              copy_push_subscriptions
              copy_filters
              copy_entropies
            end
            copy_notifications
            copy_notification_bundles
            fix_links
            unless Rails.env.production?
              # Don't spam real webhooks
              Webhook.all.update_all(active: false)
              # Don't send emails to real users
              User::Settings.all.update_all(bundle_email_frequency: :never)
            end
          end
        end
      end
    end
    puts " Import complete! (#{duration.round(2)}s)"
  rescue AccountExistsError => e
    raise e unless skip_already_imported
  end
  private
    def step(start_message, completion_message)
      puts " #{start_message}"
      result = nil
      duration = ActiveSupport::Benchmark.realtime do
        result = yield
      end
      interpolations = { duration: "#{duration.round(2)}s" }
      interpolations.merge!(result) if result.is_a?(Hash)
      completion_text = completion_message % interpolations
      puts " #{completion_text}"
      result
    end
    def generate_uuid
      ActiveRecord::Type::Uuid.generate
    end
    def setup_account
      step("Setting up account", "Account set up in %{duration}") do
        oldest_admin = import.users.order(id: :asc).admin.first
        raise "No admin user found in the database" unless oldest_admin
        membership = untenanted.memberships.find(oldest_admin.membership_id)
        account = import.accounts.sole
        new_identity = Identity.find_or_create_by!(email_address: membership.identity.email_address)
        if Account.all.exists?(external_account_id: account.external_account_id)
          raise AccountExistsError, "Account already exists"
        else
          @account = Account.create_with_owner(
            account: {
              external_account_id: account.external_account_id,
              name: account.name.truncate(255, omission: "")
            },
            owner: {
              name: oldest_admin.name.truncate(255, omission: ""),
              identity: new_identity
            }
          )
          @tenant = @account.external_account_id
          @admin = @account.users.find_by(role: :owner)
        end
        old_join_code = import.account_join_codes.sole
        attributes = {
          usage_count: old_join_code.usage_count,
          usage_limit: old_join_code.usage_limit
        }
        attributes[:code] = old_join_code.code unless Account::JoinCode.all.exists?(code: old_join_code.code)
        @account.join_code.update_columns(**attributes)
      end
    end
    def copy_users
      step("Copying users", "Copied %{count} users in %{duration}") do
        mapping[:users] ||= {}
        import.users.find_each do |old_user|
          new_identity = nil
          if old_user.membership_id && old_user.active?
            membership = untenanted.memberships.find(old_user.membership_id)
            new_identity = Identity.find_or_create_by!(email_address: membership.identity.email_address)
          end
          new_user = if new_identity == @admin.identity
            @admin
          else
            User.create!(
              account: account,
              identity: new_identity,
              name: old_user.name.truncate(255, omission: ""),
              role: old_user.role,
              active: old_user.active,
            )
          end
          old_settings = old_user.settings
          if old_settings
            User::Settings.create!(
              user: new_user,
              bundle_email_frequency: old_settings.bundle_email_frequency,
              timezone_name: old_settings.timezone_name
            )
          end
          mapping[:users][old_user.id] = new_user.id
        end
        { count: mapping[:users].size }
      end
    end
    def copy_boards
      step("Copying boards", "Copied %{count} boards in %{duration}") do
        mapping[:boards] ||= {}
        import.boards.find_each do |old_board|
          new_board = Board.create!(
            account_id: account.id,
            creator_id: mapping[:users][old_board.creator_id],
            name: old_board.name.truncate(255, omission: ""),
            all_access: old_board.all_access,
            created_at: old_board.created_at,
            updated_at: old_board.updated_at
          )
          old_publication = old_board.publication
          if old_publication
            Board::Publication.create!(
              board_id: new_board.id,
              key: old_publication.key,
              created_at: old_publication.created_at,
              updated_at: old_publication.updated_at
            )
          end
          mapping[:boards][old_board.id] = new_board.id
        end
        { count: mapping[:boards].size }
      end
    end
    def copy_columns
      step("Copying columns", "Copied %{count} columns in %{duration}") do
        mapping[:columns] ||= {}
        import.columns.find_each do |old_column|
          new_column = Column.create!(
            account_id: account.id,
            board_id: mapping[:boards][old_column.board_id],
            name: old_column.name.truncate(255, omission: ""),
            color: old_column.color,
            position: old_column.position,
            created_at: old_column.created_at,
            updated_at: old_column.updated_at
          )
          mapping[:columns][old_column.id] = new_column.id
        end
        { count: mapping[:columns].size }
      end
    end
    def copy_cards
      step("Copying cards", "Copied %{count} cards in %{duration}") do
        mapping[:cards] ||= {}
        account.update_columns(cards_count: import.cards.maximum(:id) || 0)
        activity_spikes_to_insert = []
        engagements_to_insert = []
        goldnesses_to_insert = []
        not_nows_to_insert = []
        assignments_to_insert = []
        closures_to_insert = []
        import.cards.in_batches(of: 1000) do |batch|
          cards_to_insert = []
          batch.each do |old_card|
            new_id = generate_uuid
            mapping[:cards][old_card.id] = new_id
            # Map old 'creating' status to 'drafted' since it's no longer a valid enum value
            status = old_card.status == "creating" ? "drafted" : old_card.status
            cards_to_insert << {
              id: new_id,
              number: old_card.id,
              account_id: account.id,
              board_id: mapping[:boards][old_card.board_id],
              column_id: old_card.column_id ? mapping[:columns][old_card.column_id] : nil,
              creator_id: mapping[:users][old_card.creator_id],
              title: old_card.title,
              status: status,
              due_on: old_card.due_on,
              last_active_at: old_card.last_active_at,
              created_at: old_card.created_at,
              updated_at: old_card.updated_at
            }
            old_activity_spike = old_card.activity_spike
            if old_activity_spike
              activity_spikes_to_insert << {
                id: generate_uuid,
                account_id: account.id,
                card_id: new_id,
                created_at: old_activity_spike.created_at,
                updated_at: old_activity_spike.updated_at
              }
            end
            old_engagement = old_card.engagement
            if old_engagement
              engagements_to_insert << {
                id: generate_uuid,
                account_id: account.id,
                card_id: new_id,
                status: old_engagement.status,
                created_at: old_engagement.created_at,
                updated_at: old_engagement.updated_at
              }
            end
            old_goldness = old_card.goldness
            if old_goldness
              goldnesses_to_insert << {
                id: generate_uuid,
                account_id: account.id,
                card_id: new_id,
                created_at: old_goldness.created_at,
                updated_at: old_goldness.updated_at
              }
            end
            old_not_now = old_card.not_now
            if old_not_now
              not_nows_to_insert << {
                id: generate_uuid,
                account_id: account.id,
                card_id: new_id,
                user_id: old_not_now.user_id ? mapping[:users][old_not_now.user_id] : nil,
                created_at: old_not_now.created_at,
                updated_at: old_not_now.updated_at
              }
            end
            old_card.assignments.each do |old_assignment|
              assignments_to_insert << {
                id: generate_uuid,
                account_id: account.id,
                card_id: new_id,
                assignee_id: mapping[:users][old_assignment.assignee_id],
                assigner_id: mapping[:users][old_assignment.assigner_id],
                created_at: old_assignment.created_at,
                updated_at: old_assignment.updated_at
              }
            end
            old_closure = old_card.closure
            if old_closure
              closures_to_insert << {
                id: generate_uuid,
                account_id: account.id,
                card_id: new_id,
                user_id: old_closure.user_id ? mapping[:users][old_closure.user_id] : nil,
                created_at: old_closure.created_at,
                updated_at: old_closure.updated_at
              }
            end
          end
          Card.insert_all(cards_to_insert)
        end
        Card::ActivitySpike.insert_all(activity_spikes_to_insert) if activity_spikes_to_insert.any?
        Card::Engagement.insert_all(engagements_to_insert) if engagements_to_insert.any?
        Card::Goldness.insert_all(goldnesses_to_insert) if goldnesses_to_insert.any?
        Card::NotNow.insert_all(not_nows_to_insert) if not_nows_to_insert.any?
        Assignment.insert_all(assignments_to_insert) if assignments_to_insert.any?
        Closure.insert_all(closures_to_insert) if closures_to_insert.any?
        import.cards.find_each do |old_card|
          new_card_id = mapping[:cards][old_card.id]
          new_card = Card.find(new_card_id)
          copy_rich_text(old_card, new_card, "Card", "description")
          copy_attachment(old_card, new_card, "Card", "image")
        end
        { count: mapping[:cards].size }
      end
    end
    def copy_steps
      step("Copying steps", "Copied steps in %{duration}") do
        import.steps.in_batches(of: 1000) do |batch|
          steps_to_insert = []
          batch.each do |old_step|
            steps_to_insert << {
              id: generate_uuid,
              account_id: account.id,
              card_id: mapping[:cards][old_step.card_id],
              content: old_step.content,
              completed: old_step.completed,
              created_at: old_step.created_at,
              updated_at: old_step.updated_at
            }
          end
          Step.insert_all(steps_to_insert)
        end
      end
    end
    def copy_comments
      step("Copying comments", "Copied %{count} comments in %{duration}") do
        mapping[:comments] ||= {}
        import.comments.in_batches(of: 1000) do |batch|
          comments_to_insert = []
          batch.each do |old_comment|
            new_id = generate_uuid
            mapping[:comments][old_comment.id] = new_id
            comments_to_insert << {
              id: new_id,
              account_id: account.id,
              card_id: mapping[:cards][old_comment.card_id],
              creator_id: mapping[:users][old_comment.creator_id],
              created_at: old_comment.created_at,
              updated_at: old_comment.updated_at
            }
          end
          Comment.insert_all(comments_to_insert)
        end
        import.comments.find_each do |old_comment|
          new_comment_id = mapping[:comments][old_comment.id]
          new_comment = Comment.find(new_comment_id)
          copy_rich_text(old_comment, new_comment, "Comment", "body")
        end
        { count: mapping[:comments].size }
      end
    end
    def copy_mentions
      step("Copying mentions", "Copied %{count} mentions in %{duration}") do
        mapping[:mentions] ||= {}
        import.mentions.find_each do |old_mention|
          new_mention = Mention.create!(
            source_type: old_mention.source_type,
            source_id: mapping[old_mention.source_type.tableize.to_sym][old_mention.source_id],
            mentioner_id: mapping[:users][old_mention.mentioner_id],
            mentionee_id: mapping[:users][old_mention.mentionee_id],
            created_at: old_mention.created_at,
            updated_at: old_mention.updated_at
          )
          mapping[:mentions][old_mention.id] = new_mention.id
        end
        { count: mapping[:mentions].size }
      end
    end
    def copy_accesses
      step("Copying accesses", "Copied %{count} accesses in %{duration}") do
        mapping[:accesses] ||= {}
        import.accesses.in_batches(of: 1000) do |batch|
          accesses_to_insert = []
          batch.each do |old_access|
            new_id = generate_uuid
            mapping[:accesses][old_access.id] = new_id
            accesses_to_insert << {
              id: new_id,
              account_id: account.id,
              board_id: mapping[:boards][old_access.board_id],
              user_id: mapping[:users][old_access.user_id],
              involvement: old_access.involvement,
              accessed_at: old_access.accessed_at,
              created_at: old_access.created_at,
              updated_at: old_access.updated_at
            }
          end
          Access.insert_all(accesses_to_insert)
        end
        { count: mapping[:accesses].size }
      end
    end
    def copy_notifications
      step("Copying notifications", "Copied %{count} notifications in %{duration}") do
        mapping[:notifications] ||= {}
        import.notifications.in_batches(of: 1000) do |batch|
          notifications_to_insert = []
          batch.each do |old_notification|
            new_id = generate_uuid
            mapping[:notifications][old_notification.id] = new_id
            notifications_to_insert << {
              id: new_id,
              account_id: account.id,
              user_id: mapping[:users][old_notification.user_id],
              creator_id: old_notification.creator_id ? mapping[:users][old_notification.creator_id] : nil,
              source_type: old_notification.source_type,
              source_id: mapping.fetch(old_notification.source_type.tableize.to_sym)[old_notification.source_id],
              read_at: old_notification.read_at,
              created_at: old_notification.created_at,
              updated_at: old_notification.updated_at
            }
          end
          Notification.insert_all(notifications_to_insert)
        end
        { count: mapping[:notifications].size }
      end
    end
    def copy_notification_bundles
      step("Copying notification bundles", "Copied %{count} notification bundles in %{duration}") do
        mapping[:notification_bundles] ||= {}
        import.notification_bundles.in_batches(of: 1000) do |batch|
          bundles_to_insert = []
          batch.each do |old_bundle|
            new_id = generate_uuid
            mapping[:notification_bundles][old_bundle.id] = new_id
            bundles_to_insert << {
              id: new_id,
              account_id: account.id,
              user_id: mapping[:users][old_bundle.user_id],
              status: old_bundle.status,
              starts_at: old_bundle.starts_at,
              ends_at: old_bundle.ends_at,
              created_at: old_bundle.created_at,
              updated_at: old_bundle.updated_at
            }
          end
          Notification::Bundle.insert_all(bundles_to_insert)
        end
        { count: mapping[:notification_bundles].size }
      end
    end
    def copy_entropies
      step("Copying entropies", "Copied entropies in %{duration}") do
        import.entropies.find_each do |old_entropy|
          container_id = case old_entropy.container_type
          when "Account" then account.id
          when "Board" then mapping[:boards][old_entropy.container_id]
          when "Card" then mapping[:cards][old_entropy.container_id]
          else next
          end
          Entropy.find_or_create_by!(account_id: account.id, container_type: old_entropy.container_type, container_id: container_id) do |entropy|
            entropy.auto_postpone_period = old_entropy.auto_postpone_period || 0
            entropy.created_at = old_entropy.created_at
            entropy.updated_at = old_entropy.updated_at
          end
        end
      end
    end
    def copy_filters
      step("Copying filters", "Copied %{count} filters in %{duration}") do
        mapping[:filters] ||= {}
        # First, insert all filters
        import.filters.in_batches(of: 1000) do |batch|
          filters_to_insert = []
          batch.each do |old_filter|
            new_id = generate_uuid
            mapping[:filters][old_filter.id] = new_id
            filters_to_insert << {
              id: new_id,
              account_id: account.id,
              creator_id: mapping[:users][old_filter.creator_id],
              params_digest: old_filter.params_digest,
              fields: old_filter.fields,
              created_at: old_filter.created_at,
              updated_at: old_filter.updated_at
            }
          end
          Filter.insert_all(filters_to_insert)
        end
        # Then, copy HABTM associations for each filter
        import.filters.find_each do |old_filter|
          new_filter = Filter.find(mapping[:filters][old_filter.id])
          # Copy HABTM associations by finding valid mapped IDs first
          assignee_ids = import.assignees_filters.where(filter_id: old_filter.id)
            .filter_map { |join| mapping[:users][join.assignee_id] }
          new_filter.assignee_ids = assignee_ids if assignee_ids.any?
          creator_ids = import.creators_filters.where(filter_id: old_filter.id)
            .filter_map { |join| mapping[:users][join.creator_id] }
          new_filter.creator_ids = creator_ids if creator_ids.any?
          closer_ids = import.closers_filters.where(filter_id: old_filter.id)
            .filter_map { |join| mapping[:users][join.closer_id] }
          new_filter.closer_ids = closer_ids if closer_ids.any?
          board_ids = import.boards_filters.where(filter_id: old_filter.id)
            .filter_map { |join| mapping[:boards][join.board_id] }
          new_filter.board_ids = board_ids if board_ids.any?
          tag_ids = import.filters_tags.where(filter_id: old_filter.id)
            .filter_map { |join| mapping[:tags][join.tag_id] }
          new_filter.tag_ids = tag_ids if tag_ids.any?
        end
        { count: mapping[:filters].size }
      end
    end
    def copy_events
      step("Copying events", "Copied %{count} events in %{duration}") do
        mapping[:events] ||= {}
        import.events.in_batches(of: 1000) do |batch|
          events_to_insert = []
          batch.each do |old_event|
            new_id = generate_uuid
            mapping[:events][old_event.id] = new_id
            events_to_insert << {
              id: new_id,
              account_id: account.id,
              board_id: mapping[:boards][old_event.board_id],
              creator_id: mapping[:users][old_event.creator_id],
              eventable_type: old_event.eventable_type,
              eventable_id: mapping[old_event.eventable_type.tableize.to_sym][old_event.eventable_id],
              action: old_event.action,
              particulars: old_event.particulars,
              created_at: old_event.created_at,
              updated_at: old_event.updated_at
            }
          end
          Event.insert_all(events_to_insert)
        end
        { count: mapping[:events].size }
      end
    end
    def copy_rich_text(old_record, new_record, record_type, name)
      old_rich_text = import.rich_texts.find_by(record_type: record_type, record_id: old_record.id, name: name)
      return unless old_rich_text
      new_rich_text = ActionText::RichText.create!(
        record: new_record,
        name: name,
        body: old_rich_text.body,
        created_at: old_rich_text.created_at,
        updated_at: old_rich_text.updated_at
      )
      mapping[:rich_text] ||= {}
      mapping[:rich_text][old_rich_text.id] = new_rich_text.id
      import.attachments.where(record_type: "ActionText::RichText", record_id: old_rich_text.id).each do |old_attachment|
        copy_attachment(old_rich_text, new_rich_text, "ActionText::RichText", old_attachment.name)
      end
    end
    def copy_attachment(old_record, new_record, record_type, name)
      old_attachment = import.attachments.find_by(record_type: record_type, record_id: old_record.id, name: name)
      return unless old_attachment
      old_blob = import.blobs.find(old_attachment.blob_id)
      new_blob = ActiveStorage::Blob.find_or_create_by!(key: old_blob.key) do |blob|
        blob.filename = old_blob.filename
        blob.content_type = old_blob.content_type
        blob.metadata = old_blob.metadata
        blob.service_name = old_blob.service_name
        blob.byte_size = old_blob.byte_size
        blob.checksum = old_blob.checksum
        blob.created_at = old_blob.created_at
      end
      mapping[:blobs] ||= {}
      mapping[:blobs][old_blob.id] = new_blob.id
      # Copy variant records to prevent ActiveStorage from regenerating them
      copy_variant_records(old_blob, new_blob)
      new_attachment = ActiveStorage::Attachment.find_or_create_by!(
        name: name,
        record: new_record,
        blob: new_blob,
        created_at: old_attachment.created_at
      )
      mapping[:attachments] ||= {}
      mapping[:attachments][old_attachment.id] = new_attachment.id
    end
    def copy_variant_records(old_blob, new_blob)
      import.variant_records.where(blob_id: old_blob.id).each do |old_variant_record|
        old_variant_blob = import.blobs.find_by(id: old_variant_record.id)
        next unless old_variant_blob
        new_variant_blob = ActiveStorage::Blob.find_or_create_by!(key: old_variant_blob.key) do |blob|
          blob.filename = old_variant_blob.filename
          blob.content_type = old_variant_blob.content_type
          blob.metadata = old_variant_blob.metadata
          blob.service_name = old_variant_blob.service_name
          blob.byte_size = old_variant_blob.byte_size
          blob.checksum = old_variant_blob.checksum
          blob.created_at = old_variant_blob.created_at
        end
        mapping[:blobs] ||= {}
        mapping[:blobs][old_variant_blob.id] = new_variant_blob.id
        ActiveStorage::VariantRecord.find_or_create_by!(
          id: new_variant_blob.id,
          account_id: account.id,
          blob_id: new_blob.id,
          variation_digest: old_variant_record.variation_digest
        )
      end
    end
    def copy_reactions
      step("Copying reactions", "Copied %{count} reactions in %{duration}") do
        mapping[:reactions] ||= {}
        import.reactions.find_each do |old_reaction|
          # Truncate content to 16 characters to match current column limit
          content = old_reaction.content.truncate(16, omission: "")
          new_reaction = Reaction.create!(
            comment_id: mapping[:comments][old_reaction.comment_id],
            reacter_id: mapping[:users][old_reaction.reacter_id],
            content: content,
            created_at: old_reaction.created_at,
            updated_at: old_reaction.updated_at
          )
          mapping[:reactions][old_reaction.id] = new_reaction.id
        end
        { count: mapping[:reactions].size }
      end
    end
    def copy_tags
      step("Copying tags", "Copied %{tags} tags and %{taggings} taggings in %{duration}") do
        mapping[:tags] ||= {}
        mapping[:taggings] ||= {}
        import.tags.find_each do |old_tag|
          new_tag = account.tags.find_or_create_by!(title: old_tag.title) do |t|
            t.created_at = old_tag.created_at
            t.updated_at = old_tag.updated_at
          end
          mapping[:tags][old_tag.id] = new_tag.id
        end
        import.taggings.find_each do |old_tagging|
          new_tagging = Tagging.create!(
            tag_id: mapping[:tags][old_tagging.tag_id],
            card_id: mapping[:cards][old_tagging.card_id],
            created_at: old_tagging.created_at,
            updated_at: old_tagging.updated_at
          )
          mapping[:taggings][old_tagging.id] = new_tagging.id
        end
        { tags: mapping[:tags].size, taggings: mapping[:taggings].size }
      end
    end
    def copy_watches
      step("Copying watches", "Copied %{count} watches in %{duration}") do
        mapping[:watches] ||= {}
        import.watches.in_batches(of: 1000) do |batch|
          watches_to_insert = []
          batch.each do |old_watch|
            new_id = generate_uuid
            mapping[:watches][old_watch.id] = new_id
            watches_to_insert << {
              id: new_id,
              account_id: account.id,
              user_id: mapping[:users][old_watch.user_id],
              card_id: mapping[:cards][old_watch.card_id],
              watching: old_watch.watching,
              created_at: old_watch.created_at,
              updated_at: old_watch.updated_at
            }
          end
          Watch.insert_all(watches_to_insert)
        end
        { count: mapping[:watches].size }
      end
    end
    def copy_pins
      step("Copying pins", "Copied %{count} pins in %{duration}") do
        mapping[:pins] ||= {}
        import.pins.in_batches(of: 1000) do |batch|
          pins_to_insert = []
          batch.each do |old_pin|
            new_id = generate_uuid
            mapping[:pins][old_pin.id] = new_id
            pins_to_insert << {
              id: new_id,
              account_id: account.id,
              user_id: mapping[:users][old_pin.user_id],
              card_id: mapping[:cards][old_pin.card_id],
              created_at: old_pin.created_at,
              updated_at: old_pin.updated_at
            }
          end
          Pin.insert_all(pins_to_insert)
        end
        { count: mapping[:pins].size }
      end
    end
    def copy_webhooks
      step("Copying webhooks", "Copied %{webhooks} webhooks and %{deliveries} deliveries in %{duration}") do
        mapping[:webhooks] ||= {}
        mapping[:webhook_deliveries] ||= {}
        import.webhooks.find_each do |old_webhook|
          subscribed_actions = old_webhook.subscribed_actions
          subscribed_actions = JSON.parse(subscribed_actions) if subscribed_actions.is_a?(String)
          new_webhook = Webhook.create!(
            account_id: account.id,
            board_id: mapping[:boards][old_webhook.board_id],
            name: old_webhook.name.truncate(255, omission: ""),
            url: old_webhook.url,
            signing_secret: old_webhook.signing_secret,
            subscribed_actions: subscribed_actions,
            active: old_webhook.active,
            created_at: old_webhook.created_at,
            updated_at: old_webhook.updated_at
          )
          mapping[:webhooks][old_webhook.id] = new_webhook.id
          old_tracker = import.webhook_delinquency_trackers.find_by(webhook_id: old_webhook.id)
          if old_tracker
            Webhook::DelinquencyTracker.find_or_create_by!(webhook_id: new_webhook.id) do |tracker|
              tracker.consecutive_failures_count = old_tracker.consecutive_failures_count
              tracker.first_failure_at = old_tracker.first_failure_at
              tracker.created_at = old_tracker.created_at
              tracker.updated_at = old_tracker.updated_at
            end
          end
        end
        import.webhook_deliveries.find_each do |old_delivery|
          new_delivery = Webhook::Delivery.create!(
            webhook_id: mapping[:webhooks][old_delivery.webhook_id],
            event_id: mapping[:events][old_delivery.event_id],
            state: old_delivery.state,
            request: old_delivery.request,
            response: old_delivery.response,
            created_at: old_delivery.created_at,
            updated_at: old_delivery.updated_at
          )
          mapping[:webhook_deliveries][old_delivery.id] = new_delivery.id
        end
        { webhooks: mapping[:webhooks].size, deliveries: mapping[:webhook_deliveries].size }
      end
    end
    def copy_push_subscriptions
      step("Copying push subscriptions", "Copied %{count} push subscriptions in %{duration}") do
        mapping[:push_subscriptions] ||= {}
        import.push_subscriptions.find_each do |old_subscription|
          new_subscription = Push::Subscription.create!(
            account_id: account.id,
            user_id: mapping[:users][old_subscription.user_id],
            endpoint: old_subscription.endpoint,
            p256dh_key: old_subscription.p256dh_key,
            auth_key: old_subscription.auth_key,
            user_agent: old_subscription.user_agent,
            created_at: old_subscription.created_at,
            updated_at: old_subscription.updated_at
          )
          mapping[:push_subscriptions][old_subscription.id] = new_subscription.id
        end
        { count: mapping[:push_subscriptions].size }
      end
    end
    def fix_links
      step("Fixing links", "Fixed %{count} links in %{duration}") do
        mapping[:fixed_links] ||= {}
        ActionText::RichText.where(id: mapping[:rich_text]&.values).find_each do |rich_text|
          fragment = rich_text.body.fragment
          fixed_link = false
          fragment.find_all("a[href]").each do |link|
            url = link["href"]
            uri = URI.parse(url) rescue nil
            if uri
              uri.host = FIX_LINK_HOSTS[uri.host] if uri.absolute? && FIX_LINK_HOSTS.key?(uri.host)
              params = Rails.application.routes.recognize_path(uri.path) rescue {}
              if params[:controller] == "cards" && params[:action] == "show" && params[:id] && mapping[:cards][params[:id].to_i]
                uri.path = Rails.application.routes.url_helpers.card_path(mapping[:cards][params[:id].to_i])
              elsif params[:controller] == "boards" && params[:action] == "show" && params[:id] && mapping[:boards][params[:id].to_i]
                uri.path = Rails.application.routes.url_helpers.board_path(mapping[:boards][params[:id].to_i])
              end
              link["href"] = uri.to_s
              mapping[:fixed_links][url] = link["href"]
              fixed_link = true
            end
          end
          rich_text.update!(body: fragment.to_html) if fixed_link
        end
        { count: mapping[:fixed_links].size }
      end
    end
    def import
      @import ||= Models.new(db_path)
    rescue => e
      $stderr.puts e.backtrace.join("\n") if ENV["DEBUG"]
      raise "Couldn't open the given database: #{e}"
    end
    def untenanted
      @untenanted ||= Models.new(untenanted_db_path)
    rescue => e
      $stderr.puts e.backtrace.join("\n") if ENV["DEBUG"]
      raise "Couldn't open the given untenanted database: #{e}"
    end
end
class Models
  attr_reader :application_record
  def initialize(db_path)
    const_name = "ImportBase#{db_path.hash.abs}"
    if self.class.const_defined?(const_name)
      @application_record = self.class.const_get(const_name)
    else
      @application_record = Class.new(ActiveRecord::Base) do
        self.abstract_class = true
        def self.models
          const_get("MODELS")
        end
        delegate :models, to: :class
      end
      self.class.const_set(const_name, @application_record)
    end
    @application_record.establish_connection adapter: "sqlite3", database: db_path
    @application_record.const_set("MODELS", self)
  end
  def identities
    @identities ||= Class.new(application_record) do
      self.table_name = "identities"
    end
  end
  def memberships
    @memberships ||= begin
      models = self
      Class.new(application_record) do
        self.table_name = "memberships"
        def identity
          @identity ||= models.identities.find_by(id: identity_id)
        end
      end
    end
  end
  def accounts
    @accounts ||= Class.new(application_record) do
      self.table_name = "accounts"
    end
  end
  def account_join_codes
    @account_join_codes ||= Class.new(application_record) do
      self.table_name = "account_join_codes"
    end
  end
  def users
    @users ||= begin
      models = self
      Class.new(application_record) do
        self.table_name = "users"
        def settings
          @settings ||= models.user_settings.find_by(user_id: id)
        end
      end
    end
  end
  def boards
    @boards ||= begin
      models = self
      Class.new(application_record) do
        self.table_name = "boards"
        def publication
          @publication ||= models.board_publications.find_by(board_id: id)
        end
      end
    end
  end
  def columns
    @columns ||= Class.new(application_record) do
      self.table_name = "columns"
    end
  end
  def cards
    @cards ||= begin
      models = self
      Class.new(application_record) do
        self.table_name = "cards"
        def activity_spike
          @activity_spike ||= models.card_activity_spikes.find_by(card_id: id)
        end
        def engagement
          @engagement ||= models.card_engagements.find_by(card_id: id)
        end
        def goldness
          @goldness ||= models.card_goldnesses.find_by(card_id: id)
        end
        def not_now
          @not_now ||= models.card_not_nows.find_by(card_id: id)
        end
        def assignments
          models.assignments.where(card_id: id)
        end
        def closure
          @closure ||= models.closures.find_by(card_id: id)
        end
      end
    end
  end
  def comments
    @comments ||= Class.new(application_record) do
      self.table_name = "comments"
    end
  end
  def steps
    @steps ||= Class.new(application_record) do
      self.table_name = "steps"
    end
  end
  def reactions
    @reactions ||= Class.new(application_record) do
      self.table_name = "reactions"
    end
  end
  def tags
    @tags ||= Class.new(application_record) do
      self.table_name = "tags"
    end
  end
  def taggings
    @taggings ||= Class.new(application_record) do
      self.table_name = "taggings"
    end
  end
  def watches
    @watches ||= Class.new(application_record) do
      self.table_name = "watches"
    end
  end
  def pins
    @pins ||= Class.new(application_record) do
      self.table_name = "pins"
    end
  end
  def webhooks
    @webhooks ||= Class.new(application_record) do
      self.table_name = "webhooks"
    end
  end
  def webhook_deliveries
    @webhook_deliveries ||= Class.new(application_record) do
      self.table_name = "webhook_deliveries"
    end
  end
  def webhook_delinquency_trackers
    @webhook_delinquency_trackers ||= Class.new(application_record) do
      self.table_name = "webhook_delinquency_trackers"
    end
  end
  def push_subscriptions
    @push_subscriptions ||= Class.new(application_record) do
      self.table_name = "push_subscriptions"
    end
  end
  def assignments
    @assignments ||= Class.new(application_record) do
      self.table_name = "assignments"
    end
  end
  def closures
    @closures ||= Class.new(application_record) do
      self.table_name = "closures"
    end
  end
  def accesses
    @accesses ||= Class.new(application_record) do
      self.table_name = "accesses"
    end
  end
  def events
    @events ||= Class.new(application_record) do
      self.table_name = "events"
    end
  end
  def rich_texts
    @rich_texts ||= Class.new(application_record) do
      self.table_name = "action_text_rich_texts"
    end
  end
  def attachments
    @attachments ||= Class.new(application_record) do
      self.table_name = "active_storage_attachments"
    end
  end
  def blobs
    @blobs ||= Class.new(application_record) do
      self.table_name = "active_storage_blobs"
    end
  end
  def variant_records
    @variant_records ||= Class.new(application_record) do
      self.table_name = "active_storage_variant_records"
    end
  end
  def user_settings
    @user_settings ||= Class.new(application_record) do
      self.table_name = "user_settings"
    end
  end
  def board_publications
    @board_publications ||= Class.new(application_record) do
      self.table_name = "board_publications"
    end
  end
  def card_activity_spikes
    @card_activity_spikes ||= Class.new(application_record) do
      self.table_name = "card_activity_spikes"
    end
  end
  def card_engagements
    @card_engagements ||= Class.new(application_record) do
      self.table_name = "card_engagements"
    end
  end
  def card_goldnesses
    @card_goldnesses ||= Class.new(application_record) do
      self.table_name = "card_goldnesses"
    end
  end
  def card_not_nows
    @card_not_nows ||= Class.new(application_record) do
      self.table_name = "card_not_nows"
    end
  end
  def mentions
    @mentions ||= Class.new(application_record) do
      self.table_name = "mentions"
    end
  end
  def notifications
    @notifications ||= Class.new(application_record) do
      self.table_name = "notifications"
    end
  end
  def notification_bundles
    @notification_bundles ||= Class.new(application_record) do
      self.table_name = "notification_bundles"
    end
  end
  def entropies
    @entropies ||= Class.new(application_record) do
      self.table_name = "entropies"
    end
  end
  def filters
    @filters ||= Class.new(application_record) do
      self.table_name = "filters"
    end
  end
  def assignees_filters
    @assignees_filters ||= Class.new(application_record) do
      self.table_name = "assignees_filters"
    end
  end
  def assigners_filters
    @assigners_filters ||= Class.new(application_record) do
      self.table_name = "assigners_filters"
    end
  end
  def boards_filters
    @boards_filters ||= Class.new(application_record) do
      self.table_name = "boards_filters"
    end
  end
  def closers_filters
    @closers_filters ||= Class.new(application_record) do
      self.table_name = "closers_filters"
    end
  end
  def creators_filters
    @creators_filters ||= Class.new(application_record) do
      self.table_name = "creators_filters"
    end
  end
  def filters_tags
    @filters_tags ||= Class.new(application_record) do
      self.table_name = "filters_tags"
    end
  end
end
options = {
  skip_already_imported: false
}
parser = OptionParser.new do |parser|
  parser.banner = "Usage: #{$PROGRAM_NAME} [options] <tenanted_db_path>..."
  parser.on("--untenanted-db-path PATH", "Path to the untenanted database") do |path|
    options[:untenanted_db_path] = path
  end
  parser.on("--skip-already-imported", "Skip import if account already exists") do
    options[:skip_already_imported] = true
  end
  parser.on("-h", "--help", "Show this help message") do
    puts parser
    exit
  end
end
parser.parse!
untenanted_db_path = options[:untenanted_db_path]
tenanted_db_paths = ARGV
if untenanted_db_path.nil?
  $stderr.puts "Error: --untenanted-db-path is required"
  $stderr.puts
  $stderr.puts parser
  exit 1
end
if tenanted_db_paths.empty?
  $stderr.puts "Error: at least one tenanted database path is required"
  $stderr.puts
  $stderr.puts parser
  exit 1
end
total_imported = 0
duration = ActiveSupport::Benchmark.realtime do
  tenanted_db_paths.each_with_index do |db_path, index|
    puts
    puts "="*80
    puts "Processing database #{index + 1}/#{tenanted_db_paths.size}: #{db_path}"
    puts "="*80
    Import.new(db_path, untenanted_db_path, skip_already_imported: options[:skip_already_imported]).import_database
    total_imported += 1
  end
end
puts
puts "="*80
puts "Summary:"
puts "  Imported: #{total_imported}"
puts "  Total time: #{duration.round(2)} seconds"
puts "="*80

================
File: script/load-prod-db-in-dev.rb
================
#!/usr/bin/env ruby
if ARGV.length != 1
  puts "Usage: #{$0} <dbfile>"
  exit 1
end
original_dbfile = ARGV[0]
require "securerandom"
identifier = SecureRandom.hex(4)
# run a process to run the migration and dump the schema cache
Process.fork do
  require_relative "../config/environment"
  unless Rails.env.local?
    abort "This script should only be run in a local development environment."
  end
  tenant = ActiveRecord::FixtureSet.identify(identifier)
  config = ApplicationRecord.tenanted_root_config
  path = config.config_adapter.path_for(config.database_for(tenant))
  FileUtils.mkdir_p(File.dirname(path), verbose: true)
  FileUtils.cp original_dbfile, path, verbose: true
  puts "Running migrations..."
  system "bin/rails db:migrate"
end
Process.wait
# now load the schema cache and do what we need to do in the database
require_relative "../config/environment"
tenant = ActiveRecord::FixtureSet.identify(identifier)
ApplicationRecord.with_tenant(tenant) do |tenant|
  Current.account.destroy!
  Account.create_with_owner \
    account: { name: "Company #{identifier}" },
    owner: { name: "Developer #{identifier}", email_address: "dev-#{identifier}@example.com" }
  user = User.find_by(role: :owner)
  identity = Identity.find_or_create_by(email_address: user.email_address)
  identity.link_to(user.tenant)
  Board.find_each do |board|
    board.accesses.grant_to(user)
  end
  url = Rails.application.routes.url_helpers.root_url(Rails.application.config.action_controller.default_url_options.merge(script_name: Current.account.slug))
  puts "\n\nLogin to #{url} as #{user.email_address} / secret123456"
end

================
File: script/populate.rb
================
require_relative "../config/environment"
require "faker"
ACCOUNT = Account.find_by(name: "cleanslate")
CARDS_COUNT = ARGV.first&.to_i || 10_000
BOARDS_COUNT = ARGV.second&.to_i || 100
TAGS_COUNT = ARGV.third&.to_i || 500
USERS_COUNT = ARGV.fourth&.to_i || 1000
Current.account = ACCOUNT
Current.session = ACCOUNT.users.last.identity.sessions.first
puts "Creating #{CARDS_COUNT} cards with #{TAGS_COUNT} tags across #{BOARDS_COUNT} board(s)"
Board.suppressing_turbo_broadcasts do
  Card.suppressing_turbo_broadcasts do
    BOARDS_COUNT.times do
      ACCOUNT.boards.create! name: Faker::Company.buzzword, all_access: true
      print "."
    end
    CARDS_COUNT.times do
      card = ACCOUNT.boards.take.cards.create! \
        title: Faker::Company.bs, description: Faker::Hacker.say_something_smart, status: :published
      print "."
    end
    TAGS_COUNT.times do
      ACCOUNT.cards.take.toggle_tag_with Faker::Game.title
      print "."
    end
    USERS_COUNT.times do
      ACCOUNT.users.create! name: Faker::FunnyName
    end
  end
end

================
File: script/remove-lb-admin-production.sh
================
#!/usr/bin/env bash
set -e
ssh app@fizzy-lb-101.df-iad-int.37signals.com \
  docker exec fizzy-load-balancer kamal-proxy rm fizzy-admin
ssh app@fizzy-lb-01.sc-chi-int.37signals.com \
  docker exec fizzy-load-balancer kamal-proxy rm fizzy-admin
ssh app@fizzy-lb-401.df-ams-int.37signals.com \
  docker exec fizzy-load-balancer kamal-proxy rm fizzy-admin

================
File: storage/.keep
================


================
File: test/channels/application_cable/connection_test.rb
================
require "test_helper"
module ApplicationCable
  class ConnectionTest < ActionCable::Connection::TestCase
    setup do
      # Use non-37s account to assess that Current.account is set correctly
      @account = accounts(:initech)
      @session = sessions(:mike)
    end
    test "connects with valid session and account info" do
      cookies.signed[:session_token] = @session.signed_id
      connect "/cable", env: { "fizzy.external_account_id" => @account.external_account_id }
      assert_equal users(:mike), connection.current_user
      assert_equal @account, Current.account
    end
    test "rejects with invalid session token" do
      cookies.signed[:session_token] = "invalid-session-id"
      assert_reject_connection do
        connect "/cable", env: { "fizzy.external_account_id" => @account.external_account_id }
      end
    end
    test "rejects when account does not exist" do
      cookies.signed[:session_token] = @session.signed_id
      assert_reject_connection do
        connect "/cable", env: { "fizzy.external_account_id" => -1 }
      end
    end
  end
end

================
File: test/controllers/account/cancellations_controller_test.rb
================
require "test_helper"
class Account::CancellationsControllerTest < ActionDispatch::IntegrationTest
  setup do
    @account = accounts(:"37s")
    @user = users(:jason)
    sign_in_as @user
    if @account.respond_to?(:subscription)
      Account.any_instance.stubs(:subscription).returns(nil)
    end
  end
  test "an owner can cancel the account" do
    assert_difference -> { Account::Cancellation.count }, 1 do
      assert_enqueued_emails 1 do
        post account_cancellation_url
      end
    end
    assert_redirected_to session_menu_path(script_name: nil)
    assert_equal "Account deleted", flash[:notice]
    assert @account.reload.cancelled?
    assert_equal @user, @account.cancellation.initiated_by
  end
  test "non-owner cannot cancel the account" do
    logout_and_sign_in_as users(:david)
    assert_no_difference -> { Account::Cancellation.count } do
      post account_cancellation_url
    end
    assert_response :forbidden
  end
  test "cancelling an account while in single-tenant mode does nothing" do
    with_multi_tenant_mode(false) do
      assert_no_difference -> { Account::Cancellation.count } do
        post account_cancellation_url
      end
      assert_not @account.reload.cancelled?
    end
  end
end

================
File: test/controllers/accounts/entropies_controller_test.rb
================
require "test_helper"
class Account::EntropiesControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
  end
  test "update" do
    put account_entropy_path, params: { entropy: { auto_postpone_period: 1.day } }
    assert_equal 1.day, entropies("37s_account").auto_postpone_period
    assert_redirected_to account_settings_path
  end
  test "update requires admin" do
    logout_and_sign_in_as :david
    put account_entropy_path, params: { entropy: { auto_postpone_period: 1.day } }
    assert_response :forbidden
  end
end

================
File: test/controllers/accounts/exports_controller_test.rb
================
require "test_helper"
class Account::ExportsControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :jason
  end
  test "create creates an export record and enqueues job" do
    assert_difference -> { Account::Export.count }, 1 do
      assert_enqueued_with(job: DataExportJob) do
        post account_exports_path
      end
    end
    assert_redirected_to account_settings_path
    assert_equal "Export started. You'll receive an email when it's ready.", flash[:notice]
  end
  test "create associates export with current user" do
    post account_exports_path
    export = Account::Export.last
    assert_equal users(:jason), export.user
    assert_equal Current.account, export.account
    assert export.pending?
  end
  test "create rejects request when current export limit is reached" do
    Account::ExportsController::CURRENT_EXPORT_LIMIT.times do
      Account::Export.create!(account: Current.account, user: users(:jason))
    end
    assert_no_difference -> { Account::Export.count } do
      post account_exports_path
    end
    assert_response :too_many_requests
  end
  test "create allows request when exports are older than one day" do
    Account::ExportsController::CURRENT_EXPORT_LIMIT.times do
      Account::Export.create!(account: Current.account, user: users(:jason), created_at: 2.days.ago)
    end
    assert_difference -> { Account::Export.count }, 1 do
      post account_exports_path
    end
    assert_redirected_to account_settings_path
  end
  test "show displays completed export with download link" do
    export = Account::Export.create!(account: Current.account, user: users(:jason))
    export.build
    get account_export_path(export)
    assert_response :success
    assert_select "a#download-link"
  end
  test "show displays a warning if the export is missing" do
    get account_export_path("not-really-an-export")
    assert_response :success
    assert_select "h2", "Download Expired"
  end
  test "show does not allow access to another user's export" do
    export = Account::Export.create!(account: Current.account, user: users(:kevin))
    export.build
    get account_export_path(export)
    assert_response :success
    assert_select "h2", "Download Expired"
  end
  test "create is forbidden for non-admin members" do
    logout_and_sign_in_as :david
    post account_exports_path
    assert_response :forbidden
  end
  test "show is forbidden for non-admin members" do
    logout_and_sign_in_as :david
    export = Account::Export.create!(account: Current.account, user: users(:jason))
    export.build
    get account_export_path(export)
    assert_response :forbidden
  end
end

================
File: test/controllers/accounts/join_codes_controller_test.rb
================
require "test_helper"
class Account::JoinCodesControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
  end
  test "reset" do
    get account_join_code_path
    assert_response :success
    assert_changes -> { Current.account.join_code.reload.code } do
      delete account_join_code_path
      assert_redirected_to account_join_code_path
    end
  end
  test "update" do
    get edit_account_join_code_path
    assert_response :success
    put account_join_code_path, params: { account_join_code: { usage_limit: 5 } }
    assert_equal 5, Current.account.join_code.reload.usage_limit
    assert_redirected_to account_join_code_path
  end
  test "update requires admin" do
    logout_and_sign_in_as :david
    put account_join_code_path, params: { account_join_code: { usage_limit: 5 } }
    assert_response :forbidden
  end
  test "destroy requires admin" do
    logout_and_sign_in_as :david
    delete account_join_code_path
    assert_response :forbidden
  end
  test "update with extremely large usage_limit" do
    # A number larger than bigint max (2^63 - 1 = 9223372036854775807)
    huge_number = "99999999999999999999999999999999999"
    put account_join_code_path, params: { account_join_code: { usage_limit: huge_number } }
    assert_response :unprocessable_entity
    assert_select ".txt-negative", text: /cannot be larger than the population of the planet/
  end
end

================
File: test/controllers/accounts/settings_controller_test.rb
================
require "test_helper"
class Account::SettingsControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
  end
  test "show" do
    get account_settings_path
    assert_response :success
  end
  test "update" do
    put account_settings_path, params: { account: { name: "New Account Name" } }
    assert_equal "New Account Name", Current.account.reload.name
    assert_redirected_to account_settings_path
  end
  test "update requires admin" do
    logout_and_sign_in_as :david
    put account_settings_path, params: { account: { name: "New Account Name" } }
    assert_response :forbidden
  end
end

================
File: test/controllers/active_storage/direct_uploads_controller_test.rb
================
require "test_helper"
class ActiveStorage::DirectUploadsControllerTest < ActionDispatch::IntegrationTest
  setup do
    @blob_params = {
      blob: {
        filename: "screenshot.png",
        byte_size: 12345,
        checksum: "GQ5SqLsM7ylnji0Wgd9wNC==",
        content_type: "image/png"
      }
    }
  end
  test "create" do
    sign_in_as :david
    post rails_direct_uploads_path,
      params: @blob_params,
      headers: bearer_token_header(identity_access_tokens(:davids_api_token).token),
      as: :json
    assert_response :success
    assert_includes response.parsed_body.keys, "direct_upload"
  end
  test "create with valid access token" do
    post rails_direct_uploads_path,
      params: @blob_params,
      headers: bearer_token_header(identity_access_tokens(:davids_api_token).token),
      as: :json
    assert_response :success
    assert_includes response.parsed_body.keys, "direct_upload"
  end
  test "create with read-only access token" do
    post rails_direct_uploads_path,
      params: @blob_params,
      headers: bearer_token_header(identity_access_tokens(:jasons_api_token).token),
      as: :json
    assert_response :unauthorized
  end
  test "create with invalid access token" do
    post rails_direct_uploads_path,
      params: @blob_params,
      headers: bearer_token_header("invalid_token"),
      as: :json
    assert_response :unauthorized
  end
  test "create unauthenticated" do
    post rails_direct_uploads_path,
      params: @blob_params,
      as: :json
    assert_response :redirect
  end
  test "create in another account is forbidden" do
    sign_in_as :david
    post rails_direct_uploads_path(script_name: "/#{ActiveRecord::FixtureSet.identify("initech")}"),
      params: @blob_params,
      as: :json
    assert_response :forbidden
  end
  test "create with valid access token in another account is forbidden" do
    post rails_direct_uploads_path(script_name: "/#{ActiveRecord::FixtureSet.identify("initech")}"),
      params: @blob_params,
      headers: bearer_token_header(identity_access_tokens(:davids_api_token).token),
      as: :json
    assert_response :forbidden
  end
  private
    def bearer_token_header(token)
      { "Authorization" => "Bearer #{token}" }
    end
end

================
File: test/controllers/admin/mission_control_test.rb
================
require "test_helper"
class Admin::MissionControlTest < ActionDispatch::IntegrationTest
  test "staff can access mission control jobs" do
    sign_in_as :david
    untenanted do
      get "/admin/jobs"
    end
    assert_response :success
  end
  test "non-staff cannot access mission control jobs" do
    sign_in_as :jz
    untenanted do
      get "/admin/jobs"
    end
    assert_response :forbidden
  end
end

================
File: test/controllers/boards/columns/closeds_controller_test.rb
================
require "test_helper"
class Boards::Columns::ClosedsControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
  end
  test "show" do
    get board_columns_closed_path(boards(:writebook))
    assert_response :success
  end
end

================
File: test/controllers/boards/columns/not_nows_controller_test.rb
================
require "test_helper"
class Boards::Columns::NotNowsControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
  end
  test "show" do
    get board_columns_not_now_path(boards(:writebook))
    assert_response :success
  end
end

================
File: test/controllers/boards/columns/streams_controller_test.rb
================
require "test_helper"
class Boards::Columns::StreamsControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
  end
  test "show" do
    get board_columns_stream_path(boards(:writebook))
    assert_response :success
  end
end

================
File: test/controllers/boards/columns_controller_test.rb
================
require "test_helper"
class Boards::ColumnsControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
  end
  test "show" do
    get board_column_path(boards(:writebook), columns(:writebook_in_progress))
    assert_response :success
  end
  test "create" do
    assert_difference -> { boards(:writebook).columns.count }, +1 do
      post board_columns_path(boards(:writebook)), params: { column: { name: "New Column" } }, as: :turbo_stream
      assert_response :success
    end
    assert_equal "New Column", boards(:writebook).columns.last.name
  end
  test "create refreshes adjacent columns" do
    board = boards(:writebook)
    post board_columns_path(board), params: { column: { name: "New Column" } }, as: :turbo_stream
    new_column = board.columns.find_by!(name: "New Column")
    new_column.adjacent_columns.each do |adjacent_column|
      assert_turbo_stream action: :replace, target: dom_id(adjacent_column)
    end
  end
  test "update" do
    column = columns(:writebook_in_progress)
    assert_changes -> { column.reload.name }, from: "In progress", to: "Updated Name" do
      put board_column_path(boards(:writebook), column), params: { column: { name: "Updated Name" } }, as: :turbo_stream
      assert_response :success
    end
  end
  test "destroy" do
    column = columns(:writebook_in_progress)
    adjacent_columns = column.adjacent_columns.to_a
    delete board_column_path(column.board, column), as: :turbo_stream
    assert_redirected_to board_path(column.board)
  end
  test "index as JSON" do
    board = boards(:writebook)
    get board_columns_path(board), as: :json
    assert_response :success
    assert_equal board.columns.count, @response.parsed_body.count
  end
  test "show as JSON" do
    column = columns(:writebook_in_progress)
    get board_column_path(column.board, column), as: :json
    assert_response :success
    assert_equal column.id, @response.parsed_body["id"]
  end
  test "create as JSON" do
    board = boards(:writebook)
    assert_difference -> { board.columns.count }, +1 do
      post board_columns_path(board), params: { column: { name: "New Column" } }, as: :json
    end
    assert_response :created
    assert_equal board_column_path(board, Column.last, format: :json), @response.headers["Location"]
  end
  test "update as JSON" do
    column = columns(:writebook_in_progress)
    put board_column_path(column.board, column), params: { column: { name: "Updated Name" } }, as: :json
    assert_response :no_content
    assert_equal "Updated Name", column.reload.name
  end
  test "destroy as JSON" do
    column = columns(:writebook_on_hold)
    assert_difference -> { column.board.columns.count }, -1 do
      delete board_column_path(column.board, column), as: :json
    end
    assert_response :no_content
  end
end

================
File: test/controllers/boards/entropies_controller_test.rb
================
require "test_helper"
class Boards::EntropiesControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
    @board = boards(:writebook)
  end
  test "update" do
    assert_no_difference -> { Current.account.entropy.reload.auto_postpone_period } do
      put board_entropy_path(@board, format: :turbo_stream), params: { board: { auto_postpone_period: 123.days } }
      assert_equal 123.days, @board.entropy.reload.auto_postpone_period
      assert_turbo_stream action: :replace, target: dom_id(@board, :entropy)
    end
  end
  test "update requires board admin permission" do
    logout_and_sign_in_as :jz
    original_period = @board.entropy.auto_postpone_period
    put board_entropy_path(@board, format: :turbo_stream), params: { board: { auto_postpone_period: 1.day } }
    assert_response :forbidden
    assert_equal original_period, @board.entropy.reload.auto_postpone_period
  end
end

================
File: test/controllers/boards/involvements_controller_test.rb
================
require "test_helper"
class Boards::InvolvementsControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
  end
  test "update" do
    board = boards(:writebook)
    board.access_for(users(:kevin)).access_only!
    assert_changes -> { board.access_for(users(:kevin)).involvement }, from: "access_only", to: "watching" do
      put board_involvement_path(board, involvement: "watching")
    end
    assert_response :success
  end
end

================
File: test/controllers/boards/publications_controller_test.rb
================
require "test_helper"
class Boards::PublicationsControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
    @board = boards(:writebook)
  end
  test "publish a board" do
    assert_not @board.published?
    assert_changes -> { @board.reload.published? }, from: false, to: true do
      post board_publication_path(@board, format: :turbo_stream)
    end
    assert_turbo_stream action: :replace, target: dom_id(@board, :publication)
  end
  test "unpublish a board" do
    @board.publish
    assert @board.published?
    assert_changes -> { @board.reload.published? }, from: true, to: false do
      delete board_publication_path(@board, format: :turbo_stream)
    end
    assert_turbo_stream action: :replace, target: dom_id(@board, :publication)
  end
  test "publish requires board admin permission" do
    logout_and_sign_in_as :jz
    assert_not @board.published?
    post board_publication_path(@board, format: :turbo_stream)
    assert_response :forbidden
    assert_not @board.reload.published?
  end
  test "unpublish requires board admin permission" do
    logout_and_sign_in_as :jz
    @board.publish
    assert @board.published?
    delete board_publication_path(@board, format: :turbo_stream)
    assert_response :forbidden
    assert @board.reload.published?
  end
end

================
File: test/controllers/cards/comments/reactions_controller_test.rb
================
require "test_helper"
class Cards::Comments::ReactionsControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :david
    @comment = comments(:logo_agreement_jz)
    @card = @comment.card
  end
  test "index" do
    get card_comment_reactions_path(@card, @comment)
    assert_response :success
  end
  test "create" do
    assert_difference -> { @comment.reactions.count }, 1 do
      post card_comment_reactions_path(@comment.card, @comment, format: :turbo_stream), params: { reaction: { content: "Great work!" } }
      assert_turbo_stream action: :replace, target: dom_id(@comment, :reacting)
    end
  end
  test "destroy" do
    reaction = reactions(:david)
    assert_difference -> { @comment.reactions.count }, -1 do
      delete card_comment_reaction_path(@comment.card, @comment, reaction, format: :turbo_stream)
      assert_turbo_stream action: :remove, target: dom_id(reaction)
    end
  end
  test "non-owner cannot destroy reaction" do
    reaction = reactions(:kevin)
    assert_no_difference -> { @comment.reactions.count } do
      delete card_comment_reaction_path(@comment.card, @comment, reaction, format: :turbo_stream)
      assert_response :forbidden
    end
  end
  test "index as JSON" do
    get card_comment_reactions_path(@card, @comment), as: :json
    assert_response :success
    assert_equal @comment.reactions.count, @response.parsed_body.count
  end
  test "create as JSON" do
    assert_difference -> { @comment.reactions.count }, 1 do
      post card_comment_reactions_path(@card, @comment), params: { reaction: { content: "" } }, as: :json
    end
    assert_response :created
  end
  test "destroy as JSON" do
    reaction = reactions(:david)
    assert_difference -> { @comment.reactions.count }, -1 do
      delete card_comment_reaction_path(@card, @comment, reaction), as: :json
    end
    assert_response :no_content
  end
end

================
File: test/controllers/cards/assignments_controller_test.rb
================
require "test_helper"
class Cards::AssignmentsControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
  end
  test "new" do
    get new_card_assignment_path(cards(:logo))
    assert_response :success
  end
  test "create" do
    assert_changes "cards(:logo).reload.assigned_to?(users(:david))", from: false, to: true do
      post card_assignments_path(cards(:logo)), params: { assignee_id: users(:david).id }, as: :turbo_stream
      assert_meta_replaced(cards(:logo))
    end
    assert_changes "cards(:logo).reload.assigned_to?(users(:david))", from: true, to: false do
      post card_assignments_path(cards(:logo)), params: { assignee_id: users(:david).id }, as: :turbo_stream
      assert_meta_replaced(cards(:logo))
    end
  end
  test "create as JSON" do
    card = cards(:logo)
    assert_not card.assigned_to?(users(:david))
    post card_assignments_path(card), params: { assignee_id: users(:david).id }, as: :json
    assert_response :no_content
    assert card.reload.assigned_to?(users(:david))
    post card_assignments_path(card), params: { assignee_id: users(:david).id }, as: :json
    assert_response :no_content
    assert_not card.reload.assigned_to?(users(:david))
  end
  private
    def assert_meta_replaced(card)
      assert_turbo_stream action: :replace, target: dom_id(card, :meta)
    end
end

================
File: test/controllers/cards/boards_controller_test.rb
================
require "test_helper"
class Cards::BoardsControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
  end
  test "update changes card board" do
    card = cards(:logo)
    new_board = boards(:private)
    assert_not_equal new_board, card.board
    assert_changes -> { card.reload.board }, from: card.board, to: new_board do
      put card_board_path(card), params: { board_id: new_board.id }
    end
    assert_redirected_to card
  end
  test "update as JSON" do
    card = cards(:logo)
    new_board = boards(:private)
    assert_not_equal new_board, card.board
    put card_board_path(card), params: { board_id: new_board.id }, as: :json
    assert_response :no_content
    assert_equal new_board, card.reload.board
  end
end

================
File: test/controllers/cards/closures_controller_test.rb
================
require "test_helper"
class Cards::ClosuresControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
  end
  test "create" do
    card = cards(:logo)
    assert_changes -> { card.reload.closed? }, from: false, to: true do
      post card_closure_path(card), as: :turbo_stream
      assert_card_container_rerendered(card)
    end
  end
  test "destroy" do
    card = cards(:shipping)
    assert_changes -> { card.reload.closed? }, from: true, to: false do
      delete card_closure_path(card), as: :turbo_stream
      assert_card_container_rerendered(card)
    end
  end
  test "create as JSON" do
    card = cards(:logo)
    assert_not card.closed?
    post card_closure_path(card), as: :json
    assert_response :no_content
    assert card.reload.closed?
  end
  test "destroy as JSON" do
    card = cards(:shipping)
    assert card.closed?
    delete card_closure_path(card), as: :json
    assert_response :no_content
    assert_not card.reload.closed?
  end
end

================
File: test/controllers/cards/comments_controller_test.rb
================
require "test_helper"
class Cards::CommentsControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
  end
  test "create" do
    assert_difference -> { cards(:logo).comments.count }, +1 do
      post card_comments_path(cards(:logo)), params: { comment: { body: "Agreed." } }, as: :turbo_stream
    end
    assert_response :success
  end
  test "create on draft card is forbidden" do
    draft_card = boards(:writebook).cards.create!(status: :drafted, creator: users(:kevin))
    assert_no_difference -> { draft_card.comments.count } do
      post card_comments_path(draft_card), params: { comment: { body: "This should be forbidden" } }, as: :json
    end
    assert_response :forbidden
  end
  test "update" do
    put card_comment_path(cards(:logo), comments(:logo_agreement_kevin)), params: { comment: { body: "I've changed my mind" } }, as: :turbo_stream
    assert_response :success
    assert_action_text "I've changed my mind", comments(:logo_agreement_kevin).reload.body
  end
  test "update another user's comment" do
    assert_no_changes -> { comments(:logo_agreement_jz).reload.body.to_s } do
      put card_comment_path(cards(:logo), comments(:logo_agreement_jz)), params: { comment: { body: "I've changed my mind" } }, as: :turbo_stream
    end
    assert_response :forbidden
  end
  test "index as JSON" do
    card = cards(:logo)
    get card_comments_path(card), as: :json
    assert_response :success
    assert_equal card.comments.count, @response.parsed_body.count
  end
  test "create as JSON" do
    card = cards(:logo)
    assert_difference -> { card.comments.count }, +1 do
      post card_comments_path(card), params: { comment: { body: "New comment" } }, as: :json
    end
    assert_response :created
    assert_equal card_comment_path(card, Comment.last, format: :json), @response.headers["Location"]
  end
  test "create as JSON with custom created_at" do
    card = cards(:logo)
    custom_time = Time.utc(2024, 1, 15, 10, 30, 0)
    assert_difference -> { card.comments.count }, +1 do
      post card_comments_path(card), params: { comment: { body: "Backdated comment", created_at: custom_time } }, as: :json
    end
    assert_response :created
    assert_equal custom_time, Comment.last.created_at
  end
  test "show as JSON" do
    comment = comments(:logo_agreement_kevin)
    get card_comment_path(comment.card, comment), as: :json
    assert_response :success
    assert_equal comment.id, @response.parsed_body["id"]
    assert_equal comment.card.id, @response.parsed_body.dig("card", "id")
    assert_equal card_url(comment.card.id), @response.parsed_body.dig("card", "url")
    assert_equal card_comment_reactions_url(comment.card_id, comment.id), @response.parsed_body["reactions_url"]
    assert_equal card_comment_url(comment.card_id, comment.id), @response.parsed_body["url"]
  end
  test "update as JSON" do
    comment = comments(:logo_agreement_kevin)
    put card_comment_path(cards(:logo), comment), params: { comment: { body: "Updated comment" } }, as: :json
    assert_response :success
    assert_equal "Updated comment", comment.reload.body.to_plain_text
  end
  test "destroy as JSON" do
    comment = comments(:logo_agreement_kevin)
    delete card_comment_path(cards(:logo), comment), as: :json
    assert_response :no_content
    assert_not Comment.exists?(comment.id)
  end
end

================
File: test/controllers/cards/drafts_controller_test.rb
================
require "test_helper"
class Cards::DraftsControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
  end
  test "show" do
    card = boards(:writebook).cards.create!(creator: users(:kevin), status: :drafted)
    get card_draft_path(card)
    assert_response :success
  end
  test "show redirects to card when published" do
    card = cards(:logo)
    get card_draft_path(card)
    assert_redirected_to card
  end
end

================
File: test/controllers/cards/goldnesses_controller_test.rb
================
require "test_helper"
class Cards::GoldnessesControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
  end
  test "create" do
    assert_changes -> { cards(:text).reload.golden? }, from: false, to: true do
      post card_goldness_path(cards(:text)), as: :turbo_stream
      assert_card_container_rerendered(cards(:text))
    end
  end
  test "destroy" do
    assert_changes -> { cards(:logo).reload.golden? }, from: true, to: false do
      delete card_goldness_path(cards(:logo)), as: :turbo_stream
      assert_card_container_rerendered(cards(:logo))
    end
  end
  test "create as JSON" do
    card = cards(:text)
    assert_not card.golden?
    post card_goldness_path(card), as: :json
    assert_response :no_content
    assert card.reload.golden?
  end
  test "destroy as JSON" do
    card = cards(:logo)
    assert card.golden?
    delete card_goldness_path(card), as: :json
    assert_response :no_content
    assert_not card.reload.golden?
  end
end

================
File: test/controllers/cards/images_controller_test.rb
================
require "test_helper"
class Cards::ImagesControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
  end
  test "destroy" do
    card = cards(:logo)
    card.image.attach(io: file_fixture("moon.jpg").open, filename: "moon.jpg")
    assert card.image.attached?
    delete card_image_path(card)
    assert_redirected_to card
    assert_not card.reload.image.attached?
  end
  test "destroy as JSON" do
    card = cards(:logo)
    card.image.attach(io: file_fixture("moon.jpg").open, filename: "moon.jpg")
    assert card.image.attached?
    delete card_image_path(card), as: :json
    assert_response :no_content
    assert_not card.reload.image.attached?
  end
end

================
File: test/controllers/cards/not_nows_controller_test.rb
================
require "test_helper"
class Cards::NotNowsControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
  end
  test "create" do
    card = cards(:logo)
    assert_changes -> { card.reload.postponed? }, from: false, to: true do
      post card_not_now_path(card), as: :turbo_stream
      assert_card_container_rerendered(card)
    end
  end
  test "create as JSON" do
    card = cards(:logo)
    assert_not card.postponed?
    post card_not_now_path(card), as: :json
    assert_response :no_content
    assert card.reload.postponed?
  end
end

================
File: test/controllers/cards/pins_controller_test.rb
================
require "test_helper"
class Cards::PinsControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
  end
  test "create" do
    assert_changes -> { cards(:layout).pinned_by?(users(:kevin)) }, from: false, to: true do
      perform_enqueued_jobs do
        assert_turbo_stream_broadcasts([ users(:kevin), :pins_tray ], count: 1) do
          post card_pin_path(cards(:layout)), as: :turbo_stream
        end
      end
    end
    assert_response :success
  end
  test "create as JSON" do
    card = cards(:layout)
    assert_not card.pinned_by?(users(:kevin))
    post card_pin_path(card), as: :json
    assert_response :no_content
    assert card.reload.pinned_by?(users(:kevin))
  end
  test "destroy" do
    assert_changes -> { cards(:shipping).pinned_by?(users(:kevin)) }, from: true, to: false do
      perform_enqueued_jobs do
        assert_turbo_stream_broadcasts([ users(:kevin), :pins_tray ], count: 1) do
          delete card_pin_path(cards(:shipping)), as: :turbo_stream
        end
      end
    end
    assert_response :success
  end
  test "destroy as JSON" do
    card = cards(:shipping)
    assert card.pinned_by?(users(:kevin))
    delete card_pin_path(card), as: :json
    assert_response :no_content
    assert_not card.reload.pinned_by?(users(:kevin))
  end
end

================
File: test/controllers/cards/previews_controller_test.rb
================
require "test_helper"
class Cards::PreviewsControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
  end
  test "index" do
    get cards_previews_path(format: :turbo_stream)
    assert_response :success
  end
end

================
File: test/controllers/cards/publishes_controller_test.rb
================
require "test_helper"
class Cards::PublishesControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
  end
  test "create" do
    card = cards(:logo)
    card.drafted!
    assert_changes -> { card.reload.published? }, from: false, to: true do
      post card_publish_path(card)
    end
    assert_redirected_to card.board
  end
  test "create and add another" do
    card = cards(:logo)
    card.drafted!
    assert_changes -> { card.reload.published? }, from: false, to: true do
      assert_difference -> { Card.count }, +1 do
        post card_publish_path(card, creation_type: "add_another")
      end
    end
    new_card = Card.last
    assert new_card.drafted?
    assert_redirected_to card_draft_path(new_card)
  end
end

================
File: test/controllers/cards/reactions_controller_test.rb
================
require "test_helper"
class Cards::ReactionsControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :david
    @card = cards(:logo)
  end
  test "index" do
    get card_reactions_path(@card)
    assert_response :success
  end
  test "new" do
    get new_card_reaction_path(@card)
    assert_response :success
  end
  test "create" do
    assert_difference -> { @card.reactions.count }, 1 do
      post card_reactions_path(@card, format: :turbo_stream), params: { reaction: { content: "Great work!" } }
      assert_turbo_stream action: :replace, target: dom_id(@card, :reacting)
    end
  end
  test "destroy" do
    reaction = reactions(:logo_card_david)
    assert_difference -> { @card.reactions.count }, -1 do
      delete card_reaction_path(@card, reaction, format: :turbo_stream)
      assert_turbo_stream action: :remove, target: dom_id(reaction)
    end
  end
  test "non-owner cannot destroy reaction" do
    reaction = reactions(:logo_card_kevin)
    assert_no_difference -> { @card.reactions.count } do
      delete card_reaction_path(@card, reaction, format: :turbo_stream)
      assert_response :forbidden
    end
  end
  test "index as JSON" do
    get card_reactions_path(@card), as: :json
    assert_response :success
    assert_equal @card.reactions.count, @response.parsed_body.count
  end
  test "create as JSON" do
    assert_difference -> { @card.reactions.count }, 1 do
      post card_reactions_path(@card), params: { reaction: { content: "" } }, as: :json
    end
    assert_response :created
  end
  test "destroy as JSON" do
    reaction = reactions(:logo_card_david)
    assert_difference -> { @card.reactions.count }, -1 do
      delete card_reaction_path(@card, reaction), as: :json
    end
    assert_response :no_content
  end
end

================
File: test/controllers/cards/readings_controller_test.rb
================
require "test_helper"
class Cards::ReadingsControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
  end
  test "create" do
    freeze_time
    assert_changes -> { notifications(:logo_published_kevin).reload.read? }, from: false, to: true do
      assert_changes -> { accesses(:writebook_kevin).reload.accessed_at }, from: nil, to: Time.current do
        post card_reading_url(cards(:logo)), as: :turbo_stream
      end
    end
    assert_response :success
  end
  test "read one notification on card visit" do
    assert_changes -> { notifications(:logo_published_kevin).reload.read? }, from: false, to: true do
      post card_reading_path(cards(:logo)), as: :turbo_stream
    end
    assert_response :success
  end
  test "read multiple notifications on card visit" do
    assert_changes -> { notifications(:logo_published_kevin).reload.read? }, from: false, to: true do
      assert_changes -> { notifications(:logo_assignment_kevin).reload.read? }, from: false, to: true do
        post card_reading_path(cards(:logo)), as: :turbo_stream
      end
    end
    assert_response :success
  end
  test "destroy" do
    freeze_time
    notifications(:logo_published_kevin).read
    notifications(:logo_assignment_kevin).read
    assert_changes -> { notifications(:logo_published_kevin).reload.read? }, from: true, to: false do
      assert_changes -> { accesses(:writebook_kevin).reload.accessed_at }, to: Time.current do
        delete card_reading_url(cards(:logo)), as: :turbo_stream
      end
    end
    assert_response :success
  end
  test "unread one notification on destroy" do
    notifications(:logo_published_kevin).read
    assert_changes -> { notifications(:logo_published_kevin).reload.read? }, from: true, to: false do
      delete card_reading_path(cards(:logo)), as: :turbo_stream
    end
    assert_response :success
  end
  test "unread multiple notifications on destroy" do
    notifications(:logo_published_kevin).read
    notifications(:logo_assignment_kevin).read
    assert_changes -> { notifications(:logo_published_kevin).reload.read? }, from: true, to: false do
      assert_changes -> { notifications(:logo_assignment_kevin).reload.read? }, from: true, to: false do
        delete card_reading_path(cards(:logo)), as: :turbo_stream
      end
    end
    assert_response :success
  end
end

================
File: test/controllers/cards/self_assignments_controller_test.rb
================
require "test_helper"
class Cards::SelfAssignmentsControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
  end
  test "create assigns to current user" do
    card = cards(:layout)
    assert_not card.assigned_to?(users(:kevin))
    post card_self_assignment_path(card), as: :turbo_stream
    assert_response :success
    assert_meta_replaced(card)
    assert card.reload.assigned_to?(users(:kevin))
  end
  test "create toggles off when already assigned" do
    card = cards(:logo)
    assert card.assigned_to?(users(:kevin))
    post card_self_assignment_path(card), as: :turbo_stream
    assert_response :success
    assert_meta_replaced(card)
    assert_not card.reload.assigned_to?(users(:kevin))
  end
  test "create as JSON" do
    card = cards(:layout)
    assert_not card.assigned_to?(users(:kevin))
    post card_self_assignment_path(card), as: :json
    assert_response :no_content
    assert card.reload.assigned_to?(users(:kevin))
  end
  private
    def assert_meta_replaced(card)
      assert_turbo_stream action: :replace, target: dom_id(card, :meta)
    end
end

================
File: test/controllers/cards/steps_controller_test.rb
================
require "test_helper"
class Cards::StepsControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
  end
  test "create" do
    card = cards(:logo)
    assert_difference -> { card.steps.count }, +1 do
      post card_steps_path(card), params: { step: { content: "Research alternatives" } }, as: :turbo_stream
      assert_turbo_stream action: :before, target: dom_id(card, :new_step)
    end
    assert_equal "Research alternatives", card.steps.last.content
  end
  test "update" do
    card = cards(:logo)
    step = card.steps.create!(content: "Original content")
    assert_changes -> { step.reload.content }, from: "Original content", to: "Updated content" do
      put card_step_path(card, step), params: { step: { content: "Updated content" } }, as: :turbo_stream
      assert_turbo_stream action: :replace, target: dom_id(step)
    end
  end
  test "destroy" do
    card = cards(:logo)
    step = card.steps.create!(content: "Step to delete")
    assert_difference -> { card.steps.count }, -1 do
      delete card_step_path(card, step), as: :turbo_stream
      assert_turbo_stream action: :remove, target: dom_id(step)
    end
  end
  test "toggle completion" do
    card = cards(:logo)
    step = card.steps.create!(content: "Test step", completed: false)
    # Toggle to completed
    assert_changes -> { step.reload.completed? }, from: false, to: true do
      put card_step_path(card, step), params: { step: { completed: "1" } }, as: :turbo_stream
      assert_turbo_stream action: :replace, target: dom_id(step)
    end
    # Toggle back to incomplete
    assert_changes -> { step.reload.completed? }, from: true, to: false do
      put card_step_path(card, step), params: { step: { completed: "0" } }, as: :turbo_stream
      assert_turbo_stream action: :replace, target: dom_id(step)
    end
  end
  test "create as JSON" do
    card = cards(:logo)
    assert_difference -> { card.steps.count }, +1 do
      post card_steps_path(card), params: { step: { content: "New step" } }, as: :json
    end
    assert_response :created
    assert_equal card_step_path(card, Step.last, format: :json), @response.headers["Location"]
  end
  test "show as JSON" do
    card = cards(:logo)
    step = card.steps.create!(content: "Test step")
    get card_step_path(card, step), as: :json
    assert_response :success
    assert_equal step.id, @response.parsed_body["id"]
    assert_equal "Test step", @response.parsed_body["content"]
  end
  test "update as JSON" do
    card = cards(:logo)
    step = card.steps.create!(content: "Original")
    put card_step_path(card, step), params: { step: { content: "Updated" } }, as: :json
    assert_response :success
    assert_equal "Updated", step.reload.content
    assert_equal "Updated", @response.parsed_body["content"]
  end
  test "destroy as JSON" do
    card = cards(:logo)
    step = card.steps.create!(content: "To delete")
    delete card_step_path(card, step), as: :json
    assert_response :no_content
    assert_not Step.exists?(step.id)
  end
end

================
File: test/controllers/cards/taggings_controller_test.rb
================
require "test_helper"
class Cards::TaggingsControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
  end
  test "new" do
    get new_card_tagging_path(cards(:logo))
    assert_response :success
  end
  test "toggle tag on" do
    assert_changes "cards(:logo).tagged_with?(tags(:mobile))", from: false, to: true do
      post card_taggings_path(cards(:logo)), params: { tag_title: tags(:mobile).title }, as: :turbo_stream
      assert_turbo_stream action: :replace, target: dom_id(cards(:logo), :tags)
    end
  end
  test "toggle tag off" do
    assert_changes "cards(:logo).tagged_with?(tags(:web))", from: true, to: false do
      post card_taggings_path(cards(:logo)), params: { tag_title: tags(:web).title }, as: :turbo_stream
      assert_turbo_stream action: :replace, target: dom_id(cards(:logo), :tags)
    end
  end
  test "toggle tag on as JSON" do
    card = cards(:logo)
    assert_not card.tagged_with?(tags(:mobile))
    post card_taggings_path(card), params: { tag_title: tags(:mobile).title }, as: :json
    assert_response :no_content
    assert card.reload.tagged_with?(tags(:mobile))
  end
  test "toggle tag off as JSON" do
    card = cards(:logo)
    assert card.tagged_with?(tags(:web))
    post card_taggings_path(card), params: { tag_title: tags(:web).title }, as: :json
    assert_response :no_content
    assert_not card.reload.tagged_with?(tags(:web))
  end
end

================
File: test/controllers/cards/triages_controller_test.rb
================
require "test_helper"
class Cards::TriagesControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
  end
  test "create" do
    card = cards(:logo)
    original_column = card.column
    column = columns(:writebook_in_progress)
    assert_changes -> { card.reload.column }, from: original_column, to: column do
      post card_triage_path(card, column_id: column.id)
      assert_redirected_to card
    end
  end
  test "destroy" do
    card = cards(:shipping)
    assert_changes -> { card.reload.column }, to: nil do
      delete card_triage_path(card), as: :turbo_stream
      assert_redirected_to card
    end
  end
  test "create as JSON" do
    card = cards(:logo)
    column = columns(:writebook_in_progress)
    post card_triage_path(card, column_id: column.id), as: :json
    assert_response :no_content
    assert_equal column, card.reload.column
  end
  test "destroy as JSON" do
    card = cards(:shipping)
    assert card.column.present?
    delete card_triage_path(card), as: :json
    assert_response :no_content
    assert_nil card.reload.column
  end
end

================
File: test/controllers/cards/watches_controller_test.rb
================
require "test_helper"
class Cards::WatchesControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
  end
  test "create" do
    cards(:logo).unwatch_by users(:kevin)
    assert_changes -> { cards(:logo).watched_by?(users(:kevin)) }, from: false, to: true do
      post card_watch_path(cards(:logo)), as: :turbo_stream
    end
  end
  test "destroy" do
    cards(:logo).watch_by users(:kevin)
    assert_changes -> { cards(:logo).watched_by?(users(:kevin)) }, from: true, to: false do
      delete card_watch_path(cards(:logo)), as: :turbo_stream
    end
  end
  test "create as JSON" do
    card = cards(:logo)
    card.unwatch_by users(:kevin)
    assert_not card.watched_by?(users(:kevin))
    post card_watch_path(card), as: :json
    assert_response :no_content
    assert card.reload.watched_by?(users(:kevin))
  end
  test "destroy as JSON" do
    card = cards(:logo)
    card.watch_by users(:kevin)
    assert card.watched_by?(users(:kevin))
    delete card_watch_path(card), as: :json
    assert_response :no_content
    assert_not card.reload.watched_by?(users(:kevin))
  end
end

================
File: test/controllers/columns/cards/drops/closures_controller_test.rb
================
require "test_helper"
class Columns::Cards::Drops::ClosuresControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
  end
  test "create" do
    card = cards(:logo)
    assert_changes -> { card.reload.closed? }, from: false, to: true do
      post columns_card_drops_closure_path(card), as: :turbo_stream
      assert_response :success
    end
  end
end

================
File: test/controllers/columns/cards/drops/columns_controller_test.rb
================
require "test_helper"
class Columns::Cards::Drops::ColumnsControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
  end
  test "create" do
    card = cards(:logo)
    column = columns(:writebook_in_progress)
    assert_changes -> { card.reload.column }, to: column do
      post columns_card_drops_column_path(card, column_id: column.id), as: :turbo_stream
      assert_response :success
    end
  end
end

================
File: test/controllers/columns/cards/drops/not_nows_controller_test.rb
================
require "test_helper"
class Columns::Cards::Drops::NotNowsControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
  end
  test "create" do
    card = cards(:logo)
    assert_changes -> { card.reload.postponed? }, from: false, to: true do
      post columns_card_drops_not_now_path(card), as: :turbo_stream
      assert_response :success
    end
  end
end

================
File: test/controllers/columns/cards/drops/streams_controller_test.rb
================
require "test_helper"
class Columns::Cards::Drops::StreamsControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
  end
  test "create" do
    card = cards(:text)
    assert_changes -> { card.reload.triaged? }, from: true, to: false do
      post columns_card_drops_stream_path(card), as: :turbo_stream
      assert_response :success
    end
  end
end

================
File: test/controllers/columns/left_positions_controller_test.rb
================
require "test_helper"
class Columns::LeftPositionsControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
  end
  test "move column left" do
    board = boards(:writebook)
    columns = board.columns.sorted.to_a
    column_a = columns[0]
    column_b = columns[1]
    original_position_a = column_a.position
    original_position_b = column_b.position
    post column_left_position_path(column_b), as: :turbo_stream
    assert_response :success
    assert_equal original_position_b, column_a.reload.position
    assert_equal original_position_a, column_b.reload.position
  end
  test "move left refreshes adjacent columns" do
    column = columns(:writebook_in_progress)
    post column_left_position_path(column), as: :turbo_stream
    column.reload.adjacent_columns.each do |adjacent_column|
      assert_turbo_stream action: :replace, target: dom_id(adjacent_column)
    end
  end
  test "users can only reorder columns in boards they have access to" do
    column = columns(:writebook_in_progress)
    post column_left_position_path(column), as: :turbo_stream
    assert_response :success
    boards(:writebook).update! all_access: false
    boards(:writebook).accesses.revoke_from users(:kevin)
    post column_left_position_path(column), as: :turbo_stream
    assert_response :not_found
  end
end

================
File: test/controllers/columns/right_positions_controller_test.rb
================
require "test_helper"
class Columns::RightPositionsControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
  end
  test "move column right" do
    board = boards(:writebook)
    columns = board.columns.sorted.to_a
    column_a = columns[0]
    column_b = columns[1]
    original_position_a = column_a.position
    original_position_b = column_b.position
    post column_right_position_path(column_a), as: :turbo_stream
    assert_response :success
    assert_equal original_position_b, column_a.reload.position
    assert_equal original_position_a, column_b.reload.position
  end
  test "move right refreshes adjacent columns" do
    column = columns(:writebook_in_progress)
    post column_right_position_path(column), as: :turbo_stream
    column.reload.adjacent_columns.each do |adjacent_column|
      assert_turbo_stream action: :replace, target: dom_id(adjacent_column)
    end
  end
  test "users can only reorder columns in boards they have access to" do
    column = columns(:writebook_triage)
    post column_right_position_path(column), as: :turbo_stream
    assert_response :success
    boards(:writebook).update! all_access: false
    boards(:writebook).accesses.revoke_from users(:kevin)
    post column_right_position_path(column), as: :turbo_stream
    assert_response :not_found
  end
end

================
File: test/controllers/concerns/block_search_engine_indexing_test.rb
================
require "test_helper"
class BlockSearchEngineIndexingTest < ActionDispatch::IntegrationTest
  test "sets X-Robots-Tag header to none on authenticated requests" do
    sign_in_as :david
    get board_path(boards(:writebook))
    assert_response :success
    assert_equal "none", response.headers["X-Robots-Tag"]
  end
  test "sets X-Robots-Tag header to none on unauthenticated requests" do
    untenanted do
      get new_session_path
    end
    assert_response :success
    assert_equal "none", response.headers["X-Robots-Tag"]
  end
  test "sets X-Robots-Tag header to none on public board pages" do
    boards(:writebook).publish
    get public_board_path(boards(:writebook).publication.key)
    assert_response :success
    assert_equal "none", response.headers["X-Robots-Tag"]
  end
end

================
File: test/controllers/concerns/current_timezone_test.rb
================
require "test_helper"
class CurrentTimezoneTest < ActionDispatch::IntegrationTest
  test "includes the timezone cookie in the ETag" do
    cookies[:timezone] = "America/New_York"
    get user_avatar_path(users(:kevin))
    etag = response.headers.fetch("ETag")
    get user_avatar_path(users(:kevin)), headers: { "If-None-Match" => etag }
    assert_equal 304, response.status
    cookies[:timezone] = "America/Los_Angeles"
    get user_avatar_path(users(:kevin)), headers: { "If-None-Match" => etag }
    assert_response :success
    assert_not_equal etag, response.headers.fetch("ETag")
  end
end

================
File: test/controllers/concerns/request_forgery_protection_test.rb
================
require "test_helper"
class RequestForgeryProtectionTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
    @original_allow_forgery_protection = ActionController::Base.allow_forgery_protection
    ActionController::Base.allow_forgery_protection = true
    @original_force_ssl = Rails.configuration.force_ssl
  end
  teardown do
    ActionController::Base.allow_forgery_protection = @original_allow_forgery_protection
    Rails.configuration.force_ssl = @original_force_ssl
  end
  test "JSON request succeeds with missing Sec-Fetch-Site header" do
    assert_difference -> { Board.count }, +1 do
      post boards_path,
        params: { board: { name: "Test Board" } },
        as: :json
    end
    assert_response :created
  end
  test "HTTP request succeeds with missing Sec-Fetch-Site header when force_ssl is disabled" do
    Rails.configuration.force_ssl = false
    assert_difference -> { Board.count }, +1 do
      post boards_path,
        params: { board: { name: "Test Board" } }
    end
    assert_response :redirect
  end
  test "HTTP request fails with missing Sec-Fetch-Site header when force_ssl is enabled" do
    Rails.configuration.force_ssl = true
    assert_no_difference -> { Board.count } do
      post boards_path,
        params: { board: { name: "Test Board" } }
    end
    assert_response :unprocessable_entity
  end
  test "HTTPS request fails with missing Sec-Fetch-Site header" do
    Rails.configuration.force_ssl = false
    assert_no_difference -> { Board.count } do
      post boards_path,
        params: { board: { name: "Test Board" } },
        headers: { "X-Forwarded-Proto" => "https" }
    end
    assert_response :unprocessable_entity
  end
end

================
File: test/controllers/events/day_timeline/columns_controller_test.rb
================
require "test_helper"
class Events::DayTimeline::ColumnsControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
  end
  test "show added column" do
    get events_day_timeline_column_path("added")
    assert_response :success
    assert_select "h1", text: /Added/
  end
  test "show updated column" do
    get events_day_timeline_column_path("updated")
    assert_response :success
    assert_select "h1", text: /Updated/
  end
  test "show closed column" do
    get events_day_timeline_column_path("closed")
    assert_response :success
    assert_select "h1", text: /Done/
  end
  test "show returns not found for invalid column" do
    get events_day_timeline_column_path("invalid")
    assert_response :not_found
  end
end

================
File: test/controllers/my/access_tokens_controller_test.rb
================
require "test_helper"
class My::AccessTokensControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
  end
  test "create new token" do
    get my_access_tokens_path
    assert_response :success
    get new_my_access_token_path
    assert_response :success
    assert_changes -> { identities(:kevin).access_tokens.count }, +1 do
      post my_access_tokens_path, params: { access_token: { description: "GitHub", permission: "read" } }
      follow_redirect!
      assert_in_body identities(:kevin).access_tokens.last.token
    end
  end
  test "accessing new token after reveal window redirects to index" do
    assert_changes -> { identities(:kevin).access_tokens.count }, +1 do
      post my_access_tokens_path, params: { access_token: { description: "GitHub", permission: "read" } }
      travel_to 15.seconds.from_now
      follow_redirect!
      assert_equal "Token is no longer visible", flash[:alert]
    end
  end
end

================
File: test/controllers/my/identities_controller_test.rb
================
require "test_helper"
class My::IdentitiesControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
  end
  test "show as JSON" do
    identity = identities(:kevin)
    untenanted do
      get my_identity_path, as: :json
      assert_response :success
      assert_equal identity.accounts.count, @response.parsed_body["accounts"].count
    end
  end
end

================
File: test/controllers/my/menus_controller_test.rb
================
require "test_helper"
class My::MenusControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
    @user = users(:kevin)
    @account = accounts("37s")
  end
  test "show" do
    get my_menu_path
    assert_response :success
  end
  test "etag invalidates when filters change" do
    get my_menu_path
    assert_response :success
    etag = response.headers["ETag"]
    @user.filters.create!(
      params_digest: Filter.digest_params({ indexed_by: :all, sorted_by: :newest }),
      fields: { indexed_by: :all, sorted_by: :newest }
    )
    get my_menu_path, headers: { "If-None-Match" => etag }
    assert_response :success
  end
  test "etag invalidates when boards change" do
    get my_menu_path
    assert_response :success
    etag = response.headers["ETag"]
    @account.boards.create!(name: "New Board", all_access: true, creator: @user)
    get my_menu_path, headers: { "If-None-Match" => etag }
    assert_response :success
  end
  test "etag invalidates when tags change" do
    get my_menu_path
    assert_response :success
    etag = response.headers["ETag"]
    @account.tags.create!(title: "new-tag")
    get my_menu_path, headers: { "If-None-Match" => etag }
    assert_response :success
  end
  test "etag invalidates when users change" do
    get my_menu_path
    assert_response :success
    etag = response.headers["ETag"]
    @user.touch
    get my_menu_path, headers: { "If-None-Match" => etag }
    assert_response :success
  end
  test "etag invalidates when account changes" do
    get my_menu_path
    assert_response :success
    etag = response.headers["ETag"]
    @account.update!(name: "Renamed Account")
    get my_menu_path, headers: { "If-None-Match" => etag }
    assert_response :success
  end
  test "etag returns not modified when nothing changes" do
    get my_menu_path
    assert_response :success
    etag = response.headers["ETag"]
    get my_menu_path, headers: { "If-None-Match" => etag }
    assert_response :not_modified
  end
  test "show excludes cancelled accounts" do
    # Create another account for the same identity
    another_account = Account.create!(external_account_id: 9999996, name: "Cancelled Account")
    another_user = @user.identity.users.create!(account: another_account, name: "Kevin", role: "owner")
    # Cancel the other account
    another_account.cancel(initiated_by: another_user)
    get my_menu_path
    assert_response :success
    # The response should include active account but not cancelled one
    assert_select "a[href*='#{@account.slug}']"
    assert_select "a[href*='#{another_account.slug}']", count: 0
  end
end

================
File: test/controllers/my/pins_controller_test.rb
================
require "test_helper"
class My::PinsControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
  end
  test "index" do
    get my_pins_path
    assert_response :success
    assert_select "div", text: /#{users(:kevin).pins.first.card.title}/
  end
  test "index as JSON" do
    expected_ids = users(:kevin).pins.ordered.pluck(:card_id)
    get my_pins_path(format: :json)
    assert_response :success
    assert_equal expected_ids.count, @response.parsed_body.count
    assert_equal expected_ids, @response.parsed_body.map { |card| card["id"] }
  end
end

================
File: test/controllers/my/timezones_controller_test.rb
================
require "test_helper"
class My::TimezonesControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
  end
  test "update" do
    time_zone = ActiveSupport::TimeZone["America/New_York"]
    assert_not_equal time_zone, users(:kevin).timezone
    patch my_timezone_path, params: { timezone_name: "America/New_York" }
    assert_equal time_zone, users(:kevin).reload.timezone
  end
end

================
File: test/controllers/notifications/bulk_readings_controller_test.rb
================
require "test_helper"
class Notifications::BulkReadingsControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
  end
  test "create marks all notifications as read" do
    assert_changes -> { notifications(:logo_published_kevin).reload.read? }, from: false, to: true do
      assert_changes -> { notifications(:layout_commented_kevin).reload.read? }, from: false, to: true do
        post bulk_reading_path
      end
    end
  end
  test "create redirects to notifications path when not from tray" do
    post bulk_reading_path
    assert_redirected_to notifications_path
  end
  test "create returns ok when from tray" do
    post bulk_reading_path, params: { from_tray: true }
    assert_response :ok
  end
  test "create as JSON" do
    assert_changes -> { notifications(:logo_published_kevin).reload.read? }, from: false, to: true do
      assert_changes -> { notifications(:layout_commented_kevin).reload.read? }, from: false, to: true do
        post bulk_reading_path, as: :json
      end
    end
    assert_response :no_content
  end
end

================
File: test/controllers/notifications/readings_controller_test.rb
================
require "test_helper"
class Notifications::ReadingsControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
  end
  test "create" do
    assert_changes -> { notifications(:logo_published_kevin).reload.read? }, from: false, to: true do
      post notification_reading_path(notifications(:logo_published_kevin), format: :turbo_stream)
      assert_response :success
    end
  end
  test "destroy" do
    notification = notifications(:logo_published_kevin)
    notification.read # Mark as read first
    assert_changes -> { notification.reload.read? }, from: true, to: false do
      delete notification_reading_path(notification, format: :turbo_stream)
      assert_response :success
    end
  end
  test "create as JSON" do
    assert_changes -> { notifications(:logo_published_kevin).reload.read? }, from: false, to: true do
      post notification_reading_path(notifications(:logo_published_kevin)), as: :json
      assert_response :no_content
    end
  end
  test "destroy as JSON" do
    notification = notifications(:logo_published_kevin)
    notification.read
    assert_changes -> { notification.reload.read? }, from: true, to: false do
      delete notification_reading_path(notification), as: :json
      assert_response :no_content
    end
  end
end

================
File: test/controllers/notifications/settings_controller_test.rb
================
require "test_helper"
class Notifications::SettingsControllerTest < ActionDispatch::IntegrationTest
  setup do
    @user = users(:david)
    sign_in_as @user
  end
  test "show" do
    get notifications_settings_path
    assert_response :success
  end
  test "update email frequency" do
    assert_changes -> { @user.reload.settings.bundle_email_frequency }, from: "never", to: "every_few_hours" do
      put notifications_settings_path, params: { user_settings: { bundle_email_frequency: "every_few_hours" } }
    end
    assert_redirected_to notifications_settings_path
    assert_equal "Settings updated", flash[:notice]
  end
end

================
File: test/controllers/notifications/trays_controller_test.rb
================
require "test_helper"
class Notifications::TraysControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
  end
  test "show" do
    get tray_notifications_path
    assert_response :success
    assert_select "div", text: /Layout is broken/
  end
end

================
File: test/controllers/notifications/unsubscribes_controller_test.rb
================
require "test_helper"
class Notifications::UnsubscribesControllerTest < ActionDispatch::IntegrationTest
  setup do
    @user = users(:david)
    @access_token = @user.generate_token_for(:unsubscribe)
    sign_in_as @user
  end
  test "new" do
    get new_notifications_unsubscribe_path(access_token: @access_token)
    assert_response :success
  end
  test "new with bad token" do
    get new_notifications_unsubscribe_path(access_token: "bad")
    assert_redirected_to root_path
  end
  test "create" do
    @user.reload.settings.bundle_email_every_few_hours!
    assert_changes -> { @user.reload.settings.bundle_email_frequency }, to: "never" do
      post notifications_unsubscribe_path(access_token: @access_token)
      assert_redirected_to notifications_unsubscribe_path(access_token: @access_token)
    end
  end
  test "create with bad token" do
    assert_no_changes -> { @user.reload.settings.bundle_email_frequency } do
      post notifications_unsubscribe_path(access_token: "bad")
      assert_redirected_to root_path
    end
  end
  test "show" do
    get notifications_unsubscribe_path(access_token: @access_token)
    assert_response :success
  end
end

================
File: test/controllers/prompts/boards/users_controller_test.rb
================
require "test_helper"
class Prompts::Boards::UsersControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
    @board = boards(:writebook)
  end
  test "index" do
    get prompts_board_users_path(@board)
    assert_response :success
    assert_select "lexxy-prompt-item", count: 3
  end
  test "index excludes inactive users" do
    get prompts_board_users_path(@board)
    assert_response :success
    assert_select "lexxy-prompt-item[search*='David']", count: 1
    users(:david).update!(active: false)
    get prompts_board_users_path(@board)
    assert_response :success
    assert_select "lexxy-prompt-item[search*='David']", count: 0
  end
end

================
File: test/controllers/prompts/cards_controller_test.rb
================
require "test_helper"
class Prompts::CardsControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
  end
  test "index" do
    get prompts_cards_path
    assert_response :success
  end
end

================
File: test/controllers/prompts/tags_controller_test.rb
================
require "test_helper"
class Prompts::TagsControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
  end
  test "index" do
    get prompts_tags_path
    assert_response :success
  end
end

================
File: test/controllers/prompts/users_controller_test.rb
================
require "test_helper"
class Prompts::UsersControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
  end
  test "index" do
    get prompts_users_path
    assert_response :success
  end
end

================
File: test/controllers/public/boards/columns/closeds_controller_test.rb
================
require "test_helper"
class Public::Boards::Columns::ClosedsControllerTest < ActionDispatch::IntegrationTest
  setup do
    boards(:writebook).publish
  end
  test "show" do
    get public_board_columns_closed_path(boards(:writebook).publication.key)
    assert_response :success
  end
end

================
File: test/controllers/public/boards/columns/not_nows_controller_test.rb
================
require "test_helper"
class Public::Boards::Columns::NotNowsControllerTest < ActionDispatch::IntegrationTest
  setup do
    boards(:writebook).publish
  end
  test "show" do
    get public_board_columns_not_now_path(boards(:writebook).publication.key)
    assert_response :success
  end
end

================
File: test/controllers/public/boards/columns/streams_controller_test.rb
================
require "test_helper"
class Public::Boards::Columns::StreamsControllerTest < ActionDispatch::IntegrationTest
  setup do
    boards(:writebook).publish
  end
  test "show" do
    get public_board_columns_stream_path(boards(:writebook).publication.key)
    assert_response :success
  end
end

================
File: test/controllers/public/boards/columns_controller_test.rb
================
require "test_helper"
class Public::Boards::ColumnsControllerTest < ActionDispatch::IntegrationTest
  setup do
    boards(:writebook).publish
  end
  test "show" do
    column = columns(:writebook_in_progress)
    get public_board_column_path(boards(:writebook).publication.key, column)
    assert_response :success
  end
end

================
File: test/controllers/public/boards_controller_test.rb
================
require "test_helper"
class Public::BoardsControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
    boards(:writebook).publish
  end
  test "show" do
    get published_board_path(boards(:writebook))
    assert_response :success
  end
  test "not found if the board is not published" do
    key = boards(:writebook).publication.key
    boards(:writebook).unpublish
    get public_board_path(key)
    assert_response :not_found
  end
  test "show works without authentication" do
    sign_out
    get published_board_path(boards(:writebook))
    assert_response :success
  end
end

================
File: test/controllers/public/cards_controller_test.rb
================
require "test_helper"
class Public::CardsControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
    @board = boards(:writebook)
    @card = cards(:logo)
    @board.publish
  end
  test "show" do
    get public_board_card_path(@board.publication.key, @card)
    assert_response :success
  end
  test "not found if the board is not published" do
    @board.unpublish
    get public_board_card_path(@board.publication.key, @card)
    assert_response :not_found
  end
  test "not found if the card is drafted" do
    @card.update!(status: :drafted)
    get public_board_card_path(@board.publication.key, @card)
    assert_response :not_found
  end
end

================
File: test/controllers/searches/queries_controller_test.rb
================
require "test_helper"
class Searches::QueriesControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
  end
  test "create" do
    assert_difference -> { users(:kevin).search_queries.count }, +1 do
      post searches_queries_path, params: { q: "layout issues" }
    end
    assert_equal "layout issues", users(:kevin).search_queries.last.terms
    assert_response :success
  end
end

================
File: test/controllers/sessions/magic_links_controller_test.rb
================
require "test_helper"
class Sessions::MagicLinksControllerTest < ActionDispatch::IntegrationTest
  test "show" do
    untenanted do
      get session_magic_link_url
      assert_response :redirect, "Without an email address pending authentication, should redirect"
      assert_redirected_to new_session_path
    end
    untenanted do
      post session_path, params: { email_address: "test@example.com" }
      get session_magic_link_url
      assert_response :success
    end
  end
  test "create with sign in code" do
    identity = identities(:kevin)
    magic_link = MagicLink.create!(identity: identity)
    untenanted do
      post session_path, params: { email_address: identity.email_address }
      post session_magic_link_url, params: { code: magic_link.code }
      assert_response :redirect
      assert cookies[:session_token].present?
      assert_redirected_to landing_path, "Should redirect to after authentication path"
      assert_not MagicLink.exists?(magic_link.id), "The magic link should be consumed"
    end
  end
  test "create with sign up code" do
    identity = identities(:kevin)
    magic_link = MagicLink.create!(identity: identity, purpose: :sign_up)
    untenanted do
      post session_path, params: { email_address: identity.email_address }
      post session_magic_link_url, params: { code: magic_link.code }
      assert_response :redirect
      assert cookies[:session_token].present?
      assert_redirected_to new_signup_completion_path, "Should redirect to signup completion"
      assert_not MagicLink.exists?(magic_link.id), "The magic link should be consumed"
    end
  end
  test "create with cross-user code" do
    identity = identities(:kevin)
    other_identity = identities(:jason)
    magic_link = MagicLink.create!(identity: other_identity)
    untenanted do
      post session_path, params: { email_address: identity.email_address }
      post session_magic_link_url, params: { code: magic_link.code }
      assert_redirected_to new_session_path
      assert_not cookies[:session_token].present?
    end
  end
  test "create with invalid code" do
    identity = identities(:kevin)
    magic_link = MagicLink.create!(identity: identity)
    untenanted do
      post session_magic_link_url, params: { code: "INVALID" }
    end
    assert_response :redirect, "Invalid code should redirect"
    expired_link = MagicLink.create!(identity: identity)
    expired_link.update_column(:expires_at, 1.hour.ago)
    post session_magic_link_url, params: { code: expired_link.code }
    assert_response :redirect, "Expired magic link should redirect"
    assert MagicLink.exists?(expired_link.id), "Expired magic link should not be consumed"
  end
  test "create via JSON for sign in" do
    identity = identities(:david)
    magic_link = identity.send_magic_link
    untenanted do
      post session_path(format: :json), params: { email_address: identity.email_address }
      post session_magic_link_path(format: :json), params: { code: magic_link.code }
      assert_response :success
      assert @response.parsed_body["session_token"].present?
      assert_equal false, @response.parsed_body["requires_signup_completion"]
    end
  end
  test "create via JSON for sign up" do
    identity = identities(:david)
    magic_link = identity.send_magic_link(for: :sign_up)
    untenanted do
      post session_path(format: :json), params: { email_address: identity.email_address }
      post session_magic_link_path(format: :json), params: { code: magic_link.code }
      assert_response :success
      assert @response.parsed_body["session_token"].present?
      assert_equal true, @response.parsed_body["requires_signup_completion"]
    end
  end
  test "create via JSON without pending_authentication_token" do
    identity = identities(:david)
    magic_link = identity.send_magic_link
    untenanted do
      post session_magic_link_path(format: :json), params: { code: magic_link.code }
      assert_response :unauthorized
      assert_equal "Enter your email address to sign in.", @response.parsed_body["message"]
    end
  end
  test "create via JSON with invalid code" do
    identity = identities(:david)
    untenanted do
      post session_path(format: :json), params: { email_address: identity.email_address }
      post session_magic_link_path(format: :json), params: { code: "INVALID" }
      assert_response :unauthorized
      assert_equal "Try another code.", @response.parsed_body["message"]
    end
  end
  test "create via JSON with cross-user code" do
    identity = identities(:david)
    other_identity = identities(:jason)
    magic_link = other_identity.send_magic_link
    untenanted do
      post session_path(format: :json), params: { email_address: identity.email_address }
      post session_magic_link_path(format: :json), params: { code: magic_link.code }
      assert_response :unauthorized
      assert_equal "Something went wrong. Please try again.", @response.parsed_body["message"]
    end
  end
  test "create via JSON with expired pending_authentication_token" do
    identity = identities(:david)
    magic_link = identity.send_magic_link
    untenanted do
      travel_to 20.minutes.ago do
        post session_path(format: :json), params: { email_address: identity.email_address }
      end
      post session_magic_link_path(format: :json), params: { code: magic_link.code }
      assert_response :unauthorized
      assert_equal "Enter your email address to sign in.", @response.parsed_body["message"]
    end
  end
end

================
File: test/controllers/sessions/menus_controller_test.rb
================
require "test_helper"
class Sessions::MenusControllerTest < ActionDispatch::IntegrationTest
  setup do
    @identity = identities(:kevin)
  end
  test "show with no account" do
    sign_in_as @identity
    @identity.users.delete_all
    untenanted do
      get session_menu_url
    end
    assert_response :success, "Renders an empty menu"
  end
  test "show with exactly one account" do
    sign_in_as @identity
    Current.without_account do
      @identity.users.delete_all
      account = Account.create!(external_account_id: 9999991, name: "Test Account")
      @identity.users.create!(account: account, name: "Kevin")
    end
    untenanted do
      get session_menu_url
    end
    assert_response :redirect
    assert_redirected_to root_url(script_name: "/9999991")
  end
  test "show with multiple accounts" do
    sign_in_as @identity
    @identity.users.delete_all
    account1 = Account.create!(external_account_id: 9999992, name: "37signals")
    account2 = Account.create!(external_account_id: 9999993, name: "Acme")
    @identity.users.create!(account: account1, name: "Kevin")
    @identity.users.create!(account: account2, name: "Kevin")
    untenanted do
      get session_menu_url
    end
    assert_response :success
  end
  test "show excludes cancelled accounts" do
    sign_in_as @identity
    @identity.users.delete_all
    account1 = Account.create!(external_account_id: 9999994, name: "Active Account")
    account2 = Account.create!(external_account_id: 9999995, name: "Cancelled Account")
    user1 = @identity.users.create!(account: account1, name: "Kevin", role: "owner")
    user2 = @identity.users.create!(account: account2, name: "Kevin", role: "owner")
    # Cancel one account
    account2.cancel(initiated_by: user2)
    untenanted do
      get session_menu_url
    end
    # Should redirect to the only active account
    assert_response :redirect
    assert_redirected_to root_url(script_name: account1.slug)
  end
end

================
File: test/controllers/sessions/transfers_controller_test.rb
================
require "test_helper"
class Sessions::TransfersControllerTest < ActionDispatch::IntegrationTest
  test "show renders when not signed in" do
    untenanted do
      get session_transfer_path("some-token")
      assert_response :success
    end
  end
  test "update establishes a session when the code is valid" do
    identity = identities(:david)
    untenanted do
      put session_transfer_path(identity.transfer_id)
      assert_redirected_to session_menu_url(script_name: nil)
      assert parsed_cookies.signed[:session_token]
    end
  end
end

================
File: test/controllers/signup/completions_controller_test.rb
================
require "test_helper"
class Signup::CompletionsControllerTest < ActionDispatch::IntegrationTest
  setup do
    @signup = Signup.new(email_address: "newuser@example.com", full_name: "New User")
    @signup.create_identity || raise("Failed to create identity")
    sign_in_as @signup.identity
  end
  test "new" do
    untenanted do
      get new_signup_completion_path
    end
    assert_response :success
  end
  test "create" do
    untenanted do
      post signup_completion_path, params: {
        signup: {
          full_name: @signup.full_name
        }
      }
    end
    assert_response :redirect, "Valid params should redirect"
  end
  test "shows welcome letter after signup" do
    untenanted do
      post signup_completion_path, params: {
        signup: {
          full_name: @signup.full_name
        }
      }
    end
    assert flash[:welcome_letter]
  end
  test "create with blank name" do
    untenanted do
      post signup_completion_path, params: {
        signup: {
          full_name: ""
        }
      }
    end
    assert_response :unprocessable_entity
    assert_select ".txt-negative" do
      assert_select "li", text: "Full name can't be blank"
    end
  end
  test "create via JSON" do
    untenanted do
      assert_difference -> { Account.count }, +1 do
        post signup_completion_path(format: :json), params: {
          signup: {
            full_name: @signup.full_name
          }
        }
      end
    end
    assert_response :created
    assert_equal Account.last.id, @response.parsed_body["account_id"]
  end
  test "create via JSON with blank name" do
    untenanted do
      assert_no_difference -> { Account.count } do
        post signup_completion_path(format: :json), params: {
          signup: {
            full_name: ""
          }
        }
      end
    end
    assert_response :unprocessable_entity
    assert_includes @response.parsed_body["errors"], "Full name can't be blank"
  end
end

================
File: test/controllers/users/email_addresses/confirmations_controller_test.rb
================
require "test_helper"
class Users::EmailAddresses::ConfirmationsControllerTest < ActionDispatch::IntegrationTest
  setup do
    @user = users(:david)
    @old_email = @user.identity.email_address
    @new_email = "newemail@example.com"
    @token = @user.send(:generate_email_address_change_token, to: @new_email)
  end
  test "show" do
    get user_email_address_confirmation_path(user_id: @user.id, email_address_token: @token, script_name: @user.account.slug)
    assert_response :success
  end
  test "create" do
    post user_email_address_confirmation_path(user_id: @user.id, email_address_token: @token, script_name: @user.account.slug)
    assert_equal @new_email, @user.reload.identity.email_address
    assert_redirected_to edit_user_url(script_name: @user.account.slug, id: @user)
  end
  test "create with invalid token" do
    post user_email_address_confirmation_path(user_id: @user.id, email_address_token: "invalid", script_name: @user.account.slug)
    assert_equal @user.identity.email_address, @old_email
    assert_response :unprocessable_entity
    assert_match /Link expired/, response.body
  end
end

================
File: test/controllers/users/avatars_controller_test.rb
================
require "test_helper"
class Users::AvatarsControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :david
  end
  test "show system user" do
    get user_avatar_path(users(:system))
    assert_response :redirect
    assert_redirected_to ActionController::Base.helpers.image_path("system_user.png")
  end
  test "show own initials without caching" do
    get user_avatar_path(users(:david))
    assert_match "image/svg+xml", @response.content_type
    assert @response.cache_control[:private]
    assert_equal "0", @response.cache_control[:max_age]
  end
  test "show other initials with caching" do
    get user_avatar_path(users(:kevin))
    assert_match "image/svg+xml", @response.content_type
    assert @response.cache_control[:private]
    assert_equal 30.minutes.to_s, @response.cache_control[:max_age]
  end
  test "show own image redirects to the blob url" do
    users(:david).avatar.attach(io: File.open(file_fixture("moon.jpg")), filename: "moon.jpg", content_type: "image/jpeg")
    assert users(:david).avatar.attached?
    get user_avatar_path(users(:david))
    assert_redirected_to rails_blob_url(users(:david).avatar_thumbnail, disposition: "inline")
  end
  test "show other image redirects to the blob url" do
    users(:kevin).avatar.attach(io: File.open(file_fixture("moon.jpg")), filename: "moon.jpg", content_type: "image/jpeg")
    assert users(:kevin).avatar.attached?
    get user_avatar_path(users(:kevin))
    assert_redirected_to rails_blob_url(users(:kevin).avatar_thumbnail, disposition: "inline")
  end
  test "delete self" do
    delete user_avatar_path(users(:david))
    assert_redirected_to users(:david)
  end
  test "unable to delete other" do
    delete user_avatar_path(users(:kevin))
    assert_response :forbidden
  end
end

================
File: test/controllers/users/data_exports_controller_test.rb
================
require "test_helper"
class Users::DataExportsControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :david
    @user = users(:david)
  end
  test "create creates an export record and enqueues job" do
    assert_difference -> { User::DataExport.count }, 1 do
      assert_enqueued_with(job: DataExportJob) do
        post user_data_exports_path(@user)
      end
    end
    assert_redirected_to @user
    assert_equal "Export started. You'll receive an email when it's ready.", flash[:notice]
  end
  test "create associates export with user and account" do
    post user_data_exports_path(@user)
    export = User::DataExport.last
    assert_equal @user, export.user
    assert_equal Current.account, export.account
    assert export.pending?
  end
  test "create rejects request when current export limit is reached" do
    Users::DataExportsController::CURRENT_EXPORT_LIMIT.times do
      @user.data_exports.create!(account: Current.account)
    end
    assert_no_difference -> { User::DataExport.count } do
      post user_data_exports_path(@user)
    end
    assert_response :too_many_requests
  end
  test "create allows request when exports are older than one day" do
    Users::DataExportsController::CURRENT_EXPORT_LIMIT.times do
      @user.data_exports.create!(account: Current.account, created_at: 2.days.ago)
    end
    assert_difference -> { User::DataExport.count }, 1 do
      post user_data_exports_path(@user)
    end
    assert_redirected_to @user
  end
  test "show displays completed export with download link" do
    export = @user.data_exports.create!(account: Current.account)
    export.build
    get user_data_export_path(@user, export)
    assert_response :success
    assert_select "a#download-link"
  end
  test "show displays a warning if the export is missing" do
    get user_data_export_path(@user, "not-really-an-export")
    assert_response :success
    assert_select "h2", "Download Expired"
  end
  test "create is forbidden for other users" do
    other_user = users(:kevin)
    post user_data_exports_path(other_user)
    assert_response :forbidden
  end
  test "show is forbidden for other users" do
    other_user = users(:kevin)
    export = other_user.data_exports.create!(account: Current.account)
    export.build
    get user_data_export_path(other_user, export)
    assert_response :forbidden
  end
end

================
File: test/controllers/users/email_addresses_controller_test.rb
================
require "test_helper"
class Users::EmailAddressesControllerTest < ActionDispatch::IntegrationTest
  include ActionMailer::TestHelper
  setup do
    sign_in_as :david
    @user = users(:david)
  end
  test "new" do
    get new_user_email_address_path(@user, script_name: @user.account.slug)
    assert_response :success
  end
  test "create" do
    assert_emails 1 do
      post user_email_addresses_path(@user, script_name: @user.account.slug), params: { email_address: "newemail@example.com" }
    end
    assert_response :success
  end
  test "create with existing email in same account" do
    existing_user = users(:kevin)
    existing_email = existing_user.identity.email_address
    post user_email_addresses_path(@user, script_name: @user.account.slug), params: { email_address: existing_email }
    assert_redirected_to new_user_email_address_path(@user)
    assert_equal "You already have a user in this account with that email address", flash[:alert]
  end
  test "create for other user" do
    other_user = users(:kevin)
    assert_no_emails do
      post user_email_addresses_path(other_user, script_name: @user.account.slug), params: { email_address: "newemail@example.com" }
    end
    assert_response :not_found
  end
end

================
File: test/controllers/users/events_controller_test.rb
================
require "test_helper"
class Users::EventsControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
  end
  test "show self" do
    get user_events_path(users(:kevin))
    assert_in_body "What have you been up to?"
  end
  test "show other" do
    get user_events_path(users(:david))
    assert_in_body "What has David been up to?"
  end
end

================
File: test/controllers/users/joins_controller_test.rb
================
require "test_helper"
class Users::JoinsControllerTest < ActionDispatch::IntegrationTest
  test "new" do
    sign_in_as :david
    get new_users_join_path
    assert_response :ok
  end
  test "create" do
    user = users(:david)
    sign_in_as user
    assert_no_difference -> { User.count } do
      post users_joins_path, params: { user: { name: "David Updated" } }
      assert_redirected_to landing_path
    end
    assert_equal "David Updated", user.reload.name
  end
end

================
File: test/controllers/users/push_subscriptions_controller_test.rb
================
require "test_helper"
class Users::PushSubscriptionsControllerTest < ActionDispatch::IntegrationTest
  PUBLIC_TEST_IP = "142.250.185.206"
  setup do
    sign_in_as :david
    stub_dns_resolution(PUBLIC_TEST_IP)
  end
  test "create new push subscription" do
    subscription_params = { "endpoint" => "https://fcm.googleapis.com/fcm/send/abc123", "p256dh_key" => "123", "auth_key" => "456" }
    post user_push_subscriptions_path(users(:david)),
      params: { push_subscription: subscription_params }, headers: { "HTTP_USER_AGENT" => "Mozilla/5.0" }
    assert_response :no_content
    assert_equal subscription_params, users(:david).push_subscriptions.last.attributes.slice("endpoint", "p256dh_key", "auth_key")
    assert_equal "Mozilla/5.0", users(:david).push_subscriptions.last.user_agent
  end
  test "destroy a push subscription" do
    subscription = users(:david).push_subscriptions.create!(
      endpoint: "https://fcm.googleapis.com/fcm/send/abc123",
      p256dh_key: "123",
      auth_key: "456"
    )
    assert_difference -> { Push::Subscription.count }, -1 do
      delete user_push_subscription_path(users(:david), subscription)
      assert_redirected_to user_push_subscriptions_path(users(:david))
    end
  end
  test "rejects subscription with non-permitted endpoint" do
    subscription_params = { "endpoint" => "https://attacker.example.com/steal", "p256dh_key" => "123", "auth_key" => "456" }
    assert_no_difference -> { Push::Subscription.count } do
      post user_push_subscriptions_path(users(:david)),
        params: { push_subscription: subscription_params }
    end
    assert_response :unprocessable_entity
  end
  test "rejects subscription with endpoint resolving to private IP" do
    stub_dns_resolution("192.168.1.1")
    subscription_params = { "endpoint" => "https://fcm.googleapis.com/fcm/send/abc123", "p256dh_key" => "123", "auth_key" => "456" }
    assert_no_difference -> { Push::Subscription.count } do
      post user_push_subscriptions_path(users(:david)),
        params: { push_subscription: subscription_params }
    end
    assert_response :unprocessable_entity
  end
  private
    def stub_dns_resolution(*ips)
      dns_mock = mock("dns")
      dns_mock.stubs(:each_address).multiple_yields(*ips)
      Resolv::DNS.stubs(:open).yields(dns_mock)
    end
end

================
File: test/controllers/users/roles_controller_test.rb
================
require "test_helper"
class Users::RolesControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
  end
  test "update" do
    assert_not users(:david).admin?
    put user_role_path(users(:david)), params: { user: { role: "admin" } }
    assert_redirected_to account_settings_path
    assert users(:david).reload.admin?
  end
  test "can't promote to special roles" do
    assert_no_changes -> { users(:david).reload.role } do
      put user_role_path(users(:david)), params: { user: { role: "system" } }
    end
    assert_no_changes -> { users(:david).reload.role } do
      put user_role_path(users(:david)), params: { user: { role: "owner" } }
    end
  end
  test "admin cannot demote the owner" do
    assert users(:jason).owner?
    assert_no_changes -> { users(:jason).reload.role } do
      put user_role_path(users(:jason)), params: { user: { role: "admin" } }
    end
    assert_response :forbidden
  end
  test "admin cannot change owner role to member" do
    assert users(:jason).owner?
    assert_no_changes -> { users(:jason).reload.role } do
      put user_role_path(users(:jason)), params: { user: { role: "member" } }
    end
    assert_response :forbidden
  end
end

================
File: test/controllers/users/verifications_controller_test.rb
================
require "test_helper"
class Users::VerificationsControllerTest < ActionDispatch::IntegrationTest
  test "new renders the auto-submit form" do
    sign_in_as :david
    get new_users_verification_path
    assert_response :ok
  end
  test "create verifies the user and redirects to join" do
    sign_in_as :david
    user = users(:david)
    user.update_column(:verified_at, nil)
    assert_not user.verified?
    post users_verifications_path
    assert_redirected_to new_users_join_path
    assert user.reload.verified?
  end
end

================
File: test/controllers/webhooks/activations_controller_test.rb
================
require "test_helper"
class Webhooks::ActivationsControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
  end
  test "create" do
    webhook = webhooks(:inactive)
    assert_not webhook.active?
    assert_changes -> { webhook.reload.active? }, from: false, to: true do
      post board_webhook_activation_path(webhook.board, webhook)
    end
    assert_redirected_to board_webhook_path(webhook.board, webhook)
  end
  test "cannot activate webhook on board without access" do
    logout_and_sign_in_as :jason
    webhook = webhooks(:inactive)  # on private board, jason has no access
    post board_webhook_activation_path(webhook.board, webhook)
    assert_response :not_found
  end
  test "non-admin cannot activate webhook" do
    logout_and_sign_in_as :jz  # member with writebook access, but not admin
    webhook = webhooks(:active)  # on writebook board
    post board_webhook_activation_path(webhook.board, webhook)
    assert_response :forbidden
  end
end

================
File: test/controllers/allow_browser_test.rb
================
require "test_helper"
class AllowBrowserTest < ActionDispatch::IntegrationTest
  test "Baidu browser is allowed" do
    sign_in_as :kevin
    get cards_path, headers: {
      "User-Agent" => "Mozilla/5.0 (Linux; Android 7.0; HUAWEI NXT-AL10 Build/HUAWEINXT-AL10; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/48.0.2564.116 Mobile Safari/537.36 baidubrowser/7.9.12.0 (Baidu; P1 7.0)NULL"
    }
    assert_response :success
  end
  test "nonsense user agent with bot in name is allowed" do
    sign_in_as :kevin
    get cards_path, headers: {
      "User-Agent" => "TotallyFakeBot/1.0 (NonsenseBrowser; Testing)"
    }
    assert_response :success
  end
  test "nonsense user agent is allowed" do
    sign_in_as :kevin
    get cards_path, headers: {
      "User-Agent" => "just some random nonsense text"
    }
    assert_response :success
  end
  test "old Chrome browser is rejected with 406" do
    sign_in_as :kevin
    # Chrome 118 is below the modern threshold of Chrome 120
    get cards_path, headers: {
      "User-Agent" => "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/118 Safari/537.36"
    }
    assert_response :not_acceptable
  end
  test "Google Image Proxy is allowed" do
    sign_in_as :kevin
    get cards_path, headers: {
      "User-Agent" => "Mozilla/5.0 (Windows NT 5.1; rv:11.0) Gecko Firefox/11.0 (via ggpht.com GoogleImageProxy)"
    }
    assert_response :success
  end
  test "Facebook/Twitter bot is allowed" do
    sign_in_as :kevin
    get cards_path, headers: {
      "User-Agent" => "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_1) AppleWebKit/601.2.4 (KHTML, like Gecko) Version/9.0.1 Safari/601.2.4 facebookexternalhit/1.1 Facebot Twitterbot/1.0"
    }
    assert_response :success
  end
end

================
File: test/controllers/api_test.rb
================
require "test_helper"
class ApiTest < ActionDispatch::IntegrationTest
  setup do
    @davids_bearer_token = bearer_token_env(identity_access_tokens(:davids_api_token).token)
    @jasons_bearer_token = bearer_token_env(identity_access_tokens(:jasons_api_token).token)
  end
  test "authenticate with user credentials" do
    identity = identities(:david)
    untenanted do
      post session_path(format: :json), params: { email_address: identity.email_address }
      assert_response :created
      pending_token = @response.parsed_body["pending_authentication_token"]
      assert pending_token.present?
      magic_link = MagicLink.last
      post session_magic_link_path(format: :json), params: { code: magic_link.code, pending_authentication_token: pending_token }
      assert_response :success
      assert @response.parsed_body["session_token"].present?
    end
  end
  test "logout with user credentials" do
    identity = identities(:david)
    untenanted do
      post session_path(format: :json), params: { email_address: identity.email_address }
      magic_link = MagicLink.last
      assert_difference -> { identity.sessions.count }, +1 do
        post session_magic_link_path(format: :json), params: { code: magic_link.code, pending_authentication_token: @response.parsed_body["pending_authentication_token"] }
      end
      assert cookies[:session_token].present?
      assert_difference -> { identity.sessions.count }, -1 do
        delete session_path(format: :json)
      end
      assert_response :no_content
      assert_not cookies[:session_token].present?
    end
  end
  test "authenticate with valid access token" do
    get boards_path(format: :json), env: @davids_bearer_token
    assert_response :success
  end
  test "fail to authenticate with invalid access token" do
    get boards_path(format: :json), env: bearer_token_env("nonsense")
    assert_response :unauthorized
  end
  test "changing data requires a write-endowed access token" do
    post boards_path(format: :json), params: { board: { name: "My new board" } }, env: @jasons_bearer_token
    assert_response :unauthorized
    post boards_path(format: :json), params: { board: { name: "My new board" } }, env: @davids_bearer_token
    assert_response :success
  end
  private
    def bearer_token_env(token)
      { "HTTP_AUTHORIZATION" => "Bearer #{token}" }
    end
end

================
File: test/controllers/boards_controller_test.rb
================
require "test_helper"
class BoardsControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
  end
  test "new" do
    get new_board_path
    assert_response :success
  end
  test "show" do
    get board_path(boards(:writebook))
    assert_response :success
  end
  test "invalidates page title cache when account updates" do
    get board_path(boards(:writebook))
    etag = response.headers["ETag"]
    accounts("37s").update!(name: "Renamed Account")
    get board_path(boards(:writebook)), headers: { "If-None-Match" => etag }
    assert_response :success
  end
  test "create" do
    assert_difference -> { Board.count }, +1 do
      post boards_path, params: { board: { name: "Remodel Punch List" } }
    end
    board = Board.last
    assert_redirected_to board_path(board)
    assert_includes board.users, users(:kevin)
    assert_equal "Remodel Punch List", board.name
  end
  test "edit" do
    get edit_board_path(boards(:writebook))
    assert_response :success
  end
  test "update" do
    patch board_path(boards(:writebook)), params: {
      board: {
        name: "Writebook bugs",
        all_access: false,
        auto_postpone_period: 1.day
      },
      user_ids: users(:kevin, :jz).pluck(:id)
    }
    assert_redirected_to edit_board_path(boards(:writebook))
    assert_equal "Writebook bugs", boards(:writebook).reload.name
    assert_equal users(:kevin, :jz).sort, boards(:writebook).users.sort
    assert_equal 1.day, entropies(:writebook_board).auto_postpone_period
    assert_not boards(:writebook).all_access?
  end
  test "update redirects to root when user removes themselves from board" do
    board = boards(:writebook)
    patch board_path(board), params: {
      board: { name: "Updated name", all_access: false },
      user_ids: users(:david, :jz).pluck(:id)
    }
    assert_redirected_to root_path
    assert_not board.reload.users.include?(users(:kevin))
  end
  test "update board with granular permissions, submitting no user ids" do
    assert_not boards(:private).all_access?
    boards(:private).users = [ users(:kevin) ]
    boards(:private).save!
    patch board_path(boards(:private)), params: {
      board: { name: "Renamed" }
    }
    assert_redirected_to edit_board_path(boards(:private))
    assert_equal "Renamed", boards(:private).reload.name
    assert_equal [ users(:kevin) ], boards(:private).users
    assert_not boards(:private).all_access?
  end
  test "update all access" do
    board = Current.set(account: accounts("37s"), session: sessions(:kevin), user: users(:kevin)) do
      Board.create! name: "New board", all_access: false
    end
    assert_equal [ users(:kevin) ], board.users
    patch board_path(board), params: { board: { name: "Bugs", all_access: true } }
    assert_redirected_to edit_board_path(board)
    assert board.reload.all_access?
    assert_equal accounts("37s").users.active.sort, board.users.sort
  end
  test "destroy" do
    board = boards(:writebook)
    delete board_path(board)
    assert_redirected_to root_path
    assert_raises(ActiveRecord::RecordNotFound) { board.reload }
  end
  test "non-admin cannot change all_access on board they don't own" do
    logout_and_sign_in_as :jz
    board = boards(:writebook)
    original_all_access = board.all_access
    patch board_path(board), params: { board: { all_access: !original_all_access } }
    assert_response :forbidden
    assert_equal original_all_access, board.reload.all_access
  end
  test "non-admin cannot change individual user accesses on board they don't own" do
    logout_and_sign_in_as :jz
    board = boards(:writebook)
    original_users = board.users.sort
    patch board_path(board), params: {
      board: { name: board.name },
      user_ids: [ users(:jz).id ]
    }
    assert_response :forbidden
    assert_equal original_users, board.reload.users.sort
  end
  test "non-admin cannot change board name on board they don't own" do
    logout_and_sign_in_as :jz
    board = boards(:writebook)
    original_name = board.name
    patch board_path(board), params: {
      board: { name: "Hacked Board Name" }
    }
    assert_response :forbidden
    assert_equal original_name, board.reload.name
  end
  test "non-admin cannot destroy board they don't own" do
    logout_and_sign_in_as :jz
    board = boards(:writebook)
    delete board_path(board)
    assert_response :forbidden
  end
  test "disables select all/none buttons for non-privileged user" do
    logout_and_sign_in_as :jz
    assert_not users(:jz).can_administer_board?(boards(:writebook))
    get edit_board_path(boards(:writebook))
    assert_response :success
    assert_select "button[disabled]", text: "Select all"
    assert_select "button[disabled]", text: "Select none"
  end
  test "enables select all/none buttons for privileged user" do
    assert users(:kevin).can_administer_board?(boards(:writebook))
    get edit_board_path(boards(:writebook))
    assert_response :success
    assert_select "button:not([disabled])", text: "Select all"
    assert_select "button:not([disabled])", text: "Select none"
  end
  test "access toggle disabled state is cached correctly" do
    board = boards(:writebook)
    david = users(:david)
    with_actionview_partial_caching do
      # privileged user
      assert users(:kevin).can_administer_board?(board)
      get edit_board_path(board)
      assert_response :success
      assert_select "input.switch__input[name='user_ids[]'][value='#{david.id}']:not([disabled])"
      # unprivileged user
      logout_and_sign_in_as :jz
      assert_not users(:jz).can_administer_board?(board)
      get edit_board_path(board)
      assert_response :success
      assert_select "input.switch__input[name='user_ids[]'][value='#{david.id}'][disabled]"
    end
  end
  test "index as JSON" do
    get boards_path, as: :json
    assert_response :success
    assert_equal users(:kevin).boards.count, @response.parsed_body.count
  end
  test "show as JSON" do
    get board_path(boards(:writebook)), as: :json
    assert_response :success
    assert_equal boards(:writebook).name, @response.parsed_body["name"]
  end
  test "create as JSON" do
    assert_difference -> { Board.count }, +1 do
      post boards_path, params: { board: { name: "My new board" } }, as: :json
    end
    assert_response :created
    assert_equal board_path(Board.last, format: :json), @response.headers["Location"]
  end
  test "update as JSON" do
    board = boards(:writebook)
    put board_path(board), params: { board: { name: "Updated Name" } }, as: :json
    assert_response :no_content
    assert_equal "Updated Name", board.reload.name
  end
  test "destroy as JSON" do
    board = boards(:writebook)
    assert_difference -> { Board.count }, -1 do
      delete board_path(board), as: :json
    end
    assert_response :no_content
  end
end

================
File: test/controllers/cards_controller_test.rb
================
require "test_helper"
class CardsControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
  end
  test "index" do
    get cards_path
    assert_response :success
  end
  test "filtered index" do
    get cards_path(filters(:jz_assignments).as_params.merge(term: "haggis"))
    assert_response :success
  end
  test "create a new draft" do
    assert_difference -> { Card.count }, 1 do
      post board_cards_path(boards(:writebook))
    end
    card = Card.last
    assert_redirected_to card_draft_path(card)
    assert card.drafted?
  end
  test "create resumes existing draft if it exists" do
    draft = boards(:writebook).cards.create!(creator: users(:kevin), status: :drafted)
    assert_no_difference -> { Card.count } do
      post board_cards_path(boards(:writebook))
      assert_redirected_to card_draft_path(draft)
    end
  end
  test "show redirects to draft when card is drafted" do
    card = boards(:writebook).cards.create!(creator: users(:kevin), status: :drafted)
    get card_path(card)
    assert_redirected_to card_draft_path(card)
  end
  test "show" do
    get card_path(cards(:logo))
    assert_response :success
  end
  test "edit" do
    get edit_card_path(cards(:logo))
    assert_response :success
  end
  test "edit card with invalid attachments in description" do
    card = cards(:logo)
    card.update! description: <<~HTML
      <action-text-attachment sgid="gid://fizzy/Card/nonexistent" content-type="application/octet-stream"></action-text-attachment>
    HTML
    get edit_card_path(card)
    assert_response :success
  end
  test "update" do
    patch card_path(cards(:logo)), as: :turbo_stream, params: {
      card: {
        title: "Logo needs to change",
        image: fixture_file_upload("moon.jpg", "image/jpeg"),
        description: "Something more in-depth" } }
    assert_response :success
    card = cards(:logo).reload
    assert_equal "Logo needs to change", card.title
    assert_equal "moon.jpg", card.image.filename.to_s
    assert_equal "Something more in-depth", card.description.to_plain_text.strip
  end
  test "update draft card does not render reactions" do
    draft = boards(:writebook).cards.create!(creator: users(:kevin), status: :drafted)
    patch card_path(draft), as: :turbo_stream, params: {
      card: { image: fixture_file_upload("moon.jpg", "image/jpeg") }
    }
    assert_response :success
    assert_no_match "reactions", response.body, "Draft card should not show reactions/boost button"
  end
  test "users can only see cards in boards they have access to" do
    get card_path(cards(:logo))
    assert_response :success
    boards(:writebook).update! all_access: false
    boards(:writebook).accesses.revoke_from users(:kevin)
    get card_path(cards(:logo))
    assert_response :not_found
  end
  test "admins can see delete button on any card" do
    get card_path(cards(:logo))
    assert_response :success
    assert_match "Delete this card", response.body
  end
  test "card creators can see delete button on their own cards" do
    logout_and_sign_in_as :david
    get card_path(cards(:logo))
    assert_response :success
    assert_match "Delete this card", response.body
  end
  test "non-admins cannot see delete button on cards they did not create" do
    logout_and_sign_in_as :jz
    get card_path(cards(:logo))
    assert_response :success
    assert_no_match "Delete this card", response.body
  end
  test "non-admins cannot delete cards they did not create" do
    logout_and_sign_in_as :jz
    assert_no_difference -> { Card.count } do
      delete card_path(cards(:logo))
    end
    assert_response :forbidden
  end
  test "card creators can delete their own cards" do
    logout_and_sign_in_as :david
    assert_difference -> { Card.count }, -1 do
      delete card_path(cards(:logo))
    end
    assert_redirected_to boards(:writebook)
  end
  test "admins can delete any card" do
    assert_difference -> { Card.count }, -1 do
      delete card_path(cards(:logo))
    end
    assert_redirected_to boards(:writebook)
  end
  test "show card with comment containing malformed remote image attachment" do
    card = cards(:logo)
    card.comments.create! \
      creator: users(:kevin),
      body: '<action-text-attachment url="image.png" content-type="image/*" presentation="gallery"></action-text-attachment>'
    get card_path(card)
    assert_response :success
  end
  test "show as JSON" do
    card = cards(:logo)
    card.steps.create!(content: "First step")
    card.steps.create!(content: "Second step", completed: true)
    get card_path(card), as: :json
    assert_response :success
    assert_equal card.title, @response.parsed_body["title"]
    assert_equal card.closed?, @response.parsed_body["closed"]
    assert_equal 2, @response.parsed_body["steps"].size
    assert_equal card_comments_url(card), @response.parsed_body["comments_url"]
    assert_equal card_reactions_url(card), @response.parsed_body["reactions_url"]
  end
  test "create as JSON" do
    assert_difference -> { Card.count }, +1 do
      post board_cards_path(boards(:writebook)),
        params: { card: { title: "My new card", description: "Big if true" } },
        as: :json
      assert_response :created
    end
    card = Card.last
    assert_equal card_path(card, format: :json), @response.headers["Location"]
    assert_equal "My new card", card.title
    assert_equal "Big if true", card.description.to_plain_text
  end
  test "create as JSON with custom created_at" do
    custom_time = Time.utc(2024, 1, 15, 10, 30, 0)
    assert_difference -> { Card.count }, +1 do
      post board_cards_path(boards(:writebook)),
        params: { card: { title: "Backdated card", created_at: custom_time } },
        as: :json
      assert_response :created
    end
    assert_equal custom_time, Card.last.created_at
  end
  test "create as JSON with custom last_active_at" do
    created_time = Time.utc(2024, 1, 15, 10, 30, 0)
    last_active_time = Time.utc(2024, 6, 1, 12, 0, 0)
    assert_difference -> { Card.count }, +1 do
      post board_cards_path(boards(:writebook)),
        params: { card: { title: "Card with activity", created_at: created_time, last_active_at: last_active_time } },
        as: :json
      assert_response :created
    end
    card = Card.last
    assert_equal created_time, card.created_at
    assert_equal last_active_time, card.last_active_at
  end
  test "create as JSON defaults last_active_at to created_at when not provided" do
    created_time = Time.utc(2024, 1, 15, 10, 30, 0)
    assert_difference -> { Card.count }, +1 do
      post board_cards_path(boards(:writebook)),
        params: { card: { title: "Backdated card without last_active_at", created_at: created_time } },
        as: :json
      assert_response :created
    end
    card = Card.last
    assert_equal created_time, card.created_at
    assert_equal created_time, card.last_active_at
  end
  test "update as JSON with custom last_active_at" do
    card = cards(:logo)
    custom_time = Time.utc(2024, 3, 15, 14, 0, 0)
    put card_path(card, format: :json), params: { card: { last_active_at: custom_time } }
    assert_response :success
    assert_equal custom_time, card.reload.last_active_at
  end
  test "update as JSON can restore last_active_at after comments overwrite it" do
    created_time = Time.utc(2024, 1, 15, 10, 30, 0)
    last_active_time = Time.utc(2024, 6, 1, 12, 0, 0)
    # Create a card with custom timestamps (simulating import)
    post board_cards_path(boards(:writebook)),
      params: { card: { title: "Imported card", created_at: created_time, last_active_at: last_active_time } },
      as: :json
    assert_response :created
    card = Card.last
    # Adding a comment overwrites last_active_at (this is expected)
    card.comments.create!(creator: users(:kevin), body: "Imported comment")
    assert_not_equal last_active_time, card.reload.last_active_at
    # After import, restore the correct last_active_at
    put card_path(card, format: :json), params: { card: { last_active_at: last_active_time } }
    assert_response :success
    assert_equal last_active_time, card.reload.last_active_at
  end
  test "update as JSON" do
    card = cards(:logo)
    put card_path(card, format: :json), params: { card: { title: "Update test" } }
    assert_response :success
    assert_equal "Update test", card.reload.title
  end
  test "delete as JSON" do
    card = cards(:logo)
    delete card_path(card, format: :json)
    assert_response :no_content
    assert_not Card.exists?(card.id)
  end
end

================
File: test/controllers/controller_authentication_test.rb
================
require "test_helper"
class ControllerAuthenticationTest < ActionDispatch::IntegrationTest
  test "access without an account slug redirects to menu" do
    sign_in_as :kevin
    integration_session.default_url_options[:script_name] = "" # no tenant
    get cards_path
    assert_redirected_to session_menu_path
  end
  test "access with an account slug but no session redirects to new session" do
    get cards_path
    assert_redirected_to new_session_path(script_name: nil)
  end
  test "access with an account slug and a session allows functional access" do
    sign_in_as :kevin
    get cards_path
    assert_response :success
  end
end

================
File: test/controllers/events_controller_test.rb
================
require "test_helper"
class EventsControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
    travel_to Time.utc(2025, 1, 22, 17, 30, 0)
    events(:layout_assignment_jz).update!(created_at: Time.current.beginning_of_day + 8.hours)
  end
  test "index" do
    get events_path
    assert_select "div.events__time-block[style='grid-area: 17/2']" do
      assert_select "strong", text: /assigned JZ to Layout is broken/
    end
  end
  test "index with a specific timezone" do
    cookies[:timezone] = "America/New_York"
    get events_path
    assert_select "div.events__time-block[style='grid-area: 22/2']" do
      assert_select "strong", text: /assigned JZ to Layout is broken/
    end
  end
  test "only displays events from filtered boards" do
    get events_path(board_ids: [ boards(:writebook).id ])
    assert_response :success
    events_shown = css_select(".event").count
    assert events_shown > 0, "Should show some events"
    css_select(".event").each do |event|
      assert_includes event.text, boards(:writebook).name
    end
  end
end

================
File: test/controllers/filters_controller_test.rb
================
require "test_helper"
class FiltersControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :david
  end
  test "create" do
    assert_difference "users(:david).filters.count", +1 do
      post filters_path, params: {
        indexed_by: "closed",
        assignment_status: "unassigned",
        tag_ids: [ tags(:mobile).id ],
        assignee_ids: [ users(:jz).id ],
        board_ids: [ boards(:writebook).id ] }, as: :turbo_stream
    end
    assert_response :success
    filter = Filter.last
    assert_predicate filter.indexed_by, :closed?
    assert_predicate filter.assignment_status, :unassigned?
    assert_equal [ tags(:mobile) ], filter.tags
    assert_equal [ users(:jz) ], filter.assignees
    assert_equal [ boards(:writebook) ], filter.boards
  end
  test "destroy" do
    filter = filters(:jz_assignments)
    expected_params = filter.as_params
    assert_difference "users(:david).filters.count", -1 do
      delete filter_path(filter), as: :turbo_stream
    end
    assert_response :success
  end
end

================
File: test/controllers/join_codes_controller_test.rb
================
require "test_helper"
class JoinCodesControllerTest < ActionDispatch::IntegrationTest
  setup do
    @account = accounts("37s")
    @join_code = account_join_codes(:"37s")
  end
  test "new" do
    get join_path(code: @join_code.code, script_name: @account.slug)
    assert_response :success
    assert_in_body "37signals"
  end
  test "new with an invalid code" do
    get join_path(code: "INVALID-CODE", script_name: @account.slug)
    assert_response :not_found
  end
  test "new with an inactive code" do
    @join_code.update!(usage_count: @join_code.usage_limit)
    get join_path(code: @join_code.code, script_name: @account.slug)
    assert_response :gone
    assert_in_body "That code is all used up"
  end
  test "create" do
    assert_difference -> { Identity.count }, 1 do
      assert_difference -> { User.count }, 1 do
        post join_path(code: @join_code.code, script_name: @account.slug), params: { email_address: "new_user@example.com" }
      end
    end
    assert_redirected_to session_magic_link_url(script_name: nil)
    assert_equal new_users_verification_url(script_name: @account.slug), session[:return_to_after_authenticating]
  end
  test "create for existing identity" do
    identity = identities(:jz)
    sign_in_as :jz
    assert identity.users.exists?(account: @account), "JZ should be a member of 37s for this test"
    assert identity.users.find_by!(account: @account).setup?, "JZ's user should be setup for this test"
    assert_no_difference -> { Identity.count } do
      assert_no_difference -> { User.count } do
        post join_path(code: @join_code.code, script_name: @account.slug), params: { email_address: identity.email_address }
      end
    end
    assert_redirected_to landing_url(script_name: @account.slug)
  end
  test "create for signed-in identity without a user in the account redirects to verification" do
    identity = identities(:mike)
    sign_in_as :mike
    assert_not identity.users.exists?(account: @account), "Mike should not be a member of 37s for this test"
    assert_no_difference -> { Identity.count } do
      assert_difference -> { User.count }, 1 do
        post join_path(code: @join_code.code, script_name: @account.slug), params: { email_address: identity.email_address }
      end
    end
    assert_redirected_to new_users_verification_url(script_name: @account.slug)
  end
  test "create for different identity terminates existing session" do
    sign_in_as :kevin
    assert_difference -> { Identity.count }, 1 do
      assert_difference -> { User.count }, 1 do
        post join_path(code: @join_code.code, script_name: @account.slug), params: { email_address: "new_user@example.com" }
      end
    end
    assert_redirected_to session_magic_link_url(script_name: nil)
    assert_not_predicate cookies[:session_token], :present?
  end
  test "create with invalid email address" do
    # Avoid Sentry exceptions when attackers try to stuff invalid emails into the system
    without_action_dispatch_exception_handling do
      assert_no_difference -> { Identity.count } do
        assert_no_difference -> { User.count } do
          post join_path(code: @join_code.code, script_name: @account.slug), params: { email_address: "not-a-valid-email" }
        end
      end
      assert_response :unprocessable_entity
    end
  end
  test "create is rate limited" do
    Rails.cache.stubs(:increment).returns(11)
    post join_path(code: @join_code.code, script_name: @account.slug), params: { email_address: "test@example.com" }
    assert_response :too_many_requests
  end
end

================
File: test/controllers/landings_controller_test.rb
================
require "test_helper"
class LandingsControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
  end
  test "redirects to the timeline when many boards" do
    get landing_path
    assert_redirected_to root_path
  end
  test "redirects to the timeline when no boards" do
    Board.destroy_all
    get landing_path
    assert_redirected_to root_path
  end
  test "redirects to boards when only one board" do
    sole_board, *boards_to_delete = users(:kevin).boards.to_a
    boards_to_delete.each(&:destroy)
    get landing_path
    assert_redirected_to board_path(sole_board)
  end
end

================
File: test/controllers/notifications_controller_test.rb
================
require "test_helper"
class NotificationsControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
  end
  test "index as JSON" do
    get notifications_path, as: :json
    assert_response :success
    assert_kind_of Array, @response.parsed_body
    assert @response.parsed_body.any? { |n| n["id"] == notifications(:logo_published_kevin).id }
  end
  test "index as JSON includes notification attributes" do
    get notifications_path, as: :json
    notification = @response.parsed_body.find { |n| n["id"] == notifications(:logo_published_kevin).id }
    assert_not_nil notification["title"]
    assert_not_nil notification["body"]
    assert_not_nil notification["created_at"]
    assert_not_nil notification["card"]
    assert_not_nil notification["creator"]
  end
end

================
File: test/controllers/qr_codes_controller_test.rb
================
require "test_helper"
class QrCodesControllerTest < ActionDispatch::IntegrationTest
  test "show" do
    join_code = account_join_codes(:"37s")
    account = accounts("37s")
    url = join_url(code: join_code.code, script_name: account.slug, host: "app.fizzy.do")
    signed_token = QrCodeLink.new(url).signed
    get qr_code_path(signed_token)
    assert_response :success
    assert_match %r{image/svg\+xml}, response.content_type
    assert_includes response.body, "<svg"
  end
end

================
File: test/controllers/searches_controller_test.rb
================
require "test_helper"
class SearchesControllerTest < ActionDispatch::IntegrationTest
  include SearchTestHelper
  setup do
    @board.update!(all_access: true)
    @card = @board.cards.create!(title: "Layout is broken", description: "Look at this mess.", status: "published", creator: @user)
    @comment_card = @board.cards.create!(title: "Some card", status: "published", creator: @user)
    @comment_card.comments.create!(body: "overflowing text issue", creator: @user)
    @comment2_card = @board.cards.create!(title: "Just haggis", description: "More haggis", status: "published", creator: @user)
    @comment2_card.comments.create!(body: "I love haggis", creator: @user)
    untenanted { sign_in_as @user }
  end
  test "search" do
    # Searching by card title
    get search_path(q: "broken", script_name: "/#{@account.external_account_id}")
    assert_select "li .search__title", text: /Layout is broken/
    assert_select "li .search__excerpt", text: /Look at this mess/
    # Searching by comment
    get search_path(q: "overflowing", script_name: "/#{@account.external_account_id}")
    assert_select "li .search__title", text: /Some card/
    assert_select "li .search__excerpt--comment", text: /overflowing text issue/
    # Searching for a term that appears in a card and in a comment
    get search_path(q: "haggis", script_name: "/#{@account.external_account_id}")
    assert_select "li .search__title", text: /Just haggis/, count: 2 # card title shows up in two entries
    assert_select "li .search__excerpt", text: /More haggis/ # one entry for the card description
    assert_select "li .search__excerpt--comment", text: /I love haggis/ # one entry for the comment
    assert_match(/<mark class="circled-text"><span><\/span>haggis<\/mark>/, response.body)
    # Searching by card id
    get search_path(q: @card.id, script_name: "/#{@account.external_account_id}")
    assert_select "form[data-controller='auto-submit']"
    # Searching with non-existent card id
    get search_path(q: "999999", script_name: "/#{@account.external_account_id}")
    assert_select "form[data-controller='auto-submit']", count: 0
    assert_select ".search__blank-slate", text: "No matches"
  end
  test "search highlights matched terms with proper HTML marks" do
    @board.cards.create!(title: "Testing search highlighting", status: "published", creator: @user)
    get search_path(q: "highlighting", script_name: "/#{@account.external_account_id}")
    assert_response :success
  end
  test "search preserves highlight marks but escapes surrounding HTML" do
    @board.cards.create!(
      title: "<b>Bold</b> testing content",
      status: "published",
      creator: @user
    )
    get search_path(q: "testing", script_name: "/#{@account.external_account_id}")
    assert_response :success
    # Should escape <b> tags
    assert response.body.include?("&lt;b&gt;")
    # But should preserve highlight marks around "testing"
    assert_match(/<mark class="circled-text"><span><\/span>testing<\/mark>/, response.body)
  end
end

================
File: test/controllers/sessions_controller_test.rb
================
require "test_helper"
class SessionsControllerTest < ActionDispatch::IntegrationTest
  test "new" do
    untenanted do
      get new_session_path
    end
    assert_response :success
  end
  test "new redirects authenticated users" do
    sign_in_as :kevin
    untenanted do
      get new_session_path
      assert_redirected_to root_url
    end
  end
  test "create" do
    identity = identities(:kevin)
    untenanted do
      assert_difference -> { MagicLink.count }, 1 do
        post session_path, params: { email_address: identity.email_address }
      end
      assert_redirected_to session_magic_link_path
      assert_nil flash[:magic_link_code]
    end
  end
  test "create for a new user" do
    untenanted do
      assert_difference -> { MagicLink.count }, +1 do
        assert_difference -> { Identity.count }, +1 do
          post session_path,
            params: { email_address: "nonexistent-#{SecureRandom.hex(6)}@example.com" }
        end
      end
      assert_redirected_to session_magic_link_path
      assert MagicLink.last.for_sign_up?
    end
  end
  test "create for a new user when single tenant mode already has a tenant" do
    with_multi_tenant_mode(false) do
      untenanted do
        assert_no_difference -> { MagicLink.count } do
          assert_no_difference -> { Identity.count } do
            post session_path,
              params: { email_address: "nonexistent-#{SecureRandom.hex(6)}@example.com" }
          end
        end
        assert_redirected_to session_magic_link_path
      end
    end
  end
  test "create with invalid email address" do
    # Avoid Sentry exceptions when attackers try to stuff invalid emails. The browser performs form
    # field validation that should normally prevent this from occurring, so I'm not worried about
    # returning proper validation errors.
    without_action_dispatch_exception_handling do
      untenanted do
        assert_no_difference -> { Identity.count } do
          post session_path, params: { email_address: "not-a-valid-email" }
        end
        assert_response :redirect
        assert_redirected_to new_session_path
      end
    end
  end
  test "destroy" do
    sign_in_as :kevin
    untenanted do
      delete session_path
      assert_redirected_to new_session_path
      assert_not cookies[:session_token].present?
    end
  end
  test "create via JSON" do
    untenanted do
      post session_path(format: :json), params: { email_address: identities(:david).email_address }
      assert_response :created
    end
  end
  test "create for a new user via JSON" do
    new_email = "new-user-#{SecureRandom.hex(6)}@example.com"
    untenanted do
      assert_difference -> { Identity.count }, 1 do
        assert_difference -> { MagicLink.count }, 1 do
          post session_path(format: :json), params: { email_address: new_email }
        end
      end
      assert_response :created
      assert @response.parsed_body["pending_authentication_token"].present?
      assert MagicLink.last.for_sign_up?
    end
  end
  test "create with invalid email address via JSON" do
    untenanted do
      assert_no_difference -> { Identity.count } do
        post session_path(format: :json), params: { email_address: "not-a-valid-email" }
      end
      assert_response :unprocessable_entity
    end
  end
  test "destroy via JSON" do
    sign_in_as :kevin
    untenanted do
      delete session_path(format: :json)
      assert_response :no_content
      assert_not cookies[:session_token].present?
    end
  end
end

================
File: test/controllers/signups_controller_test.rb
================
require "test_helper"
class SignupsControllerTest < ActionDispatch::IntegrationTest
  test "new" do
    untenanted do
      get new_signup_path
      assert_response :success
    end
  end
  test "new for an authenticated user" do
    identity = identities(:kevin)
    sign_in_as identity
    untenanted do
      get new_signup_path
      assert_redirected_to new_signup_completion_path
    end
  end
  test "create" do
    email_address = "newuser-#{SecureRandom.hex(6)}@example.com"
    untenanted do
      assert_difference -> { Identity.count }, +1 do
        assert_difference -> { MagicLink.count }, +1 do
          post signup_path, params: { signup: { email_address: email_address } }
        end
      end
      assert_redirected_to session_magic_link_path
    end
  end
  test "create with invalid email address" do
    without_action_dispatch_exception_handling do
      untenanted do
        assert_no_difference -> { Identity.count } do
          assert_no_difference -> { MagicLink.count } do
            post signup_path, params: { signup: { email_address: "not-a-valid-email" } }
          end
        end
        assert_response :unprocessable_entity
      end
    end
  end
  test "create for an authenticated user" do
    identity = identities(:kevin)
    sign_in_as identity
    untenanted do
      assert_no_difference -> { Identity.count } do
        assert_no_difference -> { MagicLink.count } do
          post signup_path,
            params: { signup: { email_address: identity.email_address } }
        end
      end
      assert_redirected_to new_signup_completion_path
    end
  end
  test "redirects to session#new when single_tenant and user exists" do
    users(:david)
    with_multi_tenant_mode(false) do
      untenanted do
        get new_signup_path
        assert_redirected_to new_session_url
      end
    end
  end
end

================
File: test/controllers/tags_controller_test.rb
================
require "test_helper"
class TagsControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
  end
  test "index as JSON" do
    tags = users(:kevin).account.tags.alphabetically
    get tags_path, as: :json
    assert_response :success
    assert_equal tags.count, @response.parsed_body.count
    assert_equal tags.pluck(:title), @response.parsed_body.pluck("title")
  end
end

================
File: test/controllers/users_controller_test.rb
================
require "test_helper"
class UsersControllerTest < ActionDispatch::IntegrationTest
  test "show" do
    sign_in_as :kevin
    get user_path(users(:david))
    assert_in_body users(:david).name
  end
  test "update oneself" do
    sign_in_as :kevin
    get edit_user_path(users(:kevin))
    assert_response :ok
    put user_path(users(:kevin)), params: { user: { name: "New Kevin" } }
    assert_redirected_to user_path(users(:kevin))
    assert_equal "New Kevin", users(:kevin).reload.name
  end
  test "update other as admin" do
    sign_in_as :kevin
    get edit_user_path(users(:david))
    assert_response :ok
    put user_path(users(:david)), params: { user: { name: "New David" } }
    assert_redirected_to user_path(users(:david))
    assert_equal "New David", users(:david).reload.name
  end
  test "destroy" do
    sign_in_as :kevin
    assert_difference -> { User.active.count }, -1 do
      delete user_path(users(:david))
    end
    assert_redirected_to account_settings_path
    assert_nil User.active.find_by(id: users(:david).id)
  end
  test "admin cannot deactivate the owner" do
    sign_in_as :kevin
    assert users(:jason).owner?
    assert users(:jason).active
    assert_no_difference -> { User.active.count } do
      delete user_path(users(:jason))
    end
    assert_response :forbidden
    assert users(:jason).reload.active
  end
  test "non-admins cannot perform actions" do
    sign_in_as :jz
    put user_path(users(:david)), params: { user: { role: "admin" } }
    assert_response :forbidden
    delete user_path(users(:david))
    assert_response :forbidden
  end
  test "update with invalid avatar content type shows validation error" do
    sign_in_as :kevin
    svg_file = fixture_file_upload("avatar.svg", "image/svg+xml")
    put user_path(users(:kevin)), params: { user: { avatar: svg_file } }
    assert_response :unprocessable_entity
    assert_select "form[action='#{user_path(users(:kevin))}']"
    assert_select ".txt-negative", text: /must be a JPEG, PNG, GIF, or WebP image/
  end
  test "update with oversized avatar shows validation error" do
    sign_in_as :kevin
    png_file = fixture_file_upload("avatar.png", "image/png")
    ActiveStorage::Analyzer::ImageAnalyzer::Vips.any_instance.stubs(:metadata).returns({ width: 5000, height: 100 })
    put user_path(users(:kevin)), params: { user: { avatar: png_file } }
    assert_response :unprocessable_entity
    assert_select ".txt-negative", text: /width must be less than 4096px/
  end
  test "update with valid avatar" do
    sign_in_as :kevin
    png_file = fixture_file_upload("avatar.png", "image/png")
    put user_path(users(:kevin)), params: { user: { avatar: png_file } }
    assert_redirected_to user_path(users(:kevin))
    assert users(:kevin).reload.avatar.attached?
    assert_equal "image/png", users(:kevin).avatar.content_type
  end
  test "index as JSON" do
    sign_in_as :kevin
    get users_path, as: :json
    assert_response :success
    assert_equal users(:kevin).account.users.active.count, @response.parsed_body.count
  end
  test "show as JSON" do
    sign_in_as :kevin
    get user_path(users(:david)), as: :json
    assert_response :success
    assert_equal users(:david).name, @response.parsed_body["name"]
  end
  test "update as JSON" do
    sign_in_as :kevin
    put user_path(users(:david)), params: { user: { name: "New David" } }, as: :json
    assert_response :no_content
    assert_equal "New David", users(:david).reload.name
  end
  test "update as JSON with invalid avatar returns errors" do
    sign_in_as :kevin
    svg_file = fixture_file_upload("avatar.svg", "image/svg+xml")
    put user_path(users(:kevin), format: :json), params: { user: { avatar: svg_file } }
    assert_response :unprocessable_entity
    assert @response.parsed_body["avatar"].present?
  end
  test "destroy as JSON" do
    sign_in_as :kevin
    assert_difference -> { User.active.count }, -1 do
      delete user_path(users(:david)), as: :json
    end
    assert_response :no_content
  end
end

================
File: test/controllers/webhooks_controller_test.rb
================
require "test_helper"
class WebhooksControllerTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
  end
  test "index" do
    get board_webhooks_path(boards(:writebook))
    assert_response :success
  end
  test "show" do
    webhook = webhooks(:active)
    get board_webhook_path(webhook.board, webhook)
    assert_response :success
    webhook = webhooks(:inactive)
    get board_webhook_path(webhook.board, webhook)
    assert_response :success
  end
  test "new" do
    get new_board_webhook_path(boards(:writebook))
    assert_response :success
    assert_select "form"
  end
  test "create with valid params" do
    board = boards(:writebook)
    assert_difference "Webhook.count", 1 do
      post board_webhooks_path(board), params: {
        webhook: {
          name: "Test Webhook",
          url: "https://example.com/webhook",
          subscribed_actions: [ "", "card_published", "card_closed" ]
        }
      }
    end
    webhook = Webhook.last
    assert_redirected_to board_webhook_path(webhook.board, webhook)
    assert_equal board, webhook.board
    assert_equal "Test Webhook", webhook.name
    assert_equal "https://example.com/webhook", webhook.url
    assert_equal [ "card_published", "card_closed" ], webhook.subscribed_actions
  end
  test "create with invalid params" do
    board = boards(:writebook)
    assert_no_difference "Webhook.count" do
      post board_webhooks_path(board), params: {
        webhook: {
          name: "",
          url: "invalid-url"
        }
      }
    end
    assert_response :unprocessable_entity
  end
  test "edit" do
    webhook = webhooks(:active)
    get edit_board_webhook_path(webhook.board, webhook)
    assert_response :success
    assert_select "form"
    webhook = webhooks(:inactive)
    get edit_board_webhook_path(webhook.board, webhook)
    assert_response :success
    assert_select "form"
  end
  test "update with valid params" do
    webhook = webhooks(:active)
    patch board_webhook_path(webhook.board, webhook), params: {
      webhook: {
        name: "Updated Webhook",
        subscribed_actions: [ "card_published" ]
      }
    }
    webhook.reload
    assert_redirected_to board_webhook_path(webhook.board, webhook)
    assert_equal "Updated Webhook", webhook.name
    assert_equal [ "card_published" ], webhook.subscribed_actions
  end
  test "update with invalid params" do
    webhook = webhooks(:active)
    patch board_webhook_path(webhook.board, webhook), params: {
      webhook: {
        name: ""
      }
    }
    assert_response :unprocessable_entity
    assert_no_changes -> { webhook.reload.url } do
      patch board_webhook_path(webhook.board, webhook), params: {
        webhook: {
          name: "Updated Webhook",
          url: "https://different.com/webhook"
        }
      }
    end
    assert_redirected_to board_webhook_path(webhook.board, webhook)
  end
  test "destroy" do
    webhook = webhooks(:active)
    assert_difference "Webhook.count", -1 do
      delete board_webhook_path(webhook.board, webhook)
    end
    assert_redirected_to board_webhooks_path(webhook.board)
  end
  test "cannot access webhooks on board without access" do
    logout_and_sign_in_as :jason
    webhook = webhooks(:inactive)  # on private board, jason has no access
    get board_webhooks_path(webhook.board)
    assert_response :not_found
  end
end

================
File: test/fixtures/account/join_codes.yml
================
37s:
  id: <%= ActiveRecord::FixtureSet.identify("37s_join_code", :uuid) %>
  code: 37S0-5678-9XYZ
  usage_count: 0
  usage_limit: 10
  account: 37s_uuid
initech:
  id: <%= ActiveRecord::FixtureSet.identify("initech_join_code", :uuid) %>
  code: INIT-5678-9XYZ
  usage_count: 10
  usage_limit: 10
  account: initech_uuid

================
File: test/fixtures/action_text/rich_texts.yml
================
logo_agreement_jz:
  id: <%= ActiveRecord::FixtureSet.identify("logo_agreement_jz_rich_text", :uuid) %>
  account: 37s_uuid
  record: logo_agreement_jz_uuid (Comment)
  name: body
  body: I agree.
logo_agreement_kevin:
  id: <%= ActiveRecord::FixtureSet.identify("logo_agreement_kevin_rich_text", :uuid) %>
  account: 37s_uuid
  record: logo_agreement_kevin_uuid (Comment)
  name: body
  body: Same, let's do it.
layout_overflowing_david:
  id: <%= ActiveRecord::FixtureSet.identify("layout_overflowing_david_rich_text", :uuid) %>
  account: 37s_uuid
  record: layout_overflowing_david_uuid (Comment)
  name: body
  body: The text is overflowing the container.

================
File: test/fixtures/card/goldnesses.yml
================
logo:
  id: <%= ActiveRecord::FixtureSet.identify("logo_goldness", :uuid) %>
  account: 37s_uuid
  card: logo_uuid

================
File: test/fixtures/files/avatar.svg
================
<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100">
  <circle cx="50" cy="50" r="40" fill="#4a90d9"/>
</svg>

================
File: test/fixtures/identity/access_tokens.yml
================
jasons_api_token:
  identity: jason
  token: 018cf1425682700098f24f0799e3fe20
  description: My Superscript
  permission: read
davids_api_token:
  identity: david
  token: x18cf1425682700098f24f0799e3fe20
  description: My Superscript
  permission: write

================
File: test/fixtures/user/settings.yml
================
_fixture:
  model_class: User::Settings
david_settings:
  id: <%= ActiveRecord::FixtureSet.identify("david_settings", :uuid) %>
  account: 37s_uuid
  user: david_uuid
  bundle_email_frequency: never
jz_settings:
  id: <%= ActiveRecord::FixtureSet.identify("jz_settings", :uuid) %>
  account: 37s_uuid
  user: jz_uuid
  bundle_email_frequency: never
kevin_settings:
  id: <%= ActiveRecord::FixtureSet.identify("kevin_settings", :uuid) %>
  account: 37s_uuid
  user: kevin_uuid
  bundle_email_frequency: never
system_settings:
  id: <%= ActiveRecord::FixtureSet.identify("system_settings", :uuid) %>
  account: 37s_uuid
  user: system_uuid
  bundle_email_frequency: never

================
File: test/fixtures/webhook/delinquency_trackers.yml
================
# Read about fixtures at https://api.rubyonrails.org/classes/ActiveRecord/FixtureSet.html
active_webhook_tracker:
  id: <%= ActiveRecord::FixtureSet.identify("active_webhook_tracker", :uuid) %>
  account: 37s_uuid
  webhook: active_uuid
  consecutive_failures_count: 1
  first_failure_at: <%= 1.hour.ago %>
inactive_webhook_tracker:
  id: <%= ActiveRecord::FixtureSet.identify("inactive_webhook_tracker", :uuid) %>
  account: 37s_uuid
  webhook: inactive_uuid
  consecutive_failures_count: 1
  first_failure_at: <%= 1.hour.ago %>

================
File: test/fixtures/webhook/deliveries.yml
================
# Read about fixtures at https://api.rubyonrails.org/classes/ActiveRecord/FixtureSet.html
successfully_completed:
  id: <%= ActiveRecord::FixtureSet.identify("successfully_completed_delivery", :uuid) %>
  account: 37s_uuid
  webhook: active_uuid
  event: logo_published_uuid
  state: completed
  request: '<%= { headers: {} }.to_json %>'
  response: '<%= { code: 200, headers: {} }.to_json %>'
  created_at: <%= 1.week.ago %>
unsuccessfully_completed:
  id: <%= ActiveRecord::FixtureSet.identify("unsuccessfully_completed_delivery", :uuid) %>
  account: 37s_uuid
  webhook: active_uuid
  event: logo_assignment_jz_uuid
  state: completed
  request: '<%= { headers: {} }.to_json %>'
  response: '<%= { code: 422, headers: {} }.to_json %>'
  created_at: <%= 1.week.ago + 1.hour %>
errored:
  id: <%= ActiveRecord::FixtureSet.identify("errored_delivery", :uuid) %>
  account: 37s_uuid
  webhook: active_uuid
  event: layout_published_uuid
  state: errored
  request: '<%= { headers: {} }.to_json %>'
  response: '<%= { error: "destination_unreachable" }.to_json %>'
  created_at: <%= 1.week.ago %>
pending:
  id: <%= ActiveRecord::FixtureSet.identify("pending_delivery", :uuid) %>
  account: 37s_uuid
  webhook: active_uuid
  event: shipping_closed_uuid
  state: pending
  request: null
  response: null
  created_at: <%= 2.day.ago %>
in_progress:
  id: <%= ActiveRecord::FixtureSet.identify("in_progress_delivery", :uuid) %>
  account: 37s_uuid
  webhook: active_uuid
  event: logo_assignment_km_uuid
  state: in_progress
  request: null
  response: null
  created_at: <%= 1.day.ago %>

================
File: test/fixtures/accesses.yml
================
writebook_david:
  id: <%= ActiveRecord::FixtureSet.identify("writebook_david", :uuid) %>
  account: 37s_uuid
  board: writebook_uuid
  user: david_uuid
writebook_jz:
  id: <%= ActiveRecord::FixtureSet.identify("writebook_jz", :uuid) %>
  account: 37s_uuid
  board: writebook_uuid
  user: jz_uuid
writebook_kevin:
  id: <%= ActiveRecord::FixtureSet.identify("writebook_kevin", :uuid) %>
  account: 37s_uuid
  board: writebook_uuid
  user: kevin_uuid
private_kevin:
  id: <%= ActiveRecord::FixtureSet.identify("private_kevin", :uuid) %>
  account: 37s_uuid
  board: private_uuid
  user: kevin_uuid
miltons_wish_list_mike:
  id: <%= ActiveRecord::FixtureSet.identify("miltons_wish_list_mike", :uuid) %>
  account: initech_uuid
  board: miltons_wish_list_uuid
  user: mike_uuid

================
File: test/fixtures/accounts.yml
================
37s:
  id: <%= ActiveRecord::FixtureSet.identify("37s", :uuid) %>
  name: 37signals
  external_account_id: <%= ActiveRecord::FixtureSet.identify("37signals") %>
  cards_count: 5
initech:
  id: <%= ActiveRecord::FixtureSet.identify("initech", :uuid) %>
  name: Initech LLC
  external_account_id: <%= ActiveRecord::FixtureSet.identify("initech") %>
  cards_count: 0
acme:
  id: <%= ActiveRecord::FixtureSet.identify("acme", :uuid) %>
  name: ACME
  external_account_id: <%= ActiveRecord::FixtureSet.identify("acme") %>
  cards_count: 0

================
File: test/fixtures/assignees_filters.yml
================
jz_assignments_jz:
  assignee_id: <%= ActiveRecord::FixtureSet.identify("jz", :uuid) %>
  filter_id: <%= ActiveRecord::FixtureSet.identify("jz_assignments", :uuid) %>

================
File: test/fixtures/assignments.yml
================
logo_jz:
  id: <%= ActiveRecord::FixtureSet.identify("logo_jz", :uuid) %>
  account: 37s_uuid
  assigner: david_uuid
  assignee: jz_uuid
  card: logo_uuid
  created_at: <%= 1.week.ago %>
logo_kevin:
  id: <%= ActiveRecord::FixtureSet.identify("logo_kevin", :uuid) %>
  account: 37s_uuid
  assigner: david_uuid
  assignee: kevin_uuid
  card: logo_uuid
  created_at: <%= 1.day.ago %>
layout_jz:
  id: <%= ActiveRecord::FixtureSet.identify("layout_jz", :uuid) %>
  account: 37s_uuid
  assigner: david_uuid
  assignee: jz_uuid
  card: layout_uuid

================
File: test/fixtures/boards.yml
================
writebook:
  id: <%= ActiveRecord::FixtureSet.identify("writebook", :uuid) %>
  name: Writebook
  creator: david_uuid
  all_access: true
  account: 37s_uuid
private:
  id: <%= ActiveRecord::FixtureSet.identify("private", :uuid) %>
  name: Private board
  creator: kevin_uuid
  all_access: false
  account: 37s_uuid
miltons_wish_list:
  id: <%= ActiveRecord::FixtureSet.identify("miltons_wish_list", :uuid) %>
  name: Milton's Wish List
  creator: mike_uuid
  all_access: true
  account: initech_uuid

================
File: test/fixtures/cards.yml
================
logo:
  id: <%= ActiveRecord::FixtureSet.identify("logo", :uuid) %>
  number: 1
  board: writebook_uuid
  creator: david_uuid
  column: writebook_triage_uuid
  title: The logo isn't big enough
  due_on: <%= 3.days.from_now %>
  created_at: <%= 1.week.ago %>
  status: published
  last_active_at: <%= 1.week.ago %>
  account: 37s_uuid
layout:
  id: <%= ActiveRecord::FixtureSet.identify("layout", :uuid) %>
  number: 2
  board: writebook_uuid
  creator: david_uuid
  column: writebook_triage_uuid
  title: Layout is broken
  created_at: <%= 1.week.ago %>
  status: published
  last_active_at: <%= 1.week.ago %>
  account: 37s_uuid
text:
  id: <%= ActiveRecord::FixtureSet.identify("text", :uuid) %>
  number: 3
  board: writebook_uuid
  creator: kevin_uuid
  column: writebook_in_progress_uuid
  title: The text is too small
  created_at: <%= 1.week.ago %>
  status: published
  last_active_at: <%= 1.week.ago %>
  account: 37s_uuid
shipping:
  id: <%= ActiveRecord::FixtureSet.identify("shipping", :uuid) %>
  number: 4
  board: writebook_uuid
  creator: kevin_uuid
  column: writebook_triage_uuid
  title: We need to ship the app
  created_at: <%= 1.week.ago %>
  status: published
  last_active_at: <%= 1.week.ago %>
  account: 37s_uuid
buy_domain:
  id: <%= ActiveRecord::FixtureSet.identify("buy_domain", :uuid) %>
  number: 5
  board: writebook_uuid
  creator: david_uuid
  title: Buy domain
  created_at: <%= 1.week.ago %>
  status: published
  last_active_at: <%= 1.week.ago %>
  account: 37s_uuid
radio:
  id: <%= ActiveRecord::FixtureSet.identify("radio", :uuid) %>
  number: 1
  board: miltons_wish_list_uuid
  creator: mike_uuid
  title: I want to play my radio at a reasonable volume
  created_at: <%= 1.week.ago %>
  status: published
  last_active_at: <%= 1.week.ago %>
  account: initech_uuid
paycheck:
  id: <%= ActiveRecord::FixtureSet.identify("paycheck", :uuid) %>
  number: 2
  board: miltons_wish_list_uuid
  creator: mike_uuid
  title: I haven't received my paycheck
  created_at: <%= 1.week.ago %>
  status: published
  last_active_at: <%= 1.week.ago %>
  account: initech_uuid
unfinished_thoughts:
  id: <%= ActiveRecord::FixtureSet.identify("unfinished_thoughts", :uuid) %>
  number: 3
  board: miltons_wish_list_uuid
  creator: mike_uuid
  title: Some unfinished thoughts
  created_at: <%= 1.week.ago %>
  status: drafted
  last_active_at: <%= 1.week.ago %>
  account: initech_uuid

================
File: test/fixtures/closures.yml
================
shipping:
  id: <%= ActiveRecord::FixtureSet.identify("shipping_closure", :uuid) %>
  account: 37s_uuid
  card: shipping_uuid
  user: kevin_uuid

================
File: test/fixtures/columns.yml
================
# Columns for writebook board (which has qa workflow)
writebook_triage:
  id: <%= ActiveRecord::FixtureSet.identify("writebook_triage", :uuid) %>
  name: Triage
  color: "var(--color-card-4)"
  board: writebook_uuid
  position: 0
  account: 37s_uuid
writebook_in_progress:
  id: <%= ActiveRecord::FixtureSet.identify("writebook_in_progress", :uuid) %>
  name: In progress
  color: "var(--color-card-2)"
  board: writebook_uuid
  position: 1
  account: 37s_uuid
writebook_on_hold:
  id: <%= ActiveRecord::FixtureSet.identify("writebook_on_hold", :uuid) %>
  name: On Hold
  color: "var(--color-card-4)"
  board: writebook_uuid
  position: 2
  account: 37s_uuid
writebook_review:
  id: <%= ActiveRecord::FixtureSet.identify("writebook_review", :uuid) %>
  name: Review
  color: "var(--color-card-3)"
  board: writebook_uuid
  position: 3
  account: 37s_uuid

================
File: test/fixtures/comments.yml
================
logo_1:
  id: <%= ActiveRecord::FixtureSet.identify("logo_1", :uuid) %>
  card: logo_uuid
  creator: system_uuid
  created_at: <%= 1.week.ago %>
  account: 37s_uuid
logo_agreement_jz:
  id: <%= ActiveRecord::FixtureSet.identify("logo_agreement_jz", :uuid) %>
  card: logo_uuid
  creator: jz_uuid
  created_at: <%= 2.days.ago %>
  account: 37s_uuid
logo_3:
  id: <%= ActiveRecord::FixtureSet.identify("logo_3", :uuid) %>
  card: logo_uuid
  creator: system_uuid
  created_at: <%= 1.day.ago %>
  account: 37s_uuid
logo_agreement_kevin:
  id: <%= ActiveRecord::FixtureSet.identify("logo_agreement_kevin", :uuid) %>
  card: logo_uuid
  creator: kevin_uuid
  created_at: <%= 2.hours.ago %>
  account: 37s_uuid
logo_5:
  id: <%= ActiveRecord::FixtureSet.identify("logo_5", :uuid) %>
  card: logo_uuid
  creator: system_uuid
  created_at: <%= 1.hour.ago %>
  account: 37s_uuid
layout_1:
  id: <%= ActiveRecord::FixtureSet.identify("layout_1", :uuid) %>
  card: layout_uuid
  creator: system_uuid
  account: 37s_uuid
layout_overflowing_david:
  id: <%= ActiveRecord::FixtureSet.identify("layout_overflowing_david", :uuid) %>
  card: layout_uuid
  creator: david_uuid
  account: 37s_uuid
text_1:
  id: <%= ActiveRecord::FixtureSet.identify("text_1", :uuid) %>
  card: text_uuid
  creator: system_uuid
  account: 37s_uuid
shipping_1:
  id: <%= ActiveRecord::FixtureSet.identify("shipping_1", :uuid) %>
  card: shipping_uuid
  creator: system_uuid
  account: 37s_uuid

================
File: test/fixtures/entropies.yml
================
37s_account:
  id: <%= ActiveRecord::FixtureSet.identify("37s_account", :uuid) %>
  account: 37s_uuid
  container: 37s_uuid (Account)
  auto_postpone_period: <%= 30.days.to_i %>
writebook_board:
  id: <%= ActiveRecord::FixtureSet.identify("writebook_board", :uuid) %>
  account: 37s_uuid
  container: writebook_uuid (Board)
  auto_postpone_period: <%= 90.days.to_i %>
private_board:
  id: <%= ActiveRecord::FixtureSet.identify("private_board", :uuid) %>
  account: 37s_uuid
  container: private_uuid (Board)
  auto_postpone_period: <%= 30.days.to_i %>
initech_account:
  id: <%= ActiveRecord::FixtureSet.identify("initech_account", :uuid) %>
  account: initech_uuid
  container: initech_uuid (Account)
  auto_postpone_period: <%= 30.days.to_i %>
miltons_wish_list_board:
  id: <%= ActiveRecord::FixtureSet.identify("miltons_wish_list_board", :uuid) %>
  account: initech_uuid
  container: miltons_wish_list_uuid (Board)
  auto_postpone_period: <%= 90.days.to_i %>

================
File: test/fixtures/events.yml
================
logo_published:
  id: <%= ActiveRecord::FixtureSet.identify("logo_published", :uuid) %>
  creator: david_uuid
  board: writebook_uuid
  eventable: logo_uuid (Card)
  action: card_published
  created_at: <%= 1.week.ago %>
  account: 37s_uuid
logo_assignment_jz:
  id: <%= ActiveRecord::FixtureSet.identify("logo_assignment_jz", :uuid) %>
  creator: david_uuid
  board: writebook_uuid
  eventable: logo_uuid (Card)
  action: card_assigned
  particulars: <%= { assignee_ids: [ ActiveRecord::FixtureSet.identify("jz", :uuid) ] }.to_json %>
  created_at: <%= 1.week.ago + 1.hour %>
  account: 37s_uuid
logo_assignment_david:
  id: <%= ActiveRecord::FixtureSet.identify("logo_assignment_david", :uuid) %>
  creator: david_uuid
  board: writebook_uuid
  eventable: logo_uuid (Card)
  action: card_assigned
  particulars: <%= { assignee_ids: [ ActiveRecord::FixtureSet.identify("david", :uuid) ] }.to_json %>
  created_at: <%= 1.week.ago + 1.hour %>
  account: 37s_uuid
logo_assignment_km:
  id: <%= ActiveRecord::FixtureSet.identify("logo_assignment_km", :uuid) %>
  creator: david_uuid
  board: writebook_uuid
  eventable: logo_uuid (Card)
  action: card_assigned
  particulars: <%= { assignee_ids: [ ActiveRecord::FixtureSet.identify("kevin", :uuid) ] }.to_json %>
  created_at: <%= 1.day.ago %>
  account: 37s_uuid
layout_published:
  id: <%= ActiveRecord::FixtureSet.identify("layout_published", :uuid) %>
  creator: david_uuid
  board: writebook_uuid
  eventable: layout_uuid (Card)
  action: card_published
  created_at: <%= 1.week.ago %>
  account: 37s_uuid
layout_commented:
  id: <%= ActiveRecord::FixtureSet.identify("layout_commented", :uuid) %>
  creator: david_uuid
  board: writebook_uuid
  eventable: layout_overflowing_david_uuid (Comment)
  action: comment_created
  created_at: <%= 1.week.ago %>
  account: 37s_uuid
layout_assignment_jz:
  id: <%= ActiveRecord::FixtureSet.identify("layout_assignment_jz", :uuid) %>
  creator: david_uuid
  board: writebook_uuid
  eventable: layout_uuid (Card)
  action: card_assigned
  particulars: <%= { assignee_ids: [ ActiveRecord::FixtureSet.identify("jz", :uuid) ] }.to_json %>
  created_at: <%= 1.hour.ago %>
  account: 37s_uuid
text_published:
  id: <%= ActiveRecord::FixtureSet.identify("text_published", :uuid) %>
  creator: kevin_uuid
  board: writebook_uuid
  eventable: text_uuid (Card)
  action: card_published
  created_at: <%= 1.week.ago %>
  account: 37s_uuid
shipping_published:
  id: <%= ActiveRecord::FixtureSet.identify("shipping_published", :uuid) %>
  creator: kevin_uuid
  board: writebook_uuid
  eventable: shipping_uuid (Card)
  action: card_published
  created_at: <%= 1.week.ago %>
  account: 37s_uuid
shipping_closed:
  id: <%= ActiveRecord::FixtureSet.identify("shipping_closed", :uuid) %>
  creator: kevin_uuid
  board: writebook_uuid
  eventable: shipping_uuid (Card)
  action: card_closed
  created_at: <%= 2.days.ago %>
  account: 37s_uuid

================
File: test/fixtures/exports.yml
================
pending_account_export:
  id: <%= ActiveRecord::FixtureSet.identify("pending_account_export", :uuid) %>
  account: 37s_uuid
  user: david_uuid
  type: Account::Export
  status: pending
completed_account_export:
  id: <%= ActiveRecord::FixtureSet.identify("completed_account_export", :uuid) %>
  account: 37s_uuid
  user: david_uuid
  type: Account::Export
  status: completed
  completed_at: <%= 1.hour.ago.to_fs(:db) %>
pending_user_data_export:
  id: <%= ActiveRecord::FixtureSet.identify("pending_user_data_export", :uuid) %>
  account: 37s_uuid
  user: david_uuid
  type: User::DataExport
  status: pending
completed_user_data_export:
  id: <%= ActiveRecord::FixtureSet.identify("completed_user_data_export", :uuid) %>
  account: 37s_uuid
  user: david_uuid
  type: User::DataExport
  status: completed
  completed_at: <%= 1.hour.ago.to_fs(:db) %>

================
File: test/fixtures/filters_tags.yml
================
jz_assignments_mobile:
  filter_id: <%= ActiveRecord::FixtureSet.identify("jz_assignments", :uuid) %>
  tag_id: <%= ActiveRecord::FixtureSet.identify("mobile", :uuid) %>

================
File: test/fixtures/filters.yml
================
jz_assignments:
  id: <%= ActiveRecord::FixtureSet.identify("jz_assignments", :uuid) %>
  creator: david_uuid
  fields: <%= { indexed_by: :all, sorted_by: :newest }.to_json %>
  params_digest: <%= Filter.digest_params({ indexed_by: :all, sorted_by: :newest, tag_ids: [ ActiveRecord::FixtureSet.identify("mobile", :uuid) ], assignee_ids: [ ActiveRecord::FixtureSet.identify("jz", :uuid) ] }) %>
  account: 37s_uuid

================
File: test/fixtures/identities.yml
================
david:
  email_address: david@37signals.com
  staff: true
jz:
  email_address: jz@37signals.com
jason:
  email_address: jason@37signals.com
  staff: true
kevin:
  email_address: kevin@37signals.com
  staff: true
mike:
  email_address: mike@37signals.com

================
File: test/fixtures/mentions.yml
================
logo_card_david_mention_by_jz:
  id: <%= ActiveRecord::FixtureSet.identify("logo_card_david_mention_by_jz", :uuid) %>
  account: 37s_uuid
  source: logo_uuid (Card)
  mentioner: jz_uuid
  mentionee: david_uuid
logo_comment_david_mention_by_jz:
  id: <%= ActiveRecord::FixtureSet.identify("logo_comment_david_mention_by_jz", :uuid) %>
  account: 37s_uuid
  source: logo_agreement_jz_uuid (Comment)
  mentioner: jz_uuid
  mentionee: david_uuid

================
File: test/fixtures/notifications.yml
================
logo_published_kevin:
  id: <%= ActiveRecord::FixtureSet.identify("logo_published_kevin", :uuid) %>
  user: kevin_uuid
  source: logo_published_uuid (Event)
  created_at: <%= 1.week.ago %>
  creator: david_uuid
  account: 37s_uuid
logo_assignment_kevin:
  id: <%= ActiveRecord::FixtureSet.identify("logo_assignment_kevin", :uuid) %>
  user: kevin_uuid
  source: logo_assignment_km_uuid (Event)
  created_at: <%= 1.week.ago %>
  creator: david_uuid
  account: 37s_uuid
layout_commented_kevin:
  id: <%= ActiveRecord::FixtureSet.identify("layout_commented_kevin", :uuid) %>
  user: kevin_uuid
  source: layout_commented_uuid (Event)
  created_at: <%= 1.week.ago %>
  creator: david_uuid
  account: 37s_uuid
logo_card_david_mention_by_jz:
  id: <%= ActiveRecord::FixtureSet.identify("logo_card_david_mention_by_jz_notif", :uuid) %>
  user: david_uuid
  source: logo_card_david_mention_by_jz_uuid (Mention)
  created_at: <%= 1.week.ago %>
  creator: david_uuid
  account: 37s_uuid
logo_comment_david_mention_by_jz:
  id: <%= ActiveRecord::FixtureSet.identify("logo_comment_david_mention_by_jz_notif", :uuid) %>
  user: david_uuid
  source: logo_comment_david_mention_by_jz_uuid (Mention)
  created_at: <%= 1.week.ago %>
  creator: david_uuid
  account: 37s_uuid

================
File: test/fixtures/pins.yml
================
logo_kevin:
  id: <%= ActiveRecord::FixtureSet.identify("logo_kevin_pin", :uuid) %>
  account: 37s_uuid
  card: logo_uuid
  user: kevin_uuid
shipping_kevin:
  id: <%= ActiveRecord::FixtureSet.identify("shipping_kevin_pin", :uuid) %>
  account: 37s_uuid
  card: shipping_uuid
  user: kevin_uuid

================
File: test/fixtures/reactions.yml
================
kevin:
  id: <%= ActiveRecord::FixtureSet.identify("kevin_reaction", :uuid) %>
  account: 37s_uuid
  content: ""
  reactable: logo_agreement_jz_uuid (Comment)
  reacter: kevin_uuid
david:
  id: <%= ActiveRecord::FixtureSet.identify("david_reaction", :uuid) %>
  account: 37s_uuid
  content: ""
  reactable: logo_agreement_jz_uuid (Comment)
  reacter: david_uuid
logo_card_kevin:
  id: <%= ActiveRecord::FixtureSet.identify("logo_card_kevin_reaction", :uuid) %>
  account: 37s_uuid
  content: ""
  reactable: logo_uuid (Card)
  reacter: kevin_uuid
logo_card_david:
  id: <%= ActiveRecord::FixtureSet.identify("logo_card_david_reaction", :uuid) %>
  account: 37s_uuid
  content: ""
  reactable: logo_uuid (Card)
  reacter: david_uuid

================
File: test/fixtures/sessions.yml
================
david:
  identity: david
kevin:
  identity: kevin
jz:
  identity: jz
jason:
  identity: jason
mike:
  identity: mike

================
File: test/fixtures/taggings.yml
================
logo_web:
  id: <%= ActiveRecord::FixtureSet.identify("logo_web_tagging", :uuid) %>
  account: 37s_uuid
  card: logo_uuid
  tag: web_uuid
layout_web:
  id: <%= ActiveRecord::FixtureSet.identify("layout_web_tagging", :uuid) %>
  account: 37s_uuid
  card: layout_uuid
  tag: web_uuid
layout_mobile:
  id: <%= ActiveRecord::FixtureSet.identify("layout_mobile_tagging", :uuid) %>
  account: 37s_uuid
  card: layout_uuid
  tag: mobile_uuid
text_mobile:
  id: <%= ActiveRecord::FixtureSet.identify("text_mobile_tagging", :uuid) %>
  account: 37s_uuid
  card: text_uuid
  tag: mobile_uuid

================
File: test/fixtures/tags.yml
================
web:
  id: <%= ActiveRecord::FixtureSet.identify("web", :uuid) %>
  title: web
  account: 37s_uuid
mobile:
  id: <%= ActiveRecord::FixtureSet.identify("mobile", :uuid) %>
  title: mobile
  account: 37s_uuid

================
File: test/fixtures/users.yml
================
david:
  id: <%= ActiveRecord::FixtureSet.identify("david", :uuid) %>
  name: David
  role: member
  identity: david
  account: 37s_uuid
  verified_at: <%= Time.current.to_fs(:db) %>
jz:
  id: <%= ActiveRecord::FixtureSet.identify("jz", :uuid) %>
  name: JZ
  role: member
  identity: jz
  account: 37s_uuid
  verified_at: <%= Time.current.to_fs(:db) %>
jason:
  id: <%= ActiveRecord::FixtureSet.identify("jason", :uuid) %>
  name: Jason
  role: owner
  identity: jason
  account: 37s_uuid
  verified_at: <%= Time.current.to_fs(:db) %>
kevin:
  id: <%= ActiveRecord::FixtureSet.identify("kevin", :uuid) %>
  name: Kevin
  role: admin
  identity: kevin
  account: 37s_uuid
  verified_at: <%= Time.current.to_fs(:db) %>
system:
  id: <%= ActiveRecord::FixtureSet.identify("system", :uuid) %>
  name: System
  role: system
  account: 37s_uuid
mike:
  id: <%= ActiveRecord::FixtureSet.identify("mike", :uuid) %>
  name: Mike
  role: admin
  identity: mike
  account: initech_uuid
  verified_at: <%= Time.current.to_fs(:db) %>
system_initech:
  id: <%= ActiveRecord::FixtureSet.identify("system_initech", :uuid) %>
  name: System
  role: system
  account: initech_uuid

================
File: test/fixtures/watches.yml
================
logo_david:
  id: <%= ActiveRecord::FixtureSet.identify("logo_david_watch", :uuid) %>
  account: 37s_uuid
  card: logo_uuid
  user: david_uuid
  watching: true
logo_kevin:
  id: <%= ActiveRecord::FixtureSet.identify("logo_kevin_watch", :uuid) %>
  account: 37s_uuid
  card: logo_uuid
  user: kevin_uuid
  watching: true
layout_david:
  id: <%= ActiveRecord::FixtureSet.identify("layout_david_watch", :uuid) %>
  account: 37s_uuid
  card: layout_uuid
  user: david_uuid
  watching: true
layout_kevin:
  id: <%= ActiveRecord::FixtureSet.identify("layout_kevin_watch", :uuid) %>
  account: 37s_uuid
  card: layout_uuid
  user: kevin_uuid
  watching: true
text_david:
  id: <%= ActiveRecord::FixtureSet.identify("text_david_watch", :uuid) %>
  account: 37s_uuid
  card: text_uuid
  user: david_uuid
  watching: true
text_jz:
  id: <%= ActiveRecord::FixtureSet.identify("text_jz_watch", :uuid) %>
  account: 37s_uuid
  card: text_uuid
  user: jz_uuid
  watching: true
shipping_david:
  id: <%= ActiveRecord::FixtureSet.identify("shipping_david_watch", :uuid) %>
  account: 37s_uuid
  card: shipping_uuid
  user: david_uuid
  watching: true
shipping_jz:
  id: <%= ActiveRecord::FixtureSet.identify("shipping_jz_watch", :uuid) %>
  account: 37s_uuid
  card: shipping_uuid
  user: jz_uuid
  watching: true
shipping_kevin:
  id: <%= ActiveRecord::FixtureSet.identify("shipping_kevin_watch", :uuid) %>
  account: 37s_uuid
  card: shipping_uuid
  user: kevin_uuid
  watching: true

================
File: test/fixtures/webhooks.yml
================
active:
  id: <%= ActiveRecord::FixtureSet.identify("active", :uuid) %>
  active: true
  name: Production API
  url: https://api.example.com/webhooks
  signing_secret: p94Bx2HjempCdYB4DTyZkY1b # gitleaks:allow randomly generated
  subscribed_actions: '<%= %w[ card_published card_assigned card_closed ].to_json %>'
  board: writebook_uuid
  account: 37s_uuid
inactive:
  id: <%= ActiveRecord::FixtureSet.identify("inactive", :uuid) %>
  active: false
  name: Test Webhook
  url: https://test.example.com/webhooks
  signing_secret: H8ms8ADcV92v2x17hnLEiL5m # gitleaks:allow randomly generated
  subscribed_actions: '<%= %w[ card_published card_assigned card_closed ].to_json %>'
  board: private_uuid
  account: 37s_uuid

================
File: test/helpers/.keep
================


================
File: test/helpers/action_text_rendering_test.rb
================
require "test_helper"
class ActionTextRenderingTest < ActionView::TestCase
  test "data-action attributes in user content are stripped" do
    malicious_html = <<~HTML
      <p>Click here: <a href="#" data-action="dangerous#action">malicious link</a></p>
    HTML
    content = ActionText::Content.new(malicious_html)
    rendered = content.to_s
    assert_no_match(/data-action/, rendered)
    assert_match(/<a href="#">malicious link<\/a>/, rendered)
  end
end

================
File: test/helpers/application_helper_test.rb
================
require "test_helper"
class ApplicationHelperTest < ActionView::TestCase
  def parse(html)
    Nokogiri::HTML::DocumentFragment.parse(html)
  end
  test "page_title_tag on untenanted page" do
    Current.account = nil
    assert_select parse(page_title_tag), "title", text: "Fizzy"
  end
  test "page_title_tag on untenanted page with a page title" do
    @page_title = "Holodeck"
    Current.account = nil
    assert_select parse(page_title_tag), "title", text: "Holodeck | Fizzy"
  end
  test "page_title_tag on tenanted page when user has a single account" do
    Current.session = sessions(:david)
    assert_select parse(page_title_tag), "title", text: "Fizzy"
  end
  test "page_title_tag on tenanted page when user has multiple accounts" do
    Current.session = sessions(:david)
    other_account = Account.create!(external_account_id: "dangling-tenant", name: "Other Account")
    identities(:david).users.create!(account: other_account, name: "David")
    assert_select parse(page_title_tag), "title", text: "37signals | Fizzy"
  end
  test "page_title_tag on tenanted page with a page title when user has a single account" do
    Current.session = sessions(:david)
    @page_title = "Holodeck"
    assert_select parse(page_title_tag), "title", text: "Holodeck | Fizzy"
  end
  test "page_title_tag on tenanted page with a page title when user has multiple account" do
    Current.session = sessions(:david)
    other_account = Account.create!(external_account_id: "dangling-tenant", name: "Other Account")
    identities(:david).users.create!(account: other_account, name: "David")
    @page_title = "Holodeck"
    assert_select parse(page_title_tag), "title", text: "Holodeck | 37signals | Fizzy"
  end
end

================
File: test/helpers/entropy_helper_test.rb
================
require "test_helper"
class EntropyHelperTest < ActionView::TestCase
  test "stalled_bubble_options_for returns nil when card has no activity spike" do
    assert_nil stalled_bubble_options_for(cards(:logo))
  end
  test "stalled_bubble_options_for returns options when card has activity spike" do
    card = cards(:logo)
    card.create_activity_spike!
    options = stalled_bubble_options_for(card)
    assert_not_nil options
    assert_equal card.last_activity_spike_at.iso8601, options[:lastActivitySpikeAt]
  end
  test "stalled_bubble_options_for includes updatedAt for client-side staleness check" do
    card = cards(:logo)
    card.create_activity_spike!
    travel_to 3.months.from_now
    # Touch the card to simulate step completion
    card.touch
    options = stalled_bubble_options_for(card)
    # The helper must include updatedAt so JS can check if card was recently updated
    assert_equal card.updated_at.iso8601, options[:updatedAt]
  end
end

================
File: test/helpers/excerpt_helper_test.rb
================
require "test_helper"
class ExcerptHelperTest < ActionView::TestCase
  test "quote" do
    assert_excerpt("> Hello world", ">    Hello world")
  end
  test "ul" do
    assert_excerpt(" Hello world", "-    Hello world")
    assert_excerpt(" Hello world", "  -    Hello world")
  end
  test "ol" do
    assert_excerpt("99. Hello world", "99. Hello world")
  end
  test "large spaces" do
    assert_excerpt("Hello world", "   Hello    world     ")
  end
  test "long text" do
    assert_excerpt("A"*197 + "...", "A"*1000)
    assert_excerpt("A"*97 + "...", "A"*1000, length: 100)
  end
  private
    def assert_excerpt(expected, content, ...)
      assert_equal expected, format_excerpt(ActionText::Content.new(content), ...), "Excerpt of Action Text Content does not match"
      assert_equal expected, format_excerpt(content, ...), "Excerpt of String does not match"
    end
end

================
File: test/helpers/hotkeys_helper_test.rb
================
require "test_helper"
class HotkeysHelperTest < ActionView::TestCase
  include SetPlatform
  test "mac modifier key" do
    emulate_mac
    assert_equal "J", hotkey_label([ "", "J" ])
  end
  test "linux modifier key" do
    emulate_linux
    assert_equal "Ctrl+J", hotkey_label([ "ctrl", "J" ])
  end
  test "mac enter" do
    emulate_mac
    assert_equal "Return+J", hotkey_label([ "enter", "J" ])
  end
  test "linux enter" do
    emulate_linux
    assert_equal "Enter+J", hotkey_label([ "enter", "J" ])
  end
  test "mac hyper" do
    emulate_mac
    assert_equal "Hyper+J", hotkey_label([ "hyper", "J" ])
  end
  test "linux hyper" do
    emulate_linux
    assert_equal "Hyper+J", hotkey_label([ "hyper", "J" ])
  end
  private
    def emulate_mac
      stub_platform = ApplicationPlatform.new("Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.114 Safari/537.36")
      self.stubs(:platform).returns(stub_platform)
    end
    def emulate_linux
      stub_platform = ApplicationPlatform.new("Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.114 Safari/537.36")
      self.stubs(:platform).returns(stub_platform)
    end
end

================
File: test/helpers/html_helper_test.rb
================
require "test_helper"
class HtmlHelperTest < ActionView::TestCase
  test "convert URLs into anchor tags" do
    assert_equal_html \
      %(<p>Check this: <a href="https://example.com" rel="noopener noreferrer">https://example.com</a></p>),
      format_html("<p>Check this: https://example.com</p>")
    assert_equal_html \
      %(<p>Check this: <a href="https://example.com/" rel="noopener noreferrer">https://example.com/</a></p>),
      format_html("<p>Check this: https://example.com/</p>")
  end
  test "convert multiple URLs in the same string" do
    assert_equal_html \
      %(Visit <a href="https://foo.com/" rel="noopener noreferrer">https://foo.com/</a>. Also see <a href="https://bar.com/" rel="noopener noreferrer">https://bar.com/</a>!),
      format_html("Visit https://foo.com/. Also see https://bar.com/!")
  end
  test "don't include punctuation in URL autolinking" do
    assert_equal_html \
      %(<p>Check this: <a href="https://example.com/" rel="noopener noreferrer">https://example.com/</a>!</p>),
      format_html("<p>Check this: https://example.com/!</p>")
    assert_equal_html \
      %(<p>Check this: <a href="https://example.com/" rel="noopener noreferrer">https://example.com/</a>.</p>),
      format_html("<p>Check this: https://example.com/.</p>")
    assert_equal_html \
      %(<p>Check this: <a href="https://example.com/" rel="noopener noreferrer">https://example.com/</a>?</p>),
      format_html("<p>Check this: https://example.com/?</p>")
    assert_equal_html \
      %(<p>Check this: <a href="https://example.com/" rel="noopener noreferrer">https://example.com/</a>,</p>),
      format_html("<p>Check this: https://example.com/,</p>")
    assert_equal_html \
      %(<p>Check this: <a href="https://example.com/" rel="noopener noreferrer">https://example.com/</a>:</p>),
      format_html("<p>Check this: https://example.com/:</p>")
    assert_equal_html \
      %(<p>Check this: <a href="https://example.com/" rel="noopener noreferrer">https://example.com/</a>;</p>),
      format_html("<p>Check this: https://example.com/;</p>")
    assert_equal_html \
      %(<p>Check this: <a href="https://example.com/" rel="noopener noreferrer">https://example.com/</a>"</p>),
      format_html("<p>Check this: https://example.com/\"</p>")
    assert_equal_html \
      %(<p>Check this: <a href="https://example.com/" rel="noopener noreferrer">https://example.com/</a>'</p>),
      format_html("<p>Check this: https://example.com/'</p>")
    # trailing entities that decode to punctuation
    # use assert_equal and not assert_equal_html to make sure we're getting entities correct
    assert_equal \
      %(<p>Check this: <a href="https://example.com/" rel="noopener noreferrer">https://example.com/</a>&lt;</p>),
      format_html("<p>Check this: https://example.com/&lt;</p>")
    assert_equal \
      %(<p>Check this: <a href="https://example.com/" rel="noopener noreferrer">https://example.com/</a>&gt;</p>),
      format_html("<p>Check this: https://example.com/&gt;</p>")
    assert_equal \
      %(<p>Check this: <a href="https://example.com/" rel="noopener noreferrer">https://example.com/</a>"</p>),
      format_html("<p>Check this: https://example.com/&quot;</p>")
    # multiple punctuation characters including entities
    assert_equal_html \
      %(<p>Check this: <a href="https://example.com/" rel="noopener noreferrer">https://example.com/</a>!?;</p>),
      format_html("<p>Check this: https://example.com/!?;</p>")
    assert_equal_html \
      %(&lt;img src="<a href="https://example.com/" rel="noopener noreferrer">https://example.com/</a>"&gt;),
      format_html(%(&lt;img src=&quot;https://example.com/&quot;&gt;))
    assert_equal_html \
      %(&lt;img src="<a href="https://example.com/" rel="noopener noreferrer">https://example.com/</a>"!&gt;),
      format_html(%(&lt;img src=&quot;https://example.com/&quot;!&gt;))
  end
  test "make sure the linked content is properly sanitized" do
    # https://hackerone.com/reports/3481093
    result = format_html(%(https://google.com/\"&gt;test&lt;/a&gt;&lt;input&gt;&lt;/input&gt;))
    assert_no_match(/<input>/i, result, "should not create an input element")
    result = format_html(%(https://google.com/\"&gt;&lt;script&gt;alert('xss')&lt;/script&gt;))
    assert_no_match(/<script>/i, result, "should not create a script element")
  end
  test "handle URLs with query parameters" do
    # use assert_equal and not assert_equal_html to make sure we're getting entities correct
    assert_equal \
      %(<p>Check this: <a href="https://example.com/a?b=c&amp;d=e" rel="noopener noreferrer">https://example.com/a?b=c&amp;d=e</a></p>),
      format_html("<p>Check this: https://example.com/a?b=c&amp;d=e</p>")
    assert_equal \
      %(<p>Check this: <a href="https://example.com/a?b=c&amp;d=e" rel="noopener noreferrer">https://example.com/a?b=c&amp;d=e</a></p>),
      format_html("<p>Check this: https://example.com/a?b=c&d=e</p>")
  end
  test "respect existing links" do
    assert_equal_html \
      %(<p>Check this: <a href="https://example.com">https://example.com</a></p>),
      format_html("<p>Check this: <a href=\"https://example.com\">https://example.com</a></p>")
  end
  test "convert email addresses into mailto links" do
    assert_equal_html \
      %(<p>Contact us at <a href="mailto:support@example.com" rel="noopener noreferrer">support@example.com</a></p>),
      format_html("<p>Contact us at support@example.com</p>")
  end
  test "respect existing linked emails" do
    assert_equal_html \
      %(<p>Contact us at <a href="mailto:support@example.com">support@example.com</a></p>),
      format_html(%(<p>Contact us at <a href="mailto:support@example.com">support@example.com</a></p>))
  end
  test "don't autolink content in excluded elements" do
    %w[ figcaption pre code ].each do |element|
      assert_equal_html \
        "<#{element}>Check this: https://example.com</#{element}>",
        format_html("<#{element}>Check this: https://example.com</#{element}>")
    end
  end
  test "preserve escaped HTML containing URLs" do
    input = 'before text &lt;img src="https://example.com/image.png"&gt; after text'
    output = format_html(input)
    assert_no_match(/<img/, output, "should not create an img element")
    assert_includes output, "&lt;img"
  end
end

================
File: test/integration/active_storage_authorization_test.rb
================
require "test_helper"
class ActiveStorageAuthorizationTest < ActionDispatch::IntegrationTest
  setup do
    Current.session = sessions(:david)
    @account = accounts("37s")
    @board = boards(:writebook)
    @card = cards(:logo)
    @blob = attach_blob_to_card(@card)
  end
  test "authenticated user with board access can view blob" do
    sign_in_as :david
    get rails_blob_path(@blob, disposition: :inline)
    assert_response :redirect
    assert_match %r{rails/active_storage}, response.location
  end
  test "authenticated user without board access cannot view blob" do
    sign_in_as :mike
    get rails_blob_path(@blob, disposition: :inline)
    assert_response :forbidden
  end
  test "unauthenticated user cannot view blob" do
    get rails_blob_path(@blob, disposition: :inline)
    assert_response :redirect
    assert_match %r{/session/new}, response.location
  end
  test "authenticated user with board access can view representation" do
    sign_in_as :david
    get rails_representation_path(@blob.representation(resize_to_limit: [ 100, 100 ]))
    assert_response :redirect
    assert_match %r{rails/active_storage/}, response.location
  end
  test "authenticated user without board access cannot view representation" do
    sign_in_as :mike
    get rails_representation_path(@blob.representation(resize_to_limit: [ 100, 100 ]))
    assert_response :forbidden
  end
  test "unauthenticated user can view blob on published board with published card" do
    @board.publish
    get rails_blob_path(@blob, disposition: :inline)
    assert_response :redirect
    assert_match %r{rails/active_storage}, response.location
  end
  test "unauthenticated user cannot view blob on published board with draft card" do
    @board.publish
    # Create the draft card and attachment with proper Current context
    draft_blob = nil
    Current.with(account: @account, session: sessions(:david)) do
      draft_card = @board.cards.create!(title: "Draft", status: :drafted, creator: users(:david))
      draft_card.image.attach io: file_fixture("moon.jpg").open, filename: "draft.jpg", content_type: "image/jpeg"
      draft_blob = draft_card.image.blob
    end
    get rails_blob_path(draft_blob, disposition: :inline)
    assert_response :redirect
    assert_match %r{/session/new}, response.location
  end
  # Rich text embeds in cards
  test "authenticated user with board access can view rich text embed in card" do
    sign_in_as :david
    blob = attach_blob_as_rich_text_embed(@card)
    get rails_blob_path(blob, disposition: :inline)
    assert_response :redirect
    assert_match %r{rails/active_storage}, response.location
  end
  test "authenticated user without board access cannot view rich text embed in card" do
    sign_in_as :mike
    blob = attach_blob_as_rich_text_embed(@card)
    get rails_blob_path(blob, disposition: :inline)
    assert_response :forbidden
  end
  test "unauthenticated user can view rich text embed in card on published board" do
    @board.publish
    blob = attach_blob_as_rich_text_embed(@card)
    get rails_blob_path(blob, disposition: :inline)
    assert_response :redirect
    assert_match %r{rails/active_storage}, response.location
  end
  # Rich text embeds in comments
  test "authenticated user with board access can view rich text embed in comment" do
    sign_in_as :david
    comment = comments(:logo_1)
    blob = attach_blob_as_rich_text_embed(comment)
    get rails_blob_path(blob, disposition: :inline)
    assert_response :redirect
    assert_match %r{rails/active_storage}, response.location
  end
  test "authenticated user without board access cannot view rich text embed in comment" do
    sign_in_as :mike
    comment = comments(:logo_1)
    blob = attach_blob_as_rich_text_embed(comment)
    get rails_blob_path(blob, disposition: :inline)
    assert_response :forbidden
  end
  test "unauthenticated user can view rich text embed in comment on published board" do
    @board.publish
    comment = comments(:logo_1)
    blob = attach_blob_as_rich_text_embed(comment)
    get rails_blob_path(blob, disposition: :inline)
    assert_response :redirect
    assert_match %r{rails/active_storage}, response.location
  end
  test "unauthenticated user can view avatar" do
    blob = attach_avatar_to(users(:david))
    get rails_blob_path(blob, disposition: :inline)
    assert_response :redirect
    assert_match %r{rails/active_storage}, response.location
  end
  test "unauthenticated user can view avatar thumbnail" do
    blob = attach_avatar_to(users(:david))
    get rails_representation_path(blob.representation(resize_to_fill: [ 256, 256 ]))
    assert_response :redirect
    assert_match %r{rails/active_storage}, response.location
  end
  # Account exports
  test "export owner can download their export" do
    sign_in_as :david
    blob = create_export_blob_for(users(:david))
    get rails_blob_path(blob, disposition: :attachment)
    assert_response :redirect
    assert_match %r{rails/active_storage}, response.location
  end
  test "non-owner cannot download another user's export" do
    sign_in_as :jz
    blob = create_export_blob_for(users(:david))
    get rails_blob_path(blob, disposition: :attachment)
    assert_response :forbidden
  end
  test "unauthenticated user cannot download export" do
    blob = create_export_blob_for(users(:david))
    get rails_blob_path(blob, disposition: :attachment)
    assert_response :redirect
    assert_match %r{/session/new}, response.location
  end
  private
    def attach_blob_to_card(card)
      Current.with(session: sessions(:david)) do
        card.image.attach io: file_fixture("moon.jpg").open, filename: "test.jpg", content_type: "image/jpeg"
        card.image.blob
      end
    end
    def attach_blob_as_rich_text_embed(container)
      Current.with(account: @account, session: sessions(:david)) do
        blob = ActiveStorage::Blob.create_and_upload! \
          io: file_fixture("moon.jpg").open,
          filename: "embed.jpg",
          content_type: "image/jpeg"
        attachment_html = ActionText::Attachment.from_attachable(blob).to_html
        if container.respond_to?(:description)
          container.update!(description: "<p>Description with image: #{attachment_html}</p>")
        else
          container.update!(body: "<p>Body with image: #{attachment_html}</p>")
        end
        blob.reload
      end
    end
    def create_export_blob_for(user)
      export = Account::Export.create!(account: @account, user: user)
      export.file.attach io: StringIO.new("test export content"), filename: "export.zip", content_type: "application/zip"
      export.file.blob
    end
    def attach_avatar_to(user)
      Current.with(account: @account, session: sessions(:david)) do
        user.avatar.attach io: file_fixture("moon.jpg").open, filename: "avatar.jpg", content_type: "image/jpeg"
        user.avatar.blob
      end
    end
end

================
File: test/integration/card_preview_boost_count_test.rb
================
require "test_helper"
class CardPreviewBoostCountTest < ActionDispatch::IntegrationTest
  setup do
    sign_in_as :kevin
    @card_with_reactions = cards(:logo)
    @card_without_reactions = cards(:layout)
    @column = @card_with_reactions.column
  end
  test "card preview displays boost count when card has reactions" do
    get board_column_path(@column.board, @column)
    assert_response :success
    # Check that boost count is displayed for cards with reactions
    assert_select ".card__boosts", text: /2/
  end
  test "card preview does not display boost count when card has no reactions" do
    # Ensure layout card is in the same column for this test
    @card_without_reactions.update!(column: @column)
    get board_column_path(@column.board, @column)
    assert_response :success
    # Find the card without reactions and verify no boost count is shown
    # We check the overall page doesn't have a boost count for zero reactions
    # (This is an imperfect test but reasonable given the structure)
    assert @card_without_reactions.reactions.none?
  end
end

================
File: test/jobs/account/data_import_job_test.rb
================
require "test_helper"
class Account::DataImportJobTest < ActiveJob::TestCase
  test "performs import via continuable steps" do
    source_account = accounts("37s")
    exporter = users(:david)
    identity = exporter.identity
    export = Account::Export.create!(account: source_account, user: exporter)
    export.build
    export_tempfile = Tempfile.new([ "export", ".zip" ])
    export.file.open { |f| FileUtils.cp(f.path, export_tempfile.path) }
    source_account.destroy!
    target_account = Account.create_with_owner(account: { name: "Import Test" }, owner: { identity: identity, name: exporter.name })
    import = Account::Import.create!(identity: identity, account: target_account)
    Current.set(account: target_account) do
      import.file.attach(io: File.open(export_tempfile.path), filename: "export.zip", content_type: "application/zip")
    end
    Account::DataImportJob.perform_now(import)
    assert import.reload.completed?
  ensure
    export_tempfile&.close
    export_tempfile&.unlink
  end
end

================
File: test/jobs/account/incinerate_due_job_test.rb
================
require "test_helper"
class Account::IncinerateDueJobTest < ActiveJob::TestCase
  setup do
    @account = accounts(:"37s")
    @user = users(:david)
    # Stub Stripe methods only in SaaS mode
    if defined?(Stripe::Subscription)
      Stripe::Subscription.stubs(:update).returns(true)
      Stripe::Subscription.stubs(:cancel).returns(true)
    end
  end
  test "finds accounts up for incineration" do
    @account.cancel(initiated_by: @user)
    @account.cancellation.update!(created_at: 31.days.ago)
    Account.any_instance.expects(:incinerate).once
    Account::IncinerateDueJob.perform_now
  end
  test "incinerates each old cancelled account" do
    # Cancel the test account
    @account.cancel(initiated_by: @user)
    @account.cancellation.update!(created_at: 31.days.ago)
    # Just verify it gets incinerated
    assert_difference -> { Account.count }, -1 do
      Account::IncinerateDueJob.perform_now
    end
  end
  test "skips recent cancellations" do
    @account.cancel(initiated_by: @user)
    @account.cancellation.update!(created_at: 29.days.ago)
    assert_no_difference -> { Account.count } do
      Account::IncinerateDueJob.perform_now
    end
  end
  test "handles cursor pagination correctly" do
    # Cancel and age the account
    @account.cancel(initiated_by: @user)
    @account.cancellation.update!(created_at: 31.days.ago)
    # Verify it processes accounts in the scope
    assert_difference -> { Account.count }, -1 do
      Account::IncinerateDueJob.perform_now
    end
  end
  test "only incinerates accounts past grace period" do
    # Account at 29 days (within grace period - should not be incinerated)
    @account.cancel(initiated_by: @user)
    @account.cancellation.update!(created_at: 29.days.ago)
    assert_no_difference -> { Account.count } do
      Account::IncinerateDueJob.perform_now
    end
    # The account should still exist
    assert Account.exists?(@account.id)
  end
end

================
File: test/jobs/storage/materialize_job_test.rb
================
require "test_helper"
class Storage::MaterializeJobTest < ActiveJob::TestCase
  setup do
    @account = accounts("37s")
    @board = boards(:writebook)
  end
  test "calls materialize_storage on account" do
    Storage::Entry.record(account: @account, delta: 1024, operation: "attach")
    Storage::MaterializeJob.perform_now(@account)
    assert_not_nil @account.storage_total
    assert_equal 1024, @account.bytes_used
  end
  test "calls materialize_storage on board" do
    Storage::Entry.record(account: @account, board: @board, delta: 2048, operation: "attach")
    Storage::MaterializeJob.perform_now(@board)
    assert_not_nil @board.storage_total
    assert_equal 2048, @board.bytes_used
  end
  test "job is idempotent" do
    Storage::Entry.record(account: @account, delta: 1024, operation: "attach")
    3.times { Storage::MaterializeJob.perform_now(@account) }
    assert_equal 1024, @account.bytes_used
  end
  test "job processes entries added between runs" do
    Storage::Entry.record(account: @account, delta: 1000, operation: "attach")
    Storage::MaterializeJob.perform_now(@account)
    # Small delay to ensure UUIDv7 timestamp advances
    travel 1.second
    Storage::Entry.record(account: @account, delta: 500, operation: "attach")
    Storage::MaterializeJob.perform_now(@account)
    assert_equal 1500, @account.bytes_used
  end
  test "job queued to backend queue" do
    assert_equal "backend", Storage::MaterializeJob.new.queue_name
  end
  test "job has concurrency limit by owner" do
    job = Storage::MaterializeJob.new(@account)
    # limits_concurrency is a Solid Queue feature
    # Just verify the job can be instantiated and has the correct queue
    assert_equal "backend", job.queue_name
  end
end

================
File: test/jobs/storage/reconcile_job_test.rb
================
require "test_helper"
class Storage::ReconcileJobTest < ActiveJob::TestCase
  setup do
    Current.session = sessions(:david)
    @account = accounts("37s")
    @board = @account.boards.create!(name: "Test Board", creator: users(:david))
    @card = @board.cards.create!(title: "Test Card", creator: users(:david))
  end
  test "reconcile_storage corrects drift when ledger undercounts" do
    @card.image.attach io: StringIO.new("x" * 1000), filename: "test.png", content_type: "image/png"
    Storage::Entry.where(board: @board).delete_all
    Storage::ReconcileJob.perform_now(@board)
    entry = Storage::Entry.find_by(board: @board, operation: "reconcile")
    assert_not_nil entry
    assert_equal 1000, entry.delta
  end
  test "reconcile_storage corrects drift when ledger overcounts" do
    Storage::Entry.create! \
      account_id: @account.id,
      board_id: @board.id,
      delta: 5000,
      operation: "attach"
    Storage::ReconcileJob.perform_now(@board)
    entry = Storage::Entry.find_by(board: @board, operation: "reconcile")
    assert_not_nil entry
    assert_equal(-5000, entry.delta)
  end
  test "reconcile_storage creates no entry when ledger matches reality" do
    @card.image.attach io: StringIO.new("x" * 1000), filename: "test.png", content_type: "image/png"
    initial_count = Storage::Entry.where(board: @board).count
    Storage::ReconcileJob.perform_now(@board)
    assert_equal initial_count, Storage::Entry.where(board: @board).count
  end
  test "job queued to backend queue" do
    assert_equal "backend", Storage::ReconcileJob.new.queue_name
  end
  test "job has concurrency limit by owner" do
    job = Storage::ReconcileJob.new(@board)
    # limits_concurrency is a Solid Queue feature
    # Just verify the job can be instantiated and has the correct queue
    assert_equal "backend", job.queue_name
  end
  test "job raises ReconcileAborted when reconcile fails" do
    # Use perform_now with a fresh board that we can stub
    board = @account.boards.create!(name: "Abort Test Board", creator: users(:david))
    # Prepend a module to intercept reconcile_storage
    intercept = Module.new do
      def reconcile_storage
        false
      end
    end
    board.singleton_class.prepend(intercept)
    assert_raises Storage::ReconcileJob::ReconcileAborted do
      # Call perform directly to avoid serialization
      Storage::ReconcileJob.new.perform(board)
    end
  end
end

================
File: test/jobs/delete_unused_tags_job_test.rb
================
require "test_helper"
class DeleteUnusedTagsJobTest < ActiveJob::TestCase
  test "deletes tags that are not used by any cards" do
    unused = Tag.create!(title: "unused")
    assert_changes -> { Tag.count }, -1 do
      DeleteUnusedTagsJob.perform_now
    end
    assert_not Tag.exists?(unused.id), "Unused tag should be deleted"
  end
end

================
File: test/lib/rails_ext/active_record_uuid_type_test.rb
================
require "test_helper"
class ActiveRecordUuidTypeTest < ActiveSupport::TestCase
  setup do
    @type = ActiveRecord::Type::Uuid.new
    @sample_uuid = "01jcqzx8h0000000000000000" # base36 UUID
  end
  test "cast nil returns nil" do
    assert_nil @type.cast(nil)
  end
  test "cast returns value as-is" do
    result = @type.cast(@sample_uuid)
    assert_equal @sample_uuid, result
  end
  test "serialize returns binary Data object" do
    result = @type.serialize(@sample_uuid)
    assert_instance_of ActiveModel::Type::Binary::Data, result
    assert_equal 16, result.to_s.bytesize
    assert_equal Encoding::BINARY, result.to_s.encoding
  end
  test "serialize nil returns nil" do
    assert_nil @type.serialize(nil)
  end
  test "deserialize converts binary to base36" do
    binary_data = @type.serialize(@sample_uuid)
    result = @type.deserialize(binary_data)
    assert_equal @sample_uuid, result
  end
  test "deserialize handles raw binary string" do
    binary_data = @type.serialize(@sample_uuid)
    raw_binary = binary_data.to_s
    result = @type.deserialize(raw_binary)
    assert_equal @sample_uuid, result
  end
  test "deserialize nil returns nil" do
    assert_nil @type.deserialize(nil)
  end
end

================
File: test/lib/rails_ext/active_storage_blob_service_url_for_direct_upload_expiry_test.rb
================
require "test_helper"
class ActiveStorageBlobServiceUrlForDirectUploadExpiryTest < ActiveSupport::TestCase
  setup do
    @blob = ActiveStorage::Blob.new(key: "test", filename: "test.txt", byte_size: 1024, checksum: "abc")
  end
  test "uses extended expiry by default" do
    @blob.service.expects(:url_for_direct_upload).with(@blob.key, expires_in: ActiveStorage.service_urls_for_direct_uploads_expire_in, content_type: @blob.content_type, content_length: @blob.byte_size, checksum: @blob.checksum, custom_metadata: {}).returns("https://example.com/upload")
    assert_equal "https://example.com/upload", @blob.service_url_for_direct_upload
  end
  test "service_urls_for_direct_uploads_expire_in is configurable" do
    original_expire_in = ActiveStorage.service_urls_for_direct_uploads_expire_in
    ActiveStorage.service_urls_for_direct_uploads_expire_in = 96.hours
    @blob.service.expects(:url_for_direct_upload).with(@blob.key, expires_in: 96.hours, content_type: @blob.content_type, content_length: @blob.byte_size, checksum: @blob.checksum, custom_metadata: {}).returns("https://example.com/upload")
    assert_equal "https://example.com/upload", @blob.service_url_for_direct_upload
  ensure
    ActiveStorage.service_urls_for_direct_uploads_expire_in = original_expire_in
  end
end

================
File: test/lib/rails_ext/string_test.rb
================
require "test_helper"
class StringTest < ActiveSupport::TestCase
  test "#all_emoji?" do
    assert "".all_emoji?
    assert "".all_emoji?
    assert_not "Hello ".all_emoji?
    assert_not "Hello".all_emoji?
  end
end

================
File: test/lib/web_push/persistent_request_test.rb
================
require "test_helper"
class WebPush::PersistentRequestTest < ActiveSupport::TestCase
  PUBLIC_TEST_IP = "142.250.185.206"
  ENDPOINT = "https://fcm.googleapis.com/fcm/send/test123"
  test "pins connection to endpoint_ip" do
    request = stub_request(:post, ENDPOINT)
      .with(ipaddr: PUBLIC_TEST_IP)
      .to_return(status: 201)
    notification = WebPush::Notification.new(
      title: "Test",
      body: "Test notification",
      path: "/test",
      badge: 0,
      endpoint: ENDPOINT,
      endpoint_ip: PUBLIC_TEST_IP,
      p256dh_key: "BNcRdreALRFXTkOOUHK1EtK2wtaz5Ry4YfYCA_0QTpQtUbVlUls0VJXg7A8u-Ts1XbjhazAkj7I99e8QcYP7DkM",
      auth_key: "tBHItJI5svbpez7KI4CCXg"
    )
    notification.deliver
    assert_requested request
  end
end

================
File: test/lib/true_client_ip_test.rb
================
require "test_helper"
class TrackTrueClientIpTest < ActiveSupport::TestCase
  setup do
    @app = ->(env) { [ 200, {}, [ "OK" ] ] }
    @middleware = TrackTrueClientIp.new(@app)
  end
  test "sets X-Forwarded-For header when True-Client-IP header is present" do
    env = { "HTTP_TRUE_CLIENT_IP" => "123.123.123.123" }
    @middleware.call(env)
    assert_equal "123.123.123.123", env["HTTP_X_FORWARDED_FOR"]
  end
  test "does not modify environment when True-Client-IP header is absent" do
    env = {}
    @middleware.call(env)
    assert_nil env["HTTP_X_FORWARDED_FOR"]
    env = { "HTTP_X_FORWARDED_FOR" => "234.234.234.234" }
    @middleware.call(env)
    assert_equal "234.234.234.234", env["HTTP_X_FORWARDED_FOR"]
  end
  test "calls the next middleware in the stack" do
    called = false
    app = ->(env) { called = true; [ 200, {}, [ "OK" ] ] }
    middleware = TrackTrueClientIp.new(app)
    middleware.call({})
    assert called
  end
end

================
File: test/mailers/notification/bundle_mailer_test.rb
================
require "test_helper"
class Notification::BundleMailerTest < ActionMailer::TestCase
  setup do
    @user = users(:david)
    @bundle = Notification::Bundle.create!(
      user: @user,
      starts_at: 1.hour.ago,
      ends_at: 1.hour.from_now
    )
  end
  test "renders avatar with initials in span when avatar is not attached" do
    create_notification(@user)
    email = Notification::BundleMailer.notification(@bundle)
    assert_match /<span[^>]*class="avatar"[^>]*>/, email.html_part.body.to_s
    assert_match /#{@user.initials}/, email.html_part.body.to_s
    assert_match /style="background-color: #[A-F0-9]{6};?"/, email.html_part.body.to_s
  end
  test "renders avatar with external image URL when avatar is attached" do
    @user.avatar.attach(
      io: File.open(Rails.root.join("test", "fixtures", "files", "avatar.png")),
      filename: "avatar.png",
      content_type: "image/png"
    )
    create_notification(@user)
    email = Notification::BundleMailer.notification(@bundle)
    assert_match /<img[^>]*class="avatar"[^>]*>/, email.html_part.body.to_s
    assert_match /<img[^>]*class="avatar"[^>]*src="[^"]*"/, email.html_part.body.to_s
    assert_match /alt="#{@user.name}"/, email.html_part.body.to_s
  end
  private
    def create_notification(user)
      Notification.create!(user: user, creator: user, source: events(:logo_published), created_at: 30.minutes.ago)
    end
end

================
File: test/mailers/previews/notification/bundle_mailer_preview.rb
================
class Notification::BundleMailerPreview < ActionMailer::Preview
  def notification
    bundle = Notification::Bundle.all.sample
    Current.account = bundle.account
    Notification::BundleMailer.notification bundle
  end
end

================
File: test/mailers/previews/export_mailer_preview.rb
================
class ExportMailerPreview < ActionMailer::Preview
  def completed
    export = Account::Export.new(
      id: "preview-export-id",
      account: Account.first,
      user: User.first
    )
    ExportMailer.completed(export)
  end
end

================
File: test/mailers/previews/magic_link_mailer_preview.rb
================
class MagicLinkMailerPreview < ActionMailer::Preview
  def magic_link
    identity = Identity.new email_address: "test@example.com"
    magic_link = MagicLink.new(identity: identity)
    magic_link.valid?
    MagicLinkMailer.sign_in_instructions(magic_link)
  end
end

================
File: test/mailers/previews/user_mailer_preview.rb
================
class UserMailerPreview < ActionMailer::Preview
  def email_change_confirmation
    new_email_address = "new.email@example.com"
    user = User.active.sample
    token = user.send(:generate_email_address_change_token, to: new_email_address)
    Current.account = user.account
    UserMailer.email_change_confirmation(
      email_address: new_email_address,
      token: token,
      user: user
    )
  end
end

================
File: test/mailers/.keep
================


================
File: test/mailers/account_mailer_test.rb
================
require "test_helper"
class AccountMailerTest < ActionMailer::TestCase
  setup do
    @account = accounts(:"37s")
    @user = users(:david)
    @account.cancel(initiated_by: @user)
    @cancellation = @account.cancellation
  end
  test "cancellation sends to initiating user" do
    email = AccountMailer.cancellation(@cancellation)
    assert_emails 1 do
      email.deliver_now
    end
    assert_equal [ @user.identity.email_address ], email.to
  end
  test "cancellation includes account name" do
    email = AccountMailer.cancellation(@cancellation)
    assert_match @account.name, email.body.encoded
  end
  test "cancellation includes support email" do
    email = AccountMailer.cancellation(@cancellation)
    assert_match "support@fizzy.do", email.body.encoded
  end
  test "cancellation has correct subject" do
    email = AccountMailer.cancellation(@cancellation)
    assert_equal "Your Fizzy account was cancelled", email.subject
  end
  test "cancellation has both HTML and text parts" do
    email = AccountMailer.cancellation(@cancellation)
    assert email.html_part.present?, "Email should have HTML part"
    assert email.text_part.present?, "Email should have text part"
  end
  test "cancellation mentions account access is removed" do
    email = AccountMailer.cancellation(@cancellation)
    assert_match /no one can access/i, email.body.encoded
  end
  test "cancellation mentions data will be deleted" do
    email = AccountMailer.cancellation(@cancellation)
    assert_match /deleted/i, email.body.encoded
  end
end

================
File: test/mailers/export_mailer_test.rb
================
require "test_helper"
class ExportMailerTest < ActionMailer::TestCase
  test "completed for account export" do
    export = Account::Export.create!(account: Current.account, user: users(:david))
    email = ExportMailer.completed(export)
    assert_emails 1 do
      email.deliver_now
    end
    assert_equal [ "david@37signals.com" ], email.to
    assert_equal "Your Fizzy data export is ready for download", email.subject
    assert_match %r{/exports/#{export.id}}, email.body.encoded
  end
  test "completed for user data export" do
    export = User::DataExport.create!(account: Current.account, user: users(:david))
    email = ExportMailer.completed(export)
    assert_emails 1 do
      email.deliver_now
    end
    assert_equal [ "david@37signals.com" ], email.to
    assert_equal "Your Fizzy data export is ready for download", email.subject
    assert_match %r{/users/#{export.user.id}/data_exports/#{export.id}}, email.body.encoded
  end
end

================
File: test/mailers/import_mailer_test.rb
================
require "test_helper"
class ImportMailerTest < ActionMailer::TestCase
  test "completed" do
    email = ImportMailer.completed(identities(:david), accounts(:"37s"))
    assert_emails 1 do
      email.deliver_now
    end
    assert_equal [ "david@37signals.com" ], email.to
    assert_equal "Your Fizzy account import is done", email.subject
    assert_match accounts(:"37s").slug, email.body.encoded
  end
end

================
File: test/mailers/magic_link_mailer_test.rb
================
require "test_helper"
class MagicLinkMailerTest < ActionMailer::TestCase
  test "sign_in_instructions" do
    magic_link = MagicLink.create!(identity: identities(:kevin))
    email = MagicLinkMailer.sign_in_instructions(magic_link)
    assert_emails 1 do
      email.deliver_now
    end
    assert_equal [ "kevin@37signals.com" ], email.to
    assert_equal "Your Fizzy code is #{ magic_link.code }", email.subject
    assert_match magic_link.code, email.body.encoded
  end
end

================
File: test/mailers/smtp_delivery_error_test.rb
================
require "test_helper"
class SmtpDeliveryErrorTest < ActionMailer::TestCase
  class TestMailer < ApplicationMailer
    def smtp_syntax_error(message)
      raise Net::SMTPSyntaxError, Net::SMTP::Response.parse(message)
    end
    def smtp_fatal_error(message)
      raise Net::SMTPFatalError, Net::SMTP::Response.parse(message)
    end
    def ephemeral_retry
      self.class.goes_boom_once
    end
    def self.goes_boom_once
      # Stubbed in test to raise exception once
    end
  end
  tests TestMailer
  test "deliver_later ignores bad recipient addresses" do
    assert_nothing_raised do
      perform_enqueued_jobs only: ActionMailer::MailDeliveryJob do
        TestMailer.smtp_syntax_error("501 5.1.3 Bad recipient address syntax\n").deliver_later
      end
    end
  end
  test "deliver_later ignores rejected recipient addresses" do
    assert_nothing_raised do
      perform_enqueued_jobs only: ActionMailer::MailDeliveryJob do
        TestMailer.smtp_fatal_error("550 5.1.1 fooaddress: Recipient address rejected: User unknown in local recipient table\n").deliver_later
      end
    end
  end
  test "deliver_later re-raises other SMTP syntax errors" do
    perform_enqueued_jobs only: ActionMailer::MailDeliveryJob do
      assert_raises Net::SMTPSyntaxError do
        TestMailer.smtp_syntax_error("not a recipient address error").deliver_later
      end
    end
  end
  [ Net::OpenTimeout, Net::ReadTimeout, Net::SMTPServerBusy.new(Net::SMTP::Response.parse("4xx Server Busy")) ].each do |exception|
    test "deliver_later retries temporary #{exception}" do
      TestMailer.stubs(:goes_boom_once).raises(exception).then.returns(nil)
      perform_enqueued_jobs only: ActionMailer::MailDeliveryJob do
        assert_nothing_raised do
          TestMailer.ephemeral_retry.deliver_later
        end
      end
    end
  end
end

================
File: test/middleware/account_slug_extractor_test.rb
================
require "test_helper"
require "rack/mock"
class AccountSlugExtractorTest < ActiveSupport::TestCase
  test "moves account prefix from PATH_INFO to SCRIPT_NAME" do
    account = accounts(:initech)
    slug = AccountSlug.encode(account.external_account_id)
    captured = call_with_env "/#{slug}/boards"
    assert_equal "/#{slug}", captured.fetch(:script_name)
    assert_equal "/boards", captured.fetch(:path_info)
    assert_equal account.external_account_id, captured.fetch(:external_account_id)
    assert_equal account, captured.fetch(:current_account)
  end
  test "treats a bare account prefix as the root path" do
    account = accounts(:initech)
    slug = AccountSlug.encode(account.external_account_id)
    captured = call_with_env "/#{slug}"
    assert_equal "/#{slug}", captured.fetch(:script_name)
    assert_equal "/", captured.fetch(:path_info)
  end
  test "detects the account prefix when already in SCRIPT_NAME" do
    account = accounts(:initech)
    slug = AccountSlug.encode(account.external_account_id)
    captured = call_with_env "/boards", "SCRIPT_NAME" => "/#{slug}"
    assert_equal "/#{slug}", captured.fetch(:script_name)
    assert_equal "/boards", captured.fetch(:path_info)
    assert_equal account, captured.fetch(:current_account)
  end
  test "clears Current.account when no account prefix is present" do
    captured = call_with_env "/boards"
    assert_equal "", captured.fetch(:script_name)
    assert_equal "/boards", captured.fetch(:path_info)
    assert_nil captured.fetch(:external_account_id)
    assert_nil captured.fetch(:current_account)
  end
  test "encodes account IDs without zero-padding" do
    assert_equal "1", AccountSlug.encode(1)
  end
  test "decodes both padded and non-padded slugs" do
    assert_equal 123, AccountSlug.decode("123")
    assert_equal 123, AccountSlug.decode("0000123")
  end
  private
    def call_with_env(path, extra_env = {})
      captured = {}
      extra_env = { "action_dispatch.routes" => Rails.application.routes }.merge(extra_env)
      app = ->(env) do
        captured[:script_name] = env["SCRIPT_NAME"]
        captured[:path_info] = env["PATH_INFO"]
        captured[:external_account_id] = env["fizzy.external_account_id"]
        captured[:current_account] = Current.account
        [ 200, {}, [ "ok" ] ]
      end
      middleware = AccountSlug::Extractor.new(app)
      middleware.call Rack::MockRequest.env_for(path, extra_env.merge(method: "GET"))
      captured
    end
end

================
File: test/models/account/data_transfer/action_text_rich_text_record_set_test.rb
================
require "test_helper"
class Account::DataTransfer::ActionTextRichTextRecordSetTest < ActiveSupport::TestCase
  test "check rejects ActionText record referencing existing card in another account" do
    importing_account = Account.create!(name: "Importing Account", external_account_id: 99999999)
    victim_card = cards(:logo)
    assert_not_equal importing_account.id, victim_card.account_id, "Card must belong to a different account"
    # Create a malicious ActionText record that points to the victim's card
    malicious_action_text_data = {
      "id" => "malicious_action_text_id_12345",
      "account_id" => importing_account.id,
      "record_type" => "Card",
      "record_id" => victim_card.id,
      "name" => "description",
      "body" => "<p>Injected content from attacker</p>",
      "created_at" => Time.current.iso8601,
      "updated_at" => Time.current.iso8601
    }
    tempfile = Tempfile.new([ "malicious_import", ".zip" ])
    tempfile.binmode
    writer = ZipFile::Writer.new(tempfile)
    writer.add_file("data/action_text_rich_texts/#{malicious_action_text_data['id']}.json", malicious_action_text_data.to_json)
    writer.close
    tempfile.rewind
    reader = ZipFile::Reader.new(tempfile)
    record_set = Account::DataTransfer::ActionTextRichTextRecordSet.new(importing_account)
    error = assert_raises(Account::DataTransfer::RecordSet::IntegrityError) do
      record_set.check(from: reader)
    end
    assert_match(/references existing record.*Card.*#{victim_card.id}/i, error.message)
  ensure
    tempfile&.close
    tempfile&.unlink
    importing_account&.destroy
  end
end

================
File: test/models/account/cancellable_test.rb
================
require "test_helper"
class Account::CancellableTest < ActiveSupport::TestCase
  setup do
    @account = accounts(:"37s")
    @user = users(:david)
  end
  test "cancel" do
    assert_difference -> { Account::Cancellation.count }, 1 do
      assert_enqueued_with(job: ActionMailer::MailDeliveryJob) do
        @account.cancel(initiated_by: @user)
      end
    end
    assert @account.cancelled?
    assert_equal @user, @account.cancellation.initiated_by
  end
  test "cancel does nothing if already cancelled" do
    @account.cancel(initiated_by: @user)
    assert_no_changes -> { @account.cancellation.reload.created_at } do
      @account.cancel(initiated_by: @user)
    end
  end
  test "cancel does nothing when in single-tenant mode" do
    Account.stubs(:accepting_signups?).returns(false)
    assert_no_difference -> { Account::Cancellation.count } do
      @account.cancel(initiated_by: @user)
    end
    assert_not @account.cancelled?
  end
  test "cancelled? returns true when cancellation exists" do
    assert_not @account.cancelled?
    @account.cancel(initiated_by: @user)
    assert @account.cancelled?
  end
  test "reactivate" do
    @account.cancel(initiated_by: @user)
    assert @account.cancelled?
    @account.reactivate
    @account.reload
    assert_not @account.cancelled?
    assert_nil @account.cancellation
  end
  test "reactivate does nothing if not cancelled" do
    assert_not @account.cancelled?
    assert_nothing_raised do
      @account.reactivate
    end
    assert_not @account.cancelled?
  end
  test "active scope excludes cancelled accounts" do
    account2 = accounts(:initech)
    initial_active_count = Account.active.count
    @account.cancel(initiated_by: @user)
    assert_equal initial_active_count - 1, Account.active.count
    assert_not_includes Account.active, @account
    assert_includes Account.active, account2
  end
end

================
File: test/models/account/cancellation_test.rb
================
require "test_helper"
class Account::CancellationTest < ActiveSupport::TestCase
  # test "the truth" do
  #   assert true
  # end
end

================
File: test/models/account/export_test.rb
================
require "test_helper"
class Account::ExportTest < ActiveSupport::TestCase
  test "build_later enqueues DataExportJob" do
    export = Account::Export.create!(account: Current.account, user: users(:david))
    assert_enqueued_with(job: DataExportJob, args: [ export ]) do
      export.build_later
    end
  end
  test "build sets status to failed on error" do
    export = Account::Export.create!(account: Current.account, user: users(:david))
    ZipFile.stubs(:create_for).raises(StandardError.new("Test error"))
    assert_raises(StandardError) do
      export.build
    end
    assert export.failed?
  end
  test "cleanup deletes exports completed more than 24 hours ago" do
    old_export = Account::Export.create!(account: Current.account, user: users(:david), status: :completed, completed_at: 25.hours.ago)
    recent_export = Account::Export.create!(account: Current.account, user: users(:david), status: :completed, completed_at: 23.hours.ago)
    pending_export = Account::Export.create!(account: Current.account, user: users(:david), status: :pending)
    Export.cleanup
    assert_not Export.exists?(old_export.id)
    assert Export.exists?(recent_export.id)
    assert Export.exists?(pending_export.id)
  end
  test "build generates zip with account data" do
    export = Account::Export.create!(account: Current.account, user: users(:david))
    export.build
    assert export.completed?
    assert export.file.attached?
    assert_equal "application/zip", export.file.content_type
  end
  test "build includes blob files in zip" do
    blob = ActiveStorage::Blob.create_and_upload!(
      io: file_fixture("moon.jpg").open,
      filename: "moon.jpg",
      content_type: "image/jpeg"
    )
    export = Account::Export.create!(account: Current.account, user: users(:david))
    export.build
    assert export.completed?
    export.file.open do |file|
      reader = ZipKit::FileReader.read_zip_structure(io: file)
      entry = reader.find { |e| e.filename == "storage/#{blob.key}" }
      assert entry, "Expected blob file in zip"
    end
  end
  test "build succeeds when rich text references missing blob" do
    blob = ActiveStorage::Blob.create_and_upload!(
      io: file_fixture("moon.jpg").open,
      filename: "moon.jpg",
      content_type: "image/jpeg"
    )
    card = cards(:logo)
    card.update!(description: "<action-text-attachment sgid=\"#{blob.attachable_sgid}\"></action-text-attachment>")
    ActiveStorage::Blob.where(id: blob.id).delete_all
    export = Account::Export.create!(account: Current.account, user: users(:david))
    export.build
    assert export.completed?
  end
end

================
File: test/models/account/external_id_sequence_test.rb
================
require "test_helper"
class Account::ExternalIdSequenceTest < ActiveSupport::TestCase
  setup do
    Account::ExternalIdSequence.delete_all
  end
  test "generate sequential values" do
    first_value = Account::ExternalIdSequence.next
    second_value = Account::ExternalIdSequence.next
    third_value = Account::ExternalIdSequence.next
    assert_equal first_value + 1, second_value
    assert_equal second_value + 1, third_value
  end
  test "start from the maximum existing external account id" do
    max_id = Account.maximum(:external_account_id) || 0
    first_value = Account::ExternalIdSequence.next
    assert_equal max_id + 1, first_value
  end
  test "use a single record for the sequence" do
    3.times { Account::ExternalIdSequence.next }
    assert_equal 1, Account::ExternalIdSequence.count
  end
  test "handle concurrent access safely" do
    values = 20.times.map do
      Thread.new do
        Account::ExternalIdSequence.next
      end
    end.map(&:value)
    assert_equal 20, values.uniq.size, "All values should be unique"
    assert_equal values.min..values.max, values.sort.first..values.sort.last
    assert_equal 20, values.max - values.min + 1, "Values should be sequential with no gaps"
  end
  test "#value creates the first record if it doesn't yet exist" do
    assert_nil Account::ExternalIdSequence.first
    value = nil
    assert_difference -> { Account::ExternalIdSequence.count }, 1 do
      value = Account::ExternalIdSequence.value
    end
    assert_not_nil value
    assert_equal value, Account::ExternalIdSequence.first.value
  end
end

================
File: test/models/account/import_test.rb
================
require "test_helper"
class Account::ImportTest < ActiveSupport::TestCase
  test "cleanup deletes completed imports older than 24 hours" do
    identity = identities(:david)
    old_completed = Account::Import.create!(account: Current.account, identity: identity, status: :completed, completed_at: 25.hours.ago)
    recent_completed = Account::Import.create!(account: Current.account, identity: identity, status: :completed, completed_at: 23.hours.ago)
    Account::Import.cleanup
    assert_not Account::Import.exists?(old_completed.id)
    assert Account::Import.exists?(recent_completed.id)
  end
  test "cleanup destroys accounts for failed imports older than 7 days" do
    identity = identities(:david)
    old_failed_account = Account.create!(name: "Old Failed Import")
    old_failed = Account::Import.create!(account: old_failed_account, identity: identity, status: :failed, created_at: 8.days.ago)
    recent_failed_account = Account.create!(name: "Recent Failed Import")
    recent_failed = Account::Import.create!(account: recent_failed_account, identity: identity, status: :failed, created_at: 6.days.ago)
    Account::Import.cleanup
    assert_not Account::Import.exists?(old_failed.id)
    assert_not Account.exists?(old_failed_account.id)
    assert Account::Import.exists?(recent_failed.id)
    assert Account.exists?(recent_failed_account.id)
  end
  test "export and import round-trip preserves account data" do
    source_account = accounts("37s")
    exporter = users(:david)
    identity = exporter.identity
    source_account_digest = account_digest(source_account)
    export = Account::Export.create!(account: source_account, user: exporter)
    export.build
    assert export.completed?
    export_tempfile = Tempfile.new([ "export", ".zip" ])
    export.file.open { |f| FileUtils.cp(f.path, export_tempfile.path) }
    source_account.destroy!
    target_account = Account.create_with_owner(account: { name: "Import Test" }, owner: { identity: identity, name: exporter.name })
    import = Account::Import.create!(identity: identity, account: target_account)
    Current.set(account: target_account) do
      import.file.attach(io: File.open(export_tempfile.path), filename: "export.zip", content_type: "application/zip")
    end
    import.check
    assert_not import.failed?
    import.process
    assert import.completed?
    assert_equal source_account_digest, account_digest(target_account)
  ensure
    export_tempfile&.close
    export_tempfile&.unlink
  end
  private
    def account_digest(account)
      {
        name: account.name,
        board_count: Board.where(account: account).count,
        column_count: Column.where(account: account).count,
        card_count: Card.where(account: account).count,
        comment_count: Comment.where(account: account).count,
        tag_count: Tag.where(account: account).count
      }
    end
end

================
File: test/models/account/incineratable_test.rb
================
require "test_helper"
class Account::IncineratableTest < ActiveSupport::TestCase
  setup do
    @account = accounts(:"37s")
    @user = users(:david)
  end
  test "incinerate destroys account" do
    assert_difference -> { Account.count }, -1 do
      @account.incinerate
    end
    assert_not Account.exists?(@account.id)
  end
  test "due_for_incineration finds old cancellations" do
    @account.cancel(initiated_by: @user)
    @account.cancellation.update!(created_at: 31.days.ago)
    assert_equal [ @account ], Account.due_for_incineration
    @account.cancellation.update!(created_at: 29.days.ago)
    assert Account.due_for_incineration.empty?
  end
end

================
File: test/models/account/join_code_test.rb
================
require "test_helper"
class Account::JoinCodeTest < ActiveSupport::TestCase
  test "generate code" do
    join_code = Account::JoinCode.create!(account: Current.account)
    assert join_code.code.present?
    parts = join_code.code.split("-")
    assert_equal 3, parts.count
  end
  test "redeem_if increments usage_count when block returns true" do
    join_code = account_join_codes(:"37s")
    assert_difference -> { join_code.reload.usage_count }, +1 do
      join_code.redeem_if { true }
    end
  end
  test "redeem_if does not increment usage_count when block returns false" do
    join_code = account_join_codes(:"37s")
    assert_no_difference -> { join_code.reload.usage_count } do
      join_code.redeem_if { false }
    end
  end
  test "reset" do
    join_code = account_join_codes(:"37s")
    original_code = join_code.code
    join_code.reset
    assert_not_equal original_code, join_code.code
    assert_equal 0, join_code.usage_count
  end
end

================
File: test/models/account/multi_tenantable_test.rb
================
require "test_helper"
class Account::MultiTenantableTest < ActiveSupport::TestCase
  test "accepting_signups? is true when multi_tenant is enabled" do
    with_multi_tenant_mode(true) do
      assert Account.accepting_signups?
    end
  end
  test "accepting_signups? is false when multi_tenant is disabled and accounts exist" do
    with_multi_tenant_mode(false) do
      assert_not Account.accepting_signups?
    end
  end
  test "accepting_signups? is true when multi_tenant is disabled but no accounts exist" do
    with_multi_tenant_mode(false) do
      Account.delete_all
      assert Account.accepting_signups?
    end
  end
end

================
File: test/models/account/seedeable_test.rb
================
require "test_helper"
class Account::SedeableTest < ActiveSupport::TestCase
  setup do
    @account = Current.account
  end
  test "setup_customer_template adds boards, cards, and comments" do
    assert_changes -> { Board.count } do
      assert_changes -> { Card.count } do
        @account.setup_customer_template
      end
    end
  end
end

================
File: test/models/board/accessible_test.rb
================
require "test_helper"
class Board::AccessibleTest < ActiveSupport::TestCase
  test "revising access" do
    boards(:writebook).update! all_access: false
    boards(:writebook).accesses.revise granted: users(:david, :jz), revoked: users(:kevin)
    assert_equal users(:david, :jz).to_set, boards(:writebook).users.to_set
    boards(:writebook).accesses.grant_to users(:kevin)
    assert_includes boards(:writebook).users.reload, users(:kevin)
    boards(:writebook).accesses.revoke_from users(:kevin)
    assert_not_includes boards(:writebook).users.reload, users(:kevin)
  end
  test "grants access to everyone after creation" do
    board = Current.set(session: sessions(:david), user: users(:david)) do
      Board.create! name: "New board", all_access: true
    end
    assert_equal accounts("37s").users.active.sort, board.users.sort
  end
  test "grants access to everyone after update" do
    board = Current.set(session: sessions(:david), user: users(:david)) do
      Board.create! name: "New board"
    end
    assert_equal [ users(:david) ], board.users
    board.update! all_access: true
    assert_equal accounts("37s").users.active.sort, board.users.reload.sort
  end
  test "board watchers" do
    boards(:writebook).access_for(users(:kevin)).watching!
    assert_includes boards(:writebook).watchers, users(:kevin)
    boards(:writebook).access_for(users(:kevin)).access_only!
    assert_not_includes boards(:writebook).reload.watchers, users(:kevin)
  end
  # NOTE: The tests for clearing inaccessible data are in +AccessTest+
end

================
File: test/models/board/cards_test.rb
================
require "test_helper"
class Board::CardsTest < ActiveSupport::TestCase
  test "touch cards when the name changes" do
    board = boards(:writebook)
    assert_changes -> { board.cards.first.updated_at } do
      board.update!(name: "New Name")
    end
    assert_no_changes -> { board.cards.first.updated_at } do
      board.update!(updated_at: 1.hour.from_now)
    end
  end
end

================
File: test/models/board/publishable_test.rb
================
require "test_helper"
class Board::PublishableTest < ActiveSupport::TestCase
  setup do
    Current.session = sessions(:david)
  end
  test "published scope" do
    boards(:writebook).publish
    assert_includes Board.published, boards(:writebook)
    assert_not_includes Board.published, boards(:private)
  end
  test "published?" do
    assert_not boards(:writebook).published?
    boards(:writebook).publish
    assert boards(:writebook).published?
  end
  test "publish and unpublish" do
    assert_not boards(:writebook).published?
    assert_difference -> { Board::Publication.count }, +1 do
      boards(:writebook).publish
    end
    assert boards(:writebook).published?
    assert_difference -> { Board::Publication.count }, -1 do
      boards(:writebook).unpublish
    end
    assert_not boards(:writebook).reload.published?
  end
  test "find board by publication key" do
    boards(:writebook).publish
    assert_equal boards(:writebook), Board.find_by_published_key(boards(:writebook).publication.key)
    assert_raise ActiveRecord::RecordNotFound do
      Board.find_by_published_key("invalid")
    end
  end
  test "publish doesn't create duplicate publications" do
    boards(:writebook).publish
    original_publication = boards(:writebook).publication
    assert_no_difference -> { Board::Publication.count } do
      boards(:writebook).publish
    end
    assert_equal original_publication, boards(:writebook).reload.publication
  end
end

================
File: test/models/card/activity_spike/detector_test.rb
================
require "test_helper"
class Card::ActivitySpike::DetectorTest < ActiveSupport::TestCase
  include CardActivityTestHelper
  setup do
    Current.session = sessions(:david)
    @card = cards(:logo)
  end
  test "detect multiple people commenting" do
    assert_activity_spike_detected do
      multiple_people_comment_on(@card)
    end
  end
  test "detect assignments" do
    assert_activity_spike_detected do
      @card.toggle_assignment users(:kevin)
    end
  end
  test "detect reopened cards" do
    assert_activity_spike_detected(card: cards(:shipping)) do
      cards(:shipping).reopen
    end
  end
  test "refresh the activity spike on new spikes" do
    multiple_people_comment_on(@card)
    @card = Card.find(@card.id)
    original_last_spike_at = @card.activity_spike.updated_at
    travel 2.months
    multiple_people_comment_on(@card.reload)
    assert @card.reload.activity_spike.updated_at > original_last_spike_at
  end
  test "concurrent spike creation should not create multiple spikes for a card" do
    multiple_people_comment_on(@card)
    @card.activity_spike&.destroy
    5.times.map do
      Thread.new do
        ActiveRecord::Base.connection_pool.with_connection do
          Card.find(@card.id).detect_activity_spikes
        end
      end
    end.each(&:join)
    assert_equal 1, Card::ActivitySpike.where(card: @card).count
  end
  private
    def assert_activity_spike_detected(card: @card)
      assert card.activity_spike.blank?
      perform_enqueued_jobs only: Card::ActivitySpike::DetectionJob do
        yield
      end
      assert card.reload.activity_spike.present?
    end
end

================
File: test/models/card/eventable/system_commenter_test.rb
================
require "test_helper"
class Card::Eventable::SystemCommenterTest < ActiveSupport::TestCase
  setup do
    Current.session = sessions(:david)
    @card = cards(:text)
  end
  test "card_assigned" do
    assert_system_comment "David assigned this to Kevin" do
      @card.toggle_assignment users(:kevin)
    end
  end
  test "card_unassigned" do
    @card.toggle_assignment users(:kevin)
    @card.comments.destroy_all # To skip deduplication logic
    assert_system_comment "David unassigned from Kevin" do
      @card.toggle_assignment users(:kevin)
    end
  end
  test "card_closed" do
    assert_system_comment "Moved to Done by David" do
      @card.close
    end
  end
  test "card_title_changed" do
    assert_system_comment "David changed the title from The text is too small to Make text larger" do
      @card.update! title: "Make text larger"
    end
  end
  test "escapes html in comment body" do
    users(:david).update! name: "<em>Injected</em>"
    Current.session = sessions(:david)
    assert_difference -> { @card.comments.count }, 1 do
      @card.toggle_assignment users(:kevin)
    end
    comment = @card.comments.last
    html = comment.body.body.to_html
    assert_includes html, "&lt;em&gt;Injected&lt;/em&gt; <strong>assigned</strong> this to Kevin."
    refute_includes html, "<em>Injected</em>"
  end
  test "don't notify on system comments" do
    @card.watch_by(users(:david))
    assert_no_difference -> { Notification.count } do
      @card.toggle_assignment users(:kevin)
    end
  end
  private
    def assert_system_comment(expected_comment)
      assert_difference -> { @card.comments.count }, 1 do
        yield
        comment = @card.comments.last
        assert comment.creator.system?
        assert_match Regexp.new(expected_comment.strip, Regexp::IGNORECASE), comment.body.to_plain_text.strip
      end
    end
end

================
File: test/models/card/assignable_test.rb
================
require "test_helper"
class Card::AssignableTest < ActiveSupport::TestCase
  test "assigning a user makes them watch the card" do
    assert_not cards(:layout).assigned_to?(users(:kevin))
    cards(:layout).unwatch_by users(:kevin)
    with_current_user(:jz) do
      cards(:layout).toggle_assignment(users(:kevin))
    end
    assert cards(:layout).assigned_to?(users(:kevin))
    assert cards(:layout).watched_by?(users(:kevin))
  end
  test "toggle_assignment does not add assignee when at limit" do
    card = cards(:logo)
    board = card.board
    account = card.account
    card.assignments.delete_all
    Assignment::LIMIT.times do |i|
      identity = Identity.create!(email_address: "toggle_test_#{i}@example.com")
      user = account.users.create!(identity: identity, name: "Toggle Test User #{i}", role: :member)
      user.accesses.find_or_create_by!(board: board)
      card.assignments.create!(assignee: user, assigner: users(:david))
    end
    identity = Identity.create!(email_address: "toggle_over@example.com")
    extra_user = account.users.create!(identity: identity, name: "Toggle Over User", role: :member)
    extra_user.accesses.find_or_create_by!(board: board)
    with_current_user(:david) do
      assert_no_difference "card.assignments.count" do
        card.toggle_assignment(extra_user)
      end
    end
    assert_not card.reload.assigned_to?(extra_user)
  end
end

================
File: test/models/card/closeable_test.rb
================
require "test_helper"
class Card::CloseableTest < ActiveSupport::TestCase
  setup do
    Current.session = sessions(:david)
  end
  test "closed scope" do
    assert_equal [ cards(:shipping) ], Card.closed
    assert_not_includes Card.open, cards(:shipping)
  end
  test "close cards" do
    assert_not cards(:logo).closed?
    assert_difference -> { cards(:logo).events.count }, +1 do
      cards(:logo).close(user: users(:kevin))
    end
    assert cards(:logo).closed?
    assert cards(:logo).events.last.action.card_closed?
    assert_equal users(:kevin), cards(:logo).closed_by
  end
  test "reopen cards" do
    assert cards(:shipping).closed?
    assert_difference -> { cards(:shipping).events.count }, +1 do
      cards(:shipping).reopen
    end
    assert cards(:shipping).reload.open?
    assert cards(:shipping).events.last.action.card_reopened?
  end
  test "close card from triage column" do
    card = cards(:logo)
    assert_equal columns(:writebook_triage), card.column
    card.close
    assert card.closed?
  end
  test "close card from active column" do
    card = cards(:text)
    assert_equal columns(:writebook_in_progress), card.column
    card.close
    assert card.closed?
  end
  test "close card from NOT NOW" do
    card = cards(:logo)
    card.postpone
    assert card.postponed?
    assert card.not_now.present?
    card.close
    assert card.closed?
    assert_nil card.reload.not_now
  end
end

================
File: test/models/card/colored_test.rb
================
require "test_helper"
class Card::ColoredTest < ActiveSupport::TestCase
  test "use default color if no column" do
    cards(:logo).update! column: nil
    assert_equal Column::Colored::DEFAULT_COLOR, cards(:logo).color
  end
  test "infer color from column" do
    assert_equal cards(:layout).column.color, cards(:layout).color
  end
end

================
File: test/models/card/commentable_test.rb
================
require "test_helper"
class Card::CommentableTest < ActiveSupport::TestCase
  setup do
    Current.session = sessions(:david)
  end
  test "capturing comments" do
    assert_difference -> { cards(:logo).comments.count }, +1 do
      cards(:logo).comments.create!(body: "Agreed.")
    end
    assert_equal "Agreed.", cards(:logo).comments.last.body.to_plain_text.chomp
  end
  test "creating a comment on a card makes the creator watch the card" do
    boards(:writebook).access_for(users(:kevin)).access_only!
    assert_not cards(:text).watched_by?(users(:kevin))
    with_current_user(:kevin) do
      cards(:text).comments.create!(body: "This sounds interesting!")
    end
    assert cards(:text).watched_by?(users(:kevin))
  end
  test "commentable is true for published cards, false for drafts" do
    assert cards(:logo).commentable?
    assert_not cards(:unfinished_thoughts).commentable?
  end
end

================
File: test/models/card/entropic_test.rb
================
require "test_helper"
class Card::EntropicTest < ActiveSupport::TestCase
  setup do
    Current.session = sessions(:david)
  end
  test "auto_postpone_at uses the period defined in the account by default" do
    freeze_time
    entropies(:writebook_board).destroy
    entropies("37s_account").reload.update! auto_postpone_period: 456.days
    cards(:layout).update! last_active_at: 2.day.ago
    assert_equal (456 - 2).days.from_now, cards(:layout).entropy.auto_clean_at
  end
  test "auto_postpone_at infers the period from the board when present" do
    freeze_time
    entropies(:writebook_board).update! auto_postpone_period: 123.days
    cards(:layout).update! last_active_at: 2.day.ago
    assert_equal (123 - 2).days.from_now, cards(:layout).entropy.auto_clean_at
  end
  test "setting auto_postpone_period in the board without entropy will create it, without affecting the account entropy" do
    account_entropy = entropies("37s_account")
    original_period = account_entropy.auto_postpone_period
    entropies(:writebook_board).destroy
    boards(:writebook).update! auto_postpone_period: 999.days
    assert_equal original_period, account_entropy.reload.auto_postpone_period
  end
  test "auto postpone all due using the default account entropy" do
    entropies(:writebook_board).destroy
    cards(:logo).update!(last_active_at: 1.day.ago - entropies("37s_account").auto_postpone_period)
    cards(:shipping).update!(last_active_at: 1.day.from_now - entropies("37s_account").auto_postpone_period)
    assert_difference -> { Card.postponed.count }, +1 do
      Card.auto_postpone_all_due
    end
    assert cards(:logo).reload.postponed?
    assert_equal accounts("37s").system_user, cards(:logo).postponed_by
    assert_not cards(:shipping).reload.postponed?
  end
  test "auto postpone all due using entropy defined at the board level" do
    cards(:logo).update!(last_active_at: 1.day.ago - entropies(:writebook_board).auto_postpone_period)
    cards(:shipping).update!(last_active_at: 1.day.from_now - entropies(:writebook_board).auto_postpone_period)
    assert_difference -> { Card.postponed.count }, +1 do
      Card.auto_postpone_all_due
    end
    assert cards(:logo).reload.postponed?
    assert_not cards(:shipping).reload.postponed?
  end
  test "postponing soon scope" do
    cards(:logo, :shipping).each(&:published!)
    cards(:logo).update!(last_active_at: entropies(:writebook_board).auto_postpone_period.seconds.ago + 2.days)
    cards(:shipping).update!(last_active_at: entropies(:writebook_board).auto_postpone_period.seconds.ago - 2.days)
    assert_includes Card.postponing_soon, cards(:logo)
    assert_not_includes Card.postponing_soon, cards(:shipping)
  end
  test "due_to_be_postponed scope works properly cross-account" do
    cards(:logo).update!(last_active_at: entropies(:writebook_board).auto_postpone_period.seconds.ago - 2.days)
    cards(:radio).update!(last_active_at: entropies(:miltons_wish_list_board).auto_postpone_period.seconds.ago - 2.days)
    assert_equal(cards(:logo, :radio).to_set, Card.due_to_be_postponed.to_set)
  end
  test "postponing_soon scope works properly cross-account" do
    cards(:logo).update!(last_active_at: entropies(:writebook_board).auto_postpone_period.seconds.ago + 2.days)
    cards(:radio).update!(last_active_at: entropies(:miltons_wish_list_board).auto_postpone_period.seconds.ago + 2.days)
    assert_equal(cards(:logo, :radio).to_set, Card.postponing_soon.to_set)
  end
end

================
File: test/models/card/eventable_test.rb
================
require "test_helper"
class Card::EventableTest < ActiveSupport::TestCase
  setup do
    Current.session = sessions(:david)
  end
  test "new cards default last_active_at to created_at" do
    freeze_time
    card = boards(:writebook).cards.create!(title: "Some card", creator: users(:david))
    assert_equal card.created_at, card.last_active_at
  end
  test "new cards with custom created_at default last_active_at to that time" do
    custom_time = 1.week.ago.change(usec: 0)
    card = boards(:writebook).cards.create!(title: "Backdated card", creator: users(:david), created_at: custom_time)
    assert_equal custom_time, card.created_at
    assert_equal custom_time, card.last_active_at
  end
  test "new cards preserve explicit last_active_at" do
    created_time = 2.weeks.ago.change(usec: 0)
    last_active_time = 1.week.ago.change(usec: 0)
    card = boards(:writebook).cards.create! \
      title: "Card with explicit timestamps",
      creator: users(:david),
      created_at: created_time,
      last_active_at: last_active_time
    assert_equal created_time, card.created_at
    assert_equal last_active_time, card.last_active_at
  end
  test "publishing a card does not overwrite last_active_at" do
    created_time = 2.weeks.ago.change(usec: 0)
    last_active_time = 1.week.ago.change(usec: 0)
    card = boards(:writebook).cards.create! \
      title: "Published card",
      creator: users(:david),
      status: :published,
      created_at: created_time,
      last_active_at: last_active_time
    assert_equal last_active_time, card.last_active_at
  end
  test "tracking events update the last activity time" do
    travel_to Time.current
    cards(:logo).close
    assert_equal Time.current, cards(:logo).last_active_at
  end
end

================
File: test/models/card/exportable_test.rb
================
require "test_helper"
class Card::ExportableTest < ActiveSupport::TestCase
  test "export_json returns card data as JSON" do
    card = cards(:logo)
    json = JSON.parse(card.export_json)
    assert_equal 1, json["number"]
    assert_equal "The logo isn't big enough", json["title"]
    assert_equal "Writebook", json["board"]
    assert_equal "Triage", json["status"]
    assert_equal users(:david).id, json["creator"]["id"]
    assert_equal "David", json["creator"]["name"]
    assert_equal "david@37signals.com", json["creator"]["email"]
    assert_equal "", json["description"]
    assert_equal 5, json["comments"].count
    assert_equal card.created_at.iso8601, json["created_at"]
    assert_equal card.updated_at.iso8601, json["updated_at"]
  end
  test "export_attachments returns attachment paths and blobs" do
    card = cards(:logo)
    blob = ActiveStorage::Blob.create_and_upload!(
      io: file_fixture("moon.jpg").open,
      filename: "moon.jpg",
      content_type: "image/jpeg"
    )
    attachment_html = ActionText::Attachment.from_attachable(blob).to_html
    card.update!(description: "<p>Here is an image:</p>#{attachment_html}")
    attachments = card.export_attachments
    assert_equal 1, attachments.count
    assert_equal file_fixture("moon.jpg").binread, attachments.first[:blob].download
    assert attachments.first[:path].start_with?("#{card.number}/")
  end
end

================
File: test/models/card/golden_test.rb
================
require "test_helper"
class Card::GoldenTest < ActiveSupport::TestCase
  setup do
    Current.session = sessions(:david)
    @golden, @non_golden = cards(:logo), cards(:text)
  end
  test "check whether a card is golden" do
    assert @golden.golden?
    assert_not @non_golden.golden?
  end
  test "promote and demote from golden" do
    assert_changes -> { @non_golden.reload.golden? }, to: true do
      @non_golden.gild
    end
    assert_changes -> { @golden.reload.golden? }, to: false do
      @golden.ungild
    end
  end
  test "scopes" do
    assert_includes Card.golden, @golden
    assert_not_includes Card.golden, @non_golden
  end
  test "with_golden_first orders golden first" do
    ordered = Card.where(id: [ @golden.id, @non_golden.id ]).with_golden_first
    assert_equal [ @golden, @non_golden ], ordered.to_a
    # Preserves base ordering as subordering
    @non_golden.gild
    base_ordered = Card.where(id: [ @golden.id, @non_golden.id ]).order(id: :desc).to_a
    with_golden = Card.where(id: [ @golden.id, @non_golden.id ]).order(id: :desc).with_golden_first.to_a
    assert_equal base_ordered, with_golden
  end
  test "gilding a card touches both the card and the board" do
    board = @non_golden.board
    card_updated_at = @non_golden.updated_at
    board_updated_at = board.updated_at
    travel 1.minute do
      @non_golden.gild
    end
    assert @non_golden.reload.updated_at > card_updated_at
    assert board.reload.updated_at > board_updated_at
  end
end

================
File: test/models/card/messages_test.rb
================
require "test_helper"
class Card::MessagesTest < ActiveSupport::TestCase
  test "creating a card does not create a message by default" do
    card = boards(:writebook).cards.create! creator: users(:kevin), title: "New"
    assert_empty card.comments
  end
end

================
File: test/models/card/pinnable_test.rb
================
require "test_helper"
class Card::PinnableTest < ActiveSupport::TestCase
  setup do
    Current.session = sessions(:david)
  end
  test "broadcasts pin update when title changes" do
    assert_broadcasted_pin_update do
      cards(:logo).update!(title: "New title")
    end
  end
  test "broadcasts pin update when column changes" do
    assert_broadcasted_pin_update do
      cards(:logo).update!(column: columns(:writebook_in_progress))
    end
  end
  test "broadcasts pin update when board changes" do
    assert_broadcasted_pin_update do
      cards(:logo).update!(board: boards(:private), column: nil)
    end
  end
  test "does not broadcast pin update when other properties change" do
    perform_enqueued_jobs do
      assert_turbo_stream_broadcasts([ pins(:logo_kevin).user, :pins_tray ], count: 0) do
        cards(:logo).update!(last_active_at: Time.current)
      end
    end
  end
  private
    def assert_broadcasted_pin_update(&block)
      perform_enqueued_jobs do
        assert_turbo_stream_broadcasts([ pins(:logo_kevin).user, :pins_tray ], &block)
      end
    end
end

================
File: test/models/card/postponable_test.rb
================
require "test_helper"
class Card::PostponableTest < ActiveSupport::TestCase
  setup do
    Current.session = sessions(:david)
  end
  test "check the postponed status of a card" do
    card = cards(:logo)
    assert_not card.postponed?
    assert card.active?
    card.postpone
    assert card.postponed?
    assert_not card.active?
  end
  test "postpone and resume a card" do
    card = cards(:text)
    assert_changes -> { card.reload.postponed? }, to: true do
      assert_difference -> { card.events.count }, +1 do
        card.postpone
      end
    end
    assert_equal users(:david), card.not_now.user
    assert card.events.last.action.card_postponed?
    assert_changes -> { card.reload.postponed? }, to: false do
      card.resume
    end
  end
  test "auto_postpone a card" do
    card = cards(:text)
    assert_changes -> { card.reload.postponed? }, to: true do
      assert_difference -> { card.events.count }, +1 do
        card.auto_postpone
      end
    end
    assert card.events.last.action.card_auto_postponed?
  end
  test "scopes" do
    logo = cards(:logo)
    text = cards(:text)
    logo.postpone
    assert_includes Card.postponed, logo
    assert_not_includes Card.postponed, text
    assert_includes Card.active, text
    assert_not_includes Card.active, logo
  end
end

================
File: test/models/card/readable_test.rb
================
require "test_helper"
class Card::ReadableTest < ActiveSupport::TestCase
  test "read clears events notifications" do
    assert_changes -> { notifications(:logo_published_kevin).reload.read? }, from: false, to: true do
      assert_changes -> { notifications(:logo_assignment_kevin).reload.read? }, from: false, to: true do
        cards(:logo).read_by(users(:kevin))
      end
    end
  end
  test "read clear mentions in the description" do
    assert_changes -> { notifications(:logo_card_david_mention_by_jz).reload.read? }, from: false, to: true do
      cards(:logo).read_by(users(:david))
    end
  end
  test "read clear mentions in comments" do
    assert_changes -> { notifications(:logo_comment_david_mention_by_jz).reload.read? }, from: false, to: true do
      cards(:logo).read_by(users(:david))
    end
  end
  test "read clears notifications from the comments" do
    assert_changes -> { notifications(:layout_commented_kevin).reload.read? }, from: false, to: true do
      cards(:layout).read_by(users(:kevin))
    end
  end
  test "unread marks events notifications as unread" do
    notifications(:logo_published_kevin).read
    notifications(:logo_assignment_kevin).read
    assert_changes -> { notifications(:logo_published_kevin).reload.read? }, from: true, to: false do
      assert_changes -> { notifications(:logo_assignment_kevin).reload.read? }, from: true, to: false do
        cards(:logo).unread_by(users(:kevin))
      end
    end
  end
  test "unread marks mentions in the description as unread" do
    notifications(:logo_card_david_mention_by_jz).read
    assert_changes -> { notifications(:logo_card_david_mention_by_jz).reload.read? }, from: true, to: false do
      cards(:logo).unread_by(users(:david))
    end
  end
  test "unread marks mentions in comments as unread" do
    notifications(:logo_comment_david_mention_by_jz).read
    assert_changes -> { notifications(:logo_comment_david_mention_by_jz).reload.read? }, from: true, to: false do
      cards(:logo).unread_by(users(:david))
    end
  end
  test "unread marks notifications from the comments as unread" do
    notifications(:layout_commented_kevin).read
    assert_changes -> { notifications(:layout_commented_kevin).reload.read? }, from: true, to: false do
      cards(:layout).unread_by(users(:kevin))
    end
  end
  test "remove inaccessible notifications" do
    card = cards(:logo)
    kevin = users(:kevin)
    david = users(:david)
    assert card.accessible_to?(kevin)
    kevin_notifications = [ notifications(:logo_published_kevin), notifications(:logo_assignment_kevin) ]
    david_notifications = [ notifications(:logo_card_david_mention_by_jz), notifications(:logo_comment_david_mention_by_jz) ]
    # Kevin loses access
    card.board.accesses.find_by(user: kevin).destroy
    assert_not card.accessible_to?(kevin)
    assert card.accessible_to?(david)
    card.remove_inaccessible_notifications
    # Kevin's notifications removed
    kevin_notifications.each do |notification|
      assert_not Notification.exists?(notification.id)
    end
    # David's notifications preserved
    david_notifications.each do |notification|
      assert Notification.exists?(notification.id)
    end
  end
end

================
File: test/models/card/searchable_test.rb
================
require "test_helper"
class Card::SearchableTest < ActiveSupport::TestCase
  include SearchTestHelper
  test "searchable? returns true for published cards" do
    card = @board.cards.create!(title: "Published Card", status: "published", creator: @user)
    assert card.searchable?
  end
  test "searchable? returns false for draft cards" do
    card = @board.cards.create!(title: "Draft Card", status: "drafted", creator: @user)
    assert_not card.searchable?
  end
  test "card search" do
    # Searching by title
    card = @board.cards.create!(title: "layout is broken", status: "published", creator: @user)
    results = Card.mentioning("layout", user: @user)
    assert_includes results, card
    # Searching by comment
    card_with_comment = @board.cards.create!(title: "Some card", status: "published", creator: @user)
    card_with_comment.comments.create!(body: "overflowing text", creator: @user)
    results = Card.mentioning("overflowing", user: @user)
    assert_includes results, card_with_comment
    # Sanitizing search query
    card_broken = @board.cards.create!(title: "broken layout", status: "published", creator: @user)
    results = Card.mentioning("broken \"", user: @user)
    assert_includes results, card_broken
    # Empty query returns no results
    assert_empty Card.mentioning("\"", user: @user)
    # Filtering by board_ids
    other_board = Board.create!(name: "Other Board", account: @account, creator: @user)
    card_in_board = @board.cards.create!(title: "searchable content", status: "published", creator: @user)
    card_in_other_board = other_board.cards.create!(title: "searchable content", status: "published", creator: @user)
    results = Card.mentioning("searchable", user: @user)
    assert_includes results, card_in_board
    assert_not_includes results, card_in_other_board
  end
  test "search content is truncated to a reasonable limit" do
    search_record_class = Search::Record.for(@user.account_id)
    # Create a card with unreasonably long content
    long_content = "asdf " * Searchable::SEARCH_CONTENT_LIMIT
    card = @board.cards.create!(title: "Card with long description", status: "published", creator: @user)
    card.description = ActionText::Content.new(long_content)
    card.save!
    # Check if was indexed
    results = Card.mentioning("asdf", user: @user)
    assert_includes results, card
    # Check the content length was within the limit
    search_record = search_record_class.find_by(searchable_type: "Card", searchable_id: card.id)
    assert search_record.content.bytesize <= Searchable::SEARCH_CONTENT_LIMIT
  end
  test "deleting card removes search record and FTS entry" do
    search_record_class = Search::Record.for(@user.account_id)
    card = @board.cards.create!(title: "Card to delete", status: "published", creator: @user)
    # Verify search record exists
    search_record = search_record_class.find_by(searchable_type: "Card", searchable_id: card.id)
    assert_not_nil search_record, "Search record should exist after card creation"
    # For SQLite, verify FTS entry exists
    if search_record_class.connection.adapter_name == "SQLite"
      fts_entry = search_record.search_records_fts
      assert_not_nil fts_entry, "FTS entry should exist"
      assert_equal card.title, fts_entry.title
    end
    # Delete the card
    card.destroy
    # Verify search record is deleted
    search_record = search_record_class.find_by(searchable_type: "Card", searchable_id: card.id)
    assert_nil search_record, "Search record should be deleted after card deletion"
    # For SQLite, verify FTS entry is deleted
    if search_record_class.connection.adapter_name == "SQLite"
      fts_count = Search::Record::SQLite::Fts.where(rowid: card.id).count
      assert_equal 0, fts_count, "FTS entry should be deleted"
    end
  end
  test "updating a draft card does not index it" do
    search_record_class = Search::Record.for(@user.account_id)
    card = @board.cards.create!(title: "Draft card", creator: @user, status: "drafted")
    assert_nil search_record_class.find_by(searchable_type: "Card", searchable_id: card.id)
    card.update!(title: "Updated draft card")
    assert_nil search_record_class.find_by(searchable_type: "Card", searchable_id: card.id),
      "Draft card should not be indexed after update"
    results = Card.mentioning("Updated", user: @user)
    assert_not_includes results, card
  end
  test "publishing a draft card indexes it" do
    search_record_class = Search::Record.for(@user.account_id)
    card = @board.cards.create!(title: "Draft to publish", creator: @user, status: "drafted")
    assert_nil search_record_class.find_by(searchable_type: "Card", searchable_id: card.id)
    card.publish
    search_record = search_record_class.find_by(searchable_type: "Card", searchable_id: card.id)
    assert_not_nil search_record, "Published card should be indexed"
    assert_equal card.id, search_record.card_id
    results = Card.mentioning("publish", user: @user)
    assert_includes results, card
  end
  test "unpublishing a draft card removes it from the search index" do
    search_record_class = Search::Record.for(@user.account_id)
    card = @board.cards.create!(title: "Draft to publish", creator: @user, status: "published")
    assert_not_nil search_record_class.find_by(searchable_type: "Card", searchable_id: card.id)
    card.update!(status: "drafted")
    assert_nil search_record_class.find_by(searchable_type: "Card", searchable_id: card.id)
    results = Card.mentioning("publish", user: @user)
    assert_not_includes results, card
  end
end

================
File: test/models/card/stallable_test.rb
================
require "test_helper"
class Card::StallableTest < ActiveSupport::TestCase
  include CardActivityTestHelper
  setup do
    Current.session = sessions(:david)
  end
  test "a card without activity spike is not stalled" do
    assert_not cards(:logo).stalled?
    assert_not_includes Card.stalled, cards(:logo)
  end
  test "a card with a recent activity spike is not stalled" do
    cards(:logo).create_activity_spike!
    assert_not cards(:logo).stalled?
    assert_not_includes Card.stalled, cards(:logo)
  end
  test "a card with an old activity spike is stalled" do
    cards(:logo).create_activity_spike!
    travel_to 3.months.from_now
    assert cards(:logo).stalled?
    assert_includes Card.stalled, cards(:logo)
  end
  test "a stalled card can be unstalled with a single comment" do
    cards(:logo).create_activity_spike!
    travel_to 3.months.from_now
    assert cards(:logo).stalled?
    assert_includes Card.stalled, cards(:logo)
    cards(:logo).comments.create!(body: "A new comment to unstall the card")
    assert_not cards(:logo).stalled?
    assert_not_includes Card.stalled, cards(:logo)
    # and stalls again after more time passes
    travel_to 3.months.from_now
    assert cards(:logo).stalled?
    assert_includes Card.stalled, cards(:logo)
  end
  test "a card with an old activity spike is not stalled after being postponed" do
    card = cards(:logo)
    card.create_activity_spike!
    travel_to 3.months.from_now
    assert card.stalled?
    assert_includes Card.stalled, card
    travel_to Time.now + card.board.entropy.auto_postpone_period + 1.day
    assert_includes Card.due_to_be_postponed, card
    Card.auto_postpone_all_due
    assert_not card.reload.stalled?
    assert_not_includes Card.stalled, card
  end
  # More fine-grained testing in Card::ActivitySpike::Detector
  test "detect activity spikes" do
    assert_not cards(:logo).stalled?
    multiple_people_comment_on(cards(:logo))
    travel_to 1.month.from_now
    assert cards(:logo).reload.stalled?
    assert_includes Card.stalled, cards(:logo)
  end
  test "don't detect activity spikes when updating attributes other than last_active_at" do
    assert_no_enqueued_jobs only: Card::ActivitySpike::DetectionJob do
      cards(:logo).update! created_at: 1.day.ago
    end
  end
  test "don't detect activity spikes when creating new cards" do
    assert_no_enqueued_jobs only: Card::ActivitySpike::DetectionJob do
      boards(:writebook).cards.create! title: "A new card", creator: users(:kevin)
    end
  end
end

================
File: test/models/card/statuses_test.rb
================
require "test_helper"
class Card::StatusesTest < ActiveSupport::TestCase
  setup do
    Current.session = sessions(:david)
  end
  test "cards start out in a `drafted` state" do
    card = boards(:writebook).cards.create! creator: users(:kevin), title: "Newly created card"
    assert card.drafted?
  end
  test "an event is created when a card is created in the published state" do
    assert_no_difference(-> { Event.count }) do
      boards(:writebook).cards.create! creator: users(:kevin), title: "Draft Card"
    end
    assert_difference(-> { Event.count } => +1) do
      @card = boards(:writebook).cards.create! creator: users(:kevin), title: "Published Card", status: :published
    end
    event = Event.last
    assert_equal @card, event.eventable
    assert_equal "card_published", event.action
  end
  test "an event is created when a card is published" do
    card = boards(:writebook).cards.create! creator: users(:kevin), title: "Published Card"
    assert_difference(-> { Event.count } => +1) do
      card.publish
    end
    event = Event.last
    assert_equal card, event.eventable
    assert_equal "card_published", event.action
  end
  test "created_at is updated when the card is published" do
    freeze_time
    card = travel_to 1.week.ago do
      boards(:writebook).cards.create! creator: users(:kevin), title: "Newly created card"
    end
    assert card.drafted?
    assert_equal 1.week.ago, card.created_at
    card.publish
    assert_equal Time.current, card.created_at
  end
  test "detect drafts that were just published" do
    card = boards(:writebook).cards.create! creator: users(:kevin), title: "Draft Card"
    assert card.drafted?
    assert_not card.was_just_published?
    card.publish
    assert card.was_just_published?
    assert_not Card.find(card.id).was_just_published?
  end
  test "detect cards that were created and published" do
    card = boards(:writebook).cards.create! creator: users(:kevin), title: "Published Card", status: :published
    assert card.was_just_published?
    assert_not Card.find(card.id).was_just_published?
  end
end

================
File: test/models/card/taggable_test.rb
================
require "test_helper"
class Card::TaggableTest < ActiveSupport::TestCase
  setup do
    @card = cards(:logo)
  end
  test "toggle tag" do
    assert_difference -> { @card.tags.count }, 1 do
      @card.toggle_tag_with "ruby"
    end
    assert_equal "ruby", @card.tags.last.title
    assert_difference -> { @card.tags.count }, -1 do
      @card.toggle_tag_with "ruby"
    end
  end
  test "scope tags by account" do
    assert_difference -> { Tag.count }, 2 do
      cards(:logo).toggle_tag_with "ruby"
      cards(:paycheck).toggle_tag_with "ruby"
    end
    assert_not_equal cards(:logo).tags.last, cards(:paycheck).tags.last
  end
end

================
File: test/models/card/triageable_test.rb
================
require "test_helper"
class Card::TriageableTest < ActiveSupport::TestCase
  setup do
    Current.session = sessions(:david)
  end
  test "active cards with columns are triaged" do
    assert cards(:logo).triaged?
    assert cards(:text).triaged?
    assert_not cards(:buy_domain).triaged?
  end
  test "active cards without columns are awaiting triage" do
    assert cards(:buy_domain).awaiting_triage?
    assert_not cards(:logo).awaiting_triage?
    assert_not cards(:text).awaiting_triage?
  end
  test "triage a card" do
    card = cards(:buy_domain)
    column = columns(:writebook_in_progress)
    assert_nil card.column
    assert card.awaiting_triage?
    assert_difference -> { card.reload.events.where(action: "card_triaged").count }, +1 do
      card.triage_into(column)
    end
    assert_equal column, card.reload.column
    assert card.triaged?
  end
  test "cannot triage into a column from a different board" do
    card = cards(:buy_domain)
    other_board_column = Column.create!(
      name: "Other",
      color: "#000000",
      board: boards(:private)
    )
    assert_raises(RuntimeError, "The column must belong to the card board") do
      card.triage_into(other_board_column)
    end
  end
  test "send a card back to triage" do
    card = cards(:logo)
    assert card.triaged?
    assert_difference -> { card.reload.events.where(action: "card_sent_back_to_triage").count }, +1 do
      card.send_back_to_triage
    end
    assert card.reload.awaiting_triage?
  end
  test "scopes" do
    assert_includes Card.awaiting_triage, cards(:buy_domain)
    assert_not_includes Card.awaiting_triage, cards(:logo)
    assert_not_includes Card.awaiting_triage, cards(:text)
    assert_includes Card.triaged, cards(:logo)
    assert_includes Card.triaged, cards(:text)
    assert_not_includes Card.triaged, cards(:buy_domain)
  end
end

================
File: test/models/card/watchable_test.rb
================
require "test_helper"
class Card::WatchableTest < ActiveSupport::TestCase
  setup do
    Watch.destroy_all
    Access.all.update!(involvement: :access_only)
  end
  test "watched_by?" do
    assert_not cards(:logo).watched_by?(users(:kevin))
    cards(:logo).watch_by users(:kevin)
    assert cards(:logo).watched_by?(users(:kevin))
    cards(:logo).unwatch_by users(:kevin)
    assert_not cards(:logo).watched_by?(users(:kevin))
  end
  test "cards are initially watched by their creator" do
    card = boards(:writebook).cards.create!(creator: users(:kevin))
    assert card.watched_by?(users(:kevin))
  end
  test "watchers" do
    boards(:writebook).access_for(users(:kevin)).watching!
    boards(:writebook).access_for(users(:jz)).watching!
    cards(:logo).watch_by users(:kevin)
    cards(:logo).unwatch_by users(:jz)
    cards(:logo).watch_by users(:david)
    assert_equal [ users(:kevin), users(:david) ].sort, cards(:logo).watchers.sort
    # Only active users
    users(:david).system!
    assert_equal [ users(:kevin) ].sort, cards(:logo).watchers.reload.sort
  end
end

================
File: test/models/column/colored_test.rb
================
require "test_helper"
class Column::ColoredTest < ActiveSupport::TestCase
  test "creates column with default color when color not provided" do
    column = boards(:writebook).columns.create!(name: "New Column")
    assert_equal Column::Colored::DEFAULT_COLOR, column.color
  end
  test "update the column color" do
    columns(:writebook_triage).update!(color: "var(--color-card-3)")
    assert_not_nil columns(:writebook_triage).color
    assert_equal Color.for_value("var(--color-card-3)"), columns(:writebook_triage).color
  end
end

================
File: test/models/column/positioned_test.rb
================
require "test_helper"
class Column::PositionedTest < ActiveSupport::TestCase
  test "auto position new columns" do
    board = boards(:writebook)
    max_position = board.columns.maximum(:position)
    new_column = board.columns.create!(name: "New Column", color: "#000000")
    assert_equal max_position + 1, new_column.position
  end
  test "move column to the left" do
    board = boards(:writebook)
    columns = board.columns.sorted.to_a
    column_a = columns[0]
    column_b = columns[1]
    original_position_a = column_a.position
    original_position_b = column_b.position
    column_b.move_left
    assert_equal original_position_b, column_a.reload.position
    assert_equal original_position_a, column_b.reload.position
  end
  test "move left when already at leftmost position" do
    board = boards(:writebook)
    leftmost_column = board.columns.sorted.first
    original_position = leftmost_column.position
    leftmost_column.move_left
    assert_equal original_position, leftmost_column.reload.position
  end
  test "move column to the right" do
    board = boards(:writebook)
    columns = board.columns.sorted.to_a
    column_a = columns[0]
    column_b = columns[1]
    original_position_a = column_a.position
    original_position_b = column_b.position
    column_a.move_right
    assert_equal original_position_b, column_a.reload.position
    assert_equal original_position_a, column_b.reload.position
  end
  test "move right when already at rightmost position" do
    board = boards(:writebook)
    rightmost_column = board.columns.sorted.last
    original_position = rightmost_column.position
    rightmost_column.move_right
    assert_equal original_position, rightmost_column.reload.position
  end
end

================
File: test/models/comment/searchable_test.rb
================
require "test_helper"
class Comment::SearchableTest < ActiveSupport::TestCase
  include SearchTestHelper
  setup do
    @card = @board.cards.create!(title: "Test Card", status: "published", creator: @user)
  end
  test "searchable? returns true for comments on published cards" do
    comment = @card.comments.create!(body: "test comment", creator: @user)
    assert comment.searchable?
  end
  test "searchable? returns false for comments on draft cards" do
    draft_card = @board.cards.create!(title: "Draft Card", status: "drafted", creator: @user)
    comment = draft_card.comments.build(body: "test comment", creator: @user)
    assert_not comment.searchable?
  end
  test "comment search" do
    search_record_class = Search::Record.for(@user.account_id)
    # Comment is indexed on create
    comment = @card.comments.create!(body: "searchable comment text", creator: @user)
    record = search_record_class.find_by(searchable_type: "Comment", searchable_id: comment.id)
    assert_not_nil record
    # Comment is updated in index
    comment.update!(body: "updated text")
    record = search_record_class.find_by(searchable_type: "Comment", searchable_id: comment.id)
    assert_match /updat/, record.content
    # Comment is removed from index on destroy
    comment_id = comment.id
    search_record_id = record.id
    # For SQLite, verify FTS entry exists before deletion
    if search_record_class.connection.adapter_name == "SQLite"
      fts_entry = record.search_records_fts
      assert_not_nil fts_entry, "FTS entry should exist before comment deletion"
    end
    comment.destroy
    record = search_record_class.find_by(searchable_type: "Comment", searchable_id: comment_id)
    assert_nil record
    # For SQLite, verify FTS entry is also deleted
    if search_record_class.connection.adapter_name == "SQLite"
      fts_count = Search::Record::SQLite::Fts.where(rowid: search_record_id).count
      assert_equal 0, fts_count, "FTS entry should be deleted after comment deletion"
    end
    # Finding cards via comment search
    card_with_comment = @board.cards.create!(title: "Card One", status: "published", creator: @user)
    card_with_comment.comments.create!(body: "unique searchable phrase", creator: @user)
    card_without_comment = @board.cards.create!(title: "Card Two", status: "published", creator: @user)
    results = Card.mentioning("searchable", user: @user)
    assert_includes results, card_with_comment
    assert_not_includes results, card_without_comment
    # Comment stores parent card_id and board_id
    new_comment = @card.comments.create!(body: "test comment", creator: @user)
    record = search_record_class.find_by(searchable_type: "Comment", searchable_id: new_comment.id)
    assert_equal @card.id, record.card_id
    assert_equal @board.id, record.board_id
  end
end

================
File: test/models/concerns/mentions_test.rb
================
require "test_helper"
class MentionsTest < ActiveSupport::TestCase
  setup do
    Current.session = sessions(:david)
  end
  test "don't create mentions when creating or updating drafts" do
    assert_no_difference -> { Mention.count } do
      perform_enqueued_jobs only: Mention::CreateJob do
        card = boards(:writebook).cards.create title: "Cleanup", description: "Did you finish up with the cleanup, #{mention_html_for(users(:david))}?"
        card.update description: "Any thoughts here #{mention_html_for(users(:jz))}"
      end
    end
  end
  test "create mentions from plain text mentions when publishing cards" do
    perform_enqueued_jobs only: Mention::CreateJob do
      card = assert_no_difference -> { Mention.count } do
        boards(:writebook).cards.create title: "Cleanup", description: "Did you finish up with the cleanup, #{mention_html_for(users(:david))}?"
      end
      card = Card.find(card.id)
      assert_difference -> { Mention.count }, +1 do
        card.publish
      end
    end
  end
  test "create mentions from rich text mentions when publishing cards" do
    perform_enqueued_jobs only: Mention::CreateJob do
      card = assert_no_difference -> { Mention.count } do
        boards(:writebook).cards.create title: "Cleanup", description: "Did you finish up with the cleanup, #{mention_html_for(users(:david))}?"
      end
      card = Card.find(card.id)
      assert_difference -> { Mention.count }, +1 do
        card.published!
      end
    end
  end
  test "don't create repeated mentions when updating cards" do
    perform_enqueued_jobs only: Mention::CreateJob do
      card = boards(:writebook).cards.create title: "Cleanup", description: "Did you finish up with the cleanup, #{mention_html_for(users(:david))}?"
      assert_difference -> { Mention.count }, +1 do
        card.published!
      end
      assert_no_difference -> { Mention.count } do
        card.update description: "Any thoughts here #{mention_html_for(users(:david))}"
      end
      assert_difference -> { Mention.count }, +1 do
        card.update description: "Any thoughts here #{mention_html_for(users(:jz))}"
      end
    end
  end
  test "create mentions from plain text mentions when posting comments" do
    perform_enqueued_jobs only: Mention::CreateJob do
      card = boards(:writebook).cards.create title: "Cleanup", description: "Some initial content", status: :published
      assert_difference -> { Mention.count }, +1 do
        card.comments.create!(body: "Great work on this #{mention_html_for(users(:david))}!")
      end
    end
  end
  test "can't mention users that don't have access to the board" do
    boards(:writebook).update! all_access: false
    boards(:writebook).accesses.revoke_from(users(:david))
    assert_no_difference -> { Mention.count }, +1 do
      perform_enqueued_jobs only: Mention::CreateJob do
        boards(:writebook).cards.create title: "Cleanup", description: "Did you finish up with the cleanup, #{mention_html_for(users(:david))}?"
      end
    end
  end
  test "mentionees are added as watchers of the card" do
    perform_enqueued_jobs only: Mention::CreateJob do
      card = boards(:writebook).cards.create title: "Cleanup", description: "Did you finish up with the cleanup #{mention_html_for(users(:kevin))}?"
      card.published!
      assert card.watchers.include?(users(:kevin))
    end
  end
  private
    def mention_html_for(user)
      ActionText::Attachment.from_attachable(user).to_html
    end
end

================
File: test/models/event/description_test.rb
================
require "test_helper"
class Event::DescriptionTest < ActiveSupport::TestCase
  test "generates html description for card published event" do
    description = events(:logo_published).description_for(users(:david))
    assert_includes description.to_html, "added"
    assert_includes description.to_html, "logo"
  end
  test "generates plain text description for card published event" do
    description = events(:logo_published).description_for(users(:david))
    assert_includes description.to_plain_text, "David added"
    assert_includes description.to_plain_text, "logo"
  end
  test "generates description for comment event" do
    description = events(:layout_commented).description_for(users(:jz))
    assert_includes description.to_plain_text, "David commented on"
  end
  test "uses always the name even when the event creator is the current user" do
    description = events(:logo_published).description_for(users(:david))
    assert_includes description.to_plain_text, "David added"
  end
  test "uses creator name when event creator is not the current user" do
    description = events(:logo_published).description_for(users(:jz))
    assert_includes description.to_plain_text, "David added"
  end
  test "escapes html in card titles in plain text description" do
    card = cards(:logo)
    card.update_column(:title, "<script>alert('xss')</script>")
    description = events(:logo_published).description_for(users(:david))
    assert_includes description.to_plain_text, "&lt;script&gt;alert(&#39;xss&#39;)&lt;/script&gt;"
    assert_not_includes description.to_plain_text, "<script>"
  end
end

================
File: test/models/filter/search_test.rb
================
require "test_helper"
class Filter::SearchTest < ActiveSupport::TestCase
  include SearchTestHelper
  test "deduplicate multiple results" do
    card = @board.cards.create!(title: "Duplicate results test", description: "Have you had any haggis today?", creator: @user, status: "published")
    card.comments.create(body: "I hate haggis.", creator: @user)
    card.comments.create(body: "I love haggis.", creator: @user)
    filter = @user.filters.new(terms: [ "haggis" ], indexed_by: "all", sorted_by: "latest")
    assert_equal [ card ], filter.cards.to_a
  end
end

================
File: test/models/identity/access_token_test.rb
================
require "test_helper"
class Identity::AccessTokenTest < ActiveSupport::TestCase
end

================
File: test/models/identity/joinable_test.rb
================
require "test_helper"
class Identity::JoinableTest < ActiveSupport::TestCase
  test "join creates a new user and returns true" do
    identity = identities(:david)
    assert_difference -> { User.count }, 1 do
      result = identity.join(accounts(:initech))
      assert result, "join should return true when creating a new user"
    end
    user = identity.users.find_by!(account: accounts(:initech))
    assert_equal identity.email_address, user.name
  end
  test "join with custom attributes" do
    identity = identities(:mike)
    result = identity.join(accounts("37s"), name: "Mike")
    assert result
    user = identity.users.find_by!(account: accounts("37s"))
    assert_equal "Mike", user.name
  end
  test "join returns false if user already exists" do
    identity = identities(:david)
    account = accounts("37s")
    assert identity.users.exists?(account: account), "David should already be a member of 37s"
    assert_no_difference -> { User.count } do
      result = identity.join(account)
      assert_not result, "join should return false when user already exists"
    end
  end
end

================
File: test/models/identity/transferable_test.rb
================
require "test_helper"
class Identity::TransferableTest < ActiveSupport::TestCase
  test "transfer_id" do
    identity = identities(:david)
    transfer_id = identity.transfer_id
    assert_kind_of String, transfer_id
  end
  test "find_by_transfer_id" do
    identity = identities(:kevin)
    transfer_id = identity.transfer_id
    found = Identity.find_by_transfer_id(transfer_id)
    assert_equal identity, found
    found = Identity.find_by_transfer_id("invalid_id")
    assert_nil found
    expired_id = identity.signed_id(purpose: :transfer, expires_in: -1.second)
    found = Identity.find_by_transfer_id(expired_id)
    assert_nil found
  end
end

================
File: test/models/magic_link/code_test.rb
================
require "test_helper"
class MagicLink::CodeTest < ActiveSupport::TestCase
  test "generate" do
    code = MagicLink::Code.generate(6)
    assert_equal 6, code.length
    assert_match(/\A[#{SecureRandom::BASE32_ALPHABET.join}]+\z/, code)
  end
  test "sanitize" do
    assert_equal "011123", MagicLink::Code.sanitize("OIL123")
    assert_equal "ABC123", MagicLink::Code.sanitize("ABC-123 !@#")
    assert_nil MagicLink::Code.sanitize(nil)
    assert_nil MagicLink::Code.sanitize("")
  end
end

================
File: test/models/notification/bundle_test.rb
================
require "test_helper"
class Notification::BundleTest < ActiveSupport::TestCase
  include ActionMailer::TestHelper
  setup do
    @user = users(:david)
    @user.settings.bundle_email_every_few_hours!
  end
  test "new notifications are bundled" do
    notification = assert_difference -> { @user.notification_bundles.pending.count }, 1 do
      @user.notifications.create!(source: events(:logo_published), creator: @user)
    end
    bundle = @user.notification_bundles.pending.last
    assert_includes bundle.notifications, notification
  end
  test "don't bundle new notifications if bundling is disabled" do
    @user.settings.bundle_email_never!
    assert_no_difference -> { @user.notification_bundles.count } do
      @user.notifications.create!(source: events(:logo_published), creator: @user)
    end
  end
  test "notifications are bundled withing the aggregation period" do
    @user.notification_bundles.destroy_all
    notification_1 = assert_difference -> { @user.notification_bundles.pending.count }, 1 do
      @user.notifications.create!(source: events(:logo_published), creator: @user)
    end
    travel_to 3.hours.from_now
    notification_2 = assert_no_difference -> { @user.notification_bundles.count } do
      @user.notifications.create!(source: events(:logo_published), creator: @user)
    end
    travel_to 3.days.from_now
    notification_3 = assert_difference -> { @user.notification_bundles.pending.count }, 1 do
      @user.notifications.create!(source: events(:logo_published), creator: @user)
    end
    assert_equal 2, @user.notification_bundles.count
    bundle_1, bundle_2 = @user.notification_bundles.all.to_a
    assert_includes bundle_1.notifications, notification_1
    assert_includes bundle_1.notifications, notification_2
    assert_includes bundle_2.notifications, notification_3
  end
  test "overlapping bundles are invalid" do
    bundle_1 = @user.notification_bundles.create!(
      starts_at: Time.current,
      ends_at: 4.hours.from_now,
      status: :pending
    )
    bundle_2 = @user.notification_bundles.build(
      starts_at: 2.hours.from_now,
      ends_at: 6.hours.from_now,
      status: :pending
    )
    assert_not bundle_2.valid?
    # Bundle with overlapping end time should be invalid
    bundle_3 = @user.notification_bundles.build(
      starts_at: 2.hours.ago,
      ends_at: 2.hours.from_now,
      status: :pending
    )
    assert_not bundle_3.valid?
    # Bundle completely within another bundle should be invalid
    bundle_4 = @user.notification_bundles.build(
      starts_at: 1.hour.from_now,
      ends_at: 3.hours.from_now,
      status: :pending
    )
    assert_not bundle_4.valid?
    # Non-overlapping bundle should be valid
    bundle_5 = @user.notification_bundles.build(
      starts_at: 5.hours.from_now,
      ends_at: 9.hours.from_now,
      status: :pending
    )
    assert bundle_5.valid?
  end
  test "overlapping bundles that are created relying on set_default_window are not created" do
    @user.notification_bundles.destroy_all
    bundle = @user.notification_bundles.create!(starts_at: Time.current)
    assert_raises ActiveRecord::RecordInvalid do
      @user.notification_bundles.create!(starts_at: bundle.starts_at - 1.second)
    end
  end
  test "deliver_all delivers due bundles" do
    @user.notification_bundles.destroy_all
    notification = @user.notifications.create!(source: events(:logo_published), creator: @user)
    bundle = @user.notification_bundles.pending.last
    assert bundle.pending?
    assert_includes bundle.notifications, notification
    bundle.update!(ends_at: 1.minute.ago)
    perform_enqueued_jobs only: Notification::Bundle::DeliverJob do
      Notification::Bundle.deliver_all
    end
    bundle.reload
    assert bundle.delivered?
  end
  test "deliver_all don't deliver bundles that are not due" do
    @user.notifications.create!(source: events(:logo_published), creator: @user)
    bundle = @user.notification_bundles.pending.last
    bundle.update!(ends_at: 1.minute.from_now)
    perform_enqueued_jobs only: Notification::Bundle::DeliverJob do
      Notification::Bundle.deliver_all
    end
    bundle.reload
    assert bundle.pending?
  end
  test "deliver sends email with time in user's time zone" do
    @user.settings.update!(timezone_name: "Madrid")
    freeze_time Time.utc(2025, 1, 15, 14, 30, 0) do
      @user.notifications.create!(source: events(:logo_published), creator: @user)
      bundle = @user.notification_bundles.pending.last
      bundle.deliver
      email = ActionMailer::Base.deliveries.last
      assert_not_nil email
      # Time in Madrid should be 15:30 (UTC+1 in winter)
      assert_match /notifications since 3pm/i, email.text_part&.body&.to_s
    end
  end
  test "out-of-order notification bundling should still work" do
    first_notification = @user.notifications.create!(source: events(:logo_published), creator: @user)
    second_notification = @user.notifications.create!(source: events(:logo_published), creator: @user)
    @user.notification_bundles.destroy_all
    assert first_notification.created_at < second_notification.created_at
    @user.bundle(second_notification)
    @user.bundle(first_notification)
    assert_equal 1, @user.notification_bundles.pending.count
    assert_equal 2, @user.notification_bundles.last.notifications.count
    assert_includes @user.notification_bundles.last.notifications, first_notification
    assert_includes @user.notification_bundles.last.notifications, second_notification
  end
  test "deliver does not send email for cancelled accounts" do
    @user.notifications.create!(source: events(:logo_published), creator: @user)
    bundle = @user.notification_bundles.pending.last
    @user.account.cancel(initiated_by: @user)
    assert_no_emails do
      deliver_enqueued_emails do
        bundle.deliver
      end
    end
    assert bundle.delivered?, "Bundle should be marked as delivered even if not sent"
  end
end

================
File: test/models/notifier/event_notifier_test.rb
================
require "test_helper"
class Notifier::EventNotifierTest < ActiveSupport::TestCase
  test "for returns the matching notifier class for the event" do
    assert_kind_of Notifier::CardEventNotifier, Notifier.for(events(:logo_published))
  end
  test "generate does not create notifications if the event was system-generated" do
    cards(:logo).drafted!
    events(:logo_published).update!(creator: accounts("37s").system_user)
    assert_no_difference -> { Notification.count } do
      Notifier.for(events(:logo_published)).notify
    end
  end
  test "creates a notification for each watcher, other than the event creator (events)" do
    notifications = Notifier.for(events(:layout_commented)).notify
    assert_equal [ users(:kevin) ], notifications.map(&:user)
  end
  test "creates a notification for each watcher (mentions)" do
    notifications = Notifier.for(events(:layout_commented)).notify
    assert_equal [ users(:kevin) ], notifications.map(&:user)
  end
  test "does not create a notification for access-only users" do
    boards(:writebook).access_for(users(:kevin)).access_only!
    notifications = Notifier.for(events(:layout_commented)).notify
    assert_equal [ users(:kevin) ], notifications.map(&:user)
  end
  test "links to the card" do
    boards(:writebook).access_for(users(:kevin)).watching!
    Notifier.for(events(:logo_published)).notify
    assert_equal cards(:logo), Notification.last.source.eventable
  end
  test "assignment events only create a notification for the assignee" do
    boards(:writebook).access_for(users(:jz)).watching!
    boards(:writebook).access_for(users(:kevin)).watching!
    notifications = Notifier.for(events(:logo_assignment_jz)).notify
    assert_equal [ users(:jz) ], notifications.map(&:user)
  end
  test "assignment events do not notify users who are access-only for the board" do
    boards(:writebook).access_for(users(:jz)).watching!
    events(:logo_assignment_jz).update! creator: users(:jz)
    notifications = Notifier.for(events(:logo_assignment_jz)).notify
    assert_empty notifications
  end
  test "assignment events do not notify you if you assigned yourself" do
    boards(:writebook).access_for(users(:david)).watching!
    notifications = Notifier.for(events(:logo_assignment_david)).notify
    assert_empty notifications
  end
  test "create notifications on publish for mentionees" do
    users(:kevin).mentioned_by(users(:david), at: cards(:logo))
    assert_difference -> { users(:kevin).notifications.count }, +1 do
      Notifier.for(events(:logo_published)).notify
    end
  end
  test "don'create notifications on publish for mentionees that are not watching" do
    users(:kevin).mentioned_by(users(:david), at: cards(:logo))
    cards(:logo).unwatch_by(users(:kevin))
    assert_difference -> { users(:kevin).notifications.count }, +1 do
      Notifier.for(events(:logo_published)).notify
    end
  end
  test "don't create notifications on comment for mentionees" do
    users(:david).mentioned_by(users(:kevin), at: cards(:layout))
    assert_no_difference -> { users(:david).notifications.count } do
      Notifier.for(events(:layout_commented)).notify
    end
  end
  test "assignment events notify assignees regardless of involvement level" do
    boards(:writebook).access_for(users(:jz)).access_only!
    notifications = Notifier.for(events(:logo_assignment_jz)).notify
    assert_equal [ users(:jz) ], notifications.map(&:user)
  end
end

================
File: test/models/notifier/mention_notifier_test.rb
================
require "test_helper"
class Notifier::EventNotifierTest < ActiveSupport::TestCase
  test "for returns the matching notifier class for the mention" do
    assert_kind_of Notifier::MentionNotifier, Notifier.for(mentions(:logo_card_david_mention_by_jz))
  end
  test "notify the mentionee" do
    users(:kevin).mentioned_by(users(:david), at: cards(:logo))
    assert_no_difference -> { users(:kevin).notifications.count } do
      Notifier.for(mentions(:logo_card_david_mention_by_jz)).notify
    end
  end
  test "create notifications for mentionee" do
    assert_no_difference -> { users(:david).notifications.count } do
      Notifier.for(events(:layout_commented)).notify
    end
  end
  test "don't create notifications for self-mentions" do
    assert_no_difference -> { users(:jz).notifications.count } do
      Notifier.for(events(:layout_commented)).notify
    end
  end
end

================
File: test/models/push/subscription_test.rb
================
require "test_helper"
class Push::SubscriptionTest < ActiveSupport::TestCase
  PUBLIC_TEST_IP = "142.250.185.206" # google.com IP
  setup do
    stub_dns_resolution(PUBLIC_TEST_IP)
  end
  test "valid subscription with permitted endpoint" do
    subscription = Push::Subscription.new(
      user: users(:david),
      endpoint: "https://fcm.googleapis.com/fcm/send/abc123",
      p256dh_key: "test_key",
      auth_key: "test_auth"
    )
    assert subscription.valid?
  end
  test "rejects endpoint with non-https scheme" do
    subscription = Push::Subscription.new(
      user: users(:david),
      endpoint: "http://fcm.googleapis.com/fcm/send/abc123",
      p256dh_key: "test_key",
      auth_key: "test_auth"
    )
    assert_not subscription.valid?
    assert_includes subscription.errors[:endpoint], "must use HTTPS"
  end
  test "rejects endpoint with non-permitted host" do
    subscription = Push::Subscription.new(
      user: users(:david),
      endpoint: "https://attacker.example.com/webhook",
      p256dh_key: "test_key",
      auth_key: "test_auth"
    )
    assert_not subscription.valid?
    assert_includes subscription.errors[:endpoint], "is not a permitted push service"
  end
  test "rejects endpoint that resolves to private IP" do
    stub_dns_resolution("192.168.1.1")
    subscription = Push::Subscription.new(
      user: users(:david),
      endpoint: "https://fcm.googleapis.com/fcm/send/abc123",
      p256dh_key: "test_key",
      auth_key: "test_auth"
    )
    assert_not subscription.valid?
    assert_includes subscription.errors[:endpoint], "resolves to a private or invalid IP address"
  end
  test "rejects endpoint that resolves to loopback IP" do
    stub_dns_resolution("127.0.0.1")
    subscription = Push::Subscription.new(
      user: users(:david),
      endpoint: "https://fcm.googleapis.com/fcm/send/abc123",
      p256dh_key: "test_key",
      auth_key: "test_auth"
    )
    assert_not subscription.valid?
    assert_includes subscription.errors[:endpoint], "resolves to a private or invalid IP address"
  end
  test "rejects endpoint that resolves to link-local IP (AWS IMDS)" do
    stub_dns_resolution("169.254.169.254")
    subscription = Push::Subscription.new(
      user: users(:david),
      endpoint: "https://fcm.googleapis.com/fcm/send/abc123",
      p256dh_key: "test_key",
      auth_key: "test_auth"
    )
    assert_not subscription.valid?
    assert_includes subscription.errors[:endpoint], "resolves to a private or invalid IP address"
  end
  test "resolved_endpoint_ip returns pinned public IP" do
    subscription = Push::Subscription.new(
      user: users(:david),
      endpoint: "https://fcm.googleapis.com/fcm/send/abc123",
      p256dh_key: "test_key",
      auth_key: "test_auth"
    )
    assert_equal PUBLIC_TEST_IP, subscription.resolved_endpoint_ip
  end
  test "accepts all permitted push service domains" do
    permitted_endpoints = [
      "https://fcm.googleapis.com/fcm/send/token123",
      "https://jmt17.google.com/fcm/send/token123",
      "https://updates.push.services.mozilla.com/wpush/v2/token123",
      "https://web.push.apple.com/QaBC123",
      "https://wns2-db5p.notify.windows.com/w/?token=abc123"
    ]
    permitted_endpoints.each do |endpoint|
      subscription = Push::Subscription.new(
        user: users(:david),
        endpoint: endpoint,
        p256dh_key: "test_key",
        auth_key: "test_auth"
      )
      assert subscription.valid?, "Expected #{endpoint} to be valid, got errors: #{subscription.errors.full_messages}"
    end
  end
  private
    def stub_dns_resolution(*ips)
      dns_mock = mock("dns")
      dns_mock.stubs(:each_address).multiple_yields(*ips)
      Resolv::DNS.stubs(:open).yields(dns_mock)
    end
end

================
File: test/models/search/highlighter_test.rb
================
require "test_helper"
class Search::HighlighterTest < ActiveSupport::TestCase
  test "highlight simple word match" do
    highlighter = Search::Highlighter.new("hello")
    result = highlighter.highlight("Hello world")
    assert_equal "#{mark('Hello')} world", result
  end
  test "highlight multiple occurrences" do
    highlighter = Search::Highlighter.new("test")
    result = highlighter.highlight("This is a test and another test")
    assert_equal "This is a #{mark('test')} and another #{mark('test')}", result
  end
  test "highlight case insensitive" do
    highlighter = Search::Highlighter.new("ruby")
    result = highlighter.highlight("Ruby is great and RUBY rocks")
    assert_equal "#{mark('Ruby')} is great and #{mark('RUBY')} rocks", result
  end
  test "highlight quoted phrases" do
    highlighter = Search::Highlighter.new('"hello world"')
    result = highlighter.highlight("Say hello world to everyone")
    assert_equal "Say #{mark('hello world')} to everyone", result
  end
  test "snippet returns full text with highlights when under max words" do
    highlighter = Search::Highlighter.new("ruby")
    result = highlighter.snippet("Ruby is great", max_words: 20)
    assert_equal "#{mark('Ruby')} is great", result
  end
  test "snippet creates excerpt around match" do
    highlighter = Search::Highlighter.new("match")
    text = "word " * 10 + "match " + "word " * 10
    result = highlighter.snippet(text, max_words: 10)
    assert result.start_with?("...")
    assert result.end_with?("...")
    assert_includes result, mark("match")
  end
  test "snippet adds leading ellipsis when match is not at start" do
    highlighter = Search::Highlighter.new("middle")
    text = "word " * 20 + "middle"
    result = highlighter.snippet(text, max_words: 10)
    assert result.start_with?("...")
    assert_not result.end_with?("...")
    assert_includes result, mark("middle")
  end
  test "snippet adds trailing ellipsis when text continues after excerpt" do
    highlighter = Search::Highlighter.new("start")
    text = "start " + "word " * 30
    result = highlighter.snippet(text, max_words: 10)
    assert result.end_with?("...")
    assert_not result.start_with?("...")
    assert_includes result, mark("start")
  end
  test "snippet falls back to truncation when no match found" do
    highlighter = Search::Highlighter.new("nomatch")
    text = "This text does not contain the search term " + "word " * 50
    result = highlighter.snippet(text, max_words: 10)
    assert_includes result, "..."
    assert_not_includes result, Search::Highlighter::OPENING_MARK
  end
  test "highlight escapes HTML and preserves marks" do
    highlighter = Search::Highlighter.new("test")
    result = highlighter.highlight("<script>test</script>")
    assert_equal "&lt;script&gt;#{mark('test')}&lt;/script&gt;", result
  end
  private
    def mark(text)
      "#{Search::Highlighter::OPENING_MARK}#{text}#{Search::Highlighter::CLOSING_MARK}"
    end
end

================
File: test/models/search/stemmer_test.rb
================
require "test_helper"
class Search::StemmerTest < ActiveSupport::TestCase
  test "stem single word" do
    result = Search::Stemmer.stem("running")
    assert_equal "run", result
  end
  test "stem multiple words" do
    result = Search::Stemmer.stem("test, running      JUMPING & walking")
    assert_equal "test run jump walk", result
  end
end

================
File: test/models/signup/account_name_generator_test.rb
================
require "test_helper"
class Signup::AccountNameGeneratorTest < ActiveSupport::TestCase
  setup do
    @identity = Identity.create!(email_address: "newart.userbaum@example.com")
    @name = "Newart userbaum"
    @generator = Signup::AccountNameGenerator.new(identity: @identity, name: @name)
  end
  test "generate" do
    account_name = @generator.generate
    assert_equal "Newart's Fizzy", account_name, "The 1st account doesn't have 1st in the name"
    first_account = Account.create!(external_account_id: "1st", name: account_name)
    Current.without_account do
      @identity.users.create!(account: first_account, name: @name)
      @identity.reload
    end
    account_name = @generator.generate
    assert_equal "Newart's 2nd Fizzy", account_name
    second_account = Account.create!(external_account_id: "2nd", name: account_name)
    Current.without_account do
      @identity.users.create!(account: second_account, name: @name)
      @identity.reload
    end
    account_name = @generator.generate
    assert_equal "Newart's 3rd Fizzy", account_name
    third_account = Account.create!(external_account_id: "3rd", name: account_name)
    Current.without_account do
      @identity.users.create!(account: third_account, name: @name)
      @identity.reload
    end
    account_name = @generator.generate
    assert_equal "Newart's 4th Fizzy", account_name
    fourth_account = Account.create!(external_account_id: "4th", name: account_name)
    Current.without_account do
      @identity.users.create!(account: fourth_account, name: @name)
      @identity.reload
    end
    account_name = @generator.generate
    assert_equal "Newart's 5th Fizzy", account_name
  end
  test "generate continues from the previous highest index" do
    account = Account.create!(external_account_id: "12th", name: "Newart's 12th Fizzy")
    Current.without_account do
      @identity.users.create!(account: account, name: @name)
      @identity.reload
    end
    account_name = @generator.generate
    assert_equal "Newart's 13th Fizzy", account_name
  end
end

================
File: test/models/storage/attachment_tracking_test.rb
================
require "test_helper"
class Storage::AttachmentTrackingTest < ActiveSupport::TestCase
  setup do
    Current.session = sessions(:david)
    Current.request_id = "test-request-123"
    @account = accounts("37s")
    @board = boards(:writebook)
    @card = cards(:logo)
  end
  # Attachment Creation
  test "attaching file creates storage entry with positive delta" do
    assert_difference "Storage::Entry.count", +1 do
      @card.image.attach io: StringIO.new("x" * 2048), filename: "test.png", content_type: "image/png"
    end
    entry = Storage::Entry.last
    assert_equal 2048, entry.delta
    assert_equal "attach", entry.operation
    assert_equal @account.id, entry.account_id
    assert_equal @board.id, entry.board_id
    assert_equal @card.class.name, entry.recordable_type
    assert_equal @card.id, entry.recordable_id
    assert_equal @card.image.blob.id, entry.blob_id
    assert_equal Current.user.id, entry.user_id
    assert_equal Current.request_id, entry.request_id
  end
  test "attaching file enqueues MaterializeJob for account" do
    assert_enqueued_with job: Storage::MaterializeJob, args: [ @account ] do
      @card.image.attach io: StringIO.new("x" * 1024), filename: "test.png", content_type: "image/png"
    end
  end
  test "attaching file enqueues MaterializeJob for board" do
    assert_enqueued_with job: Storage::MaterializeJob, args: [ @board ] do
      @card.image.attach io: StringIO.new("x" * 1024), filename: "test.png", content_type: "image/png"
    end
  end
  # Attachment Deletion
  test "destroying attachment creates storage entry with negative delta" do
    @card.image.attach io: StringIO.new("x" * 2048), filename: "test.png", content_type: "image/png"
    attachment = @card.image.attachment
    blob_id = attachment.blob_id
    # Destroy the attachment directly to trigger callbacks
    attachment.destroy!
    entry = Storage::Entry.find_by(operation: "detach", recordable: @card)
    assert_not_nil entry, "Expected detach entry to be created"
    assert_equal -2048, entry.delta
    assert_equal "detach", entry.operation
    assert_equal blob_id, entry.blob_id
  end
  test "destroying attachment uses snapshotted IDs from before_destroy" do
    @card.image.attach io: StringIO.new("x" * 1024), filename: "test.png", content_type: "image/png"
    # Capture expected values before destroy
    expected_account_id = @account.id
    expected_board_id = @board.id
    expected_recordable_type = @card.class.name
    expected_recordable_id = @card.id
    attachment = @card.image.attachment
    attachment.destroy!
    entry = Storage::Entry.find_by(operation: "detach", recordable_id: expected_recordable_id)
    assert_not_nil entry, "Expected detach entry to be created"
    assert_equal expected_account_id, entry.account_id
    assert_equal expected_board_id, entry.board_id
    assert_equal expected_recordable_type, entry.recordable_type
    assert_equal expected_recordable_id, entry.recordable_id
  end
  # Non-Trackable Records
  test "does not track attachments on records without account method" do
    # Account uploads are not trackable (Account.account returns self, but
    # uploads on Account are not board-scoped in the same way)
    # This test verifies the guard clause works
    # Create a model that doesn't respond to :board
    identity = identities(:david)
    # Identity doesn't have :account or :board, so attachments shouldn't be tracked
    # (Though in practice, Identity may not have attachments in this codebase)
    # We test the guard by checking that the tracking module handles non-trackable records
    assert_respond_to @card, :account
    assert_respond_to @card, :board
  end
  # Edge Cases
  test "attachment tracking handles nil board gracefully" do
    # Create a card with nil board association won't happen in practice
    # but test that entry creation handles nil board_id
    @card.image.attach io: StringIO.new("x" * 1024), filename: "test.png", content_type: "image/png"
    entry = Storage::Entry.last
    assert_not_nil entry.account_id
    # board_id should be present for cards
    assert_not_nil entry.board_id
  end
  test "replacing attachment creates detach and attach entries" do
    # First attachment
    @card.image.attach io: StringIO.new("x" * 1024), filename: "first.png", content_type: "image/png"
    initial_count = Storage::Entry.count
    # Replace with new attachment
    @card.image.attach io: StringIO.new("x" * 2048), filename: "second.png", content_type: "image/png"
    # Should have detach (-1024) and attach (+2048) entries
    # Note: depending on purge_later vs purge, the detach might be async
    entries = Storage::Entry.where(recordable: @card).order(:id).last(2)
    # At minimum, we should have the new attach entry
    attach_entry = entries.find { |e| e.operation == "attach" && e.delta == 2048 }
    assert_not_nil attach_entry
  end
  # Rich Text Embeds
  #
  # ActionText embeds are automatically extracted from body content that contains
  # <action-text-attachment> tags referencing ActiveStorage::Blob objects.
  # The embeds association is populated during before_validation callback.
  test "card description embed creates storage entry" do
    blob = ActiveStorage::Blob.create_and_upload! \
      io: file_fixture("moon.jpg").open,
      filename: "card_embed.jpg",
      content_type: "image/jpeg"
    # Create rich text content with embedded blob attachment
    attachment_html = ActionText::Attachment.from_attachable(blob).to_html
    assert_difference "Storage::Entry.count", +1 do
      @card.update!(description: "<p>Description with image: #{attachment_html}</p>")
    end
    entry = Storage::Entry.last
    assert_equal blob.byte_size, entry.delta
    assert_equal "attach", entry.operation
    assert_equal "Card", entry.recordable_type
    assert_equal @card.id, entry.recordable_id
  end
  test "comment embed creates storage entry via rich text body" do
    blob = ActiveStorage::Blob.create_and_upload! \
      io: file_fixture("moon.jpg").open,
      filename: "comment_image.jpg",
      content_type: "image/jpeg"
    attachment_html = ActionText::Attachment.from_attachable(blob).to_html
    assert_difference "Storage::Entry.count", +1 do
      @card.comments.create!(body: "<p>Comment with image: #{attachment_html}</p>")
    end
    entry = Storage::Entry.last
    assert_equal blob.byte_size, entry.delta
    assert_equal "attach", entry.operation
    assert_equal @account.id, entry.account_id
    assert_equal @board.id, entry.board_id
    assert_equal "Comment", entry.recordable_type
  end
  test "comment embed uses card's board for tracking" do
    blob = ActiveStorage::Blob.create_and_upload! \
      io: file_fixture("moon.jpg").open,
      filename: "test.jpg",
      content_type: "image/jpeg"
    attachment_html = ActionText::Attachment.from_attachable(blob).to_html
    comment = @card.comments.create!(body: "<p>Comment: #{attachment_html}</p>")
    entry = Storage::Entry.last
    assert_equal @card.board_id, entry.board_id
    assert_equal comment.id, entry.recordable_id
  end
  test "board public_description embed creates storage entry" do
    blob = ActiveStorage::Blob.create_and_upload! \
      io: file_fixture("moon.jpg").open,
      filename: "board_image.jpg",
      content_type: "image/jpeg"
    attachment_html = ActionText::Attachment.from_attachable(blob).to_html
    assert_difference "Storage::Entry.count", +1 do
      @board.update!(public_description: "<p>Board description: #{attachment_html}</p>")
    end
    entry = Storage::Entry.last
    assert_equal blob.byte_size, entry.delta
    assert_equal "attach", entry.operation
    assert_equal @account.id, entry.account_id
    assert_equal @board.id, entry.board_id
    assert_equal "Board", entry.recordable_type
    assert_equal @board.id, entry.recordable_id
  end
  # Reconciliation includes all attachment types
  test "board calculate_real_storage_bytes includes comment embeds" do
    blob = ActiveStorage::Blob.create_and_upload! \
      io: file_fixture("moon.jpg").open,
      filename: "comment_embed.jpg",
      content_type: "image/jpeg"
    attachment_html = ActionText::Attachment.from_attachable(blob).to_html
    @card.comments.create!(body: "<p>Comment: #{attachment_html}</p>")
    board_bytes = @board.send(:calculate_real_storage_bytes)
    assert board_bytes >= blob.byte_size, "board bytes should include comment embed bytes"
  end
  test "account calculate_real_storage_bytes includes comment embeds via boards" do
    blob = ActiveStorage::Blob.create_and_upload! \
      io: file_fixture("moon.jpg").open,
      filename: "comment_embed.jpg",
      content_type: "image/jpeg"
    attachment_html = ActionText::Attachment.from_attachable(blob).to_html
    @card.comments.create!(body: "<p>Comment: #{attachment_html}</p>")
    account_bytes = @account.send(:calculate_real_storage_bytes)
    assert account_bytes >= blob.byte_size, "account bytes should include comment embed bytes"
  end
  # Cascading Deletes
  test "attachment tracking handles card deletion gracefully" do
    @card.image.attach io: StringIO.new("x" * 1024), filename: "test.png", content_type: "image/png"
    card_id = @card.id
    # Delete the card - this should trigger attachment purge
    # The before_destroy snapshot should capture IDs before card is gone
    perform_enqueued_jobs do
      assert_nothing_raised do
        @card.destroy!
      end
    end
    # Should have detach entry with snapshotted IDs
    detach_entry = Storage::Entry.find_by(recordable_id: card_id, operation: "detach")
    assert_not_nil detach_entry, "Expected detach entry for destroyed card"
    assert_equal -1024, detach_entry.delta
  end
end

================
File: test/models/storage/entry_test.rb
================
require "test_helper"
class Storage::EntryTest < ActiveSupport::TestCase
  setup do
    @account = accounts("37s")
    @board = boards(:writebook)
    @card = cards(:logo)
  end
  test "record creates entry with positive delta" do
    assert_difference "Storage::Entry.count", +1 do
      entry = Storage::Entry.record \
        account: @account,
        board: @board,
        recordable: @card,
        delta: 1024,
        operation: "attach"
      assert_equal @account.id, entry.account_id
      assert_equal @board.id, entry.board_id
      assert_equal @card.class.name, entry.recordable_type
      assert_equal @card.id, entry.recordable_id
      assert_equal 1024, entry.delta
      assert_equal "attach", entry.operation
    end
  end
  test "record creates entry with negative delta" do
    entry = Storage::Entry.record \
      account: @account,
      board: @board,
      recordable: @card,
      delta: -512,
      operation: "detach"
    assert_equal -512, entry.delta
    assert_equal "detach", entry.operation
  end
  test "record returns nil and creates no entry when delta is zero" do
    assert_no_difference "Storage::Entry.count" do
      result = Storage::Entry.record \
        account: @account,
        board: @board,
        recordable: @card,
        delta: 0,
        operation: "attach"
      assert_nil result
    end
  end
  test "record works with destroyed records (destroyed? check)" do
    # Simulate a destroyed record - .id still works after destroy
    @card.destroy
    entry = Storage::Entry.record \
      account: @account,
      board: @board,
      recordable: @card,
      delta: 2048,
      operation: "detach"
    assert_equal @account.id, entry.account_id
    assert_equal @board.id, entry.board_id
    assert_equal "Card", entry.recordable_type
    assert_equal @card.id, entry.recordable_id
  end
  test "record creates entry without board" do
    entry = Storage::Entry.record \
      account: @account,
      board: nil,
      recordable: @card,
      delta: 1024,
      operation: "attach"
    assert_nil entry.board_id
  end
  test "record creates entry without recordable" do
    entry = Storage::Entry.record \
      account: @account,
      board: @board,
      recordable: nil,
      delta: 1024,
      operation: "reconcile"
    assert_nil entry.recordable_type
    assert_nil entry.recordable_id
  end
  test "record enqueues MaterializeJob for account" do
    assert_enqueued_with job: Storage::MaterializeJob, args: [ @account ] do
      Storage::Entry.record \
        account: @account,
        board: nil,
        recordable: nil,
        delta: 1024,
        operation: "attach"
    end
  end
  test "record enqueues MaterializeJob for board when board_id present" do
    assert_enqueued_with job: Storage::MaterializeJob, args: [ @board ] do
      Storage::Entry.record \
        account: @account,
        board: @board,
        recordable: nil,
        delta: 1024,
        operation: "attach"
    end
  end
  test "record skips entirely when account is destroyed" do
    # No need to track storage for deleted accounts
    @account.destroy
    assert_no_difference "Storage::Entry.count" do
      result = Storage::Entry.record \
        account: @account,
        delta: 1024,
        operation: "attach"
      assert_nil result
    end
  end
  test "record does not enqueue board job when board is destroyed" do
    @board.destroy
    # Account job still enqueued, but destroyed board skips its job
    jobs = []
    assert_enqueued_with job: Storage::MaterializeJob, args: [ @account ] do
      Storage::Entry.record \
        account: @account,
        board: @board,
        delta: 1024,
        operation: "attach"
    end
    # Verify board job was NOT enqueued
    board_jobs = enqueued_jobs.select { |j| j["arguments"].include?(@board.to_global_id.to_s) }
    assert_empty board_jobs
  end
  test "entries belong to account" do
    entry = Storage::Entry.record \
      account: @account,
      delta: 1024,
      operation: "attach"
    assert_equal @account, entry.account
  end
  test "entries belong to board (optional)" do
    entry = Storage::Entry.record \
      account: @account,
      board: @board,
      delta: 1024,
      operation: "attach"
    assert_equal @board, entry.board
  end
  test "entries belong to recordable (polymorphic, optional)" do
    entry = Storage::Entry.record \
      account: @account,
      recordable: @card,
      delta: 1024,
      operation: "attach"
    assert_equal @card, entry.recordable
  end
end

================
File: test/models/storage/no_reuse_test.rb
================
require "test_helper"
class Storage::NoReuseTest < ActiveSupport::TestCase
  setup do
    Current.session = sessions(:david)
    @account = accounts("37s")
    Current.account = @account  # Ensure blobs get correct account_id
    @board = @account.boards.create!(name: "Test", creator: users(:david))
  end
  # No-reuse validation
  # NOTE: For persisted records, ActiveStorage::Attached::One#attach raises
  # ActiveRecord::RecordNotSaved when validation fails.
  test "rejects attaching blob that already has tracked attachment" do
    blob = ActiveStorage::Blob.create_and_upload! \
      io: StringIO.new("x" * 1000),
      filename: "test.png",
      content_type: "image/png"
    # First attachment succeeds
    card1 = @board.cards.create!(title: "Card 1", creator: users(:david))
    card1.image.attach(blob)
    assert card1.image.attached?
    # Second attachment of same blob fails
    card2 = @board.cards.create!(title: "Card 2", creator: users(:david))
    assert_raises ActiveRecord::RecordNotSaved do
      card2.image.attach(blob)
    end
    # Verify only one attachment exists for this blob
    assert_equal 1, ActiveStorage::Attachment.where(blob_id: blob.id).count
  end
  test "allows reuse for ActionText embeds" do
    file = file_fixture("moon.jpg")
    blob = ActiveStorage::Blob.create_and_upload! \
      io: file.open,
      filename: "embed.jpg",
      content_type: "image/jpeg"
    embed_html = ActionText::Attachment.from_attachable(blob).to_html
    card1 = @board.cards.create!(title: "Card 1", creator: users(:david))
    card1.update!(description: "<p>#{embed_html}</p>")
    card1.reload
    card2 = @board.cards.create!(title: "Card 2", creator: users(:david))
    card2.update!(description: "<p>#{embed_html}</p>")
    card2.reload
    assert_equal 2, ActiveStorage::Attachment.where(
      record_type: "ActionText::RichText",
      name: "embeds",
      blob_id: blob.id
    ).count
  end
  test "purge_later does not purge blob when still attached elsewhere" do
    file = file_fixture("moon.jpg")
    blob = ActiveStorage::Blob.create_and_upload! \
      io: file.open,
      filename: "embed.jpg",
      content_type: "image/jpeg"
    embed_html = ActionText::Attachment.from_attachable(blob).to_html
    card1 = @board.cards.create!(title: "Card 1", creator: users(:david))
    card1.update!(description: "<p>#{embed_html}</p>")
    card2 = @board.cards.create!(title: "Card 2", creator: users(:david))
    card2.update!(description: "<p>#{embed_html}</p>")
    attachment = ActiveStorage::Attachment.find_by(
      record: card1.rich_text_description,
      name: "embeds",
      blob_id: blob.id
    )
    assert_no_enqueued_jobs only: ActiveStorage::PurgeJob do
      attachment.purge_later
    end
    assert ActiveStorage::Blob.exists?(blob.id)
    assert_equal 1, ActiveStorage::Attachment.where(blob_id: blob.id).count
  end
  test "purge_later enqueues purge when last attachment is removed" do
    file = file_fixture("moon.jpg")
    blob = ActiveStorage::Blob.create_and_upload! \
      io: file.open,
      filename: "embed.jpg",
      content_type: "image/jpeg"
    embed_html = ActionText::Attachment.from_attachable(blob).to_html
    card = @board.cards.create!(title: "Card", creator: users(:david))
    card.update!(description: "<p>#{embed_html}</p>")
    card.reload
    attachment = ActiveStorage::Attachment.find_by(
      record: card.rich_text_description,
      name: "embeds",
      blob_id: blob.id
    )
    assert_enqueued_with job: ActiveStorage::PurgeJob, args: [ blob ] do
      attachment.purge_later
    end
  end
  test "rejects cross-account blob attachment" do
    other_account = Account.create!(name: "Other")
    other_board = other_account.boards.create!(name: "Other Board", creator: users(:david))
    # Blob created in @account context
    blob = ActiveStorage::Blob.create_and_upload! \
      io: StringIO.new("x" * 1000),
      filename: "test.png",
      content_type: "image/png"
    card = other_board.cards.create!(title: "Card", creator: users(:david))
    assert_raises ActiveRecord::RecordNotSaved do
      card.image.attach(blob)
    end
    # Verify attachment was not created (blob account doesn't match record account)
    assert_not card.reload.image.attached?
  end
  test "allows attaching blob to untracked record type" do
    file = file_fixture("moon.jpg")
    blob = ActiveStorage::Blob.create_and_upload! \
      io: file.open,
      filename: "avatar.jpg",
      content_type: "image/jpeg"
    # User avatar is not a tracked record type
    user = users(:david)
    user.avatar.attach(blob)
    # Should succeed - avatars are not storage-tracked
    assert user.avatar.attached?
  end
  test "allows multiple attachments of same blob to untracked record types" do
    file = file_fixture("moon.jpg")
    blob = ActiveStorage::Blob.create_and_upload! \
      io: file.open,
      filename: "avatar.jpg",
      content_type: "image/jpeg"
    # First attachment to untracked (avatar)
    user1 = users(:david)
    user1.avatar.attach(blob)
    assert user1.avatar.attached?
    # Second attachment to untracked (another avatar) should work
    # since no-reuse only checks tracked contexts
    user2 = users(:jz)
    user2.avatar.attach(blob)
    assert user2.avatar.attached?
  end
end

================
File: test/models/storage/total_test.rb
================
require "test_helper"
class Storage::TotalTest < ActiveSupport::TestCase
  setup do
    @account = accounts("37s")
    @board = boards(:writebook)
  end
  test "pending_entries returns all entries when no cursor" do
    # Create some entries
    3.times do |i|
      Storage::Entry.record \
        account: @account,
        delta: 1024 * (i + 1),
        operation: "attach"
    end
    total = @account.create_storage_total!
    assert_nil total.last_entry_id
    assert_equal 3, total.pending_entries.count
  end
  test "pending_entries returns only entries after cursor" do
    # Create first entry and set cursor
    entry1 = Storage::Entry.record(account: @account, delta: 1024, operation: "attach")
    total = @account.create_storage_total!(last_entry_id: entry1.id, bytes_stored: 1024)
    # Advance time to ensure UUIDv7 timestamps sort correctly
    travel 1.second
    # Create more entries AFTER cursor is set
    entry2 = Storage::Entry.record(account: @account, delta: 2048, operation: "attach")
    travel 1.second
    entry3 = Storage::Entry.record(account: @account, delta: 512, operation: "attach")
    pending = total.pending_entries
    assert_equal 2, pending.count
    assert_includes pending, entry2
    assert_includes pending, entry3
    assert_not_includes pending, entry1
  end
  test "current_usage returns snapshot value when no pending entries" do
    total = @account.create_storage_total!(bytes_stored: 5000)
    # No entries exist, so nothing pending
    assert_equal 5000, total.current_usage
  end
  test "current_usage sums snapshot and pending entries" do
    # Create first entry and set cursor
    entry1 = Storage::Entry.record(account: @account, delta: 1024, operation: "attach")
    total = @account.create_storage_total!(last_entry_id: entry1.id, bytes_stored: 1024)
    # Small delay to ensure UUIDv7 timestamp component advances
    travel 1.second
    # Create more entries AFTER cursor is set
    Storage::Entry.record(account: @account, delta: 2048, operation: "attach")
    travel 1.second
    Storage::Entry.record(account: @account, delta: -512, operation: "detach")
    # 1024 (snapshot) + 2048 - 512 (pending) = 2560
    assert_equal 2560, total.current_usage
  end
  test "belongs to owner polymorphically" do
    account_total = Storage::Total.create!(owner: @account)
    assert_equal @account, account_total.owner
    board_total = Storage::Total.create!(owner: @board)
    assert_equal @board, board_total.owner
  end
  test "unique constraint on owner" do
    Storage::Total.create!(owner: @account)
    assert_raises ActiveRecord::RecordNotUnique do
      Storage::Total.create!(owner: @account)
    end
  end
end

================
File: test/models/storage/totaled_test.rb
================
require "test_helper"
class Storage::TotaledTest < ActiveSupport::TestCase
  setup do
    Current.session = sessions(:david)
    @account = accounts("37s")
    @board = boards(:writebook)
  end
  # bytes_used (fast snapshot)
  test "bytes_used returns 0 when no storage_total exists" do
    assert_nil @account.storage_total
    assert_equal 0, @account.bytes_used
  end
  test "bytes_used returns snapshot value" do
    @account.create_storage_total!(bytes_stored: 10_000)
    assert_equal 10_000, @account.bytes_used
  end
  test "bytes_used does not include pending entries (fast path)" do
    @account.create_storage_total!(bytes_stored: 1000)
    # Create pending entry (not materialized)
    Storage::Entry.record(account: @account, delta: 500, operation: "attach")
    # bytes_used is fast path - only reads snapshot
    assert_equal 1000, @account.bytes_used
  end
  # bytes_used_exact (snapshot + pending)
  test "bytes_used_exact creates storage_total if missing" do
    assert_nil @account.storage_total
    @account.bytes_used_exact
    assert_not_nil @account.reload.storage_total
  end
  test "bytes_used_exact includes pending entries" do
    # Create first entry and set cursor at that entry
    entry = Storage::Entry.record(account: @account, delta: 500, operation: "attach")
    @account.create_storage_total!(bytes_stored: 500, last_entry_id: entry.id)
    # Small delay to ensure UUIDv7 timestamp advances
    travel 1.second
    # Create pending entry AFTER cursor
    Storage::Entry.record(account: @account, delta: 256, operation: "attach")
    # 500 (snapshot) + 256 (pending) = 756
    assert_equal 756, @account.bytes_used_exact
  end
  test "bytes_used_exact returns 0 when no entries and no snapshot" do
    assert_equal 0, @account.bytes_used_exact
  end
  # materialize_storage
  test "materialize_storage creates storage_total if missing" do
    assert_nil @account.storage_total
    Storage::Entry.record(account: @account, delta: 1024, operation: "attach")
    @account.materialize_storage
    total = @account.reload.storage_total
    assert_not_nil total
    assert_equal 1024, total.bytes_stored
  end
  test "materialize_storage processes all pending entries" do
    Storage::Entry.record(account: @account, delta: 1000, operation: "attach")
    Storage::Entry.record(account: @account, delta: 2000, operation: "attach")
    Storage::Entry.record(account: @account, delta: -500, operation: "detach")
    @account.materialize_storage
    assert_equal 2500, @account.storage_total.bytes_stored
    assert_equal 0, @account.storage_total.pending_entries.count
  end
  test "materialize_storage updates cursor to latest entry" do
    entry1 = Storage::Entry.record(account: @account, delta: 1000, operation: "attach")
    entry2 = Storage::Entry.record(account: @account, delta: 500, operation: "attach")
    @account.materialize_storage
    assert_equal entry2.id, @account.storage_total.last_entry_id
  end
  test "materialize_storage is idempotent when no new entries" do
    Storage::Entry.record(account: @account, delta: 1000, operation: "attach")
    @account.materialize_storage
    initial_bytes = @account.storage_total.bytes_stored
    initial_cursor = @account.storage_total.last_entry_id
    @account.materialize_storage
    assert_equal initial_bytes, @account.storage_total.bytes_stored
    assert_equal initial_cursor, @account.storage_total.last_entry_id
  end
  test "materialize_storage processes only entries since cursor" do
    entry1 = Storage::Entry.record(account: @account, delta: 1000, operation: "attach")
    @account.materialize_storage
    assert_equal 1000, @account.storage_total.bytes_stored
    # Small delay to ensure UUIDv7 timestamp advances
    travel 1.second
    # Add more entries
    Storage::Entry.record(account: @account, delta: 500, operation: "attach")
    @account.materialize_storage
    assert_equal 1500, @account.storage_total.bytes_stored
  end
  test "materialize_storage does nothing when no entries" do
    @account.materialize_storage
    total = @account.reload.storage_total
    assert_not_nil total
    assert_equal 0, total.bytes_stored
    assert_nil total.last_entry_id
  end
  test "materialize_storage handles concurrent calls safely" do
    # Pre-create storage_total to avoid unique constraint race
    @account.create_storage_total!
    Storage::Entry.record(account: @account, delta: 1000, operation: "attach")
    # Simulate concurrent materialization
    threads = 3.times.map do
      Thread.new do
        ActiveRecord::Base.connection_pool.with_connection do
          @account.materialize_storage
        end
      end
    end
    threads.each(&:join)
    # Should still have correct total
    assert_equal 1000, @account.reload.storage_total.bytes_stored
  end
  # storage_entries association
  test "account has storage_entries association" do
    entry = Storage::Entry.record(account: @account, delta: 1024, operation: "attach")
    assert_includes @account.storage_entries, entry
  end
  test "board has storage_entries association" do
    entry = Storage::Entry.record(account: @account, board: @board, delta: 1024, operation: "attach")
    assert_includes @board.storage_entries, entry
  end
  # storage_total association
  test "storage_total is destroyed when owner is destroyed" do
    @account.create_storage_total!(bytes_stored: 1000)
    total_id = @account.storage_total.id
    # Create a new account to destroy (don't destroy fixtures)
    new_account = Account.create!(name: "Temp Account")
    new_account.create_storage_total!(bytes_stored: 500)
    storage_total_id = new_account.storage_total.id
    new_account.destroy!
    assert_not Storage::Total.exists?(storage_total_id)
  end
  # Board-specific tests
  test "board bytes_used works independently of account" do
    # Create entries for both account and board
    Storage::Entry.record(account: @account, board: nil, delta: 1000, operation: "attach")
    Storage::Entry.record(account: @account, board: @board, delta: 500, operation: "attach")
    @account.materialize_storage
    @board.materialize_storage
    # Account sees all its entries (1000 + 500 = 1500)
    assert_equal 1500, @account.bytes_used
    # Board only sees entries with its board_id (500)
    assert_equal 500, @board.bytes_used
  end
  test "board and account have independent cursors" do
    entry1 = Storage::Entry.record(account: @account, board: @board, delta: 1000, operation: "attach")
    @account.materialize_storage
    # Board not yet materialized
    entry2 = Storage::Entry.record(account: @account, board: @board, delta: 500, operation: "attach")
    # Account cursor at entry1, board has no cursor yet
    assert_equal entry1.id, @account.storage_total.last_entry_id
    @board.materialize_storage
    # Board cursor now at entry2
    assert_equal entry2.id, @board.storage_total.last_entry_id
    assert_equal 1500, @board.bytes_used
  end
  # reconcile_storage
  test "reconcile_storage creates entry for drift" do
    board = @account.boards.create!(name: "Test Board", creator: users(:david))
    card = board.cards.create!(title: "Test Card", creator: users(:david))
    card.image.attach io: StringIO.new("x" * 1000), filename: "test.png", content_type: "image/png"
    # Delete entry to simulate drift
    Storage::Entry.where(board: board).delete_all
    assert_difference "Storage::Entry.count", +1 do
      board.reconcile_storage
    end
    entry = Storage::Entry.find_by(board: board, operation: "reconcile")
    assert_equal 1000, entry.delta
  end
  test "reconcile_storage no-op when ledger matches reality" do
    board = @account.boards.create!(name: "Test Board", creator: users(:david))
    card = board.cards.create!(title: "Test Card", creator: users(:david))
    card.image.attach io: StringIO.new("x" * 1000), filename: "test.png", content_type: "image/png"
    assert_no_difference "Storage::Entry.where(operation: 'reconcile').count" do
      board.reconcile_storage
    end
  end
  test "reconcile_storage handles empty board" do
    board = @account.boards.create!(name: "Empty Board", creator: users(:david))
    assert_no_difference "Storage::Entry.count" do
      board.reconcile_storage
    end
  end
  test "reconcile_storage handles negative drift" do
    board = @account.boards.create!(name: "Test Board", creator: users(:david))
    # Create fake ledger entry with no real attachment
    Storage::Entry.create! \
      account_id: @account.id,
      board_id: board.id,
      delta: 5000,
      operation: "attach"
    board.reconcile_storage
    entry = Storage::Entry.find_by(board: board, operation: "reconcile")
    assert_not_nil entry
    assert_equal(-5000, entry.delta)
  end
  test "reconcile_storage aborts when entry added during scan" do
    board = @account.boards.create!(name: "Test Board", creator: users(:david))
    card = board.cards.create!(title: "Test Card", creator: users(:david))
    card.image.attach io: StringIO.new("x" * 1000), filename: "test.png", content_type: "image/png"
    # Delete entry to create drift
    Storage::Entry.where(board: board).delete_all
    # Intercept calculate_real_storage_bytes to insert a new entry mid-scan,
    # faithfully simulating a concurrent upload that changes the cursor
    board.define_singleton_method(:calculate_real_storage_bytes) do
      Storage::Entry.create!(
        account_id: account.id,
        board_id: id,
        delta: 500,
        operation: "attach"
      )
      super()
    end
    # Should abort and return false without creating reconcile entry
    assert_no_difference "Storage::Entry.where(operation: 'reconcile').count" do
      result = board.reconcile_storage
      assert_equal false, result
    end
  end
  test "reconcile_storage returns true on success" do
    board = @account.boards.create!(name: "Test Board", creator: users(:david))
    result = board.reconcile_storage
    assert_equal true, result
  end
  # ensure_storage_total race safety
  test "ensure_storage_total handles concurrent creation" do
    @account.storage_total&.destroy
    threads = 3.times.map do
      Thread.new do
        ActiveRecord::Base.connection_pool.with_connection do
          @account.bytes_used_exact
        end
      end
    end
    threads.each(&:join)
    assert_equal 1, Storage::Total.where(owner: @account).count
  end
  # per-attachment reconcile
  test "reconcile counts each attachment separately" do
    board = @account.boards.create!(name: "Test", creator: users(:david))
    # Create 3 distinct blobs (one per card) - no reuse
    file = file_fixture("moon.jpg")
    expected_bytes = file.size
    3.times do |i|
      blob = ActiveStorage::Blob.create_and_upload! \
        io: file.open,
        filename: "image_#{i}.jpg",
        content_type: "image/jpeg"
      embed = ActionText::Attachment.from_attachable(blob).to_html
      board.cards.create!(title: "Card #{i}", description: "<p>#{embed}</p>", creator: users(:david))
    end
    Storage::Entry.where(board: board).delete_all
    board.reconcile_storage
    entry = Storage::Entry.find_by(board: board, operation: "reconcile")
    # 3 attachments x file_size bytes
    assert_equal expected_bytes * 3, entry.delta
  end
end

================
File: test/models/storage/tracked_test.rb
================
require "test_helper"
class Storage::TrackedTest < ActiveSupport::TestCase
  setup do
    Current.session = sessions(:david)
    @account = accounts("37s")
    @board1 = boards(:writebook)
    @board2 = boards(:private)
    @card = cards(:logo)
  end
  test "storage_bytes returns 0 when no attachments" do
    assert_equal 0, @card.storage_bytes
  end
  test "storage_bytes sums all attachment blob sizes" do
    @card.image.attach io: StringIO.new("x" * 1024), filename: "test.png", content_type: "image/png"
    assert_equal 1024, @card.storage_bytes
  end
  test "storage_bytes includes rich text embeds" do
    blob = ActiveStorage::Blob.create_and_upload! \
      io: file_fixture("moon.jpg").open,
      filename: "embed.jpg",
      content_type: "image/jpeg"
    embed_html = ActionText::Attachment.from_attachable(blob).to_html
    @card.update!(description: "<p>Content with #{embed_html}</p>")
    assert_equal blob.byte_size, @card.storage_bytes
  end
  test "storage_bytes sums direct attachments and rich text embeds" do
    @card.image.attach io: StringIO.new("x" * 1024), filename: "test.png", content_type: "image/png"
    blob = ActiveStorage::Blob.create_and_upload! \
      io: file_fixture("moon.jpg").open,
      filename: "embed.jpg",
      content_type: "image/jpeg"
    embed_html = ActionText::Attachment.from_attachable(blob).to_html
    @card.update!(description: "<p>Content with #{embed_html}</p>")
    assert_equal 1024 + blob.byte_size, @card.storage_bytes
  end
  test "board transfer creates transfer_out entry for old board" do
    @card.image.attach io: StringIO.new("x" * 2048), filename: "test.png", content_type: "image/png"
    old_board_id = @card.board_id
    assert_difference "Storage::Entry.count", +2 do
      @card.update!(board: @board2)
    end
    transfer_out = Storage::Entry.find_by(board_id: old_board_id, operation: "transfer_out")
    assert_not_nil transfer_out
    assert_equal -2048, transfer_out.delta
    assert_equal @account.id, transfer_out.account_id
    assert_equal @card.class.name, transfer_out.recordable_type
    assert_equal @card.id, transfer_out.recordable_id
  end
  test "board transfer creates transfer_in entry for new board" do
    @card.image.attach io: StringIO.new("x" * 2048), filename: "test.png", content_type: "image/png"
    @card.update!(board: @board2)
    transfer_in = Storage::Entry.find_by(board_id: @board2.id, operation: "transfer_in")
    assert_not_nil transfer_in
    assert_equal 2048, transfer_in.delta
    assert_equal @account.id, transfer_in.account_id
  end
  test "board transfer does not create entries when no attachments" do
    # Ensure card has no attachments
    @card.image.purge if @card.image.attached?
    # Count only transfer entries
    initial_count = Storage::Entry.where(operation: [ "transfer_out", "transfer_in" ]).count
    @card.update!(board: @board2)
    final_count = Storage::Entry.where(operation: [ "transfer_out", "transfer_in" ]).count
    assert_equal initial_count, final_count
  end
  test "board transfer moves card description embeds" do
    blob = ActiveStorage::Blob.create_and_upload! \
      io: file_fixture("moon.jpg").open,
      filename: "card_embed.jpg",
      content_type: "image/jpeg"
    embed_html = ActionText::Attachment.from_attachable(blob).to_html
    @card.update!(description: "<p>Desc with image #{embed_html}</p>")
    old_board_id = @card.board_id
    assert_difference -> { Storage::Entry.where(operation: "transfer_out", recordable: @card).count }, +1 do
      assert_difference -> { Storage::Entry.where(operation: "transfer_in", recordable: @card).count }, +1 do
        @card.update!(board: @board2)
      end
    end
    transfer_out = Storage::Entry.where(operation: "transfer_out", recordable: @card).last
    transfer_in = Storage::Entry.where(operation: "transfer_in", recordable: @card).last
    assert_equal(-blob.byte_size, transfer_out.delta)
    assert_equal old_board_id, transfer_out.board_id
    assert_equal blob.byte_size, transfer_in.delta
    assert_equal @board2.id, transfer_in.board_id
  end
  test "board transfer moves comment embeds" do
    blob = ActiveStorage::Blob.create_and_upload! \
      io: file_fixture("moon.jpg").open,
      filename: "comment_embed.jpg",
      content_type: "image/jpeg"
    embed_html = ActionText::Attachment.from_attachable(blob).to_html
    comment = @card.comments.create!(body: "<p>Comment with image #{embed_html}</p>")
    old_board_id = @card.board_id
    assert_difference -> { Storage::Entry.where(operation: "transfer_out", recordable: comment).count }, +1 do
      assert_difference -> { Storage::Entry.where(operation: "transfer_in", recordable: comment).count }, +1 do
        @card.update!(board: @board2)
      end
    end
    transfer_out = Storage::Entry.where(operation: "transfer_out", recordable: comment).last
    transfer_in = Storage::Entry.where(operation: "transfer_in", recordable: comment).last
    assert_equal(-blob.byte_size, transfer_out.delta)
    assert_equal old_board_id, transfer_out.board_id
    assert_equal blob.byte_size, transfer_in.delta
    assert_equal @board2.id, transfer_in.board_id
  end
  test "board transfer moves card image and description embed together" do
    @card.image.attach io: StringIO.new("x" * 1024), filename: "test.png", content_type: "image/png"
    blob = ActiveStorage::Blob.create_and_upload! \
      io: file_fixture("moon.jpg").open,
      filename: "card_embed.jpg",
      content_type: "image/jpeg"
    embed_html = ActionText::Attachment.from_attachable(blob).to_html
    @card.update!(description: "<p>Desc with #{embed_html}</p>")
    old_board_id = @card.board_id
    expected_bytes = 1024 + blob.byte_size
    # One transfer_out and one transfer_in for the card (combined bytes)
    assert_difference -> { Storage::Entry.where(operation: "transfer_out", recordable: @card).count }, +1 do
      assert_difference -> { Storage::Entry.where(operation: "transfer_in", recordable: @card).count }, +1 do
        @card.update!(board: @board2)
      end
    end
    transfer_out = Storage::Entry.where(operation: "transfer_out", recordable: @card).last
    transfer_in = Storage::Entry.where(operation: "transfer_in", recordable: @card).last
    assert_equal(-expected_bytes, transfer_out.delta)
    assert_equal expected_bytes, transfer_in.delta
  end
  test "board transfer moves multiple comments with embeds" do
    blob1 = ActiveStorage::Blob.create_and_upload! \
      io: file_fixture("moon.jpg").open,
      filename: "embed1.jpg",
      content_type: "image/jpeg"
    blob2 = ActiveStorage::Blob.create_and_upload! \
      io: file_fixture("moon.jpg").open,
      filename: "embed2.jpg",
      content_type: "image/jpeg"
    comment1 = @card.comments.create!(body: "<p>#{ActionText::Attachment.from_attachable(blob1).to_html}</p>")
    comment2 = @card.comments.create!(body: "<p>#{ActionText::Attachment.from_attachable(blob2).to_html}</p>")
    old_board_id = @card.board_id
    # Should create transfer entries for both comments
    assert_difference -> { Storage::Entry.where(operation: "transfer_out").count }, +2 do
      assert_difference -> { Storage::Entry.where(operation: "transfer_in").count }, +2 do
        @card.update!(board: @board2)
      end
    end
    # Verify each comment's transfer
    assert_equal(-blob1.byte_size, Storage::Entry.find_by(operation: "transfer_out", recordable: comment1).delta)
    assert_equal blob1.byte_size, Storage::Entry.find_by(operation: "transfer_in", recordable: comment1).delta
    assert_equal(-blob2.byte_size, Storage::Entry.find_by(operation: "transfer_out", recordable: comment2).delta)
    assert_equal blob2.byte_size, Storage::Entry.find_by(operation: "transfer_in", recordable: comment2).delta
  end
  test "board transfer net effect on account is zero" do
    @card.image.attach io: StringIO.new("x" * 1024), filename: "test.png", content_type: "image/png"
    # Materialize account storage before transfer
    @account.materialize_storage
    initial_account_bytes = @account.bytes_used
    @card.update!(board: @board2)
    # Materialize again
    @account.materialize_storage
    # Account total should be unchanged (transfer_out + transfer_in = 0 for account)
    assert_equal initial_account_bytes, @account.bytes_used
  end
  test "board transfer correctly moves storage between boards" do
    @card.image.attach io: StringIO.new("x" * 1024), filename: "test.png", content_type: "image/png"
    # Materialize both boards
    @board1.materialize_storage
    @board2.materialize_storage
    board1_initial = @board1.bytes_used
    board2_initial = @board2.bytes_used
    # Small delay to ensure UUIDv7 timestamp advances for transfer entries
    travel 1.second
    @card.update!(board: @board2)
    # Materialize again
    @board1.materialize_storage
    @board2.materialize_storage
    # Board1 loses 1024, Board2 gains 1024
    assert_equal board1_initial - 1024, @board1.bytes_used
    assert_equal board2_initial + 1024, @board2.bytes_used
  end
  test "non-board updates do not trigger transfer tracking" do
    @card.image.attach io: StringIO.new("x" * 1024), filename: "test.png", content_type: "image/png"
    initial_count = Storage::Entry.where(operation: [ "transfer_out", "transfer_in" ]).count
    @card.update!(title: "New Title")
    final_count = Storage::Entry.where(operation: [ "transfer_out", "transfer_in" ]).count
    assert_equal initial_count, final_count
  end
  test "attachments_for_storage returns all direct attachments" do
    @card.image.attach io: StringIO.new("x" * 1024), filename: "test.png", content_type: "image/png"
    attachments = @card.send(:attachments_for_storage)
    assert_equal 1, attachments.count
    assert_equal @card.image.blob.byte_size, attachments.first.blob.byte_size
  end
  test "attachments_for_storage includes rich text embeds" do
    blob = ActiveStorage::Blob.create_and_upload! \
      io: file_fixture("moon.jpg").open,
      filename: "embed.jpg",
      content_type: "image/jpeg"
    embed_html = ActionText::Attachment.from_attachable(blob).to_html
    @card.update!(description: "<p>Content with #{embed_html}</p>")
    attachments = @card.send(:attachments_for_storage)
    assert_equal 1, attachments.count
    assert_equal blob.byte_size, attachments.first.blob.byte_size
  end
  test "attachments_for_storage includes both direct and rich text attachments" do
    @card.image.attach io: StringIO.new("x" * 1024), filename: "test.png", content_type: "image/png"
    blob = ActiveStorage::Blob.create_and_upload! \
      io: file_fixture("moon.jpg").open,
      filename: "embed.jpg",
      content_type: "image/jpeg"
    embed_html = ActionText::Attachment.from_attachable(blob).to_html
    @card.update!(description: "<p>Content with #{embed_html}</p>")
    attachments = @card.send(:attachments_for_storage)
    assert_equal 2, attachments.count
    assert_equal 1024 + blob.byte_size, attachments.sum { |a| a.blob.byte_size }
  end
end

================
File: test/models/user/accessor_test.rb
================
require "test_helper"
class User::AccessorTest < ActiveSupport::TestCase
  test "new users get added to all_access boards on creation" do
    user = User.create!(account: accounts("37s"), name: "Jorge")
    assert_includes user.boards, boards(:writebook)
    assert_equal user.account.boards.all_access.count, user.boards.count
  end
  test "system user does not get added to boards on creation" do
    system_user = User.create!(account: accounts("37s"), role: "system", name: "Test System User")
    assert_empty system_user.boards
  end
  test "creating a new card draft sets current timestamps" do
    user = users(:david)
    board = boards(:writebook)
    freeze_time do
      card = user.draft_new_card_in(board)
      assert card.persisted?
      assert card.drafted?
      assert_equal user, card.creator
      assert_equal board, card.board
      assert_equal Time.current, card.created_at
      assert_equal Time.current, card.updated_at
      assert_equal Time.current, card.last_active_at
    end
  end
  test "reusing an existing card draft refreshes timestamps" do
    existing_draft = cards(:unfinished_thoughts)
    user = existing_draft.creator
    board = existing_draft.board
    freeze_time do
      card = user.draft_new_card_in(board)
      assert_equal existing_draft, card
      assert_equal Time.current, card.created_at
      assert_equal Time.current, card.updated_at
      assert_equal Time.current, card.last_active_at
    end
  end
end

================
File: test/models/user/avatar_test.rb
================
require "test_helper"
class User::AvatarTest < ActiveSupport::TestCase
  test "avatar_thumbnail returns variant for variable images" do
    users(:david).avatar.attach(io: File.open(file_fixture("moon.jpg")), filename: "moon.jpg", content_type: "image/jpeg")
    assert users(:david).avatar.variable?
    assert_equal users(:david).avatar.variant(:thumb).blob, users(:david).avatar_thumbnail.blob
  end
  test "avatar_thumbnail returns original blob for non-variable images" do
    users(:david).avatar.attach(io: File.open(file_fixture("avatar.svg")), filename: "avatar.svg", content_type: "image/svg+xml")
    assert_not users(:david).avatar.variable?
    assert_equal users(:david).avatar.blob, users(:david).avatar_thumbnail.blob
  end
  test "allows valid image content types" do
    users(:david).avatar.attach(io: File.open(file_fixture("moon.jpg")), filename: "test.jpg", content_type: "image/jpeg")
    assert users(:david).valid?
  end
  test "rejects SVG uploads" do
    users(:david).avatar.attach(io: File.open(file_fixture("avatar.svg")), filename: "avatar.svg")
    assert_not users(:david).valid?
    assert_includes users(:david).errors[:avatar], "must be a JPEG, PNG, GIF, or WebP image"
  end
  test "thumb variant is processed immediately on attachment" do
    users(:david).avatar.attach(io: File.open(file_fixture("avatar.png")), filename: "avatar.png", content_type: "image/png")
    assert users(:david).avatar.variant(:thumb).processed?
  end
  test "rejects images that are too wide" do
    users(:david).avatar.attach(io: File.open(file_fixture("avatar.png")), filename: "avatar.png", content_type: "image/png")
    users(:david).avatar.blob.update!(metadata: { analyzed: true, width: 5000, height: 100 })
    assert_not users(:david).valid?
    assert_includes users(:david).errors[:avatar], "width must be less than #{User::Avatar::MAX_AVATAR_DIMENSIONS[:width]}px"
  end
  test "rejects images that are too tall" do
    users(:david).avatar.attach(io: File.open(file_fixture("avatar.png")), filename: "avatar.png", content_type: "image/png")
    users(:david).avatar.blob.update!(metadata: { analyzed: true, width: 100, height: 5000 })
    assert_not users(:david).valid?
    assert_includes users(:david).errors[:avatar], "height must be less than #{User::Avatar::MAX_AVATAR_DIMENSIONS[:height]}px"
  end
  test "accepts images within dimension limits" do
    users(:david).avatar.attach(io: File.open(file_fixture("avatar.png")), filename: "avatar.png", content_type: "image/png")
    users(:david).avatar.blob.update!(metadata: { analyzed: true, width: 4096, height: 4096 })
    assert users(:david).valid?
  end
end

================
File: test/models/user/configurable_test.rb
================
require "test_helper"
class User::ConfigurableTest < ActiveSupport::TestCase
  test "should create settings for new users" do
    user = User.create! account: accounts("37s"), name: "Some new user"
    assert user.settings.present?
  end
end

================
File: test/models/user/data_export_test.rb
================
require "test_helper"
class User::DataExportTest < ActiveSupport::TestCase
  test "build generates zip with card JSON files" do
    export = User::DataExport.create!(account: Current.account, user: users(:david))
    export.build
    assert export.completed?
    assert export.file.attached?
    assert_equal "application/zip", export.file.content_type
  end
  test "build sets status to processing then completed" do
    export = User::DataExport.create!(account: Current.account, user: users(:david))
    export.build
    assert export.completed?
    assert_not_nil export.completed_at
  end
  test "build sends email when completed" do
    export = User::DataExport.create!(account: Current.account, user: users(:david))
    assert_enqueued_jobs 1, only: ActionMailer::MailDeliveryJob do
      export.build
    end
  end
  test "build includes only accessible cards for user" do
    user = users(:david)
    export = User::DataExport.create!(account: Current.account, user: user)
    export.build
    assert export.completed?
    assert export.file.attached?
    Tempfile.create([ "test", ".zip" ]) do |temp|
      temp.binmode
      export.file.download { |chunk| temp.write(chunk) }
      temp.rewind
      reader = ZipKit::FileReader.read_zip_structure(io: temp)
      json_files = reader.select { |e| e.filename.end_with?(".json") }
      assert json_files.any?, "Zip should contain at least one JSON file"
      extractor = json_files.first.extractor_from(temp)
      json_content = JSON.parse(extractor.extract)
      assert json_content.key?("number")
      assert json_content.key?("title")
      assert json_content.key?("board")
      assert json_content.key?("creator")
      assert json_content["creator"].key?("id")
      assert json_content["creator"].key?("name")
      assert json_content["creator"].key?("email")
      assert json_content.key?("description")
      assert json_content.key?("comments")
    end
  end
  test "build_later enqueues DataExportJob" do
    export = User::DataExport.create!(account: Current.account, user: users(:david))
    assert_enqueued_with(job: DataExportJob, args: [ export ]) do
      export.build_later
    end
  end
end

================
File: test/models/user/email_address_changeable_test.rb
================
require "test_helper"
class User::EmailAddressChangeableTest < ActiveSupport::TestCase
  include ActionMailer::TestHelper
  setup do
    @identity = identities(:kevin)
    @user = @identity.users.find_by!(account: accounts("37s"))
    @new_email = "newart@example.com"
    @old_email = @identity.email_address
  end
  test "send_email_address_change_confirmation" do
    assert_emails 1 do
      @user.send_email_address_change_confirmation(@new_email)
    end
  end
  test "change_email_address" do
    old_identity = @identity
    new_identity = identities(:mike)
    assert_difference -> { Identity.count }, +1 do
      @user.change_email_address(@new_email)
    end
    assert_equal @new_email, @user.reload.identity.email_address
    assert_not old_identity.reload.users.exists?(id: @user.id)
    assert_equal @new_email, @user.reload.identity.email_address
    assert_no_difference -> { Identity.count } do
      @user.change_email_address(new_identity.email_address)
    end
    assert_equal new_identity.email_address, @user.reload.identity.email_address
  end
  test "change_email_address_using_token" do
    token = @user.send(:generate_email_address_change_token, to: @new_email)
    @user.change_email_address_using_token(token)
    assert_equal @new_email, @user.reload.identity.email_address
  end
  test "change_email_address_using_token with invalid token" do
    assert_not @user.change_email_address_using_token("invalid_token")
    assert_equal @old_email, @user.reload.identity.email_address
    token = @user.send(:generate_email_address_change_token, to: @new_email)
    old_email = "#{SecureRandom.hex(16)}@example.com"
    @identity.update!(email_address: old_email)
    @user.reload
    assert_not @user.change_email_address_using_token(token)
    assert_equal old_email, @user.reload.identity.email_address
  end
end

================
File: test/models/user/mentionable_test.rb
================
require "test_helper"
class User::MentionableTest < ActiveSupport::TestCase
  test "mentionable handles" do
    assert_equal [ "dhh", "david", "davidh" ], User.new(name: "David Heinemeier-Hansson").mentionable_handles
  end
  test "mentioned by" do
    users(:david).mentions.destroy_all
    assert_difference -> { users(:david).mentions.count }, +1 do
      users(:david).mentioned_by users(:jz), at: cards(:logo)
    end
    # No dups
    assert_no_difference -> { users(:david).mentions.count }, +1 do
      users(:david).mentioned_by users(:jz), at: cards(:logo)
    end
  end
end

================
File: test/models/user/named_test.rb
================
require "test_helper"
class User::NamedTest < ActiveSupport::TestCase
  test "initials" do
    assert_initials "M", name: "Michael"
    assert_initials "SD", name: "Salvador Dali"
    assert_initials "LMM", name: "Lin-Manuel Miranda"
    assert_initials "OCD", name: "O'Conor Dez"
    assert_initials "ACG", name: "Anne Christine Garca"
    assert_initials "L", name: "ngela Lpez"
  end
  test "first name" do
    assert_first_name "Michael", "Michael"
    assert_first_name "Salvador", "Salvador Dali"
    assert_first_name "Lin-Manuel", "Lin-Manuel Miranda"
    assert_first_name "Anne", "Anne Christine Garca"
  end
  test "last name" do
    assert_last_name "Dali", "Salvador Dali"
    assert_last_name "Miranda", "Lin_Manuel Miranda"
    assert_last_name "Christine Garca", "Anne Christine Garca"
  end
  private
    def assert_initials(expected, **attributes)
      assert_equal expected, User.new(attributes).initials
    end
    def assert_first_name(expected, name)
      assert_equal expected, User.new(name: name).first_name
    end
    def assert_last_name(expected, name)
      assert_equal expected, User.new(name: name).last_name
    end
end

================
File: test/models/user/notifiable_test.rb
================
require "test_helper"
class User::NotifiableTest < ActiveSupport::TestCase
  setup do
    @user = users(:david)
    @user.settings.bundle_email_every_few_hours!
  end
  test "bundle method creates new bundle for first notification" do
    notification = assert_difference -> { @user.notification_bundles.count }, 1 do
      @user.notifications.create!(source: events(:logo_published), creator: @user)
    end
    bundle = @user.notification_bundles.last
    assert_equal notification.created_at, bundle.starts_at
    assert bundle.pending?
  end
  test "bundle method finds existing bundle within aggregation period" do
    @user.notifications.create!(source: events(:logo_published), creator: @user)
    assert_no_difference -> { @user.notification_bundles.count } do
      @user.notifications.create!(source: events(:logo_published), creator: @user)
    end
  end
end

================
File: test/models/user/role_test.rb
================
require "test_helper"
class User::RoleTest < ActiveSupport::TestCase
  test "can administer others?" do
    assert users(:kevin).can_administer?(users(:jz))
    assert_not users(:kevin).can_administer?(users(:kevin))
    assert_not users(:jz).can_administer?(users(:kevin))
  end
  test "owner can administer admins and members" do
    assert users(:jason).can_administer?(users(:kevin))
    assert users(:jason).can_administer?(users(:david))
    assert users(:jason).can_administer?(users(:jz))
  end
  test "owner cannot administer themselves" do
    assert_not users(:jason).can_administer?(users(:jason))
  end
  test "admin cannot administer the owner" do
    assert_not users(:kevin).can_administer?(users(:jason))
  end
  test "owner is included in active scope" do
    active_users = User.active
    assert_includes active_users, users(:jason)
    assert_includes active_users, users(:kevin)
    assert_includes active_users, users(:david)
    assert_not_includes active_users, users(:system)
  end
  test "owner is also considered an admin" do
    assert users(:jason).owner?
    assert users(:jason).admin?
    assert users(:kevin).admin?
    assert_not users(:kevin).owner?
  end
  test "owner scope returns only active owners" do
    owners = accounts("37s").users.owner
    assert_includes owners, users(:jason)
    assert_not_includes owners, users(:kevin)
    assert_not_includes owners, users(:david)
    users(:jason).update!(active: false)
    assert_not_includes accounts("37s").users.owner, users(:jason)
  end
  test "admin scope returns active owners and admins" do
    admins = accounts("37s").users.admin
    assert_includes admins, users(:jason)
    assert_includes admins, users(:kevin)
    assert_not_includes admins, users(:david)
    users(:kevin).update!(active: false)
    assert_not_includes accounts("37s").users.admin, users(:kevin)
  end
  test "can administer board?" do
    writebook_board = boards(:writebook)
    private_board = boards(:private)
    # Admin can administer any board
    assert users(:kevin).can_administer_board?(writebook_board)
    assert users(:kevin).can_administer_board?(private_board)
    # Creator can administer their own board
    assert users(:david).can_administer_board?(writebook_board)
    # Regular user cannot administer boards they didn't create
    assert_not users(:jz).can_administer_board?(writebook_board)
    assert_not users(:jz).can_administer_board?(private_board)
    # Creator cannot administer other people's boards
    assert_not users(:david).can_administer_board?(private_board)
  end
  test "can administer card?" do
    logo_card = cards(:logo)
    text_card = cards(:text)
    # Admin can administer any card
    assert users(:kevin).can_administer_card?(logo_card)
    assert users(:kevin).can_administer_card?(text_card)
    # Creator can administer their own card
    assert users(:david).can_administer_card?(logo_card)
    # Regular user cannot administer cards they didn't create
    assert_not users(:jz).can_administer_card?(logo_card)
    assert_not users(:jz).can_administer_card?(text_card)
    # Creator cannot administer other people's cards
    assert_not users(:david).can_administer_card?(text_card)
  end
end

================
File: test/models/user/searcher_test.rb
================
require "test_helper"
class User::SearcherTest < ActiveSupport::TestCase
  setup do
    @user = users(:kevin)
  end
  test "remember the last search" do
    assert_difference -> { @user.search_queries.count }, +1 do
      @user.remember_search("broken")
    end
    assert_equal "broken", @user.search_queries.last.terms
  end
  test "don't duplicate repeated searches but touch the existing match" do
    search_result = @user.remember_search("broken")
    original_updated_at = search_result.updated_at
    travel_to 1.day.from_now
    assert_no_difference -> { @user.search_queries.count }, +1 do
      @user.remember_search("broken")
    end
    assert search_result.reload.updated_at > original_updated_at
  end
end

================
File: test/models/user/settings_test.rb
================
require "test_helper"
class User::SettingsTest < ActiveSupport::TestCase
  setup do
    @user = users(:david)
    @settings = @user.settings
  end
  test "changing the bundle email frequency to never will cancel pending bundles" do
    @settings.update!(bundle_email_frequency: :every_few_hours)
    bundle = @user.notification_bundles.create!
    @settings.update!(bundle_email_frequency: :never)
    assert_nil Notification::Bundle.find_by(id: bundle.id)
  end
  test "changing the bundle email frequency will deliver pending bundles" do
    bundle = @user.notification_bundles.create!
    assert bundle.pending?
    freeze_time Time.current do
      perform_enqueued_jobs only: Notification::Bundle::DeliverJob do
        @settings.update!(bundle_email_frequency: :daily)
      end
      assert bundle.reload.delivered?
      assert_equal Time.current, bundle.ends_at
    end
  end
  test "changing other settings will not affect pending bundles" do
    bundle = @user.notification_bundles.create!
    perform_enqueued_jobs only: Notification::Bundle::DeliverJob do
      @settings.update!(updated_at: 1.hour.from_now)
    end
    assert bundle.reload.pending?
  end
  test "bundling_emails?" do
    @settings.update!(bundle_email_frequency: :never)
    assert_not @user.settings.bundling_emails?
    @settings.update!(bundle_email_frequency: :every_few_hours)
    assert @user.settings.bundling_emails?
    @user.update!(role: :system)
    assert_not @user.settings.bundling_emails?, "System users should not receive bundled emails"
    @user.update!(role: :member, active: false)
    assert_not @user.settings.bundling_emails?, "Inactive users should not receive bundled emails"
    @user.update!(active: true)
    @user.update_column(:verified_at, nil)
    assert_not @user.settings.bundling_emails?, "Unverified users should not receive bundled emails"
  end
end

================
File: test/models/webhook/delinquency_tracker_test.rb
================
require "test_helper"
class Webhook::DelinquencyTrackerTest < ActiveSupport::TestCase
  test "record_delivery_of" do
    tracker = webhook_delinquency_trackers(:active_webhook_tracker)
    webhook = tracker.webhook
    successful_delivery = webhook_deliveries(:successfully_completed)
    failed_delivery = webhook_deliveries(:errored)
    tracker.update!(consecutive_failures_count: 5)
    tracker.record_delivery_of(successful_delivery)
    tracker.reload
    assert_equal 0, tracker.consecutive_failures_count
    assert_nil tracker.first_failure_at
    assert_difference -> { tracker.reload.consecutive_failures_count }, +1 do
      tracker.record_delivery_of(failed_delivery)
    end
    tracker.reload
    assert_not_nil tracker.first_failure_at
    assert_difference -> { tracker.reload.consecutive_failures_count }, +1 do
      assert_no_difference -> { tracker.reload.first_failure_at } do
        tracker.record_delivery_of(failed_delivery)
      end
    end
    travel_to 2.hours.from_now do
      tracker.update!(consecutive_failures_count: 9)
      webhook.activate
      assert_changes -> { webhook.reload.active? }, from: true, to: false do
        tracker.record_delivery_of(failed_delivery)
      end
    end
  end
end

================
File: test/models/webhook/triggerable_test.rb
================
require "test_helper"
class Webhook::TriggerableTest < ActiveSupport::TestCase
  setup do
    @account = accounts(:"37s")
    @board = boards(:writebook)
    @card = @board.cards.first
    @webhook = @board.webhooks.create!(
      name: "Test Webhook",
      url: "https://example.com/webhook",
      subscribed_actions: [ "card_published" ]
    )
    # Create a test event
    @event = @board.events.create!(
      creator: users(:david),
      eventable: @card,
      action: "card_published"
    )
    @user = users(:david)
  end
  test "trigger creates delivery for active accounts" do
    assert_difference -> { Webhook::Delivery.count }, 1 do
      @webhook.trigger(@event)
    end
    delivery = Webhook::Delivery.last
    assert_equal @event, delivery.event
    assert_equal @webhook, delivery.webhook
  end
  test "trigger skips cancelled accounts" do
    @account.cancel(initiated_by: @user)
    assert_no_difference -> { Webhook::Delivery.count } do
      @webhook.trigger(@event)
    end
  end
  test "triggered_by scope finds webhooks for event" do
    other_webhook = @board.webhooks.create!(
      name: "Other Webhook",
      url: "https://example.com/other",
      subscribed_actions: [ "card_closed" ]
    )
    matching_webhooks = Webhook.triggered_by(@event)
    assert_includes matching_webhooks, @webhook
    assert_not_includes matching_webhooks, other_webhook
  end
  test "active scope only returns active webhooks" do
    @webhook.update!(active: false)
    assert_not_includes Webhook.active, @webhook
  end
end

================
File: test/models/access_test.rb
================
require "test_helper"
class AccessTest < ActiveSupport::TestCase
  test "acesssed" do
    freeze_time
    assert_changes -> { accesses(:writebook_kevin).reload.accessed_at }, from: nil, to: Time.current do
      accesses(:writebook_kevin).accessed
    end
    travel 2.minutes
    assert_no_changes -> { accesses(:writebook_kevin).reload.accessed_at } do
      accesses(:writebook_kevin).accessed
    end
  end
  test "event notifications are destroyed when access is lost" do
    kevin = users(:kevin)
    board = boards(:writebook)
    # make sure we have test coverage for both cards and comments
    assert kevin.notifications.map(&:source).map(&:eventable_type).uniq.sort == [ "Card", "Comment" ]
    notifications_to_be_destroyed = kevin.notifications.select do |notification|
      notification.card&.board == board
    end
    assert notifications_to_be_destroyed.any?
    kevin_access = accesses(:writebook_kevin)
    perform_enqueued_jobs only: Board::CleanInaccessibleDataJob do
      kevin_access.destroy
    end
    remaining_notifications = kevin.notifications.reload.select do |notification|
      notification.card&.board == board
    end
    assert_empty remaining_notifications
  end
  test "mentions are destroyed when access is lost" do
    david = users(:david)
    board = boards(:writebook)
    # make sure we have test coverage for both cards and comments
    assert david.mentions.map(&:source_type).uniq.sort == [ "Card", "Comment" ]
    mentions_to_be_destroyed = david.mentions.select do |mention|
      mention.card&.board == board
    end
    assert mentions_to_be_destroyed.any?
    david_access = accesses(:writebook_david)
    perform_enqueued_jobs only: Board::CleanInaccessibleDataJob do
      david_access.destroy
    end
    remaining_mentions = david.mentions.reload.select do |mention|
      mention.card&.board == board
    end
    assert_empty remaining_mentions
  end
  test "watches are destroyed when access is lost" do
    kevin = users(:kevin)
    board = boards(:writebook)
    card = cards(:logo) # Kevin watches this card
    assert card.watched_by?(kevin)
    kevin_access = accesses(:writebook_kevin)
    perform_enqueued_jobs only: Board::CleanInaccessibleDataJob do
      kevin_access.destroy
    end
    assert_not card.watched_by?(kevin)
  end
  test "pins are destroyed when access is lost" do
    kevin = users(:kevin)
    board = boards(:writebook)
    card = cards(:logo) # Kevin has pinned this card
    other_board = boards(:miltons_wish_list)
    other_card = cards(:radio)
    other_board.accesses.grant_to(kevin)
    other_card.pin_by(kevin)
    assert card.pinned_by?(kevin)
    assert other_card.pinned_by?(kevin)
    kevin_access = accesses(:writebook_kevin)
    perform_enqueued_jobs only: Board::CleanInaccessibleDataJob do
      kevin_access.destroy
    end
    assert_not card.pinned_by?(kevin)
    assert other_card.pinned_by?(kevin), "Pin on other board should not be destroyed"
  end
end

================
File: test/models/account_test.rb
================
require "test_helper"
class AccountTest < ActiveSupport::TestCase
  test "create" do
    assert_difference "Account::JoinCode.count", +1 do
      Account.create!(name: "ACME corp")
    end
  end
  test "slug" do
    account = accounts("37s")
    assert_equal "/#{account.external_account_id}", account.slug
  end
  test ".create_with_owner creates a new local account" do
    Current.without_account do
      identity = identities(:david)
      account = nil
      assert_changes -> { Account.count }, +1 do
        assert_changes -> { User.count }, +2 do
          account = Account.create_with_owner(
            account: {
              external_account_id: ActiveRecord::FixtureSet.identify("account-create-with-owner-test"),
              name: "Account Create With Owner"
            },
            owner: {
              name: "David",
              identity: identity
            }
          )
        end
      end
      assert_not_nil account
      assert account.persisted?
      assert_equal ActiveRecord::FixtureSet.identify("account-create-with-owner-test"), account.external_account_id
      assert_equal "Account Create With Owner", account.name
      owner = account.users.find_by(role: "owner")
      assert_equal "David", owner.name
      assert_equal "david@37signals.com", owner.identity.email_address
      assert_equal "owner", owner.role
      assert owner.admin?, "owner should also be considered an admin"
      assert_predicate account.system_user, :present?
      assert owner.verified?, "owner should be verified on account creation"
    end
  end
  test "#system_user returns the system user of the account" do
    system_user = User.find_by!(account: accounts("37s"), role: :system)
    assert_equal system_user, accounts("37s").system_user
  end
  test "#system_user raises if there is no system user" do
    account = Account.create!(name: "No System User Account")
    assert_raises ActiveRecord::RecordNotFound do
      account.system_user
    end
  end
  test "external_account_id auto-increments on creation" do
    account1 = Account.create!(name: "First Account")
    account2 = Account.create!(name: "Second Account")
    assert_not_nil account1.external_account_id
    assert_not_nil account2.external_account_id
    assert_equal account1.external_account_id + 1, account2.external_account_id
  end
  test "external_account_id can be overridden" do
    custom_id = 999999
    sequence_value_before = Account::ExternalIdSequence.first_or_create!(value: 0).value
    account = Account.create!(name: "Custom ID Account", external_account_id: custom_id)
    assert_equal custom_id, account.external_account_id
    assert_equal sequence_value_before, Account::ExternalIdSequence.value
  end
end

================
File: test/models/assignment_test.rb
================
require "test_helper"
class AssignmentTest < ActiveSupport::TestCase
  test "create" do
    card = cards(:text)
    assignment = card.assignments.create!(assignee: users(:david), assigner: users(:jason))
    assert_equal users(:david), assignment.assignee
    assert_equal users(:jason), assignment.assigner
    assert_equal card, assignment.card
  end
  test "create cannot exceed assignee limit" do
    card = cards(:logo)
    board = card.board
    account = card.account
    card.assignments.delete_all
    Assignment::LIMIT.times do |i|
      identity = Identity.create!(email_address: "limit_test_#{i}@example.com")
      user = account.users.create!(identity: identity, name: "Limit Test User #{i}", role: :member)
      user.accesses.find_or_create_by!(board: board)
      card.assignments.create!(assignee: user, assigner: users(:david))
    end
    assert_equal Assignment::LIMIT, card.assignments.count
    identity = Identity.create!(email_address: "over_limit@example.com")
    extra_user = account.users.create!(identity: identity, name: "Over Limit User", role: :member)
    extra_user.accesses.find_or_create_by!(board: board)
    assignment = card.assignments.build(assignee: extra_user, assigner: users(:david))
    assert_not assignment.valid?
    assert_includes assignment.errors[:base], "Card already has the maximum of #{Assignment::LIMIT} assignees"
  end
end

================
File: test/models/card_test.rb
================
require "test_helper"
class CardTest < ActiveSupport::TestCase
  setup do
    Current.session = sessions(:david)
  end
  test "create assigns a number to the card" do
    user = users(:david)
    board = boards(:writebook)
    account = board.account
    card = nil
    assert_difference -> { account.reload.cards_count }, +1 do
      card = Card.create!(title: "Test", board: board, creator: user)
    end
    assert_equal account.reload.cards_count, card.number
  end
  test "assignment states" do
    assert cards(:logo).assigned_to?(users(:kevin))
    assert_not cards(:logo).assigned_to?(users(:david))
  end
  test "assignment toggling" do
    assert cards(:logo).assigned_to?(users(:kevin))
    assert_difference({ -> { cards(:logo).assignees.count } => -1, -> { Event.count } => +1 }) do
      cards(:logo).toggle_assignment users(:kevin)
    end
    assert_not cards(:logo).reload.assigned_to?(users(:kevin))
    unassign_event = Event.last
    assert_equal "card_unassigned", unassign_event.action
    assert_equal [ users(:kevin) ], unassign_event.assignees
    assert_difference %w[ cards(:logo).assignees.count Event.count ], +1 do
      cards(:logo).toggle_assignment users(:kevin)
    end
    assert cards(:logo).assigned_to?(users(:kevin))
    assign_event = Event.last
    assert_equal "card_assigned", assign_event.action
    assert_equal [ users(:kevin) ], assign_event.assignees
  end
  test "tagged states" do
    assert cards(:logo).tagged_with?(tags(:web))
    assert_not cards(:logo).tagged_with?(tags(:mobile))
  end
  test "tag toggling" do
    assert cards(:logo).tagged_with?(tags(:web))
    assert_difference "cards(:logo).taggings.count", -1 do
      cards(:logo).toggle_tag_with tags(:web).title
    end
    assert_not cards(:logo).tagged_with?(tags(:web))
    assert_difference "cards(:logo).taggings.count", +1 do
      cards(:logo).toggle_tag_with tags(:web).title
    end
    assert cards(:logo).tagged_with?(tags(:web))
    assert_difference %w[ cards(:logo).taggings.count Tag.count ], +1 do
      cards(:logo).toggle_tag_with "prioritized"
    end
    assert_equal "prioritized", cards(:logo).taggings.last.tag.title
  end
  test "closed" do
    assert_equal [ cards(:shipping) ], Card.closed
  end
  test "open" do
    assert_equal cards(:logo, :layout, :text, :buy_domain).to_set, accounts("37s").cards.open.to_set
    assert_equal cards(:radio, :paycheck, :unfinished_thoughts).to_set, accounts("initech").cards.open.to_set
  end
  test "card_unassigned" do
    assert_equal cards(:shipping, :text, :buy_domain).to_set, accounts("37s").cards.unassigned.to_set
  end
  test "assigned to" do
    assert_equal cards(:logo, :layout).to_set, Card.assigned_to(users(:jz)).to_set
  end
  test "assigned by" do
    assert_equal cards(:layout, :logo).to_set, Card.assigned_by(users(:david)).to_set
  end
  test "in board" do
    new_board = Board.create! name: "New Board", creator: users(:david)
    assert_equal cards(:logo, :shipping, :layout, :text, :buy_domain).to_set, Card.where(board: boards(:writebook)).to_set
    assert_empty Card.where(board: new_board)
  end
  test "tagged with" do
    assert_equal cards(:layout, :text), Card.tagged_with(tags(:mobile))
  end
  test "for published cards, it should set the default title 'Untitiled' when not provided" do
    card = boards(:writebook).cards.create!
    assert_nil card.title
    card.publish
    assert_equal "Untitled", card.reload.title
  end
  test "send back to triage when moved to a new board" do
    cards(:logo).update! column: columns(:writebook_in_progress)
    assert_changes -> { cards(:logo).reload.triaged? }, from: true, to: false do
      cards(:logo).update! board: boards(:private)
    end
  end
  test "grants access to assignees when moved to a new board" do
    card = cards(:logo)
    assignee = users(:david)
    card.toggle_assignment(assignee)
    board = boards(:private)
    assert_not_includes board.users, assignee
    card.update!(board: board)
    assert_includes board.users.reload, assignee
  end
  test "move cards to a different board" do
    card = cards(:logo)
    old_board = boards(:writebook)
    new_board = boards(:private)
    assert_equal old_board, card.board
    assert card.events.where(board: old_board).exists?
    card.move_to(new_board)
    assert_equal new_board, card.reload.board
    events_in_old_board = card.events.where(board: old_board)
    events_in_new_board = card.events.where(board: new_board)
    assert_empty events_in_old_board
    assert events_in_new_board.exists?
    board_changed_event = events_in_new_board.find { |event| event.action == "card_board_changed" }
    assert board_changed_event
  end
  test "a card is filled if it has either the title or the description set" do
    assert Card.new(title: "Some title").filled?
    assert Card.new(description: "Some description").filled?
    assert_not Card.new.filled?
  end
  test "pins are deleted when card moves to a board user cannot access" do
    card = cards(:logo)
    kevin = users(:kevin)
    david = users(:david)
    # David pins the card (Kevin already has it pinned via fixture)
    card.pin_by(david)
    assert card.pinned_by?(kevin)
    assert card.pinned_by?(david)
    # Kevin has access to the private board, David does not
    assert boards(:private).accessible_to?(kevin)
    assert_not boards(:private).accessible_to?(david)
    perform_enqueued_jobs only: Card::CleanInaccessibleDataJob do
      card.move_to(boards(:private))
    end
    assert card.pinned_by?(kevin), "Kevin's pin should remain (has board access)"
    assert_not card.pinned_by?(david), "David's pin should be deleted (no board access)"
  end
  test "watches are deleted when card moves to a board user cannot access" do
    card = cards(:logo)
    kevin = users(:kevin)
    david = users(:david)
    # Both watch the card via fixtures
    assert card.watched_by?(kevin)
    assert card.watched_by?(david)
    # Kevin has access to the private board, David does not
    assert boards(:private).accessible_to?(kevin)
    assert_not boards(:private).accessible_to?(david)
    perform_enqueued_jobs only: Card::CleanInaccessibleDataJob do
      card.move_to(boards(:private))
    end
    assert card.watched_by?(kevin), "Kevin's watch should remain (has board access)"
    assert_not card.watched_by?(david), "David's watch should be deleted (no board access)"
  end
  test "card has reactions association" do
    card = cards(:logo)
    user = users(:david)
    assert_difference "card.reactions.count", +1 do
      card.reactions.create!(content: "", reacter: user)
    end
    reaction = card.reactions.last
    assert_equal "", reaction.content
    assert_equal user, reaction.reacter
    assert_equal card, reaction.reactable
  end
end

================
File: test/models/column_limits_test.rb
================
require "test_helper"
class ColumnLimitsTest < ActiveSupport::TestCase
  # Database errors for exceeding column limits:
  # - MySQL: ActiveRecord::ValueTooLong
  # - SQLite: ActiveRecord::CheckViolation
  COLUMN_LIMIT_ERRORS = [ ActiveRecord::ValueTooLong, ActiveRecord::CheckViolation ]
  test "account name rejects strings over 255 characters" do
    account = Account.new(name: "a" * 256)
    assert_raises(*COLUMN_LIMIT_ERRORS) { account.save! }
  end
  test "account name accepts strings up to 255 characters" do
    account = Account.new(name: "a" * 255)
    assert account.save
  end
  test "account name accepts 255 emoji characters" do
    account = Account.new(name: "" * 255)
    assert account.save
  end
  test "account name rejects 256 emoji characters" do
    account = Account.new(name: "" * 256)
    assert_raises(*COLUMN_LIMIT_ERRORS) { account.save! }
  end
  # Test text column limits (65535 bytes for TEXT)
  test "step content rejects text over 65535 bytes" do
    step = Step.new(content: "a" * 65536, card: cards(:logo))
    assert_raises(*COLUMN_LIMIT_ERRORS) { step.save! }
  end
  test "step content accepts text up to 65535 bytes" do
    step = Step.new(content: "a" * 65535, card: cards(:logo))
    assert step.save
  end
  test "step content counts bytes not characters for text columns" do
    # 20000 emoji = 20000 chars but 80000 bytes (over 65535 limit)
    step = Step.new(content: "" * 20000, card: cards(:logo))
    assert_raises(*COLUMN_LIMIT_ERRORS) { step.save! }
  end
  test "ActionText::RichText name rejects strings over 255 characters" do
    rich_text = ActionText::RichText.new(name: "a" * 256, record: cards(:logo))
    assert_raises(*COLUMN_LIMIT_ERRORS) { rich_text.save! }
  end
  test "ActiveStorage::Blob filename rejects strings over 255 characters" do
    Current.account = accounts(:"37s")
    blob = ActiveStorage::Blob.new(filename: "a" * 256, key: "test-key", byte_size: 0, checksum: "test", service_name: "local")
    assert_raises(*COLUMN_LIMIT_ERRORS) { blob.save! }
  end
end

================
File: test/models/column_test.rb
================
require "test_helper"
class ColumnTest < ActiveSupport::TestCase
  test "touch all the cards when the name or color changes" do
    column = columns(:writebook_triage)
    assert_changes -> { column.cards.first.updated_at } do
      column.update!(name: "New Name")
    end
    assert_changes -> { column.cards.first.updated_at } do
      column.update!(color: "#FF0000")
    end
    assert_no_changes -> { column.cards.first.updated_at } do
      column.update!(updated_at: 1.hour.from_now)
    end
  end
  test "touch all board cards when column is destroyed" do
    column = columns(:writebook_triage)
    assert_changes -> { column.board.cards.first.updated_at } do
      column.destroy
    end
  end
end

================
File: test/models/comment_test.rb
================
require "test_helper"
class CommentTest < ActiveSupport::TestCase
  setup do
    Current.session = sessions(:david)
  end
  test "cannot create comment on a draft card" do
    draft_card = cards(:unfinished_thoughts)
    comment = draft_card.comments.build(body: "This should fail")
    assert_not comment.valid?
    assert_includes comment.errors[:card], "does not allow comments"
    assert_raises(ActiveRecord::RecordInvalid) do
      draft_card.comments.create!(body: "This should raise")
    end
  end
  test "rich text embed variants are processed immediately on attachment" do
    comment = cards(:logo).comments.create!(body: "Check this out")
    comment.body.body.attachables # force load
    blob = ActiveStorage::Blob.create_and_upload! \
      io: File.open(file_fixture("moon.jpg")),
      filename: "moon.jpg",
      content_type: "image/jpeg"
    comment.body.body = ActionText::Content.new(comment.body.body.to_html).append_attachables(blob)
    comment.save!
    embed = comment.body.embeds.sole
    Attachments::VARIANTS.each_key do |variant_name|
      variant = embed.variant(variant_name)
      assert variant.processed?, "Expected #{variant_name} variant to be processed immediately"
    end
  end
end

================
File: test/models/entropy_test.rb
================
require "test_helper"
class Entropy::Test < ActiveSupport::TestCase
  test "touch cards when entropy changes for board" do
    assert_changes -> { boards(:writebook).cards.first.updated_at } do
      boards(:writebook).entropy.update!(auto_postpone_period: 15.days)
    end
  end
  test "touch cards when entropy changes for account container" do
    account = Current.account
    assert_changes -> { account.cards.first.updated_at } do
      boards(:writebook).entropy.update!(auto_postpone_period: 15.days)
    end
  end
end

================
File: test/models/filter_test.rb
================
require "test_helper"
class FilterTest < ActiveSupport::TestCase
  setup do
    Current.session = sessions(:david)
  end
  test "cards" do
    @new_board = Board.create! name: "Inaccessible Board", creator: users(:david)
    @new_card = @new_board.cards.create!(status: "published")
    cards(:layout).comments.create!(body: "I hate haggis")
    cards(:logo).comments.create!(body: "I love haggis")
    assert_not_includes users(:kevin).filters.new.cards, @new_card
    filter = users(:david).filters.new creator_ids: [ users(:david).id ], tag_ids: [ tags(:mobile).id ]
    assert_equal [ cards(:layout) ], filter.cards
    filter = users(:david).filters.new assignment_status: "unassigned", board_ids: [ @new_board.id ]
    assert_equal [ @new_card ], filter.cards
    filter = users(:david).filters.new indexed_by: "closed"
    assert_equal [ cards(:shipping) ], filter.cards
    cards(:shipping).postpone
    filter = users(:david).filters.new indexed_by: "not_now"
    assert_includes filter.cards, cards(:shipping)
    filter = users(:david).filters.new card_ids: [ cards(:logo, :layout).collect(&:id) ]
    assert_equal [ cards(:logo), cards(:layout) ], filter.cards
  end
  test "can't see cards in boards that aren't accessible" do
    boards(:writebook).update! all_access: false
    boards(:writebook).accesses.revoke_from users(:david)
    assert_empty users(:david).filters.new(board_ids: [ boards(:writebook).id ]).cards
  end
  test "can't see boards that aren't accessible" do
    boards(:writebook).update! all_access: false
    boards(:writebook).accesses.revoke_from users(:david)
    assert_empty users(:david).filters.new(board_ids: [ boards(:writebook).id ]).boards
  end
  test "remembering equivalent filters" do
    assert_difference "Filter.count", +1 do
      filter = users(:david).filters.remember(sorted_by: "latest", assignment_status: "unassigned", tag_ids: [ tags(:mobile).id ])
      assert_changes "filter.reload.updated_at" do
        assert_equal filter, users(:david).filters.remember(tag_ids: [ tags(:mobile).id ], assignment_status: "unassigned")
      end
    end
  end
  test "remembering equivalent filters for different users" do
    assert_difference "Filter.count", +2 do
      users(:david).filters.remember(assignment_status: "unassigned", tag_ids: [ tags(:mobile).id ])
      users(:kevin).filters.remember(assignment_status: "unassigned", tag_ids: [ tags(:mobile).id ])
    end
  end
  test "turning into params" do
    filter = users(:david).filters.new sorted_by: "latest", tag_ids: "", assignee_ids: [ users(:jz).id ], board_ids: [ boards(:writebook).id ]
    expected = { assignee_ids: [ users(:jz).id ], board_ids: [ boards(:writebook).id ] }
    assert_equal expected, filter.as_params
  end
  test "cacheability" do
    assert_not filters(:jz_assignments).cacheable?
    assert users(:david).filters.create!(board_ids: [ boards(:writebook).id ]).cacheable?
  end
  test "terms" do
    assert_equal [], users(:david).filters.new.terms
    assert_equal [ "haggis" ], users(:david).filters.new(terms: [ "haggis" ]).terms
  end
  test "resource removal" do
    filter = users(:david).filters.create! tag_ids: [ tags(:mobile).id ], board_ids: [ boards(:writebook).id ]
    assert_includes filter.as_params[:tag_ids], tags(:mobile).id
    assert_includes filter.tags, tags(:mobile)
    assert_includes filter.as_params[:board_ids], boards(:writebook).id
    assert_includes filter.boards, boards(:writebook)
    assert_changes "filter.reload.updated_at" do
      tags(:mobile).destroy!
    end
    assert_nil Filter.find(filter.id).as_params[:tag_ids]
    assert_changes "Filter.exists?(filter.id)" do
      boards(:writebook).destroy!
    end
  end
  test "duplicate filters are removed after a resource is destroyed" do
    users(:david).filters.create! tag_ids: [ tags(:mobile).id ], board_ids: [ boards(:writebook).id ]
    users(:david).filters.create! tag_ids: [ tags(:mobile).id, tags(:web).id ], board_ids: [ boards(:writebook).id ]
    assert_difference "Filter.count", -1 do
      tags(:web).destroy!
    end
  end
  test "summary" do
    assert_equal "Newest, #mobile, and assigned to JZ", filters(:jz_assignments).summary
    filters(:jz_assignments).update!(assignees: [], tags: [], boards: [ boards(:writebook) ])
    assert_equal "Newest", filters(:jz_assignments).summary
    filters(:jz_assignments).update!(indexed_by: "stalled", sorted_by: "latest")
    assert_equal "Stalled", filters(:jz_assignments).summary
  end
  test "get a clone with some changed params" do
    seed_filter = users(:david).filters.new indexed_by: "all", terms: [ "haggis" ]
    filter = seed_filter.with(indexed_by: "closed")
    assert filter.indexed_by.closed?
    assert_equal [ "haggis" ], filter.terms
  end
  test "creation window" do
    filter = users(:david).filters.new creation: "this week"
    cards(:logo).update_columns created_at: 2.weeks.ago
    assert_not_includes filter.cards, cards(:logo)
    cards(:logo).update_columns created_at: Time.current
    assert_includes filter.cards, cards(:logo)
  end
  test "closure window" do
    filter = users(:david).filters.new closure: "this week"
    cards(:shipping).closure.update_columns created_at: 2.weeks.ago
    assert_not_includes filter.cards, cards(:shipping)
    cards(:shipping).closure.update_columns created_at: Time.current
    assert_includes filter.cards, cards(:shipping)
  end
  test "completed by" do
    cards(:shipping).closure.update_columns user_id: users(:david).id
    filter = users(:david).filters.new closer_ids: [ users(:david).id ]
    assert_includes filter.cards, cards(:shipping)
    filter = users(:david).filters.new closer_ids: [ users(:jz).id ]
    assert_not_includes filter.cards, cards(:shipping)
    cards(:shipping).closure.update_columns user_id: users(:jz).id
    filter = users(:david).filters.new closer_ids: [ users(:jz).id ]
    assert_includes filter.cards, cards(:shipping)
  end
  test "check if a filter is used" do
    assert users(:david).filters.new(creator_ids: [ users(:david).id ]).used?
    assert_not users(:david).filters.new.used?
    assert users(:david).filters.new(board_ids: [ boards(:writebook).id ]).used?
    assert_not users(:david).filters.new(board_ids: [ boards(:writebook).id ]).used?(ignore_boards: true)
  end
  test "board titles are scoped to creator's account" do
    # Give mike (initech) access to the board in his account
    boards(:miltons_wish_list).accesses.grant_to(users(:mike))
    assert_equal 1, users(:mike).boards.count
    # Filter with no boards selected should show the single board name from mike's account
    filter = users(:mike).filters.new(creator: users(:mike))
    assert_equal [ "Milton's Wish List" ], filter.board_titles
    # Should NOT leak board names from other accounts (37s has multiple boards)
    assert Board.where.not(account: accounts(:initech)).exists?
    assert_not_includes filter.board_titles, "Writebook"
    assert_not_includes filter.board_titles, "Private board"
  end
end

================
File: test/models/identity_test.rb
================
require "test_helper"
class IdentityTest < ActiveSupport::TestCase
  include ActionMailer::TestHelper
  test "send_magic_link" do
    identity = identities(:david)
    assert_emails 1 do
      magic_link = identity.send_magic_link
      assert_not_nil magic_link
      assert_equal identity, magic_link.identity
    end
  end
  test "email address format validation" do
    invalid_emails = [
      "sam smith@example.com",       # space in local part
      "@example.com",                # missing local part
      "test@",                       # missing domain
      "test",                        # missing @ and domain
      "<script>@example.com",        # angle brackets
      "test@example.com\nX-Inject:" # newline (header injection attempt)
    ]
    invalid_emails.each do |email|
      identity = Identity.new(email_address: email)
      assert_not identity.valid?, "expected #{email.inspect} to be invalid"
      assert identity.errors[:email_address].any?, "expected error on email_address for #{email.inspect}"
    end
  end
  test "join" do
    identity = identities(:david)
    account = accounts(:initech)
    Current.without_account do
      assert_difference "User.count", 1 do
        identity.join(account)
      end
      user = account.users.find_by!(identity: identity)
      assert_not_nil user
      assert_equal identity, user.identity
      assert_equal identity.email_address, user.name
    end
  end
  test "destroy deactivates users before nullifying identity" do
    identity = identities(:kevin)
    user = users(:kevin)
    assert_predicate user, :active?
    assert_predicate user.accesses, :any?
    identity.destroy!
    user.reload
    assert_nil user.identity_id, "identity should be nullified"
    assert_not_predicate user, :active?
    assert_empty user.accesses, "user accesses should be removed"
  end
end

================
File: test/models/magic_link_test.rb
================
require "test_helper"
class MagicLinkTest < ActiveSupport::TestCase
  test "new" do
    magic_link = MagicLink.create!(identity: identities(:kevin))
    assert magic_link.code.present?
    assert_equal MagicLink::CODE_LENGTH, magic_link.code.length
    assert magic_link.expires_at.present?
    assert_in_delta MagicLink::EXPIRATION_TIME.from_now, magic_link.expires_at, 1.second
  end
  test "active" do
    active_link = MagicLink.create!(identity: identities(:kevin))
    expired_link = MagicLink.create!(identity: identities(:kevin))
    expired_link.update_column(:expires_at, 1.hour.ago)
    assert_includes MagicLink.active, active_link
    assert_not_includes MagicLink.active, expired_link
  end
  test "stale" do
    active_link = MagicLink.create!(identity: identities(:kevin))
    expired_link = MagicLink.create!(identity: identities(:kevin))
    expired_link.update_column(:expires_at, 1.hour.ago)
    assert_includes MagicLink.stale, expired_link
    assert_not_includes MagicLink.stale, active_link
  end
  test "consume" do
    magic_link = MagicLink.create!(identity: identities(:kevin))
    code_with_spaces = magic_link.code.downcase.chars.join(" ")
    consumed_magic_link = MagicLink.consume(code_with_spaces)
    assert_equal magic_link, consumed_magic_link
    assert_not MagicLink.exists?(magic_link.id)
    expired_link = MagicLink.create!(identity: identities(:kevin))
    expired_link.update_column(:expires_at, 1.hour.ago)
    assert_nil MagicLink.consume(expired_link.code)
    assert MagicLink.exists?(expired_link.id)
    assert_nil MagicLink.consume("INVALID")
    assert_nil MagicLink.consume(nil)
  end
  test "cleanup" do
    active_link = MagicLink.create!(identity: identities(:kevin))
    expired_link = MagicLink.create!(identity: identities(:kevin))
    expired_link.update_column(:expires_at, 1.hour.ago)
    MagicLink.cleanup
    assert MagicLink.exists?(active_link.id)
    assert_not MagicLink.exists?(expired_link.id)
  end
end

================
File: test/models/notification_pusher_test.rb
================
require "test_helper"
class NotificationPusherTest < ActiveSupport::TestCase
  setup do
    @user = users(:david)
    @notification = @user.notifications.create!(
      source: events(:logo_published),
      creator: users(:jason)
    )
    @pusher = NotificationPusher.new(@notification)
    @user.push_subscriptions.create!(
      endpoint: "https://fcm.googleapis.com/fcm/send/test123",
      p256dh_key: "test_key",
      auth_key: "test_auth"
    )
  end
  test "push does not send notifications for cancelled accounts" do
    @user.account.cancel(initiated_by: @user)
    result = @pusher.push
    assert_nil result, "Should not push notifications for cancelled accounts"
  end
  test "push sends notifications for active accounts with subscriptions" do
    result = @pusher.push
    assert_not_nil result, "Should push notifications for active accounts with subscriptions"
  end
end

================
File: test/models/notification_test.rb
================
require "test_helper"
class NotificationTest < ActiveSupport::TestCase
  test "unread marks notification as unread" do
    notification = notifications(:logo_published_kevin)
    notification.read # Mark as read first
    assert_changes -> { notification.reload.read? }, from: true, to: false do
      notification.unread
    end
  end
  test "unread broadcasts to notifications" do
    notification = notifications(:logo_published_kevin)
    notification.read # Mark as read first
    assert_turbo_stream_broadcasts([ notification.user, :notifications ], count: 1) do
      perform_enqueued_jobs do
        notification.unread
      end
    end
  end
  test "read marks notification as read" do
    notification = notifications(:logo_published_kevin)
    # Ensure it starts as unread
    notification.update!(read_at: nil)
    assert_changes -> { notification.reload.read? }, from: false, to: true do
      notification.read
    end
  end
  test "read broadcasts to notifications" do
    notification = notifications(:logo_published_kevin)
    # Ensure it starts as unread
    notification.update!(read_at: nil)
    assert_turbo_stream_broadcasts([ notification.user, :notifications ], count: 1) do
      notification.read
    end
  end
  test "deleting notification broadcasts its removal" do
    notification = notifications(:logo_published_kevin)
    notification.update!(read_at: nil)
    assert_turbo_stream_broadcasts([ notification.user, :notifications ], count: 1) do
      notification.destroy
    end
  end
end

================
File: test/models/qr_code_link_test.rb
================
require "test_helper"
class QrCodeLinkTest < ActiveSupport::TestCase
  test "links can be signed and verified" do
    link = QrCodeLink.new "https://example.com"
    signed_link = link.signed
    verified = QrCodeLink.from_signed(signed_link)
    assert_equal link.url, verified.url
  end
end

================
File: test/models/reaction_test.rb
================
require "test_helper"
class ReactionTest < ActiveSupport::TestCase
  setup do
    Current.session = sessions(:david)
  end
  test "creating a comment reaction touches the card activity" do
    assert_changes -> { cards(:logo).reload.last_active_at } do
      comments(:logo_1).reactions.create!(content: "Nice!")
    end
  end
  test "reactions are deleted when comment is destroyed" do
    comment = comments(:logo_1)
    comment.reactions.create!(content: "")
    reaction_ids = comment.reactions.pluck(:id)
    assert reaction_ids.any?, "Expected comment to have reactions"
    comment.destroy
    assert_empty Reaction.where(id: reaction_ids)
  end
  test "creating a card reaction touches the card activity" do
    card = cards(:logo)
    assert_changes -> { card.reload.last_active_at } do
      card.reactions.create!(content: "")
    end
  end
  test "reactions are deleted when card is destroyed" do
    card = cards(:logo)
    reaction_ids = card.reactions.pluck(:id)
    assert reaction_ids.any?, "Expected card to have reactions"
    card.destroy
    assert_empty Reaction.where(id: reaction_ids)
  end
end

================
File: test/models/search_test.rb
================
require "test_helper"
class SearchTest < ActiveSupport::TestCase
  include SearchTestHelper
  test "search" do
    # Search cards and comments
    card = @board.cards.create!(title: "layout design", creator: @user, status: "published")
    comment_card = @board.cards.create!(title: "Some card", creator: @user, status: "published")
    comment_card.comments.create!(body: "overflowing text", creator: @user)
    results = Search::Record.for(@user.account_id).search("layout", user: @user)
    assert results.find { |it| it.card_id == card.id }
    results = Search::Record.for(@user.account_id).search("overflowing", user: @user)
    assert results.find { |it| it.card_id == comment_card.id && it.searchable_type == "Comment" }
    # Drafted cards are excluded from search results
    drafted_card = @board.cards.create!(title: "drafted searchable content", creator: @user, status: "drafted")
    results = Search::Record.for(@user.account_id).search("drafted", user: @user)
    assert_not results.find { |it| it.card_id == drafted_card.id }
    # Don't include inaccessible boards
    other_user = User.create!(name: "Other User", account: @account)
    inaccessible_board = Board.create!(name: "Inaccessible Board", account: @account, creator: other_user)
    accessible_card = @board.cards.create!(title: "searchable content", creator: @user, status: "published")
    inaccessible_card = inaccessible_board.cards.create!(title: "searchable content", creator: other_user, status: "published")
    results = Search::Record.for(@user.account_id).search("searchable", user: @user)
    assert results.find { |it| it.card_id == accessible_card.id }
    assert_not results.find { |it| it.card_id == inaccessible_card.id }
    # Empty board_ids returns no results
    user_without_access = User.create!(name: "No Access User", account: @account)
    results = Search::Record.for(user_without_access.account_id).search("anything", user: user_without_access)
    assert_empty results
  end
end

================
File: test/models/signup_test.rb
================
require "test_helper"
class SignupTest < ActiveSupport::TestCase
  test "validates email format for identity creation" do
    signup = Signup.new(email_address: "not-an-email")
    assert_not signup.valid?(:identity_creation)
    assert signup.errors[:email_address].any?
    signup = Signup.new(email_address: "valid@example.com")
    assert signup.valid?(:identity_creation)
  end
  test "#create_identity" do
    signup = Signup.new(email_address: "brian@example.com")
    magic_link = nil
    assert_difference -> { Identity.count }, 1 do
      assert_difference -> { MagicLink.count }, 1 do
        magic_link = signup.create_identity
      end
    end
    assert_kind_of MagicLink, magic_link
    assert_empty signup.errors
    assert signup.identity
    assert signup.identity.persisted?
    signup_existing = Signup.new(email_address: "brian@example.com")
    assert_no_difference -> { Identity.count } do
      assert_difference -> { MagicLink.count }, 1 do
        magic_link = signup_existing.create_identity
      end
    end
    assert_kind_of MagicLink, magic_link
    signup_invalid = Signup.new(email_address: "")
    assert_raises do
      signup_invalid.create_identity
    end
  end
  test "#complete" do
    Account.any_instance.expects(:setup_customer_template).once
    Current.without_account do
      signup = Signup.new(full_name: "Kevin", identity: identities(:kevin))
      assert signup.complete
      assert signup.account
      assert signup.user
      assert_equal "Kevin", signup.user.name
      signup_invalid = Signup.new(
        full_name: "",
        identity: identities(:kevin)
      )
      assert_not signup_invalid.complete
      assert_not_empty signup_invalid.errors[:full_name]
    end
  end
  test "#complete with invalid data" do
    Current.without_account do
      signup = Signup.new
      assert_not signup.complete
      assert signup.errors[:full_name].any?
      assert signup.errors[:identity].any?
      assert_nil signup.account
      assert_nil signup.user
    end
  end
  test "#complete with name that is too long" do
    Current.without_account do
      signup = Signup.new(full_name: "A" * 241, identity: identities(:kevin))
      signup.expects(:create_tenant).never
      assert_not signup.complete
      assert signup.errors[:full_name].any?
      assert_nil signup.account
      assert_nil signup.user
    end
  end
end

================
File: test/models/ssrf_protection_test.rb
================
require "test_helper"
class SsrfProtectionTest < ActiveSupport::TestCase
  test "blocks loopback addresses" do
    stub_dns_resolution("127.0.0.1")
    assert_nil SsrfProtection.resolve_public_ip("localhost")
  end
  test "blocks private 10.x.x.x addresses" do
    stub_dns_resolution("10.0.0.1")
    assert_nil SsrfProtection.resolve_public_ip("internal.example.com")
  end
  test "blocks private 172.16.x.x addresses" do
    stub_dns_resolution("172.16.0.1")
    assert_nil SsrfProtection.resolve_public_ip("internal.example.com")
  end
  test "blocks private 192.168.x.x addresses" do
    stub_dns_resolution("192.168.1.1")
    assert_nil SsrfProtection.resolve_public_ip("internal.example.com")
  end
  test "blocks link-local addresses (AWS metadata endpoint)" do
    stub_dns_resolution("169.254.169.254")
    assert_nil SsrfProtection.resolve_public_ip("metadata.example.com")
  end
  test "blocks carrier-grade NAT addresses" do
    stub_dns_resolution("100.64.0.1")
    assert_nil SsrfProtection.resolve_public_ip("cgnat.example.com")
  end
  test "blocks benchmark testing addresses" do
    stub_dns_resolution("198.18.0.1")
    assert_nil SsrfProtection.resolve_public_ip("benchmark.example.com")
  end
  test "blocks broadcast addresses" do
    stub_dns_resolution("0.0.0.1")
    assert_nil SsrfProtection.resolve_public_ip("broadcast.example.com")
  end
  test "allows public addresses" do
    stub_dns_resolution("93.184.216.34")
    assert_equal "93.184.216.34", SsrfProtection.resolve_public_ip("example.com")
  end
  test "returns first public IP when multiple addresses resolve" do
    stub_dns_resolution("10.0.0.1", "93.184.216.34", "192.168.1.1")
    assert_equal "93.184.216.34", SsrfProtection.resolve_public_ip("multi.example.com")
  end
  # IPv6 address format tests (SSRF bypass prevention)
  test "blocks IPv4-mapped IPv6 addresses with private IPs" do
    stub_dns_resolution("::ffff:192.168.1.1")
    assert_nil SsrfProtection.resolve_public_ip("mapped-private.example.com")
  end
  test "blocks IPv4-mapped IPv6 addresses with link-local IPs" do
    stub_dns_resolution("::ffff:169.254.169.254")
    assert_nil SsrfProtection.resolve_public_ip("mapped-metadata.example.com")
  end
  test "blocks IPv4-mapped IPv6 addresses even with public IPs" do
    stub_dns_resolution("::ffff:93.184.216.34")
    assert_nil SsrfProtection.resolve_public_ip("mapped-public.example.com")
  end
  test "blocks IPv4-compatible IPv6 addresses with private IPs" do
    stub_dns_resolution("::192.168.1.1")
    assert_nil SsrfProtection.resolve_public_ip("compat-private.example.com")
  end
  test "blocks IPv4-compatible IPv6 addresses with link-local IPs" do
    stub_dns_resolution("::169.254.169.254")
    assert_nil SsrfProtection.resolve_public_ip("compat-metadata.example.com")
  end
  test "blocks IPv4-compatible IPv6 addresses even with public IPs" do
    stub_dns_resolution("::93.184.216.34")
    assert_nil SsrfProtection.resolve_public_ip("compat-public.example.com")
  end
  private
    def stub_dns_resolution(*ips)
      dns_mock = mock("dns")
      dns_mock.stubs(:each_address).multiple_yields(*ips)
      Resolv::DNS.stubs(:open).yields(dns_mock)
    end
end

================
File: test/models/tag_test.rb
================
require "test_helper"
class TagTest < ActiveSupport::TestCase
  test "downcase title" do
    assert_equal "a tag", Tag.create!(title: "A TAG").title
  end
  test ".unused returns tags not associated with any cards" do
    unused = Tag.create!(title: "unused")
    unused_tags = Tag.unused
    assert_includes unused_tags, unused
    assert_not_includes unused_tags, tags(:web)
    assert_not_includes unused_tags, tags(:mobile)
  end
  test ".unused returns empty relation if all tags are used" do
    assert_empty Tag.unused
  end
end

================
File: test/models/time_window_parser_test.rb
================
require "test_helper"
class TimeWindowParserTest < ActiveSupport::TestCase
  setup do
    @now = Time.zone.parse("2023-06-15 9am")
    @parser = TimeWindowParser.new(now: @now)
  end
  test "parse today" do
    assert_equal @now.beginning_of_day..@now.end_of_day,
      @parser.parse("today")
  end
  test "parse yesterday" do
    yesterday = @now - 1.day
    assert_equal yesterday.beginning_of_day..yesterday.end_of_day,
      @parser.parse("yesterday")
  end
  test "parse this week" do
    assert_equal @now.beginning_of_week..@now.end_of_week,
      @parser.parse("this week")
  end
  test "parse this month" do
    assert_equal @now.beginning_of_month..@now.end_of_month,
      @parser.parse("this month")
  end
  test "parse this year" do
    assert_equal @now.beginning_of_year..@now.end_of_year,
      @parser.parse("this year")
  end
  test "parse last week" do
    last_week = @now - 1.week
    assert_equal last_week.beginning_of_week..last_week.end_of_week,
      @parser.parse("last week")
  end
  test "parse last month" do
    last_month = @now - 1.month
    assert_equal last_month.beginning_of_month..last_month.end_of_month,
      @parser.parse("last month")
  end
  test "parse last year" do
    last_year = @now - 1.year
    assert_equal last_year.beginning_of_year..last_year.end_of_year,
      @parser.parse("last year")
  end
  test "parse with unknown string returns nil" do
    assert_nil @parser.parse("unknown time window")
  end
  test "returns nil for nil" do
    assert_nil @parser.parse(nil)
  end
end

================
File: test/models/user_test.rb
================
require "test_helper"
class UserTest < ActiveSupport::TestCase
  test "create" do
    user = User.create!(
      account: accounts("37s"),
      role: "member",
      name: "Victor Cooper"
    )
    assert_equal [ boards(:writebook) ], user.boards
    assert user.settings.present?
  end
  test "creation gives access to all_access boards" do
    user = User.create!(
      account: accounts("37s"),
      role: "member",
      name: "Victor Cooper"
    )
    assert_equal [ boards(:writebook) ], user.boards
  end
  test "deactivate" do
    assert_changes -> { users(:jz).active? }, from: true, to: false do
      assert_changes -> { users(:jz).accesses.count }, from: 1, to: 0 do
        users(:jz).tap do |user|
          user.stubs(:close_remote_connections).once
          user.deactivate
        end
      end
    end
  end
  test "initials" do
    assert_equal "JF", User.new(name: "jason fried").initials
    assert_equal "DHH", User.new(name: "David Heinemeier Hansson").initials
    assert_equal "LH", User.new(name: "va-Louise Hernndez").initials
  end
  test "name methods handle blank names gracefully" do
    user = User.new(name: "")
    assert_equal "", user.familiar_name
    assert_nil user.first_name
    assert_nil user.last_name
    assert_equal "", user.initials
  end
  test "validates name presence" do
    user = User.new(account: accounts("37s"), role: "member", name: "")
    assert_not user.valid?
    assert_includes user.errors[:name], "can't be blank"
    user.name = "   "
    assert_not user.valid?
    assert_includes user.errors[:name], "can't be blank"
    user.name = "Victor Cooper"
    assert user.valid?
  end
  test "setup?" do
    user = users(:kevin)
    user.update!(name: user.identity.email_address)
    assert_not user.setup?
    user.update!(name: "Kevin")
    assert user.setup?
  end
  test "verified? returns true when verified_at is present" do
    user = users(:david)
    user.update_column(:verified_at, Time.current)
    assert user.verified?
  end
  test "verified? returns false when verified_at is nil" do
    user = users(:david)
    user.update_column(:verified_at, nil)
    assert_not user.verified?
  end
  test "verify sets verified_at when not already verified" do
    user = users(:david)
    user.update_column(:verified_at, nil)
    assert_nil user.verified_at
    user.verify
    assert_not_nil user.reload.verified_at
  end
  test "verify does not update verified_at when already verified" do
    user = users(:david)
    original_time = 1.day.ago
    user.update_column(:verified_at, original_time)
    user.verify
    assert_equal original_time.to_i, user.reload.verified_at.to_i
  end
end

================
File: test/models/zip_file_test.rb
================
require "test_helper"
class ZipFileTest < ActiveSupport::TestCase
  test "writer adds files with content" do
    tempfile = Tempfile.new([ "test", ".zip" ])
    tempfile.binmode
    writer = ZipFile::Writer.new(tempfile)
    writer.add_file("hello.txt", "Hello, World!")
    writer.close
    assert writer.exists?("hello.txt")
    assert_not writer.exists?("missing.txt")
  end
  test "writer adds files with block" do
    tempfile = Tempfile.new([ "test", ".zip" ])
    tempfile.binmode
    writer = ZipFile::Writer.new(tempfile)
    writer.add_file("hello.txt") { |sink| sink.write("Hello, World!") }
    writer.close
    assert writer.exists?("hello.txt")
  end
  test "writer globs entries" do
    tempfile = Tempfile.new([ "test", ".zip" ])
    tempfile.binmode
    writer = ZipFile::Writer.new(tempfile)
    writer.add_file("docs/readme.txt", "Readme")
    writer.add_file("docs/guide.txt", "Guide")
    writer.add_file("images/logo.png", "PNG data")
    writer.close
    assert_equal [ "docs/guide.txt", "docs/readme.txt" ], writer.glob("docs/*.txt")
    assert_equal [ "images/logo.png" ], writer.glob("**/*.png")
  end
  test "reader reads file content" do
    tempfile = create_test_zip("hello.txt" => "Hello, World!")
    reader = ZipFile::Reader.new(tempfile)
    content = reader.read("hello.txt")
    assert_equal "Hello, World!", content
  end
  test "reader reads file with block" do
    tempfile = create_test_zip("hello.txt" => "Hello, World!")
    reader = ZipFile::Reader.new(tempfile)
    content = nil
    reader.read("hello.txt") { |io| content = io.read }
    assert_equal "Hello, World!", content
  end
  test "reader raises for missing file" do
    tempfile = create_test_zip("hello.txt" => "Hello")
    reader = ZipFile::Reader.new(tempfile)
    assert_raises(ArgumentError) { reader.read("missing.txt") }
  end
  test "reader checks file existence" do
    tempfile = create_test_zip("hello.txt" => "Hello")
    reader = ZipFile::Reader.new(tempfile)
    assert reader.exists?("hello.txt")
    assert_not reader.exists?("missing.txt")
  end
  test "reader globs entries" do
    tempfile = create_test_zip(
      "docs/readme.txt" => "Readme",
      "docs/guide.txt" => "Guide",
      "images/logo.png" => "PNG"
    )
    reader = ZipFile::Reader.new(tempfile)
    assert_equal [ "docs/guide.txt", "docs/readme.txt" ], reader.glob("docs/*.txt")
  end
  test "reader io provides size" do
    tempfile = create_test_zip("hello.txt" => "Hello, World!")
    reader = ZipFile::Reader.new(tempfile)
    reader.read("hello.txt") do |io|
      assert_equal 13, io.size
    end
  end
  test "reader io supports rewind" do
    tempfile = create_test_zip("hello.txt" => "Hello, World!")
    reader = ZipFile::Reader.new(tempfile)
    reader.read("hello.txt") do |io|
      first_read = io.read
      io.rewind
      second_read = io.read
      assert_equal first_read, second_read
    end
  end
  test "reader io tracks eof" do
    tempfile = create_test_zip("hello.txt" => "Hello")
    reader = ZipFile::Reader.new(tempfile)
    reader.read("hello.txt") do |io|
      assert_not io.eof?
      io.read
      assert io.eof?
    end
  end
  private
    def create_test_zip(files)
      tempfile = Tempfile.new([ "test", ".zip" ])
      tempfile.binmode
      writer = ZipFile::Writer.new(tempfile)
      files.each { |path, content| writer.add_file(path, content) }
      writer.close
      tempfile.rewind
      tempfile
    end
end

================
File: test/system/.keep
================


================
File: test/system/smoke_test.rb
================
require "application_system_test_case"
class SmokeTest < ApplicationSystemTestCase
  test "joining an account" do
    account = accounts("37s")
    visit join_url(code: account.join_code.code, script_name: account.slug)
    fill_in "Email address", with: "newbie@example.com"
    click_on "Continue"
    assert_selector "h1", text: "Check your email"
    identity = Identity.find_by!(email_address: "newbie@example.com")
    code = identity.magic_links.active.first.code
    fill_in "code", with: code
    send_keys :enter
    assert_selector "input[id=user_name]"
    assert account.users.find_by!(identity:).verified?, "User was not properly verified"
    fill_in "Full name", with: "New Bee"
    click_on "Continue"
    assert_selector "h1", text: "Writebook"
  end
  test "create a card" do
    sign_in_as(users(:david))
    visit board_url(boards(:writebook))
    click_on "Add a card"
    fill_in "card_title", with: "Hello, world!"
    fill_in_lexxy with: "I am editing this thing"
    click_on "Create card"
    assert_selector "h3", text: "Hello, world!"
  end
  test "active storage attachments" do
    sign_in_as(users(:david))
    visit card_url(cards(:layout))
    fill_in_lexxy with: "Here is a comment"
    attach_file file_fixture("moon.jpg") do
      click_on "Upload file"
    end
    within("form lexxy-editor figure.attachment[data-content-type='image/jpeg']") do
      assert_selector "img[src*='/rails/active_storage']"
      assert_selector "figcaption textarea[placeholder='moon.jpg']"
    end
    click_on "Post"
    within("action-text-attachment") do
      assert_selector "a img[src*='/rails/active_storage']"
      assert_selector "figcaption span.attachment__name", text: "moon.jpg"
    end
    # Click the image to open the lightbox
    find("action-text-attachment figure.attachment a:has(img)").click
    assert_selector "dialog.lightbox[open]"
    within("dialog.lightbox") do
      assert_selector "img.lightbox__image[src*='/rails/active_storage']"
    end
  end
  test "dismissing notifications" do
    sign_in_as(users(:david))
    notif = notifications(:logo_card_david_mention_by_jz)
    assert_selector "div##{dom_id(notif)}"
    within_window(open_new_window) { visit card_url(notif.card) }
    assert_no_selector "div##{dom_id(notif)}"
  end
  test "dragging card to a new column" do
    sign_in_as(users(:david))
    card = Card.find("03axhd1h3qgnsffqplkyf28fv")
    assert_nil(card.column)
    visit board_url(boards(:writebook))
    card_el = page.find("#article_card_03axhd1h3qgnsffqplkyf28fv")
    column_el = page.find("#column_03axmcferfmbnv4qg816nw6bg")
    cards_count = column_el.find(".cards__expander-count").text.to_i
    card_el.drag_to(column_el)
    column_el.find(".cards__expander-count", text: cards_count + 1)
    assert_equal("Triage", card.reload.column.name)
  end
  private
    def sign_in_as(user)
      visit session_transfer_url(user.identity.transfer_id, script_name: nil)
      assert_selector "h1", text: "Latest Activity"
    end
    def fill_in_lexxy(selector = "lexxy-editor", with:)
      editor_element = find(selector)
      editor_element.set with
      page.execute_script("arguments[0].value = '#{with}'", editor_element)
    end
end

================
File: test/test_helpers/action_text_test_helper.rb
================
module ActionTextTestHelper
  def assert_action_text(expected_html, content)
    assert_equal_html <<~HTML, content.to_s
      <div class="action-text-content">#{expected_html}</action-text-content>
    HTML
  end
  def assert_equal_html(expected, actual)
    assert_equal normalize_html(expected), normalize_html(actual)
  end
  def normalize_html(html)
    Nokogiri::HTML.fragment(html).tap do |fragment|
      fragment.traverse do |node|
        if node.text?
          node.content = node.text.squish
        end
      end
    end.to_html.strip
  end
end

================
File: test/test_helpers/caching_test_helper.rb
================
module CachingTestHelper
  def with_actionview_partial_caching
    was_cache = ActionView::PartialRenderer.collection_cache
    was_perform_caching = ApplicationController.perform_caching
    begin
      ActionView::PartialRenderer.collection_cache = ActiveSupport::Cache.lookup_store(:memory_store)
      ApplicationController.perform_caching = true
      yield
    ensure
      ActionView::PartialRenderer.collection_cache = was_cache
      ApplicationController.perform_caching = was_perform_caching
    end
  end
end

================
File: test/test_helpers/card_activity_test_helper.rb
================
module CardActivityTestHelper
  def multiple_people_comment_on(card, times: 4, people: users(:david, :kevin, :jz))
    perform_enqueued_jobs only: Card::ActivitySpike::DetectionJob do
      times.times do |index|
        creator = people[index % people.size]
        card.comments.create!(body: "Comment number #{index}", creator: creator)
        travel 1.second
      end
    end
  end
end

================
File: test/test_helpers/card_test_helper.rb
================
module CardTestHelper
  def assert_card_container_rerendered(card)
    assert_turbo_stream action: :replace, target: dom_id(card, :card_container)
  end
end

================
File: test/test_helpers/change_test_helper.rb
================
module ChangeTestHelper
  def capture_change(target)
    before = target.call
    yield
    after = target.call
    after - before
  end
end

================
File: test/test_helpers/command_test_helper.rb
================
module CommandTestHelper
  def execute_command(string, user: users(:david))
    parse_command(string, user:).execute
  end
  def parse_command(string, user: users(:david))
    parser = Command::Parser.new(user: user, script_name: integration_session.default_url_options[:script_name])
    parser.parse(string)
  end
end

================
File: test/test_helpers/search_test_helper.rb
================
module SearchTestHelper
  extend ActiveSupport::Concern
  included do
    self.use_transactional_tests = false
    setup :setup_search_test
    teardown :teardown_search_test
  end
  def setup_search_test
    clear_search_records
    Account.find_by(name: "Search Test")&.destroy
    Identity.find_by(email_address: "test@example.com")&.destroy
    @account = Account.create!(name: "Search Test", external_account_id: ActiveRecord::FixtureSet.identify("search_test"))
    Current.account = @account
    @identity = Identity.create!(email_address: "test@example.com")
    @user = User.create!(name: "Test User", account: @account, identity: @identity)
    Current.user = @user
    @board = Board.create!(name: "Test Board", account: @account, creator: @user)
  end
  def teardown_search_test
    clear_search_records
    Account.find_by(name: "Search Test")&.destroy
    Identity.find_by(email_address: "test@example.com")&.destroy
  end
  private
    def clear_search_records
      if ActiveRecord::Base.connection.adapter_name == "SQLite"
        ActiveRecord::Base.connection.execute("DELETE FROM search_records")
        ActiveRecord::Base.connection.execute("DELETE FROM search_records_fts")
      else
        Search::Record::Trilogy::SHARD_COUNT.times do |shard_id|
          ActiveRecord::Base.connection.execute("DELETE FROM search_records_#{shard_id}")
        end
      end
    end
end

================
File: test/test_helpers/session_test_helper.rb
================
module SessionTestHelper
  def parsed_cookies
    ActionDispatch::Cookies::CookieJar.build(request, cookies.to_hash)
  end
  def sign_in_as(identity)
    cookies.delete :session_token
    if identity.is_a?(User)
      user = identity
      identity = user.identity
      raise "User #{user.name} (#{user.id}) doesn't have an associated identity" unless identity
    elsif !identity.is_a?(Identity)
      identity = identities(identity)
    end
    identity.send_magic_link
    magic_link = identity.magic_links.order(id: :desc).first
    untenanted do
      post session_path, params: { email_address: identity.email_address }
      post session_magic_link_url, params: { code: magic_link.code }
    end
    assert_response :redirect, "Posting the Magic Link code should grant access"
    cookie = cookies.get_cookie "session_token"
    assert_not_nil cookie, "Expected session_token cookie to be set after sign in"
  end
  def logout_and_sign_in_as(identity)
    Session.delete_all
    sign_in_as identity
  end
  def sign_out
    untenanted do
      delete session_path
    end
    assert_not cookies[:session_token].present?
  end
  def with_current_user(user)
    user = users(user) unless user.is_a? User
    @old_session = Current.session
    begin
      Current.session = Session.new(identity: user.identity)
      yield
    ensure
      Current.session = @old_session
    end
  end
  def untenanted(&block)
    original_script_name = integration_session.default_url_options[:script_name]
    integration_session.default_url_options[:script_name] = ""
    yield
  ensure
    integration_session.default_url_options[:script_name] = original_script_name
  end
  def with_multi_tenant_mode(enabled)
    previous = Account.multi_tenant
    Account.multi_tenant = enabled
    yield
  ensure
    Account.multi_tenant = previous
  end
end

================
File: test/test_helpers/vcr_test_helper.rb
================
# To include in those tests that use VCR. It will automatically insert a VCR cassette named after the test. By default,
# it will run the test in "replay" mode. To switch to record mode, you can either:
#
# * Set the environment variable +VCR_RECORD+.
# * Use +.vcr_record!+ in your test class.
module VcrTestHelper
  extend ActiveSupport::Concern
  included do
    class_attribute :vcr_record
    setup do
      @casette_name = "#{self.class.name.tableize.singularize}-#{name}"
      VCR.insert_cassette @casette_name,
        record: recording? ? :all : :none,
        preserve_exact_body_bytes: true
    end
    teardown do
      VCR.eject_cassette
    end
    def recording?
      vcr_record || ENV["VCR_RECORD"]
    end
  end
  class_methods do
    # Use to force record mode at development time: always perform real http interactions and record fixtures
    def vcr_record!
      raise "#vcr_record! is meant for dev time. You are not supposed to run it in CI." if ENV["CI"]
      self.vcr_record = true
    end
  end
  def without_vcr_body_matching(&block)
    VCR.use_cassette("#{@casette_name}_without_body", match_requests_on: [ :method, :uri ], &block)
  end
end

================
File: test/application_system_test_case.rb
================
require "test_helper"
class ApplicationSystemTestCase < ActionDispatch::SystemTestCase
  browser_options = Selenium::WebDriver::Chrome::Options.new.tap do |opts|
    opts.add_argument("--window-size=1200,800")
    opts.add_argument("--disable-extensions")
    # Disable non-foreground tabs from getting a lower process priority
    opts.add_argument("--disable-renderer-backgrounding")
    # Normally, Chrome will treat a 'foreground' tab instead as backgrounded if the surrounding
    # window is occluded (aka visually covered) by another window. This flag disables that.
    opts.add_argument("--disable-backgrounding-occluded-windows")
    # Suppress all permission prompts by automatically denying them.
    opts.add_argument("--deny-permission-prompts")
    opts.add_argument("--enable-automation")
  end
  Capybara.register_driver :chrome_headless do |app|
    browser_options.add_argument("--headless")
    Capybara::Selenium::Driver.new(app, browser: :chrome, options: browser_options)
  end
  Capybara.register_driver :chrome do |app|
    Capybara::Selenium::Driver.new(app, browser: :chrome, options: browser_options)
  end
  if ENV["SYSTEM_TESTS_BROWSER"]
    driven_by :chrome, screen_size: [ 1200, 1000 ]
  else
    driven_by :chrome_headless, screen_size: [ 1200, 1000 ]
  end
end

================
File: test/routes_test.rb
================
require "test_helper"
class RouteTest < ActionDispatch::IntegrationTest
  test "account/join_code" do
    assert_recognizes({ controller: "account/join_codes", action: "show" }, "/account/join_code")
  end
  test "account/settings" do
    assert_recognizes({ controller: "account/settings", action: "show" }, "/account/settings")
  end
  test "account/entropy" do
    assert_recognizes({ controller: "account/entropies", action: "show" }, "/account/entropy")
  end
end

================
File: test/test_helper.rb
================
ENV["RAILS_ENV"] ||= "test"
require_relative "../config/environment"
require "rails/test_help"
require "webmock/minitest"
require_relative "webmock_ipaddr_extension"
require "vcr"
require "mocha/minitest"
require "turbo/broadcastable/test_helper"
WebMock.allow_net_connect!
VCR.configure do |config|
  config.allow_http_connections_when_no_cassette = true
  config.cassette_library_dir = "test/vcr_cassettes"
  config.hook_into :webmock
  config.filter_sensitive_data("<OPEN_AI_KEY>") { Rails.application.credentials.openai_api_key || ENV["OPEN_AI_API_KEY"] }
  config.default_cassette_options = {
    match_requests_on: [ :method, :uri, :body ]
  }
  # Ignore timestamps in request bodies
  config.before_record do |i|
    if i.request&.body
      i.request.body.gsub!(/\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2} UTC/, "<TIME>")
    end
  end
  config.register_request_matcher :body_without_times do |r1, r2|
    b1 = (r1.body || "").gsub(/\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2} UTC/, "<TIME>")
    b2 = (r2.body || "").gsub(/\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2} UTC/, "<TIME>")
    b1 == b2
  end
  config.default_cassette_options = {
    match_requests_on: [ :method, :uri, :body_without_times ]
  }
end
module ActiveSupport
  class TestCase
    parallelize workers: :number_of_processors, work_stealing: ENV["WORK_STEALING"] != "false"
    # Setup all fixtures in test/fixtures/*.yml for all tests in alphabetical order.
    fixtures :all
    include ActiveJob::TestHelper
    include ActionTextTestHelper, CachingTestHelper, CardTestHelper, ChangeTestHelper, SessionTestHelper
    include Turbo::Broadcastable::TestHelper
    setup do
      Current.account = accounts("37s")
    end
    teardown do
      Current.clear_all
    end
  end
end
class ActionDispatch::IntegrationTest
  setup do
    integration_session.default_url_options[:script_name] = "/#{ActiveRecord::FixtureSet.identify("37signals")}"
  end
  private
    def without_action_dispatch_exception_handling
      original = Rails.application.config.action_dispatch.show_exceptions
      Rails.application.config.action_dispatch.show_exceptions = :none
      Rails.application.instance_variable_set(:@app_env_config, nil) # Clear memoized env_config
      yield
    ensure
      Rails.application.config.action_dispatch.show_exceptions = original
      Rails.application.instance_variable_set(:@app_env_config, nil) # Reset env_config
    end
end
class ActionDispatch::SystemTestCase
  setup do
    self.default_url_options[:script_name] = "/#{ActiveRecord::FixtureSet.identify("37signals")}"
  end
end
module FixturesTestHelper
  extend ActiveSupport::Concern
  class_methods do
    def identify(label, column_type = :integer)
      if label.to_s.end_with?("_uuid")
        column_type = :uuid
        label = label.to_s.delete_suffix("_uuid")
      end
      # Rails passes :string for varchar columns, so handle both :uuid and :string
      return super(label, column_type) unless column_type.in?([ :uuid, :string ])
      generate_fixture_uuid(label)
    end
    private
    def generate_fixture_uuid(label)
      # Generate deterministic UUIDv7 for fixtures that sorts by fixture ID
      # This allows .first/.last to work as expected in tests
      # Use the same CRC32 algorithm as Rails' default fixture ID generation
      # so that UUIDs sort in the same order as integer IDs
      fixture_int = Zlib.crc32("fixtures/#{label}") % (2**30 - 1)
      # Translate the deterministic order into times in the past, so that records
      # created during test runs are also always newer than the fixtures.
      base_time = Time.utc(2024, 1, 1, 0, 0, 0)
      timestamp = base_time + (fixture_int / 1000.0)
      uuid_v7_with_timestamp(timestamp, label)
    end
    def uuid_v7_with_timestamp(time, seed_string)
      # Generate UUIDv7 with custom timestamp and deterministic random bits
      # Format: 48-bit timestamp_ms | 12-bit sub_ms_precision | 4-bit version | 62-bit random
      time_ms = time.to_f * 1000
      timestamp_ms = time_ms.to_i
      # 48-bit timestamp (milliseconds since epoch)
      bytes = []
      bytes[0] = (timestamp_ms >> 40) & 0xff
      bytes[1] = (timestamp_ms >> 32) & 0xff
      bytes[2] = (timestamp_ms >> 24) & 0xff
      bytes[3] = (timestamp_ms >> 16) & 0xff
      bytes[4] = (timestamp_ms >> 8) & 0xff
      bytes[5] = timestamp_ms & 0xff
      # Use the 12-bit rand_a field for sub-millisecond precision
      # Extract fractional milliseconds and convert to 12-bit value (0-4095)
      # This gives us ~0.244 microsecond precision
      frac_ms = time_ms - timestamp_ms
      sub_ms_precision = (frac_ms * 4096).to_i & 0xfff
      # Derive deterministic "random" bits from seed_string for the remaining random bits
      hash = Digest::MD5.hexdigest(seed_string)
      # 12-bit sub-ms precision + 4-bit version (0111 for v7)
      bytes[6] = ((sub_ms_precision >> 8) & 0x0f) | 0x70  # version 7
      bytes[7] = sub_ms_precision & 0xff
      # 2-bit variant (10) + 62-bit random
      rand_b = hash[3...19].to_i(16) & ((2**62) - 1)
      bytes[8] = ((rand_b >> 56) & 0x3f) | 0x80  # variant 10
      bytes[9] = (rand_b >> 48) & 0xff
      bytes[10] = (rand_b >> 40) & 0xff
      bytes[11] = (rand_b >> 32) & 0xff
      bytes[12] = (rand_b >> 24) & 0xff
      bytes[13] = (rand_b >> 16) & 0xff
      bytes[14] = (rand_b >> 8) & 0xff
      bytes[15] = rand_b & 0xff
      # Format as UUID string and convert to base36 (25 chars)
      uuid = "%02x%02x%02x%02x-%02x%02x-%02x%02x-%02x%02x-%02x%02x%02x%02x%02x%02x" % bytes
      ActiveRecord::Type::Uuid.hex_to_base36(uuid.delete("-"))
    end
  end
end
ActiveSupport.on_load(:active_record_fixture_set) do
  prepend(FixturesTestHelper)
end

================
File: test/webmock_ipaddr_extension.rb
================
# Extends WebMock to support ipaddr matching for testing IP pinning.
#
# Usage:
#   stub_request(:post, "https://example.com/push")
#     .with(ipaddr: "93.184.216.34")
#     .to_return(status: 201)
#
# If the HTTP connection's ipaddr doesn't match, the stub won't match and
# WebMock will raise an error about an unregistered request.
module WebMock
  class RequestSignature
    attr_accessor :ipaddr
  end
  module RequestPatternIpaddrExtension
    attr_accessor :ipaddr_pattern
    def assign_options(options)
      options = options.dup
      @ipaddr_pattern = options.delete(:ipaddr) || options.delete("ipaddr")
      super(options)
    end
    def matches?(request_signature)
      super && ipaddr_matches?(request_signature)
    end
    private
      def ipaddr_matches?(request_signature)
        @ipaddr_pattern.nil? || @ipaddr_pattern == request_signature.ipaddr
      end
  end
  RequestPattern.prepend RequestPatternIpaddrExtension
  module NetHTTPUtilityIpaddrExtension
    def request_signature_from_request(net_http, request, body = nil)
      super.tap { |signature| signature.ipaddr = net_http.ipaddr }
    end
  end
  NetHTTPUtility.singleton_class.prepend NetHTTPUtilityIpaddrExtension
end

================
File: .dockerignore
================
# See https://docs.docker.com/engine/reference/builder/#dockerignore-file for more about ignoring files.

# Ignore git directory.
/.git/

# Ignore bundler config.
/.bundle

# Ignore documentation
/docs/
/README.md
/CLAUDE.md
/AGENTS.md
/STYLE.md
/CONTRIBUTING.md

# Ignore all environment files (except templates).
/.env*
!/.env*.erb

# Ignore all default key files.
/config/master.key
/config/credentials/*.key

# Ignore all logfiles and tempfiles.
/log/*
/tmp/*
!/log/.keep
!/tmp/.keep

# Ignore pidfiles, but keep the directory.
/tmp/pids/*
!/tmp/pids/.keep

# Ignore storage (uploaded files in development and any SQLite databases).
/storage/*
!/storage/.keep
/tmp/storage/*
!/tmp/storage/.keep

# Ignore assets.
/node_modules/
/app/assets/builds/*
!/app/assets/builds/.keep
/public/assets

================
File: .gitattributes
================
# See https://git-scm.com/docs/gitattributes for more about git attribute files.

# Mark the database schema as having been generated.
db/schema.rb linguist-generated

# Mark any vendored files as having been vendored.
vendor/* linguist-vendored

================
File: .gitignore
================
# See https://help.github.com/articles/ignoring-files for more about ignoring files.
#
# If you find yourself ignoring temporary files generated by your text editor
# or operating system, you probably want to add a global ignore instead:
#   git config --global core.excludesfile '~/.gitignore_global'

# Ignore bundler config.
/.bundle

# Ignore all environment files (except templates).
/.env*
!/.env*.erb

# Ignore all logfiles and tempfiles.
/log/*
/tmp/*
!/log/.keep
!/tmp/.keep
*.log

# Ignore pidfiles, but keep the directory.
/tmp/pids/*
!/tmp/pids/
!/tmp/pids/.keep

# Ignore storage (uploaded files in development and any SQLite databases).
/storage/*
!/storage/.keep
/tmp/storage/*
!/tmp/storage/
!/tmp/storage/.keep
/data

*.sqlite3
*.sqlite3_*

/public/assets

# Ignore master key for decrypting credentials and more.
/config/master.key

/config/credentials/*.key
.DS_Store

================
File: .gitleaks.toml
================
[extend]
useDefault = true

[allowlist]
paths = [
  '''log''',
  '''tmp''',
  '''.*\.yml\.enc''',
  '''docs/''',
  '''test/''',
]

[[rules]]
id = "basecamp-integration-url"
description = "Basecamp Integration URL"
regex = '''https://[^\s]*?([0-9a-fA-F]{16,})'''
[rules.allowlist]
regexTarget = "match"
regexes = ['''github\.com''']

================
File: .gitleaksignore
================
d8463077:gems/fizzy-saas/bin/setup:generic-api-key:54
c4073c1c:app/models/integration/basecamp.rb:generic-api-key:3
c4073c1c:app/models/integration/basecamp.rb:generic-api-key:4

================
File: .mise.toml
================
[settings]
idiomatic_version_file_enable_tools = ["ruby"]

[env]
PROMETHEUS_EXPORTER_URL = "http://127.0.0.1:9306/metrics"

================
File: .rubocop.yml
================
# Omakase Ruby styling for Rails
inherit_gem: { rubocop-rails-omakase: rubocop.yml }
# Overwrite or add rules to create your own house style
#
# # Use `[a, [b, c]]` not `[ a, [ b, c ] ]`
# Layout/SpaceInsideArrayLiteralBrackets:
#   Enabled: false
AllCops:
  Exclude:
    - 'db/migrate/**/*'
    - 'db/schema*.rb'
    - 'saas/db/migrate/**/*'
    - 'saas/db/saas_schema.rb'

================
File: .ruby-version
================
3.4.7

================
File: AGENTS.md
================
# Fizzy

This file provides guidance to AI coding agents working with this repository.

## What is Fizzy?

Fizzy is a collaborative project management and issue tracking application built by 37signals/Basecamp. It's a kanban-style tool for teams to create and manage cards (tasks/issues) across boards, organize work into columns representing workflow stages, and collaborate via comments, mentions, and assignments.

## Development Commands

### Setup and Server
```bash
bin/setup              # Initial setup (installs gems, creates DB, loads schema)
bin/dev                # Start development server (runs on port 3006)
```

Development URL: http://fizzy.localhost:3006
Login with: david@example.com (development fixtures), password will appear in the browser console

### Testing
```bash
bin/rails test                    # Run unit tests (fast)
bin/rails test test/path/file_test.rb  # Run single test file
bin/rails test:system             # Run system tests (Capybara + Selenium)
bin/ci                            # Run full CI suite (style, security, tests)

# For parallel test execution issues, use:
PARALLEL_WORKERS=1 bin/rails test
```

CI pipeline (`bin/ci`) runs:
1. Rubocop (style)
2. Bundler audit (gem security)
3. Importmap audit
4. Brakeman (security scan)
5. Application tests
6. System tests

### Database
```bash
bin/rails db:fixtures:load   # Load fixture data
bin/rails db:migrate          # Run migrations
bin/rails db:reset            # Drop, create, and load schema
```

### Other Utilities
```bash
bin/rails dev:email          # Toggle letter_opener for email preview
bin/jobs                     # Manage Solid Queue jobs
bin/kamal deploy             # Deploy (requires 1Password CLI for secrets)
```

## Architecture Overview

### Multi-Tenancy (URL-Based)

Fizzy uses **URL path-based multi-tenancy**:
- Each Account (tenant) has a unique `external_account_id` (7+ digits)
- URLs are prefixed: `/{account_id}/boards/...`
- Middleware (`AccountSlug::Extractor`) extracts the account ID from the URL and sets `Current.account`
- The slug is moved from `PATH_INFO` to `SCRIPT_NAME`, making Rails think it's "mounted" at that path
- All models include `account_id` for data isolation
- Background jobs automatically serialize and restore account context

**Key insight**: This architecture allows multi-tenancy without subdomains or separate databases, making local development and testing simpler.

### Authentication & Authorization

**Passwordless magic link authentication**:
- Global `Identity` (email-based) can have `Users` in multiple Accounts
- Users belong to an Account and have roles: owner, admin, member, system
- Sessions managed via signed cookies
- Board-level access control via `Access` records

### Core Domain Models

**Account**  The tenant/organization
- Has users, boards, cards, tags, webhooks
- Has entropy configuration for auto-postponement

**Identity**  Global user (email)
- Can have Users in multiple Accounts
- Session management tied to Identity

**User**  Account membership
- Belongs to Account and Identity
- Has role (owner/admin/member/system)
- Board access via explicit `Access` records

**Board**  Primary organizational unit
- Has columns for workflow stages
- Can be "all access" or selective
- Can be published publicly with shareable key

**Card**  Main work item (task/issue)
- Sequential number within each Account
- Rich text description and attachments
- Lifecycle: triage  columns  closed/not_now
- Automatically postpones after inactivity ("entropy")

**Event**  Records all significant actions
- Polymorphic association to changed object
- Drives activity timeline, notifications, webhooks
- Has JSON `particulars` for action-specific data

### Entropy System

Cards automatically "postpone" (move to "not now") after inactivity:
- Account-level default entropy period
- Board-level entropy override
- Prevents endless todo lists from accumulating
- Configurable via Account/Board settings

### UUID Primary Keys

All tables use UUIDs (UUIDv7 format, base36-encoded as 25-char strings):
- Custom fixture UUID generation maintains deterministic ordering for tests
- Fixtures are always "older" than runtime records
- `.first`/`.last` work correctly in tests

### Background Jobs (Solid Queue)

Database-backed job queue (no Redis):
- Custom `FizzyActiveJobExtensions` prepended to ActiveJob
- Jobs automatically capture/restore `Current.account`
- Mission Control::Jobs for monitoring

Key recurring tasks (via `config/recurring.yml`):
- Deliver bundled notifications (every 30 min)
- Auto-postpone stale cards (hourly)
- Cleanup jobs for expired links, deliveries

### Sharded Full-Text Search

16-shard MySQL full-text search instead of Elasticsearch:
- Shards determined by account ID hash (CRC32)
- Search records denormalized for performance
- Models in `app/models/search/`

### Imports and exports

Allow people to move between OSS and SAAS Fizzy instances:
- Exports/Imports can be wirtten to/read from local or S3 storage depending on the config of the instance (both myst be supported)
- Must be able to handle very large ZIP files (500+GB)
- Models in `app/models/account/data_transfer/`, `app/models/zip_file`

## Tools

### Chrome MCP (Local Dev)

URL: `http://fizzy.localhost:3006`
Login: david@example.com (passwordless magic link auth - check rails console for link)

Use Chrome MCP tools to interact with the running dev app for UI testing and debugging.

## Coding style

@STYLE.md

================
File: config.ru
================
# This file is used by Rack-based servers to start the application.

require_relative 'config/environment'

use Autotuner::RackPlugin

run Rails.application
Rails.application.load_server

================
File: CONTRIBUTING.md
================
# How to contribute to Fizzy

Fizzy uses GitHub
[discussions](https://github.com/basecamp/fizzy/discussions) to track
feature requests and questions, rather than [the issue
tracker](https://github.com/basecamp/fizzy/issues). If you're considering
opening an issue or pull request, please open a discussion instead.

Whenever a discussion leads to an actionable and well-understood task, we'll
move it to the issue tracker where it can be worked on.

This is a little different than how some other projects work, but it makes it
easier for us to triage and prioritise the work. It also means that the open
issues all represent agreed-upon tasks that are either being worked on, or are
ready to be worked on.

This should also make it easier to see what's in progress, and to find
something to work on if you'd like to do so.

## What this means in practice

### If you'd like to contribute to the code...

1. If you're interested in working on one of the open issues, please do! We are
   grateful for the help!
2. You'll want to make sure someone else isn't already working on the same
   issue. If they are, it will be tagged "in progress" and/or it should be clear
   from the comments. When in doubt, you can always comment on the issue to ask.
3. Similarly, if you need any help or guidance on the issue, please comment on
   the issue as you go, and we'll do our best to help.
4. When you have something ready for review or collaboration, open a PR.

### If you've found a bug...

1. If you don't have steps to reproduce the problem, or you're not certain it's a
   bug, open a discussion.
2. If you have steps to reproduce, open an issue.

### If you have an idea for a feature...

1. Open a discussion.

### If you have a question, or are having trouble with configuration...

1. Open a discussion.

Hopefully this process makes it easier for everyone to be involved. Thanks for
helping! 

================
File: Dockerfile
================
# syntax=docker/dockerfile:1
# check=error=true

# This Dockerfile is designed for production, not development. Use with Kamal or build'n'run by hand:
# docker build -t fizzy .
# docker run -d -p 80:80 -e RAILS_MASTER_KEY=<value from config/master.key> --name fizzy fizzy

# For a containerized dev environment, see Dev Containers: https://guides.rubyonrails.org/getting_started_with_devcontainer.html

# Make sure RUBY_VERSION matches the Ruby version in .ruby-version
ARG RUBY_VERSION=3.4.7
FROM docker.io/library/ruby:$RUBY_VERSION-slim AS base

# Rails app lives here
WORKDIR /rails

# Install base packages
RUN apt-get update -qq && \
    apt-get install --no-install-recommends -y curl libjemalloc2 libvips sqlite3 libssl-dev && \
    ln -s /usr/lib/$(uname -m)-linux-gnu/libjemalloc.so.2 /usr/local/lib/libjemalloc.so && \
    rm -rf /var/lib/apt/lists /var/cache/apt/archives

# Set production environment variables and enable jemalloc for reduced memory usage and latency.
ENV RAILS_ENV="production" \
    BUNDLE_DEPLOYMENT="1" \
    BUNDLE_PATH="/usr/local/bundle" \
    BUNDLE_WITHOUT="development:test" \
    LD_PRELOAD="/usr/local/lib/libjemalloc.so"

# Throw-away build stage to reduce size of final image
FROM base AS build

# Install packages needed to build gems
RUN apt-get update -qq && \
    apt-get install --no-install-recommends -y build-essential git libyaml-dev pkg-config && \
    rm -rf /var/lib/apt/lists /var/cache/apt/archives

# Install application gems
COPY Gemfile Gemfile.lock vendor ./

RUN bundle install && \
    rm -rf ~/.bundle/ "${BUNDLE_PATH}"/ruby/*/cache "${BUNDLE_PATH}"/ruby/*/bundler/gems/*/.git && \
    # -j 1 disable parallel compilation to avoid a QEMU bug: https://github.com/rails/bootsnap/issues/495
    bundle exec bootsnap precompile -j 1 --gemfile

# Copy application code
COPY . .

# Precompile bootsnap code for faster boot times.
# -j 1 disable parallel compilation to avoid a QEMU bug: https://github.com/rails/bootsnap/issues/495
RUN bundle exec bootsnap precompile -j 1 app/ lib/

# Precompiling assets for production without requiring secret RAILS_MASTER_KEY
RUN SECRET_KEY_BASE_DUMMY=1 ./bin/rails assets:precompile




# Final stage for app image
FROM base

# Image metadata
ARG OCI_DESCRIPTION
LABEL org.opencontainers.image.description="${OCI_DESCRIPTION}"
ARG OCI_SOURCE
LABEL org.opencontainers.image.source="${OCI_SOURCE}"
LABEL org.opencontainers.image.licenses="O'Saasy"

# Run and own only the runtime files as a non-root user for security
RUN groupadd --system --gid 1000 rails && \
    useradd rails --uid 1000 --gid 1000 --create-home --shell /bin/bash
USER 1000:1000

# Copy built artifacts: gems, application
COPY --chown=rails:rails --from=build "${BUNDLE_PATH}" "${BUNDLE_PATH}"
COPY --chown=rails:rails --from=build /rails /rails

# Entrypoint prepares the database.
ENTRYPOINT ["/rails/bin/docker-entrypoint"]

# Start server via Thruster by default, this can be overwritten at runtime
EXPOSE 80
CMD ["./bin/thrust", "./bin/rails", "server"]

================
File: Gemfile
================
source "https://rubygems.org"

git_source(:bc) { |repo| "https://github.com/basecamp/#{repo}" }

gem "rails", github: "rails/rails", branch: "main"

# Assets & front end
gem "importmap-rails"
gem "propshaft"
gem "stimulus-rails"
gem "turbo-rails"

# Deployment and drivers
gem "bootsnap", require: false
gem "kamal", require: false
gem "puma", ">= 5.0"
gem "solid_cable", ">= 3.0"
gem "solid_cache", "~> 1.0"
gem "solid_queue", "~> 1.2"
gem "sqlite3", ">= 2.0"
gem "thruster", require: false
gem "trilogy", "~> 2.9"

# Features
gem "bcrypt", "~> 3.1.7"
gem "geared_pagination", "~> 1.2"
gem "rqrcode"
gem "redcarpet"
gem "rouge"
gem "jbuilder"
gem "lexxy", bc: "lexxy"
gem "image_processing", "~> 1.14"
gem "platform_agent"
gem "aws-sdk-s3", require: false
gem "web-push"
gem "net-http-persistent"
gem "zip_kit"
gem "mittens"
gem "useragent", bc: "useragent"

# Operations
gem "autotuner"
gem "mission_control-jobs"
gem "benchmark" # indirect dependency, being removed from Ruby 3.5 stdlib so here to quash warnings

group :development, :test do
  gem "brakeman", require: false
  gem "bundler-audit", require: false
  gem "debug"
  gem "faker"
  gem "letter_opener"
  gem "rack-mini-profiler"
  gem "rubocop-rails-omakase", require: false
end

group :development do
  gem "web-console"
end

group :test do
  gem "capybara"
  gem "selenium-webdriver"
  gem "webmock"
  gem "vcr"
  gem "mocha"
end

================
File: Gemfile.saas
================
# This Gemfile extends the base Gemfile with SaaS-specific dependencies
eval_gemfile "Gemfile"

git_source(:bc) { |repo| "https://github.com/basecamp/#{repo}" }

gem "activeresource", require: "active_resource"
gem "stripe", "~> 18.0"
gem "queenbee", bc: "queenbee-plugin"
gem "fizzy-saas", path: "saas"
gem "console1984", bc: "console1984"
gem "audits1984", bc: "audits1984", branch: "flavorjones/coworker-api"

# Telemetry
gem "rails_structured_logging", bc: "rails-structured-logging"
gem "sentry-ruby"
gem "sentry-rails"
gem "yabeda"
gem "yabeda-actioncable"
gem "yabeda-activejob", github: "basecamp/yabeda-activejob", branch: "bulk-and-scheduled-jobs"
gem "yabeda-gc"
gem "yabeda-http_requests"
gem "yabeda-prometheus-mmap"
gem "yabeda-puma-plugin"
gem "yabeda-rails"
gem "webrick" # required for yabeda-prometheus metrics server
gem "prometheus-client-mmap", "~> 1.3"

================
File: Gemfile.saas.lock
================
GIT
  remote: https://github.com/basecamp/audits1984
  revision: 422b8ff25820c828b7cf09aff4923fd8cc2c6795
  branch: flavorjones/coworker-api
  specs:
    audits1984 (0.1.7)
      console1984
      importmap-rails (>= 1.2.1)
      jbuilder
      rinku
      rouge
      turbo-rails

GIT
  remote: https://github.com/basecamp/console1984
  revision: 02b1b9ee7fd7050174b6a98c2b43057553621dc4
  specs:
    console1984 (0.2.2)
      irb (~> 1.13)
      parser
      rails (>= 7.0)
      rainbow

GIT
  remote: https://github.com/basecamp/lexxy
  revision: 4f0fc4d5773bc6892de70f175440c259974c12a7
  specs:
    lexxy (0.7.0.beta)
      rails (>= 8.0.2)

GIT
  remote: https://github.com/basecamp/queenbee-plugin
  revision: 14312a940471e20617b38cdec7c092a01567d18b
  specs:
    queenbee (3.2.0)
      activeresource
      builder
      rexml

GIT
  remote: https://github.com/basecamp/rails-structured-logging
  revision: 76960cb5c15fc2b6b5f7542e05d7dcc031cef9e6
  specs:
    rails_structured_logging (0.2.1)
      json
      rails (>= 6.0.0)

GIT
  remote: https://github.com/basecamp/useragent
  revision: 433ca320a42db1266c4b89df74d0abdb9a880c5e
  specs:
    useragent (0.16.11)

GIT
  remote: https://github.com/basecamp/yabeda-activejob.git
  revision: 684973f77ff01d8b3dd75874538fae55961e15e6
  branch: bulk-and-scheduled-jobs
  specs:
    yabeda-activejob (0.6.0)
      rails (>= 6.1)
      yabeda (~> 0.6)

GIT
  remote: https://github.com/rails/rails.git
  revision: 60d92e4e7dfe923528ccdccc18820ccfe841b7b8
  branch: main
  specs:
    actioncable (8.2.0.alpha)
      actionpack (= 8.2.0.alpha)
      activesupport (= 8.2.0.alpha)
      nio4r (~> 2.0)
      websocket-driver (>= 0.6.1)
      zeitwerk (~> 2.6)
    actionmailbox (8.2.0.alpha)
      actionpack (= 8.2.0.alpha)
      activejob (= 8.2.0.alpha)
      activerecord (= 8.2.0.alpha)
      activestorage (= 8.2.0.alpha)
      activesupport (= 8.2.0.alpha)
      mail (>= 2.8.0)
    actionmailer (8.2.0.alpha)
      actionpack (= 8.2.0.alpha)
      actionview (= 8.2.0.alpha)
      activejob (= 8.2.0.alpha)
      activesupport (= 8.2.0.alpha)
      mail (>= 2.8.0)
      rails-dom-testing (~> 2.2)
    actionpack (8.2.0.alpha)
      actionview (= 8.2.0.alpha)
      activesupport (= 8.2.0.alpha)
      nokogiri (>= 1.8.5)
      rack (>= 2.2.4)
      rack-session (>= 1.0.1)
      rack-test (>= 0.6.3)
      rails-dom-testing (~> 2.2)
      rails-html-sanitizer (~> 1.6)
      useragent (~> 0.16)
    actiontext (8.2.0.alpha)
      action_text-trix (~> 2.1.15)
      actionpack (= 8.2.0.alpha)
      activerecord (= 8.2.0.alpha)
      activestorage (= 8.2.0.alpha)
      activesupport (= 8.2.0.alpha)
      globalid (>= 0.6.0)
      nokogiri (>= 1.8.5)
    actionview (8.2.0.alpha)
      activesupport (= 8.2.0.alpha)
      builder (~> 3.1)
      erubi (~> 1.11)
      rails-dom-testing (~> 2.2)
      rails-html-sanitizer (~> 1.6)
    activejob (8.2.0.alpha)
      activesupport (= 8.2.0.alpha)
      globalid (>= 0.3.6)
    activemodel (8.2.0.alpha)
      activesupport (= 8.2.0.alpha)
    activerecord (8.2.0.alpha)
      activemodel (= 8.2.0.alpha)
      activesupport (= 8.2.0.alpha)
      timeout (>= 0.4.0)
    activestorage (8.2.0.alpha)
      actionpack (= 8.2.0.alpha)
      activejob (= 8.2.0.alpha)
      activerecord (= 8.2.0.alpha)
      activesupport (= 8.2.0.alpha)
      marcel (~> 1.0)
    activesupport (8.2.0.alpha)
      base64
      bigdecimal
      concurrent-ruby (~> 1.0, >= 1.3.1)
      connection_pool (>= 2.2.5)
      drb
      i18n (>= 1.6, < 2)
      json
      logger (>= 1.4.2)
      minitest (>= 5.1)
      psych (>= 4)
      securerandom (>= 0.3)
      tzinfo (~> 2.0, >= 2.0.5)
      uri (>= 0.13.1)
    rails (8.2.0.alpha)
      actioncable (= 8.2.0.alpha)
      actionmailbox (= 8.2.0.alpha)
      actionmailer (= 8.2.0.alpha)
      actionpack (= 8.2.0.alpha)
      actiontext (= 8.2.0.alpha)
      actionview (= 8.2.0.alpha)
      activejob (= 8.2.0.alpha)
      activemodel (= 8.2.0.alpha)
      activerecord (= 8.2.0.alpha)
      activestorage (= 8.2.0.alpha)
      activesupport (= 8.2.0.alpha)
      bundler (>= 1.15.0)
      railties (= 8.2.0.alpha)
    railties (8.2.0.alpha)
      actionpack (= 8.2.0.alpha)
      activesupport (= 8.2.0.alpha)
      irb (~> 1.13)
      rackup (>= 1.0.0)
      rake (>= 12.2)
      thor (~> 1.0, >= 1.2.2)
      tsort (>= 0.2)
      zeitwerk (~> 2.6)

PATH
  remote: saas
  specs:
    fizzy-saas (0.1.0)
      audits1984
      console1984
      prometheus-client-mmap (~> 1.4.0)
      queenbee
      rails (>= 8.1.0.beta1)
      rails_structured_logging
      sentry-rails
      sentry-ruby
      yabeda
      yabeda-actioncable
      yabeda-activejob
      yabeda-gc
      yabeda-http_requests
      yabeda-prometheus-mmap
      yabeda-puma-plugin
      yabeda-rails (>= 0.10)

GEM
  remote: https://rubygems.org/
  specs:
    action_text-trix (2.1.16)
      railties
    activemodel-serializers-xml (1.0.3)
      activemodel (>= 5.0.0.a)
      activesupport (>= 5.0.0.a)
      builder (~> 3.1)
    activeresource (6.2.0)
      activemodel (>= 7.0)
      activemodel-serializers-xml (~> 1.0)
      activesupport (>= 7.0)
    addressable (2.8.7)
      public_suffix (>= 2.0.2, < 7.0)
    anyway_config (2.7.2)
      ruby-next-core (~> 1.0)
    ast (2.4.3)
    autotuner (1.1.0)
    aws-eventstream (1.4.0)
    aws-partitions (1.1203.0)
    aws-sdk-core (3.241.3)
      aws-eventstream (~> 1, >= 1.3.0)
      aws-partitions (~> 1, >= 1.992.0)
      aws-sigv4 (~> 1.9)
      base64
      bigdecimal
      jmespath (~> 1, >= 1.6.1)
      logger
    aws-sdk-kms (1.120.0)
      aws-sdk-core (~> 3, >= 3.241.3)
      aws-sigv4 (~> 1.5)
    aws-sdk-s3 (1.211.0)
      aws-sdk-core (~> 3, >= 3.241.3)
      aws-sdk-kms (~> 1)
      aws-sigv4 (~> 1.5)
    aws-sigv4 (1.12.1)
      aws-eventstream (~> 1, >= 1.0.2)
    base64 (0.3.0)
    bcrypt (3.1.21)
    bcrypt_pbkdf (1.1.2)
    benchmark (0.5.0)
    bigdecimal (4.0.1)
    bindex (0.8.1)
    bootsnap (1.21.1)
      msgpack (~> 1.2)
    brakeman (7.1.2)
      racc
    builder (3.3.0)
    bundler-audit (0.9.3)
      bundler (>= 1.2.0)
      thor (~> 1.0)
    capybara (3.40.0)
      addressable
      matrix
      mini_mime (>= 0.1.3)
      nokogiri (~> 1.11)
      rack (>= 1.6.0)
      rack-test (>= 0.6.3)
      regexp_parser (>= 1.5, < 3.0)
      xpath (~> 3.2)
    childprocess (5.1.0)
      logger (~> 1.5)
    chunky_png (1.4.0)
    concurrent-ruby (1.3.6)
    connection_pool (3.0.2)
    crack (1.0.1)
      bigdecimal
      rexml
    crass (1.0.6)
    date (3.5.1)
    debug (1.11.1)
      irb (~> 1.10)
      reline (>= 0.3.8)
    dotenv (3.2.0)
    drb (2.2.3)
    dry-initializer (3.2.0)
    ed25519 (1.4.0)
    erb (6.0.1)
    erubi (1.13.1)
    et-orbi (1.4.0)
      tzinfo
    faker (3.5.3)
      i18n (>= 1.8.11, < 2)
    ffi (1.17.2-aarch64-linux-gnu)
    ffi (1.17.2-aarch64-linux-musl)
    ffi (1.17.2-arm-linux-gnu)
    ffi (1.17.2-arm-linux-musl)
    ffi (1.17.2-arm64-darwin)
    ffi (1.17.2-x86_64-linux-gnu)
    ffi (1.17.2-x86_64-linux-musl)
    fugit (1.12.1)
      et-orbi (~> 1.4)
      raabro (~> 1.4)
    geared_pagination (1.2.0)
      activesupport (>= 5.0)
      addressable (>= 2.5.0)
    globalid (1.3.0)
      activesupport (>= 6.1)
    hashdiff (1.2.1)
    i18n (1.14.8)
      concurrent-ruby (~> 1.0)
    image_processing (1.14.0)
      mini_magick (>= 4.9.5, < 6)
      ruby-vips (>= 2.0.17, < 3)
    importmap-rails (2.2.2)
      actionpack (>= 6.0.0)
      activesupport (>= 6.0.0)
      railties (>= 6.0.0)
    io-console (0.8.2)
    irb (1.16.0)
      pp (>= 0.6.0)
      rdoc (>= 4.0.0)
      reline (>= 0.4.2)
    jbuilder (2.14.1)
      actionview (>= 7.0.0)
      activesupport (>= 7.0.0)
    jmespath (1.6.2)
    json (2.18.0)
    jwt (3.1.2)
      base64
    kamal (2.10.1)
      activesupport (>= 7.0)
      base64 (~> 0.2)
      bcrypt_pbkdf (~> 1.0)
      concurrent-ruby (~> 1.2)
      dotenv (~> 3.1)
      ed25519 (~> 1.4)
      net-ssh (~> 7.3)
      sshkit (>= 1.23.0, < 2.0)
      thor (~> 1.3)
      zeitwerk (>= 2.6.18, < 3.0)
    language_server-protocol (3.17.0.5)
    launchy (3.1.1)
      addressable (~> 2.8)
      childprocess (~> 5.0)
      logger (~> 1.6)
    letter_opener (1.10.0)
      launchy (>= 2.2, < 4)
    lint_roller (1.1.0)
    logger (1.7.0)
    loofah (2.25.0)
      crass (~> 1.0.2)
      nokogiri (>= 1.12.0)
    mail (2.9.0)
      logger
      mini_mime (>= 0.1.1)
      net-imap
      net-pop
      net-smtp
    marcel (1.1.0)
    matrix (0.4.3)
    mini_magick (5.3.1)
      logger
    mini_mime (1.1.5)
    minitest (6.0.1)
      prism (~> 1.5)
    mission_control-jobs (1.1.0)
      actioncable (>= 7.1)
      actionpack (>= 7.1)
      activejob (>= 7.1)
      activerecord (>= 7.1)
      importmap-rails (>= 1.2.1)
      irb (~> 1.13)
      railties (>= 7.1)
      stimulus-rails
      turbo-rails
    mittens (0.3.1)
    mocha (3.0.1)
      ruby2_keywords (>= 0.0.5)
    msgpack (1.8.0)
    net-http-persistent (4.0.8)
      connection_pool (>= 2.2.4, < 4)
    net-imap (0.6.2)
      date
      net-protocol
    net-pop (0.1.2)
      net-protocol
    net-protocol (0.2.2)
      timeout
    net-scp (4.1.0)
      net-ssh (>= 2.6.5, < 8.0.0)
    net-sftp (4.0.0)
      net-ssh (>= 5.0.0, < 8.0.0)
    net-smtp (0.5.1)
      net-protocol
    net-ssh (7.3.0)
    nio4r (2.7.5)
    nokogiri (1.19.0-aarch64-linux-gnu)
      racc (~> 1.4)
    nokogiri (1.19.0-aarch64-linux-musl)
      racc (~> 1.4)
    nokogiri (1.19.0-arm-linux-gnu)
      racc (~> 1.4)
    nokogiri (1.19.0-arm-linux-musl)
      racc (~> 1.4)
    nokogiri (1.19.0-arm64-darwin)
      racc (~> 1.4)
    nokogiri (1.19.0-x86_64-linux-gnu)
      racc (~> 1.4)
    nokogiri (1.19.0-x86_64-linux-musl)
      racc (~> 1.4)
    openssl (4.0.0)
    ostruct (0.6.3)
    parallel (1.27.0)
    parser (3.3.10.0)
      ast (~> 2.4.1)
      racc
    platform_agent (1.0.1)
      activesupport (>= 5.2.0)
      useragent (~> 0.16.3)
    pp (0.6.3)
      prettyprint
    prettyprint (0.2.0)
    prism (1.8.0)
    prometheus-client-mmap (1.4.0)
      base64
      bigdecimal
      logger
      rb_sys (~> 0.9.117)
    prometheus-client-mmap (1.4.0-aarch64-linux-gnu)
      base64
      bigdecimal
      logger
      rb_sys (~> 0.9.117)
    prometheus-client-mmap (1.4.0-aarch64-linux-musl)
      base64
      bigdecimal
      logger
      rb_sys (~> 0.9.117)
    prometheus-client-mmap (1.4.0-arm64-darwin)
      base64
      bigdecimal
      logger
      rb_sys (~> 0.9.117)
    prometheus-client-mmap (1.4.0-x86_64-linux-gnu)
      base64
      bigdecimal
      logger
      rb_sys (~> 0.9.117)
    prometheus-client-mmap (1.4.0-x86_64-linux-musl)
      base64
      bigdecimal
      logger
      rb_sys (~> 0.9.117)
    propshaft (1.3.1)
      actionpack (>= 7.0.0)
      activesupport (>= 7.0.0)
      rack
    psych (5.3.1)
      date
      stringio
    public_suffix (6.0.2)
    puma (7.1.0)
      nio4r (~> 2.0)
    raabro (1.4.0)
    racc (1.8.1)
    rack (3.2.4)
    rack-mini-profiler (4.0.1)
      rack (>= 1.2.0)
    rack-session (2.1.1)
      base64 (>= 0.1.0)
      rack (>= 3.0.0)
    rack-test (2.2.0)
      rack (>= 1.3)
    rackup (2.3.1)
      rack (>= 3)
    rails-dom-testing (2.3.0)
      activesupport (>= 5.0.0)
      minitest
      nokogiri (>= 1.6)
    rails-html-sanitizer (1.6.2)
      loofah (~> 2.21)
      nokogiri (>= 1.15.7, != 1.16.7, != 1.16.6, != 1.16.5, != 1.16.4, != 1.16.3, != 1.16.2, != 1.16.1, != 1.16.0.rc1, != 1.16.0)
    rainbow (3.1.1)
    rake (13.3.1)
    rake-compiler-dock (1.9.1)
    rb_sys (0.9.117)
      rake-compiler-dock (= 1.9.1)
    rdoc (7.0.3)
      erb
      psych (>= 4.0.0)
      tsort
    redcarpet (3.6.1)
    regexp_parser (2.11.3)
    reline (0.6.3)
      io-console (~> 0.5)
    rexml (3.4.4)
    rinku (2.0.6)
    rouge (4.7.0)
    rqrcode (3.2.0)
      chunky_png (~> 1.0)
      rqrcode_core (~> 2.0)
    rqrcode_core (2.1.0)
    rubocop (1.81.7)
      json (~> 2.3)
      language_server-protocol (~> 3.17.0.2)
      lint_roller (~> 1.1.0)
      parallel (~> 1.10)
      parser (>= 3.3.0.2)
      rainbow (>= 2.2.2, < 4.0)
      regexp_parser (>= 2.9.3, < 3.0)
      rubocop-ast (>= 1.47.1, < 2.0)
      ruby-progressbar (~> 1.7)
      unicode-display_width (>= 2.4.0, < 4.0)
    rubocop-ast (1.48.0)
      parser (>= 3.3.7.2)
      prism (~> 1.4)
    rubocop-performance (1.26.1)
      lint_roller (~> 1.1)
      rubocop (>= 1.75.0, < 2.0)
      rubocop-ast (>= 1.47.1, < 2.0)
    rubocop-rails (2.34.0)
      activesupport (>= 4.2.0)
      lint_roller (~> 1.1)
      rack (>= 1.1)
      rubocop (>= 1.75.0, < 2.0)
      rubocop-ast (>= 1.44.0, < 2.0)
    rubocop-rails-omakase (1.1.0)
      rubocop (>= 1.72)
      rubocop-performance (>= 1.24)
      rubocop-rails (>= 2.30)
    ruby-next-core (1.1.2)
    ruby-progressbar (1.13.0)
    ruby-vips (2.2.5)
      ffi (~> 1.12)
      logger
    ruby2_keywords (0.0.5)
    rubyzip (3.2.2)
    securerandom (0.4.1)
    selenium-webdriver (4.39.0)
      base64 (~> 0.2)
      logger (~> 1.4)
      rexml (~> 3.2, >= 3.2.5)
      rubyzip (>= 1.2.2, < 4.0)
      websocket (~> 1.0)
    sentry-rails (6.2.0)
      railties (>= 5.2.0)
      sentry-ruby (~> 6.2.0)
    sentry-ruby (6.2.0)
      bigdecimal
      concurrent-ruby (~> 1.0, >= 1.0.2)
    sniffer (0.5.0)
      anyway_config (>= 1.0)
      dry-initializer (~> 3)
    solid_cable (3.0.12)
      actioncable (>= 7.2)
      activejob (>= 7.2)
      activerecord (>= 7.2)
      railties (>= 7.2)
    solid_cache (1.0.10)
      activejob (>= 7.2)
      activerecord (>= 7.2)
      railties (>= 7.2)
    solid_queue (1.2.4)
      activejob (>= 7.1)
      activerecord (>= 7.1)
      concurrent-ruby (>= 1.3.1)
      fugit (~> 1.11)
      railties (>= 7.1)
      thor (>= 1.3.1)
    sqlite3 (2.8.0-aarch64-linux-gnu)
    sqlite3 (2.8.0-aarch64-linux-musl)
    sqlite3 (2.8.0-arm-linux-gnu)
    sqlite3 (2.8.0-arm-linux-musl)
    sqlite3 (2.8.0-arm64-darwin)
    sqlite3 (2.8.0-x86_64-linux-gnu)
    sqlite3 (2.8.0-x86_64-linux-musl)
    sshkit (1.25.0)
      base64
      logger
      net-scp (>= 1.1.2)
      net-sftp (>= 2.1.2)
      net-ssh (>= 2.8.0)
      ostruct
    stimulus-rails (1.3.4)
      railties (>= 6.0.0)
    stringio (3.2.0)
    stripe (18.0.1)
    thor (1.5.0)
    thruster (0.1.17)
    thruster (0.1.17-aarch64-linux)
    thruster (0.1.17-arm64-darwin)
    thruster (0.1.17-x86_64-linux)
    timeout (0.6.0)
    trilogy (2.9.0)
    tsort (0.2.0)
    turbo-rails (2.0.21)
      actionpack (>= 7.1.0)
      railties (>= 7.1.0)
    tzinfo (2.0.6)
      concurrent-ruby (~> 1.0)
    unicode-display_width (3.2.0)
      unicode-emoji (~> 4.1)
    unicode-emoji (4.1.0)
    uri (1.1.1)
    vcr (6.4.0)
    web-console (4.2.1)
      actionview (>= 6.0.0)
      activemodel (>= 6.0.0)
      bindex (>= 0.4.0)
      railties (>= 6.0.0)
    web-push (3.1.0)
      jwt (~> 3.0)
      openssl (>= 3.0)
    webmock (3.26.1)
      addressable (>= 2.8.0)
      crack (>= 0.3.2)
      hashdiff (>= 0.4.0, < 2.0.0)
    webrick (1.9.1)
    websocket (1.2.11)
    websocket-driver (0.8.0)
      base64
      websocket-extensions (>= 0.1.0)
    websocket-extensions (0.1.5)
    xpath (3.2.0)
      nokogiri (~> 1.8)
    yabeda (0.14.0)
      anyway_config (>= 1.0, < 3)
      concurrent-ruby
      dry-initializer
    yabeda-actioncable (0.2.2)
      actioncable (>= 7.2)
      activesupport (>= 7.2)
      railties (>= 7.2)
      yabeda (~> 0.8)
    yabeda-gc (0.4.0)
      yabeda (~> 0.6)
    yabeda-http_requests (0.3.0)
      anyway_config (>= 1.3, < 3.0)
      sniffer
      yabeda
    yabeda-prometheus-mmap (0.4.0)
      prometheus-client-mmap
      yabeda (~> 0.10)
    yabeda-puma-plugin (0.9.0)
      json
      puma
      yabeda (~> 0.5)
    yabeda-rails (0.10.0)
      activesupport
      anyway_config (>= 1.3, < 3)
      railties
      yabeda (~> 0.8)
    zeitwerk (2.7.4)
    zip_kit (6.3.4)

PLATFORMS
  aarch64-linux
  aarch64-linux-gnu
  aarch64-linux-musl
  arm-linux-gnu
  arm-linux-musl
  arm64-darwin
  x86_64-linux
  x86_64-linux-gnu
  x86_64-linux-musl

DEPENDENCIES
  activeresource
  audits1984!
  autotuner
  aws-sdk-s3
  bcrypt (~> 3.1.7)
  benchmark
  bootsnap
  brakeman
  bundler-audit
  capybara
  console1984!
  debug
  faker
  fizzy-saas!
  geared_pagination (~> 1.2)
  image_processing (~> 1.14)
  importmap-rails
  jbuilder
  kamal
  letter_opener
  lexxy!
  mission_control-jobs
  mittens
  mocha
  net-http-persistent
  platform_agent
  prometheus-client-mmap (~> 1.3)
  propshaft
  puma (>= 5.0)
  queenbee!
  rack-mini-profiler
  rails!
  rails_structured_logging!
  redcarpet
  rouge
  rqrcode
  rubocop-rails-omakase
  selenium-webdriver
  sentry-rails
  sentry-ruby
  solid_cable (>= 3.0)
  solid_cache (~> 1.0)
  solid_queue (~> 1.2)
  sqlite3 (>= 2.0)
  stimulus-rails
  stripe (~> 18.0)
  thruster
  trilogy (~> 2.9)
  turbo-rails
  useragent!
  vcr
  web-console
  web-push
  webmock
  webrick
  yabeda
  yabeda-actioncable
  yabeda-activejob!
  yabeda-gc
  yabeda-http_requests
  yabeda-prometheus-mmap
  yabeda-puma-plugin
  yabeda-rails
  zip_kit

BUNDLED WITH
   2.7.2

================
File: LICENSE.md
================
# O'Saasy License Agreement

Copyright  2025, 37signals LLC.

Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:

1. The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.
2. No licensee or downstream recipient may use the Software (including any modified or derivative versions) to directly compete with the original Licensor by offering it to third parties as a hosted, managed, or Software-as-a-Service (SaaS) product or cloud service where the primary value of the service is the functionality of the Software itself.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

================
File: Rakefile
================
# Add your own tasks in files placed in lib/tasks ending in .rake,
# for example lib/tasks/capistrano.rake, and they will automatically be available to Rake.

require_relative 'config/application'

Rails.application.load_tasks

================
File: README.md
================
# Fizzy

This is the source code of [Fizzy](https://fizzy.do/), the Kanban tracking tool for issues and ideas by [37signals](https://37signals.com).


## Running your own Fizzy instance

If you want to run your own Fizzy instance, but don't need to change its code, you can use our pre-built Docker image.
You'll need access to a server on which you can run Docker, and you'll need to configure some options to customize your installation.

You can find the details of how to do a Docker-based deployment in our [Docker deployment guide](docs/docker-deployment.md).

If you want more flexibility to customize your Fizzy installation by changing its code, and deploy those changes to your server, then we recommend you deploy Fizzy with Kamal. You can find a complete walkthrough of doing that in our [Kamal deployment guide](docs/kamal-deployment.md).


## Development

You are welcome -- and encouraged -- to modify Fizzy to your liking.
Please see our [Development guide](docs/development.md) for how to get Fizzy set up for local development.


## Contributing

We welcome contributions! Please read our [style guide](STYLE.md) before submitting code.


## License

Fizzy is released under the [O'Saasy License](LICENSE.md).

================
File: STYLE.md
================
# Style

We aim to write code that is a pleasure to read, and we have a lot of opinions about how to do it well. Writing great code is an essential part of our programming culture, and we deliberately set a high bar for every code change anyone contributes. We care about how code reads, how code looks, and how code makes you feel when you read it.

We love discussing code. If you have questions about how to write something, or if you detect some smell you are not quite sure how to solve, please ask away to other programmers. A Pull Request is a great way to do this.

When writing new code, unless you are very familiar with our approach, try to find similar code elsewhere to look for inspiration.

## Conditional returns

In general, we prefer to use expanded conditionals over guard clauses.

```ruby
# Bad
def todos_for_new_group
  ids = params.require(:todolist)[:todo_ids]
  return [] unless ids
  @bucket.recordings.todos.find(ids.split(","))
end

# Good
def todos_for_new_group
  if ids = params.require(:todolist)[:todo_ids]
    @bucket.recordings.todos.find(ids.split(","))
  else
    []
  end
end
```

This is because guard clauses can be hard to read, especially when they are nested.

As an exception, we sometimes use guard clauses to return early from a method:

* When the return is right at the beginning of the method.
* When the main method body is not trivial and involves several lines of code.

```ruby
def after_recorded_as_commit(recording)
  return if recording.parent.was_created?

  if recording.was_created?
    broadcast_new_column(recording)
  else
    broadcast_column_change(recording)
  end
end
```

## Methods ordering

We order methods in classes in the following order:

1. `class` methods
2. `public` methods with `initialize` at the top.
3. `private` methods

## Invocation order

We order methods vertically based on their invocation order. This helps us to understand the flow of the code.

```ruby
class SomeClass
  def some_method
    method_1
    method_2
  end

  private
    def method_1
      method_1_1
      method_1_2
    end
  
    def method_1_1
      # ...
    end
  
    def method_1_2
      # ...
    end
  
    def method_2
      method_2_1
      method_2_2
    end
  
    def method_2_1
      # ...
    end
  
    def method_2_2
      # ...
    end
end
```

## To bang or not to bang

Should I call a method `do_something` or `do_something!`?

As a general rule, we only use `!` for methods that have a correspondent counterpart without `!`. In particular, we dont use `!` to flag destructive actions. There are plenty of destructive methods in Ruby and Rails that do not end with `!`.

## Visibility modifiers

We don't add a newline under visibility modifiers, and we indent the content under them.

```ruby
class SomeClass
  def some_method
    # ...
  end

  private
    def some_private_method_1
      # ...
    end

    def some_private_method_2
      # ...
    end
end
```

If a module only has private methods, we mark it `private` at the top and add an extra new line after but don't indent.

```ruby
module SomeModule
  private
  
  def some_private_method
    # ...
  end
end
```

## CRUD controllers

We model web endpoints as CRUD operations on resources (REST). When an action doesn't map cleanly to a standard CRUD verb, we introduce a new resource rather than adding custom actions.

```ruby
# Bad
resources :cards do
  post :close
  post :reopen
end

# Good
resources :cards do
  resource :closure
end
```

## Controller and model interactions

In general, we favor a [vanilla Rails](https://dev.37signals.com/vanilla-rails-is-plenty/) approach with thin controllers directly invoking a rich domain model. We don't use services or other artifacts to connect the two.

Invoking plain Active Record operations is totally fine:

```ruby
class Cards::CommentsController < ApplicationController
  def create
    @comment = @card.comments.create!(comment_params)
  end
end
```

For more complex behavior, we prefer clear, intention-revealing model APIs that controllers call directly:

```ruby
class Cards::GoldnessesController < ApplicationController
  def create
    @card.gild
  end
end
```

When justified, it is fine to use services or form objects, but don't treat those as special artifacts:

```ruby
Signup.new(email_address: email_address).create_identity
```

## Run async operations in jobs

As a general rule, we write shallow job classes that delegate the logic itself to domain models:

* We typically use the suffix `_later` to flag methods that enqueue a job.
* A common scenario is having a model class that enqueues a job that, when executed, invokes some method in that same class. In this case, we use the suffix `_now` for the regular synchronous method.

```ruby
module Event::Relaying
  extend ActiveSupport::Concern

  included do
    after_create_commit :relay_later
  end

  def relay_later
    Event::RelayJob.perform_later(self)
  end

  def relay_now
    # ...
  end
end

class Event::RelayJob < ApplicationJob
  def perform(event)
    event.relay_now
  end
end
```





================================================================
End of Codebase
================================================================
